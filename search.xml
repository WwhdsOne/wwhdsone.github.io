<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>JAVA后端学习计划</title>
    <url>/2024/03/19/JAVA%E5%90%8E%E7%AB%AF%E5%AD%A6%E4%B9%A0%E8%AE%A1%E5%88%92/</url>
    <content><![CDATA[<h1 id="java后端内容学习"><a class="markdownIt-Anchor" href="#java后端内容学习"></a> JAVA后端内容学习</h1>
<table>
<thead>
<tr>
<th style="text-align:center"><strong>Java基础<br>（已完成）</strong></th>
<th><a href="https://www.bilibili.com/video/BV17F411T7Ao/?share_source=copy_web&amp;vd_source=96f983f689673aeb998155061f545543"><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240207173142846.png" alt="image-20240207173142846"></a><a href="https://www.bilibili.com/video/BV1yW4y1Y7Ms/?share_source=copy_web&amp;vd_source=96f983f689673aeb998155061f545543"><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240207173232867.png" alt="image-20240207173232867"></a></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><strong>JavaWeb<br>（已完成）</strong></td>
<td><a href="https://www.bilibili.com/video/BV1m84y1w7Tb/?share_source=copy_web&amp;vd_source=96f983f689673aeb998155061f545543"><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240207131825110.png" alt="image-20240207131825110"></a></td>
</tr>
<tr>
<td style="text-align:center"><strong>单体项目苍穹外卖<br>（已完成）</strong></td>
<td><a href="https://www.bilibili.com/video/BV1TP411v7v6/?share_source=copy_web&amp;vd_source=96f983f689673aeb998155061f545543"><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240207131900926.png" alt="image-20240207131900926"></a></td>
</tr>
<tr>
<td style="text-align:center"><strong>Git<br>（已完成）</strong></td>
<td><a href="https://www.bilibili.com/video/BV1MU4y1Y7h5/?share_source=copy_web&amp;vd_source=96f983f689673aeb998155061f545543"><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240207173404539.png" alt="image-20240207173404539"></a></td>
</tr>
<tr>
<td style="text-align:center"><strong>SpringCloud<br>(进度：第七章)</strong></td>
<td><a href="https://www.bilibili.com/video/BV1LQ4y127n4/?share_source=copy_web&amp;vd_source=96f983f689673aeb998155061f545543"><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240207173523057.png" alt="image-20240207173523057"></a></td>
</tr>
<tr>
<td style="text-align:center"><strong>学成在线<br>(已完成)</strong></td>
<td><a href="https://www.bilibili.com/video/BV1j8411N7Bm/?share_source=copy_web&amp;vd_source=96f983f689673aeb998155061f545543"><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240207173746548.png" alt="image-20240207173746548"></a></td>
</tr>
<tr>
<td style="text-align:center"><strong>Mysql<br>(未学习)</strong></td>
<td><a href="https://www.bilibili.com/video/BV1Kr4y1i7ru/?share_source=copy_web&amp;vd_source=96f983f689673aeb998155061f545543"><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240207180731511.png" alt="image-20240207180731511"></a></td>
</tr>
<tr>
<td style="text-align:center"><strong>Redis<br>(未学习)</strong></td>
<td><a href="https://www.bilibili.com/video/BV1cr4y1671t/?share_source=copy_web&amp;vd_source=96f983f689673aeb998155061f545543"><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240207180911403.png" alt="image-20240207180911403"></a></td>
</tr>
<tr>
<td style="text-align:center"><strong>Java设计模式<br>(未学习)</strong></td>
<td><a href="https://www.bilibili.com/video/BV1Np4y1z7BU/?share_source=copy_web&amp;vd_source=96f983f689673aeb998155061f545543"><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240207181106619.png" alt="image-20240207181106619"></a></td>
</tr>
</tbody>
</table>
]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>计划</tag>
        <tag>目标</tag>
        <tag>学习</tag>
      </tags>
  </entry>
  <entry>
    <title>Git基础教程</title>
    <url>/2024/03/18/Git%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B/</url>
    <content><![CDATA[<h1 id="git"><a class="markdownIt-Anchor" href="#git"></a> Git</h1>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/gitlogo.png" alt=""></p>
<h1 id="1-版本管理工具概念"><a class="markdownIt-Anchor" href="#1-版本管理工具概念"></a> 1 版本管理工具概念</h1>
<p>在平时开发中,可能有时要用到上个版本的内容,例如:</p>
<blockquote>
<p>领导让写文档,写好了,领导让修改,改好了,领导觉得第一版不错,改回来吧,此时内心一脸懵,第一版长啥样没存档啊</p>
</blockquote>
<p>实际上,代码开发中也需要这样的软件来管理我们的代码. 例如我们经常会碰到如下的现象:</p>
<blockquote>
<p>改之前好好的,改完就报错了,也没怎么修改啊</p>
</blockquote>
<p>在这种情况下如果不能查看修改之前的代码,查找问题是非常困难的.</p>
<p>如果有一个软件能记录我们对文档的所有修改,所有版本,那么上面的问题讲迎刃而解.而这类软件我们一般叫做版本控制工具</p>
<p>版本管理工具一般具有如下特性:</p>
<blockquote>
<p>能够记录历史版本,回退历史版本<br>
团队开发,方便代码合并</p>
</blockquote>
<h1 id="2-主流版本管理工具介绍"><a class="markdownIt-Anchor" href="#2-主流版本管理工具介绍"></a> 2 主流版本管理工具介绍</h1>
<h2 id="git-2"><a class="markdownIt-Anchor" href="#git-2"></a> Git</h2>
<p>工作流程</p>
<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">Git是分布式版本控制系统（Distributed Version Control System，简称 DVCS），分为两种类型的仓库：</span><br><span class="line">本地仓库和远程仓库</span><br><span class="line">工作流程如下</span><br><span class="line">    1．从远程仓库中克隆或拉取代码到本地仓库(clone/pull)</span><br><span class="line">    2．从本地进行代码修改</span><br><span class="line">    3．在提交前先将代码提交到暂存区</span><br><span class="line">    4．提交到本地仓库。本地仓库中保存修改的各个历史版本</span><br><span class="line">    5．修改完成后，需要和团队成员共享代码时，将代码push到远程仓库</span><br></pre></td></tr></table></figure>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/git.png" alt=""></p>
<p>Windows下载地址: <a href="https://git-scm.com/download/win">Git - Downloading Package (git-scm.com)</a></p>
<p>Linux/Unix下载方法: <a href="https://git-scm.com/download/linux">Git (git-scm.com)</a></p>
<h1 id="3-git工作流程"><a class="markdownIt-Anchor" href="#3-git工作流程"></a> 3 Git工作流程</h1>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/git%E6%B5%81%E7%A8%8B.png" alt=""></p>
<h1 id="4-命令行-git基本操作"><a class="markdownIt-Anchor" href="#4-命令行-git基本操作"></a> 4 命令行-- git基本操作</h1>
<h3 id="41-环境配置"><a class="markdownIt-Anchor" href="#41-环境配置"></a> 4.1 环境配置</h3>
<ol>
<li>打开Git Bash</li>
<li>设置用户信息</li>
</ol>
<p>邮箱可以是假邮箱</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">git config --global user.name “wwhds”</span><br><span class="line"></span><br><span class="line">git config --global user.email “hello@wwhds.cn”</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>查看配置信息</li>
</ol>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">git config --global user.name</span><br><span class="line"></span><br><span class="line">git config --global user.email</span><br></pre></td></tr></table></figure>
<h3 id="42-为常用指令配置别名"><a class="markdownIt-Anchor" href="#42-为常用指令配置别名"></a> 4.2 为常用指令配置别名</h3>
<p>有些常用的指令参数非常多，每次都要输入好多参数，我们可以使用别名。</p>
<h4 id="421-如何定义和使用别名"><a class="markdownIt-Anchor" href="#421-如何定义和使用别名"></a> 4.2.1 如何定义和使用别名</h4>
<p>要定义 Git 的别名，请使用 <code>git config</code> 命令，加上别名和要替换的命令。例如，要为 <code>git push</code> 创建别名 <code>p</code>：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git config --global alias.p <span class="string">'push'</span></span></span><br></pre></td></tr></table></figure>
<p>你可以通过将别名作为 <code>git</code> 的参数来使用别名，就像其他命令一样：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git p</span></span><br></pre></td></tr></table></figure>
<p>要查看所有的别名，用 <code>git config</code> 列出你的配置：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git config --global -l</span></span><br><span class="line">user.name=ricardo</span><br><span class="line">user.email=ricardo@example.com</span><br><span class="line">alias.p=push</span><br></pre></td></tr></table></figure>
<p>无论使用哪种方法，定义别名都能改善你使用 Git 的整体体验。更多关于定义 Git 别名的信息，请看《<a href="https://link.zhihu.com/?target=https%3A//git-scm.com/book/en/v2/Git-Basics-Git-Aliases">Git Book</a>》。</p>
<h4 id="422-有用的-git-别名"><a class="markdownIt-Anchor" href="#422-有用的-git-别名"></a> 4.2.2 有用的 Git 别名</h4>
<ol>
<li>
<p><strong>Git 单行日志</strong></p>
<p>以单行方式显示你的提交，使输出更紧凑：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">git config --global alias.ll 'log --pretty=oneline --all --graph --abbrev-commit'</span><br></pre></td></tr></table></figure>
<ul>
<li><code>--pretty=oneline</code>: 将每个提交的信息压缩为一行，只显示提交的哈希值和提交信息。</li>
<li><code>--all</code>: 显示所有分支的提交历史记录，包括本地分支和远程分支。</li>
<li><code>--graph</code>: 以图形化的方式显示提交历史记录，显示分支、合并等关系。</li>
<li><code>--abbrev-commit</code>: 缩短每个提交的哈希值为7个字符，减少显示的字符数，方便查看。</li>
</ul>
<p>使用这个别名可以提供所有提交的简短列表：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git ll</span></span><br><span class="line">* ea12179 (HEAD -&gt; master, origin/master) 导出运营数据报表 后端开发结束</span><br><span class="line">* 96f64fd 数据统计功能开发</span><br><span class="line">* 8fba9e4 用户催单和接单提醒功能开发</span><br><span class="line">* 8c96623 地址簿相关功能开发 管理端订单功能开发 用户端订单功能开发 微信支付模拟xxxxxxxxxx * ea12179 (HEAD -&gt; master, origin/master) 导出运营数据报表 后端开发结束* 96f64fd 数据统计功能开发* 8fba9e4 用户催单和接单提醒功能开发* 8c96623 地址簿相关功能开发 管理端订单功能开发 用户端订单功能开发 微信支付模拟$ git ll33559c5 (HEAD -&gt; master) Another commit17646c1 test1</span><br></pre></td></tr></table></figure>
</li>
<li>
<p><strong>Git 的最近一次提交</strong></p>
<p>这将显示你最近一次提交的详细信息。这是扩展了《Git Book》中 <a href="https://link.zhihu.com/?target=https%3A//git-scm.com/book/en/v2/Git-Basics-Git-Aliases">别名</a> 一章的例子：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git config --global alias.last <span class="string">'log -1 HEAD --stat'</span></span></span><br></pre></td></tr></table></figure>
<p>用它来查看最后的提交：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git last</span></span><br><span class="line">commit f3dddcbaabb928f84f45131ea5be88dcf0692783 (HEAD -&gt; branch1)</span><br><span class="line">Author: ricardo &lt;ricardo@example.com&gt;</span><br><span class="line">Date:   Tue Nov 3 00:19:52 2020 +0000</span><br><span class="line"></span><br><span class="line">    Commit to branch1</span><br><span class="line"></span><br><span class="line"> test2 | 1 +</span><br><span class="line"> test3 | 0</span><br><span class="line"> 2 files changed, 1 insertion(+)</span><br></pre></td></tr></table></figure>
</li>
<li>
<p><strong>Git 远程仓库</strong></p>
<p><code>git remote -v</code> 命令列出了所有配置的远程仓库。用别名 <code>rv</code> 将其缩短：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git config --global alias.rv <span class="string">'remote -v'</span></span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p><strong>Git 配置列表</strong></p>
<p><code>gl</code> 别名可以更方便地列出所有用户配置：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git config --global alias.gl <span class="string">'config --global -l'</span></span></span><br></pre></td></tr></table></figure>
<p>现在可以查看用户配置了</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">user.name=Wwhds</span><br><span class="line">user.email=a1605691832@163.com</span><br><span class="line">core.quotepath=false</span><br><span class="line">alias.ll=log --pretty=oneline --all --graph --abbrev-commit</span><br><span class="line">alias.last=log -1 HEAD --stat</span><br><span class="line">alias.rv=remote -v</span><br><span class="line">alias.gl=config --global -l</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="43-解决gitbash乱码问题"><a class="markdownIt-Anchor" href="#43-解决gitbash乱码问题"></a> 4.3 解决GitBash乱码问题</h3>
<ol>
<li>打开GitBash执行下面命令</li>
</ol>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">git config --global core.quotepath false</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>${git_home}/etc/bash.bashrc 文件最后加入下面两行</li>
</ol>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">export LANG="zh_CN.UTF-8" </span><br><span class="line">export LC_ALL="zh_CN.UTF-8"</span><br></pre></td></tr></table></figure>
<h3 id="44-获取本地仓库"><a class="markdownIt-Anchor" href="#44-获取本地仓库"></a> 4.4 获取本地仓库</h3>
<p>要使用Git对我们的代码进行版本控制，首先需要获得本地仓库</p>
<ol>
<li>
<p>在电脑的任意位置创建一个空目录（例如test）作为我们的本地Git仓库</p>
</li>
<li>
<p>进入这个目录中，点击右键打开Git bash窗口</p>
</li>
<li>
<p>执行命令git init</p>
</li>
<li>
<p>如果创建成功后可在文件夹下看到隐藏的.git目录。</p>
</li>
</ol>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/git_init.png" alt=""></p>
<h3 id="45-基础操作指令"><a class="markdownIt-Anchor" href="#45-基础操作指令"></a> 4.5 基础操作指令</h3>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/git_work.png" alt=""></p>
<h4 id="451-查看修改状态-status"><a class="markdownIt-Anchor" href="#451-查看修改状态-status"></a> 4.5.1 查看修改状态 (status)</h4>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git status</span></span><br></pre></td></tr></table></figure>
<p>不同文件状态不同</p>
<ul>
<li>Untracked files 新创建的文件是未跟踪状态</li>
<li>Changes to be committed 即将被提交</li>
<li>Changes not staged for commit 修改并未添加至暂存区来提交</li>
<li>nothing to commit,working tree clean 提交后显示没有东西可以提交</li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">On branch master</span><br><span class="line">Changes not staged for commit:                                </span><br><span class="line">  (use "git add &lt;file&gt;..." to update what will be committed)</span><br><span class="line">  (use "git restore &lt;file&gt;..." to discard changes in working directory)</span><br><span class="line">        modified:   file01.txt</span><br><span class="line">Untracked files:                                                             </span><br><span class="line">  (use "git add &lt;file&gt;..." to include in what will be committed)</span><br><span class="line">        file02.txt</span><br><span class="line"></span><br><span class="line">no changes added to commit (use "git add" and/or "git commit -a")</span><br></pre></td></tr></table></figure>
<h4 id="451-添加工作区到暂存区add"><a class="markdownIt-Anchor" href="#451-添加工作区到暂存区add"></a> 4.5.1 添加工作区到暂存区(add)</h4>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git add .</span></span><br></pre></td></tr></table></figure>
<ul>
<li>作用：添加工作区一个或多个文件的修改到暂存区</li>
</ul>
<p>将暂存区指定文件回退</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git reset <span class="string">"文件名"</span></span></span><br></pre></td></tr></table></figure>
<p>将暂存区全部文件回退</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git reset</span></span><br></pre></td></tr></table></figure>
<h4 id="452-提交暂存区到本地仓库commit"><a class="markdownIt-Anchor" href="#452-提交暂存区到本地仓库commit"></a> 4.5.2 提交暂存区到本地仓库(commit)</h4>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git commit -m <span class="string">'注释内容'</span></span></span><br></pre></td></tr></table></figure>
<ul>
<li>作用：提交暂存区汇总所有内容到本地仓库的当前分支</li>
<li>命令形式：git commit -m ‘注释内容’</li>
</ul>
<h4 id="453-查看提交日志log"><a class="markdownIt-Anchor" href="#453-查看提交日志log"></a> 4.5.3 查看提交日志(log)</h4>
<p>在4.2.2中设置了git log的别名并添加设置。</p>
<p>我们使用别名即可:</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git ll</span></span><br></pre></td></tr></table></figure>
<p>效果如下:</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">* 34fa638 (HEAD -&gt; master) file01</span><br></pre></td></tr></table></figure>
<p>若想获得更详细的信息:</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git <span class="built_in">log</span></span></span><br></pre></td></tr></table></figure>
<p>效果如下:</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">commit 34fa638efcb9fbe96b997a0cab2fe2dd73f8f15b (HEAD -&gt; master)</span><br><span class="line">Author: Wwhds &lt;a1605691832@163.com&gt;</span><br><span class="line">Date:   Wed Feb 7 15:26:15 2024 +0800</span><br><span class="line"></span><br><span class="line">    file01</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>提交时候添加的备注会被放到日志中</p>
<h4 id="454-版本回退"><a class="markdownIt-Anchor" href="#454-版本回退"></a> 4.5.4 版本回退</h4>
<p>撤回到之前的某个操作，他回去删除我们撤回到位置之后的版本</p>
<ul>
<li>作用：版本切换</li>
<li>命令形式：git reset --hard commitID
<ul>
<li>commitID 可以使用 git-log 或 git log 指令查看</li>
</ul>
</li>
<li>如何查看已经删除的记录？
<ul>
<li>git reflog</li>
<li>这个指令可以看到已经删除的提交记录</li>
</ul>
</li>
</ul>
<p>我们可以在reflog里面知道删除文件的id，我们可以直接使用命令git reset --hard commitID 还原</p>
<p>所以</p>
<p>git reset --hard commitID既可以做版本回退，也可以做版本还原</p>
<h4 id="455-添加文件至忽略列表"><a class="markdownIt-Anchor" href="#455-添加文件至忽略列表"></a> 4.5.5 添加文件至忽略列表</h4>
<p>一般我们总会有些文件无需纳入Git 的管理，也不希望它们总出现在未跟踪文件列表。 通常都是些自动</p>
<p>生成的文件，比如日志文件，或者编译过程中创建的临时文件等。 在这种情况下，我们可以在工作目录</p>
<p>中<strong>创建一个名为 .gitignore 的文件（文件名称固定），列出要忽略的文件模式</strong>。</p>
<p>下面是一个示例：</p>
<p>先创建一个.gitignore文件</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">touch</span> .gitignore</span></span><br></pre></td></tr></table></figure>
<p>然后使用vi指令对.gitignore文件进行编辑</p>
<blockquote>
<p>在其中插入*.txt</p>
</blockquote>
<p>那么之后的提交便会无视.txt后缀的文件</p>
<h4 id="456-基础操作指令练习"><a class="markdownIt-Anchor" href="#456-基础操作指令练习"></a> 4.5.6 基础操作指令练习</h4>
<ol>
<li>新建一个文件夹在其中初始化git仓库</li>
</ol>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git init</span></span><br></pre></td></tr></table></figure>
<ol start="2">
<li>创建file01.txt并在其中写入"12345"</li>
</ol>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">touch</span> file01.txt</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">vi file01.txt</span></span><br></pre></td></tr></table></figure>
<ol start="3">
<li>查看工作目录状态</li>
</ol>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git status</span></span><br></pre></td></tr></table></figure>
<p>此时我们会看到:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">On branch master</span><br><span class="line"></span><br><span class="line">No commits yet</span><br><span class="line"></span><br><span class="line">Untracked files:</span><br><span class="line">  (use "git add &lt;file&gt;..." to include in what will be committed)</span><br><span class="line">        file01.txt</span><br><span class="line"></span><br><span class="line">nothing added to commit but untracked files present (use "git add" to track)</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>将file01.txt加入暂存区</li>
</ol>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git add .</span></span><br></pre></td></tr></table></figure>
<ol start="5">
<li>将暂存区的file01.txt提交到本地仓库</li>
</ol>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git commit -m <span class="string">'file01.txt'</span></span></span><br></pre></td></tr></table></figure>
<ol start="6">
<li>修改file01.txt内容为"23333"并提交到本地仓库</li>
</ol>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git add .</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git commit -m <span class="string">'file01.txt update'</span></span></span><br></pre></td></tr></table></figure>
<ol start="7">
<li>利用别名查看日志</li>
</ol>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git ll</span></span><br></pre></td></tr></table></figure>
<ol start="8">
<li>回退到第一次提交的版本</li>
</ol>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"> git reset a8c40cb --hard</span></span><br></pre></td></tr></table></figure>
<h3 id="46-分支"><a class="markdownIt-Anchor" href="#46-分支"></a> 4.6 分支</h3>
<p>几乎所有的版本控制系统都以某种形式支持分支。 使用分支意味着你可以把你的工作从开发主线上分离</p>
<p>开来进行重大的Bug修改、开发新的功能，以免影响开发主线。master是我们的主线</p>
<p>每个人开发的那一部分就是一个分支，使得每个人的开发互不影响，在每个人都开发完后就将所有的代码汇总到一起，此时就要执行分支的合并操作</p>
<p>工作区只能在一个分支工作，每个分支存放的文件或者资源是不一样的，就相当于不同的文件夹</p>
<h4 id="461-查看本地分支"><a class="markdownIt-Anchor" href="#461-查看本地分支"></a> 4.6.1 查看本地分支</h4>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git branch</span></span><br></pre></td></tr></table></figure>
<p>带星号的表示当前分支</p>
<h4 id="462-创建本地分支branch"><a class="markdownIt-Anchor" href="#462-创建本地分支branch"></a> 4.6.2 创建本地分支(branch)</h4>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git branch <span class="string">"分支名"</span></span></span><br></pre></td></tr></table></figure>
<p>创建的新分支会建立在当前分支的版本之上，所以新建的分支会有当前分支的内容</p>
<h4 id="463-切换分支checkout"><a class="markdownIt-Anchor" href="#463-切换分支checkout"></a> 4.6.3 切换分支(checkout)</h4>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git checkout</span></span><br></pre></td></tr></table></figure>
<p>我们还可直接切换到一个不存在的分支（创建并切换)</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git checkout -b</span></span><br></pre></td></tr></table></figure>
<h4 id="464-合并分支merge"><a class="markdownIt-Anchor" href="#464-合并分支merge"></a> 4.6.4 合并分支(merge)</h4>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git merge <span class="string">"分支名"</span></span></span><br></pre></td></tr></table></figure>
<p>注意：分支上的内容必须先提交,才能切换分支</p>
<p>一个分支上的提交可以合并到另一个分支</p>
<p>在每个人都开发完后就将所有的代码汇总到一起，此时就要执行分支的合并操作</p>
<p>当分支岔开时表示多个人在修改同一个文件</p>
<h4 id="465-删除分支"><a class="markdownIt-Anchor" href="#465-删除分支"></a> 4.6.5 删除分支</h4>
<p><strong>不能删除当前分支，只能删除其他分支</strong></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">git branch -d b1 删除分支时，需要做各种检查</span><br><span class="line">git branch -D b1 不做任何检查，强制删除</span><br></pre></td></tr></table></figure>
<h4 id="466-解决冲突"><a class="markdownIt-Anchor" href="#466-解决冲突"></a> 4.6.6 解决冲突</h4>
<p>当我们合并分支后，两个或者多个分支对同一个文件的同一个地方进行修改的时候（不是同一个地方是不会出现冲突的 ），此时git就不知道要取哪个分支修改的值，是取a分支修改的值，还是取b分支修改的值呢，此时就产生了冲突</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/%E5%86%B2%E7%AA%81%E6%8A%A5%E9%94%99.png" alt=""></p>
<p>冲突时文件具体内容如下:</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/%E5%86%B2%E7%AA%81%E5%85%B7%E4%BD%93%E6%83%85%E5%86%B5.png" alt=""></p>
<p>第一个count值表示的是当前分支修改的值</p>
<p>第二个count值是在dev分支修改的值</p>
<p>当两个分支上对文件的修改可能会存在冲突，例如同时修改了同一个文件的同一行，这时就需要手动解</p>
<p>决冲突，<strong>解决冲突步骤如下：</strong></p>
<p>其实我们就是直接手动去删除文件中的一个分支，留下一个分支，这样就不会冲突了</p>
<ol>
<li>处理文件中冲突的地方</li>
<li>将解决完冲突的文件加入暂存区(add)</li>
<li>提交到仓库(commit)</li>
</ol>
<h4 id="467-开发中分支使用原则与流程"><a class="markdownIt-Anchor" href="#467-开发中分支使用原则与流程"></a> 4.6.7 开发中分支使用原则与流程</h4>
<p>几乎所有的版本控制系统都以某种形式支持分支。 使用分支意味着你可以把你的工作从开发主线上分离</p>
<p>开来进行重大的Bug修改、开发新的功能，以免影响开发主线。</p>
<p>在开发中，一般有如下分支使用原则与流程：</p>
<ul>
<li>master （生产） 分支</li>
</ul>
<p>线上分支，主分支，中小规模项目作为线上运行的应用对应的分支；</p>
<ul>
<li>develop（开发）分支</li>
</ul>
<p>是从master创建的分支，一般作为开发部门的主要开发分支，如果没有其他并行开发不同期上线</p>
<p>要求，都可以在此版本进行开发，阶段开发完成后，需要是合并到master分支,准备上线。</p>
<blockquote>
<p>例如我们要开发新功能，我们要可以在develop分支上在建一个分支，新功能一般叫做feature分支，开发完以后在合并到 develop分支上面去，而不是直接提交到master分支，最后项目做完了develop在合并到master分支上</p>
</blockquote>
<p>develop和master分支是不可删除的</p>
<ul>
<li>feature/xxxx分支（用完可删）</li>
</ul>
<p>从develop创建的分支，一般是同期并行开发，但不同期上线时创建的分支，分支上的研发任务完</p>
<p>成后合并到develop分支，用完后可删除。</p>
<ul>
<li>hotfifix/xxxx分支，</li>
</ul>
<p>从master派生的分支，一般作为线上bug修复使用，修复测试完成后需要合并到master、test、develop分支。</p>
<ul>
<li>还有一些其他分支，在此不再详述，例如test分支（用于代码测试）、pre分支（预上线分支）等等。</li>
</ul>
]]></content>
      <categories>
        <category>Git</category>
      </categories>
      <tags>
        <tag>Git</tag>
        <tag>基础</tag>
        <tag>教程</tag>
      </tags>
  </entry>
  <entry>
    <title>Markdown语法快速入门</title>
    <url>/2024/03/18/Markdown%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/</url>
    <content><![CDATA[<h1 id="1-markdown标题语法"><a class="markdownIt-Anchor" href="#1-markdown标题语法"></a> 1 Markdown标题语法</h1>
<p>创建标题需要在单词或短语面前添加(#),#号数量代表标题级别,最多添加6个#</p>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line"><span class="section"># 一级标题</span></span><br></pre></td></tr></table></figure>
<h1 id="11-一级标题"><a class="markdownIt-Anchor" href="#11-一级标题"></a> 1.1 一级标题</h1>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line"><span class="section">## 二级标题</span></span><br></pre></td></tr></table></figure>
<h2 id="12-二级标题markdown"><a class="markdownIt-Anchor" href="#12-二级标题markdown"></a> 1.2 二级标题markdown</h2>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line"><span class="section">##  三级标题</span></span><br></pre></td></tr></table></figure>
<h3 id="13-三级标题"><a class="markdownIt-Anchor" href="#13-三级标题"></a> 1.3 三级标题</h3>
<p>不同的 Markdown 应用程序处理 <code>#</code> 和标题之间的空格方式并不一致。为了兼容考虑，请用一个空格在 <code>#</code> 和标题之间进行分隔。</p>
<table>
<thead>
<tr>
<th style="text-align:center">✅</th>
<th style="text-align:center">❌</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><code># 标题</code></td>
<td style="text-align:center"><code>#标题</code></td>
</tr>
</tbody>
</table>
<p>Typora快捷键: Crtl + 1-6</p>
<h1 id="2-markdown-段落语法"><a class="markdownIt-Anchor" href="#2-markdown-段落语法"></a> 2 Markdown 段落语法</h1>
<p>要创建段落，请使用空白行将一行或多行文本进行分隔。</p>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line">这是第一段的段落</span><br><span class="line">这是第二段的段落</span><br></pre></td></tr></table></figure>
<p><strong>请不要在段落面前加入空格或者制表符(TAB)</strong></p>
<h1 id="3-markdown-换行语法"><a class="markdownIt-Anchor" href="#3-markdown-换行语法"></a> 3 Markdown 换行语法</h1>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line">按下回车即可换行</span><br><span class="line">就像这样😀</span><br></pre></td></tr></table></figure>
<h1 id="4-markdown强调语法"><a class="markdownIt-Anchor" href="#4-markdown强调语法"></a> 4 Markdown强调语法</h1>
<p>通过将文本设置为粗体或斜体来强调其重要性。</p>
<h2 id="41-粗体bold"><a class="markdownIt-Anchor" href="#41-粗体bold"></a> 4.1 粗体(<code>Bold</code>)</h2>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line"><span class="strong">**这是粗体语法**</span></span><br></pre></td></tr></table></figure>
<p><strong>这是粗体语法</strong></p>
<p>Typora快捷键: Crtl + B</p>
<h2 id="42-斜体italic"><a class="markdownIt-Anchor" href="#42-斜体italic"></a> 4.2 斜体(<code>Italic</code>)</h2>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line"><span class="emphasis">*这是斜体语法*</span></span><br></pre></td></tr></table></figure>
<p><em>这是斜体语法</em></p>
<p>Typora快捷键: Crtl + I</p>
<h2 id="43-粗体bold和斜体italic"><a class="markdownIt-Anchor" href="#43-粗体bold和斜体italic"></a> 4.3 粗体(<code>Bold</code>)和斜体(<code>Italic</code>)</h2>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line"><span class="strong">**<span class="emphasis">*这是粗体和斜体同时作用*</span>**</span></span><br></pre></td></tr></table></figure>
<p><em><strong>这是粗体和斜体同时作用</strong></em></p>
<p>Typora快捷键: Crtl + I + B</p>
<h2 id="44-删除线strikethrough"><a class="markdownIt-Anchor" href="#44-删除线strikethrough"></a> 4.4 删除线(<code>strikethrough</code>)</h2>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line">~~这是删除线~~</span><br></pre></td></tr></table></figure>
<p><s>这是删除线</s></p>
<h1 id="5-markdown-引用语法"><a class="markdownIt-Anchor" href="#5-markdown-引用语法"></a> 5 Markdown 引用语法</h1>
<p>要创建块引用，请在段落前添加一个 <code>&gt;</code> 符号。</p>
<h2 id="51-单行引用"><a class="markdownIt-Anchor" href="#51-单行引用"></a> 5.1 单行引用</h2>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line">&gt;这就是单行引用</span><br></pre></td></tr></table></figure>
<blockquote>
<p>这就是单行引用</p>
</blockquote>
<h2 id="52-多个段落的块引用"><a class="markdownIt-Anchor" href="#52-多个段落的块引用"></a> 5.2 多个段落的块引用</h2>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line">&gt;第一行引用</span><br><span class="line"><span class="quote">&gt;</span></span><br><span class="line"><span class="quote">&gt;</span></span><br><span class="line"><span class="quote">&gt;</span></span><br><span class="line"><span class="quote">&gt;第二行引用</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>第一行引用</p>
<p>第二行引用</p>
</blockquote>
<h2 id="53-嵌套块引用"><a class="markdownIt-Anchor" href="#53-嵌套块引用"></a> 5.3 嵌套块引用</h2>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line"><span class="quote">&gt;</span></span><br><span class="line"><span class="quote">&gt;</span></span><br><span class="line">&gt;&gt;这是外层引用</span><br><span class="line">&gt;&gt;这是第一行内层引用</span><br><span class="line">&gt;&gt;这是第二行内层引用</span><br></pre></td></tr></table></figure>
<blockquote>
<p>这是外层引用</p>
<blockquote>
<p>这是第一行内层引用</p>
<p>这是第二行内层引用</p>
</blockquote>
</blockquote>
<h2 id="54-带有其他元素的引用"><a class="markdownIt-Anchor" href="#54-带有其他元素的引用"></a> 5.4 带有其他元素的引用</h2>
<blockquote>
<h2 id="效果看起来很不错"><a class="markdownIt-Anchor" href="#效果看起来很不错"></a> # 效果看起来很不错!</h2>
<ul>
<li>这是无序列表第一行!</li>
<li>这是无序列表第二行!</li>
</ul>
<p><em><strong>效果如同我们想象的那样出现</strong></em></p>
</blockquote>
<h1 id="6-markdown-列表语法"><a class="markdownIt-Anchor" href="#6-markdown-列表语法"></a> 6 Markdown 列表语法</h1>
<p>可以将多个条目组织成有序或无序列表。</p>
<h2 id="61-有序列表"><a class="markdownIt-Anchor" href="#61-有序列表"></a> 6.1 有序列表</h2>
<p>要创建有序列表，请在每个列表项前添加数字并紧跟一个英文句点。数字不必按数学顺序排列，但是列表应当以数字 1 起始。</p>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line"><span class="bullet">1.</span> 第一件物品</span><br><span class="line"><span class="bullet">2.</span> 第二件物品</span><br><span class="line"><span class="bullet">3.</span> 第三件物品</span><br><span class="line"><span class="bullet">4.</span> LOLOLOLOL</span><br></pre></td></tr></table></figure>
<ol>
<li>
<p>第一件物品</p>
</li>
<li>
<p>第二件物品</p>
</li>
<li>
<p>第三件物品</p>
</li>
<li>
<p>LOLOLOLOL</p>
</li>
</ol>
<p>Typora快捷键: Crtl + Shift + [</p>
<p>即使你在定义时数字并非从1开始，列表显示时也会正常工作，效果如下</p>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line"><span class="bullet">1.</span> 第一件物品</span><br><span class="line"><span class="bullet">1.</span> 第二件物品</span><br><span class="line"><span class="bullet">1.</span> 第三件物品</span><br><span class="line"><span class="bullet">1.</span> LOLOLOLOL</span><br></pre></td></tr></table></figure>
<ol>
<li>第一件物品</li>
<li>第二件物品</li>
<li>第三件物品</li>
<li>LOLOLOLOL</li>
</ol>
<h2 id="62-无序列表"><a class="markdownIt-Anchor" href="#62-无序列表"></a> 6.2 无序列表</h2>
<p>要创建无序列表，请在每个列表项前面添加破折号 (-)、星号 (*) 或加号 (+) 。缩进一个或多个列表项可创建嵌套列表。</p>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line"><span class="bullet">-</span> 第一件物品</span><br><span class="line"><span class="bullet">-</span> 第二件物品</span><br><span class="line"><span class="bullet">-</span> 第三件没了</span><br><span class="line"><span class="bullet">-</span> 再看一下上一行</span><br></pre></td></tr></table></figure>
<ul>
<li>第一件物品</li>
<li>第二件物品</li>
<li>第三件没了</li>
<li>再看一下上一行</li>
</ul>
<p>Typora快捷键: Crtl + Shift + ]</p>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line">无序列表四种符号均可使用</span><br><span class="line">但是不能混用,例如:</span><br><span class="line"><span class="bullet">-</span> 第一件物品</span><br><span class="line"><span class="bullet">+</span> 第二件物品</span><br><span class="line"><span class="bullet">-</span> 第三件没了</span><br><span class="line"><span class="bullet">*</span> 再看一下上一行</span><br></pre></td></tr></table></figure>
<h2 id="63-在列表中嵌套其他元素"><a class="markdownIt-Anchor" href="#63-在列表中嵌套其他元素"></a> 6.3 在列表中嵌套其他元素</h2>
<p>要在保留列表连续性的同时在列表中添加另一种元素，请将该元素缩进四个空格或一个制表符，如下例所示</p>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line"><span class="bullet">*</span>   This is the first list item.</span><br><span class="line"><span class="bullet">*</span>   Here's the second list item.</span><br><span class="line"></span><br><span class="line"><span class="code">    &gt; I need to add another paragraph below the second list item.</span></span><br><span class="line"><span class="code"></span></span><br><span class="line"><span class="bullet">*</span>   And here's the third list item.</span><br></pre></td></tr></table></figure>
<ul>
<li>
<p>This is the first list item.</p>
</li>
<li>
<p>Here's the second list item.</p>
<blockquote>
<p>I need to add another paragraph below the second list item.</p>
</blockquote>
</li>
<li>
<p>And here's the third list item.</p>
</li>
</ul>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line"><span class="bullet">1.</span>   This is the first list item.</span><br><span class="line"><span class="bullet">2.</span>   Here's the second list item.</span><br><span class="line"><span class="code">	</span></span><br><span class="line"><span class="code">	- 拦腰截断！</span></span><br><span class="line"><span class="code">	- 再接回去！</span></span><br><span class="line"><span class="code"></span></span><br><span class="line"><span class="bullet">3.</span>   And here's the third list item.</span><br></pre></td></tr></table></figure>
<ol>
<li>
<p>This is the first list item.</p>
</li>
<li>
<p>Here's the second list item.</p>
<ul>
<li>拦腰截断！</li>
<li>再接回去！</li>
</ul>
</li>
<li>
<p>And here's the third list item.</p>
</li>
</ol>
<h1 id="7-markdown-代码语法"><a class="markdownIt-Anchor" href="#7-markdown-代码语法"></a> 7 Markdown 代码语法</h1>
<h2 id="71-转义反引号"><a class="markdownIt-Anchor" href="#71-转义反引号"></a> 7.1 转义反引号</h2>
<p>要将单词或短语表示为代码，请将其包裹在反引号 (`) 中。</p>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line">一句话里面掺一些<span class="code">`代码`</span></span><br></pre></td></tr></table></figure>
<p>一句话里面掺一些<code>代码</code></p>
<p>如果你要表示为代码的单词或短语中包含一个或多个反引号，则可以通过将单词或短语包裹在双反引号(````)中。</p>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line"><span class="code">``Use `</span>code<span class="code">` in your Markdown file.`</span>`</span><br></pre></td></tr></table></figure>
<p><code>Use `code` in your Markdown file.</code></p>
<p>Typora快捷键: Crtl + Shift + Q</p>
<h2 id="72-围栏式代码块"><a class="markdownIt-Anchor" href="#72-围栏式代码块"></a> 7.2 围栏式代码块</h2>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line"><span class="code">```json</span></span><br><span class="line"><span class="code">{</span></span><br><span class="line"><span class="code">  "firstName": "John",</span></span><br><span class="line"><span class="code">  "lastName": "Smith",</span></span><br><span class="line"><span class="code">  "age": 25</span></span><br><span class="line"><span class="code">}</span></span><br><span class="line"><span class="code">```</span></span><br></pre></td></tr></table></figure>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">{</span></span><br><span class="line">  <span class="attr">"firstName"</span><span class="punctuation">:</span> <span class="string">"John"</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">"lastName"</span><span class="punctuation">:</span> <span class="string">"Smith"</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">"age"</span><span class="punctuation">:</span> <span class="number">25</span></span><br><span class="line"><span class="punctuation">}</span></span><br></pre></td></tr></table></figure>
<h1 id="8-markdown-分隔线语法"><a class="markdownIt-Anchor" href="#8-markdown-分隔线语法"></a> 8 Markdown 分隔线语法</h1>
<p>要创建分隔线，请在单独一行上使用三个或多个星号 (<code>***</code>)、破折号 (<code>---</code>) 或下划线 (<code>___</code>) ，并且不能包含其他内容。</p>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line"><span class="section"><span class="strong">***</span></span></span><br><span class="line"><span class="strong"><span class="section">---</span></span></span><br><span class="line"><span class="strong"><span class="section">________<span class="emphasis">_</span></span></span></span><br></pre></td></tr></table></figure>
<hr>
<hr>
<hr>
<p>为了兼容性，请在分隔线的前后均添加空白行。</p>
<table>
<thead>
<tr>
<th style="text-align:center">✅</th>
<th style="text-align:center">❌</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">Try to put a blank line before...<br><br>---<br><br>...and after a horizontal rule.</td>
<td style="text-align:center">Without blank lines, this would be a heading.<br>---<br>Don't do this!</td>
</tr>
</tbody>
</table>
<h1 id="9-markdown-链接语法"><a class="markdownIt-Anchor" href="#9-markdown-链接语法"></a> 9 Markdown 链接语法</h1>
<h2 id="91-标准链接语法"><a class="markdownIt-Anchor" href="#91-标准链接语法"></a> 9.1 标准链接语法</h2>
<p>链接文本放在中括号内，链接地址放在后面的括号中，链接title可选。</p>
<p>超链接Markdown语法代码：<code>[超链接显示名](超链接地址 "超链接title")</code></p>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line">[<span class="string">不懂就去问百度</span>](<span class="link">https://www.baidu.com</span>)</span><br></pre></td></tr></table></figure>
<p><a href="https://www.baidu.com">不懂就去问百度</a></p>
<h2 id="92-带title的链接语法"><a class="markdownIt-Anchor" href="#92-带title的链接语法"></a> 9.2 带title的链接语法</h2>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line">[<span class="string">不懂就去问百度</span>](<span class="link">https://www.baidu.com "这是百度哦😙"</span>)</span><br></pre></td></tr></table></figure>
<p><a href="https://www.baidu.com" title="这是百度哦😙">不懂就去问百度</a></p>
<h2 id="93-网址和email地址"><a class="markdownIt-Anchor" href="#93-网址和email地址"></a> 9.3 网址和Email地址</h2>
<p>使用尖括号可以很方便地把URL或者email地址变成可点击的链接。</p>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">www.bilibili.com</span>&gt;</span></span></span><br><span class="line"></span><br><span class="line">&lt;892920290@qq.com&gt;</span><br></pre></td></tr></table></figure>
<p>&lt;<a href="http://www.bilibili.com">www.bilibili.com</a>&gt;</p>
<p><a href="mailto:892920290@qq.com">892920290@qq.com</a></p>
<h2 id="94-带格式化的链接"><a class="markdownIt-Anchor" href="#94-带格式化的链接"></a> 9.4 带格式化的链接</h2>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line">I love supporting the <span class="strong">**[<span class="string">EFF</span>](<span class="link">https://eff.org</span>)**</span>.</span><br><span class="line">This is the <span class="emphasis">*[<span class="string">Markdown Guide</span>](<span class="link">https://www.markdownguide.org</span>)*</span>.</span><br><span class="line">See the section on [<span class="string">`code`</span>](<span class="link">#code</span>).</span><br></pre></td></tr></table></figure>
<p>I love supporting the <strong><a href="https://eff.org">EFF</a></strong>.<br>
This is the <em><a href="https://www.markdownguide.org">Markdown Guide</a></em>.<br>
See the section on <a href="#code"><code>code</code></a>.</p>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line">[<span class="symbol">百度</span>]: <span class="link">https://www.baidu.com "芝士百度"</span></span><br></pre></td></tr></table></figure>
<p>不懂就问[芝士百度][百度]</p>
<p>不同的 Markdown 应用程序处理URL中间的空格方式不一样。为了兼容性，请尽量使用%20代替空格。</p>
<table>
<thead>
<tr>
<th>✅ Do this</th>
<th>❌ Don't do this</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>[link](https://www.example.com/my%20great%20page)</code></td>
<td><code>[link](https://www.example.com/my great page)</code></td>
</tr>
</tbody>
</table>
<h2 id="95-脚注"><a class="markdownIt-Anchor" href="#95-脚注"></a> 9.5 脚注</h2>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line">[<span class="symbol">^footnote</span>]: <span class="link">这是个脚注</span></span><br></pre></td></tr></table></figure>
<p>您可以像这样创建脚注<sup class="footnote-ref"><a href="#fn1" id="fnref1">[1]</a></sup></p>
<h1 id="10-markdown-图片语法"><a class="markdownIt-Anchor" href="#10-markdown-图片语法"></a> 10 Markdown 图片语法</h1>
<h2 id="101-基础语法"><a class="markdownIt-Anchor" href="#101-基础语法"></a> 10.1 基础语法</h2>
<p>要添加图像，请使用感叹号 (<code>!</code>), 然后在方括号增加替代文本，图片链接放在圆括号里，括号里的链接后可以增加一个可选的图片标题文本。</p>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line">![<span class="string">W!</span>](<span class="link">https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/Markdown%E4%BD%BF%E7%94%A8/w.jpg</span>)</span><br></pre></td></tr></table></figure>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/Markdown%E4%BD%BF%E7%94%A8/w.jpg" alt="W!"></p>
<p>Typora快捷键: Crtl + Shift + I</p>
<h2 id="102-带链接的图像"><a class="markdownIt-Anchor" href="#102-带链接的图像"></a> 10.2 带链接的图像</h2>
<p>给图片增加链接，请将图像的Markdown 括在方括号中，然后将链接添加在圆括号中。</p>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line">[<span class="string">![风景图</span>](<span class="link">https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/Markdown%E4%BD%BF%E7%94%A8/small095125P47QH1707616285.jpg</span>)](<span class="link">https://www.baidu.com</span>)</span><br></pre></td></tr></table></figure>
<p><a href="https://www.baidu.com"><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/Markdown%E4%BD%BF%E7%94%A8/small095125P47QH1707616285.jpg" alt="图片描述"></a></p>
<h1 id="11-markdown-转义字符语法"><a class="markdownIt-Anchor" href="#11-markdown-转义字符语法"></a> 11 Markdown 转义字符语法</h1>
<h2 id="111-特殊字符用法"><a class="markdownIt-Anchor" href="#111-特殊字符用法"></a> 11.1 特殊字符用法</h2>
<p>要显示原本用于格式化 Markdown 文档的字符，请在字符前面添加反斜杠字符 \ 。</p>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line">\* Without the backslash, this would be a bullet in an unordered list.</span><br></pre></td></tr></table></figure>
<p>* Without the backslash, this would be a bullet in an unordered list.</p>
<h2 id="112-特殊字符自动转义"><a class="markdownIt-Anchor" href="#112-特殊字符自动转义"></a> 11.2 特殊字符自动转义</h2>
<p>在 HTML 文件中，有两个字符需要特殊处理： <code>&lt;</code> 和 <code>&amp;</code> 。 <code>&lt;</code> 符号用于起始标签，<code>&amp;</code> 符号则用于标记 HTML 实体，如果你只是想要使用这些符号，你必须要使用实体的形式，像是 <code>&lt;</code> 和 <code>&amp;</code>。</p>
<p>例如:</p>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line">http://images.google.com/images?num=30&amp;q=larry+bird</span><br></pre></td></tr></table></figure>
<p>应该如此才能正常使用</p>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line">http://images.google.com/images?num=30&amp;amp;q=larry+bird</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th style="text-align:center">&gt;</th>
<th style="text-align:center">&amp;</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><code>&amp;lt;</code></td>
<td style="text-align:center"><code>&amp;amp;</code></td>
</tr>
</tbody>
</table>
<h1 id="12-markdown-内嵌-html-标签"><a class="markdownIt-Anchor" href="#12-markdown-内嵌-html-标签"></a> 12 Markdown 内嵌 HTML 标签</h1>
<p>对于 Markdown 涵盖范围之外的标签，都可以直接在文件里面用 HTML 本身。如需使用 HTML，不需要额外标注这是 HTML 或是 Markdown，只需 HTML 标签添加到 Markdown 文本中即可。</p>
<h2 id="121-行级內联标签"><a class="markdownIt-Anchor" href="#121-行级內联标签"></a> 12.1 行级內联标签</h2>
<p>HTML 的行级內联标签如 <code>&lt;span&gt;</code>、<code>&lt;cite&gt;</code>、<code>&lt;del&gt;</code> 不受限制，可以在 Markdown 的段落、列表或是标题里任意使用。依照个人习惯，甚至可以不用 Markdown 格式，而采用 HTML 标签来格式化。例如：如果比较喜欢 HTML 的 <code>&lt;a&gt;</code> 或 <code>&lt;img&gt;</code> 标签，可以直接使用这些标签，而不用 Markdown 提供的链接或是图片语法。当你需要更改元素的属性时（例如为文本指定颜色或更改图像的宽度），使用 HTML 标签更方便些。</p>
<p>HTML 行级內联标签和区块标签不同，在內联标签的范围内， Markdown 的语法是可以解析的。</p>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line"><span class="strong">**这一段话既可以这么加粗**</span>,<span class="language-xml"><span class="tag">&lt;<span class="name">strong</span>&gt;</span></span>也可以这么加粗。<span class="language-xml"><span class="tag">&lt;/<span class="name">strong</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
<p><strong>这一段话既可以这么加粗</strong>,<strong>也可以这么加粗。</strong></p>
<h2 id="122-区块标签"><a class="markdownIt-Anchor" href="#122-区块标签"></a> 12.2 区块标签</h2>
<p>区块元素──比如 <code>&lt;div&gt;</code>、<code>&lt;table&gt;</code>、<code>&lt;pre&gt;</code>、<code>&lt;p&gt;</code> 等标签，必须在前后加上空行，以便于内容区分。而且这些元素的开始与结尾标签，不可以用 tab 或是空白来缩进。Markdown 会自动识别这区块元素，避免在区块标签前后加上没有必要的 <code>&lt;p&gt;</code> 标签。</p>
<p>例如，在 Markdown 文件里加上一段 HTML 表格：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">在标签之前的元素</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">span</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">strong</span>&gt;</span></span><br><span class="line">            span标签内的元素</span><br><span class="line">        <span class="tag">&lt;/<span class="name">strong</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">在标签之后的元素</span><br></pre></td></tr></table></figure>
<p>在标签之前的元素</p>
<div>
	<span>
        <strong>
            span标签内的元素
        </strong>
    </span>
</div>
在标签之后的元素
<p><strong>注意：在 HTML 块级标签内不能使用 Markdown 语法。例如 <code>&lt;p&gt;italic and **bold**&lt;/p&gt;</code> 将不起作用。</strong></p>
<h1 id="13-markdown拓展功能"><a class="markdownIt-Anchor" href="#13-markdown拓展功能"></a> 13 Markdown拓展功能</h1>
<h2 id="131-mermaid"><a class="markdownIt-Anchor" href="#131-mermaid"></a> 13.1 Mermaid</h2>
<p><strong>Mermaid 允许你使用文本和代码创建图表和可视化。</strong></p>
<p>它是一个基于 JavaScript 的图表绘制工具，可渲染 Markdown 启发的文本定义以动态创建和修改图表。</p>
<p>Mermaid 是一个基于 JavaScript 的图表绘制工具，它使用 Markdown 启发的文本定义和渲染器来创建和修改复杂的图表。Mermaid 的主要目的是帮助文档跟上开发的步伐。</p>
<p>Mermaid中文网:<a href="https://mermaid.nodejs.cn/intro/">关于 Mermaid | Mermaid 中文网 (nodejs.cn)</a></p>
<p><strong>流程图:</strong></p>
<pre class="mermaid">graph TD;
    A--&gt;B;
    A--&gt;C;
    B--&gt;D;
    C--&gt;D;</pre>
<p><strong>时序图:</strong></p>
<pre class="mermaid">sequenceDiagram
    participant Alice
    participant Bob
    Alice-&gt;&gt;John: Hello John, how are you?
    loop Healthcheck
        John-&gt;&gt;John: Fight against hypochondria
    end
    Note right of John: Rational thoughts <br>prevail!
    John--&gt;&gt;Alice: Great!
    John-&gt;&gt;Bob: How about you?
    Bob--&gt;&gt;John: Jolly good!</pre>
<p><strong>甘特图:</strong></p>
<pre class="mermaid">gantt
dateFormat  YYYY-MM-DD
title Adding GANTT diagram to mermaid
excludes weekdays 2014-01-10

section A section
Completed task            :done,    des1, 2014-01-06,2014-01-08
Active task               :active,  des2, 2014-01-09, 3d
Future task               :         des3, after des2, 5d
Future task2               :         des4, after des3, 5d</pre>
<p>等等</p>
<h2 id="132-latex"><a class="markdownIt-Anchor" href="#132-latex"></a> 13.2 LaTex</h2>
<p>LaTeX 是一个让你的文档看起来更专业的排版系统，而不是文字处理器。它尤其适合处理篇幅较长、结构严谨的文档，并且十分擅长处理公式表达。它是免费的软件，对大多数操作系统都适用。</p>
<p>LaTex <a href="https://oi-wiki.org/tools/latex/">LaTeX 入门 - OI Wiki (oi-wiki.org)</a></p>
<mjx-container class="MathJax" jax="SVG" display="true" width="full" style="min-width: 20.834ex;"><svg style="vertical-align: -1.5ex; min-width: 20.834ex;" xmlns="http://www.w3.org/2000/svg" width="100%" height="4.131ex" role="img" focusable="false"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(0.0181,-0.0181) translate(0, -1163)"><g data-mml-node="math"><g data-mml-node="mtable" transform="translate(2078,0) translate(-2078,0)"><g transform="translate(0 1163) matrix(1 0 0 -1 0 0) scale(55.25)"><svg data-table="true" preserveAspectRatio="xMidYMid" viewBox="2526.3 -1163 1 1826"><g transform="matrix(1 0 0 -1 0 0)"><g data-mml-node="mlabeledtr" transform="translate(0,45)"><g data-mml-node="mtd"><g data-mml-node="mi"><path data-c="1D436" d="M50 252Q50 367 117 473T286 641T490 704Q580 704 633 653Q642 643 648 636T656 626L657 623Q660 623 684 649Q691 655 699 663T715 679T725 690L740 705H746Q760 705 760 698Q760 694 728 561Q692 422 692 421Q690 416 687 415T669 413H653Q647 419 647 422Q647 423 648 429T650 449T651 481Q651 552 619 605T510 659Q484 659 454 652T382 628T299 572T226 479Q194 422 175 346T156 222Q156 108 232 58Q280 24 350 24Q441 24 512 92T606 240Q610 253 612 255T628 257Q648 257 648 248Q648 243 647 239Q618 132 523 55T319 -22Q206 -22 128 53T50 252Z"></path></g><g data-mml-node="mi" transform="translate(760,0)"><path data-c="1D443" d="M287 628Q287 635 230 637Q206 637 199 638T192 648Q192 649 194 659Q200 679 203 681T397 683Q587 682 600 680Q664 669 707 631T751 530Q751 453 685 389Q616 321 507 303Q500 302 402 301H307L277 182Q247 66 247 59Q247 55 248 54T255 50T272 48T305 46H336Q342 37 342 35Q342 19 335 5Q330 0 319 0Q316 0 282 1T182 2Q120 2 87 2T51 1Q33 1 33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM645 554Q645 567 643 575T634 597T609 619T560 635Q553 636 480 637Q463 637 445 637T416 636T404 636Q391 635 386 627Q384 621 367 550T332 412T314 344Q314 342 395 342H407H430Q542 342 590 392Q617 419 631 471T645 554Z"></path></g><g data-mml-node="mi" transform="translate(1511,0)"><path data-c="1D43C" d="M43 1Q26 1 26 10Q26 12 29 24Q34 43 39 45Q42 46 54 46H60Q120 46 136 53Q137 53 138 54Q143 56 149 77T198 273Q210 318 216 344Q286 624 286 626Q284 630 284 631Q274 637 213 637H193Q184 643 189 662Q193 677 195 680T209 683H213Q285 681 359 681Q481 681 487 683H497Q504 676 504 672T501 655T494 639Q491 637 471 637Q440 637 407 634Q393 631 388 623Q381 609 337 432Q326 385 315 341Q245 65 245 59Q245 52 255 50T307 46H339Q345 38 345 37T342 19Q338 6 332 0H316Q279 2 179 2Q143 2 113 2T65 2T43 1Z"></path></g><g data-mml-node="mo" transform="translate(2292.8,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path></g><g data-mml-node="mfrac" transform="translate(3348.6,0)"><g data-mml-node="mi" transform="translate(413,676)"><path data-c="1D45A" d="M21 287Q22 293 24 303T36 341T56 388T88 425T132 442T175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q303 442 384 442Q401 442 415 440T441 433T460 423T475 411T485 398T493 385T497 373T500 364T502 357L510 367Q573 442 659 442Q713 442 746 415T780 336Q780 285 742 178T704 50Q705 36 709 31T724 26Q752 26 776 56T815 138Q818 149 821 151T837 153Q857 153 857 145Q857 144 853 130Q845 101 831 73T785 17T716 -10Q669 -10 648 17T627 73Q627 92 663 193T700 345Q700 404 656 404H651Q565 404 506 303L499 291L466 157Q433 26 428 16Q415 -11 385 -11Q372 -11 364 -4T353 8T350 18Q350 29 384 161L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 181Q151 335 151 342Q154 357 154 369Q154 405 129 405Q107 405 92 377T69 316T57 280Q55 278 41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mrow" transform="translate(220,-686)"><g data-mml-node="mi"><path data-c="1D43C" d="M43 1Q26 1 26 10Q26 12 29 24Q34 43 39 45Q42 46 54 46H60Q120 46 136 53Q137 53 138 54Q143 56 149 77T198 273Q210 318 216 344Q286 624 286 626Q284 630 284 631Q274 637 213 637H193Q184 643 189 662Q193 677 195 680T209 683H213Q285 681 359 681Q481 681 487 683H497Q504 676 504 672T501 655T494 639Q491 637 471 637Q440 637 407 634Q393 631 388 623Q381 609 337 432Q326 385 315 341Q245 65 245 59Q245 52 255 50T307 46H339Q345 38 345 37T342 19Q338 6 332 0H316Q279 2 179 2Q143 2 113 2T65 2T43 1Z"></path></g><g data-mml-node="mi" transform="translate(504,0)"><path data-c="1D436" d="M50 252Q50 367 117 473T286 641T490 704Q580 704 633 653Q642 643 648 636T656 626L657 623Q660 623 684 649Q691 655 699 663T715 679T725 690L740 705H746Q760 705 760 698Q760 694 728 561Q692 422 692 421Q690 416 687 415T669 413H653Q647 419 647 422Q647 423 648 429T650 449T651 481Q651 552 619 605T510 659Q484 659 454 652T382 628T299 572T226 479Q194 422 175 346T156 222Q156 108 232 58Q280 24 350 24Q441 24 512 92T606 240Q610 253 612 255T628 257Q648 257 648 248Q648 243 647 239Q618 132 523 55T319 -22Q206 -22 128 53T50 252Z"></path></g></g><rect width="1464" height="60" x="120" y="220"></rect></g></g></g></g></svg><svg data-labels="true" preserveAspectRatio="xMaxYMid" viewBox="1278 -1163 1 1826"><g data-labels="true" transform="matrix(1 0 0 -1 0 0)"><g data-mml-node="mtd" id="mjx-eqn:1" transform="translate(0,795)"><text data-id-align="true"></text><g data-idbox="true" transform="translate(0,-750)"><g data-mml-node="mtext"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z" transform="translate(389,0)"></path><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z" transform="translate(889,0)"></path></g></g></g></g></svg></g></g></g></g></svg></mjx-container>

<hr class="footnotes-sep">
<section class="footnotes">
<ol class="footnotes-list">
<li id="fn1" class="footnote-item"><p>这是个脚注 <a href="#fnref1" class="footnote-backref">↩︎</a></p>
</li>
</ol>
</section>
]]></content>
      <categories>
        <category>Markdown</category>
      </categories>
      <tags>
        <tag>基础</tag>
        <tag>教程</tag>
        <tag>Markdown</tag>
      </tags>
  </entry>
  <entry>
    <title>学成在线Day01</title>
    <url>/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFDay01/</url>
    <content><![CDATA[<h1 id="学成在线day01"><a class="markdownIt-Anchor" href="#学成在线day01"></a> 学成在线Day01</h1>
<h1 id="开发工具版本"><a class="markdownIt-Anchor" href="#开发工具版本"></a> 开发工具版本</h1>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240207192456061.png" alt="image-20240207192456061"></p>
<h1 id="环境搭建"><a class="markdownIt-Anchor" href="#环境搭建"></a> 环境搭建</h1>
<h2 id="搭建环境时遇到的问题"><a class="markdownIt-Anchor" href="#搭建环境时遇到的问题"></a> 搭建环境时遇到的问题</h2>
<table>
<thead>
<tr>
<th style="text-align:center"><strong>出现问题</strong></th>
<th style="text-align:center"><strong>解决方案</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">虚拟机启动后IP地址不对</td>
<td style="text-align:center">通过主机cmd的ipconfig指令查看正确虚拟机指令</td>
</tr>
<tr>
<td style="text-align:center">无法连接Mysql等服务</td>
<td style="text-align:center">应按照教程填写IP地址，不要自己发挥</td>
</tr>
<tr>
<td style="text-align:center">引入资料的maven依赖爆红显示找不到文件</td>
<td style="text-align:center">将<dependencymanagement>标签注释后加载完成后再取消注释即可</dependencymanagement></td>
</tr>
</tbody>
</table>
<h2 id="基础工程搭建"><a class="markdownIt-Anchor" href="#基础工程搭建"></a> 基础工程搭建</h2>
<h3 id="工程结构关系"><a class="markdownIt-Anchor" href="#工程结构关系"></a> 工程结构关系</h3>
<img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240318093529814.png" alt="image-20240318093529814" style="zoom:50%;">
<p>每一种类的工程都有不同的作用，下面是对其功能进行说明：</p>
<ul>
<li>
<p>父工程</p>
<ul>
<li>对依赖包的版本进行管理</li>
<li>本身为Pom工程，对子工程进行聚合管理</li>
</ul>
</li>
<li>
<p>基础工程</p>
<ul>
<li>继承父类工程</li>
<li>提供基础类库</li>
<li>提供工具类库</li>
</ul>
</li>
<li>
<p>微服务工程</p>
</li>
<li>
<p>分别从业务、技术方面划分模块，每个模块构建为一个微服务。</p>
</li>
</ul>
<h3 id="构建父工程"><a class="markdownIt-Anchor" href="#构建父工程"></a> 构建父工程</h3>
<p>父工程创建过程中记得<strong>组名</strong>,<strong>包名</strong>,<strong>工件</strong>不要填写错误</p>
<p>创建完成内部后仅保留pom.xml文件</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.xuecheng<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>xuecheng-plus-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>xuecheng-plus-parent<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>xuecheng-plus-parent<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">project.reporting.outputEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.reporting.outputEncoding</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">spring-boot.version</span>&gt;</span>2.3.7.RELEASE<span class="tag">&lt;/<span class="name">spring-boot.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">spring-cloud.version</span>&gt;</span>Hoxton.SR9<span class="tag">&lt;/<span class="name">spring-cloud.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">org.mapstruct.version</span>&gt;</span>1.3.1.Final<span class="tag">&lt;/<span class="name">org.mapstruct.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">spring-cloud-alibaba.version</span>&gt;</span>2.2.6.RELEASE<span class="tag">&lt;/<span class="name">spring-cloud-alibaba.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">org.projectlombok.version</span>&gt;</span>1.18.8<span class="tag">&lt;/<span class="name">org.projectlombok.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">javax.servlet-api.version</span>&gt;</span>4.0.1<span class="tag">&lt;/<span class="name">javax.servlet-api.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">fastjson.version</span>&gt;</span>1.2.83<span class="tag">&lt;/<span class="name">fastjson.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">druid-spring-boot-starter.version</span>&gt;</span>1.2.8<span class="tag">&lt;/<span class="name">druid-spring-boot-starter.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mysql-connector-java.version</span>&gt;</span>8.0.30<span class="tag">&lt;/<span class="name">mysql-connector-java.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mybatis-plus-boot-starter.version</span>&gt;</span>3.4.1<span class="tag">&lt;/<span class="name">mybatis-plus-boot-starter.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">commons-lang.version</span>&gt;</span>2.6<span class="tag">&lt;/<span class="name">commons-lang.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">minio.version</span>&gt;</span>8.4.3<span class="tag">&lt;/<span class="name">minio.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">xxl-job-core.version</span>&gt;</span>2.3.1<span class="tag">&lt;/<span class="name">xxl-job-core.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">swagger-annotations.version</span>&gt;</span>1.5.20<span class="tag">&lt;/<span class="name">swagger-annotations.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">commons-lang3.version</span>&gt;</span>3.10<span class="tag">&lt;/<span class="name">commons-lang3.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">okhttp.version</span>&gt;</span>4.8.1<span class="tag">&lt;/<span class="name">okhttp.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">swagger-spring-boot-starter.version</span>&gt;</span>1.9.0.RELEASE<span class="tag">&lt;/<span class="name">swagger-spring-boot-starter.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">elasticsearch.version</span>&gt;</span>7.12.1<span class="tag">&lt;/<span class="name">elasticsearch.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>${spring-cloud.version}<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>${spring-boot.version}<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-alibaba-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>${spring-cloud-alibaba.version}<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- lombok，简化类的构建--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>${org.projectlombok.version}<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- mapstruct 代码生成器，简化java bean之间的映射 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mapstruct<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mapstruct-jdk8<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>${org.mapstruct.version}<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mapstruct<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mapstruct-processor<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>${org.mapstruct.version}<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.swagger<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>swagger-annotations<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>${swagger-annotations.version}<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- Servlet 容器管理 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.servlet<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javax.servlet-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>${javax.servlet-api.version}<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- fastjson ，json解析工具 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>${fastjson.version}<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- druid 连接池管理 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>${druid-spring-boot-starter.version}<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">&lt;!-- mySQL数据库驱动包管理 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>${mysql-connector-java.version}<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- mybatis plus 集成Spring Boot启动器 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>${mybatis-plus-boot-starter.version}<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">&lt;!-- mybatis plus 代码生成器 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-plus-generator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>${mybatis-plus-boot-starter.version}<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">&lt;!-- 工具类管理 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-lang<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-lang<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>${commons-lang.version}<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 分布式文件系统 minIO的客户端API包 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.minio<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>minio<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>${minio.version}<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--google推荐的一套工具类库--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.google.guava<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>guava<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>25.0-jre<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--分布式任务调度--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.xuxueli<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>xxl-job-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>${xxl-job-core.version}<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--Spring boot单元测试--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>${spring-boot.version}<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.junit.vintage<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit-vintage-engine<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.squareup.okhttp3<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>okhttp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>${okhttp.version}<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-lang3<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>${commons-lang3.version}<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.spring4all<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>swagger-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>${swagger-spring-boot-starter.version}<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.elasticsearch.client<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>elasticsearch-rest-high-level-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>${elasticsearch.version}<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.elasticsearch<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>elasticsearch<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>${elasticsearch.version}<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">finalName</span>&gt;</span>${project.name}<span class="tag">&lt;/<span class="name">finalName</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--编译打包过虑配置--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">resources</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">resource</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">directory</span>&gt;</span>src/main/resources<span class="tag">&lt;/<span class="name">directory</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">filtering</span>&gt;</span>true<span class="tag">&lt;/<span class="name">filtering</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">includes</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">include</span>&gt;</span>**/*<span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">includes</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">resource</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">resource</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">directory</span>&gt;</span>src/main/java<span class="tag">&lt;/<span class="name">directory</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">includes</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">include</span>&gt;</span>**/*.xml<span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">includes</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">resource</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">resources</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.8.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                    <span class="comment">&lt;!--指定项目源码jdk的版本--&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">source</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">                    <span class="comment">&lt;!--指定项目编译后的jdk的版本--&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">target</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">                    <span class="comment">&lt;!--配置注解预编译--&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">annotationProcessorPaths</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">path</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">version</span>&gt;</span>${org.projectlombok.version}<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">path</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">annotationProcessorPaths</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">&lt;!--责处理项目资源文件并拷贝到输出目录，如果有额外的资源文件目录则需要配置--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-resources-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.3.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">encoding</span>&gt;</span>utf-8<span class="tag">&lt;/<span class="name">encoding</span>&gt;</span></span><br><span class="line">                    <span class="comment">&lt;!--使用默认分隔符，resource中可以使用分割符定义过虑的路径--&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">useDefaultDelimiters</span>&gt;</span>true<span class="tag">&lt;/<span class="name">useDefaultDelimiters</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>最终情况如下</p>
<img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240318094358268.png" alt="image-20240318094358268" style="zoom:33%;">
<h3 id="构建基础工程"><a class="markdownIt-Anchor" href="#构建基础工程"></a> 构建基础工程</h3>
<p>父工程创建过程中记得<strong>组名</strong>,<strong>包名</strong>,<strong>工件</strong>不要填写错误</p>
<p>创建完成内部后仅保留pom.xml文件</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.xuecheng<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>xuecheng-plus-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">relativePath</span>&gt;</span>../xuecheng-plus-parent<span class="tag">&lt;/<span class="name">relativePath</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>xuecheng-plus-base<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-lang3<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- fast Json --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- servlet Api 依赖 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.servlet<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javax.servlet-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- 通用组件 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-lang<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-lang<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-codec<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-codec<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.11<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.swagger<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>swagger-annotations<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-validation<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-log4j2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--根据扩展名取mimetype--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.j256.simplemagic<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>simplemagic<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.17<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-lang3<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.google.zxing<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.3.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.google.zxing<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javase<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.3.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.module<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-module-parameter-names<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.datatype<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-datatype-jdk8<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.datatype<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-datatype-jsr310<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>最终情况如下:</p>
<img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240318094433486.png" alt="image-20240318094433486" style="zoom:50%;">
]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>学习</tag>
        <tag>后端</tag>
        <tag>黑马程序员</tag>
        <tag>学成在线</tag>
      </tags>
  </entry>
  <entry>
    <title>学成在线Day02</title>
    <url>/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFDay02/</url>
    <content><![CDATA[<h1 id="开发持久层"><a class="markdownIt-Anchor" href="#开发持久层"></a> 开发持久层</h1>
<p>在真实开发中，切记从底层向上层开发。例如项目应该先写持久层(mapper)再写业务层(service)</p>
<h1 id="分页查询测试代码"><a class="markdownIt-Anchor" href="#分页查询测试代码"></a> 分页查询测试代码</h1>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testCourseBaseMapper</span><span class="params">()</span>{</span><br><span class="line">    <span class="type">CourseBase</span> <span class="variable">courseBase</span> <span class="operator">=</span> courseBaseMapper.selectById(<span class="number">18</span>);</span><br><span class="line">    System.out.println(courseBase);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//拼装分页查询条件</span></span><br><span class="line">    <span class="type">QueryCourseParamsDto</span> <span class="variable">queryCourseParamsDto</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">QueryCourseParamsDto</span>();</span><br><span class="line">    queryCourseParamsDto.setCourseName(<span class="string">"java"</span>);<span class="comment">//课程名称为查询条件</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//封装查询条件</span></span><br><span class="line">    LambdaQueryWrapper&lt;CourseBase&gt; courseBaseLambdaQueryWrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();</span><br><span class="line">    <span class="comment">//根据课程名称模糊查询,sql为course_base.name like '%?%'</span></span><br><span class="line">    courseBaseLambdaQueryWrapper.like(StringUtils.isNotEmpty(queryCourseParamsDto.getCourseName()),</span><br><span class="line">                                      CourseBase::getName,</span><br><span class="line">                                      queryCourseParamsDto.getCourseName());</span><br><span class="line">    <span class="comment">//根据课程状态查询,sql为course_base.audit_status = ?</span></span><br><span class="line">    courseBaseLambdaQueryWrapper.like(StringUtils.isNotEmpty(queryCourseParamsDto.getAuditStatus()),</span><br><span class="line">                                      CourseBase::getAuditStatus,</span><br><span class="line">                                      queryCourseParamsDto.getAuditStatus());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//创建分页查询类</span></span><br><span class="line">    <span class="type">PageParams</span> <span class="variable">pageParams</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PageParams</span>(<span class="number">1L</span>,<span class="number">2L</span>);</span><br><span class="line">    <span class="comment">//创建分页对象,参数为当前页码,每页记录数</span></span><br><span class="line">    Page&lt;CourseBase&gt; page = <span class="keyword">new</span> <span class="title class_">Page</span>&lt;&gt;(pageParams.getPageNo(), pageParams.getPageSize());</span><br><span class="line">    <span class="comment">//获取分页查询结果</span></span><br><span class="line">    Page&lt;CourseBase&gt; courseBasePage = courseBaseMapper.selectPage(page, courseBaseLambdaQueryWrapper);</span><br><span class="line">    <span class="comment">//获取数据列表</span></span><br><span class="line">    List&lt;CourseBase&gt; records = courseBasePage.getRecords();</span><br><span class="line">    <span class="comment">//获取记录总数</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">total</span> <span class="operator">=</span> courseBasePage.getTotal();</span><br><span class="line"></span><br><span class="line">    PageResult&lt;CourseBase&gt; result = <span class="keyword">new</span> <span class="title class_">PageResult</span>&lt;&gt;(records,total,pageParams.getPageNo(), pageParams.getPageSize());</span><br><span class="line"></span><br><span class="line">    System.out.println(result);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>本篇用到大量mybatis-plus内容,先去学习这块内容(2.11已学习完Mybatis-plus)</p>
<h3 id="利用http-client插件生成http请求"><a class="markdownIt-Anchor" href="#利用http-client插件生成http请求"></a> 利用Http Client插件生成http请求</h3>
<p>插件:</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240211163239135.png" alt="image-20240211163239135"></p>
<p>点击此处可以生成Http请求</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240211163338945.png" alt="image-20240211163338945"></p>
<p>例如分页查询的请求可以这么写</p>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line">### 查询课程信息</span><br><span class="line">POST http://localhost:8080/course/list?pageNo=1&amp;pageSize=2</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/json</span><br><span class="line"></span><br><span class="line">{</span><br><span class="line">  "auditStatus": "202004",</span><br><span class="line">  "courseName": "java",</span><br><span class="line">  "publishStatus": ""</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>在项目根目录下建立文件夹统一存放请求测试</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240211163614502.png" alt="image-20240211163614502"></p>
<p>为了方便将来和网关集成测试，这里我们把测试主机地址在配置文件http-client.env.json 中配置<img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240211163817932.png" alt="image-20240211163817932"></p>
<p>注意要调用http-client.env.json文件内容需要将使用以下环境运行调整至dev<img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240211164035140.png" alt="image-20240211164035140"></p>
<h1 id="跨域三种解决方案"><a class="markdownIt-Anchor" href="#跨域三种解决方案"></a> 跨域三种解决方案</h1>
<p>在浏览器通过http://localhost:8601/地址访问前端工程。</p>
<p>chrome浏览器报错如下：</p>
<blockquote>
<p>Access to XMLHttpRequest at  '<a href="http://localhost:63110/system/dictionary/all">http://localhost:63110/system/dictionary/all</a>' from origin  '<a href="http://localhost:8601">http://localhost:8601</a>' has been blocked by CORS policy: No  'Access-Control-Allow-Origin' header is present on the requested resource.</p>
</blockquote>
<p>Firefox浏览器报错如下：</p>
<blockquote>
<p>已拦截跨源请求：同源策略禁止读取位于 <a href="http://localhost:63110/system/dictionary/all">http://localhost:63110/system/dictionary/all</a> 的远程资源。（原因：CORS  头缺少 'Access-Control-Allow-Origin'）。状态码：200。</p>
</blockquote>
<p>提示：从http://localhost:8601访问http://localhost:63110/system/dictionary/all被CORS policy阻止，因为没有Access-Control-Allow-Origin 头信息。CORS全称是 cross origin resource share 表示跨域资源共享。</p>
<p>出这个提示的原因是基于浏览器的同源策略，去判断是否跨域请求，同源策略是浏览器的一种安全机制，从一个地址请求另一个地址，如果协议、主机、端口三者全部一致则不属于跨域，否则有一个不一致就是跨域请求。</p>
<p>比如：</p>
<ul>
<li>
<p>从http://localhost:8601 到  <a href="http://localhost:8602">http://localhost:8602</a> 由于端口不同，是跨域。</p>
</li>
<li>
<p>从http://192.168.101.10:8601 到  <a href="http://192.168.101.11:8601">http://192.168.101.11:8601</a> 由于主机不同，是跨域。</p>
</li>
<li>
<p>从http://192.168.101.10:8601 到  <a href="https://192.168.101.11:8601">https://192.168.101.10:8601</a> 由于协议不同，是跨域。</p>
</li>
</ul>
<p>注意：服务器之间不存在跨域请求。</p>
<p>浏览器判断是跨域请求会在请求头上添加origin，表示这个请求来源哪里。</p>
<p>比如：</p>
<blockquote>
<p>GET / HTTP/1.1</p>
<p>Origin: <a href="http://localhost:8601">http://localhost:8601</a></p>
</blockquote>
<p>服务器收到请求判断这个Origin是否允许跨域，如果允许则在响应头中说明允许该来源的跨域请求，如下：</p>
<blockquote>
<p>Access-Control-Allow-Origin：<a href="http://localhost:8601">http://localhost:8601</a></p>
</blockquote>
<p>如果允许任何域名来源的跨域请求，则响应如下：</p>
<blockquote>
<p>Access-Control-Allow-Origin：*</p>
</blockquote>
<h3 id="第一种-json"><a class="markdownIt-Anchor" href="#第一种-json"></a> 第一种 JSON</h3>
<p>通过script标签的src属性进行跨域请求，如果服务端要响应内容则首先读取请求参数callback的值，callback是一个回调函数的名称，服务端读取callback的值后将响应内容通过调用callback函数的方式告诉请求方。如下图：</p>
<img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240318123843870.png" alt="image-20240318123843870" style="zoom:50%;">
<h3 id="第二种-添加响应头"><a class="markdownIt-Anchor" href="#第二种-添加响应头"></a> 第二种 添加响应头</h3>
<p>服务端在响应头添加 <code>Access-Control-Allow-Origin：*</code></p>
<h3 id="第三种-通过nginx代理跨域"><a class="markdownIt-Anchor" href="#第三种-通过nginx代理跨域"></a> 第三种 通过nginx代理跨域</h3>
<p>由于服务端之间没有跨域，浏览器通过nginx去访问跨域地址。</p>
<img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240318124740478.png" alt="image-20240318124740478" style="zoom:50%;">
<ol>
<li>
<p>浏览器先访问http://192.168.101.10:8601 nginx提供的地址，进入页面</p>
</li>
<li>
<p>此页面要跨域访问http://192.168.101.11:8601 ，不能直接跨域访问http://www.baidu.com:8601 ，而是访问nginx的一个同源地址，比如：<a href="http://192.168.101.11:8601/api">http://192.168.101.11:8601/api</a> ，通过http://192.168.101.11:8601/api 的代理去访问http://www.baidu.com:8601。</p>
</li>
</ol>
<p>这样就实现了跨域访问。</p>
<p>浏览器到http://192.168.101.11:8601/api 没有跨域</p>
<p>nginx到http://www.baidu.com:8601通过服务端通信，没有跨域。</p>
<p><em><strong>本项目采用第二种方法解决跨域问题</strong></em></p>
<h1 id="前后端联调"><a class="markdownIt-Anchor" href="#前后端联调"></a> 前后端联调</h1>
<p>这里进行前后联调的目的是体会前后端联调的流程，测试的功能为课程查询功能。</p>
<p>1、启动前端工程，再启内容管理服务端。</p>
<p>2、修改服务端地址</p>
<p>前端默认连接的是项目的网关地址，由于现在网关工程还没有创建，这里需要更改前端工程的参数配置文件 ，修改网关地址为内容管理服务的地址。</p>
<p>启动前端工程，用前端访问后端接口，观察前端界面的数据是否正确。</p>
<h1 id="课程分类查询"><a class="markdownIt-Anchor" href="#课程分类查询"></a> 课程分类查询</h1>
<p>分类表中的数据为树形结构：</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240211185359606.png" alt="image-20240211185359606"></p>
<h3 id="树形数据库查询"><a class="markdownIt-Anchor" href="#树形数据库查询"></a> 树形数据库查询</h3>
<h4 id="树层级确定"><a class="markdownIt-Anchor" href="#树层级确定"></a> 树层级确定</h4>
<p>课程分类表是一个树型结构，其中parentid字段为父结点ID，它是树型结构的标志字段。</p>
<p>如果树的层级固定可以使用表的自链接去查询，比如：我们只查询两级课程分类，可以用下边的SQL</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">select *</span><br><span class="line">from course_category one</span><br><span class="line">         inner join course_category two on one.id = two.parentid</span><br><span class="line">where one.parentid = 1</span><br><span class="line">  and one.is_show = 1</span><br><span class="line">  and two.is_show = 1</span><br><span class="line">order by one.orderby, two.orderby;</span><br></pre></td></tr></table></figure>
<p>注意此时的order by 根据两个条件，其效果是先根据one.orderby排序,其内部排序结果再由two.orderby排序。</p>
<h4 id="树层级不确定"><a class="markdownIt-Anchor" href="#树层级不确定"></a> 树层级不确定</h4>
<p>此时可以使用MySQL递归实现，使用with语法，如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">WITH RECURSIVE cte_name (column_list) AS (</span><br><span class="line">    SELECT initial_query_result</span><br><span class="line">    UNION [ALL]</span><br><span class="line">    SELECT recursive_query</span><br><span class="line">    FROM cte_name</span><br><span class="line">    WHERE condition</span><br><span class="line">)</span><br><span class="line">SELECT * FROM cte_name;</span><br></pre></td></tr></table></figure>
<p>MySQL with Recursive语法详解</p>
<ol>
<li>
<p>WITH RECURSIVE：表示要使用递归查询的方式处理数据。</p>
</li>
<li>
<p>cte_name：给这个临时的递归表取个名字，可以在初始查询和递归查询中引用。</p>
</li>
<li>
<p>column_list：表示cte_name查询表中包含的列名，列名之间用逗号分隔。</p>
</li>
<li>
<p>initial_query_result：表示初始的查询结果，应该与column_list中的列名对应。</p>
</li>
<li>
<p>UNION：表示将两个查询结果集进行联合，使用UNION ALL则表示保留重复数据。</p>
</li>
<li>
<p>recursive_query：表示递归查询语句，应当与column_list中的列名对应。</p>
</li>
<li>
<p>condition：表示递归查询的终止条件，需要使用cte_name中的列进行判</p>
</li>
<li>
<p>SELECT * FROM cte_name：表示最终返回的查询结果集，可以通过cte_name查询表中的列名进行指定。</p>
</li>
</ol>
<p>下边是一个递归的简单例子：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">with RECURSIVE t1 AS   (    </span><br><span class="line">	SELECT 1 as n    </span><br><span class="line">	UNION ALL    </span><br><span class="line">	SELECT n + 1 FROM t1 WHERE n &lt; 5   </span><br><span class="line">)   </span><br><span class="line">SELECT * FROM t1;</span><br></pre></td></tr></table></figure>
<p>输出：</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240211193838531.png" alt="image-20240211193838531"></p>
<p>课程分类表层级固定查询sql:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">select *</span><br><span class="line">from course_category one</span><br><span class="line">         inner join course_category two on one.id = two.parentid</span><br><span class="line">where one.parentid = 1</span><br><span class="line">  and one.is_show = 1</span><br><span class="line">  and two.is_show = 1</span><br><span class="line">order by one.orderby, two.orderby;</span><br></pre></td></tr></table></figure>
<p>课程分类表层级不固定查询sql:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">with recursive t1 as (</span><br><span class="line">    select * from course_category where id = '1'</span><br><span class="line">    union all</span><br><span class="line">    select t2.* from course_category t2 inner join t1 on t2.parentid = t1.id</span><br><span class="line">)</span><br><span class="line">select * from t1 order by t1.id;</span><br></pre></td></tr></table></figure>
<p>以上是我们研究了树型表的查询方法，通过递归的方式查询课程分类比较灵活，因为它可以不限制层级。</p>
<p>mysql为了避免无限递归默认递归次数为1000，可以通过设置cte_max_recursion_depth参数增加递归深度，还可以通过max_execution_time限制执行时间，超过此时间也会终止递归操作。</p>
<p>mysql递归相当于在存储过程中执行若干次sql语句，java程序仅与数据库建立一次链接执行递归操作，所以只要控制好递归深度，控制好数据量性能就没有问题。</p>
<p>思考：如果java程序在递归操作中连接数据库去查询数据组装数据，这个性能高吗？</p>
<p>答：若在mysql中执行递归查询，java与数据库只用连接一次。若在java中使用递归查询则会连接多次，浪费性能。</p>
<h3 id="service层处理"><a class="markdownIt-Anchor" href="#service层处理"></a> service层处理</h3>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> List&lt;CourseCategoryDTO&gt; <span class="title function_">queryTreeNodes</span><span class="params">(String id)</span> {</span><br><span class="line">    <span class="comment">//调用mapper查询分类信息</span></span><br><span class="line">    List&lt;CourseCategoryDTO&gt; courseCategoryDTOS = courseCategoryMapper.selectTreeNodes(id);</span><br><span class="line">    <span class="comment">//封装成list类型返回</span></span><br><span class="line">    <span class="comment">//将list转换成map,key为id,value为CourseCategoryDTO</span></span><br><span class="line">    Map&lt;String, CourseCategoryDTO&gt; map = courseCategoryDTOS.stream()</span><br><span class="line">        .collect(Collectors.toMap(CourseCategory::getId, value -&gt; value, (key1, key2) -&gt; key2));</span><br><span class="line">    <span class="comment">//遍历list,查找collect子节点</span></span><br><span class="line">    List&lt;CourseCategoryDTO&gt; result = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    courseCategoryDTOS.stream().filter(item -&gt; !id.equals(item.getId())) <span class="comment">//去除根节点</span></span><br><span class="line">        .forEach(item -&gt; {</span><br><span class="line">            <span class="keyword">if</span> ( item.getParentid().equals(id) ) {</span><br><span class="line">                result.add(item);</span><br><span class="line">            }</span><br><span class="line">            <span class="type">CourseCategoryDTO</span> <span class="variable">courseCategoryDTO</span> <span class="operator">=</span> map.get(item.getParentid());</span><br><span class="line">            <span class="comment">//父节点属于要要找的节点则此时会在map中,若不是要找的节点则会被filter过滤</span></span><br><span class="line">            <span class="keyword">if</span> ( courseCategoryDTO != <span class="literal">null</span> ) {</span><br><span class="line">                <span class="comment">//如果该父节点的子节点集合为空,设置一个新的集合</span></span><br><span class="line">                <span class="keyword">if</span> ( courseCategoryDTO.getChildrenTreeNodes() == <span class="literal">null</span> ) {</span><br><span class="line">                    courseCategoryDTO.setChildrenTreeNodes(<span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;());</span><br><span class="line">                }</span><br><span class="line">                courseCategoryDTO.getChildrenTreeNodes().add(item);</span><br><span class="line">            }</span><br><span class="line">        });</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h1 id="新增课程"><a class="markdownIt-Anchor" href="#新增课程"></a> 新增课程</h1>
<p>注意涉及到增删改查记得要添加**@Transactional**注解</p>
<p>注意当事务回滚时ID仍然自增，因为innodb的auto_increament的计数器记录的当前值是保存在存内 存中的，并不是存在于磁盘上，当mysql server处于运行的时候，这个计数值只会随着 insert 改增长，不会随着delete而减少。</p>
<p>所以最后要在courseMarket设置ID，而不是直接插入</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> CourseBaseInfoDTO <span class="title function_">createCourseBaseInfo</span><span class="params">(Long companyId, AddCourseDTO addcourseDTO)</span> {</span><br><span class="line">    <span class="comment">//合法性校验</span></span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isBlank(addcourseDTO.getName())) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">"课程名称为空"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isBlank(addcourseDTO.getMt())) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">"课程分类为空"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isBlank(addcourseDTO.getSt())) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">"课程分类为空"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isBlank(addcourseDTO.getGrade())) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">"课程等级为空"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isBlank(addcourseDTO.getTeachmode())) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">"教育模式为空"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isBlank(addcourseDTO.getUsers())) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">"适应人群为空"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isBlank(addcourseDTO.getCharge())) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">"收费规则为空"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">//1.向课程信息表(course_Base)写入信息</span></span><br><span class="line">    <span class="type">CourseBase</span> <span class="variable">courseBase</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CourseBase</span>();</span><br><span class="line">    BeanUtils.copyProperties(addcourseDTO,courseBase);</span><br><span class="line">    courseBase.setCompanyId(companyId);</span><br><span class="line">    courseBase.setCreateDate(LocalDateTime.now());</span><br><span class="line">    <span class="comment">//审核状态默认未提交</span></span><br><span class="line">    courseBase.setAuditStatus(<span class="string">"202002"</span>);</span><br><span class="line">    <span class="comment">//发布状态为未发布</span></span><br><span class="line">    courseBase.setStatus(<span class="string">"203001"</span>);</span><br><span class="line">    <span class="type">int</span> <span class="variable">insert</span> <span class="operator">=</span> courseBaseMapper.insert(courseBase);</span><br><span class="line">    <span class="keyword">if</span>(insert &lt;= <span class="number">0</span>){</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">"添加课程失败"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//2.向课程营销表(course_market)写入信息</span></span><br><span class="line">    <span class="comment">//课程营销信息</span></span><br><span class="line">    <span class="type">CourseMarket</span> <span class="variable">courseMarket</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CourseMarket</span>();</span><br><span class="line">    <span class="type">Long</span> <span class="variable">courseId</span> <span class="operator">=</span> courseBase.getId();</span><br><span class="line">    BeanUtils.copyProperties(addcourseDTO,courseMarket);</span><br><span class="line">    courseMarket.setId(courseId);</span><br><span class="line">    <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> saveCourseMarket(courseMarket);</span><br><span class="line">    <span class="keyword">if</span>(i&lt;=<span class="number">0</span>){</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">"保存课程营销信息失败"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//查询课程基本信息及营销信息并返回</span></span><br><span class="line">    <span class="keyword">return</span> getCourseBaseInfo(courseId);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h1 id="异常处理"><a class="markdownIt-Anchor" href="#异常处理"></a> 异常处理</h1>
<p>异常处理方法用的三个注解:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@ResponseBody</span>									  <span class="comment">//将java对象转换成json格式</span></span><br><span class="line"><span class="meta">@ExceptionHandler(XueChengPlusException.class)</span>    <span class="comment">//利用字节码文件捕获对应异常</span></span><br><span class="line"><span class="meta">@ResponseStatus(HttpStatus.INTERNAL_SERVER_ERROR)</span> <span class="comment">//设置响应码</span></span><br></pre></td></tr></table></figure>
<p>注意到类上用了</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@ControllerAdvice</span></span><br></pre></td></tr></table></figure>
<p>我们可以使用</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestControllerAdvice</span></span><br></pre></td></tr></table></figure>
<p>@RestControllerAdvice注解包含了@ControllerAdvice注解和@ResponseBody注解</p>
]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>学习</tag>
        <tag>后端</tag>
        <tag>黑马程序员</tag>
        <tag>学成在线</tag>
      </tags>
  </entry>
  <entry>
    <title>学成在线Day03</title>
    <url>/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFDay03/</url>
    <content><![CDATA[<h1 id="jsr303校验"><a class="markdownIt-Anchor" href="#jsr303校验"></a> JSR303校验</h1>
<h3 id="统一校验实现"><a class="markdownIt-Anchor" href="#统一校验实现"></a> 统一校验实现</h3>
<p>首先在Base工程添加spring-boot-starter-validation的依赖</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>       </span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>      </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-validation<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>   </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>  </span><br></pre></td></tr></table></figure>
<p>在javax.validation.constraints包下有很多这样的校验注解，直接使用注解定义校验规则即可。</p>
<p>之后我们在数据传输类的属性直接添加注解即可，例如：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@NotEmpty(message = "课程名称不能为空")</span></span><br><span class="line"><span class="meta">@ApiModelProperty(value = "课程名称", required = true)</span></span><br><span class="line"><span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line"><span class="meta">@NotEmpty(message = "适用人群不能为空")</span></span><br><span class="line"><span class="meta">@Size(message = "适用人群内容过少", min = 10)</span></span><br><span class="line"><span class="meta">@ApiModelProperty(value = "适用人群", required = true)</span></span><br><span class="line"><span class="keyword">private</span> String users;</span><br></pre></td></tr></table></figure>
<h3 id="分组校验"><a class="markdownIt-Anchor" href="#分组校验"></a> <strong>分组校验</strong></h3>
<p>有时候在同一个属性上设置一个校验规则不能满足要求，比如：订单编号由系统生成，在添加订单时要求订单编号为空，在更新 订单时要求订单编写不能为空。此时就用到了分组校验，同一个属性定义多个校验规则属于不同的分组，比如：添加订单定义@NULL规则属于insert分组，更新订单定义@NotEmpty规则属于update分组，insert和update是分组的名称，是可以修改的。</p>
<p>下边举例说明</p>
<p>我们用class类型来表示不同的分组，所以我们定义不同的接口类型（空接口）表示不同的分组，由于校验分组是公用的，所以定义在 base工程中。如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ValidationGroups</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Inster</span>{};</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Update</span>{};</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Delete</span>{};</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>在校验规则的时候分组</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@NotEmpty(groups = {ValidationGroups.Inster.class},message = "添加课程名称不能为空")</span></span><br><span class="line"><span class="meta">@NotEmpty(groups = {ValidationGroups.Update.class},message = "修改课程名称不能为空")</span></span><br><span class="line"><span class="comment">// @NotEmpty(message = "课程名称不能为空")</span></span><br><span class="line"><span class="meta">@ApiModelProperty(value = "课程名称", required = true)</span></span><br><span class="line"><span class="keyword">private</span> String name;</span><br></pre></td></tr></table></figure>
<h1 id="修改课程"><a class="markdownIt-Anchor" href="#修改课程"></a> 修改课程</h1>
<p>第一步我们需要获取课程信息</p>
<p>我们可以让前端回显分页查询数据</p>
<p>或者利用后端Api查询</p>
<p>这里我们选择后端Api查询</p>
<h1 id="课程计划查询"><a class="markdownIt-Anchor" href="#课程计划查询"></a> 课程计划查询</h1>
<p>常规开发,查询类似课程分类查询</p>
<p>由于层级固定，采用自连接查询</p>
<p>由于返回时数据并非符合要求，所以在select标签内使用resultMap来映射</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">id</span>=<span class="string">"treeNodeResultMap"</span> <span class="attr">type</span>=<span class="string">""</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"selectTreeNodes"</span> <span class="attr">resultMap</span>=<span class="string">"treeNodeResultMap"</span> <span class="attr">parameterType</span>=<span class="string">"java.lang.Long"</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>注意collection中嵌套了association标签，移出去防止爆红</p>
<p>查询语句用到了</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">resultMap</span>&gt;</span> <span class="tag">&lt;<span class="name">association</span>&gt;</span> <span class="tag">&lt;<span class="name">collection</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>详细内容可以查看<a href="https://zhuanlan.zhihu.com/p/572129887">MyBatis之ResultMap的association和collection标签详解 - 知乎 (zhihu.com)</a>学习</p>
<p>查询语句如下</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">id</span>=<span class="string">"treeNodeResultMap"</span> <span class="attr">type</span>=<span class="string">"com.xuecheng.content.model.dto.TeachplanDTO"</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 一级数据映射 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span>     <span class="attr">column</span>=<span class="string">"one_id"</span>        <span class="attr">property</span>=<span class="string">"id"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">"one_pname"</span>      <span class="attr">property</span>=<span class="string">"pname"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">"one_parentid"</span>     <span class="attr">property</span>=<span class="string">"parentid"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">"one_grade"</span>  <span class="attr">property</span>=<span class="string">"grade"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">"one_mediaType"</span>   <span class="attr">property</span>=<span class="string">"mediaType"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">"one_stratTime"</span>   <span class="attr">property</span>=<span class="string">"startTime"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">"one_endTime"</span>   <span class="attr">property</span>=<span class="string">"endTime"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">"one_orderby"</span>   <span class="attr">property</span>=<span class="string">"orderby"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">"one_courseId"</span>   <span class="attr">property</span>=<span class="string">"courseId"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">"one_coursePubId"</span>   <span class="attr">property</span>=<span class="string">"coursePubId"</span> /&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 一级中包含多个二级数据 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">collection</span> <span class="attr">property</span>=<span class="string">"teachPlanTreeNodes"</span> <span class="attr">ofType</span>=<span class="string">"com.xuecheng.content.model.dto.TeachplanDTO"</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 二级数据映射 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>     <span class="attr">column</span>=<span class="string">"two_id"</span>        <span class="attr">property</span>=<span class="string">"id"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">"two_pname"</span>      <span class="attr">property</span>=<span class="string">"pname"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">"two_parentid"</span>     <span class="attr">property</span>=<span class="string">"parentid"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">"two_grade"</span>  <span class="attr">property</span>=<span class="string">"grade"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">"two_mediaType"</span>   <span class="attr">property</span>=<span class="string">"mediaType"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">"two_stratTime"</span>   <span class="attr">property</span>=<span class="string">"startTime"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">"two_endTime"</span>   <span class="attr">property</span>=<span class="string">"endTime"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">"two_orderby"</span>   <span class="attr">property</span>=<span class="string">"orderby"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">"two_courseId"</span>   <span class="attr">property</span>=<span class="string">"courseId"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">"two_coursePubId"</span>   <span class="attr">property</span>=<span class="string">"coursePubId"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">association</span> <span class="attr">property</span>=<span class="string">"teachplanMedia"</span> <span class="attr">javaType</span>=<span class="string">"com.xuecheng.content.model.po.TeachplanMedia"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span> <span class="attr">column</span>=<span class="string">"teachplanMeidaId"</span>   <span class="attr">property</span>=<span class="string">"id"</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">"mediaFilename"</span>   <span class="attr">property</span>=<span class="string">"mediaFilename"</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">"mediaId"</span>   <span class="attr">property</span>=<span class="string">"mediaId"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">association</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">collection</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h1 id="新增修改课程计划"><a class="markdownIt-Anchor" href="#新增修改课程计划"></a> 新增修改课程计划</h1>
<p>我们用一个SaveTeachPlanDTO类即可完成新增和修改相关操作，减少了操作量，提高了代码复用率</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SaveTeachPlanDTO</span> {</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String pname;</span><br><span class="line">    <span class="keyword">private</span> Long parentid;</span><br><span class="line">    <span class="keyword">private</span> Integer grade;</span><br><span class="line">    <span class="keyword">private</span> String mediaType;</span><br><span class="line">    <span class="keyword">private</span> Long courseId;</span><br><span class="line">    <span class="keyword">private</span> Long coursePubId;</span><br><span class="line">    <span class="keyword">private</span> String isPreview;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>当我们需要确定插入数据的orderBy时，我们可以通过统计同类课程的数量并将其+1即可</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> Integer <span class="title function_">getTeachPlanCount</span><span class="params">(Long courseId,Long parentId)</span>{</span><br><span class="line">        LambdaQueryWrapper&lt;Teachplan&gt; lambdaQueryWrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();</span><br><span class="line">        lambdaQueryWrapper.eq(Teachplan::getCourseId,courseId);</span><br><span class="line">        lambdaQueryWrapper.eq(Teachplan::getParentid,parentId);</span><br><span class="line">        <span class="comment">//计算个数</span></span><br><span class="line">        <span class="keyword">return</span> teachplanMapper.selectCount(lambdaQueryWrapper);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>注意当我们添加大章节时前端不显示，我们需要把sql语句中的</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">from teachplan one</span><br><span class="line">     inner join teachplan two on two.parentid = one.id</span><br><span class="line">     left join teachplan_media m1 on m1.teachplan_id = two.id</span><br></pre></td></tr></table></figure>
<p>改为</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">from teachplan one</span><br><span class="line">     left join teachplan two on two.parentid = one.id</span><br><span class="line">     left join teachplan_media m1 on m1.teachplan_id = two.id</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>学习</tag>
        <tag>后端</tag>
        <tag>黑马程序员</tag>
        <tag>学成在线</tag>
      </tags>
  </entry>
  <entry>
    <title>学成在线Day04</title>
    <url>/2024/03/21/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFDay04/</url>
    <content><![CDATA[<h1 id="删除课程计划"><a class="markdownIt-Anchor" href="#删除课程计划"></a> 删除课程计划</h1>
<p>课程计划添加成功，如果课程还没有提交时可以删除课程计划。</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240214185143784.png" alt="image-20240214185143784"></p>
<ul>
<li>删除第一级别的章时要求章下边没有小节方可删除。</li>
<li>删除第二级别的小节的同时需要将其它关联的视频信息也删除。</li>
<li>删除课程计划需要传输课程计划的id。</li>
</ul>
<p>涉及多表删除需要开启事务</p>
<p>可以从IDEA数据库直接复制行的sql语句</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240214193321392.png" alt="image-20240214193321392"></p>
<p>修改圈中部分即可</p>
<h1 id="课程计划排序"><a class="markdownIt-Anchor" href="#课程计划排序"></a> 课程计划排序</h1>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240214200241048.png" alt="image-20240214200241048"></p>
<ul>
<li>上移表示将课程计划向上移动。</li>
<li>下移表示将课程计划向下移动。</li>
<li>向上移动表示和上边的课程计划交换位置，将两个课程计划的排序字段值交换。</li>
<li>向下移动表示和下边的课程计划交换位置，将两个课程计划的排序字段值交换。</li>
</ul>
<p>可以使用SQl语句一次完成</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;!--根据方向和ID修改顺序--&gt;</span><br><span class="line">    &lt;update id="updateOrderByDirectionAndId"&gt;</span><br><span class="line">        update teachplan T1,					# 先设置三个表用来更新和保存状态</span><br><span class="line">            teachplan T2,</span><br><span class="line">            &lt;if test="direction != null and direction == 'movedown'.toString()"&gt;</span><br><span class="line">                (SELECT id,orderby</span><br><span class="line">                 FROM teachplan T3</span><br><span class="line">                 WHERE T3.course_id = #{teachplan.courseId}						</span><br><span class="line">                 AND T3.orderby &gt; #{teachplan.orderby}					# 找到第一个比当前顺序大的行，和他的orderby进行就交换</span><br><span class="line">                 AND T3.parentid = #{teachplan.parentid}</span><br><span class="line">                 ORDER BY T3.orderby</span><br><span class="line">                 limit 1) T4</span><br><span class="line">            &lt;/if&gt;</span><br><span class="line">            &lt;if test="direction != null and direction == 'moveup'.toString()"&gt;</span><br><span class="line">                (SELECT id,orderby</span><br><span class="line">                 FROM teachplan T3</span><br><span class="line">                 WHERE T3.course_id = #{teachplan.courseId}</span><br><span class="line">                 AND T3.orderby &amp;lt; #{teachplan.orderby}				# 找到第一个比当前顺序小的行，和他的orderby进行就交换</span><br><span class="line">                 AND T3.parentid = #{teachplan.parentid}</span><br><span class="line">                 ORDER BY T3.orderby desc								# 注意此时是逆序</span><br><span class="line">                 limit 1) T4</span><br><span class="line">            &lt;/if&gt;</span><br><span class="line">        SET T2.orderby = T1.orderby,</span><br><span class="line">            T1.orderby = T2.orderby</span><br><span class="line">        where T1.parentid = T2.parentid</span><br><span class="line">          AND T1.course_id = T2.course_id</span><br><span class="line">          AND T1.parentid = #{teachplan.parentid}</span><br><span class="line">          AND T1.course_id = #{teachplan.courseId}</span><br><span class="line">          AND T1.orderby = #{teachplan.orderby}</span><br><span class="line">          AND T2.orderby = T4.orderby</span><br><span class="line">          AND T1.id != T4.id;											# 防止其再次更新自己，确保只更新目标的两行</span><br><span class="line">    &lt;/update&gt;</span><br></pre></td></tr></table></figure>
<h1 id="师资管理"><a class="markdownIt-Anchor" href="#师资管理"></a> 师资管理</h1>
<h2 id="课程教师查询"><a class="markdownIt-Anchor" href="#课程教师查询"></a> 课程教师查询</h2>
<p>调用mybatis-plus接口即可</p>
<h2 id="添加教师"><a class="markdownIt-Anchor" href="#添加教师"></a> 添加教师</h2>
<p>由于需要插入后返回数据，我们将Controller的返回类设置为CourseTeacher</p>
<p>当插入完成后，id字段会自动为插入实体类赋值</p>
<p>可以直接返回</p>
<h2 id="删除教师和修改教师"><a class="markdownIt-Anchor" href="#删除教师和修改教师"></a> 删除教师和修改教师</h2>
<p>基础增删查改</p>
<h1 id="课程删除"><a class="markdownIt-Anchor" href="#课程删除"></a> 课程删除</h1>
<p>涉及到的表比较多，需要细心处理</p>
]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>学习</tag>
        <tag>后端</tag>
        <tag>黑马程序员</tag>
        <tag>学成在线</tag>
      </tags>
  </entry>
  <entry>
    <title>学成在线Day05</title>
    <url>/2024/03/21/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFDay05/</url>
    <content><![CDATA[<h1 id="媒资管理开发流程"><a class="markdownIt-Anchor" href="#媒资管理开发流程"></a> 媒资管理开发流程</h1>
<p>见word资料</p>
<h1 id="微服务搭建"><a class="markdownIt-Anchor" href="#微服务搭建"></a> 微服务搭建</h1>
<p>在xuecheng-plus-parent中添加依赖管理</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-alibaba-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>${spring-cloud-alibaba.version}<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>在内容管理模块的接口工程，因为api是启动Http服务，在其中添加如下依赖</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>在bootstrap.yml文件加入如下配置:</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment">#微服务配置</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">content-api</span> <span class="comment">#微服务名称</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="number">192.168</span><span class="number">.101</span><span class="number">.65</span><span class="string">:8848</span></span><br><span class="line">      <span class="attr">discovery:</span> <span class="comment">#服务相关配置</span></span><br><span class="line">        <span class="attr">namespace:</span> <span class="string">dev-Wwh</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">xuecheng-plus-project</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="attr">namespace:</span> <span class="string">dev-Wwh</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">xuecheng-plus-project</span></span><br><span class="line">        <span class="attr">file-extension:</span> <span class="string">yaml</span></span><br><span class="line">        <span class="attr">refresh-enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev</span></span><br></pre></td></tr></table></figure>
<p>在搭建Nacos服务发现中心之前需要搞清楚两个概念：namespace和group</p>
<ul>
<li>
<p>namespace:用于区分环境、比如：开发环境、测试环境、生产环境。</p>
</li>
<li>
<p>group:用于区分项目，比如：xuecheng-plus项目、xuecheng2.0项目</p>
</li>
</ul>
<h3 id="配置三要素"><a class="markdownIt-Anchor" href="#配置三要素"></a> <strong>配置三要素</strong></h3>
<p>搭建完成Nacos服务发现中心，下边搭建Nacos为配置中心，其目的就是通过Nacos去管理项目的所有配置。</p>
<p>先将项目中的配置文件分分类：</p>
<p>1、每个项目特有的配置</p>
<p>是指该配置只在有些项目中需要配置，或者该配置在每个项目中配置的值不同。</p>
<p>比如：spring.application.name每个项目都需要配置但值不一样，以及有些项目需要连接数据库而有些项目不需要，有些项目需要配置消息队列而有些项目不需要。</p>
<p>2、项目所公用的配置</p>
<p>是指在若干项目中配置内容相同的配置。比如：redis的配置，很多项目用的同一套redis服务所以配置也一样。</p>
<p>另外还需要知道nacos如何去定位一个具体的配置文件，即：namespace、group、dataid.</p>
<p>1、通过namespace、group找到具体的环境和具体的项目。</p>
<p>2、通过dataid找到具体的配置文件，dataid有三部分组成</p>
<p><em><strong>比如：content-service-dev.yaml配置文件 由（content-service）-（dev）. (yaml)三部分组成</strong></em></p>
<p><em><strong>content-service：第一部分，它是在application.yaml中配置的应用名，即spring.application.name的值。</strong></em></p>
<p><em><strong>dev：第二部分，它是环境名，通过spring.profiles.active指定，</strong></em></p>
<p><em><strong>Yaml: 第三部分，它是配置文件 的后缀，目前nacos支持properties、yaml等格式类型，本项目选择yaml格式类型。</strong></em></p>
<h3 id="配置content-service"><a class="markdownIt-Anchor" href="#配置content-service"></a> 配置content-service</h3>
<p>在content-service工程的test/resources 中添加bootstrap.yaml，内容如下：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">content-service</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="number">192.168</span><span class="number">.101</span><span class="number">.65</span><span class="string">:8848</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">xuecheng-plus-project</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">xuecheng-plus-project</span></span><br><span class="line">        <span class="attr">file-extension:</span> <span class="string">yaml</span></span><br><span class="line">        <span class="attr">refresh-enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="comment">#profiles默认为dev</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev</span></span><br></pre></td></tr></table></figure>
<p>通过运行观察控制台打印出下边的信息，NacosRestTemplate.java通过Post方式与nacos服务端交互读取配置信息。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">[NacosRestTemplate.java:<span class="number">476</span>] - HTTP method: POST, url: http:<span class="comment">//192.168.101.65:8848/nacos/v1/cs/configs/listener, body: {Listening-Configs=content-service.yaml?xuecheng-plus-project??dev?content-service-dev.yaml?xuecheng-plus-project?88459b1483b8381eccc2ef462bd59182?dev?content-service?xuecheng-plus-project??dev?, tenant=dev}</span></span><br></pre></td></tr></table></figure>
<h3 id="配置content-api"><a class="markdownIt-Anchor" href="#配置content-api"></a> 配置content-api</h3>
<p>内容如下：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment">#微服务配置</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">content-api</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="number">192.168</span><span class="number">.101</span><span class="number">.65</span><span class="string">:8848</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">xuecheng-plus-project</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">xuecheng-plus-project</span></span><br><span class="line">        <span class="attr">file-extension:</span> <span class="string">yaml</span></span><br><span class="line">        <span class="attr">refresh-enabled:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">extension-configs:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">data-id:</span> <span class="string">content-service-${spring.profiles.active}.yaml</span></span><br><span class="line">            <span class="attr">group:</span> <span class="string">xuecheng-plus-project</span></span><br><span class="line">            <span class="attr">refresh:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev</span></span><br></pre></td></tr></table></figure>
<p>通过这一部分，能让其引用service层的数据库连接配置：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">extension-configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">data-id:</span> <span class="string">content-service-${spring.profiles.active}.yaml</span></span><br><span class="line">    <span class="attr">group:</span> <span class="string">xuecheng-plus-project</span></span><br><span class="line">    <span class="attr">refresh:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<p>将swagger配置和logging配置抽取到项目公共组，来让所有项目通用配置这部分内容</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">shared-configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">data-id:</span> <span class="string">swagger-${spring.profiles.active}.yaml</span>       <span class="comment">#swagger文件配置</span></span><br><span class="line">    <span class="attr">group:</span> <span class="string">xuecheng-plus-common</span></span><br><span class="line">    <span class="attr">refresh:</span> <span class="literal">true</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">data-id:</span> <span class="string">logging-${spring.profiles.active}.yaml</span>       <span class="comment">#日志文件配置</span></span><br><span class="line">    <span class="attr">group:</span> <span class="string">xuecheng-plus-common</span></span><br><span class="line">    <span class="attr">refresh:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<p>nacos中并未对<code>extension-configs</code>和<code>shared-configs</code>的差别</p>
<p>但是我们在使用时，若使用公共配置文件，则需要配置<code>shared-configs</code></p>
<p>若使用私有配置，则需要配置<code>extension-configs</code></p>
<h3 id="配置优先级"><a class="markdownIt-Anchor" href="#配置优先级"></a> 配置优先级</h3>
<p>到目前为止已将所有微服务的配置统一在nacos进行配置，用到的配置文件有本地的配置文件 bootstrap.yaml和nacos上的配置文件，SpringBoot读取配置文件 的顺序如下：</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240216202431287.png" alt="image-20240216202431287"></p>
<p>引入配置文件的形式有：</p>
<p>1、以项目应用名方式引入</p>
<p>2、以扩展配置文件方式引入</p>
<p>3、以共享配置文件 方式引入</p>
<p>4、本地配置文件</p>
<p>各配置文件 的优先级：项目应用名配置文件 &gt; 扩展配置文件 &gt; 共享配置文件 &gt; 本地配置文件。</p>
<p>想让本地最优先，可以在nacos配置文件 中配置如下即可实现：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"> <span class="attr">cloud:</span></span><br><span class="line">  <span class="attr">config:</span></span><br><span class="line">    <span class="attr">override-none:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<h1 id="分布式文件系统"><a class="markdownIt-Anchor" href="#分布式文件系统"></a> 分布式文件系统</h1>
<p>简介请查看word中分布式文件系统这一章:[分布式简介](E:\学习资料\学成在线项目—资料\day05 媒资管理 Nacos Gateway MinIO\资料\第3章媒资管理模块v3.1.docx)</p>
<p>我们使用Minio分布式文件存储系统</p>
<h3 id="sdk"><a class="markdownIt-Anchor" href="#sdk"></a> SDK</h3>
<p>操作教程地址：<a href="https://docs.min.io/docs/java-client-quickstart-guide.html">https://docs.min.io/docs/java-client-quickstart-guide.html</a></p>
<p>最低需求Java 1.8或更高版本</p>
<p>Maven依赖:</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.minio<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>minio<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>8.4.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.squareup.okhttp3<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>okhttp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.8.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h1 id="上传图片"><a class="markdownIt-Anchor" href="#上传图片"></a> 上传图片</h1>
<p>首先分析接口：</p>
<p>请求地址：/media/upload/coursefile</p>
<p>请求内容：<strong>Content-Type:</strong> multipart/form-data;</p>
<p>form-data; name="filedata"; filename="具体的文件名称"</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@ApiOperation("上传图片")</span></span><br><span class="line"><span class="meta">@PostMapping(value = "/upload/coursefile",consumes = MediaType.MULTIPART_FORM_DATA_VALUE)</span></span><br><span class="line"><span class="keyword">public</span> UploadFileResultDTO <span class="title function_">upload</span><span class="params">(<span class="meta">@RequestPart("file")</span> MultipartFile file)</span> {</span><br><span class="line">    <span class="comment">//调用service上传文件</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p><code>consumes</code> 请求提交内容类型，<code>MediaType</code>方式，如 <code>application/json</code>、<code>application/x-www-urlencode</code>、<code>multipart/form-data</code>等</p>
<p><code>@RequestPart</code>用于将<code>multipart/form-data</code>类型数据映射到控制器处理方法的参数中。除了<code>@RequestPart</code>注解外，<code>@RequestParam</code>同样可以用于此类操作。</p>
<p>上传到Minio需要进行的操作</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//1.文件上传到Minio</span></span><br><span class="line"><span class="type">String</span> <span class="variable">fileName</span> <span class="operator">=</span> uploadFileParamsDto.getFilename();</span><br><span class="line"><span class="comment">//获取文件拓展名</span></span><br><span class="line"><span class="type">String</span> <span class="variable">extension</span> <span class="operator">=</span> StringUtils.substringAfterLast(fileName, <span class="string">"."</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//根据拓展名获取媒体类型</span></span><br><span class="line"><span class="type">String</span> <span class="variable">mimeType</span> <span class="operator">=</span> getMimeType(extension);</span><br><span class="line"></span><br><span class="line"><span class="type">String</span> <span class="variable">defaultFolderPath</span> <span class="operator">=</span> getDefaultFolderPath();</span><br><span class="line"></span><br><span class="line"><span class="comment">//获取MD5值</span></span><br><span class="line"><span class="type">String</span> <span class="variable">fileMd5</span> <span class="operator">=</span> getFileMd5(<span class="keyword">new</span> <span class="title class_">File</span>(localFilePath));</span><br><span class="line"></span><br><span class="line"><span class="comment">//objectName以年月日作为名称存储</span></span><br><span class="line"><span class="type">String</span> <span class="variable">objectName</span> <span class="operator">=</span> defaultFolderPath + fileMd5 + extension;</span><br><span class="line"></span><br><span class="line"><span class="type">boolean</span> <span class="variable">result</span> <span class="operator">=</span> addMediaFilesToMinIO(localFilePath, mimeType, bucket_mediaFiles, objectName);</span><br><span class="line"><span class="keyword">if</span>(!result){</span><br><span class="line">    XueChengPlusException.cast(<span class="string">"文件上传失败"</span>);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>在Controller层，接收到文件后要创建暂时文件</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//创建临时文件</span></span><br><span class="line"><span class="type">File</span> <span class="variable">tempFile</span> <span class="operator">=</span> File.createTempFile(<span class="string">"minio"</span>, <span class="string">"temp"</span>);</span><br><span class="line">file.transferTo(tempFile);</span><br></pre></td></tr></table></figure>
<p><code>File.createTempFile</code> 是 Java 中的一个方法，用于创建一个临时文件。这个方法是 <code>java.io.File</code> 类的一部分。</p>
<p><code>transferTo</code> 是 Java 中的一个方法，用于将文件的内容转移到另一个文件中。这个方法是 <code>java.nio.file.Files</code> 类的一部分，它使用了 Java 的 NIO（Non-blocking I/O）特性，可以更高效地处理文件操作。</p>
<p>这个方法会在默认的临时文件目录中创建一个新的空文件，文件名是由给定的前缀和后缀生成的。这个临时文件的路径可以通过 <code>tempFile.getPath()</code> 获取。</p>
<p>注意：创建的临时文件在 JVM 退出时不会自动删除，需要手动删除。如果你希望临时文件在 JVM 退出时自动删除，可以调用 <code>tempFile.deleteOnExit()</code> 方法。</p>
<h1 id="service事务优化"><a class="markdownIt-Anchor" href="#service事务优化"></a> Service事务优化</h1>
<p>上边的service方法优化后并测试通过，现在思考关于uploadFile方法的是否应该开启事务。</p>
<p>目前是在uploadFile方法上添加@Transactional，当调用uploadFile方法前会开启数据库事务，如果上传文件过程时间较长那么数据库的事务持续时间就会变长，这样数据库链接释放就慢，最终导致数据库链接不够用。</p>
<p>我们只将addMediaFilesToDb方法添加事务控制即可,uploadFile方法上的@Transactional注解去掉。</p>
<p>我们人为在int insert = mediaFilesMapper.insert(mediaFiles);下边添加一个异常代码int a=1/0;</p>
<p>测试是否事务控制。很遗憾，事务控制失败。</p>
<p>方法上已经添加了@Transactional注解为什么该方法不能被事务控制呢？</p>
<p>如果是在uploadFile方法上添加@Transactional注解就可以控制事务，去掉则不行。</p>
<p><strong>现在的问题其实是一个非事务方法调同类一个事务方法，事务无法控制，这是为什么？</strong></p>
<p>下边分析原因：</p>
<p>如果在uploadFile方法上添加@Transactional注解，代理对象执行此方法前会开启事务，如下图：</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240217202502483.png" alt="image-20240217202502483"></p>
<p>如果在uploadFile方法上没有@Transactional注解，代理对象执行此方法前不进行事务控制，如下图：</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240217202523999.png" alt="image-20240217202523999"></p>
<p>所以判断该方法是否可以事务控制必须保证是通过代理对象调用此方法，且此方法上添加了@Transactional注解。</p>
<p>现在在addMediaFilesToDb方法上添加@Transactional注解，也不会进行事务控制是因为并不是通过代理对象执行的addMediaFilesToDb方法。为了判断在uploadFile方法中去调用addMediaFilesToDb方法是否是通过代理对象去调用，我们可以打断点跟踪。</p>
<p>我们发现在uploadFile方法中去调用addMediaFilesToDb方法不是通过代理对象去调用，<strong>而是直接调用本类的方法</strong>。</p>
<p>简而言之：只有通过调用代理类来执行事务操作才可以控制事务</p>
<p>那么解决方案就明了了，首先我们将这个方法在接口中创建，然后我们将service类代理对象注入其中，并利用代理对象调用数据库函数即可</p>
]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>学习</tag>
        <tag>后端</tag>
        <tag>黑马程序员</tag>
        <tag>学成在线</tag>
      </tags>
  </entry>
  <entry>
    <title>学成在线Day06</title>
    <url>/2024/03/21/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFDay06/</url>
    <content><![CDATA[<h1 id="上传视频"><a class="markdownIt-Anchor" href="#上传视频"></a> 上传视频</h1>
<h2 id="断点续传技术"><a class="markdownIt-Anchor" href="#断点续传技术"></a> 断点续传技术</h2>
<h3 id="1什么是断点续传"><a class="markdownIt-Anchor" href="#1什么是断点续传"></a> 1.什么是断点续传</h3>
<p>通常视频文件都比较大，所以对于媒资系统上传文件的需求要满足大文件的上传要求。http协议本身对上传文件大小没有限制，但是客户的网络环境质量、电脑硬件环境等参差不齐，如果一个大文件快上传完了网断了没有上传完成，需要客户重新上传，用户体验非常差，所以对于大文件上传的要求最基本的是断点续传。</p>
<p>什么是断点续传：</p>
<p>​    引用百度百科：断点续传指的是在下载或上传时，将下载或上传任务（一个文件或一个压缩包）人为的划分为几个部分，每一个部分采用一个线程进行上传或下载，如果碰到网络故障，可以从已经上传或下载的部分开始继续上传下载未完成的部分，而没有必要从头开始上传下载，断点续传可以提高节省操作时间，提高用户体验性。</p>
<p>断点续传流程如下图：</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240217205319182.png" alt="image-20240217205319182"></p>
<p>流程如下：</p>
<p>1、前端上传前先把文件分成块</p>
<p>2、一块一块的上传，上传中断后重新上传，已上传的分块则不用再上传</p>
<p>3、各分块上传完成最后在服务端合并文件</p>
<h3 id="2文件分块测试"><a class="markdownIt-Anchor" href="#2文件分块测试"></a> 2.文件分块测试</h3>
<p>文件分块测试代码：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//分块测试</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testChunk</span><span class="params">()</span> <span class="keyword">throws</span> IOException {</span><br><span class="line">    <span class="type">File</span> <span class="variable">sourceFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">"C:\\Users\\Administrator\\Desktop\\分块测试\\test.mp4"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">fileChunkPath</span> <span class="operator">=</span> <span class="string">"C:\\Users\\Administrator\\Desktop\\分块测试"</span>;</span><br><span class="line">    <span class="comment">//分块大小</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">chunkSize</span> <span class="operator">=</span> <span class="number">1024</span> * <span class="number">1024</span> * <span class="number">1</span>;</span><br><span class="line">    <span class="comment">//分块数量</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">chunkNum</span> <span class="operator">=</span> (<span class="type">int</span>) Math.ceil(sourceFile.length() * <span class="number">1.0</span> / chunkSize);</span><br><span class="line">    <span class="type">RandomAccessFile</span> <span class="variable">ref_r</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RandomAccessFile</span>(sourceFile, <span class="string">"r"</span>);</span><br><span class="line">    <span class="comment">//缓冲区</span></span><br><span class="line">    <span class="type">byte</span>[] b = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>];</span><br><span class="line">    <span class="keyword">for</span> ( <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; chunkNum; i++ ) {</span><br><span class="line">        <span class="comment">//创建分块文件</span></span><br><span class="line">        <span class="type">File</span> <span class="variable">chunkFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(fileChunkPath + i);</span><br><span class="line">        <span class="comment">//分块文件写入流</span></span><br><span class="line">        <span class="type">RandomAccessFile</span> <span class="variable">ref_w</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RandomAccessFile</span>(chunkFile, <span class="string">"rw"</span>);</span><br><span class="line">        <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">        <span class="comment">//读取文件</span></span><br><span class="line">        <span class="keyword">while</span> ( (len = ref_r.read(b)) != -<span class="number">1</span> ) {</span><br><span class="line">            ref_w.write(b, <span class="number">0</span>, len);</span><br><span class="line">            <span class="keyword">if</span> ( chunkFile.length() &gt;= chunkSize ) {</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>其中用到了<code>RandomAccessFile</code></p>
<p>RandomAccessFile从字面意思翻译：随机通行文件</p>
<p>下面开始介绍一下RandomAccessFile，该类是直接继承Object的类，既可以读取文件内容，也可以向文件输出数据。</p>
<p>RandomAccessFile支持“随机访问”的方式，程序快可以直接跳转到文件的<strong>任意地方</strong>来读写数据。</p>
<p>RandomAccessFile的一个重要使用场景就是网络请求中的多线程下载及断点续传。</p>
<p>文件分块合并测试代码：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testMerge</span><span class="params">()</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">    <span class="comment">//找到分块文件路径</span></span><br><span class="line">    <span class="type">File</span> <span class="variable">chunkFolder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">"C:\\Users\\Wwhds\\Desktop\\分块测试\\chunk"</span>);</span><br><span class="line">    <span class="comment">//源文件</span></span><br><span class="line">    <span class="type">File</span> <span class="variable">sourceFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">"C:\\Users\\Wwhds\\Desktop\\分块测试\\test.mp4"</span>);</span><br><span class="line">    <span class="comment">//合并文件</span></span><br><span class="line">    <span class="type">File</span> <span class="variable">mergeFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">"C:\\Users\\Wwhds\\Desktop\\分块测试\\test_merge.mp4"</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//取出所有分块文件</span></span><br><span class="line">    File[] chunkFiles = chunkFolder.listFiles();</span><br><span class="line"></span><br><span class="line">    List&lt;File&gt; list = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> ( chunkFiles != <span class="literal">null</span> ) {</span><br><span class="line">        list = Arrays.asList(chunkFiles);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//根据文件名称排序list</span></span><br><span class="line">    <span class="keyword">if</span> ( list != <span class="literal">null</span> ) {</span><br><span class="line">        list.sort(Comparator.comparingInt(o -&gt; Integer.parseInt(o.getName())));</span><br><span class="line">    }</span><br><span class="line">    <span class="type">RandomAccessFile</span> <span class="variable">raf_rw</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RandomAccessFile</span>(mergeFile, <span class="string">"rw"</span>);</span><br><span class="line">    <span class="type">byte</span> b[] = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>];</span><br><span class="line">    <span class="keyword">for</span> ( File file : list ) {</span><br><span class="line">        <span class="type">RandomAccessFile</span> <span class="variable">raf_r</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RandomAccessFile</span>(file, <span class="string">"r"</span>);</span><br><span class="line">        <span class="type">int</span> len;</span><br><span class="line">        <span class="keyword">while</span> ( (len = raf_r.read(b)) != -<span class="number">1</span> ) {</span><br><span class="line">            raf_rw.write(b, <span class="number">0</span>, len);</span><br><span class="line">        }</span><br><span class="line">        raf_r.close();</span><br><span class="line">    }</span><br><span class="line">    raf_rw.close();</span><br><span class="line">    System.out.println(<span class="string">"合并完成"</span>);				<span class="comment">//MD5验证</span></span><br><span class="line">    <span class="keyword">if</span> ( DigestUtils.md5Hex(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(sourceFile)).equals(DigestUtils.md5Hex(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(mergeFile))) ) {</span><br><span class="line">        System.out.println(<span class="string">"文件一致"</span>);</span><br><span class="line">    }<span class="keyword">else</span> {</span><br><span class="line">        System.out.println(<span class="string">"文件不一致"</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h3 id="3视频上传流程"><a class="markdownIt-Anchor" href="#3视频上传流程"></a> 3.视频上传流程</h3>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240218151425388.png" alt="image-20240218151425388"></p>
<p>1、前端对文件进行分块。</p>
<p>2、前端上传分块文件前请求媒资服务检查文件是否存在，如果已经存在则不再上传。</p>
<p>3、如果分块文件不存在则前端开始上传</p>
<p>4、前端请求媒资服务上传分块。</p>
<p>5、媒资服务将分块上传至MinIO。</p>
<p>6、前端将分块上传完毕请求媒资服务合并分块。</p>
<p>7、媒资服务判断分块上传完成则请求MinIO合并文件。</p>
<p>8、合并完成校验合并后的文件是否完整，如果完整则上传完成，否则删除文件。</p>
<h3 id="4minio文件上传测试"><a class="markdownIt-Anchor" href="#4minio文件上传测试"></a> 4.Minio文件上传测试</h3>
<p>注意分块内容必须大于等于5M</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">List&lt;ComposeSource&gt; sources = Stream.iterate(<span class="number">0</span>, i -&gt; ++i)</span><br><span class="line">    .limit(<span class="number">42</span>)</span><br><span class="line">    .map(i -&gt; ComposeSource.builder()</span><br><span class="line">         .bucket(<span class="string">"testbucket"</span>)</span><br><span class="line">         .object(<span class="string">"chunk/"</span> + i)</span><br><span class="line">         .build())</span><br><span class="line">    .collect(Collectors.toList());</span><br></pre></td></tr></table></figure>
<p>stream流全新用法</p>
<h1 id="上传分块"><a class="markdownIt-Anchor" href="#上传分块"></a> 上传分块</h1>
<p>上传文件大小限制需要解除</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">servlet:</span></span><br><span class="line">    <span class="attr">multipart:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">max-file-size:</span> <span class="string">50MB</span>			<span class="string">//上传文件最大限制</span></span><br><span class="line">      <span class="attr">max-request-size:</span> <span class="string">50MB</span>		<span class="string">//请求文件最大限制</span></span><br></pre></td></tr></table></figure>
<p>在nacos配置即可</p>
<p>内容过于庞大，请在代码文件中查看</p>
<h1 id="视频处理"><a class="markdownIt-Anchor" href="#视频处理"></a> 视频处理</h1>
<p>视频上传成功后需要对视频进行转码处理。</p>
<p>什么是视频编码？查阅百度百科如下：</p>
<p>详情参考 ：<a href="https://baike.baidu.com/item/%E8%A7%86%E9%A2%91%E7%BC%96%E7%A0%81/839038">https://baike.baidu.com/item/%E8%A7%86%E9%A2%91%E7%BC%96%E7%A0%81/839038</a></p>
<p>首先我们要分清文件格式和编码格式：</p>
<p>文件格式：是指.mp4、.avi、.rmvb等 这些不同扩展名的视频文件的文件格式 ，视频文件的内容主要包括视频和音频，其文件格式是按照一 定的编码格式去编码，并且按照该文件所规定的封装格式将视频、音频、字幕等信息封装在一起，播放器会根据它们的封装格式去提取出编码，然后由播放器解码，最终播放音视频。</p>
<p>音视频编码格式：通过音视频的压缩技术，将视频格式转换成另一种视频格式，通过视频编码实现流媒体的传输。比如：一个.avi的视频文件原来的编码是a，通过编码后编码格式变为b，音频原来为c，通过编码后变为d。</p>
<p>音视频编码格式各类繁多，主要有几下几类：</p>
<p>MPEG系列</p>
<p>（由ISO[国际标准组织机构]下属的MPEG[运动图象专家组]开发 ）视频编码方面主要是Mpeg1（vcd用的就是它）、Mpeg2（DVD使用）、Mpeg4（的DVDRIP使用的都是它的变种，如：divx，xvid等）、Mpeg4 AVC（正热门）；音频编码方面主要是MPEG Audio Layer 1/2、MPEG Audio Layer 3（大名鼎鼎的mp3）、MPEG-2 AAC 、MPEG-4 AAC等等。注意：DVD音频没有采用Mpeg的。</p>
<p>H.26X系列</p>
<p>（由ITU[国际电传视讯联盟]主导，侧重网络传输，注意：只是视频编码）</p>
<p>包括H.261、H.262、H.263、H.263+、H.263++、H.264（就是MPEG4 AVC-合作的结晶）</p>
<p>目前最常用的编码标准是视频H.264，音频AAC。</p>
<h1 id="分布式调度"><a class="markdownIt-Anchor" href="#分布式调度"></a> 分布式调度</h1>
<p>对一个视频的转码可以理解为一个任务的执行，如果视频的数量比较多，如何去高效处理一批任务呢？</p>
<p>1、多线程</p>
<p>多线程是充分利用单机的资源。</p>
<p>2、分布式加多线程</p>
<p>充分利用多台计算机，每台计算机使用多线程处理。</p>
<p>方案2可扩展性更强。</p>
<p>方案2是一种分布式任务调度的处理方案。</p>
<p>什么是分布式任务调度？</p>
<p>我们可以先思考一下下面业务场景的解决方案：</p>
<p>​    每隔24小时执行数据备份任务。</p>
<p>​    12306网站会根据车次不同，设置几个时间点分批次放票。</p>
<p>​    某财务系统需要在每天上午10点前结算前一天的账单数据，统计汇总。</p>
<p>​    商品成功发货后，需要向客户发送短信提醒。</p>
<p><strong>什么是分布式任务调度？</strong></p>
<p>​    通常任务调度的程序是集成在应用中的，比如：优惠卷服务中包括了定时发放优惠卷的的调度程序，结算服务中包括了定期生成报表的任务调度程序，由于采用分布式架构，一个服务往往会部署多个冗余实例来运行我们的业务，在这种分布式系统环境下运行任务调度，我们称之为<strong>分布式任务调度</strong>，如下图：</p>
<img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240318125528197.png" alt="image-20240318125528197" style="zoom:50%;">
<p><strong>分布式调度要实现的目标：</strong></p>
<p>​    不管是任务调度程序集成在应用程序中，还是单独构建的任务调度系统，如果采用分布式调度任务的方式就相当于将任务调度程序分布式构建，这样就可以具有分布式系统的特点，并且提高任务的调度处理能力：</p>
<ol>
<li>并行任务调度</li>
</ol>
<p>​    并行任务调度实现靠多线程，如果有大量任务需要调度，此时光靠多线程就会有瓶颈了，因为一台计算机CPU的处理能力是有限的。</p>
<p>​    如果将任务调度程序分布式部署，每个结点还可以部署为集群，这样就可以让多台计算机共同去完成任务调度，我们可以将任务分割为若干个分片，由不同的实例并行执行，来提高任务调度的处理效率。</p>
<ol start="2">
<li>高可用</li>
</ol>
<p>​    若某一个实例宕机，不影响其他实例来执行任务。</p>
<ol start="3">
<li>弹性扩容</li>
</ol>
<p>​    当集群中增加实例就可以提高并执行任务的处理效率。</p>
<ol start="4">
<li>任务管理与监测</li>
</ol>
<p>​    对系统中存在的所有定时任务进行统一的管理及监测。让开发人员及运维人员能够时刻了解任务执行情况，从而做出快速的应急处理响应。</p>
<ol start="5">
<li>避免任务重复执行</li>
</ol>
<p>​    当任务调度以集群方式部署，同一个任务调度可能会执行多次，比如在上面提到的电商系统中到点发优惠券的例子，就会发放多次优惠券，对公司造成很多损失，所以我们需要控制相同的任务在多个运行实例上只执行一次。</p>
<p>我们使用xxl来执行任务调度</p>
<p>XXL-JOB是一个轻量级分布式任务调度平台，其核心设计目标是开发迅速、学习简单、轻量级、易扩展。现已开放源代码并接入多家公司线上产品线，开箱即用。</p>
<p>官网：<a href="https://www.xuxueli.com/xxl-job/">https://www.xuxueli.com/xxl-job/</a></p>
<p>文档：<a href="https://www.xuxueli.com/xxl-job/#%E3%80%8A%E5%88%86%E5%B8%83%E5%BC%8F%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6%E5%B9%B3%E5%8F%B0XXL-JOB%E3%80%8B">https://www.xuxueli.com/xxl-job/#《分布式任务调度平台XXL-JOB》</a></p>
<p>maven依赖：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.xuxueli<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>xxl-job-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>配置文件:</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">xxl:</span></span><br><span class="line">  <span class="attr">job:</span></span><br><span class="line">    <span class="attr">admin:</span> </span><br><span class="line">      <span class="attr">addresses:</span> <span class="string">http://192.168.101.65:8088/xxl-job-admin</span></span><br><span class="line">    <span class="attr">executor:</span></span><br><span class="line">      <span class="attr">appname:</span> <span class="string">media-process-service</span></span><br><span class="line">      <span class="attr">address:</span> </span><br><span class="line">      <span class="attr">ip:</span> </span><br><span class="line">      <span class="attr">port:</span> <span class="number">9999</span></span><br><span class="line">      <span class="attr">logpath:</span> <span class="string">/data/applogs/xxl-job/jobhandler</span></span><br><span class="line">      <span class="attr">logretentiondays:</span> <span class="number">30</span></span><br><span class="line">    <span class="attr">accessToken:</span> <span class="string">default_token</span></span><br></pre></td></tr></table></figure>
<p>添加调度</p>
<p>在新增处新增测试任务，注意bean名称要与注册内容相同，可以用cron表达式调度</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240218203347215.png" alt="image-20240218203347215"></p>
<p>点击新增，填写任务信息</p>
<img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240318130501625.png" alt="image-20240318130501625" style="zoom:50%;">
<p>高级配置的其它配置项稍后在分片广播章节详细解释。</p>
<p>添加成功，启动任务</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240318130551255.png" alt="image-20240318130551255"></p>
<p>通过日志查看任务运行情况</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240318130608832.png" alt="image-20240318130608832"></p>
<p>下边启动媒资管理的service工程，启动执行器。</p>
<p>观察执行器方法的执行。</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240318130655394.png" alt="image-20240318130655394"></p>
<p>如果要停止任务需要在调度中心操作</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240318130708805.png" alt="image-20240318130708805"></p>
<p>任务跑一段时间注意清理日志</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240318130722290.png" alt="image-20240318130722290"></p>
<p>xxl路由策略配置详细内容：<a href="https://blog.csdn.net/w_t_y_y/article/details/117119864">xxl-job（四）路由策略_xxl-job路由策略-CSDN博客</a></p>
<h2 id="分片广播"><a class="markdownIt-Anchor" href="#分片广播"></a> 分片广播</h2>
<p>掌握了xxl-job的基本使用，下边思考如何进行分布式任务处理呢？如下图，我们会启动多个执行器组成一个集群，去执行任务。</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240318130800270.png" alt="image-20240318130800270"></p>
<p>执行器在集群部署下调度中心有哪些调度策略呢？</p>
<p>查看xxl-job官方文档，阅读高级配置相关的内容：</p>
<p>高级配置：<br>
- 路由策略：当执行器集群部署时，提供丰富的路由策略，包括；<br>
FIRST（第一个）：固定选择第一个机器；<br>
LAST（最后一个）：固定选择最后一个机器；<br>
ROUND（轮询）：；<br>
RANDOM（随机）：随机选择在线的机器；<br>
CONSISTENT_HASH（一致性HASH）：每个任务按照Hash算法固定选择某一台机器，且所有任务均匀散列在不同机器上。<br>
LEAST_FREQUENTLY_USED（最不经常使用）：使用频率最低的机器优先被选举；<br>
LEAST_RECENTLY_USED（最近最久未使用）：最久未使用的机器优先被选举；<br>
FAILOVER（故障转移）：按照顺序依次进行心跳检测，第一个心跳检测成功的机器选定为目标执行器并发起调度；<br>
BUSYOVER（忙碌转移）：按照顺序依次进行空闲检测，第一个空闲检测成功的机器选定为目标执行器并发起调度；<br>
SHARDING_BROADCAST(分片广播)：广播触发对应集群中所有机器执行一次任务，同时系统自动传递分片参数；可根据分片参数开发分片任务；</p>
<p>- 子任务：每个任务都拥有一个唯一的任务ID(任务ID可以从任务列表获取)，当本任务执行结束并且执行成功时，将会触发子任务ID所对应的任务的一次主动调度，通过子任务可以实现一个任务执行完成去执行另一个任务。<br>
- 调度过期策略：<br>
忽略：调度过期后，忽略过期的任务，从当前时间开始重新计算下次触发时间；<br>
立即执行一次：调度过期后，立即执行一次，并从当前时间开始重新计算下次触发时间；<br>
- 阻塞处理策略：调度过于密集执行器来不及处理时的处理策略；<br>
单机串行（默认）：调度请求进入单机执行器后，调度请求进入FIFO队列并以串行方式运行；<br>
丢弃后续调度：调度请求进入单机执行器后，发现执行器存在运行的调度任务，本次请求将会被丢弃并标记为失败；<br>
覆盖之前调度：调度请求进入单机执行器后，发现执行器存在运行的调度任务，将会终止运行中的调度任务并清空队列，然后运行本地调度任务；<br>
- 任务超时时间：支持自定义任务超时时间，任务运行超时将会主动中断任务；<br>
- 失败重试次数；支持自定义任务失败重试次数，当任务失败时将会按照预设的失败重试次数主动进行重试；</p>
<p>下边要重点说的是分片广播策略，分片是指是调度中心以执行器为维度进行分片，将集群中的执行器标上序号：0，1，2，3...，广播是指每次调度会向集群中的所有执行器发送任务调度，请求中携带分片参数。</p>
<p>如下图：</p>
<img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240318131022846.png" alt="image-20240318131022846" style="zoom:50%;">
<p>每个执行器收到调度请求同时接收分片参数。</p>
<p>xxl-job支持动态扩容执行器集群从而动态增加分片数量，当有任务量增加可以部署更多的执行器到集群中，调度中心会动态修改分片的数量。</p>
<p><strong>作业分片适用哪些场景呢？</strong></p>
<ul>
<li>
<p>分片任务场景：10个执行器的集群来处理10w条数据，每台机器只需要处理1w条数据，耗时降低10倍；</p>
</li>
<li>
<p>广播任务场景：广播执行器同时运行shell脚本、广播集群节点进行缓存更新等。</p>
</li>
</ul>
<p>所以，广播分片方式不仅可以充分发挥每个执行器的能力，并且根据分片参数可以控制任务是否执行，最终灵活控制了执行器集群分布式处理任务。</p>
<p><strong>使用说明：</strong></p>
<p><strong>分片广播</strong> 和普通任务开发流程一致，不同之处在于可以获取分片参数进行分片业务处理。</p>
<p>Java语言任务获取分片参数方式：</p>
<p>BEAN、GLUE模式(Java)，可参考Sample示例执行器中的示例任务</p>
<p>下边测试作业分片：</p>
<ol>
<li>定义作业分片的任务方法</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 2、分片广播任务</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="meta">@XxlJob("shardingJobHandler")</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">shardingJobHandler</span><span class="params">()</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">    <span class="comment">// 分片参数</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">shardIndex</span> <span class="operator">=</span> XxlJobHelper.getShardIndex();</span><br><span class="line">    <span class="type">int</span> <span class="variable">shardTotal</span> <span class="operator">=</span> XxlJobHelper.getShardTotal();</span><br><span class="line">    log.info(<span class="string">"分片参数：当前分片序号 = {}, 总分片数 = {}"</span>, shardIndex, shardTotal);</span><br><span class="line">    log.info(<span class="string">"开始执行第"</span>+shardIndex+<span class="string">"批任务"</span>);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>在调度中心添加任务</li>
</ol>
<img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240318131421838.png" alt="image-20240318131421838" style="zoom:50%;">
<p>添加成功:</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240318131506343.png" alt="image-20240318131506343"></p>
<p>启动任务，观察日志</p>
<p>下边启动两个执行器实例，观察每个实例的执行情况</p>
<p>首先在nacos中配置media-service的本地优先配置：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"> <span class="attr">cloud:</span></span><br><span class="line">  <span class="attr">config:</span></span><br><span class="line">    <span class="attr">override-none:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<p>将media-service启动两个实例</p>
<p>两个实例的在启动时注意端口不能冲突：</p>
<p>实例1 在VM options处添加：-Dserver.port=63051 -Dxxl.job.executor.port=9998</p>
<p>实例2 在VM options处添加：-Dserver.port=63050 -Dxxl.job.executor.port=9999</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240318131735660.png" alt="image-20240318131735660"></p>
<p>启动两个实例</p>
<p>观察任务调度中心，稍等片刻执行器有两个</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240318131753744.png" alt="image-20240318131753744"></p>
<p>两示例日志如下:</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240318131828536.png" alt="image-20240318131828536"></p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240318131840898.png" alt="image-20240318131840898"></p>
<p>从日志可以看每个实例的分片序号不同。</p>
<p>如果其中一个执行器挂掉，只剩下一个执行器在工作，稍等片刻调用中心发现少了一个执行器将动态调整总分片数为1。</p>
<p>到此作业分片任务调试完成，此时我们可以思考：</p>
<blockquote>
<p>当一次分片广播到来，各执行器如何根据分片参数去分布式执行任务，保证执行器之间执行的任务不重复呢？</p>
</blockquote>
]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>学习</tag>
        <tag>后端</tag>
        <tag>黑马程序员</tag>
        <tag>学成在线</tag>
      </tags>
  </entry>
  <entry>
    <title>学成在线Day07</title>
    <url>/2024/03/21/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFDay07/</url>
    <content><![CDATA[<h1 id="技术方案"><a class="markdownIt-Anchor" href="#技术方案"></a> 技术方案</h1>
<h2 id="作业分片方案"><a class="markdownIt-Anchor" href="#作业分片方案"></a> 作业分片方案</h2>
<p>任务添加成功后，对于要处理的任务会添加到待处理任务表中，现在启动多个执行器实例去查询这些待处理任务</p>
<p><em><strong>此时如何保证多个执行器不会查询到重复的任务呢？</strong></em></p>
<p>XXL-JOB并不直接提供数据处理的功能，它只会给执行器分配好分片序号，在向执行器任务调度的同时下发分片总数以及分片序号等参数，执行器收到这些参数根据自己的业务需求去利用这些参数。</p>
<p>每个执行器收到广播任务有两个参数：分片总数、分片序号。每个执行从数据表取任务时可以让任务id 模上 分片总数，如果等于分片序号则执行此任务。</p>
<p>上边两个执行器实例那么分片总数为2，序号为0、1，从任务1开始，如下：</p>
<p>1 % 2 = 1  执行器2执行</p>
<p>2 % 2 = 0  执行器1执行</p>
<p>3 % 2 = 1   执行器2执行</p>
<p>以此类推</p>
<h2 id="保证任务不重复执行"><a class="markdownIt-Anchor" href="#保证任务不重复执行"></a> 保证任务不重复执行</h2>
<h3 id="1调度过期策略"><a class="markdownIt-Anchor" href="#1调度过期策略"></a> 1.调度过期策略</h3>
<p><em><strong>通过作业分片方案保证了执行器之间查询到不重复的任务，如果一个执行器在处理一个视频还没有完成，此时调度中心又一次请求调度，为了不重复处理同一个视频该怎么办？</strong></em></p>
<p>首先配置调度过期策略：</p>
<p>查看文档如下：</p>
<p>调度过期策略：调度中心错过调度时间的补偿处理策略，包括：忽略、立即补偿触发一次等；</p>
<ul>
<li>忽略：调度过期后，忽略过期的任务，从当前时间开始重新计算下次触发时间；</li>
<li>立即执行一次：调度过期后，立即执行一次，并从当前时间开始重新计算下次触发时间；</li>
<li>阻塞处理策略：调度过于密集执行器来不及处理时的处理策略；</li>
</ul>
<p>这里我们选择忽略，如果立即执行一次就可能重复执行相同的任务。</p>
<h3 id="2阻塞处理策略"><a class="markdownIt-Anchor" href="#2阻塞处理策略"></a> 2.阻塞处理策略</h3>
<p>其次，再看阻塞处理策略，阻塞处理策略就是当前执行器正在执行任务还没有结束时调度中心进行任务调度，此时该如何处理。</p>
<p>查看文档如下：</p>
<ul>
<li>单机串行（默认）：调度请求进入单机执行器后，调度请求进入FIFO队列并以串行方式运行；</li>
<li>丢弃后续调度：调度请求进入单机执行器后，发现执行器存在运行的调度任务，本次请求将会被丢弃并标记为失败；</li>
<li>覆盖之前调度：调度请求进入单机执行器后，发现执行器存在运行的调度任务，将会终止运行中的调度任务并清空队列，然后运行本地调度任务；</li>
</ul>
<p>这里如果选择覆盖之前调度则可能重复执行任务，这里选择 丢弃后续调度或单机串行方式来避免任务重复执行。</p>
<h3 id="3只做这些配置可以保证任务不会重复执行吗"><a class="markdownIt-Anchor" href="#3只做这些配置可以保证任务不会重复执行吗"></a> 3.只做这些配置可以保证任务不会重复执行吗？</h3>
<p>做不到，还需要保证任务处理的<code>幂等性</code>，什么是任务的<code>幂等性</code>？任务的<code>幂等性</code>是指：对于数据的操作不论多少次，操作的结果始终是一致的。在本项目中要实现的是不论多少次任务调度同一个视频只执行一次成功的转码。</p>
<p>什么是幂等性？</p>
<p>它描述了一次和多次请求某一个资源对于资源本身应该具有同样的结果。</p>
<p>幂等性是为了解决重复提交问题，比如：恶意刷单，重复支付等。</p>
<p>解决幂等性常用的方案：</p>
<ol>
<li>
<p>数据库约束，比如：唯一索引，主键。</p>
</li>
<li>
<p>乐观锁，常用于数据库，更新数据时根据乐观锁状态去更新。</p>
</li>
<li>
<p>唯一序列号，操作传递一个唯一序列号，操作时判断与该序列号相等则执行。</p>
</li>
</ol>
<p>基于以上分析，在执行器接收调度请求去执行视频处理任务时要实现视频处理的幂等性，要有办法去判断该视频是否处理完成，如果正在处理中或处理完则不再处理。这里我们在数据库视频处理表中添加处理状态字段，视频处理完成更新状态为完成，执行视频处理前判断状态是否完成，如果完成则不再处理。</p>
<h2 id="视频处理方案"><a class="markdownIt-Anchor" href="#视频处理方案"></a> 视频处理方案</h2>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240219161521796.png" alt="image-20240219161521796"></p>
<p>视频处理的详细流程如下：</p>
<pre class="mermaid">sequenceDiagram
	任务调度中心 -&gt;&gt; 媒资服务层 : 任务调度
	媒资服务层 -&gt;&gt; 媒资数据库 : 读取待处理任务
	媒资数据库 --&gt;&gt; 媒资服务层 : 
	Minio -&gt;&gt; 媒资服务层: 下载视频
	媒资服务层 -&gt;&gt; 媒资服务层 : 多线程处理
	媒资服务层 -&gt;&gt; Minio : 上传处理后视频
	媒资服务层 -&gt;&gt; 媒资数据库 : 记录处理结果</pre>
<ol>
<li>
<p>任务调度中心广播作业分片。</p>
</li>
<li>
<p>执行器收到广播作业分片，从数据库读取待处理任务，读取未处理及处理失败的任务。</p>
</li>
<li>
<p>执行器更新任务为处理中，根据任务内容从MinIO下载要处理的文件。</p>
</li>
<li>
<p>执行器启动多线程去处理任务。</p>
</li>
<li>
<p>任务处理完成，上传处理后的视频到MinIO。</p>
</li>
<li>
<p>将更新任务处理结果，如果视频处理完成除了更新任务处理结果以外还要将文件的访问地址更新至任务处理表及文件表中，最后将任务完成记录写入历史表。</p>
</li>
</ol>
<h1 id="查询待处理任务"><a class="markdownIt-Anchor" href="#查询待处理任务"></a> 查询待处理任务</h1>
<h2 id="需求分析"><a class="markdownIt-Anchor" href="#需求分析"></a> 需求分析</h2>
<p>查询待处理任务只处理未提交及处理失败的任务，任务处理失败后进行重试，最多重试3次。</p>
<p>任务处理成功将待处理记录移动到历史任务表。</p>
<p>下图是待处理任务表：</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240219164345252.png" alt="image-20240219164345252"></p>
<p>历史任务表与待处理任务表的结构相同。</p>
<h2 id="添加待处理任务"><a class="markdownIt-Anchor" href="#添加待处理任务"></a> 添加待处理任务</h2>
<p>上传视频成功向视频处理待处理表添加记录，暂时只添加对avi视频的处理记录。</p>
<p>根据MIME Type去判断是否是avi视频，下边列出部分MIME Type</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240219164705050.png" alt="image-20240219164705050"></p>
<p>avi视频的MIME Type是video/x-msvideo</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 记录待处理任务</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> mediaFiles 文件信息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addWitingTask</span><span class="params">(MediaFiles mediaFiles)</span> {</span><br><span class="line">    <span class="comment">//获取文件名</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">filename</span> <span class="operator">=</span> mediaFiles.getFilename();</span><br><span class="line">    <span class="comment">//获取拓展名</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">extension</span> <span class="operator">=</span> filename.substring(filename.lastIndexOf(<span class="string">"."</span>));</span><br><span class="line">    <span class="comment">//获取mimeType类型</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">mimeType</span> <span class="operator">=</span> getMimeType(extension);</span><br><span class="line">    <span class="keyword">if</span>(mimeType.equals(<span class="string">"video/x-msvideo"</span>)){         <span class="comment">//如果是avi文件，记录待处理任务</span></span><br><span class="line">        <span class="type">MediaProcess</span> <span class="variable">mediaProcess</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MediaProcess</span>();</span><br><span class="line">        BeanUtils.copyProperties(mediaFiles, mediaProcess);</span><br><span class="line">        <span class="comment">//状态</span></span><br><span class="line">        mediaProcess.setStatus(<span class="string">""</span>);</span><br><span class="line">        mediaProcess.setCreateDate(LocalDateTime.now());</span><br><span class="line">        mediaProcess.setFailCount(<span class="number">0</span>);</span><br><span class="line">        <span class="comment">//处理完成后再设置url</span></span><br><span class="line">        mediaProcess.setUrl(<span class="literal">null</span>);</span><br><span class="line">        mediaProcessMapper.insert(mediaProcess);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h2 id="查询待处理任务-2"><a class="markdownIt-Anchor" href="#查询待处理任务-2"></a> 查询待处理任务</h2>
<p>如何保证查询到的待处理视频记录不重复？</p>
<p>编写根据分片参数获取待处理任务的DAO方法，定义DAO接口如下</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Select("select * from media_process m " +</span></span><br><span class="line"><span class="meta">            "where (m.status = 1 or m.status = 3) " +</span></span><br><span class="line"><span class="meta">            "and m.fail_count &lt; 3 " +</span></span><br><span class="line"><span class="meta">            "and m.id % #{sharedTotal} = #{shardIndex} limit #{failCount}")</span></span><br><span class="line">    List&lt;MediaProcess&gt; <span class="title function_">selectProcessByShardIndex</span><span class="params">(<span class="type">int</span> sharedTotal, <span class="type">int</span> shardIndex,<span class="type">int</span> failCount)</span>;</span><br></pre></td></tr></table></figure>
<h1 id="开始执行任务"><a class="markdownIt-Anchor" href="#开始执行任务"></a> 开始执行任务</h1>
<h2 id="1分布式锁"><a class="markdownIt-Anchor" href="#1分布式锁"></a> 1.分布式锁</h2>
<p>为了避免多线程去争抢同一个任务可以使用synchronized同步锁去解决，如下代码：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">synchronized</span>(锁对象){</span><br><span class="line">   执行任务...</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>synchronized只能保证同一个虚拟机中多个线程去争抢锁。</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240219190142694.png" alt="image-20240219190142694"></p>
<p>如果是多个执行器分布式部署，并不能保证同一个视频只有一个执行器去处理。</p>
<p>现在要实现分布式环境下所有虚拟机中的线程去同步执行就需要让多个虚拟机去共用一个锁，虚拟机可以分布式部署，锁也可以分布式部署，如下图：</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240219190206663.png" alt="image-20240219190206663"></p>
<p>虚拟机都去抢占同一个锁，锁是一个单独的程序提供加锁、解锁服务。</p>
<p>该锁已不属于某个虚拟机，而是分布式部署，由多个虚拟机所共享，这种锁叫<code>分布式锁</code>。</p>
<p>实现分布式锁的方案有很多，常用的如下：</p>
<ol>
<li>基于<code>数据库</code>实现分布锁</li>
</ol>
<p>利用数据库<code>主键唯一性</code>的特点，或利用数据库唯一索引、行级锁的特点，多个线程同时去更新相同的记录，谁更新成功谁就抢到锁。</p>
<ol start="2">
<li>基于<code>redis</code>实现锁</li>
</ol>
<p>redis提供了分布式锁的实现方案，比如：SETNX、set nx、redisson等。</p>
<p>拿SETNX举例说明，SETNX命令的工作过程是去set一个不存在的key，多个线程去设置同一个key只会有一个线程设置成功，设置成功的的线程拿到锁。</p>
<ol start="3">
<li>使用<code>zookeeper</code>实现</li>
</ol>
<p>zookeeper是一个分布式协调服务，主要解决分布式程序之间的同步的问题。zookeeper的结构类似的文件目录，多线程向zookeeper创建一个子目录(节点)只会有一个创建成功，利用此特点可以实现分布式锁，谁创建该结点成功谁就获得锁。</p>
<h2 id="2开启任务"><a class="markdownIt-Anchor" href="#2开启任务"></a> 2.开启任务</h2>
<p>什么是<code>乐观锁</code>、<code>悲观锁</code>？</p>
<p><code>synchronized</code>是一种<code>悲观锁</code>，在执行被synchronized包裹的代码时需要首先获取锁，没有拿到锁则无法执行，是总悲观的认为别的线程会去抢，所以叫悲观锁。</p>
<p><code>乐观锁</code>的思想是它不认为会有线程去争抢，尽管去执行，如果没有<strong>执行成功就再去重试</strong>。</p>
<h1 id="更新任务状态"><a class="markdownIt-Anchor" href="#更新任务状态"></a> 更新任务状态</h1>
<p>任务处理完成需要更新任务处理结果，任务执行成功更新视频的URL、及任务处理结果，将待处理任务记录删除，同时向历史任务表添加记录。</p>
<p>在MediaFileProcessService接口添加方法</p>
<h1 id="视频处理"><a class="markdownIt-Anchor" href="#视频处理"></a> 视频处理</h1>
<p>视频采用并发处理，每个视频使用一个线程去处理，每次处理的视频数量不要超过cpu核心数。</p>
<p>所有视频处理完成结束本次执行，为防止代码异常出现无限期等待则添加超时设置，到达超时时间还没有处理完成仍结束任务。</p>
<p>获取电脑核心数量：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="variable">processors</span> <span class="operator">=</span> Runtime.getRuntime().availableProcessors();</span><br></pre></td></tr></table></figure>
<p>视频处理任务代码:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@XxlJob("videoJobHandler")</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">shardingJobHandler</span><span class="params">()</span> <span class="keyword">throws</span> Exception {</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 分片参数</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">shardIndex</span> <span class="operator">=</span> XxlJobHelper.getShardIndex();  <span class="comment">//执行器的序号, 从0开始编号</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">shardTotal</span> <span class="operator">=</span> XxlJobHelper.getShardTotal();  <span class="comment">//执行器的总数</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//确定cpu核心数量</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">processors</span> <span class="operator">=</span> Runtime.getRuntime().availableProcessors();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//查询待处理任务</span></span><br><span class="line">        List&lt;MediaProcess&gt; mediaProcessList = mediaFileProcessService</span><br><span class="line">                .getProcessByShardIndex(shardTotal, shardIndex, processors);</span><br><span class="line">        <span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> mediaProcessList.size();</span><br><span class="line">        log.debug(<span class="string">"查询到任务数量:{}"</span>, size);</span><br><span class="line">        <span class="keyword">if</span> ( size == <span class="number">0</span> ) {</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">//计数器数量为任务数量</span></span><br><span class="line">        <span class="type">CountDownLatch</span> <span class="variable">countDownLatch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(size);</span><br><span class="line">        <span class="comment">//启动一个线程池</span></span><br><span class="line">        <span class="comment">//线程池参数是任务数量</span></span><br><span class="line">        <span class="type">ExecutorService</span> <span class="variable">executorService</span> <span class="operator">=</span> Executors.newFixedThreadPool(size);</span><br><span class="line">        mediaProcessList.forEach(mediaProcess -&gt; {</span><br><span class="line">            executorService.execute(() -&gt; {</span><br><span class="line">                <span class="keyword">try</span> {</span><br><span class="line">                    <span class="type">Long</span> <span class="variable">taskId</span> <span class="operator">=</span> mediaProcess.getId();</span><br><span class="line">                    <span class="type">boolean</span> <span class="variable">b</span> <span class="operator">=</span> mediaFileProcessService.startTask(taskId);</span><br><span class="line">                    <span class="comment">//====抢占任务失败=====</span></span><br><span class="line">                    <span class="keyword">if</span> ( !b ) {</span><br><span class="line">                        log.debug(<span class="string">"抢占任务失败:{}"</span>, taskId);</span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                    }</span><br><span class="line">                    <span class="comment">//====抢占任务成功=====</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                    <span class="comment">//文件ID就是md5值</span></span><br><span class="line">                    <span class="type">String</span> <span class="variable">fileId</span> <span class="operator">=</span> mediaProcess.getFileId();</span><br><span class="line">                    <span class="comment">//桶</span></span><br><span class="line">                    <span class="type">String</span> <span class="variable">bucket</span> <span class="operator">=</span> mediaProcess.getBucket();</span><br><span class="line">                    <span class="comment">//文件名称</span></span><br><span class="line">                    <span class="type">String</span> <span class="variable">objectName</span> <span class="operator">=</span> mediaProcess.getFilePath();</span><br><span class="line">                    <span class="comment">//下载minio文件到本地</span></span><br><span class="line">                    <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> mediaFileService.downloadFileFromMinIO(bucket, objectName);</span><br><span class="line">                    <span class="keyword">if</span> ( file == <span class="literal">null</span> ) {</span><br><span class="line">                        log.debug(<span class="string">"下载文件失败,任务id:{},buckerName:{},objectName:{}"</span>, taskId, bucket, objectName);</span><br><span class="line">                        <span class="comment">//保存任务失败的结果</span></span><br><span class="line">                        mediaFileProcessService.saveProcessFinishStatus(taskId, <span class="string">"3"</span>, fileId, <span class="literal">null</span>, <span class="string">"下载视频到本地失败"</span>);</span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                    }</span><br><span class="line">                    <span class="comment">//源avi视频路径</span></span><br><span class="line">                    <span class="type">String</span> <span class="variable">videoPath</span> <span class="operator">=</span> file.getAbsolutePath();</span><br><span class="line">                    <span class="comment">//替换后的mp4视频名称</span></span><br><span class="line">                    <span class="type">String</span> <span class="variable">mp4Name</span> <span class="operator">=</span> fileId + <span class="string">".mp4"</span>;</span><br><span class="line">                    <span class="comment">//先创建一个临时文件作为转换后的文件</span></span><br><span class="line">                    <span class="type">File</span> <span class="variable">mp4File</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">                    <span class="keyword">try</span> {</span><br><span class="line">                        mp4File = File.createTempFile(<span class="string">"minio"</span>, <span class="string">".mp4"</span>);</span><br><span class="line">                    } <span class="keyword">catch</span> (IOException e) {</span><br><span class="line">                        log.info(<span class="string">"创建临时文件失败:{}"</span>, e.getMessage());</span><br><span class="line">                        <span class="comment">//保存任务失败的结果</span></span><br><span class="line">                        mediaFileProcessService.saveProcessFinishStatus(taskId, <span class="string">"3"</span>, fileId, <span class="literal">null</span>, <span class="string">"创建临时文件失败"</span>);</span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                    }</span><br><span class="line">                    <span class="type">String</span> <span class="variable">mp4Path</span> <span class="operator">=</span> mp4File.getAbsolutePath();</span><br><span class="line">                    <span class="comment">//创建工具类对象</span></span><br><span class="line">                    <span class="comment">//成功返回success,失败返回失败原因</span></span><br><span class="line">                    <span class="type">Mp4VideoUtil</span> <span class="variable">mp4VideoUtil</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Mp4VideoUtil</span>(ffmpegPath, videoPath, mp4Name, mp4Path);</span><br><span class="line">                    <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> mp4VideoUtil.generateMp4();</span><br><span class="line">                    <span class="keyword">if</span> ( !result.equals(<span class="string">"success"</span>) ) {</span><br><span class="line">                        log.debug(<span class="string">"视频转码失败,失败原因:{},buketName:{},objectName:{}"</span>, result, bucket, objectName);</span><br><span class="line">                        mediaFileProcessService.saveProcessFinishStatus(taskId, <span class="string">"3"</span>, fileId, <span class="literal">null</span>, <span class="string">"视频转码失败"</span>);</span><br><span class="line">                    }</span><br><span class="line">                    <span class="comment">//上传到minio</span></span><br><span class="line">                    <span class="type">boolean</span> <span class="variable">b1</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">                    <span class="keyword">try</span> {</span><br><span class="line">                        b1 = mediaFileService.addMediaFilesToMinIO(mp4File.getAbsolutePath(), <span class="string">"video/mp4"</span>, bucket, objectName);</span><br><span class="line">                    } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">                        log.debug(<span class="string">"上传到minio失败,任务id:{},buckerName:{},objectName:{}"</span>, taskId, bucket, objectName);</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">                    }</span><br><span class="line">                    <span class="keyword">if</span> ( !b1 ) {</span><br><span class="line">                        log.debug(<span class="string">"上传到minio失败,任务id:{},buckerName:{},objectName:{}"</span>, taskId, bucket, objectName);</span><br><span class="line">                        <span class="comment">//保存任务失败的结果</span></span><br><span class="line">                        mediaFileProcessService.saveProcessFinishStatus(taskId, <span class="string">"3"</span>, fileId, <span class="literal">null</span>, <span class="string">"上传到minio失败"</span>);</span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                    }</span><br><span class="line">                    <span class="comment">//拼装地址</span></span><br><span class="line">                    <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> getFilePath(fileId, <span class="string">"mp4"</span>);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//保存任务成功的结果</span></span><br><span class="line">                    mediaFileProcessService.saveProcessFinishStatus(taskId, <span class="string">"2"</span>, fileId, url, <span class="string">"任务成功"</span>);</span><br><span class="line">                } <span class="keyword">finally</span> {</span><br><span class="line">                    <span class="comment">//计数器减一</span></span><br><span class="line">                    countDownLatch.countDown();</span><br><span class="line">                }</span><br><span class="line">            });</span><br><span class="line">        });</span><br><span class="line">        <span class="comment">//阻塞</span></span><br><span class="line">        <span class="comment">//当计数器为0则继续执行</span></span><br><span class="line">        <span class="comment">//出现部分异常时,最多阻塞30分钟</span></span><br><span class="line">        countDownLatch.await(<span class="number">30</span>, TimeUnit.MINUTES);</span><br><span class="line">    }</span><br></pre></td></tr></table></figure>
<p>发现重大bug，由于获取文件类型错误，所以不会使mp4以外的视频格式的转码任务存储到数据库中，错误出现在：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> String <span class="title function_">getMimeType</span><span class="params">(String extension)</span> {</span><br><span class="line">        <span class="keyword">if</span> ( extension == <span class="literal">null</span> ) {</span><br><span class="line">            extension = <span class="string">""</span>;</span><br><span class="line">        }</span><br><span class="line">        </span><br><span class="line">        =========================================================================</span><br><span class="line">        <span class="type">ContentInfo</span> <span class="variable">mimeTypeMatch</span> <span class="operator">=</span> ContentInfoUtil.findMimeTypeMatch(extension);</span><br><span class="line">        =========================================================================</span><br><span class="line">        </span><br><span class="line">        <span class="type">String</span> <span class="variable">mimeType</span> <span class="operator">=</span> MediaType.APPLICATION_OCTET_STREAM_VALUE;<span class="comment">//通用mineType,也叫字节流</span></span><br><span class="line">        <span class="keyword">if</span> ( mimeTypeMatch != <span class="literal">null</span> ) {</span><br><span class="line">            mimeType = mimeTypeMatch.getMimeType();</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> mimeType;</span><br><span class="line">    }</span><br></pre></td></tr></table></figure>
<p>应该为<code>ContentInfo mimeTypeMatch = ContentInfoUtil.findExtensionMatch(extension);</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">b1 = mediaFileService.addMediaFilesToMinIO(mp4File.getAbsolutePath(), <span class="string">"video/mp4"</span>, bucket, objectName);</span><br></pre></td></tr></table></figure>
<p>修改为:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">b1 = mediaFileService.addMediaFilesToMinIO(mp4File.getAbsolutePath(), <span class="string">"video/mp4"</span>, bucket, mp4Name);</span><br></pre></td></tr></table></figure>
<p>只有mp4Name对应的路径是正确的</p>
<p>保存后更新media_file中的文件路径和url</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//更新media_file中的url地址和文件路径</span></span><br><span class="line"><span class="type">MediaFiles</span> <span class="variable">mediaFiles</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MediaFiles</span>();</span><br><span class="line">mediaFiles.setId(fileId);</span><br><span class="line">mediaFiles.setUrl(url);</span><br><span class="line">mediaFiles.setFilePath(mp4Name);</span><br><span class="line">mediaFileService.updateById(mediaFiles);</span><br></pre></td></tr></table></figure>
<h2 id="视频处理其他问题待完善"><a class="markdownIt-Anchor" href="#视频处理其他问题待完善"></a> 视频处理其他问题(待完善)</h2>
<h3 id="1任务补偿机制"><a class="markdownIt-Anchor" href="#1任务补偿机制"></a> 1.任务补偿机制</h3>
<p>如果有线程抢占了某个视频的处理任务，如果线程处理过程中挂掉了，该视频的状态将会一直是处理中，其它线程将无法处理，这个问题需要用补偿机制。</p>
<p>单独启动一个任务找到待处理任务表中超过执行期限但仍在处理中的任务，将任务的状态改为执行失败。</p>
<p>任务执行期限是处理一个视频的最大时间，比如定为30分钟，通过任务的启动时间去判断任务是否超过执行期限。</p>
<p>大家思考这个sql该如何实现？</p>
<p>大家尝试自己实现此任务补偿机制。</p>
<h3 id="2达到最大失败次数"><a class="markdownIt-Anchor" href="#2达到最大失败次数"></a> 2.达到最大失败次数</h3>
<p>当任务达到最大失败次数时一般就说明程序处理此视频存在问题，这种情况就需要人工处理，在页面上会提示失败的信息，人工可手动执行该视频进行处理，或通过其它转码工具进行视频转码，转码后直接上传mp4视频。</p>
<h3 id="3分块文件清理问题"><a class="markdownIt-Anchor" href="#3分块文件清理问题"></a> 3.分块文件清理问题</h3>
<p>上传一个文件进行分块上传，上传一半不传了，之前上传到minio的分块文件要清理吗？怎么做的？</p>
<p>1、在数据库中有一张文件表记录minio中存储的文件信息。</p>
<p>2、文件开始上传时会写入文件表，状态为上传中，上传完成会更新状态为上传完成。</p>
<p>3、当一个文件传了一半不再上传了说明该文件没有上传完成，会有定时任务去查询文件表中的记录，如果文件未上传完成则删除minio中没有上传成功的文件目录。</p>
<h1 id="绑定媒资"><a class="markdownIt-Anchor" href="#绑定媒资"></a> 绑定媒资</h1>
<p>基础增删改查内容，详细内容查看内容模块代码</p>
<h1 id="实战"><a class="markdownIt-Anchor" href="#实战"></a> 实战</h1>
<p>根据接口定义实现解除绑定功能。</p>
<p>前端文件course-add-step2-outline.vue中作如下修改:</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">async</span> <span class="title function_">handleDeleteMedia</span>(<span class="params">node: ICourseOutlineTreeNode</span>) {</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(node)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(node.<span class="property">id</span>)</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">      <span class="keyword">if</span> (</span><br><span class="line">        node.<span class="property">teachplanMedia</span> === <span class="literal">undefined</span> ||</span><br><span class="line">        node.<span class="property">teachplanMedia</span>.<span class="property">id</span> === <span class="literal">undefined</span></span><br><span class="line">      ) {</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      }</span><br><span class="line">      <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="title function_">showDeleteConfirm</span>()</span><br><span class="line">      <span class="keyword">await</span> <span class="title function_">mediaUnAssociation</span>(</span><br><span class="line">        node.<span class="property">id</span>,</span><br><span class="line">        node.<span class="property">teachplanMedia</span>.<span class="property">mediaId</span>,</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">courseBaseId</span></span><br><span class="line">      )</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">getList</span>()</span><br><span class="line">    } <span class="keyword">catch</span> (error) {}</span><br><span class="line">  }</span><br></pre></td></tr></table></figure>
<p>后端基础增删查改即可</p>
<h1 id="课程发布"><a class="markdownIt-Anchor" href="#课程发布"></a> 课程发布</h1>
<p>作为课程制作方即教学机构，在课程发布前通过课程预览功能可以看到课程发布后的效果，哪里的课程信息存在问题方便查看，及时修改。</p>
<p>下图是课程预览的效果图，也是课程正式发布后的课程详情界面：</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240220200205363.png" alt="image-20240220200205363"></p>
<p>教学机构确认课程内容无误，提交审核，平台运营人员对课程内容审核，审核通过后教学机构人员发布课程成功。</p>
<p>课程发布模块共包括三块功能：</p>
<p>1、课程预览</p>
<p>2、课程审核</p>
<p>3、课程发布</p>
<h2 id="模板引擎"><a class="markdownIt-Anchor" href="#模板引擎"></a> 模板引擎</h2>
<p>根据前边的数据模型分析，课程预览就是把课程的相关信息进行整合，在课程预览界面进行展示，课程预览界面与课程发布的课程详情界面一致。</p>
<p>项目采用模板引擎技术实现课程预览界面。什么是模板引擎？</p>
<p>早期我们采用的jsp技术就是一种模板引擎技术，如下图：</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240220200332744.png" alt="image-20240220200332744"></p>
<p>1、浏览器请求web服务器</p>
<p>2、服务器渲染页面，渲染的过程就是向jsp页面(模板)内填充数据(模型)。</p>
<p>3、服务器将渲染生成的页面返回给浏览器。</p>
<p>所以模板引擎就是：模板+数据=输出，Jsp页面就是模板，页面中嵌入的jsp标签就是数据，两者相结合输出html网页。</p>
<p>常用的java模板引擎还有哪些？</p>
<p>Jsp、Freemarker、Thymeleaf 、Velocity 等。</p>
<p>本项目采用Freemarker作为模板引擎技术。</p>
<p>Freemarker官方地址：<a href="http://freemarker.foofun.cn/">http://freemarker.foofun.cn/</a></p>
<p>Maven依赖:</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- Spring Boot 对结果视图 Freemarker 集成 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-freemarker<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>配置文件:</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">freemarker:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">cache:</span> <span class="literal">false</span>   <span class="comment">#关闭模板缓存，方便测试</span></span><br><span class="line">    <span class="attr">settings:</span></span><br><span class="line">      <span class="attr">template_update_delay:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">suffix:</span> <span class="string">.ftl</span>   <span class="comment">#页面模板后缀名</span></span><br><span class="line">    <span class="attr">charset:</span> <span class="string">UTF-8</span></span><br><span class="line">    <span class="attr">template-loader-path:</span> <span class="string">classpath:/templates/</span>   <span class="comment">#页面模板位置(默认为 classpath:/templates/)</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="attr">add-mappings:</span> <span class="literal">false</span>   <span class="comment">#关闭项目中的静态资源映射(static、resources文件夹下的资源)</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>学习</tag>
        <tag>后端</tag>
        <tag>黑马程序员</tag>
        <tag>学成在线</tag>
      </tags>
  </entry>
  <entry>
    <title>学成在线Day08</title>
    <url>/2024/03/21/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFDay08/</url>
    <content><![CDATA[<h1 id="课程预览"><a class="markdownIt-Anchor" href="#课程预览"></a> 课程预览</h1>
<h2 id="接口定义"><a class="markdownIt-Anchor" href="#接口定义"></a> 接口定义</h2>
<p>遇到了问题：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">nginx: [error] OpenEvent("Global\ngx_reload_34084") failed (2: The system cannot find the file specified)</span><br></pre></td></tr></table></figure>
<p>出现这个错误就是你的nginx关掉了,没有打开,你再次点击nginx.exe运行, 一闪而过后,在cmd控制台下,再次输入nginx.exe -s reload,结果成功</p>
<p>模板修改好之后，点击</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240226173831645.png" alt="image-20240226173831645"></p>
<p>可以不用重启项目</p>
<p>其他部分基础查询操作即可</p>
<p>预览网页:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@ApiOperation("预览文件")</span></span><br><span class="line">    <span class="meta">@GetMapping("/preview/{mediaId}")</span></span><br><span class="line">    <span class="keyword">public</span> RestResponse&lt;String&gt; <span class="title function_">getPlayUrlByMediaId</span><span class="params">(<span class="meta">@PathVariable</span> String mediaId)</span> {</span><br><span class="line">        <span class="type">MediaFiles</span> <span class="variable">mediaFiles</span> <span class="operator">=</span> mediaFileService.getFileById(mediaId);</span><br><span class="line">        <span class="keyword">if</span>(mediaFiles == <span class="literal">null</span> || StringUtils.isEmpty(mediaFiles.getUrl())){</span><br><span class="line">            XueChengPlusException.cast(<span class="string">"视频还没有转码处理"</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> RestResponse.success(mediaFiles.getUrl());</span><br><span class="line">    }</span><br></pre></td></tr></table></figure>
<h1 id="课程审核"><a class="markdownIt-Anchor" href="#课程审核"></a> 课程审核</h1>
<h2 id="业务流程"><a class="markdownIt-Anchor" href="#业务流程"></a> 业务流程</h2>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240227135349170.png" alt="image-20240227135349170"></p>
<p>在课程基本表course_base表设置课程审核状态字段，包括：未提交、已提交(未审核)、审核通过、审核不通过。</p>
<h2 id="接口开发"><a class="markdownIt-Anchor" href="#接口开发"></a> 接口开发</h2>
<h3 id="dao开发"><a class="markdownIt-Anchor" href="#dao开发"></a> Dao开发</h3>
<p>1、查询课程基本信息、课程营销信息、课程计划信息等课程相关信息，整合为课程预发布信息。</p>
<p>2、向课程预发布表course_publish_pre插入一条记录，如果已经存在则更新，审核状态为：已提交。</p>
<p>3、更新课程基本表course_base课程审核状态为：已提交。</p>
<p>约束：</p>
<p>1、对已提交审核的课程不允许提交审核。</p>
<p>2、本机构只允许提交本机构的课程。</p>
<p>3、没有上传图片不允许提交审核。</p>
<p>4、没有添加课程计划不允许提交审核。</p>
<p>代码如下:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">commitAudit</span><span class="params">(Long companyId, Long courseId)</span> {</span><br><span class="line">        <span class="comment">//查询课程</span></span><br><span class="line">        <span class="comment">//1.对已提交审核的课程不允许提交审核。</span></span><br><span class="line">        <span class="type">CourseBaseInfoDTO</span> <span class="variable">courseBaseInfo</span> <span class="operator">=</span> courseBaseInfoService.getCourseBaseInfo(courseId);</span><br><span class="line">        <span class="keyword">if</span>(courseBaseInfo == <span class="literal">null</span>){</span><br><span class="line">            XueChengPlusException.cast(<span class="string">"课程不存在"</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">//审核状态</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">auditStatus</span> <span class="operator">=</span> courseBaseInfo.getAuditStatus();</span><br><span class="line">        <span class="comment">//若课程状态为已提交则不允许提交</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="string">"202003"</span>.equals(auditStatus)){</span><br><span class="line">            XueChengPlusException.cast(<span class="string">"课程已提交,不允许重复提交"</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">//2.没有上传图片不允许提交审核。</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">pic</span> <span class="operator">=</span> courseBaseInfo.getPic();</span><br><span class="line">        <span class="keyword">if</span>( StringUtils.isEmpty(pic) ){</span><br><span class="line">            XueChengPlusException.cast(<span class="string">"请上传课程图片"</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">//查询课程计划</span></span><br><span class="line">        <span class="comment">//3.没有添加课程计划不允许提交审核。</span></span><br><span class="line">        List&lt;TeachplanDTO&gt; teachPlanTree = teachPlanService.findTeachPlanTree(courseId);</span><br><span class="line">        <span class="keyword">if</span> ( teachPlanTree == <span class="literal">null</span> || teachPlanTree.isEmpty() ){</span><br><span class="line">            XueChengPlusException.cast(<span class="string">"请编写课程计划"</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="type">CoursePublishPre</span> <span class="variable">coursePublishPre</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CoursePublishPre</span>();</span><br><span class="line">        BeanUtils.copyProperties(courseBaseInfo, coursePublishPre);</span><br><span class="line">        <span class="comment">//将课程基本信息,营销信息,教学计划信息等插入课程预发布表</span></span><br><span class="line">        <span class="comment">//营销信息</span></span><br><span class="line">        <span class="type">CourseMarket</span> <span class="variable">courseMarket</span> <span class="operator">=</span> courseMarketMapper.selectById(courseId);</span><br><span class="line">        <span class="type">String</span> <span class="variable">courseMarketJsonString</span> <span class="operator">=</span> JSON.toJSONString(courseMarket);</span><br><span class="line">        coursePublishPre.setMarket(courseMarketJsonString);</span><br><span class="line">        <span class="comment">//计划信息</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">teachPlanJsonString</span> <span class="operator">=</span> JSON.toJSONString(teachPlanTree);</span><br><span class="line">        coursePublishPre.setTeachplan(teachPlanJsonString);</span><br><span class="line">        <span class="comment">//设置状态为已提交</span></span><br><span class="line">        coursePublishPre.setStatus(<span class="string">"202003"</span>);</span><br><span class="line">        <span class="comment">//提交时间</span></span><br><span class="line">        coursePublishPre.setCreateDate(LocalDateTime.now());</span><br><span class="line">        <span class="comment">//保存到课程预发布表</span></span><br><span class="line">        <span class="type">CoursePublishPre</span> <span class="variable">coursePublishPreObj</span> <span class="operator">=</span> coursePublishPreMapper.selectById(courseId);</span><br><span class="line">        <span class="keyword">if</span>(coursePublishPreObj == <span class="literal">null</span>){</span><br><span class="line">            <span class="comment">//插入</span></span><br><span class="line">            coursePublishPreMapper.insert(coursePublishPre);</span><br><span class="line">        }<span class="keyword">else</span>{</span><br><span class="line">            <span class="comment">//更新</span></span><br><span class="line">            coursePublishPreMapper.updateById(coursePublishPre);</span><br><span class="line">        }</span><br><span class="line">        <span class="type">CourseBase</span> <span class="variable">courseBase</span> <span class="operator">=</span> courseBaseMapper.selectById(courseId);</span><br><span class="line">        <span class="comment">//更新课程状态为已提交</span></span><br><span class="line">        courseBase.setAuditStatus(<span class="string">"203003"</span>);</span><br><span class="line">        courseBaseMapper.updateById(courseBase);</span><br><span class="line">    }</span><br></pre></td></tr></table></figure>
<h1 id="课程发布"><a class="markdownIt-Anchor" href="#课程发布"></a> 课程发布</h1>
<h2 id="数据模型"><a class="markdownIt-Anchor" href="#数据模型"></a> 数据模型</h2>
<p>为了提高网站的速度需要将课程信息进行缓存，并且要将课程信息加入索引库方便搜索，下图显示了课程发布后课程信息的流转情况：</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240227144812329.png" alt="image-20240227144812329"></p>
<ol>
<li>
<p>向内容管理数据库的课程发布表存储课程发布信息，更新课程基本信息表中发布状态为已发布。</p>
</li>
<li>
<p>向Redis存储课程缓存信息。</p>
</li>
<li>
<p>向Elasticsearch存储课程索引信息。</p>
</li>
<li>
<p>请求分布文件系统存储课程静态化页面(即html页面)，实现快速浏览课程详情页面。</p>
</li>
</ol>
<h2 id="分布式事务技术方案"><a class="markdownIt-Anchor" href="#分布式事务技术方案"></a> 分布式事务技术方案</h2>
<h3 id="分布式事务概念"><a class="markdownIt-Anchor" href="#分布式事务概念"></a> 分布式事务概念</h3>
<p><code>本地事务:</code></p>
<p>平常我们在程序中通过spring去控制事务是利用数据库本身的事务特性来实现的，因此叫数据库事务，由于应用主要靠关系数据库来控制事务，此数据库只属于该应用，所以基于本应用自己的关系型数据库的事务又被称为本地事务。</p>
<p>本地事务具有ACID四大特性，数据库事务在实现时会将一次事务涉及的所有操作全部纳入到一个不可分割的执行单元，该执行单元中的所有操作 要么都成功，要么都失败，只要其中任一操作执行失败，都将导致整个事务的回滚。</p>
<p><code>分布式事务:</code></p>
<p>现在的需求是课程发布操作后将数据写入数据库、redis、elasticsearch、MinIO四个地方，这四个地方已经不限制在一个数据库内，是由四个分散的服务去提供，与这四个服务去通信需要网络通信，而网络存在不可到达性，这种分布式系统环境下，通过与不同的服务进行网络通信去完成事务称之为<strong>分布式事务。</strong></p>
<p>在分布式系统中分布式事务的场景很多：</p>
<p>例如用户注册送积分，银行转账，创建订单减库存，这些都是分布式事务。</p>
<p>拿转账举例：</p>
<p>我们知道本地事务依赖数据库本身提供的事务特性来实现，因此以下逻辑可以控制本地事务：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">begin transaction； </span><br><span class="line">//1.本地数据库操作：张三减少金额 </span><br><span class="line">//2.本地数据库操作：李四增加金额 </span><br><span class="line">commit transation; </span><br></pre></td></tr></table></figure>
<p>但是在分布式环境下，会变成下边这样:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">begin transaction； </span><br><span class="line">//1.本地数据库操作：张三减少金额 </span><br><span class="line">//2.远程调用：让李四增加金额 </span><br><span class="line">commit transation;</span><br></pre></td></tr></table></figure>
<h3 id="cap理论"><a class="markdownIt-Anchor" href="#cap理论"></a> CAP理论</h3>
<p>控制分布式事务首先需要理解CAP理论，什么是CAP理论？</p>
<p>CAP是 <code>Consistency</code>、<code>Availability</code>、<code>Partition tolerance</code>三个词语的缩写，分别表示一致性、可用性、分区容忍性。</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240227145524460.png" alt="image-20240227145524460"></p>
<ol>
<li>
<p><code>一致性</code>是指用户不管访问哪一个结点拿到的数据都是最新的，比如查询小明的信息，不能出现在数据没有改变的情况下两次查询结果不一样。</p>
</li>
<li>
<p><code>可用性</code>是指任何时候查询用户信息都可以查询到结果，但不保证查询到最新的数据。</p>
</li>
<li>
<p><code>分区容忍性</code>也叫<code>分区容错性</code>，当系统采用分布式架构时由于网络通信异常导致请求中断、消息丢失，但系统依然对外提供服务。</p>
</li>
</ol>
<p>CAP理论要强调的是在分布式系统中这三点<code>不可能全部满足</code>，由于是分布式系统就要满足分区容忍性，因为服务之间难免出现网络异常，不能因为局部网络异常导致整个系统不可用。</p>
<h3 id="分布式事务控制方案"><a class="markdownIt-Anchor" href="#分布式事务控制方案"></a> 分布式事务控制方案</h3>
<p>学习了CAP理论我们知道进行分布式事务控制要在C和A中作出取舍，保证一致性就不要保证可用性，保证可用性就不要保证一致，首先你确认是要CP还是AP，具体要根据应用场景进行判断。</p>
<p>CP的场景：满足C舍弃A，强调一致性。</p>
<p>跨行转账：一次转账请求要等待双方银行系统都完成整个事务才算完成，只要其中一个失败另一方执行回滚操作。</p>
<p>开户操作：在业务系统开户同时要在运营商开户，任何一方开户失败该用户都不可使用，所以要满足CP。</p>
<p>AP的场景：满足A舍弃C，强调可用性。</p>
<p>订单退款，今日退款成功，明日账户到账，只要用户可以接受在一定时间内到账即可。</p>
<p>注册送积分，注册成功积分在24分到账。</p>
<p>支付短信通信，支付成功发短信，短信发送可以有延迟，甚至没有发送成功。</p>
<p>在实际应用中符合AP的场景较多，其实虽然AP舍弃C一致性，实际上最终数据还是达到了一致，也就满足了最终一致性，所以业界定义了BASE理论。</p>
<p>什么是<code>BASE理论</code>？</p>
<p>BASE 是 <code>Basically Available(基本可用)</code>、<code>Soft state(软状态)</code>和 <code>Eventually consistent (最终一致性)</code>三个短语的缩写。</p>
<p>基本可用：当系统无法满足全部可用时保证核心服务可用即可，比如一个外卖系统，每到中午12点左右系统并发量很高，此时要保证下单流程涉及的服务可用，其它服务暂时不可用。</p>
<p>软状态：是指可以存在中间状态，比如：打印自己的社保统计情况，该操作不会立即出现结果，而是提示你打印中，请在XXX时间后查收。虽然出现了中间状态，但最终状态是正确的。</p>
<p>最终一致性：退款操作后没有及时到账，经过一定的时间后账户到账，舍弃强一致性，满足最终一致性。</p>
<p>分布式事务控制有哪些<code>常用的技术方案</code>？</p>
<p>实现CP就是要实现强一致性:</p>
<p>使用<code>Seata</code>框架基于AT模式实现</p>
<p>使用<code>Seata</code>框架基于TCC模式实现。</p>
<p>实现AP则要保证最终数据一致性:</p>
<p>使用消息队列通知的方式去实现，通知失败自动重试，达到最大失败次数需要人工处理；</p>
<p>使用任务调度的方案，启动任务调度将课程信息由数据库同步到elasticsearch、MinIO、redis中。</p>
<h3 id="课程发布的事务控制方案"><a class="markdownIt-Anchor" href="#课程发布的事务控制方案"></a> 课程发布的事务控制方案</h3>
<p>目前我们已经有了任务调度的技术积累，这里选用任务调度的方案去实现分布式事务控制，课程发布满足<code>AP(可用性,分区容忍性)</code>即可。</p>
<p>时序图如下:</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240227150255989.png" alt="image-20240227150255989"></p>
<ol>
<li>
<p>执行发布操作，内容管理服务存储课程发布表的同时向消息表添加一条“课程发布任务”。这里使用本地事务保证课程发布信息保存成功，同时消息表也保存成功。</p>
</li>
<li>
<p>任务调度服务定时调度内容管理服务扫描消息表，由于课程发布操作后向消息表插入一条课程发布任务，此时扫描到一条任务。</p>
</li>
<li>
<p>拿到任务开始执行任务，分别向redis、elasticsearch及文件系统存储数据。</p>
</li>
<li>
<p>任务完成后删除消息表记录。</p>
</li>
</ol>
<h1 id="课程发布接口"><a class="markdownIt-Anchor" href="#课程发布接口"></a> 课程发布接口</h1>
<p>service代码如下,有待完善:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">publish</span><span class="params">(Long companyId, Long courseId)</span> {</span><br><span class="line">        <span class="comment">//查询课程预发布信息</span></span><br><span class="line">        <span class="type">CoursePublishPre</span> <span class="variable">coursePublishPre</span> <span class="operator">=</span> coursePublishPreMapper.selectById(courseId);</span><br><span class="line">        <span class="keyword">if</span>(coursePublishPre == <span class="literal">null</span>){</span><br><span class="line">            XueChengPlusException.cast(<span class="string">"课程预发布信息不存在"</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">//课程预发布信息状态</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">status</span> <span class="operator">=</span> coursePublishPre.getStatus();</span><br><span class="line">        <span class="comment">//检查是否通过审核</span></span><br><span class="line">        <span class="keyword">if</span>(!<span class="string">"202004"</span>.equals(status)){</span><br><span class="line">            XueChengPlusException.cast(<span class="string">"课程未通过审核,不能发布"</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">//向课程发布表写入数据</span></span><br><span class="line">        <span class="type">CoursePublish</span> <span class="variable">coursePublish</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CoursePublish</span>();</span><br><span class="line">        BeanUtils.copyProperties(coursePublishPre, coursePublish);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//发布课程</span></span><br><span class="line">        <span class="type">CourseBase</span> <span class="variable">courseBase</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CourseBase</span>();</span><br><span class="line">        BeanUtils.copyProperties(coursePublishPre, courseBase);</span><br><span class="line">        <span class="comment">//先查询课程发布表</span></span><br><span class="line">        <span class="type">CoursePublish</span> <span class="variable">coursePublishObj</span> <span class="operator">=</span> coursePublishMapper.selectById(courseId);</span><br><span class="line">        <span class="keyword">if</span>(coursePublishObj == <span class="literal">null</span>) {</span><br><span class="line">            <span class="comment">//插入</span></span><br><span class="line">            coursePublishMapper.insert(coursePublish);</span><br><span class="line">        }<span class="keyword">else</span>{</span><br><span class="line">            <span class="comment">//更新</span></span><br><span class="line">            coursePublishMapper.updateById(coursePublish);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">//向消息表写记录</span></span><br><span class="line">        <span class="comment">//todo</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//将预发布表信息删除</span></span><br><span class="line">        coursePublishPreMapper.deleteById(courseId);</span><br><span class="line">    }</span><br></pre></td></tr></table></figure>
<h1 id="消息处理sdk"><a class="markdownIt-Anchor" href="#消息处理sdk"></a> 消息处理SDK</h1>
<h2 id="消息模块技术方案"><a class="markdownIt-Anchor" href="#消息模块技术方案"></a> 消息模块技术方案</h2>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240227162519786.png" alt="image-20240227162519786"></p>
<p>上图中红色框内的都是与消息处理相关的操作：</p>
<ol>
<li>
<p>新增消息表</p>
</li>
<li>
<p>扫描消息表。</p>
</li>
<li>
<p>更新消息表。</p>
</li>
<li>
<p>删除消息表。</p>
</li>
</ol>
<p>使用消息表这种方式实现最终事务一致性的地方除了课程发布还有其它业务场景。</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240227162727715.png" alt="image-20240227162727715"></p>
<p>如果在每个地方都实现一套针对消息表定时扫描、处理的逻辑基本上都是重复的，软件的可复用性太低，成本太高。</p>
<p>如何解决这个问题？</p>
<p>针对这个问题可以想到将消息处理相关的逻辑做成一个通用的东西。</p>
<p>是做成<code>通用的服务</code>，还是做成<code>通用的代码组件</code>呢？</p>
<p>通用的服务是完成一个通用的独立功能，并提供独立的网络接口，比如：项目中的文件系统服务，提供文件的分布式存储服务。</p>
<p>代码组件也是完成一个通用的独立功能，通常会提供API的方式供外部系统使用，比如：fastjson、Apache commons工具包等。</p>
<p>如果将消息处理做成一个通用的服务，该服务需要连接多个数据库，因为它要扫描微服务数据库下的消息表，并且要提供与微服务通信的网络接口，单就针对当前需求而言开发成本有点高。</p>
<p>如果将消息处理做一个SDK工具包相比通用服务不仅可以解决<code>将消息处理通用化</code>的需求，还可以<code>降低成本</code>。</p>
<p>所以，本项目确定将对消息表相关的处理做成一个SDK组件供各微服务使用,如下图所示：</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240227162824003.png" alt="image-20240227162824003"></p>
<p>下边对消息SDK的设计内容进行说明：</p>
<ol>
<li>sdk需要提供执行任务的逻辑吗？</li>
</ol>
<p>拿课程发布任务举例，执行课程发布任务是要向redis、索引库等同步数据，其它任务的执行逻辑是不同的，所以执行任务在sdk中不用实现任务逻辑，只需要提供一个抽象方法由具体的执行任务方去实现。</p>
<ol start="2">
<li>如何保证任务的幂等性？</li>
</ol>
<p>在视频处理章节介绍的视频处理的<code>幂等性</code>方案，这里可以采用类似方案，任务执行完成后会从消息表删除，如果消息的状态是完成或不存在消息表中则不用执行。</p>
<ol start="3">
<li>如何保证任务不重复执行？</li>
</ol>
<p>采用和视频处理章节一致方案，除了保证任务的幂等性外，任务调度采用<code>分片广播</code>，根据分片参数去获取任务，另外阻塞调度策略为<code>丢弃任务</code>。</p>
<p>注意：这里是信息同步类任务，即使任务重复执行也没有关系，不再使用抢占任务的方式保证任务不重复执行。</p>
<ol start="4">
<li>还有一个问题，根据消息表记录是否存在或消息表中的任务状态去保证任务的幂等性，如果一个任务有好几个小任务，比如：课程发布任务需要执行三个同步操作：存储课程到redis、存储课程到索引库，存储课程页面到文件系统。如果其中一个小任务已经完成也不应该去重复执行。这里该如何设计？</li>
</ol>
<p>将小任务作为任务的不同的阶段，在消息表中设计阶段状态。</p>
<p>调整配置文件后发现无法启动content的api，原因是在nacos中有如下代码片段:</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 配置本地优先</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">override-none:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<p>将其删除即可解决问题</p>
<p>后续内容有待Day09完善</p>
]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>学习</tag>
        <tag>后端</tag>
        <tag>黑马程序员</tag>
        <tag>学成在线</tag>
      </tags>
  </entry>
  <entry>
    <title>学成在线Day09</title>
    <url>/2024/03/21/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFDay09/</url>
    <content><![CDATA[<h1 id="页面静态化"><a class="markdownIt-Anchor" href="#页面静态化"></a> 页面静态化</h1>
<h2 id="页面静态化概念"><a class="markdownIt-Anchor" href="#页面静态化概念"></a> 页面静态化概念</h2>
<p>根据课程发布的操作流程，执行课程发布后要将课程详情信息页面静态化，生成html页面上传至文件系统。</p>
<p>什么是页面静态化？</p>
<p>课程预览功能通过模板引擎技术在页面模板中填充数据，生成html页面，这个过程是当客户端请求服务器时服务器才开始渲染生成html页面，最后响应给浏览器，服务端渲染的并发能力是有限的。</p>
<p>页面静态化则强调将生成html页面的过程提前，提前使用模板引擎技术生成html页面，当客户端请求时直接请求html页面，由于是静态页面可以使用nginx、apache等高性能的web服务器，并发性能高。</p>
<p>什么时候能用页面静态化技术？</p>
<p>当数据变化不频繁，一旦生成静态页面很长一段时间内很少变化，此时可以使用页面静态化。因为如果数据变化频繁，一旦改变就需要重新生成静态页面，导致维护静态页面的工作量很大。</p>
<p>根据课程发布的业务需求，虽然课程发布后仍可以修改课程信息，但需要经过课程审核，且修改频度不大，所以适合使用页面静态化。</p>
<h2 id="页面静态化测试"><a class="markdownIt-Anchor" href="#页面静态化测试"></a> 页面静态化测试</h2>
<p>maven依赖:</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-freemarker<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>测试类代码:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testGenerateHtmlByTemplate</span><span class="params">()</span> <span class="keyword">throws</span> IOException, TemplateException {</span><br><span class="line">        <span class="comment">//配置freemarker</span></span><br><span class="line">        <span class="type">Configuration</span> <span class="variable">configuration</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Configuration</span>(Configuration.VERSION_2_3_30);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//加载模板</span></span><br><span class="line">        <span class="comment">//选指定模板路径,classpath下templates下</span></span><br><span class="line">        <span class="comment">//得到classpath路径</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">classpath</span> <span class="operator">=</span> <span class="built_in">this</span>.getClass().getResource(<span class="string">"/"</span>).getPath();</span><br><span class="line">        configuration.setDirectoryForTemplateLoading(<span class="keyword">new</span> <span class="title class_">File</span>(classpath + <span class="string">"/templates/"</span>));</span><br><span class="line">        <span class="comment">//设置字符编码</span></span><br><span class="line">        configuration.setDefaultEncoding(<span class="string">"utf-8"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//指定模板文件名称</span></span><br><span class="line">        <span class="type">Template</span> <span class="variable">template</span> <span class="operator">=</span> configuration.getTemplate(<span class="string">"course_template.ftl"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//准备数据</span></span><br><span class="line">        <span class="type">CoursePreviewDTO</span> <span class="variable">coursePreviewInfo</span> <span class="operator">=</span> coursePublishService.getCoursePreviewInfo(<span class="number">26L</span>);</span><br><span class="line"></span><br><span class="line">        Map&lt;String, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">"model"</span>, coursePreviewInfo);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//静态化</span></span><br><span class="line">        <span class="comment">//参数1：模板，参数2：数据模型</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">content</span> <span class="operator">=</span> FreeMarkerTemplateUtils.processTemplateIntoString(template, map);</span><br><span class="line">        System.out.println(content);</span><br><span class="line">        <span class="comment">//将静态化内容输出到文件中</span></span><br><span class="line">        <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> IOUtils.toInputStream(content);</span><br><span class="line">        <span class="comment">//输出流</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//再用拷贝流输出</span></span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fileOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">"D:\\Programming_Learning\\Project\\freemaker\\"</span> + <span class="number">25</span> + <span class="string">".html"</span>);</span><br><span class="line">        IOUtils.copy(inputStream, fileOutputStream);</span><br><span class="line">    }</span><br></pre></td></tr></table></figure>
<h2 id="上传文件测试"><a class="markdownIt-Anchor" href="#上传文件测试"></a> 上传文件测试</h2>
<p>maven依赖:</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- Spring Cloud 微服务远程调用 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.github.openfeign<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>feign-httpclient<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--feign支持Multipart格式传参--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.github.openfeign.form<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>feign-form<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.8.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.github.openfeign.form<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>feign-form-spring<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.8.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>feign-dev.yaml配置添加：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">hystrix:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">circuitbreaker:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">hystrix:</span></span><br><span class="line">  <span class="attr">command:</span></span><br><span class="line">    <span class="attr">default:</span></span><br><span class="line">      <span class="attr">execution:</span></span><br><span class="line">        <span class="attr">isolation:</span></span><br><span class="line">          <span class="attr">thread:</span></span><br><span class="line">            <span class="attr">timeoutInMilliseconds:</span> <span class="number">30000</span>  <span class="comment">#熔断超时时间</span></span><br><span class="line"><span class="attr">ribbon:</span></span><br><span class="line">  <span class="attr">ConnectTimeout:</span> <span class="number">60000</span> <span class="comment">#连接超时时间</span></span><br><span class="line">  <span class="attr">ReadTimeout:</span> <span class="number">60000</span> <span class="comment">#读超时时间</span></span><br><span class="line">  <span class="attr">MaxAutoRetries:</span> <span class="number">0</span> <span class="comment">#重试次数</span></span><br><span class="line">  <span class="attr">MaxAutoRetriesNextServer:</span> <span class="number">1</span> <span class="comment">#切换实例的重试次数</span></span><br></pre></td></tr></table></figure>
<p>现在需要将课程的静态文件上传到minio，单独存储到course目录下，文件的objectname为"课程id.html"，原有的上传文件接口需要增加一个参数 objectname。</p>
<p>注意feign的配置不能有错</p>
<p>feign上的请求地址与原api有所差异，有时需要单独更改</p>
<p>原api:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(value = "/upload/coursefile",consumes = MediaType.MULTIPART_FORM_DATA_VALUE)</span></span><br></pre></td></tr></table></figure>
<p>feign客户端:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@PostMapping(value = "/media/upload/coursefile",consumes = MediaType.MULTIPART_FORM_DATA_VALUE)</span></span><br></pre></td></tr></table></figure>
<p>意外BUG</p>
<p>前端工程启动不了发现是修改feign相关配置时删除了原有的配置，下次应该仔细点</p>
<p>MD其实并没有错，由于测试类和实际类名字相同，我启动了半天<code>测试类</code>...</p>
<h1 id="此处插入重点nginx内容"><a class="markdownIt-Anchor" href="#此处插入重点nginx内容"></a> 此处插入重点NGINX内容</h1>
<p>我修改配置后使用：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">nginx.exe -s reload</span><br></pre></td></tr></table></figure>
<p>后发现配置并未修改。</p>
<p><strong>经过调试</strong>后发现，nginx在根目录使用关闭指令后，<strong>并未按照预期关闭</strong></p>
<p>应使用</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">tasklist /fi "imagename eq nginx.exe"</span><br></pre></td></tr></table></figure>
<p>查询所有nginx进程并使用</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">taskkill /pid PID /f</span><br></pre></td></tr></table></figure>
<p>全部关闭，新打开的才是能正常使用的</p>
<p>浪费我俩小时服了</p>
<h2 id="熔断降级处理"><a class="markdownIt-Anchor" href="#熔断降级处理"></a> 熔断降级处理</h2>
<p>微服务中难免存在服务之间的远程调用，比如：内容管理服务远程调用媒资服务的上传文件接口，当微服务运行不正常会导致无法正常调用微服务，此时会出现异常，如果这种异常不去处理可能导致雪崩效应。</p>
<p>微服务的雪崩效应表现在服务与服务之间调用，当其中一个服务无法提供服务可能导致其它服务也死掉，比如：服务B调用服务A，由于A服务异常导致B服务响应缓慢，最后B、C等服务都不可用，像这样由一个服务所引起的一连串的多个服务无法提供服务即是微服务的雪崩效应，如下图：</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240229192607540.png" alt="image-20240229192607540"></p>
<p>如何解决由于微服务异常引起的雪崩效应呢？</p>
<p>可以采用熔断、降级的方法去解决。</p>
<p>熔断降级的相同点都是为了解决微服务系统崩溃的问题，但它们是两个不同的技术手段，两者又存在联系。</p>
<p>熔断：</p>
<p>当下游服务异常而断开与上游服务的交互，它就相当于保险丝，下游服务异常触发了熔断，从而保证上游服务不受影响。</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240229192808246.png" alt="image-20240229192808246"></p>
<p>降级：</p>
<p>当下游服务异常触发熔断后，上游服务就不再去调用异常的微服务而是执行了降级处理逻辑，这个降级处理逻辑可以是本地一个单独的方法。</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240229192920699.png" alt="image-20240229192920699"></p>
<p>两者都是为了保护系统，熔断是当下游服务异常时一种保护系统的手段，降级是熔断后上游服务处理熔断的方法。</p>
<h3 id="hystrix"><a class="markdownIt-Anchor" href="#hystrix"></a> Hystrix</h3>
<p>项目使用<strong>Hystrix</strong>框架实现熔断、降级处理，在feign-dev.yaml中配置</p>
<h3 id="定义降级逻辑"><a class="markdownIt-Anchor" href="#定义降级逻辑"></a> 定义降级逻辑</h3>
<ol>
<li>fallback</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@FeignClient(value = "media-api",configuration = MultipartSupportConfig.class,fallback = MediaServiceClientFallback.class)</span></span><br><span class="line"><span class="meta">@RequestMapping("/media")</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MediaServiceClient</span>{</span><br><span class="line">    ...</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>定义时指定回调接口fallback</p>
<p>定义一个fallback类MediaServiceClientFallback，此类实现了MediaServiceClient接口。</p>
<p>第一种方法无法取出熔断所抛出的异常，第二种方法定义MediaServiceClientFallbackFactory 可以解决这个问题。</p>
<ol start="2">
<li>
<p>fallbackFactory</p>
<p>第二种方法在FeignClient中指定fallbackFactory ，如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@FeignClient(value = "media-api",configuration = MultipartSupportConfig.class,fallbackFactory = MediaServiceClientFallbackFactory.class)</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>​	降级处理逻辑：</p>
<p>​	返回一个null对象，上游服务请求接口得到一个null说明执行了降级处理。</p>
<p>​	测试：</p>
<p>​	停止媒资管理服务或人为制造异常观察是否执行降级逻辑。</p>
<p>fallbackFactory代码如下:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SearchServiceClientFallbackFactory</span> <span class="keyword">implements</span> <span class="title class_">FallbackFactory</span>&lt;SearchServiceClient&gt; {</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> SearchServiceClient <span class="title function_">create</span><span class="params">(Throwable throwable)</span> {</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SearchServiceClient</span>() {</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> Boolean <span class="title function_">add</span><span class="params">(CourseIndex courseIndex)</span> {</span><br><span class="line">                throwable.printStackTrace();</span><br><span class="line">                log.debug(<span class="string">"调用搜索发生熔断走降级方法,熔断异常:"</span>, throwable.getMessage());</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            }</span><br><span class="line">        };</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//生成课程静态化页面并上传至文件系统</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">generateCourseHtml</span><span class="params">(MqMessage mqMessage, <span class="type">long</span> courseId)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        log.info(<span class="string">"开始执行课程静态化任务,id:{}"</span>, mqMessage.getId());</span><br><span class="line">        <span class="type">Long</span> <span class="variable">taskId</span> <span class="operator">=</span> mqMessage.getId();</span><br><span class="line">        <span class="type">MqMessageService</span> <span class="variable">mqMessageService</span> <span class="operator">=</span> <span class="built_in">this</span>.getMqMessageService();</span><br><span class="line">        <span class="comment">//任务幂等性处理</span></span><br><span class="line">        <span class="comment">//取出当前阶段执行状态</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">stageOne</span> <span class="operator">=</span> mqMessageService.getStageOne(taskId);</span><br><span class="line">        <span class="keyword">if</span>(stageOne &gt; <span class="number">0</span>){</span><br><span class="line">            <span class="comment">//已经执行过了</span></span><br><span class="line">            log.info(<span class="string">"课程静态化完成,无需处理"</span>);</span><br><span class="line">            <span class="keyword">return</span> ;</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">//生成html页面</span></span><br><span class="line">        <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> coursePublishService.generateCourseHtml(courseId);</span><br><span class="line">        <span class="keyword">if</span>(file == <span class="literal">null</span>){</span><br><span class="line">            XueChengPlusException.cast(<span class="string">"生成课程静态化页面为空"</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">//上传到minio</span></span><br><span class="line">        coursePublishService.uploadCourseHtml(courseId,file);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//将任务状态设置为完成</span></span><br><span class="line">        mqMessageService.completedStageOne(taskId);</span><br><span class="line">    }</span><br></pre></td></tr></table></figure>
<p>生成静态页面部分完成</p>
<h1 id="课程搜索"><a class="markdownIt-Anchor" href="#课程搜索"></a> 课程搜索</h1>
<h2 id="模块介绍"><a class="markdownIt-Anchor" href="#模块介绍"></a> 模块介绍</h2>
<p>搜索功能是一个系统的重要功能，是信息查询的方式。课程搜索是课程展示的渠道，用户通过课程搜索找到课程信息，进一步去查看课程的详细信息，进行选课、支付、学习。</p>
<p>本项目的课程搜索支持全文检索技术，什么是全文检索？</p>
<p><a href="https://baike.baidu.com/item/%E5%85%A8%E6%96%87%E6%A3%80%E7%B4%A2/8028630?fromModule=lemma_inlink">全文检索</a>是指计算机索引程序通过扫描文章中的每一个词，对每一个词建立一个索引，指明该词在文章中出现的次数和位置，当用户查询时，检索程序就根据事先建立的索引进行查找，并将查找的结果反馈给用户的检索方式。这个过程类似于通过字典中的检索字表查字的过程。</p>
<p>全文检索可以简单理解为通过索引搜索文章。</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240301133145260.png" alt="image-20240301133145260"></p>
<p>全文检索的速度非常快，早期应用在搜索引擎技术中，比如：百度、google等，现在通常一些大型网站的搜索功能都是采用全文检索技术。</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240301133158004.png" alt="image-20240301133158004"></p>
<p>课程搜索也要将课程信息建立索引，在课程发布时建立课程索引，索引建立好用户可通过搜索网页去查询课程信息。</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240301110007796.png" alt="image-20240301110007796"></p>
<p>所以，课程搜索模块包括两部分：课程索引、课程搜索。</p>
<p>课程索引是将课程信息建立索引。</p>
<p>课程搜索是通过前端网页，通过关键字等条件去搜索课程。</p>
<h2 id="业务流程"><a class="markdownIt-Anchor" href="#业务流程"></a> 业务流程</h2>
<p>根据模块介绍的内容，课程搜索模块包括课程索引、课程搜索两部分。</p>
<p>1、课程索引</p>
<p>在课程发布操作执行后通过消息处理方式创建课程索引，如下图：</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240301133215694.png" alt="image-20240301133215694"></p>
<p>本项目使用elasticsearch作为索引及搜索服务。</p>
<p>2、课程搜索</p>
<p>课程索引创建完成，用户才可以通过前端搜索课程信息。</p>
<p>课程搜索可以从首页进入搜索页面。</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240301110126724.png" alt="image-20240301110126724"></p>
<p>下图是搜索界面，可以通过课程分类、课程难度等级等条件进行搜索。</p>
<h1 id="课程信息索引同步"><a class="markdownIt-Anchor" href="#课程信息索引同步"></a> 课程信息索引同步</h1>
<h3 id="1-针对实时性非常高的场景需要满足数据的及时同步可以同步调用或使用canal去实现"><a class="markdownIt-Anchor" href="#1-针对实时性非常高的场景需要满足数据的及时同步可以同步调用或使用canal去实现"></a> 1、针对实时性非常高的场景需要满足数据的及时同步，可以同步调用，或使用Canal去实现。</h3>
<p>1）同步调用即在向MySQL写数据后远程调用搜索服务的接口写入索引，此方法简单但是耦合代码太高。</p>
<p>2）可以使用一个中间的软件canal解决耦合性的问题，但存在学习与维护成本。</p>
<p>canal主要用途是基于 MySQL 数据库增量日志解析，并能提供增量数据订阅和消费，实现将MySQL的数据同步到消息队列、Elasticsearch、其它数据库等，应用场景十分丰富。</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240301133237230.png" alt="image-20240301133237230"></p>
<p>它的地址：</p>
<p>github地址：<a href="https://github.com/alibaba/canal">https://github.com/alibaba/canal</a></p>
<p>版本下载地址：<a href="https://github.com/alibaba/canal/releases">https://github.com/alibaba/canal/releases</a></p>
<p>文档地址：<a href="https://github.com/alibaba/canal/wiki/Docker-QuickStart">https://github.com/alibaba/canal/wiki/Docker-QuickStart</a></p>
<p>Canal基于mysql的binlog技术实现数据同步，什么是binlog，它是一个文件，二进制格式，记录了对数据库更新的SQL语句，向数据库写数据的同时向binlog文件里记录对应的sql语句。当数据库服务器发生了故障就可以使用binlog文件对数据库进行恢复。</p>
<p>所以，使用canal是需要开启mysql的binlog写入功能，Canal工作原理如下：</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240301133257781.png" alt="image-20240301133257781"></p>
<p>1、canal 模拟 MySQL slave 的交互协议，伪装自己为 MySQL slave ，向 MySQL master 发送dump</p>
<p>协议</p>
<p>2、MySQL master 收到 dump 请求，开始推送 binary log 给 slave (即 canal )</p>
<p>3、canal 解析 binary log 对象(原始为 byte 流)</p>
<p>详细使用Canal进行索引同步的步骤参考：Canal实现索引同步.pdf</p>
<h3 id="2-当索引同步的实时性要求不高时可用的技术比较多比如mq-logstash-任务调度等"><a class="markdownIt-Anchor" href="#2-当索引同步的实时性要求不高时可用的技术比较多比如mq-logstash-任务调度等"></a> 2、当索引同步的实时性要求不高时可用的技术比较多，比如：MQ、Logstash、任务调度等。</h3>
<p>MQ：向mysql写数据的时候向mq写入消息，搜索服务监听MQ，收到消息后写入索引。使用MQ的优势是代码解耦，但是需要处理消息可靠性的问题有一定的技术成本，做到消息可靠性需要做到生产者投递成功、消息持久化以及消费者消费成功三个方面，另外还要做好消息幂等性问题。</p>
<p>Logstash： 开源实时日志分析平台 ELK包括Elasticsearch、Kibana、Logstash，Logstash负责收集、解析和转换日志信息，可以实现MySQL与Elasticsearch之间的数据同步。也可以实现解耦合并且是官方推荐，但需要增加学习与维护成本。</p>
<p>任务调度：向mysql写数据的时候记录修改记录，开启一个定时任务根据修改记录将数据同步到Elasticsearch。</p>
<p>根据本项目的需求，课程发布后信息同步的实时性要求不高，从提交审核到发布成功一般两个工作日完成。综合比较以上技术方案本项目的索引同步技术使用任务调度的方法。</p>
<p>如下图：</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240301133312380.png" alt="image-20240301133312380"></p>
<p>1、课程发布向消息表插入记录。</p>
<p>2、由任务调度程序通过消息处理SDK对消息记录进行处理。</p>
<p>3、向elasticsearch索引中保存课程信息。</p>
<p>如何向向elasticsearch索引中保存课程信息？</p>
<p>执行流程如下：</p>
<p>由内容管理服务远程调用搜索服务添加课程信息索引，搜索服务再请求elasticsearch向课程索引中添加文档。</p>
<h1 id="认证授权"><a class="markdownIt-Anchor" href="#认证授权"></a> 认证授权</h1>
<p>截至目前，项目已经完成了课程发布功能，课程发布后用户通过在线学习页面点播视频进行学习。如何去记录学生的学习过程呢？要想掌握学生的学习情况就需要知道用户的身份信息，记录哪个用户在什么时间学习什么课程，如果用户要购买课程也需要知道用户的身份信息。所以，去管理学生的学习过程最基本的要实现用户的身份认证。</p>
<p>认证授权模块实现平台所有用户的身份认证与用户授权功能。</p>
<p>什么是用户身份认证？</p>
<p>​    用户身份认证即用户去访问系统资源时系统要求验证用户的身份信息，身份合法方可继续访问。常见的用户身份认证的表现形式有：用户名密码登录，微信扫码等方式。</p>
<p>项目包括学生、学习机构的老师、平台运营人员三类用户，不管哪一类用户在访问项目受保护资源时都需要进行身份认证。比如：发布课程操作，需要学习机构的老师首先登录系统成功，然后再执行发布课程操作。创建订单，需要学生用户首先登录系统，才可以创建订单。如下图：</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240301133354267.png" alt="image-20240301133354267"></p>
<p>什么是用户授权？</p>
<p>​    用户认证通过后去访问系统的资源，系统会判断用户是否拥有访问资源的权限，只允许访问有权限的系统资源，没有权限的资源将无法访问，这个过程叫用户授权。比如：用户去发布课程，系统首先进行用户身份认证，认证通过后继续判断用户是否有发布课程的权限，如果没有权限则拒绝继续访问系统，如果有权限则继续发布课程。如下图：</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240301133417716.png" alt="image-20240301133417716"></p>
<h2 id="业务流程-2"><a class="markdownIt-Anchor" href="#业务流程-2"></a> 业务流程</h2>
<h3 id="1统一认证"><a class="markdownIt-Anchor" href="#1统一认证"></a> 1.统一认证</h3>
<p>项目包括学生、学习机构的老师、平台运营人员三类用户，三类用户将使用统一的认证入口，如下图：</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240301133440646.png" alt="image-20240301133440646"></p>
<p>用户输入账号和密码提交认证，认证通过则继续操作。</p>
<p>项目由统一认证服务受理用户的认证请求，如下图：</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240301133544154.png" alt="image-20240301133544154"></p>
<p>认证通过由认证服务向给用户颁发令牌，相当于访问系统的通行证，用户拿着令牌去访问系统的资源。</p>
<h3 id="2单点登录"><a class="markdownIt-Anchor" href="#2单点登录"></a> 2.单点登录</h3>
<p>本项目基于微服务架构构建，微服务包括：内容管理服务、媒资管理服务、学习中心服务、系统管理服务等，为了提高用户体验性，用户只需要认证一次便可以在多个拥有访问权限的系统中访问，这个功能叫做单点登录。</p>
<p>引用百度百科：单点登录（Single Sign On），简称为 SSO，是目前比较流行的企业业务整合的解决方案之一。SSO的定义是在多个应用系统中，用户只需要登录一次就可以访问所有相互信任的应用系统。</p>
<p>如下图，用户只需要认证一次，便可以在多个拥有访问权限的系统中访问。</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240301133600353.png" alt="image-20240301133600353"></p>
<h3 id="3第三方认证"><a class="markdownIt-Anchor" href="#3第三方认证"></a> 3.第三方认证</h3>
<p>为了提高用户体验，很多网站有扫码登录的功能，如：微信扫码登录、QQ扫码登录等。扫码登录的好处是用户不用输入账号和密码，操作简便，另外一个好处就是有利于用户信息的共享，互联网的优势就是资源共享，用户也是一种资源，对于一个新网站如果让用户去注册是很困难的，如果提供了微信扫码登录将省去用户注册的成本，是一种非常有效的推广手段。</p>
<p>微信扫码登录其中的原理正是使用了第三方认证，如下图：</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240301133612279.png" alt="image-20240301133612279"></p>
<h1 id="spring-security-认证研究重点"><a class="markdownIt-Anchor" href="#spring-security-认证研究重点"></a> <strong>Spring Security</strong> <strong>认证研究</strong>(重点)</h1>
<h2 id="1-spring-security介绍"><a class="markdownIt-Anchor" href="#1-spring-security介绍"></a> 1. <strong>Spring Security</strong>介绍</h2>
<p>认证功能几乎是每个项目都要具备的功能，并且它与业务无关，市面上有很多认证框架，如：Apache Shiro、CAS、Spring Security等。由于本项目基于Spring Cloud技术构建，Spring Security是spring家族的一份子且和Spring Cloud集成的很好，所以本项目选用Spring Security作为认证服务的技术框架。</p>
<p>Spring Security 是一个功能强大且高度可定制的身份验证和访问控制框架，它是一个专注于为 Java 应用程序提供身份验证和授权的框架。</p>
<p>项目主页：<a href="https://spring.io/projects/spring-security">https://spring.io/projects/spring-security</a></p>
<p>Spring cloud Security： <a href="https://spring.io/projects/spring-cloud-security">https://spring.io/projects/spring-cloud-security</a></p>
<h2 id="2-认证授权入门"><a class="markdownIt-Anchor" href="#2-认证授权入门"></a> 2. <strong>认证授权入门</strong></h2>
<p><strong>maven</strong>依赖：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-oauth2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>启动auth项目后进入网站:<a href="http://localhost:63070/auth/r/r1">http://localhost:63070/auth/r/r1</a></p>
<p>有如下界面:</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240301130300278.png" alt="image-20240301130300278"></p>
<p>账号和密码是多少呢？下一步需要进行安全配置。</p>
<p>配置文件如下:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="meta">@EnableGlobalMethodSecurity(securedEnabled = true, prePostEnabled = true)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> {</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//配置用户信息服务</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> UserDetailsService <span class="title function_">userDetailsService</span><span class="params">()</span> {</span><br><span class="line">        <span class="comment">//这里配置用户信息,这里暂时使用这种方式将用户存储在内存中</span></span><br><span class="line">        <span class="type">InMemoryUserDetailsManager</span> <span class="variable">manager</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InMemoryUserDetailsManager</span>();</span><br><span class="line">        manager.createUser(User.withUsername(<span class="string">"zhangsan"</span>).password(<span class="string">"123"</span>).authorities(<span class="string">"p1"</span>).build());</span><br><span class="line">        manager.createUser(User.withUsername(<span class="string">"lisi"</span>).password(<span class="string">"456"</span>).authorities(<span class="string">"p2"</span>).build());</span><br><span class="line">        <span class="keyword">return</span> manager;</span><br><span class="line">    }</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> PasswordEncoder <span class="title function_">passwordEncoder</span><span class="params">()</span> {</span><br><span class="line">        <span class="comment">//        //密码为明文方式</span></span><br><span class="line">        <span class="keyword">return</span> NoOpPasswordEncoder.getInstance();</span><br><span class="line">        <span class="comment">//        return new BCryptPasswordEncoder();</span></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">//配置安全拦截机制</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        http</span><br><span class="line">            .authorizeRequests()</span><br><span class="line">            .antMatchers(<span class="string">"/r/**"</span>).authenticated()<span class="comment">//访问/r开始的请求需要认证通过</span></span><br><span class="line">            .anyRequest().permitAll()<span class="comment">//其它请求全部放行</span></span><br><span class="line">            .and()</span><br><span class="line">            .formLogin().successForwardUrl(<span class="string">"/login-success"</span>);<span class="comment">//登录成功跳转到/login-success</span></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>可以看到账号:zhangsan,密码:123</p>
<p>账号:lisi,密码:456</p>
<h3 id="认证授权测试"><a class="markdownIt-Anchor" href="#认证授权测试"></a> 认证授权测试</h3>
<p>用户认证通过去访问系统资源时spring security进行授权控制，判断用户是否有该资源的访问权限，如果有则继续访问，如果没有则拒绝访问。</p>
<p>下边测试授权功能：</p>
<p>1、配置用户拥有哪些权限。</p>
<p>在WebSecurityConfig类配置zhangsan拥有p1权限，lisi拥有p2权限。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> UserDetailsService <span class="title function_">userDetailsService</span><span class="params">()</span> {</span><br><span class="line">    <span class="comment">//这里配置用户信息,这里暂时使用这种方式将用户存储在内存中</span></span><br><span class="line">    <span class="type">InMemoryUserDetailsManager</span> <span class="variable">manager</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InMemoryUserDetailsManager</span>();</span><br><span class="line">    manager.createUser(User.withUsername(<span class="string">"zhangsan"</span>).password(<span class="string">"123"</span>).authorities(<span class="string">"p1"</span>).build());</span><br><span class="line">    manager.createUser(User.withUsername(<span class="string">"lisi"</span>).password(<span class="string">"456"</span>).authorities(<span class="string">"p2"</span>).build());</span><br><span class="line">    <span class="keyword">return</span> manager;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>2、指定资源与权限的关系。</p>
<p>什么是系统的资源？</p>
<p>比如：查询一个用户的信息，用户信息就是系统的资源，要访问资源需要通过URL，所以我们在controller中定义的每个http的接口就是访问资源的接口。</p>
<p>下边在controller中配置/r/r1需要p1权限，/r/r2需要p2权限。</p>
<p>hasAuthority('p1')表示拥有p1权限方可访问。</p>
<p>代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginController</span> {</span><br><span class="line">    <span class="meta">@RequestMapping("/r/r1")</span></span><br><span class="line">    <span class="meta">@PreAuthorize("hasAuthority('p1')")</span><span class="comment">//拥有p1权限方可访问</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">r1</span><span class="params">()</span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"访问r1资源"</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping("/r/r2")</span></span><br><span class="line">    <span class="meta">@PreAuthorize("hasAuthority('p2')")</span><span class="comment">//拥有p2权限方可访问</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">r2</span><span class="params">()</span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"访问r2资源"</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>当访问以/r/开头的url时会判断用户是否认证，如果没有认证则跳转到登录页面，如果已经认证则判断用户是否具有该URL的访问权限，如果具有该URL的访问权限则继续，否则拒绝访问。</p>
<p>例如：</p>
<p>访问/r/r1，使用zhangsan登录可以正常访问，因为在/r/r1的方法上指定了权限p1，zhangsan用户拥有权限p1,所以可以正常访问。</p>
<p>访问/r/r1，使用lisi登录则拒绝访问，由于lisi用户不具有权限p1需要拒绝访问</p>
<p>注意：如果访问上不加@PreAuthorize，此方法没有授权控制。</p>
<p>整理授权的过程见下图所示：</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240301133641903.png" alt="image-20240301133641903"></p>
<h3 id="工作原理"><a class="markdownIt-Anchor" href="#工作原理"></a> 工作原理</h3>
<p>通过测试认证和授权两个功能，我们了解了Spring Security的基本使用方法，下边了解它的工作流程。</p>
<p>Spring Security所解决的问题就是<strong>安全访问控制</strong>，而安全访问控制功能其实就是对所有进入系统的请求进行拦截，校验每个请求是否能够访问它所期望的资源。根据前边知识的学习，可以通过Filter或AOP等技术来实现，Spring Security对Web资源的保护是靠Filter实现的，所以从这个Filter来入手，逐步深入Spring Security原理。</p>
<p>​    当初始化Spring Security时，会创建一个名为SpringSecurityFilterChain的Servlet过滤器，类型为 org.springframework.security.web.FilterChainProxy，它实现了javax.servlet.Filter，因此外部的请求会经过此类，下图是Spring Security过虑器链结构图：</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240301133704312.png" alt="image-20240301133704312"></p>
<p>FilterChainProxy是一个代理，真正起作用的是FilterChainProxy中SecurityFilterChain所包含的各个Filter，同时这些Filter作为Bean被Spring管理，它们是Spring Security核心，各有各的职责，但他们并不直接处理用户的<strong>认证</strong>，也不直接处理用户的<strong>授权</strong>，而是把它们交给了认证管理器（AuthenticationManager）和决策管理器（AccessDecisionManager）进行处理。</p>
<p>spring Security功能的实现主要是由一系列过滤器链相互配合完成。</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240301133728055.png" alt="image-20240301133728055"></p>
<p>下面介绍过滤器链中主要的几个过滤器及其作用：</p>
<p><strong>SecurityContextPersistenceFilter</strong> 这个Filter是整个拦截过程的入口和出口（也就是第一个和最后一个拦截器），会在请求开始时从配置好的 SecurityContextRepository 中获取 SecurityContext，然后把它设置给 SecurityContextHolder。在请求完成后将 SecurityContextHolder 持有的 SecurityContext 再保存到配置好的 SecurityContextRepository，同时清除 securityContextHolder 所持有的 SecurityContext；</p>
<p><strong>UsernamePasswordAuthenticationFilter</strong> 用于处理来自表单提交的认证。该表单必须提供对应的用户名和密码，其内部还有登录成功或失败后进行处理的 AuthenticationSuccessHandler 和 AuthenticationFailureHandler，这些都可以根据需求做相关改变；</p>
<p><strong>FilterSecurityInterceptor</strong> 是用于保护web资源的，使用AccessDecisionManager对当前用户进行授权访问，前面已经详细介绍过了；</p>
<p><strong>ExceptionTranslationFilter</strong> 能够捕获来自 FilterChain 所有的异常，并进行处理。但是它只会处理两类异常：AuthenticationException 和 AccessDeniedException，其它的异常它会继续抛出。</p>
<p>Spring Security的执行流程如下：</p>
<pre class="mermaid">sequenceDiagram
	actor User
	User-&gt;&gt;+UsernamePasswordAuthenticationFilter: 1. 用户提交用户名,密码
	UsernamePasswordAuthenticationFilter-&gt;&gt;UsernamePasswordAuthenticationFilter: 2. 将请求信息封装为Authentication<br>实现类为UsernamePasswordAuthenticationToken
	UsernamePasswordAuthenticationFilter-&gt;&gt;AuthenticationManager: 3. 认证authenticate()
	AuthenticationManager-&gt;&gt;+DaoAuthenticationProvider: 4.委托认证authenticate()
	DaoAuthenticationProvider-&gt;&gt;+UserDetailsService: 5.获取用户信息loadUserByUsername()
	UserDetailsService-&gt;&gt;-DaoAuthenticationProvider: 6.返回UserDetails
	DaoAuthenticationProvider-&gt;&gt;DaoAuthenticationProvider: 7.通过PasswordEncoder对比UserDetails中的密码与Authentication中密码是否一致
	DaoAuthenticationProvider-&gt;&gt;-DaoAuthenticationProvider: 8.填充Authentication,如权限信息
	DaoAuthenticationProvider-&gt;&gt;UsernamePasswordAuthenticationFilter: 9.返回Authentication
	UsernamePasswordAuthenticationFilter-&gt;&gt;-SecurityContextHolder: 10.SecurityContextHolder.getContext().setAuthentication(…)方法将Authentication保存至安全上下文</pre>
<ol>
<li>用户提交用户名、密码被SecurityFilterChain中的UsernamePasswordAuthenticationFilter过滤器获取到，封装为请求Authentication，通常情况下是UsernamePasswordAuthenticationToken这个实现类。</li>
<li>然后过滤器将Authentication提交至认证管理器（AuthenticationManager）进行认证</li>
<li>认证成功后，AuthenticationManager身份管理器返回一个被填充满了信息的（包括上面提到的权限信息，身份信息，细节信息，但密码通常会被移除）Authentication实例。</li>
<li>SecurityContextHolder安全上下文容器将第3步填充了信息的Authentication，通过SecurityContextHolder.getContext().setAuthentication(…)方法，设置到其中。</li>
<li>可以看出AuthenticationManager接口（认证管理器）是认证相关的核心接口，也是发起认证的出发点，它的实现类为ProviderManager。而Spring Security支持多种认证方式，因此ProviderManager维护着一个List&lt;AuthenticationProvider&amp;gt列表，存放多种认证方式，最终实际的认证工作是由AuthenticationProvider完成的。咱们知道web表单的对应的AuthenticationProvider实现类为DaoAuthenticationProvider，它的内部又维护着一个UserDetailsService负责UserDetails的获取。最终AuthenticationProvider将UserDetails填充至Authentication。</li>
</ol>
<h2 id="3oauth2"><a class="markdownIt-Anchor" href="#3oauth2"></a> 3.OAuth2</h2>
<p><strong>OAuth2</strong>认证流程</p>
<p>在前边我们提到微信扫码认证，这是一种第三方认证的方式，这种认证方式是基于OAuth2协议实现，</p>
<p>OAUTH协议为用户资源的授权提供了一个安全的、开放而又简易的标准。同时，任何第三方都可以使用OAUTH认证服务，任何服务提供商都可以实现自身的OAUTH认证服务，因而OAUTH是开放的。业界提供了OAUTH的多种实现如PHP、JavaScript，Java，Ruby等各种语言开发包，大大节约了程序员的时间，因而OAUTH是简易的。互联网很多服务如Open API，很多大公司如Google，Yahoo，Microsoft等都提供了OAUTH认证服务，这些都足以说明OAUTH标准逐渐成为开放资源授权的标准。</p>
<p>​    Oauth协议目前发展到2.0版本，1.0版本过于复杂，2.0版本已得到广泛应用。</p>
<p>参考：<a href="https://baike.baidu.com/item/oAuth/7153134?fr=aladdin">https://baike.baidu.com/item/oAuth/7153134?fr=aladdin</a></p>
<p>Oauth协议：<a href="https://tools.ietf.org/html/rfc6749">https://tools.ietf.org/html/rfc6749</a></p>
<p>下边分析一个Oauth2认证的例子，黑马程序员网站使用微信认证扫码登录的过程：</p>
<pre class="mermaid">sequenceDiagram
	actor 用户
	用户-&gt;&gt;浏览器:通过浏览器访问网站
	浏览器-&gt;&gt;黑马程序员网站:进入网站
	浏览器-&gt;&gt;黑马程序员网站:打开扫码界面
	用户-&gt;&gt;微信认证服务:微信扫码
	微信认证服务-&gt;&gt;用户:授权页面
	用户-&gt;&gt;微信认证服务:用户同意
	微信认证服务-&gt;&gt;黑马程序员网站:下发授权码
	黑马程序员网站-&gt;&gt;微信认证服务:授权码申请令牌
	微信认证服务-&gt;&gt;黑马程序员网站:下发令牌
	黑马程序员网站-&gt;&gt;微信用户信息:携带令牌获取用户信息
	微信用户信息-&gt;&gt;黑马程序员网站:返回用户信息
	黑马程序员网站-&gt;&gt;浏览器:显示用户登录成功</pre>
<p>具体流程如下：</p>
<p>1、用户点击微信扫码</p>
<p>用户进入黑马程序的登录页面，点击微信的图标开打微信扫码界面。</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240301134223182.png" alt="image-20240301134223182"></p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240301134239105.png" alt="image-20240301134239105"></p>
<p>微信扫码的目的是通过微信认证登录黑马程序员官网，黑马程序员网站需要从微信获取当前用户的身份信息才会让当前用户在黑马网站登录成功。</p>
<p>现在搞清楚几个概念：</p>
<p>资源：用户信息，在微信中存储。</p>
<p>资源拥有者：用户是用户信息资源的拥有者。</p>
<p>认证服务：微信负责认证当前用户的身份，负责为客户端颁发令牌。</p>
<p>客户端：客户端会携带令牌请求微信获取用户信息，黑马程序员网站即客户端，黑马网站需要在浏览器打开。</p>
<p>2、用户授权黑马网站访问用户信息</p>
<p>资源拥有者扫描二维码表示资源拥有者请求微信进行认证，微信认证通过向用户手机返回授权页面，如下图：</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240301134312905.png" alt="image-20240301134312905"></p>
<p>询问用户是否授权黑马程序员访问自己在微信的用户信息，用户点击“确认登录”表示同意授权，微信认证服务器会颁发一个授权码给黑马程序员的网站。</p>
<p>只有资源拥有者同意微信才允许黑马网站访问资源。</p>
<p>3、黑马程序员的网站获取到授权码</p>
<p>4、携带授权码请求微信认证服务器申请令牌</p>
<p>此交互过程用户看不到。</p>
<p>5、微信认证服务器向黑马程序员的网站响应令牌</p>
<p>此交互过程用户看不到。</p>
<p>6、黑马程序员网站请求微信资源服务器获取资源即用户信息。</p>
<p>黑马程序员网站携带令牌请求访问微信服务器获取用户的基本信息。</p>
<p>7、资源服务器返回受保护资源即用户信息</p>
<p>8、黑马网站接收到用户信息，此时用户在黑马网站登录成功。</p>
<p>理解了微信扫码登录黑马网站的流程，接下来认识Oauth2.0的认证流程，如下：</p>
<p>引自Oauth2.0协议rfc6749 <a href="https://tools.ietf.org/html/rfc6749">https://tools.ietf.org/html/rfc6749</a></p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240301134442480.png" alt="image-20240301134442480"></p>
<p>Oauth2包括以下角色：</p>
<p>1、客户端</p>
<p>本身不存储资源，需要通过资源拥有者的授权去请求资源服务器的资源，比如：手机客户端、浏览器等。</p>
<p>上边示例中黑马网站即为客户端，它需要通过浏览器打开。</p>
<p>2、资源拥有者</p>
<p>通常为用户，也可以是应用程序，即该资源的拥有者。</p>
<p>A表示 客户端请求资源拥有者授权。</p>
<p>B表示 资源拥有者授权客户端即黑马网站访问自己的用户信息。</p>
<p>3、授权服务器（也称认证服务器）</p>
<p>认证服务器对资源拥有者进行认证，还会对客户端进行认证并颁发令牌。</p>
<p>C 客户端即黑马网站携带授权码请求认证。</p>
<p>D 认证通过颁发令牌。</p>
<p>4、资源服务器</p>
<p>存储资源的服务器。</p>
<p>E 表示客户端即黑马网站携带令牌请求资源服务器获取资源。</p>
<p>F 表示资源服务器校验令牌通过后提供受保护资源。</p>
<h3 id="oauth2在本项目的应用"><a class="markdownIt-Anchor" href="#oauth2在本项目的应用"></a> <strong>OAuth2</strong>在本项目的应用</h3>
<p>Oauth2是一个标准的开放的授权协议，应用程序可以根据自己的要求去使用Oauth2，本项目使用Oauth2实现如下目标：</p>
<p>1、学成在线访问第三方系统的资源。</p>
<p>本项目要接入微信扫码登录所以本项目要使用OAuth2协议访问微信中的用户信息。</p>
<p>2、外部系统访问学成在线的资源 。</p>
<p>同样当第三方系统想要访问学成在线网站的资源也可以基于OAuth2协议。</p>
<p>3、学成在线前端（客户端） 访问学成在线微服务的资源。</p>
<p>本项目是前后端分离架构，前端访问微服务资源也可以基于OAuth2协议进行认证。</p>
<h3 id="oauth2的授权模式"><a class="markdownIt-Anchor" href="#oauth2的授权模式"></a> <strong>OAuth2</strong>的授权模式</h3>
<p>Spring Security支持OAuth2认证，OAuth2提供授权码模式、密码模式、简化模式、客户端模式等四种授权模式，前边举的微信扫码登录的例子就是基于授权码模式，这四种模式中授权码模式和密码模式应用较多，本节使用Spring Security演示授权码模式、密码模式，其余两种请自行查阅相关资料。</p>
<h4 id="授权码模式"><a class="markdownIt-Anchor" href="#授权码模式"></a> <strong>授权码模式</strong></h4>
<p>OAuth2的几个授权模式是根据不同的应用场景以不同的方式去获取令牌，最终目的是要获取认证服务颁发的令牌，最终通过令牌去获取资源。</p>
<p>授权码模式简单理解是使用授权码去获取令牌，要想获取令牌先要获取授权码，授权码的获取需要资源拥有者亲自授权同意才可以获取。</p>
<p>下图是授权码模式的交互图：</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240301134756575.png" alt="image-20240301134756575"></p>
<p>要想测试授权模式首先要配置授权服务器即上图中的认证服务器，需要配置授权服务及令牌策略。</p>
<p>1、从课程资料中拷贝 AuthorizationServer.java、TokenConfig.java到认证服务的config包下。</p>
<p>说明“：AuthorizationServer用 @EnableAuthorizationServer 注解标识并继承AuthorizationServerConfigurerAdapter来配置OAuth2.0 授权服务器。</p>
<p>在WebSecurityConfig配置认证管理bean</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> AuthenticationManager <span class="title function_">authenticationManagerBean</span><span class="params">()</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">super</span>.authenticationManagerBean();</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>重启认证服务</p>
<p>1、get请求获取授权码</p>
<p>地址: <a href="http://localhost:63070/auth/oauth/authorize?client_id=XcWebApp&amp;response_type=code&amp;scope=all&amp;redirect_uri=http://www.51xuecheng.cn">http://localhost:63070/auth/oauth/authorize?client_id=XcWebApp&amp;response_type=code&amp;scope=all&amp;redirect_uri=http://www.51xuecheng.cn</a></p>
<p>参数列表如下：</p>
<p>•     client_id：客户端准入标识。</p>
<p>•     response_type：授权码模式固定为code。</p>
<p>•     scope：客户端权限。</p>
<p>•     redirect_uri：跳转uri，当授权码申请成功后会跳转到此地址，并在后边带上code参数（授权码）。</p>
<p>输入账号zhangsan、密码123登录成功，输入localhost:63070/auth/oauth/authorizeclient_id=XcWebApp&amp;response_type=code&amp;scope=all&amp;redirect_uri=http://www.51xuecheng.cn</p>
<p>注意登录后才能进入这个页面</p>
<p>显示授权页面</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240301135523863.png" alt="image-20240301135523863"></p>
<p>授权“XcWebApp”访问自己的受保护资源?</p>
<p>选择同意。</p>
<p>2、请求成功，重定向至http://www.51xuecheng.cn/?code=授权码，比如：<a href="http://www.51xuecheng.cn/?code=Wqjb5H">http://www.51xuecheng.cn/?code=Wqjb5H</a></p>
<p>3、使用httpclient工具post申请令牌</p>
<p>/oauth/token?client_id=XcWebApp&amp;client_secret=XcWebApp&amp;grant_type=authorization_code&amp;code=授权码&amp;redirect_uri=http://www.51xuecheng.cn/</p>
<p>参数列表如下</p>
<p>•     client_id：客户端准入标识。</p>
<p>•     client_secret：客户端秘钥。</p>
<p>•     grant_type：授权类型，填写authorization_code，表示授权码模式</p>
<p>•     code：授权码，就是刚刚获取的授权码，注意：授权码只使用一次就无效了，需要重新申请。</p>
<p>•     redirect_uri：申请授权码时的跳转url，一定和申请授权码时用的redirect_uri一致。</p>
<p>httpclient脚本如下：</p>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line">### 授权码模式</span><br><span class="line">### 第一步申请授权码(浏览器请求)/oauth/authorize?client_id=c1&amp;response_type=code&amp;scope=all&amp;redirect_uri=http://www.51xuecheng.cn</span><br><span class="line">### 第二步申请令牌</span><br><span class="line">POST {{auth_host}}/auth/oauth/token?client_id=XcWebApp&amp;client_secret=XcWebApp&amp;grant_type=authorization_code&amp;code=a1s5mu&amp;redirect_uri=http://www.51xuecheng.cn</span><br></pre></td></tr></table></figure>
<p>成功后返回结果如下:</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">{</span></span><br><span class="line">  <span class="attr">"access_token"</span><span class="punctuation">:</span> <span class="string">"69abe6b8-7fe3-43d1-bfeb-7701a6fce80d"</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">"token_type"</span><span class="punctuation">:</span> <span class="string">"bearer"</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">"refresh_token"</span><span class="punctuation">:</span> <span class="string">"c6e06588-1b0a-4a3c-9c40-e3111fc8c1f8"</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">"expires_in"</span><span class="punctuation">:</span> <span class="number">7199</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">"scope"</span><span class="punctuation">:</span> <span class="string">"all"</span></span><br><span class="line"><span class="punctuation">}</span></span><br></pre></td></tr></table></figure>
<p>说明“：AuthorizationServer用 @EnableAuthorizationServer 注解标识并继承AuthorizationServerConfigurerAdapter来配置OAuth2.0 授权服务器。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableAuthorizationServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AuthorizationServer</span> <span class="keyword">extends</span> <span class="title class_">AuthorizationServerConfigurerAdapter</span> {...}</span><br></pre></td></tr></table></figure>
<p>AuthorizationServerConfigurerAdapter要求配置以下几个类：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AuthorizationServerConfigurerAdapter</span> <span class="keyword">implements</span> <span class="title class_">AuthorizationServerConfigurer</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">AuthorizationServerConfigurerAdapter</span><span class="params">()</span> {}</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthorizationServerSecurityConfigurer security)</span> <span class="keyword">throws</span> Exception {}</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(ClientDetailsServiceConfigurer clients)</span> <span class="keyword">throws</span> Exception {}</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthorizationServerEndpointsConfigurer endpoints)</span> <span class="keyword">throws</span> Exception {}</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p><strong>1</strong>)ClientDetailsServiceConfigurer：用来配置客户端详情服务（ClientDetailsService），</p>
<p>随便一个客户端都可以随便接入到它的认证服务吗？答案是否定的，服务提供商会给批准接入的客户端一个身份，用于接入时的凭据，有客户端标识和客户端秘钥，在这里配置批准接入的客户端的详细信息。</p>
<p><strong>2</strong>)AuthorizationServerEndpointsConfigurer：用来配置令牌（token）的访问端点和令牌服务(token services)。</p>
<p><strong>3</strong>)AuthorizationServerSecurityConfigurer：用来配置令牌端点的安全约束.</p>
<ol start="2">
<li><strong>TokenConfig</strong>为令牌策略配置类</li>
</ol>
<p>暂时先使用InMemoryTokenStore在内存存储令牌，令牌的有效期等信息配置如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//令牌管理服务</span></span><br><span class="line"><span class="meta">@Bean(name="authorizationServerTokenServicesCustom")</span></span><br><span class="line"><span class="keyword">public</span> AuthorizationServerTokenServices <span class="title function_">tokenService</span><span class="params">()</span> {</span><br><span class="line">    DefaultTokenServices service=<span class="keyword">new</span> <span class="title class_">DefaultTokenServices</span>();</span><br><span class="line">    service.setSupportRefreshToken(<span class="literal">true</span>);<span class="comment">//支持刷新令牌</span></span><br><span class="line">    service.setTokenStore(tokenStore);<span class="comment">//令牌存储策略</span></span><br><span class="line">    service.setAccessTokenValiditySeconds(<span class="number">7200</span>); <span class="comment">// 令牌默认有效期2小时</span></span><br><span class="line">    service.setRefreshTokenValiditySeconds(<span class="number">259200</span>); <span class="comment">// 刷新令牌默认有效期3天</span></span><br><span class="line">    <span class="keyword">return</span> service;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h4 id="密码模式"><a class="markdownIt-Anchor" href="#密码模式"></a> <strong>密码模式</strong></h4>
<p>密码模式相对授权码模式简单，授权码模式需要借助浏览器供用户亲自授权，密码模式不用借助浏览器，如下图：</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240301141024801.png" alt="image-20240301141024801"></p>
<p>1、资源拥有者提供账号和密码</p>
<p>2、客户端向认证服务申请令牌，请求中携带账号和密码</p>
<p>3、认证服务校验账号和密码正确颁发令牌。</p>
<p>开始测试：</p>
<p>1、POST请求获取令牌</p>
<p>/oauth/token?client_id=XcWebApp&amp;client_secret=XcWebApp&amp;grant_type=password&amp;username=shangsan&amp;password=123</p>
<p>参数列表如下：</p>
<p>•     client_id：客户端准入标识。</p>
<p>•     client_secret：客户端秘钥。</p>
<p>•     grant_type：授权类型，填写password表示密码模式</p>
<p>•     username：资源拥有者用户名。</p>
<p>•     password：资源拥有者密码。</p>
<p>2、授权服务器将令牌（access_token）发送给client</p>
<p>使用httpclient进行测试</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">POST {{auth_host}}/auth/oauth/token?client_id=XcWebApp&amp;client_secret=XcWebApp&amp;grant_type=password&amp;username=zhangsan&amp;password=123</span><br></pre></td></tr></table></figure>
<p>返回：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">{</span></span><br><span class="line">  <span class="attr">"access_token"</span><span class="punctuation">:</span> <span class="string">"69abe6b8-7fe3-43d1-bfeb-7701a6fce80d"</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">"token_type"</span><span class="punctuation">:</span> <span class="string">"bearer"</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">"refresh_token"</span><span class="punctuation">:</span> <span class="string">"c6e06588-1b0a-4a3c-9c40-e3111fc8c1f8"</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">"expires_in"</span><span class="punctuation">:</span> <span class="number">6770</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">"scope"</span><span class="punctuation">:</span> <span class="string">"all"</span></span><br><span class="line"><span class="punctuation">}</span></span><br></pre></td></tr></table></figure>
<p>这种模式十分简单，但是却意味着直接将用户敏感信息泄漏给了client，因此这就说明这种模式只能用于client是我们自己开发的情况下。</p>
]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>学习</tag>
        <tag>后端</tag>
        <tag>黑马程序员</tag>
        <tag>学成在线</tag>
      </tags>
  </entry>
  <entry>
    <title>学成在线Day10</title>
    <url>/2024/03/21/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFDay10/</url>
    <content><![CDATA[<h1 id="jwt"><a class="markdownIt-Anchor" href="#jwt"></a> JWT</h1>
<h2 id="普通令牌的问题"><a class="markdownIt-Anchor" href="#普通令牌的问题"></a> 普通令牌的问题</h2>
<p>客户端申请到令牌，接下来客户端携带令牌去访问资源，</p>
<p>到资源服务器将会校验令牌的合法性。</p>
<p>资源服务器如何校验令牌的合法性？</p>
<p>我们以OAuth2的密码模式为例进行说明：</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240301171801030.png" alt="image-20240301171801030"></p>
<p>从第4步开始说明：</p>
<p>1、客户端携带令牌访问资源服务获取资源。</p>
<p>2、资源服务远程请求认证服务校验令牌的合法性</p>
<p>3、如果令牌合法资源服务向客户端返回资源。</p>
<p>这里存在一个问题：</p>
<p>就是校验令牌需要远程请求认证服务，客户端的每次访问都会远程校验，执行性能低。</p>
<p>如果能够让资源服务自己校验令牌的合法性将省去远程请求认证服务的成本，提高了性能。如下图：</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240301171855970.png" alt="image-20240301171855970"></p>
<p>如何解决上边的问题，实现资源服务自行校验令牌。</p>
<p>令牌采用JWT格式即可解决上边的问题，用户认证通过后会得到一个JWT令牌，JWT令牌中已经包括了用户相关的信息，客户端只需要携带JWT访问资源服务，资源服务根据事先约定的算法自行完成令牌校验，无需每次都请求认证服务完成授权。</p>
<h2 id="什么是jwt"><a class="markdownIt-Anchor" href="#什么是jwt"></a> 什么是JWT</h2>
<p>JSON Web Token（JWT）是一种使用JSON格式传递数据的网络令牌技术，它是一个开放的行业标准（RFC 7519），它定义了一种简洁的、自包含的协议格式，用于在通信双方传递json对象，传递的信息经过数字签名可以被验证和信任，它可以使用HMAC算法或使用RSA的公钥/私钥对来签名，防止内容篡改。官网：<a href="https://jwt.io/">https://jwt.io/</a></p>
<p>使用JWT可以实现无状态认证。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TokenConfig</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">SIGNING_KEY</span> <span class="operator">=</span> <span class="string">"mq123"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    TokenStore tokenStore;</span><br><span class="line"></span><br><span class="line"><span class="comment">//    @Bean</span></span><br><span class="line"><span class="comment">//    public TokenStore tokenStore() {</span></span><br><span class="line"><span class="comment">//        //使用内存存储令牌（普通令牌）</span></span><br><span class="line"><span class="comment">//        return new InMemoryTokenStore();</span></span><br><span class="line"><span class="comment">//    }</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JwtAccessTokenConverter accessTokenConverter;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> TokenStore <span class="title function_">tokenStore</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">JwtTokenStore</span>(accessTokenConverter());</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> JwtAccessTokenConverter <span class="title function_">accessTokenConverter</span><span class="params">()</span> {</span><br><span class="line">        <span class="type">JwtAccessTokenConverter</span> <span class="variable">converter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JwtAccessTokenConverter</span>();</span><br><span class="line">        converter.setSigningKey(SIGNING_KEY);</span><br><span class="line">        <span class="keyword">return</span> converter;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">//令牌管理服务</span></span><br><span class="line">    <span class="meta">@Bean(name="authorizationServerTokenServicesCustom")</span></span><br><span class="line">    <span class="keyword">public</span> AuthorizationServerTokenServices <span class="title function_">tokenService</span><span class="params">()</span> {</span><br><span class="line">        DefaultTokenServices service=<span class="keyword">new</span> <span class="title class_">DefaultTokenServices</span>();</span><br><span class="line">        service.setSupportRefreshToken(<span class="literal">true</span>);<span class="comment">//支持刷新令牌</span></span><br><span class="line">        service.setTokenStore(tokenStore);<span class="comment">//令牌存储策略</span></span><br><span class="line"></span><br><span class="line">        <span class="type">TokenEnhancerChain</span> <span class="variable">tokenEnhancerChain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TokenEnhancerChain</span>();</span><br><span class="line">        tokenEnhancerChain.setTokenEnhancers(Arrays.asList(accessTokenConverter));</span><br><span class="line">        service.setTokenEnhancer(tokenEnhancerChain);</span><br><span class="line"></span><br><span class="line">        service.setAccessTokenValiditySeconds(<span class="number">7200</span>); <span class="comment">// 令牌默认有效期2小时</span></span><br><span class="line">        service.setRefreshTokenValiditySeconds(<span class="number">259200</span>); <span class="comment">// 刷新令牌默认有效期3天</span></span><br><span class="line">        <span class="keyword">return</span> service;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>申请令牌http测试：</p>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line">POST {{auth_host}}/oauth/token?client_id=XcWebApp&amp;client_secret=XcWebApp&amp;grant_type=password&amp;username=zhangsan&amp;password=123</span><br></pre></td></tr></table></figure>
<h2 id="测试资源服务校验令牌"><a class="markdownIt-Anchor" href="#测试资源服务校验令牌"></a> 测试资源服务校验令牌</h2>
<p>拿到了jwt令牌下一步就要携带令牌去访问资源服务中的资源，本项目各个微服务就是资源服务</p>
<p>在内容管理服务的content-api工程中添加依赖</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-oauth2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>http请求携带jwt令牌访问课程信息</p>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="attribute">Authorization</span><span class="punctuation">: </span>Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOlsi...</span><br></pre></td></tr></table></figure>
<p>注意<code>Authorization: Bearer</code>是规定用来校验的字段，jwt令牌过长结尾省略</p>
<h2 id="测试获取用户身份"><a class="markdownIt-Anchor" href="#测试获取用户身份"></a> 测试获取用户身份</h2>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@ApiOperation("根据课程id查询课程基础信息")</span></span><br><span class="line"><span class="meta">@GetMapping("/course/{courseId}")</span></span><br><span class="line"><span class="keyword">public</span> CourseBaseInfoDto <span class="title function_">getCourseBaseById</span><span class="params">(<span class="meta">@PathVariable("courseId")</span> Long courseId)</span>{</span><br><span class="line">    <span class="comment">//取出当前用户身份</span></span><br><span class="line">    <span class="comment">//SecurityContextHolder底层就是ThreadLocal</span></span><br><span class="line">    <span class="type">Object</span> <span class="variable">principal</span> <span class="operator">=</span> SecurityContextHolder.getContext().getAuthentication().getPrincipal();</span><br><span class="line">    System.out.println(principal);</span><br><span class="line">    <span class="keyword">return</span> courseBaseInfoService.getCourseBaseInfo(courseId);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h1 id="网关认证"><a class="markdownIt-Anchor" href="#网关认证"></a> 网关认证</h1>
<h2 id="技术方案"><a class="markdownIt-Anchor" href="#技术方案"></a> 技术方案</h2>
<p>到目前为止，测试通过了认证服务颁发jwt令牌，客户端携带jwt访问资源服务，资源服务对jwt的合法性进行验证。如下图：</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240301180738561.png" alt="image-20240301180738561"></p>
<p>仔细观察此图，遗漏了本项目架构中非常重要的组件：网关，加上网关并完善后如下图所示：</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240301180755266.png" alt="image-20240301180755266"></p>
<p>所有访问微服务的请求都要经过网关，在网关进行用户身份的认证可以将很多非法的请求拦截到微服务以外，这叫做网关认证。</p>
<p>下边需要明确网关的职责：</p>
<p>1、网站白名单维护</p>
<p>针对不用认证的URL全部放行。</p>
<p>2、校验jwt的合法性。</p>
<p>除了白名单剩下的就是需要认证的请求，网关需要验证jwt的合法性，jwt合法则说明用户身份合法，否则说明身份不合法则拒绝继续访问。</p>
<p>网关负责授权吗？</p>
<p>网关不负责授权，对请求的授权操作在各个微服务进行，因为微服务最清楚用户有哪些权限访问哪些接口。</p>
<h2 id="实现网关认证"><a class="markdownIt-Anchor" href="#实现网关认证"></a> 实现网关认证</h2>
<p>实现以下职责：</p>
<p>1、网站白名单维护</p>
<p>针对不用认证的URL全部放行。</p>
<p>2、校验jwt的合法性。</p>
<p>除了白名单剩下的就是需要认证的请求，网关需要验证jwt的合法性，jwt合法则说明用户身份合法，否则说明身份不合法则拒绝继续访问。</p>
<p>网关工程依赖：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-oauth2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>配置白名单文件security-whitelist.properties</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 后续记得关闭</span></span><br><span class="line"><span class="attr">/**</span>=<span class="string">临时全部放行</span></span><br><span class="line"><span class="attr">/auth/**</span>=<span class="string">认证地址</span></span><br><span class="line"><span class="attr">/content/open/**</span>=<span class="string">内容管理公开访问接口</span></span><br><span class="line"><span class="attr">/media/open/**</span>=<span class="string">媒资管理公开访问接口</span></span><br></pre></td></tr></table></figure>
<p>导入了四个文件，其中最重要的的是GatewayAuthFilter</p>
<p>其内部过滤器比较重要</p>
<p>过滤器代码</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.gateway.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.gateway.filter.GatewayFilterChain;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.gateway.filter.GlobalFilter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.Ordered;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.io.buffer.DataBuffer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpStatus;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.server.reactive.ServerHttpResponse;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.common.OAuth2AccessToken;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.common.exceptions.InvalidTokenException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.token.TokenStore;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.AntPathMatcher;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.server.ServerWebExchange;</span><br><span class="line"><span class="keyword">import</span> reactor.core.publisher.Mono;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.nio.charset.StandardCharsets;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 网关认证过虑器</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/27 12:10</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GatewayAuthFilter</span> <span class="keyword">implements</span> <span class="title class_">GlobalFilter</span>, Ordered {</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//白名单</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> List&lt;String&gt; whitelist = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> {</span><br><span class="line">        <span class="comment">//加载白名单</span></span><br><span class="line">        <span class="keyword">try</span> (</span><br><span class="line">                <span class="type">InputStream</span> <span class="variable">resourceAsStream</span> <span class="operator">=</span> GatewayAuthFilter.class.getResourceAsStream(<span class="string">"/security-whitelist.properties"</span>);</span><br><span class="line">        ) {</span><br><span class="line">            <span class="type">Properties</span> <span class="variable">properties</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Properties</span>();</span><br><span class="line">            properties.load(resourceAsStream);</span><br><span class="line">            Set&lt;String&gt; strings = properties.stringPropertyNames();</span><br><span class="line">            whitelist = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(strings);</span><br><span class="line"></span><br><span class="line">        } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">            log.error(<span class="string">"加载/security-whitelist.properties出错:{}"</span>, e.getMessage());</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> TokenStore tokenStore;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//认证过滤器</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;Void&gt; <span class="title function_">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> {</span><br><span class="line">        <span class="type">String</span> <span class="variable">requestUrl</span> <span class="operator">=</span> exchange.getRequest().getPath().value();</span><br><span class="line">        <span class="type">AntPathMatcher</span> <span class="variable">pathMatcher</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AntPathMatcher</span>();</span><br><span class="line">        <span class="comment">//白名单放行</span></span><br><span class="line">        <span class="keyword">for</span> ( String url : whitelist ) {</span><br><span class="line">            <span class="keyword">if</span> ( pathMatcher.match(url, requestUrl) ) {</span><br><span class="line">                <span class="keyword">return</span> chain.filter(exchange);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">//检查token是否存在</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> getToken(exchange);</span><br><span class="line">        <span class="keyword">if</span> ( StringUtils.isBlank(token) ) {</span><br><span class="line">            <span class="keyword">return</span> buildReturnMono(<span class="string">"没有认证"</span>, exchange);</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">//判断是否是有效的token</span></span><br><span class="line">        OAuth2AccessToken oAuth2AccessToken;</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            oAuth2AccessToken = tokenStore.readAccessToken(token);</span><br><span class="line"></span><br><span class="line">            <span class="type">boolean</span> <span class="variable">expired</span> <span class="operator">=</span> oAuth2AccessToken.isExpired();</span><br><span class="line">            <span class="keyword">if</span> ( expired ) {</span><br><span class="line">                <span class="keyword">return</span> buildReturnMono(<span class="string">"认证令牌已过期"</span>, exchange);</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">return</span> chain.filter(exchange);</span><br><span class="line">        } <span class="keyword">catch</span> (InvalidTokenException e) {</span><br><span class="line">            log.info(<span class="string">"认证令牌无效: {}"</span>, token);</span><br><span class="line">            <span class="keyword">return</span> buildReturnMono(<span class="string">"认证令牌无效"</span>, exchange);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取token</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">getToken</span><span class="params">(ServerWebExchange exchange)</span> {</span><br><span class="line">        <span class="type">String</span> <span class="variable">tokenStr</span> <span class="operator">=</span> exchange.getRequest().getHeaders().getFirst(<span class="string">"Authorization"</span>);</span><br><span class="line">        <span class="keyword">if</span> ( StringUtils.isBlank(tokenStr) ) {</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> tokenStr.split(<span class="string">" "</span>)[<span class="number">1</span>];</span><br><span class="line">        <span class="keyword">if</span> ( StringUtils.isBlank(token) ) {</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> token;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Mono&lt;Void&gt; <span class="title function_">buildReturnMono</span><span class="params">(String error, ServerWebExchange exchange)</span> {</span><br><span class="line">        <span class="type">ServerHttpResponse</span> <span class="variable">response</span> <span class="operator">=</span> exchange.getResponse();</span><br><span class="line">        <span class="type">String</span> <span class="variable">jsonString</span> <span class="operator">=</span> JSON.toJSONString(<span class="keyword">new</span> <span class="title class_">RestErrorResponse</span>(error));</span><br><span class="line">        <span class="type">byte</span>[] bits = jsonString.getBytes(StandardCharsets.UTF_8);</span><br><span class="line">        <span class="type">DataBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> response.bufferFactory().wrap(bits);</span><br><span class="line">        response.setStatusCode(HttpStatus.UNAUTHORIZED);</span><br><span class="line">        response.getHeaders().add(<span class="string">"Content-Type"</span>, <span class="string">"application/json;charset=UTF-8"</span>);</span><br><span class="line">        <span class="keyword">return</span> response.writeWith(Mono.just(buffer));</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getOrder</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>网关的三个主要功能：</p>
<ol>
<li>提供路由功能</li>
<li>提供白名单</li>
<li>校验jwt<code>合法性</code></li>
</ol>
<h1 id="用户认证"><a class="markdownIt-Anchor" href="#用户认证"></a> 用户认证</h1>
<h2 id="需求分析"><a class="markdownIt-Anchor" href="#需求分析"></a> 需求分析</h2>
<p>至此我们了解了使用Spring Security进行认证授权的过程，本节实现用户认证功能。</p>
<p>目前各大网站的认证方式非常丰富：账号密码认证、手机验证码认证、扫码登录等。</p>
<p>本项目也要支持多种认证</p>
<h2 id="连接用户中心数据库"><a class="markdownIt-Anchor" href="#连接用户中心数据库"></a> 连接用户中心数据库</h2>
<h3 id="连接数据库认证"><a class="markdownIt-Anchor" href="#连接数据库认证"></a> 连接数据库认证</h3>
<p>基于的认证流程在研究Spring Security过程中已经测试通过，到目前为止用户认证流程如下：</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240302100509537.png" alt="image-20240302100509537"></p>
<p>认证所需要的用户信息存储在用户中心数据库，现在需要将认证服务连接数据库查询用户信息。</p>
<p>在研究Spring Security的过程中是将用户信息硬编码</p>
<p>我们要认证服务中连接用户中心数据库查询用户信息。</p>
<p>如何使用Spring Security连接数据库认证吗？</p>
<p>前边学习Spring Security工作原理时有一张执行流程图，如下图：</p>
<pre class="mermaid">sequenceDiagram
	actor User
	User-&gt;&gt;+UsernamePasswordAuthenticationFilter: 1. 用户提交用户名,密码
	UsernamePasswordAuthenticationFilter-&gt;&gt;UsernamePasswordAuthenticationFilter: 2. 将请求信息封装为Authentication<br>实现类为UsernamePasswordAuthenticationToken
	UsernamePasswordAuthenticationFilter-&gt;&gt;AuthenticationManager: 3. 认证authenticate()
	AuthenticationManager-&gt;&gt;+DaoAuthenticationProvider: 4.委托认证authenticate()
	DaoAuthenticationProvider-&gt;&gt;+UserDetailsService: 5.获取用户信息loadUserByUsername()
	UserDetailsService-&gt;&gt;-DaoAuthenticationProvider: 6.返回UserDetails
	DaoAuthenticationProvider-&gt;&gt;DaoAuthenticationProvider: 7.通过PasswordEncoder对比UserDetails中的密码与Authentication中密码是否一致
	DaoAuthenticationProvider-&gt;&gt;-DaoAuthenticationProvider: 8.填充Authentication,如权限信息
	DaoAuthenticationProvider-&gt;&gt;UsernamePasswordAuthenticationFilter: 9.返回Authentication
	UsernamePasswordAuthenticationFilter-&gt;&gt;-SecurityContextHolder: 10.SecurityContextHolder.getContext().setAuthentication(…)方法将Authentication保存至安全上下文</pre>
<p>用户提交账号和密码由DaoAuthenticationProvider调用UserDetailsService的loadUserByUsername()方法获取UserDetails用户信息。</p>
<p>UserDetailService是一个接口：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.springframework.security.core.userdetails;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserDetailsService</span> {</span><br><span class="line">    UserDetails <span class="title function_">loadUserByUsername</span><span class="params">(String var1)</span> <span class="keyword">throws</span> UsernameNotFoundException;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>UserDetails是用户信息接口:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserDetails</span> <span class="keyword">extends</span> <span class="title class_">Serializable</span> {</span><br><span class="line">    Collection&lt;? <span class="keyword">extends</span> <span class="title class_">GrantedAuthority</span>&gt; getAuthorities();</span><br><span class="line"></span><br><span class="line">    String <span class="title function_">getPassword</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    String <span class="title function_">getUsername</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">isAccountNonExpired</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">isAccountNonLocked</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">isCredentialsNonExpired</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">isEnabled</span><span class="params">()</span>;</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>我们只要实现UserDetailsService 接口查询数据库得到用户信息返回UserDetails 类型的用户信息即可,框架调用loadUserByUsername()方法拿到用户信息之后是如何执行的，见下图：</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240302103505430.png" alt="image-20240302103505430"></p>
<p>首先屏蔽原有的UserService</p>
<p>然后新建软件包写下如下内容:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">UserDetailsService</span> {</span><br><span class="line"></span><br><span class="line">    <span class="comment">//用户中心dao层</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    XcUserMapper xcUserMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> UserDetails <span class="title function_">loadUserByUsername</span><span class="params">(String s)</span> <span class="keyword">throws</span> UsernameNotFoundException {</span><br><span class="line">        <span class="comment">//查询数据库</span></span><br><span class="line">        <span class="type">XcUser</span> <span class="variable">xcUser</span> <span class="operator">=</span> xcUserMapper.selectOne(<span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;XcUser&gt;().eq(XcUser::getUsername, s));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//查询用户不存在,返回null即可,spring security同时抛出异常提示用户不存在</span></span><br><span class="line">        <span class="keyword">if</span> ( xcUser == <span class="literal">null</span> ) {</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">//如果查到了正确的用户拿到了正确的密码,返回UserDetails对象给spring security框架,由框架进行密码比对</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> xcUser.getPassword();</span><br><span class="line">        <span class="comment">//权限</span></span><br><span class="line">        String[] authorities = {<span class="string">"test"</span>};</span><br><span class="line">        <span class="type">UserDetails</span> <span class="variable">userDetails</span> <span class="operator">=</span> User</span><br><span class="line">            .builder()</span><br><span class="line">            .username(xcUser.getUsername())</span><br><span class="line">            .password(password)</span><br><span class="line">            .authorities(authorities).build();</span><br><span class="line">        <span class="keyword">return</span> userDetails;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>数据库中的密码加过密的，用户输入的密码是明文，我们需要修改密码格式器PasswordEncoder，原来使用的是NoOpPasswordEncoder，它是通过明文方式比较密码，现在我们修改为BCryptPasswordEncoder，它是将用户输入的密码编码为BCrypt格式与数据库中的密码进行比对。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        <span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> <span class="string">"123456"</span>;</span><br><span class="line">        <span class="type">PasswordEncoder</span> <span class="variable">passwordEncoder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BCryptPasswordEncoder</span>();</span><br><span class="line">        <span class="comment">//生成密码</span></span><br><span class="line">        <span class="keyword">for</span> ( <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">5</span>; i++ ) {</span><br><span class="line">            <span class="type">String</span> <span class="variable">encode</span> <span class="operator">=</span> passwordEncoder.encode(password);</span><br><span class="line">            System.out.println(encode);</span><br><span class="line">            System.out.println(passwordEncoder.matches(password, encode));</span><br><span class="line">        }</span><br><span class="line">    }</span><br></pre></td></tr></table></figure>
<p>修改数据库中的密码为Bcrypt格式，并且记录明文密码，稍后申请令牌时需要。</p>
<p>由于修改密码编码方式还需要将客户端的密钥更改为Bcrypt格式.</p>
<p>在AuthorizationServer中修改</p>
<h3 id="扩展用户身份信息"><a class="markdownIt-Anchor" href="#扩展用户身份信息"></a> <strong>扩展用户身份信息</strong></h3>
<p>我们需要扩展用户身份的信息，在jwt令牌中存储用户的昵称、头像、qq等信息。</p>
<p>如何扩展Spring Security的用户身份信息呢？</p>
<p>在认证阶段DaoAuthenticationProvider会调用UserDetailService查询用户的信息，这里是可以获取到齐全的用户信息的。由于JWT令牌中用户身份信息来源于UserDetails，UserDetails中仅定义了username为用户的身份信息，这里有两个思路：</p>
<ol>
<li>
<p>是可以扩展UserDetails，使之包括更多的自定义属性</p>
</li>
<li>
<p>也可以扩展username的内容 ，比如存入json数据内容作为username的内容。相比较而言，方案二比较简单还不用破坏UserDetails的结构，我们采用方案二。</p>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> UserDetails <span class="title function_">loadUserByUsername</span><span class="params">(String s)</span> <span class="keyword">throws</span> UsernameNotFoundException {</span><br><span class="line">    <span class="comment">//查询数据库</span></span><br><span class="line">    <span class="type">XcUser</span> <span class="variable">xcUser</span> <span class="operator">=</span> xcUserMapper.selectOne(<span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;XcUser&gt;().eq(XcUser::getUsername, s));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//查询用户不存在,返回null即可,spring security同时抛出异常提示用户不存在</span></span><br><span class="line">    <span class="keyword">if</span> ( xcUser == <span class="literal">null</span> ) {</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//如果查到了正确的用户拿到了正确的密码,返回UserDetails对象给spring security框架,由框架进行密码比对</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> xcUser.getPassword();</span><br><span class="line">    <span class="comment">//权限</span></span><br><span class="line">    String[] authorities = {<span class="string">"test"</span>};</span><br><span class="line">    xcUser.setPassword(<span class="literal">null</span>);</span><br><span class="line">    <span class="comment">//将用户信息转json</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">userJson</span> <span class="operator">=</span> JSON.toJSONString(xcUser);</span><br><span class="line">    <span class="type">UserDetails</span> <span class="variable">userDetails</span> <span class="operator">=</span> User</span><br><span class="line">        .builder()</span><br><span class="line">        .username(userJson)</span><br><span class="line">        .password(password)</span><br><span class="line">        .authorities(authorities).build();</span><br><span class="line">    <span class="keyword">return</span> userDetails;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>密码置空可以保证安全性</p>
<p>在资源服务中就可以通过<code>SecurityUtil</code>工具类获取用户信息</p>
<h2 id="支持认证方式多样化"><a class="markdownIt-Anchor" href="#支持认证方式多样化"></a> 支持认证方式多样化</h2>
<h3 id="统一认证入口"><a class="markdownIt-Anchor" href="#统一认证入口"></a> 统一认证入口</h3>
<p>目前各大网站的认证方式非常丰富：账号密码认证、手机验证码认证、扫码登录等。基于当前研究的Spring Security认证流程如何支持多样化的认证方式呢？</p>
<p>1、支持账号和密码认证</p>
<p>采用OAuth2协议的密码模式即可实现。</p>
<p>2、支持手机号加验证码认证</p>
<p>用户认证提交的是手机号和验证码，并不是账号和密码。</p>
<p>3、微信扫码认证</p>
<p>基于OAuth2协议与微信交互，学成在线网站向微信服务器申请到一个令牌，然后携带令牌去微信查询用户信息，查询成功则用户在学成在线项目认证通过。</p>
<p>目前我们测试通过OAuth2的密码模式，用户认证会提交账号和密码，由DaoAuthenticationProvider调用UserDetailsService的loadUserByUsername()方法获取UserDetails用户信息。</p>
<p>在前边我们自定义了UserDetailsService接口实现类，通过loadUserByUsername()方法根据账号查询用户信息。</p>
<p>而不同的认证方式提交的数据不一样，比如：手机加验证码方式会提交手机号和验证码，账号密码方式会提交账号、密码、验证码。</p>
<p>我们可以在loadUserByUsername()方法上作文章，将用户原来提交的账号数据改为提交json数据，json数据可以扩展不同认证方式所提交的各种参数。</p>
<p>首先创建一个DTO类表示认证的参数：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AuthParamsDto</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String username; <span class="comment">//用户名</span></span><br><span class="line">    <span class="keyword">private</span> String password; <span class="comment">//域  用于扩展</span></span><br><span class="line">    <span class="keyword">private</span> String cellphone;<span class="comment">//手机号</span></span><br><span class="line">    <span class="keyword">private</span> String checkcode;<span class="comment">//验证码</span></span><br><span class="line">    <span class="keyword">private</span> String checkcodekey;<span class="comment">//验证码key</span></span><br><span class="line">    <span class="keyword">private</span> String authType; <span class="comment">// 认证的类型   password:用户名密码模式类型    sms:短信模式类型</span></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, Object&gt; payload = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();<span class="comment">//附加数据，作为扩展，不同认证类型可拥有不同的附加数据。如认证类型为短信时包含smsKey : sms:3d21042d054548b08477142bbca95cfa; 所有情况下都包含clientId</span></span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>UserServiceImpl修改如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> UserDetails <span class="title function_">loadUserByUsername</span><span class="params">(String s)</span> <span class="keyword">throws</span> UsernameNotFoundException {</span><br><span class="line"></span><br><span class="line">    <span class="type">AuthParamsDto</span> <span class="variable">authParamsDto</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        <span class="comment">//将认证参数转为AuthParamsDto类型</span></span><br><span class="line">        authParamsDto = JSON.parseObject(s, AuthParamsDto.class);</span><br><span class="line">    } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">        log.info(<span class="string">"认证请求不符合项目要求:{}"</span>,s);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">"认证请求数据格式不对"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//账号</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> authParamsDto.getUsername();</span><br><span class="line">    <span class="type">XcUser</span> <span class="variable">user</span> <span class="operator">=</span> xcUserMapper.selectOne(<span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;XcUser&gt;().eq(XcUser::getUsername, username));</span><br><span class="line">    <span class="keyword">if</span>(user==<span class="literal">null</span>){</span><br><span class="line">        <span class="comment">//返回空表示用户不存在</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//取出数据库存储的正确密码</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">password</span>  <span class="operator">=</span>user.getPassword();</span><br><span class="line">    <span class="comment">//用户权限,如果不加报Cannot pass a null GrantedAuthority collection</span></span><br><span class="line">    String[] authorities = {<span class="string">"p1"</span>};</span><br><span class="line">    <span class="comment">//将user对象转json</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">userString</span> <span class="operator">=</span> JSON.toJSONString(user);</span><br><span class="line">    <span class="comment">//创建UserDetails对象</span></span><br><span class="line">    <span class="type">UserDetails</span> <span class="variable">userDetails</span> <span class="operator">=</span> User.withUsername(userString).password(password).authorities(authorities).build();</span><br><span class="line">    <span class="keyword">return</span> userDetails;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>原来的DaoAuthenticationProvider 会进行密码校验，现在重新定义DaoAuthenticationProviderCustom类，重写类的additionalAuthenticationChecks方法。因为有一些方式，比如<code>微信扫码</code>和<code>手机验证码</code><strong>不需要校验密码</strong>，所以我们自定义校验方式</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DaoAuthenticationProviderCustom</span> <span class="keyword">extends</span> <span class="title class_">DaoAuthenticationProvider</span> {</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setUserDetailsService</span><span class="params">(UserDetailsService userDetailsService)</span> {</span><br><span class="line">        <span class="built_in">super</span>.setUserDetailsService(userDetailsService);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//屏蔽密码对比</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">additionalAuthenticationChecks</span><span class="params">(UserDetails userDetails, UsernamePasswordAuthenticationToken authentication)</span> <span class="keyword">throws</span> AuthenticationException {</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>在WebSecurityConfig中注入DaoAuthenticationProviderCustom</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">DaoAuthenticationProviderCustom daoAuthenticationProviderCustom;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">    auth.authenticationProvider(daoAuthenticationProviderCustom);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>此时可以重启认证服务，测试申请令牌接口，传入的账号信息改为json数据，如下：</p>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line">################扩展认证请求参数后######################</span><br><span class="line">###密码模式</span><br><span class="line">POST {{auth_host}}/auth/oauth/token?client_id=XcWebApp&amp;client_secret=XcWebApp&amp;grant_type=password&amp;username={"username":"stu1","authType":"password","password":"111111"}</span><br></pre></td></tr></table></figure>
<p>定义统一认证接口</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">AuthService</span> {</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@description</span> 认证方法</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> authParamsDto 认证参数</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> com.xuecheng.ucenter.model.po.XcUser 用户信息</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@date</span> 2022/9/29 12:11</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    XcUserExt <span class="title function_">execute</span><span class="params">(AuthParamsDto authParamsDto)</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>定义账号密码认证接口：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service("password_authService")</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PasswordAuthServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">AuthService</span> {</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> XcUserExt <span class="title function_">execute</span><span class="params">(AuthParamsDto authParamsDto)</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>定义微信扫码认证接口：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service("wx_authService")</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WxAuthServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">AuthService</span> {</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> XcUserExt <span class="title function_">execute</span><span class="params">(AuthParamsDto authParamsDto)</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h3 id="实现账号密码认证"><a class="markdownIt-Anchor" href="#实现账号密码认证"></a> 实现账号密码认证</h3>
<p>账号密码实现类代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service("password_authService")</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PasswordAuthServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">AuthService</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    XcUserMapper xcUserMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    PasswordEncoder passwordEncoder;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    CheckCodeClient checkCodeClient;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> XcUserExt <span class="title function_">execute</span><span class="params">(AuthParamsDto authParamsDto)</span> {</span><br><span class="line">        <span class="comment">//账号</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> authParamsDto.getUsername();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//远程调用验证码校验接口认证服务</span></span><br><span class="line">        <span class="comment">//校验验证码todo</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//查询数据库</span></span><br><span class="line">        <span class="type">XcUser</span> <span class="variable">xcUser</span> <span class="operator">=</span> xcUserMapper.selectOne(<span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;XcUser&gt;().eq(XcUser::getUsername, username));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//查询用户不存在,返回null即可,spring security同时抛出异常提示用户不存在</span></span><br><span class="line">        <span class="keyword">if</span> ( xcUser == <span class="literal">null</span> ) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">"账号不存在"</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">//验证密码是否正确</span></span><br><span class="line">        <span class="comment">//如果查到了正确的用户拿到了正确的密码,返回UserDetails对象给spring security框架,由框架进行密码比对</span></span><br><span class="line">        <span class="comment">//数据库密码</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">passwordDB</span> <span class="operator">=</span> xcUser.getPassword();</span><br><span class="line">        <span class="comment">//用户输入密码</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">passwordForm</span> <span class="operator">=</span> authParamsDto.getPassword();</span><br><span class="line"></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">matches</span> <span class="operator">=</span> passwordEncoder.matches(passwordForm, passwordDB);</span><br><span class="line">        <span class="keyword">if</span> ( !matches ) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">"账号或密码错误"</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="type">XcUserExt</span> <span class="variable">xcUserExt</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XcUserExt</span>();</span><br><span class="line">        BeanUtils.copyProperties(xcUser, xcUserExt);</span><br><span class="line">        <span class="keyword">return</span> xcUserExt;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h2 id="验证码服务"><a class="markdownIt-Anchor" href="#验证码服务"></a> 验证码服务</h2>
<h3 id="验证码作用"><a class="markdownIt-Anchor" href="#验证码作用"></a> 验证码作用</h3>
<p>在认证时一般都需要输入验证码，验证码有什么用？</p>
<p>验证码可以防止恶性攻击，比如：XSS跨站脚本攻击、CSRF跨站请求伪造攻击，一些比较复杂的图形验证码可以有效的防止恶性攻击。</p>
<p>为了保护系统的安全在一些比较重要的操作都需要验证码。</p>
<h3 id="验证码接口测试"><a class="markdownIt-Anchor" href="#验证码接口测试"></a> <strong>验证码接口测试</strong></h3>
<p>验证码服务对外提供的接口有：</p>
<p>1、生成验证码</p>
<p>2、校验验证码。</p>
<p>如下：</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240302122054930.png" alt="image-20240302122054930"></p>
<p>验证码服务如何生成并校验验证码？</p>
<p>拿图片验证码举例：</p>
<p>1、先生成一个指定位数的验证码，根据需要可能是数字、数字字母组合或文字。</p>
<p>2、根据生成的验证码生成一个图片并返回给页面</p>
<p>3、给生成的验证码分配一个key，将key和验证码一同存入缓存。这个key和图片一同返回给页面。</p>
<p>4、用户输入验证码，连同key一同提交至认证服务。</p>
<p>5、认证服务拿key和输入的验证码请求验证码服务去校验</p>
<p>6、验证码服务根据key从缓存取出正确的验证码和用户输入的验证码进行比对，如果相同则校验通过，否则不通过。</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240302122129225.png" alt="image-20240302122129225"></p>
<p>1、生成验证码接口</p>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line">### 申请验证码</span><br><span class="line">POST {{checkcode_host}}/checkcode/pic</span><br></pre></td></tr></table></figure>
<p>2、校验验证码接口</p>
<p>根据生成验证码返回的key以及日志中输出正确的验证码去测试。</p>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line">### 校验验证码</span><br><span class="line">POST {{checkcode_host}}/checkcode/verify?key=checkcode4506b95bddbe46cdb0d56810b747db1b&amp;code=70dl</span><br></pre></td></tr></table></figure>
<h2 id="账号密码认证"><a class="markdownIt-Anchor" href="#账号密码认证"></a> 账号密码认证</h2>
<h3 id="需求分析-2"><a class="markdownIt-Anchor" href="#需求分析-2"></a> <strong>需求分析</strong></h3>
<p>到目前为止账号和密码认证所需要的技术、组件都已开发完毕，下边实现账号密码认证，输出如下图：</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240302161407938.png" alt="image-20240302161407938"></p>
<p>流程如下：</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240302161427234.png" alt="image-20240302161427234"></p>
<h3 id="账号密码认证开发"><a class="markdownIt-Anchor" href="#账号密码认证开发"></a> <strong>账号密码认证开发</strong></h3>
<ol>
<li>
<p>在认证服务定义远程调用验证码服务的接口</p>
</li>
<li>
<p>完善PasswordAuthServiceImpl</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service("password_authService")</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PasswordAuthServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">AuthService</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    XcUserMapper xcUserMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    PasswordEncoder passwordEncoder;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    CheckCodeClient checkCodeClient;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> XcUserExt <span class="title function_">execute</span><span class="params">(AuthParamsDto authParamsDto)</span> {</span><br><span class="line">        <span class="comment">//账号</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> authParamsDto.getUsername();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//远程调用验证码校验接口认证服务</span></span><br><span class="line">        <span class="comment">//校验验证码</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">checkcode</span> <span class="operator">=</span> authParamsDto.getCheckcode();</span><br><span class="line">        <span class="type">String</span> <span class="variable">checkcodekey</span> <span class="operator">=</span> authParamsDto.getCheckcodekey();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ( StringUtils.isEmpty(checkcodekey) || StringUtils.isEmpty(checkcode) ) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">"验证码为空"</span>);</span><br><span class="line"></span><br><span class="line">        }</span><br><span class="line">        <span class="type">Boolean</span> <span class="variable">verify</span> <span class="operator">=</span> checkCodeClient.verify(checkcodekey, checkcode);</span><br><span class="line">        <span class="keyword">if</span> ( !verify ) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">"验证码输入错误"</span>);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">//查询数据库</span></span><br><span class="line">        <span class="type">XcUser</span> <span class="variable">xcUser</span> <span class="operator">=</span> xcUserMapper.selectOne(<span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;XcUser&gt;().eq(XcUser::getUsername, username));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//查询用户不存在,返回null即可,spring security同时抛出异常提示用户不存在</span></span><br><span class="line">        <span class="keyword">if</span> ( xcUser == <span class="literal">null</span> ) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">"账号不存在"</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">//验证密码是否正确</span></span><br><span class="line">        <span class="comment">//如果查到了正确的用户拿到了正确的密码,返回UserDetails对象给spring security框架,由框架进行密码比对</span></span><br><span class="line">        <span class="comment">//数据库密码</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">passwordDB</span> <span class="operator">=</span> xcUser.getPassword();</span><br><span class="line">        <span class="comment">//用户输入密码</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">passwordForm</span> <span class="operator">=</span> authParamsDto.getPassword();</span><br><span class="line"></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">matches</span> <span class="operator">=</span> passwordEncoder.matches(passwordForm, passwordDB);</span><br><span class="line">        <span class="keyword">if</span> ( !matches ) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">"账号或密码错误"</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="type">XcUserExt</span> <span class="variable">xcUserExt</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XcUserExt</span>();</span><br><span class="line">        BeanUtils.copyProperties(xcUser, xcUserExt);</span><br><span class="line">        <span class="keyword">return</span> xcUserExt;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h1 id="微信扫码登录"><a class="markdownIt-Anchor" href="#微信扫码登录"></a> <strong>微信扫码登录</strong></h1>
<h2 id="接入规范"><a class="markdownIt-Anchor" href="#接入规范"></a> 接入规范</h2>
<h3 id="接入流程"><a class="markdownIt-Anchor" href="#接入流程"></a> 接入流程</h3>
<p>微信扫码登录基于OAuth2协议的授权码模式，</p>
<p>接口文档：</p>
<p><a href="https://developers.weixin.qq.com/doc/oplatform/Website_App/WeChat_Login/Wechat_Login.html">https://developers.weixin.qq.com/doc/oplatform/Website_App/WeChat_Login/Wechat_Login.html</a></p>
<p>流程如下：</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240302172032467.png" alt="image-20240302172032467"></p>
<p>第三方应用获取access_token令牌后即可请求微信获取用户的信息，成功获取到用户的信息表示用户在第三方应用认证成功。</p>
<h3 id="请求获取授权码"><a class="markdownIt-Anchor" href="#请求获取授权码"></a> <strong>请求获取授权码</strong></h3>
<p>第三方使用网站应用授权登录前请注意已获取相应网页授权作用域（scope=snsapi_login）</p>
<p>则可以通过在 PC 端打开以下链接： <a href="https://open.weixin.qq.com/connect/qrconnect?appid=APPID&amp;redirect_uri=REDIRECT_URI&amp;response_type=code&amp;scope=SCOPE&amp;state=STATE#wechat_redirect">https://open.weixin.qq.com/connect/qrconnect?appid=APPID&amp;redirect_uri=REDIRECT_URI&amp;response_type=code&amp;scope=SCOPE&amp;state=STATE#wechat_redirect</a></p>
<p>若提示“该链接无法访问”，请检查参数是否填写错误，如redirect_uri的域名与审核时填写的授权域名不一致或 scope 不为snsapi_login。</p>
<p><strong>返回说明</strong></p>
<p>用户允许授权后，将会重定向到redirect_uri的网址上，并且带上 code 和state参数</p>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line">redirect_uri?code=CODE&amp;state=STATE</span><br></pre></td></tr></table></figure>
<p>若用户禁止授权，则不会发生重定向。</p>
<p>登录一号店网站应用 <a href="https://test.yhd.com/wechat/login.do">https://test.yhd.com/wechat/login.do</a> 打开后，一号店会生成 state 参数</p>
<p>跳转到 <a href="https://open.weixin.qq.com/connect/qrconnect?appid=wxbdc5610cc59c1631&amp;redirect_uri=https%3A%2F%2Fpassport.yhd.com%2Fwechat%2Fcallback.do&amp;response_type=code&amp;scope=snsapi_login&amp;state=3d6be0a4035d839573b04816624a415e#wechat_redirect">https://open.weixin.qq.com/connect/qrconnect?appid=wxbdc5610cc59c1631&amp;redirect_uri=https%3A%2F%2Fpassport.yhd.com%2Fwechat%2Fcallback.do&amp;response_type=code&amp;scope=snsapi_login&amp;state=3d6be0a4035d839573b04816624a415e#wechat_redirect</a></p>
<p>微信用户使用微信扫描二维码并且确认登录后</p>
<p>PC端会跳转到 <a href="https://test.yhd.com/wechat/callback.do?code=CODE&amp;state=3d6be0a40sssssxxxxx6624a415e">https://test.yhd.com/wechat/callback.do?code=CODE&amp;state=3d6be0a40sssssxxxxx6624a415e</a> 为了满足网站更定制化的需求，我们还提供了第二种获取 code 的方式，支持网站将微信登录二维码内嵌到自己页面中，用户使用微信扫码授权后通过 JS 将code返回给网站。 JS微信登录主要用途：网站希望用户在网站内就能完成登录，无需跳转到微信域下登录后再返回，提升微信登录的流畅性与成功率。 网站内嵌二维码微信登录 JS 实现办法：</p>
<p>步骤1：在页面中先引入如下 JS 文件（支持https）：</p>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line">http://res.wx.qq.com/connect/zh_CN/htmledition/js/wxLogin.js</span><br></pre></td></tr></table></figure>
<p>步骤2：在需要使用微信登录的地方实例以下 JS 对象：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> obj = <span class="keyword">new</span> <span class="title class_">WxLogin</span>({</span><br><span class="line">    <span class="attr">self_redirect</span>:<span class="literal">true</span>,</span><br><span class="line">    <span class="attr">id</span>:<span class="string">"login_container"</span>, </span><br><span class="line">    <span class="attr">appid</span>: <span class="string">""</span>, </span><br><span class="line">    <span class="attr">scope</span>: <span class="string">""</span>, </span><br><span class="line">    <span class="attr">redirect_uri</span>: <span class="string">""</span>,</span><br><span class="line">    <span class="attr">state</span>: <span class="string">""</span>,</span><br><span class="line">    <span class="attr">style</span>: <span class="string">""</span>,</span><br><span class="line">    <span class="attr">href</span>: <span class="string">""</span></span><br><span class="line">});</span><br></pre></td></tr></table></figure>
<h3 id="通过-code-获取access_token"><a class="markdownIt-Anchor" href="#通过-code-获取access_token"></a> <strong>通过</strong> <strong>code</strong> 获取access_token</h3>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line">https://api.weixin.qq.com/sns/oauth2/access_token?appid=APPID&amp;secret=SECRET&amp;code=CODE&amp;grant_type=authorization_code</span><br></pre></td></tr></table></figure>
<p>正确返回:</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">{</span> </span><br><span class="line">    <span class="attr">"access_token"</span><span class="punctuation">:</span><span class="string">"ACCESS_TOKEN"</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="attr">"expires_in"</span><span class="punctuation">:</span><span class="number">7200</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="attr">"refresh_token"</span><span class="punctuation">:</span><span class="string">"REFRESH_TOKEN"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"openid"</span><span class="punctuation">:</span><span class="string">"OPENID"</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="attr">"scope"</span><span class="punctuation">:</span><span class="string">"SCOPE"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"unionid"</span><span class="punctuation">:</span> <span class="string">"o6_bmasdasdsad6_2sgVt7hMZOPfL"</span></span><br><span class="line"><span class="punctuation">}</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>错误返回:</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"errcode"</span><span class="punctuation">:</span><span class="number">40029</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"errmsg"</span><span class="punctuation">:</span><span class="string">"invalid code"</span></span><br><span class="line"><span class="punctuation">}</span></span><br></pre></td></tr></table></figure>
<h3 id="通过access_token调用接口"><a class="markdownIt-Anchor" href="#通过access_token调用接口"></a> <strong>通过access_token调用接口</strong></h3>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">access_token有效且未超时；</span><br><span class="line">微信用户已授权给第三方应用帐号相应接口作用域（scope）。</span><br></pre></td></tr></table></figure>
<p>获取用户信息接口文档：<a href="https://developers.weixin.qq.com/doc/oplatform/Website_App/WeChat_Login/Authorized_Interface_Calling_UnionID.html">https://developers.weixin.qq.com/doc/oplatform/Website_App/WeChat_Login/Authorized_Interface_Calling_UnionID.html</a></p>
<blockquote>
<p>接口地址：http请求方式: GET<br>
<a href="https://api.weixin.qq.com/sns/userinfo?access_token=ACCESS_TOKEN&amp;openid=OPENID">https://api.weixin.qq.com/sns/userinfo?access_token=ACCESS_TOKEN&amp;openid=OPENID</a></p>
</blockquote>
<p>正确响应:</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"openid"</span><span class="punctuation">:</span><span class="string">"OPENID"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"nickname"</span><span class="punctuation">:</span><span class="string">"NICKNAME"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"sex"</span><span class="punctuation">:</span><span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"province"</span><span class="punctuation">:</span><span class="string">"PROVINCE"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"city"</span><span class="punctuation">:</span><span class="string">"CITY"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"country"</span><span class="punctuation">:</span><span class="string">"COUNTRY"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"headimgurl"</span><span class="punctuation">:</span> <span class="string">"https://thirdwx.qlogo.cn/mmopen/g3MonUZtNHkdmzicIlibx6iaFqAc56vxLSUfpb6n5WKSYVY0ChQKkiaJSgQ1dZuTOgvLLrhJbERQQ4eMsv84eavHiaiceqxibJxCfHe/0"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"privilege"</span><span class="punctuation">:</span><span class="punctuation">[</span></span><br><span class="line">        <span class="string">"PRIVILEGE1"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">"PRIVILEGE2"</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"unionid"</span><span class="punctuation">:</span> <span class="string">" o6_bmasdasdsad6_2sgVt7hMZOPfL"</span></span><br><span class="line"><span class="punctuation">}</span></span><br></pre></td></tr></table></figure>
<p>微信登录部分的请求只能用别人的</p>
<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">weixin:</span><br><span class="line">appid: wxed9954c01bb89b47</span><br><span class="line">secret: a7482517235173ddb4083788de60b90e</span><br></pre></td></tr></table></figure>
<p>在html文件中修改</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> wxObj = <span class="keyword">new</span> <span class="title class_">WxLogin</span>({</span><br><span class="line">    <span class="attr">self_redirect</span>:<span class="literal">true</span>,</span><br><span class="line">    <span class="attr">id</span>:<span class="string">"login_container"</span>, </span><br><span class="line">    <span class="attr">appid</span>: <span class="string">"wxed9954c01bb89b47"</span>, </span><br><span class="line">    <span class="attr">scope</span>: <span class="string">"snsapi_login"</span>, </span><br><span class="line">    <span class="attr">redirect_uri</span>: <span class="string">"http://localhost:8160/auth/wxLogin"</span>,</span><br><span class="line">    <span class="attr">state</span>: token,</span><br><span class="line">    <span class="attr">style</span>: <span class="string">""</span>,</span><br><span class="line">    <span class="attr">href</span>: <span class="string">""</span></span><br><span class="line">});</span><br></pre></td></tr></table></figure>
<h2 id="接入微信登录"><a class="markdownIt-Anchor" href="#接入微信登录"></a> 接入微信登录</h2>
<h3 id="接入分析"><a class="markdownIt-Anchor" href="#接入分析"></a> 接入分析</h3>
<p>本部分内容涉及到的请求url请查看微信帮助文档</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240302181509670.png" alt="image-20240302181509670"></p>
<p>本项目认证服务需要做哪些事？</p>
<p>1、需要定义接口接收微信下发的授权码。</p>
<p>2、收到授权码调用微信接口申请令牌。</p>
<p>3、申请到令牌调用微信获取用户信息</p>
<p>4、获取用户信息成功将其写入本项目用户中心数据库。</p>
<p>5、最后重定向到浏览器自动登录。</p>
<h3 id="定义接口"><a class="markdownIt-Anchor" href="#定义接口"></a> 定义接口</h3>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WxLoginController</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping("/wxLogin")</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">wxLogin</span><span class="params">(String code, String state)</span> <span class="keyword">throws</span> IOException {</span><br><span class="line">        log.debug(<span class="string">"微信扫码回调,code:{},state:{}"</span>, code, state);</span><br><span class="line">        <span class="comment">//请求微信申请令牌，拿到令牌查询用户信息，将用户信息写入本项目数据库</span></span><br><span class="line">        <span class="type">XcUser</span> <span class="variable">xcUser</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XcUser</span>();</span><br><span class="line">        <span class="comment">//暂时硬编写，目的是调试环境</span></span><br><span class="line">        xcUser.setUsername(<span class="string">"t1"</span>);</span><br><span class="line">        <span class="keyword">if</span> ( xcUser == <span class="literal">null</span> ) {</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"redirect:http://www.51xuecheng.cn/error.html"</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> xcUser.getUsername();</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"redirect:http://www.51xuecheng.cn/sign.html?username="</span> + username + <span class="string">"&amp;authType=wx"</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h3 id="接入微信认证"><a class="markdownIt-Anchor" href="#接入微信认证"></a> 接入微信认证</h3>
<ol>
<li>使用restTemplate请求微信，配置RestTemplate bean</li>
</ol>
<p>在启动类配置restTemplate</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line">RestTemplate <span class="title function_">restTemplate</span><span class="params">()</span>{</span><br><span class="line">    <span class="type">RestTemplate</span> <span class="variable">restTemplate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>(<span class="keyword">new</span> <span class="title class_">OkHttp3ClientHttpRequestFactory</span>());</span><br><span class="line">    <span class="keyword">return</span>  restTemplate;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>定义与微信认证的service接口:</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">WxAuthService</span> {</span><br><span class="line">    <span class="keyword">public</span> XcUser <span class="title function_">wxAuth</span><span class="params">(String code)</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p><strong>远程调用微信url获取令牌:</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">	 <span class="comment">/** 携带授权码申请令牌</span></span><br><span class="line"><span class="comment">	 * url:https://api.weixin.qq.com/sns/oauth2/access_token?appid=%s&amp;secret=%s&amp;code=%s&amp;grant_type=authorization_code</span></span><br><span class="line"><span class="comment">     * 申请访问令牌,响应示例</span></span><br><span class="line"><span class="comment">     * {</span></span><br><span class="line"><span class="comment">     * 		"access_token":"ACCESS_TOKEN",</span></span><br><span class="line"><span class="comment">     * 		"expires_in":7200,</span></span><br><span class="line"><span class="comment">     * 		"refresh_token":"REFRESH_TOKEN",</span></span><br><span class="line"><span class="comment">     * 		"openid":"OPENID",</span></span><br><span class="line"><span class="comment">     * 		"scope":"SCOPE",</span></span><br><span class="line"><span class="comment">     * 		"unionid": "o6_bmasdasdsad6_2sgVt7hMZOPfL"</span></span><br><span class="line"><span class="comment">     * }</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="keyword">private</span> Map&lt;String, String&gt; <span class="title function_">getAccess_token</span><span class="params">(String code)</span> {</span><br><span class="line">    <span class="comment">//请求地址</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">wxUrl_template</span> <span class="operator">=</span> <span class="string">"https://api.weixin.qq.com/sns/oauth2/access_token?appid=%s&amp;secret=%s&amp;code=%s&amp;grant_type=authorization_code"</span>;</span><br><span class="line">    <span class="comment">//最终请求路径</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">wxUrl</span> <span class="operator">=</span> String.format(wxUrl_template, appid, secret, code);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//远程调用</span></span><br><span class="line">    ResponseEntity&lt;String&gt; exchange = restTemplate.exchange(wxUrl, HttpMethod.POST, <span class="literal">null</span>, String.class);</span><br><span class="line">    <span class="comment">//获取响应结果</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> exchange.getBody();</span><br><span class="line">    <span class="comment">//解析json</span></span><br><span class="line">    Map&lt;String,String&gt; map = JSON.parseObject(result, Map.class);</span><br><span class="line">    <span class="keyword">return</span> map;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p><strong>根据令牌获取用户信息:</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * url:https://api.weixin.qq.com/sns/userinfo?access_token=%s&amp;openid=%s</span></span><br><span class="line"><span class="comment">     * 获取用户信息，示例如下：</span></span><br><span class="line"><span class="comment">     {</span></span><br><span class="line"><span class="comment">     	"openid":"OPENID",</span></span><br><span class="line"><span class="comment">     	"nickname":"NICKNAME",</span></span><br><span class="line"><span class="comment">     	"sex":1,</span></span><br><span class="line"><span class="comment">     	"province":"PROVINCE",</span></span><br><span class="line"><span class="comment">     	"city":"CITY",</span></span><br><span class="line"><span class="comment">     	"country":"COUNTRY",</span></span><br><span class="line"><span class="comment">     	"headimgurl": "https://thirdwx.qlogo.cn/mmopen/g3MonUZtNHkdmzicIlibx6iaFqAc56vxLSUfpb6n5WKSYVY0ChQKkiaJSgQ1dZuTOgvLLrhJbERQQ4eMsv84eavHiaiceqxibJxCfHe/0",</span></span><br><span class="line"><span class="comment">     	"privilege":[</span></span><br><span class="line"><span class="comment">     	"PRIVILEGE1",</span></span><br><span class="line"><span class="comment">     	"PRIVILEGE2"</span></span><br><span class="line"><span class="comment">     	],</span></span><br><span class="line"><span class="comment">     	"unionid": " o6_bmasdasdsad6_2sgVt7hMZOPfL"</span></span><br><span class="line"><span class="comment">     }</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="keyword">private</span> Map&lt;String,String&gt; <span class="title function_">getUserinfo</span><span class="params">(String access_token,String openid)</span> {</span><br><span class="line">    <span class="comment">//请求地址</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">wxUrl_template</span> <span class="operator">=</span> <span class="string">"https://api.weixin.qq.com/sns/userinfo?access_token=%s&amp;openid=%s"</span>;</span><br><span class="line">    <span class="comment">//最终请求路径</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">wxUrl</span> <span class="operator">=</span> String.format(wxUrl_template, access_token, openid);</span><br><span class="line">    <span class="comment">//请求数据</span></span><br><span class="line">    ResponseEntity&lt;String&gt; exchange = restTemplate.exchange(wxUrl, HttpMethod.GET, <span class="literal">null</span>, String.class);</span><br><span class="line">    <span class="comment">//获取响应结果</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(exchange.getBody().getBytes(StandardCharsets.ISO_8859_1),StandardCharsets.UTF_8);</span><br><span class="line">    <span class="comment">//解析json</span></span><br><span class="line">    Map&lt;String,String&gt; map = JSON.parseObject(result, Map.class);</span><br><span class="line">    <span class="keyword">return</span> map;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p><strong>数据库保存用户信息:</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 向数据库添加微信用户</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userInfo_map 用户信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 用户信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> XcUser <span class="title function_">addWxUser</span><span class="params">(Map&lt;String,String&gt; userInfo_map)</span> {</span><br><span class="line">    <span class="type">String</span> <span class="variable">nickname</span> <span class="operator">=</span> userInfo_map.get(<span class="string">"nickname"</span>);</span><br><span class="line">    <span class="type">String</span> <span class="variable">unionid</span> <span class="operator">=</span> userInfo_map.get(<span class="string">"unionid"</span>);</span><br><span class="line">    <span class="type">XcUser</span> <span class="variable">xcUser</span> <span class="operator">=</span> xcUserMapper.selectOne(<span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;XcUser&gt;().eq(XcUser::getWxUnionid, unionid));</span><br><span class="line">    <span class="keyword">if</span> (xcUser != <span class="literal">null</span>) {</span><br><span class="line">        <span class="keyword">return</span> xcUser;</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//向数据库新增记录</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">userId</span> <span class="operator">=</span> UUID.randomUUID().toString();</span><br><span class="line">    xcUser = <span class="keyword">new</span> <span class="title class_">XcUser</span>();</span><br><span class="line">    xcUser.setNickname(userInfo_map.get(<span class="string">"nickname"</span>));</span><br><span class="line">    xcUser.setUserpic(userInfo_map.get(<span class="string">"headimgurl"</span>));</span><br><span class="line">    xcUser.setName(userInfo_map.get(<span class="string">"nickname"</span>));</span><br><span class="line">    xcUser.setUsername(unionid);</span><br><span class="line">    xcUser.setPassword(unionid);</span><br><span class="line">    xcUser.setUtype(<span class="string">"101001"</span>);<span class="comment">//学生类型</span></span><br><span class="line">    xcUser.setStatus(<span class="string">"1"</span>);<span class="comment">//用户状态</span></span><br><span class="line">    xcUser.setCreateTime(LocalDateTime.now());</span><br><span class="line">    xcUserMapper.insert(xcUser);</span><br><span class="line">    <span class="type">XcUserRole</span> <span class="variable">xcUserRole</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XcUserRole</span>();</span><br><span class="line">    xcUserRole.setId(UUID.randomUUID().toString());</span><br><span class="line">    xcUserRole.setUserId(userId);</span><br><span class="line">    xcUserRole.setRoleId(<span class="string">"17"</span>);<span class="comment">//学生角色</span></span><br><span class="line">    xcUserRoleMapper.insert(xcUserRole);</span><br><span class="line">    <span class="keyword">return</span> xcUser;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p><strong>controller调用微信扫码认证方法：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 微信扫码认证</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> code 微信授权码</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 用户信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> XcUser <span class="title function_">wxAuth</span><span class="params">(String code)</span> {</span><br><span class="line">    <span class="comment">//申请令牌</span></span><br><span class="line">    Map&lt;String, String&gt; accessToken = getAccess_token(code);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//携带令牌查询用户信息</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">access_token</span> <span class="operator">=</span> accessToken.get(<span class="string">"access_token"</span>);</span><br><span class="line">    <span class="type">String</span> <span class="variable">openid</span> <span class="operator">=</span> accessToken.get(<span class="string">"openid"</span>);</span><br><span class="line">    Map&lt;String, String&gt; userinfo = getUserinfo(access_token, openid);</span><br><span class="line"></span><br><span class="line">    <span class="type">XcUser</span> <span class="variable">xcUser</span> <span class="operator">=</span> currentProxy.addWxUser(userinfo);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> xcUser;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p><strong>excute验证方法:</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> XcUserExt <span class="title function_">execute</span><span class="params">(AuthParamsDto authParamsDto)</span> {</span><br><span class="line">    <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> authParamsDto.getUsername();</span><br><span class="line">    <span class="comment">//查询数据库</span></span><br><span class="line">    <span class="type">XcUser</span> <span class="variable">xcUser</span> <span class="operator">=</span> xcUserMapper.selectOne(<span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;XcUser&gt;().eq(XcUser::getUsername, username));</span><br><span class="line">    <span class="keyword">if</span>(xcUser == <span class="literal">null</span>){</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">"账号不存在"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="type">XcUserExt</span> <span class="variable">xcUserExt</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XcUserExt</span>();</span><br><span class="line">    BeanUtils.copyProperties(xcUser, xcUserExt);</span><br><span class="line">    <span class="keyword">return</span> xcUserExt;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>下边在controller中调用wxAuth接口：</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WxLoginController</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    WxAuthService wxAuthService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping("/wxLogin")</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">wxLogin</span><span class="params">(String code, String state)</span> <span class="keyword">throws</span> IOException {</span><br><span class="line">        log.debug(<span class="string">"微信扫码回调,code:{},state:{}"</span>,code,state);</span><br><span class="line">        <span class="comment">//请求微信申请令牌，拿到令牌查询用户信息，将用户信息写入本项目数据库</span></span><br><span class="line">        <span class="type">XcUser</span> <span class="variable">xcUser</span> <span class="operator">=</span> wxAuthService.wxAuth(code);</span><br><span class="line">        <span class="keyword">if</span>(xcUser==<span class="literal">null</span>){</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"redirect:http://www.51xuecheng.cn/error.html"</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> xcUser.getUsername();</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"redirect:http://www.51xuecheng.cn/sign.html?username="</span>+username+<span class="string">"&amp;authType=wx"</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>学习</tag>
        <tag>后端</tag>
        <tag>黑马程序员</tag>
        <tag>学成在线</tag>
      </tags>
  </entry>
  <entry>
    <title>学成在线Day11</title>
    <url>/2024/03/21/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFDay11/</url>
    <content><![CDATA[<h1 id="学成在线day11"><a class="markdownIt-Anchor" href="#学成在线day11"></a> 学成在线Day11</h1>
<h1 id="用户授权"><a class="markdownIt-Anchor" href="#用户授权"></a> 用户授权</h1>
<h2 id="rbac"><a class="markdownIt-Anchor" href="#rbac"></a> RBAC</h2>
<p>如何实现授权？业界通常基于RBAC实现授权。</p>
<p>RBAC分为两种方式：</p>
<p>基于角色的访问控制（Role-Based Access Control）</p>
<p>基于资源的访问控制（Resource-Based Access Control）</p>
<p>角色的访问控制（Role-Based Access Control）是按角色进行授权，比如：主体的角色为总经理可以查询企业运营报表，查询员工工资信息等，访问控制流程如下：</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240304162632533.png" alt="image-20240304162632533"></p>
<p>根据上图中的判断逻辑，授权代码可表示如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(主体.hasRole(<span class="string">"总经理角色id"</span>)){</span><br><span class="line">	查询工资</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>如果上图中查询工资所需要的角色变化为总经理和部门经理，此时就需要修改判断逻辑为“判断用户的角色是否是总经理或部门经理”，修改代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(主体.hasRole(<span class="string">"总经理角色id"</span>) ||  主体.hasRole(<span class="string">"部门经理角色id"</span>)){</span><br><span class="line">    查询工资</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>根据上边的例子发现，当需要修改角色的权限时就需要修改授权的相关代码，系统可扩展性差。</p>
<p>基于资源的访问控制（Resource-Based Access</p>
<p>Control）是按资源（或权限）进行授权，比如：用户必须具有查询工资权限才可以查询员工工资信息等，访问控制流程如下：</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240304163606002.png" alt="image-20240304163606002"></p>
<p>根据上图中的判断，授权代码可以表示为：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(主体.hasPermission(<span class="string">"查询工资权限标识"</span>)){</span><br><span class="line">    查询工资</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>优点：系统设计时定义好查询工资的权限标识，即使查询工资所需要的角色变化为总经理和部门经理也不需要修改授权代码，系统可扩展性强。</p>
<h2 id="资源服务授权流程"><a class="markdownIt-Anchor" href="#资源服务授权流程"></a> 资源服务授权流程</h2>
<p>本项目在资源服务内部进行授权，基于资源的授权模式，因为接口在资源服务，通过在接口处添加授权注解实现授权。</p>
<p>在资源服务集成Spring Security</p>
<p>在需要授权的接口处使用@PreAuthorize("hasAuthority('权限标识符')")进行控制</p>
<p>下边代码指定/course/list接口需要拥有xc_teachmanager_course_list 权限。</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240304164611743.png" alt="image-20240304164611743"></p>
<p>设置了@PreAuthorize表示执行此方法需要授权，如果当前用户请求接口没有权限则抛出异常</p>
<p>org.springframework.security.access.AccessDeniedException: 不允许访问</p>
<p>在统一异常处理处处理异常</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="meta">@ExceptionHandler(Exception.class)</span></span><br><span class="line"><span class="meta">@ResponseStatus(HttpStatus.INTERNAL_SERVER_ERROR)</span></span><br><span class="line"><span class="keyword">public</span> RestErrorResponse <span class="title function_">exception</span><span class="params">(Exception e)</span> {</span><br><span class="line">    log.error(<span class="string">"【系统异常】{}"</span>,e.getMessage(),e);</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">    <span class="keyword">if</span>(e.getMessage().equals(<span class="string">"不允许访问"</span>)){</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RestErrorResponse</span>(<span class="string">"没有操作此功能的权限"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RestErrorResponse</span>(CommonError.UNKOWN_ERROR.getErrMessage());</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>重启资源服务进行测试</p>
<p>使用教学机构用户登录系统</p>
<p>这里使用t1用户登录，账号:t1、密码：111111</p>
<p>登录成功，点击“教学机构”</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240304171025127.png" alt="image-20240304171025127"></p>
<p>如何给用户分配权限呢？</p>
<p>首先要学习数据模型，本项目授权相关的数据表如下：</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240304171201768.png" alt="image-20240304171201768"></p>
<p>xc_user：用户表，存储了系统用户信息，用户类型包括：学生、老师、管理员等</p>
<p>xc_role：角色表，存储了系统的角色信息，学生、老师、教学管理员、系统管理员等。</p>
<p>xc_user_role：用户角色表，一个用户可拥有多个角色，一个角色可被多个用户所拥有</p>
<p>xc_menu:模块表，记录了菜单及菜单下的权限</p>
<p>xc_permission:角色权限表，一个角色可拥有多个权限，一个权限可被多个角色所拥有</p>
<p>本项目要求掌握基于权限数据模型（5张数据表），要求在数据库中操作完成给用户分配权限、查询用户权限等需求。</p>
<p>1、查询用户所拥有的权限</p>
<p>步骤：</p>
<p>查询用户的id</p>
<p>查询用户所拥有的角色</p>
<p>查询用户所拥有的权限</p>
<p>例子：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT * FROM xc_menu WHERE id IN(</span><br><span class="line">    SELECT menu_id FROM xc_permission WHERE role_id IN(</span><br><span class="line">        SELECT role_id FROM xc_user_role WHERE user_id = '49'</span><br><span class="line">    )</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>2、给用户分配权限</p>
<p>1）添加权限</p>
<p>查询用户的id</p>
<p>查询权限的id</p>
<p>查询用户的角色，如果没有角色需要先给用户指定角色</p>
<p>向角色权限表添加记录</p>
<p>2）删除用户权限</p>
<p>本项目是基于角色分配权限，如果要删除用户的权限可以给用户换角色，那么新角色下的权限就是用户的权限；如果不换用户的角色可以删除角色下的权限即删除角色权限关系表相应记录，这样操作是将角色下的权限删除，属于该角色的用户都将删除此权限。</p>
<h2 id="查询用户权限"><a class="markdownIt-Anchor" href="#查询用户权限"></a> 查询用户权限</h2>
<p>使用Spring Security进行授权，首先在生成jwt前会查询用户的权限，如下图</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240304173446011.png" alt="image-20240304173446011"></p>
<p>接下来需要修改UserServiceImpl和PasswordAuthServiceImpl从数据库查询用户的权限。</p>
<ol>
<li>定义mapper接口</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">XcMenuMapper</span> <span class="keyword">extends</span> <span class="title class_">BaseMapper</span>&lt;XcMenu&gt; {</span><br><span class="line">    <span class="meta">@Select("SELECT    * FROM xc_menu WHERE id IN (SELECT menu_id FROM xc_permission WHERE role_id IN ( SELECT role_id FROM xc_user_role WHERE user_id = #{userId} ))")</span></span><br><span class="line">    List&lt;XcMenu&gt; <span class="title function_">selectPermissionByUserId</span><span class="params">(<span class="meta">@Param("userId")</span> String userId)</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>修改PasswordAuthServiceImpl</li>
</ol>
<p>修改UserServiceImpl类的getUserPrincipal方法，查询权限信息</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//查询用户身份</span></span><br><span class="line"><span class="keyword">public</span> UserDetails <span class="title function_">getUserPrincipal</span><span class="params">(XcUserExt user)</span>{</span><br><span class="line">    <span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> user.getPassword();</span><br><span class="line">    <span class="comment">//查询用户权限</span></span><br><span class="line">    List&lt;XcMenu&gt; xcMenus = menuMapper.selectPermissionByUserId(user.getId());</span><br><span class="line">    List&lt;String&gt; permissions = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">if</span>(xcMenus.size()&lt;=<span class="number">0</span>){</span><br><span class="line">        <span class="comment">//用户权限,如果不加则报Cannot pass a null GrantedAuthority collection</span></span><br><span class="line">        permissions.add(<span class="string">"p1"</span>);</span><br><span class="line">    }<span class="keyword">else</span>{</span><br><span class="line">        xcMenus.forEach(menu-&gt;{</span><br><span class="line">            permissions.add(menu.getCode());</span><br><span class="line">        });</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//将用户权限放在XcUserExt中</span></span><br><span class="line">    user.setPermissions(permissions);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//为了安全在令牌中不放密码</span></span><br><span class="line">    user.setPassword(<span class="literal">null</span>);</span><br><span class="line">    <span class="comment">//将user对象转json</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">userString</span> <span class="operator">=</span> JSON.toJSONString(user);</span><br><span class="line">    String[] authorities = permissions.toArray(<span class="keyword">new</span> <span class="title class_">String</span>[<span class="number">0</span>]);</span><br><span class="line">    <span class="type">UserDetails</span> <span class="variable">userDetails</span> <span class="operator">=</span> User.withUsername(userString).password(password).authorities(authorities).build();</span><br><span class="line">    <span class="keyword">return</span> userDetails;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>将xc_teachmanager_course_list权限分配给用户。</p>
<p>1）首先找到当前用户的角色</p>
<p>2）找到xc_teachmanager_course_list权限的主键</p>
<p>3）在角色权限关系表中添加记录</p>
<p>分配完权限需要重新登录</p>
<p>由于用户分配了xc_teachmanager_course_list权限，用户具有访问课程查询接口的权限。</p>
<h2 id="细粒度授权"><a class="markdownIt-Anchor" href="#细粒度授权"></a> 细粒度授权</h2>
<h3 id="什么是细粒度授权"><a class="markdownIt-Anchor" href="#什么是细粒度授权"></a> <strong>什么是细粒度授权</strong></h3>
<p>什么是细粒度授权？</p>
<p>细粒度授权也叫数据范围授权，即不同的用户所拥有的操作权限相同，但是能够操作的数据范围是不一样的。一个例子：用户A和用户B都是教学机构，他们都拥有“我的课程”权限，但是两个用户所查询到的数据是不一样的。</p>
<p>本项目有哪些细粒度授权？</p>
<p>比如：</p>
<p>我的课程，教学机构只允许查询本教学机构下的课程信息。</p>
<p>我的选课，学生只允许查询自己所选课。</p>
<p>如何实现细粒度授权？</p>
<p>细粒度授权涉及到不同的业务逻辑，通常在<code>service</code>层实现，根据不同的用户进行校验，根据不同的参数查询不同的数据或操作不同的数据。</p>
<h3 id="教学机构细粒度授权"><a class="markdownIt-Anchor" href="#教学机构细粒度授权"></a> 教学机构细粒度授权</h3>
<p>教学机构在维护课程时只允许维护本机构的课程，教学机构细粒度授权过程如下：</p>
<ol>
<li>
<p>获取当前登录的用户身份</p>
</li>
<li>
<p>得到用户所属教育机构的Id</p>
</li>
<li>
<p>查询该教学机构下的课程信息</p>
</li>
</ol>
<p>最终实现了用户只允许查询自己机构的课程信息。</p>
<p>根据公司Id查询课程，流程如下：</p>
<ol>
<li>
<p>教学机构用户登录系统，从用户身份中取出所属机构的id,在用户表中设计了company_id字段存储该用户所属的机构id.</p>
</li>
<li>
<p>接口层取出当前登录用户的身份，取出机构id</p>
</li>
</ol>
<ol start="3">
<li>将机构id传入service方法。</li>
<li>service方法将机构id传入Dao方法，最终查询出本机构的课程信息。</li>
</ol>
<p>代码实现如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@ApiOperation("课程查询接口")</span></span><br><span class="line"><span class="meta">@PreAuthorize("hasAuthority('xc_teachmanager_course_list')")</span><span class="comment">//拥有课程列表查询的权限方可访问</span></span><br><span class="line"><span class="meta">@PostMapping("/course/list")</span></span><br><span class="line"><span class="keyword">public</span> PageResult&lt;CourseBase&gt; <span class="title function_">list</span><span class="params">(PageParams pageParams, <span class="meta">@RequestBody</span> QueryCourseParamsDto queryCourseParams)</span>{</span><br><span class="line">    <span class="comment">//取出用户身份</span></span><br><span class="line">    <span class="type">XcUser</span> <span class="variable">user</span> <span class="operator">=</span> SecurityUtil.getUser();</span><br><span class="line">    <span class="comment">//机构id</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">companyId</span> <span class="operator">=</span> user.getCompanyId();</span><br><span class="line">    <span class="keyword">return</span> courseBaseInfoService.queryCourseBaseList(Long.parseLong(companyId),pageParams,queryCourseParams);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>Service层:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> PageResult&lt;CourseBase&gt; <span class="title function_">queryCourseBaseList</span><span class="params">(Long companyId, PageParams pageParams, QueryCourseParamsDTO queryCourseParamsDto)</span> {</span><br><span class="line">    <span class="comment">//构建查询条件对象</span></span><br><span class="line">    LambdaQueryWrapper&lt;CourseBase&gt; queryWrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();</span><br><span class="line">    <span class="comment">//构建查询条件，根据课程名称查询</span></span><br><span class="line">    queryWrapper.like(StringUtils.isNotEmpty(queryCourseParamsDto.getCourseName()), CourseBase::getName, queryCourseParamsDto.getCourseName());</span><br><span class="line">    <span class="comment">//构建查询条件，根据课程审核状态查询</span></span><br><span class="line">    queryWrapper.eq(StringUtils.isNotEmpty(queryCourseParamsDto.getAuditStatus()), CourseBase::getAuditStatus, queryCourseParamsDto.getAuditStatus());</span><br><span class="line">    <span class="comment">//构建查询条件，根据课程发布状态查询</span></span><br><span class="line">    queryWrapper.eq(StringUtils.isNotEmpty(queryCourseParamsDto.getPublishStatus()), CourseBase::getStatus, queryCourseParamsDto.getPublishStatus());</span><br><span class="line">    <span class="comment">//构建查询条件，根据课程所属机构查询</span></span><br><span class="line">    queryWrapper.eq(CourseBase::getCompanyId, companyId);</span><br><span class="line">    <span class="comment">//分页对象</span></span><br><span class="line">    Page&lt;CourseBase&gt; page = <span class="keyword">new</span> <span class="title class_">Page</span>&lt;&gt;(pageParams.getPageNo(), pageParams.getPageSize());</span><br><span class="line">    <span class="comment">// 查询数据内容获得结果</span></span><br><span class="line">    Page&lt;CourseBase&gt; pageResult = courseBaseMapper.selectPage(page, queryWrapper);</span><br><span class="line">    <span class="comment">// 获取数据列表</span></span><br><span class="line">    List&lt;CourseBase&gt; list = pageResult.getRecords();</span><br><span class="line">    <span class="comment">// 获取数据总数</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">total</span> <span class="operator">=</span> pageResult.getTotal();</span><br><span class="line">    <span class="comment">// 构建结果集</span></span><br><span class="line">    PageResult&lt;CourseBase&gt; courseBasePageResult = <span class="keyword">new</span> <span class="title class_">PageResult</span>&lt;&gt;(list, total, pageParams.getPageNo(), pageParams.getPageSize());</span><br><span class="line">    <span class="keyword">return</span> courseBasePageResult;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p><code>启动后出现配置类重名情况</code></p>
<p>原因:因为我前面没写工具类导致引入的工具类是其他包的工具类顺便在maven导入了其他模块进而导致了类名重复无法运行,下次可以先从maven依赖开始检查</p>
<h1 id="找回密码实战"><a class="markdownIt-Anchor" href="#找回密码实战"></a> 找回密码实战</h1>
<h2 id="找回密码接口文档"><a class="markdownIt-Anchor" href="#找回密码接口文档"></a> 找回密码接口文档</h2>
<p><strong>只做邮箱找回密码</strong></p>
<blockquote>
<ul>
<li>需求：忘记密码需要找回，可以通过邮箱找回密码</li>
<li>页面访问地址：localhost/findpassword.html</li>
</ul>
</blockquote>
<p>接口:</p>
<blockquote>
<p>邮箱验证码：/api/checkcode/phone?param1=电子邮箱地址</p>
<p>找回密码：/api/auth/findpassword</p>
</blockquote>
<p>请求:</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">{</span></span><br><span class="line">    cellphone<span class="punctuation">:</span>''<span class="punctuation">,</span></span><br><span class="line">    email<span class="punctuation">:</span>''<span class="punctuation">,</span></span><br><span class="line">    checkcodekey<span class="punctuation">:</span>''<span class="punctuation">,</span></span><br><span class="line">    checkcode<span class="punctuation">:</span>''<span class="punctuation">,</span></span><br><span class="line">    confirmpwd<span class="punctuation">:</span>''<span class="punctuation">,</span></span><br><span class="line">    password<span class="punctuation">:</span>''</span><br><span class="line"><span class="punctuation">}</span></span><br></pre></td></tr></table></figure>
<p>响应：</p>
<p>200: 找回成功</p>
<p>其它：找回失败，失败原因使用统一异常处理返回的信息格式</p>
<p>执行流程</p>
<ol>
<li>
<p>校验验证码，不一致则抛出异常</p>
</li>
<li>
<p>判断两次密码是否一致，不一致则抛出异常</p>
</li>
<li>
<p>根据手机号和邮箱查询用户</p>
</li>
<li>
<p>如果找到用户更新为新密码</p>
</li>
</ol>
<h2 id="找回密码代码开发"><a class="markdownIt-Anchor" href="#找回密码代码开发"></a> 找回密码代码开发</h2>
<h3 id="1-安装相关依赖"><a class="markdownIt-Anchor" href="#1-安装相关依赖"></a> 1. 安装相关依赖</h3>
<p>邮箱相关依赖:</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/javax.activation/activation --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.activation<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>activation<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/javax.mail/mail --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.mail<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mail<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4.7<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.apache.commons/commons-email --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-email<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="2-编写邮箱工具类"><a class="markdownIt-Anchor" href="#2-编写邮箱工具类"></a> 2. 编写邮箱工具类</h3>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.checkcode.utils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.mail.*;</span><br><span class="line"><span class="keyword">import</span> javax.mail.internet.InternetAddress;</span><br><span class="line"><span class="keyword">import</span> javax.mail.internet.MimeMessage;</span><br><span class="line"><span class="keyword">import</span> javax.mail.internet.MimeMessage.RecipientType;</span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> java.util.Collections;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MailUtil</span> {</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> MimeMessage mimeMsg; <span class="comment">// 邮件对象</span></span><br><span class="line">    <span class="keyword">private</span> Multipart mp;<span class="comment">// 附件添加的组件</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> MessagingException {</span><br><span class="line">        <span class="comment">//可以在这里直接测试方法，填自己的邮箱即可</span></span><br><span class="line">        sendTestMail(<span class="string">"a1605691832@163.com"</span>, achieveCode());</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 发送邮件</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> email 收件邮箱号</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> code  验证码</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> MessagingException 邮件异常</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">sendTestMail</span><span class="params">(String email, String code)</span> <span class="keyword">throws</span> MessagingException {</span><br><span class="line">        <span class="comment">/* 创建Properties 类用于记录邮箱的一些属性</span></span><br><span class="line"><span class="comment">         * 1.邮件服务器</span></span><br><span class="line"><span class="comment">         * 2.发件人邮箱</span></span><br><span class="line"><span class="comment">         * 3.发件人的授权密码</span></span><br><span class="line"><span class="comment">         * 4.邮件主题</span></span><br><span class="line"><span class="comment">         * 5.收件人，多个收件人以半角逗号分隔</span></span><br><span class="line"><span class="comment">         * 6.抄送，多个抄送以半角逗号分隔</span></span><br><span class="line"><span class="comment">         * 7.正文，可以用html格式的哟</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="type">Properties</span> <span class="variable">props</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Properties</span>();</span><br><span class="line">        <span class="comment">// 表示SMTP发送邮件，必须进行身份验证</span></span><br><span class="line">        props.put(<span class="string">"mail.smtp.auth"</span>, <span class="string">"true"</span>);</span><br><span class="line">        <span class="comment">//此处填写SMTP服务器</span></span><br><span class="line">        props.put(<span class="string">"mail.smtp.host"</span>, <span class="string">"smtp.163.com"</span>);</span><br><span class="line">        <span class="comment">//端口号，QQ邮箱端口587</span></span><br><span class="line">        props.put(<span class="string">"mail.smtp.port"</span>, <span class="string">"25"</span>);</span><br><span class="line">        <span class="comment">// 此处填写，写信人的账号</span></span><br><span class="line">        props.put(<span class="string">"mail.user"</span>, <span class="string">"a1605691832@163.com"</span>);</span><br><span class="line">        <span class="comment">// 此处填写16位STMP口令</span></span><br><span class="line">        props.put(<span class="string">"mail.password"</span>, <span class="string">"CZLXNYOVEHHUQRXB"</span>);</span><br><span class="line">        <span class="comment">// 构建授权信息，用于进行SMTP进行身份验证</span></span><br><span class="line">        <span class="type">Authenticator</span> <span class="variable">authenticator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Authenticator</span>() {</span><br><span class="line">            <span class="keyword">protected</span> PasswordAuthentication <span class="title function_">getPasswordAuthentication</span><span class="params">()</span> {</span><br><span class="line">                <span class="comment">// 用户名、密码</span></span><br><span class="line">                <span class="type">String</span> <span class="variable">userName</span> <span class="operator">=</span> props.getProperty(<span class="string">"mail.user"</span>);</span><br><span class="line">                <span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> props.getProperty(<span class="string">"mail.password"</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">PasswordAuthentication</span>(userName, password);</span><br><span class="line">            }</span><br><span class="line">        };</span><br><span class="line">        <span class="comment">// 使用环境属性和授权信息，创建邮件会话</span></span><br><span class="line">        <span class="type">Session</span> <span class="variable">mailSession</span> <span class="operator">=</span> Session.getInstance(props, authenticator);</span><br><span class="line">        <span class="comment">// 创建邮件消息</span></span><br><span class="line">        <span class="type">MimeMessage</span> <span class="variable">message</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MimeMessage</span>(mailSession);</span><br><span class="line">        <span class="comment">// 设置发件人</span></span><br><span class="line">        <span class="type">InternetAddress</span> <span class="variable">from</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InternetAddress</span>(props.getProperty(<span class="string">"mail.user"</span>));</span><br><span class="line">        message.setFrom(from);</span><br><span class="line">        <span class="comment">// 设置收件人的邮箱</span></span><br><span class="line">        <span class="type">InternetAddress</span> <span class="variable">to</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InternetAddress</span>(email);</span><br><span class="line">        message.setRecipient(RecipientType.TO, to);</span><br><span class="line">        <span class="comment">// 设置邮件标题</span></span><br><span class="line">        message.setSubject(<span class="string">"Wwhds 学成在线实战邮件测试"</span>);</span><br><span class="line">        <span class="comment">// 设置邮件的内容体</span></span><br><span class="line">        message.setContent(<span class="string">"尊敬的用户:你好!\n注册验证码为:"</span> + code + <span class="string">"(有效期为一分钟,请勿告知他人)"</span>, <span class="string">"text/html;charset=UTF-8"</span>);</span><br><span class="line">        <span class="comment">// 最后当然就是发送邮件啦</span></span><br><span class="line">        Transport.send(message);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *  生成验证码</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 验证码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">achieveCode</span><span class="params">()</span> {  <span class="comment">//由于数字 1 、 0 和字母 O 、l 有时分不清楚，所以，没有数字 1 、 0</span></span><br><span class="line">        String[] beforeShuffle = <span class="keyword">new</span> <span class="title class_">String</span>[]{<span class="string">"2"</span>, <span class="string">"3"</span>, <span class="string">"4"</span>, <span class="string">"5"</span>, <span class="string">"6"</span>, <span class="string">"7"</span>, <span class="string">"8"</span>, <span class="string">"9"</span>, <span class="string">"A"</span>, <span class="string">"B"</span>, <span class="string">"C"</span>, <span class="string">"D"</span>, <span class="string">"E"</span>, <span class="string">"F"</span>,</span><br><span class="line">                <span class="string">"G"</span>, <span class="string">"H"</span>, <span class="string">"I"</span>, <span class="string">"J"</span>, <span class="string">"K"</span>, <span class="string">"L"</span>, <span class="string">"M"</span>, <span class="string">"N"</span>, <span class="string">"O"</span>, <span class="string">"P"</span>, <span class="string">"Q"</span>, <span class="string">"R"</span>, <span class="string">"S"</span>, <span class="string">"T"</span>, <span class="string">"U"</span>, <span class="string">"V"</span>, <span class="string">"W"</span>, <span class="string">"X"</span>, <span class="string">"Y"</span>, <span class="string">"Z"</span>, <span class="string">"a"</span>,</span><br><span class="line">                <span class="string">"b"</span>, <span class="string">"c"</span>, <span class="string">"d"</span>, <span class="string">"e"</span>, <span class="string">"f"</span>, <span class="string">"g"</span>, <span class="string">"h"</span>, <span class="string">"i"</span>, <span class="string">"j"</span>, <span class="string">"k"</span>, <span class="string">"l"</span>, <span class="string">"m"</span>, <span class="string">"n"</span>, <span class="string">"o"</span>, <span class="string">"p"</span>, <span class="string">"q"</span>, <span class="string">"r"</span>, <span class="string">"s"</span>, <span class="string">"t"</span>, <span class="string">"u"</span>, <span class="string">"v"</span>,</span><br><span class="line">                <span class="string">"w"</span>, <span class="string">"x"</span>, <span class="string">"y"</span>, <span class="string">"z"</span>};</span><br><span class="line">        List&lt;String&gt; list = Arrays.asList(beforeShuffle);<span class="comment">//将数组转换为集合</span></span><br><span class="line">        Collections.shuffle(list);  <span class="comment">//打乱集合顺序</span></span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        <span class="keyword">for</span> (String s : list) {</span><br><span class="line">            sb.append(s); <span class="comment">//将集合转化为字符串</span></span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> sb.substring(<span class="number">3</span>, <span class="number">8</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h3 id="3-发送验证码接口"><a class="markdownIt-Anchor" href="#3-发送验证码接口"></a> 3. 发送验证码接口</h3>
<p><strong>Controller层:</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@ApiOperation(value = "发送邮箱验证码", tags = "发送邮箱验证码")</span></span><br><span class="line"><span class="meta">@PostMapping("/phone")</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendEMail</span><span class="params">(<span class="meta">@RequestParam("param1")</span> String email)</span> <span class="keyword">throws</span> MessagingException {</span><br><span class="line">    <span class="type">String</span> <span class="variable">code</span> <span class="operator">=</span> MailUtil.achieveCode();</span><br><span class="line">    sendCodeService.sendCodeToEmail(email, code);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p><strong>Service接口:</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">SendCodeService</span> {</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">        * 发送验证码</span></span><br><span class="line"><span class="comment">        * <span class="doctag">@param</span> email 目标邮箱</span></span><br><span class="line"><span class="comment">        * <span class="doctag">@param</span> code 验证码</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        <span class="keyword">void</span> <span class="title function_">sendCodeToEmail</span><span class="params">(String email,String code)</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p><strong>Service实现类:</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SendCodeServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">SendCodeService</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    RedisTemplate&lt;String, String&gt; redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendCodeToEmail</span><span class="params">(String email, String code)</span> {</span><br><span class="line">        log.info(<span class="string">"发送验证码到邮箱：{}，验证码：{}"</span>, email, code);</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="comment">//1.发送邮件</span></span><br><span class="line">            MailUtil.sendTestMail(email, code);</span><br><span class="line">        } <span class="keyword">catch</span> (MessagingException e) {</span><br><span class="line">            log.info(<span class="string">"发送验证码到邮箱失败：{}，验证码：{}"</span>, email, code);</span><br><span class="line">            XueChengPlusException.cast(<span class="string">"发送验证码到邮箱失败"</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">//2.将验证码存入redis</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">CODE_EXPIRE_TIME</span> <span class="operator">=</span> <span class="number">2</span> * <span class="number">60L</span>;</span><br><span class="line">        redisTemplate.opsForValue().set(email, code, CODE_EXPIRE_TIME);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h3 id="4-验证验证码接口"><a class="markdownIt-Anchor" href="#4-验证验证码接口"></a> 4. 验证验证码接口</h3>
<p>密码找回DTO类:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FindPswDto</span> {</span><br><span class="line"></span><br><span class="line">    String cellphone;</span><br><span class="line"></span><br><span class="line">    String email;</span><br><span class="line"></span><br><span class="line">    String checkcodekey;</span><br><span class="line"></span><br><span class="line">    String checkcode;</span><br><span class="line"></span><br><span class="line">    String password;</span><br><span class="line"></span><br><span class="line">    String confirmpwd;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p><strong>Controller层:</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@ApiOperation(value = "验证验证码是否正确", tags = "验证验证码是否正确")</span></span><br><span class="line"><span class="meta">@PostMapping("/findpassword")</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">verifyCode</span><span class="params">(<span class="meta">@RequestBody</span> FindPswDto findPswDto)</span> {</span><br><span class="line">    log.info(<span class="string">"验证验证码:{}"</span>, findPswDto);</span><br><span class="line">    verifyService.findPassword(findPswDto);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p><strong>Service接口:</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">VerifyService</span> {</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">findPassword</span><span class="params">(FindPswDto findPswDto)</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p><strong>Service实现类:</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">VerifyServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">VerifyService</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate&lt;String,String&gt; redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> XcUserMapper userMapper;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">findPassword</span><span class="params">(FindPswDto findPswDto)</span> {</span><br><span class="line">        <span class="comment">//获取redis中的验证码</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">code</span> <span class="operator">=</span> redisTemplate.opsForValue().get(findPswDto.getEmail());</span><br><span class="line">        <span class="keyword">if</span> (code == <span class="literal">null</span>) {</span><br><span class="line">            log.info(<span class="string">"验证码已过期"</span>);</span><br><span class="line">            XueChengPlusException.cast(<span class="string">"验证码已过期"</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">if</span> (!code.equals(findPswDto.getCheckcode())) {</span><br><span class="line">            log.info(<span class="string">"验证码错误"</span>);</span><br><span class="line">            XueChengPlusException.cast(<span class="string">"验证码已过期"</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> findPswDto.getPassword();</span><br><span class="line">        <span class="type">String</span> <span class="variable">confirmpwd</span> <span class="operator">=</span> findPswDto.getConfirmpwd();</span><br><span class="line">        <span class="keyword">if</span> (!password.equals(confirmpwd)) {</span><br><span class="line">            log.info(<span class="string">"两次密码不一致"</span>);</span><br><span class="line">            XueChengPlusException.cast(<span class="string">"两次密码不一致"</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">//修改密码</span></span><br><span class="line">        LambdaQueryWrapper&lt;XcUser&gt; wrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();</span><br><span class="line">        wrapper.eq(XcUser::getEmail,findPswDto.getEmail());</span><br><span class="line">        wrapper.eq(XcUser::getCellphone,findPswDto.getCellphone());</span><br><span class="line">        <span class="type">XcUser</span> <span class="variable">xcUser</span> <span class="operator">=</span> userMapper.selectOne(wrapper);</span><br><span class="line">        <span class="keyword">if</span> (xcUser == <span class="literal">null</span>) {</span><br><span class="line">            log.info(<span class="string">"用户不存在"</span>);</span><br><span class="line">            XueChengPlusException.cast(<span class="string">"用户不存在"</span>);</span><br><span class="line">        }</span><br><span class="line">        xcUser.setPassword(<span class="keyword">new</span> <span class="title class_">BCryptPasswordEncoder</span>().encode(password));</span><br><span class="line">        userMapper.updateById(xcUser);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h1 id="注册实战"><a class="markdownIt-Anchor" href="#注册实战"></a> 注册实战</h1>
<h2 id="注册接口文档"><a class="markdownIt-Anchor" href="#注册接口文档"></a> 注册接口文档</h2>
<p>需求：为学生提供注册入口，通过此入口注册的用户为学生用户。</p>
<p>界面访问地址：<a href="http://www.51xuecheng.cn/register.html">http://www.51xuecheng.cn/register.html</a></p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240304222553158.png" alt="image-20240304222553158"></p>
<p>接口：</p>
<p>手机验证码：/api/checkcode/phone?param1=手机号</p>
<p>注册：/api/auth/register</p>
<p>请求：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">{</span></span><br><span class="line">    cellphone<span class="punctuation">:</span>''<span class="punctuation">,</span></span><br><span class="line">    username<span class="punctuation">:</span>''<span class="punctuation">,</span></span><br><span class="line">    email<span class="punctuation">:</span>''<span class="punctuation">,</span></span><br><span class="line">    nickname<span class="punctuation">:</span>''<span class="punctuation">,</span></span><br><span class="line">    password<span class="punctuation">:</span>''<span class="punctuation">,</span></span><br><span class="line">    confirmpwd<span class="punctuation">:</span>''<span class="punctuation">,</span></span><br><span class="line">    checkcodekey<span class="punctuation">:</span>''<span class="punctuation">,</span></span><br><span class="line">    checkcode<span class="punctuation">:</span>''</span><br><span class="line"><span class="punctuation">}</span></span><br></pre></td></tr></table></figure>
<p>响应：</p>
<p>200: 注册成功</p>
<p>其它：注册失败，失败原因使用统一异常处理返回的信息格式</p>
<p>执行流程：</p>
<ol>
<li>
<p>校验验证码，如果不一致则抛出异常</p>
</li>
<li>
<p>校验两次密码是否一致，如果不一致则抛出异常</p>
</li>
<li>
<p>校验用户是否存在，如果存在则抛出异常</p>
</li>
<li>
<p>向用户表、用户角色关系表添加数据。角色为学生角色。</p>
</li>
</ol>
<h2 id="代码开发"><a class="markdownIt-Anchor" href="#代码开发"></a> 代码开发</h2>
<h3 id="1-准备dto类接受注册参数"><a class="markdownIt-Anchor" href="#1-准备dto类接受注册参数"></a> 1. 准备DTO类接受注册参数</h3>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RegisterDto</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String cellphone;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String checkcode;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String checkcodekey;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String confirmpwd;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String email;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String nickname;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h3 id="2-注册接口"><a class="markdownIt-Anchor" href="#2-注册接口"></a> 2. 注册接口</h3>
<p><strong>Controller层:</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@ApiOperation(value = "注册", tags = "注册")</span></span><br><span class="line"><span class="meta">@RequestMapping("/register")</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">register</span><span class="params">(<span class="meta">@RequestBody</span> RegisterDto registerDto)</span> {</span><br><span class="line">    verifyService.register(registerDto);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p><strong>Sevice接口:</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">VerifyService</span> {</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">register</span><span class="params">(RegisterDto registerDto)</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p><strong>Service接口实现类:</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">register</span><span class="params">(RegisterDto registerDto)</span> {</span><br><span class="line">    <span class="type">String</span> <span class="variable">id</span> <span class="operator">=</span> UUID.randomUUID().toString();</span><br><span class="line">    <span class="type">String</span> <span class="variable">email</span> <span class="operator">=</span> registerDto.getEmail();</span><br><span class="line">    <span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> registerDto.getPassword();</span><br><span class="line">    <span class="type">String</span> <span class="variable">confirmpwd</span> <span class="operator">=</span> registerDto.getConfirmpwd();</span><br><span class="line">    <span class="type">String</span> <span class="variable">checkcode</span> <span class="operator">=</span> registerDto.getCheckcode();</span><br><span class="line">    <span class="type">Boolean</span> <span class="variable">verify</span> <span class="operator">=</span> verify(email, checkcode);</span><br><span class="line">    <span class="comment">//验证码错误</span></span><br><span class="line">    <span class="keyword">if</span> ( !verify ) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">"验证码输入错误"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//两次密码不一致</span></span><br><span class="line">    <span class="keyword">if</span> ( !password.equals(confirmpwd) ) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">"两次密码不一致"</span>);</span><br><span class="line">    }</span><br><span class="line">    LambdaQueryWrapper&lt;XcUser&gt; wrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();</span><br><span class="line">    wrapper.eq(XcUser::getEmail, email);</span><br><span class="line">    <span class="type">XcUser</span> <span class="variable">xcUser</span> <span class="operator">=</span> userMapper.selectOne(wrapper);</span><br><span class="line">    <span class="keyword">if</span> ( xcUser != <span class="literal">null</span> ) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">"邮箱已被注册,一个账号只能有一个用户"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="type">XcUser</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XcUser</span>();</span><br><span class="line">    BeanUtils.copyProperties(registerDto, user);</span><br><span class="line">    user.setPassword(<span class="keyword">new</span> <span class="title class_">BCryptPasswordEncoder</span>().encode(password));</span><br><span class="line">    user.setId(id);</span><br><span class="line">    user.setUtype(<span class="string">"101001"</span>);</span><br><span class="line">    user.setStatus(<span class="string">"1"</span>);</span><br><span class="line">    user.setName(registerDto.getNickname());</span><br><span class="line">    user.setCreateTime(LocalDateTime.now());</span><br><span class="line">    user.setUpdateTime(LocalDateTime.now());</span><br><span class="line">    <span class="type">int</span> <span class="variable">insert</span> <span class="operator">=</span> userMapper.insert(user);</span><br><span class="line">    <span class="keyword">if</span> ( insert &lt;= <span class="number">0</span> ) {</span><br><span class="line">        XueChengPlusException.cast(<span class="string">"注册失败"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="type">XcUserRole</span> <span class="variable">userRole</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XcUserRole</span>();</span><br><span class="line">    userRole.setUserId(id);</span><br><span class="line">    userRole.setRoleId(<span class="string">"17"</span>);</span><br><span class="line">    userRole.setId(id);</span><br><span class="line">    userRole.setCreateTime(LocalDateTime.now());</span><br><span class="line">    <span class="type">int</span> <span class="variable">insert1</span> <span class="operator">=</span> userRoleMapper.insert(userRole);</span><br><span class="line">    <span class="keyword">if</span> ( insert1 &lt;= <span class="number">0</span> ) {</span><br><span class="line">        XueChengPlusException.cast(<span class="string">"注册失败"</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h3 id="3-问题整理"><a class="markdownIt-Anchor" href="#3-问题整理"></a> 3. 问题整理</h3>
<h3 id="31-spring-security问题"><a class="markdownIt-Anchor" href="#31-spring-security问题"></a> 3.1. Spring Security问题:</h3>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@ApiOperation(value = "修改密码", tags = "修改密码")</span></span><br><span class="line"><span class="meta">@RequestMapping("/findpassword")</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">verifyCode</span><span class="params">(<span class="meta">@RequestBody</span> FindPswDto findPswDto)</span> {</span><br><span class="line">    log.info(<span class="string">"修改密码:{}"</span>, findPswDto);</span><br><span class="line">    verifyService.findPassword(findPswDto);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@ApiOperation(value = "注册", tags = "注册")</span></span><br><span class="line"><span class="meta">@RequestMapping("/register")</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">register</span><span class="params">(<span class="meta">@RequestBody</span> RegisterDto registerDto)</span> {</span><br><span class="line">    verifyService.register(registerDto);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>这部分api接口一开始发送请求无论何种内容均会被返回403(Forbidden)</p>
<p>原因和<code>Spring Security</code>有关</p>
<p>在WebSecurityConfig中</p>
<p>原安全拦截机制代码如下:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//配置安全拦截机制</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">    http</span><br><span class="line">        .authorizeRequests()</span><br><span class="line">        .antMatchers(<span class="string">"/r/**"</span>).authenticated()<span class="comment">//访问/r开始的请求需要认证通过</span></span><br><span class="line">        .anyRequest().permitAll()<span class="comment">//其它请求全部放行</span></span><br><span class="line">        .and()</span><br><span class="line">        .formLogin().successForwardUrl(<span class="string">"/login-success"</span>);<span class="comment">//登录成功跳转到/login-success</span></span><br><span class="line">    http.logout().logoutUrl(<span class="string">"/logout"</span>);<span class="comment">//退出地址</span></span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>修改后的安全拦截机制如下:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">    http</span><br><span class="line">        .csrf().disable()</span><br><span class="line">        .authorizeRequests()</span><br><span class="line">        .anyRequest().permitAll()</span><br><span class="line">        .and()</span><br><span class="line">        .formLogin().successForwardUrl(<span class="string">"/login-success"</span>);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>可以看到<code>csrf().disable()</code>，我们让csrf失效使得注册和找回密码需求可以正常运行</p>
<h3 id="32-redis缓存提前删除"><a class="markdownIt-Anchor" href="#32-redis缓存提前删除"></a> 3.2 redis缓存提前删除</h3>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Boolean <span class="title function_">verify</span><span class="params">(String email, String checkcode)</span> {</span><br><span class="line">    <span class="comment">// 1. 从redis中获取缓存的验证码</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">codeInRedis</span> <span class="operator">=</span> redisTemplate.opsForValue().get(email);</span><br><span class="line">    <span class="comment">// 2. 判断是否与用户输入的一致</span></span><br><span class="line">    <span class="keyword">if</span> ( codeInRedis != <span class="literal">null</span> &amp;&amp; codeInRedis.equalsIgnoreCase(checkcode) ) {</span><br><span class="line">        redisTemplate.delete(email);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p><code>redisTemplate.delete(email);</code>由于在调用<code>verify</code>方法的方法中后续插入数据库可能导致失败，但是这步却成功了，导致删除了验证码却无法成功注册，只能重新生成验证码，可以考虑在结尾删除验证码</p>
<h3 id="33-smtp泄露"><a class="markdownIt-Anchor" href="#33-smtp泄露"></a> 3.3 SMTP泄露</h3>
<p>首先感谢Git邮件提醒</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240305091312405.png" alt="image-20240305091312405">、</p>
<p>解决方法就是通过nacos发布配置替代硬编码</p>
<h4 id="331-在nacos发布配置"><a class="markdownIt-Anchor" href="#331-在nacos发布配置"></a> 3.3.1 在nacos发布配置</h4>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">mail:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="string">smtp.**.com</span></span><br><span class="line">    <span class="attr">port:</span> <span class="string">**</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">*********@163.com</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">CZL**********XNY</span></span><br></pre></td></tr></table></figure>
<h4 id="332-设置配置读取配置类"><a class="markdownIt-Anchor" href="#332-设置配置读取配置类"></a> 3.3.2 设置配置读取配置类</h4>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MailSendConfigProperties</span> {</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(value = "${spring.mail.host}")</span></span><br><span class="line">    <span class="keyword">public</span> String host;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(value = "${spring.mail.port}")</span></span><br><span class="line">    <span class="keyword">public</span> String port;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(value = "${spring.mail.username}")</span></span><br><span class="line">    <span class="keyword">public</span> String username;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(value = "${spring.mail.password}")</span></span><br><span class="line">    <span class="keyword">public</span> String password;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p><code>@Configuration</code>即可，不用其他注解。</p>
<h4 id="333-工具类修改"><a class="markdownIt-Anchor" href="#333-工具类修改"></a> 3.3.3 工具类修改</h4>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MailUtil</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MailSendConfigProperties mailProperties;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> MailSendConfigProperties MailProperties;</span><br><span class="line">    <span class="comment">//提前读取配置文件</span></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span>{</span><br><span class="line">        <span class="comment">//        System.out.println("mailProperties.host = " + mailProperties.host);</span></span><br><span class="line">        <span class="comment">//        System.out.println("mailProperties.port = " + mailProperties.port);</span></span><br><span class="line">        <span class="comment">//        System.out.println("mailProperties.username = " + mailProperties.username);</span></span><br><span class="line">        <span class="comment">//        System.out.println("mailProperties.password = " + mailProperties.password);</span></span><br><span class="line">        MailProperties = mailProperties;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> MessagingException {</span><br><span class="line">        <span class="comment">//可以在这里直接测试方法，填自己的邮箱即可</span></span><br><span class="line">        sendTestMail(MailProperties.host, achieveCode());</span><br><span class="line">    }</span><br><span class="line">    ...</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<ul>
<li>
<p>首先将工具类加入<code>@Component</code>使得其可以进行自动注入</p>
</li>
<li>
<p>然后注入配置类并设置一个静态配置类</p>
</li>
<li>
<p>设置<code>init()</code>方法然后加上<code>@PostConStruct</code>注解使得其能在静态方法前加载完成</p>
</li>
<li>
<p>用<code>@PostConStruct</code>一定要在<code>bootstrap.yml</code>文件开启配置</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">main:</span></span><br><span class="line">	<span class="attr">allow-bean-definition-overriding:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h1 id="选课学习"><a class="markdownIt-Anchor" href="#选课学习"></a> 选课学习</h1>
<h1 id="模块需求分析"><a class="markdownIt-Anchor" href="#模块需求分析"></a> 模块需求分析</h1>
<h2 id="模块介绍"><a class="markdownIt-Anchor" href="#模块介绍"></a> 模块介绍</h2>
<p>本模块实现了学生选课、下单支付、学习的整体流程。</p>
<p>网站的课程有免费和收费两种，对于免费课程学生选课后可直接学习，对于收费课程学生需要下单且支付成功方可选课、学习。</p>
<p>选课：是将课程加入我的课程表的过程。</p>
<p>我的课程表：记录我在网站学习的课程，我的课程表中有免费课程和收费课程两种，对于免费课程可直接添加到我的课程表，对于收费课程需要下单、支付成功后自动加入我的课程表。</p>
<p>模块整体流程如下：</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240305165437866.png" alt="image-20240305165437866"></p>
<h2 id="业务流程"><a class="markdownIt-Anchor" href="#业务流程"></a> 业务流程</h2>
<h3 id="学习引导"><a class="markdownIt-Anchor" href="#学习引导"></a> 学习引导</h3>
<p>用户通过搜索课程、课程推荐等信息进入课程详情页面，点击“马上学习” 引导进入学习界面去学习。</p>
<p>流程如下：</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/clip_image002.gif" alt="img"></p>
<p>1、进入课程详情点击马上学习</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/clip_image004.gif" alt="img"></p>
<p>2、课程免费时引导加入我的课程表、或进入学习界面。</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/clip_image006.gif" alt="img"></p>
<p>3、课程收费时引导去支付、或试学。</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/clip_image008.gif" alt="img"></p>
<h3 id="选课流程"><a class="markdownIt-Anchor" href="#选课流程"></a> 选课流程</h3>
<p>选课是将课程加入我的课程表的过程。</p>
<p>对免费课程选课后可直接加入我的课程表，对收费课程选课后需要下单支付成功系统自动加入我的课程表。</p>
<p>流程如下：</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/clip_image010.gif" alt="img"></p>
<h3 id="支付流程"><a class="markdownIt-Anchor" href="#支付流程"></a> 支付流程</h3>
<p>本项目与第三方支付平台对接完成支付操作。</p>
<p>流程如下：</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/clip_image012.gif" alt="img"></p>
<h3 id="在线学习"><a class="markdownIt-Anchor" href="#在线学习"></a> 在线学习</h3>
<p>选课成功用户可以在线学习，对于免费课程无需选课即可在线学习。</p>
<p>流程如下：</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/clip_image014.gif" alt="img"></p>
<h3 id="免费课程续期"><a class="markdownIt-Anchor" href="#免费课程续期"></a> 免费课程续期</h3>
<p>免费课程加入我的课程表默认为1年有效期，到期用户可申请续期，流程如下：</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/clip_image016.gif" alt="img"></p>
<h1 id="添加选课"><a class="markdownIt-Anchor" href="#添加选课"></a> 添加选课</h1>
<h2 id="需求分析"><a class="markdownIt-Anchor" href="#需求分析"></a> 需求分析</h2>
<h3 id="数据模型"><a class="markdownIt-Anchor" href="#数据模型"></a> 数据模型</h3>
<p>选课是将课程加入我的课程表的过程，根据选课的业务流程进行详细分析，业务流程如下：</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/clip_image002.gif" alt="img"></p>
<p>选课信息存入选课记录表，免费课程被选课除了进入选课记录表同时进入我的课程表，收费课程进入选课记录表后需要经过下单、支付成功才可以进入我的课程表。</p>
<p>我的课程表记录了用户学习的课程，包括免费课程、收费课程（已经支付）。</p>
<p>1、选课记录表</p>
<p>当用户将课程添加到课程表时需要先创建选课记录。</p>
<p>结构如下：</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/clip_image004.gif" alt="img"></p>
<p>选课类型：免费课程、收费课程。</p>
<p>选课状态：选课成功、待支付、选课删除。</p>
<p>对于免费课程：课程价格为0，有效期默认365，开始服务时间为选课时间，结束服务时间为选课时间加1年后的时间，选课状态为选课成功。</p>
<p>对于收费课程：按课程的现价、有效期确定开始服务时间、结束服务时间，选课状态为待支付。</p>
<p>收费课程的选课记录需要支付成功后选课状态为成功。</p>
<p>2、我的课程表</p>
<p>我的课程表中记录了用户选课成功的课程，所以我的课程表的数据来源于选课记录表。</p>
<p>对于免费课程创建选课记录后同时向我的课程表添加记录。</p>
<p>对于收费课程创建选课记录后需要下单支付成功后自动向我的课程表添加记录。</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/clip_image006.gif" alt="img"></p>
<h3 id="执行流程"><a class="markdownIt-Anchor" href="#执行流程"></a> 执行流程</h3>
<pre class="mermaid">sequenceDiagram
    actor 用户
    用户 -&gt;&gt; 学习中心服务:添加选课
    学习中心服务 -&gt;&gt; 内容管理服务:查询课程信息
    内容管理服务 -&gt;&gt; 内容管理服务数据库:查询课程发布表
    学习中心服务 -&gt;&gt;学习中心服务:判断收费标准
    学习中心服务 -&gt;&gt; 学习中心数据库:免费课程:添加选课记录表及我的课程表
    学习中心服务 -&gt;&gt; 学习中心数据库:收费课程:添加选课记录表</pre>
<h2 id="接口开发"><a class="markdownIt-Anchor" href="#接口开发"></a> 接口开发</h2>
<h3 id="添加查询课程接口"><a class="markdownIt-Anchor" href="#添加查询课程接口"></a> 添加查询课程接口</h3>
<p><strong>Controller</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@description</span> 课程预览，发布，内部调用不用token</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> courseId 课程id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="meta">@ApiOperation("课程发布")</span></span><br><span class="line"><span class="meta">@PostMapping("/r/coursepublish/{courseId}")</span></span><br><span class="line"><span class="keyword">public</span> CoursePublish <span class="title function_">getCoursepublish</span><span class="params">(<span class="meta">@PathVariable("courseId")</span> Long courseId)</span> {</span><br><span class="line">    <span class="keyword">return</span> coursePublishService.getCoursePublish(courseId);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p><strong>Service接口</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">CoursePublish <span class="title function_">getCoursePublish</span><span class="params">(Long courseId)</span>;</span><br></pre></td></tr></table></figure>
<p><strong>Service实现方法</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> CoursePublish <span class="title function_">getCoursePublish</span><span class="params">(Long courseId)</span> {</span><br><span class="line">    <span class="keyword">return</span> coursePublishMapper.selectById(courseId);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>由于是在网关处进行令牌校验，所以在微服务处不再校验令牌的合法性，修改内容管理content-api工程的ResouceServerConfig类，屏蔽authenticated()。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">    http.csrf().disable()</span><br><span class="line">        .authorizeRequests()</span><br><span class="line">        <span class="comment">//          .antMatchers("/r/**","/course/**").authenticated()//所有/r/**的请求必须认证通过</span></span><br><span class="line">        .anyRequest().permitAll();</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>测试类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FeignClientTest</span> {</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    ContentServiceClient contentServiceClient;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testContentServiceClient</span><span class="params">()</span> {</span><br><span class="line">        <span class="type">CoursePublish</span> <span class="variable">coursepublish</span> <span class="operator">=</span> contentServiceClient.getCoursepublish(<span class="number">125L</span>);</span><br><span class="line">        Assertions.assertNotNull(coursepublish);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>在进行feign远程调用时会将字符串转成LocalDateTime，在CoursePublish 类中LocalDateTime的属性上边添加如下代码：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@JsonFormat(shape = JsonFormat.Shape.STRING,pattern = "yyyy-MM-dd HH:mm:ss")</span></span><br></pre></td></tr></table></figure>
<p><code>@JsonFormat说明:</code><br>
该注解可用于返回日期数据时的时间格式化。<br>
如果前端传来的为字符串格式的日期：“2022年07月29日 09时41分22秒”，则需要如下配置：<br>
@JsonFormat(pattern = “yyyy年MM月dd日 HH时mm分ss秒”)<br>
private Date createTime;</p>
<p>解析后存入DB中的则为：2022-07-29 09:41:22，而在查询时返回的数据则为：“2022年07月29日 09时41分22秒”</p>
<h3 id="添加选课接口"><a class="markdownIt-Anchor" href="#添加选课接口"></a> 添加选课接口</h3>
<h4 id="接口分析"><a class="markdownIt-Anchor" href="#接口分析"></a> 接口分析</h4>
<p>本接口支持免费课程选课、收费课程选课。</p>
<p>免费课程选课：添加选课记录、添加我的课程表。</p>
<p>收费课程选课：添加选课记录。</p>
<p><strong>接口定义</strong></p>
<p>1、请求参数：课程id、当前用户id</p>
<p>2、响应结果：选课记录信息、学习资格</p>
<h4 id="接口定义"><a class="markdownIt-Anchor" href="#接口定义"></a> 接口定义</h4>
<p>学习资格：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">{</span><span class="attr">"code"</span><span class="punctuation">:</span><span class="string">"702001"</span><span class="punctuation">,</span><span class="attr">"desc"</span><span class="punctuation">:</span><span class="string">"正常学习"</span><span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">{</span><span class="attr">"code"</span><span class="punctuation">:</span><span class="string">"702002"</span><span class="punctuation">,</span><span class="attr">"desc"</span><span class="punctuation">:</span><span class="string">"没有选课或选课后没有支付"</span><span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">{</span><span class="attr">"code"</span><span class="punctuation">:</span><span class="string">"702003"</span><span class="punctuation">,</span><span class="attr">"desc"</span><span class="punctuation">:</span><span class="string">"已过期需要申请续期或重新支付"</span><span class="punctuation">}</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></table></figure>
<p>接口定义如下：</p>
<p><strong>Controller</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@ApiOperation("添加选课")</span></span><br><span class="line"><span class="meta">@PostMapping("/choosecourse/{courseId}")</span></span><br><span class="line"><span class="keyword">public</span> XcChooseCourseDto <span class="title function_">addChooseCourse</span><span class="params">(<span class="meta">@PathVariable("courseId")</span> Long courseId)</span> {</span><br><span class="line">    <span class="comment">//获取用户信息</span></span><br><span class="line">    SecurityUtil.<span class="type">XcUser</span> <span class="variable">user</span> <span class="operator">=</span> SecurityUtil.getUser();</span><br><span class="line">    <span class="keyword">if</span>(user == <span class="literal">null</span>){</span><br><span class="line">        XueChengPlusException.cast(<span class="string">"请登录后再操作"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//获取用户id</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">userId</span> <span class="operator">=</span> user.getId();</span><br><span class="line">    <span class="comment">//选课</span></span><br><span class="line">    <span class="type">XcChooseCourseDto</span> <span class="variable">xcChooseCourseDto</span> <span class="operator">=</span> myCourseTableService.addChooseCourse(userId, courseId);</span><br><span class="line">    <span class="keyword">return</span> xcChooseCourseDto;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p><strong>Service接口</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MyCourseTableService</span> {</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userId   用户id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> courseId 课程id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> com.xuecheng.learning.model.dto.XcChooseCourseDto</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@description</span> 添加选课</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@date</span> 2022/10/24 17:33</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    XcChooseCourseDto <span class="title function_">addChooseCourse</span><span class="params">(String userId, Long courseId)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userId   用户id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> courseId 课程id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> com.xuecheng.learning.model.dto.XcCourseTablesDto</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@description</span> 查询学习资格，是否可以学习课程，是否已经选课，是否已经支付等等信息，返回给前端，前端根据这些信息决定是否可以学习课程，是否可以支付等等操作</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@date</span> 2022/10/24 17:33</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    XcCourseTablesDto <span class="title function_">getLearningStatus</span><span class="params">(String userId, Long courseId)</span>;</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p><strong>添加免费课程</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//添加免费课程,免费课程加入选课记录表、我的课程表</span></span><br><span class="line"><span class="keyword">public</span> XcChooseCourse <span class="title function_">addFreeCoruse</span><span class="params">(String userId, CoursePublish coursepublish)</span> {</span><br><span class="line">    <span class="comment">//如果存在免费选课记录且选课为成功状态,直接返回</span></span><br><span class="line">    LambdaQueryWrapper&lt;XcChooseCourse&gt; eq = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;XcChooseCourse&gt;()</span><br><span class="line">        .eq(XcChooseCourse::getUserId, userId)</span><br><span class="line">        .eq(XcChooseCourse::getCourseId, coursepublish.getId())</span><br><span class="line">        .eq(XcChooseCourse::getOrderType, <span class="string">"700001"</span>) <span class="comment">//免费课程</span></span><br><span class="line">        .eq(XcChooseCourse::getStatus, <span class="string">"701001"</span>);<span class="comment">//选课成功</span></span><br><span class="line">    List&lt;XcChooseCourse&gt; xcChooseCourses = xcChooseCourseMapper.selectList(eq);</span><br><span class="line">    <span class="comment">//同一个人同一门课程只能选一次,但数据库没有主键约束可能有多次,这里只取第一次</span></span><br><span class="line">    <span class="keyword">if</span>( !xcChooseCourses.isEmpty() ){</span><br><span class="line">        <span class="keyword">return</span> xcChooseCourses.get(<span class="number">0</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//向选课记录写数据</span></span><br><span class="line">    <span class="type">XcChooseCourse</span> <span class="variable">xcChooseCourse</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XcChooseCourse</span>();</span><br><span class="line">    xcChooseCourse.setCourseId(coursepublish.getId());</span><br><span class="line">    xcChooseCourse.setCourseName(coursepublish.getName());</span><br><span class="line">    xcChooseCourse.setUserId(userId);</span><br><span class="line">    xcChooseCourse.setCompanyId(coursepublish.getCompanyId());</span><br><span class="line">    xcChooseCourse.setOrderType(<span class="string">"700001"</span>);<span class="comment">//免费课程</span></span><br><span class="line">    xcChooseCourse.setCreateDate(LocalDateTime.now());</span><br><span class="line">    xcChooseCourse.setCoursePrice(coursepublish.getPrice());</span><br><span class="line">    xcChooseCourse.setValidDays(<span class="number">365</span>); <span class="comment">//暂时硬编码</span></span><br><span class="line">    xcChooseCourse.setStatus(<span class="string">"701001"</span>);<span class="comment">//选课成功</span></span><br><span class="line">    xcChooseCourse.setValidtimeStart(LocalDateTime.now());</span><br><span class="line">    xcChooseCourse.setValidtimeEnd(LocalDateTime.now().plusDays(<span class="number">365</span>));</span><br><span class="line">    <span class="type">int</span> <span class="variable">insert</span> <span class="operator">=</span> xcChooseCourseMapper.insert(xcChooseCourse);</span><br><span class="line">    <span class="keyword">if</span>( insert &lt;= <span class="number">0</span> ){</span><br><span class="line">        XueChengPlusException.cast(<span class="string">"添加选课失败"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> xcChooseCourse;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p><strong>添加收费课程</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//添加收费课程</span></span><br><span class="line"><span class="keyword">public</span> XcChooseCourse <span class="title function_">addChargeCoruse</span><span class="params">(String userId, CoursePublish coursepublish)</span> {</span><br><span class="line">    <span class="comment">//如果存在收费选课记录且选课状态为待支付，直接返回</span></span><br><span class="line">    LambdaQueryWrapper&lt;XcChooseCourse&gt; eq = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;XcChooseCourse&gt;()</span><br><span class="line">        .eq(XcChooseCourse::getUserId, userId)</span><br><span class="line">        .eq(XcChooseCourse::getCourseId, coursepublish.getId())</span><br><span class="line">        .eq(XcChooseCourse::getOrderType, <span class="string">"700002"</span>) <span class="comment">//收费课程</span></span><br><span class="line">        .eq(XcChooseCourse::getStatus, <span class="string">"701002"</span>);<span class="comment">//选课成功</span></span><br><span class="line">    List&lt;XcChooseCourse&gt; xcChooseCourses = xcChooseCourseMapper.selectList(eq);</span><br><span class="line">    <span class="comment">//同一个人同一门课程只能选一次,但数据库没有主键约束可能有多次,这里只取第一次</span></span><br><span class="line">    <span class="keyword">if</span>( !xcChooseCourses.isEmpty() ){</span><br><span class="line">        <span class="keyword">return</span> xcChooseCourses.get(<span class="number">0</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//向选课记录写数据</span></span><br><span class="line">    <span class="type">XcChooseCourse</span> <span class="variable">xcChooseCourse</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XcChooseCourse</span>();</span><br><span class="line">    xcChooseCourse.setCourseId(coursepublish.getId());</span><br><span class="line">    xcChooseCourse.setCourseName(coursepublish.getName());</span><br><span class="line">    xcChooseCourse.setUserId(userId);</span><br><span class="line">    xcChooseCourse.setCompanyId(coursepublish.getCompanyId());</span><br><span class="line">    xcChooseCourse.setOrderType(<span class="string">"700002"</span>);<span class="comment">//免费课程</span></span><br><span class="line">    xcChooseCourse.setCreateDate(LocalDateTime.now());</span><br><span class="line">    xcChooseCourse.setCoursePrice(coursepublish.getPrice());</span><br><span class="line">    xcChooseCourse.setValidDays(<span class="number">365</span>); <span class="comment">//暂时硬编码</span></span><br><span class="line">    xcChooseCourse.setStatus(<span class="string">"701002"</span>);<span class="comment">//选课成功</span></span><br><span class="line">    xcChooseCourse.setValidtimeStart(LocalDateTime.now());</span><br><span class="line">    xcChooseCourse.setValidtimeEnd(LocalDateTime.now().plusDays(<span class="number">365</span>));</span><br><span class="line">    <span class="type">int</span> <span class="variable">insert</span> <span class="operator">=</span> xcChooseCourseMapper.insert(xcChooseCourse);</span><br><span class="line">    <span class="keyword">if</span>( insert &lt;= <span class="number">0</span> ){</span><br><span class="line">        XueChengPlusException.cast(<span class="string">"添加选课失败"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> xcChooseCourse;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p><strong>添加到我的课程表:</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//添加到我的课程表</span></span><br><span class="line"><span class="keyword">public</span> XcCourseTables <span class="title function_">addCourseTabls</span><span class="params">(XcChooseCourse xcChooseCourse)</span> {</span><br><span class="line">    <span class="comment">//选课成功才能向我的课程表添加数据</span></span><br><span class="line">    <span class="keyword">if</span>( !xcChooseCourse.getStatus().equals(<span class="string">"701001"</span>) ){</span><br><span class="line">        XueChengPlusException.cast(<span class="string">"选课失败,无法添加到我的课程表"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="type">XcCourseTables</span> <span class="variable">xcCourseTables</span> <span class="operator">=</span> getXcCourseTables(xcChooseCourse.getUserId(), xcChooseCourse.getCourseId());</span><br><span class="line">    <span class="keyword">if</span>( xcCourseTables != <span class="literal">null</span> ){</span><br><span class="line">        <span class="keyword">return</span> xcCourseTables;</span><br><span class="line">    }</span><br><span class="line">    xcCourseTables = <span class="keyword">new</span> <span class="title class_">XcCourseTables</span>();</span><br><span class="line">    BeanUtils.copyProperties(xcChooseCourse, xcCourseTables);</span><br><span class="line">    xcCourseTables.setChooseCourseId(xcChooseCourse.getId());<span class="comment">//记录选课记录id</span></span><br><span class="line">    xcCourseTables.setCourseType(xcChooseCourse.getOrderType());<span class="comment">//课程类型</span></span><br><span class="line">    xcCourseTables.setUpdateDate(LocalDateTime.now());</span><br><span class="line">    <span class="type">int</span> <span class="variable">insert</span> <span class="operator">=</span> xcCourseTablesMapper.insert(xcCourseTables);</span><br><span class="line">    <span class="keyword">if</span>( insert &lt;= <span class="number">0</span> ){</span><br><span class="line">        XueChengPlusException.cast(<span class="string">"添加我的课程表失败"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> xcCourseTables;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p><strong>获取学习资格</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> XcCourseTablesDto <span class="title function_">getLearningStatus</span><span class="params">(String userId, Long courseId)</span> {</span><br><span class="line">    <span class="comment">//查询我的课程表,查不到说明没有资格学习</span></span><br><span class="line">    <span class="type">XcCourseTables</span> <span class="variable">xcCourseTables</span> <span class="operator">=</span> getXcCourseTables(userId, courseId);</span><br><span class="line">    <span class="comment">//最终返回结果</span></span><br><span class="line">    <span class="type">XcCourseTablesDto</span> <span class="variable">xcCourseTablesDto</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XcCourseTablesDto</span>();</span><br><span class="line">    <span class="keyword">if</span>( xcCourseTables == <span class="literal">null</span> ){</span><br><span class="line">        <span class="comment">//{"code":"702002","desc":"没有选课或选课后没有支付"}</span></span><br><span class="line">        xcCourseTablesDto.setLearnStatus(<span class="string">"702002"</span>);</span><br><span class="line">        <span class="keyword">return</span> xcCourseTablesDto;</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//查询到了之后,判断是否过期</span></span><br><span class="line">    <span class="type">LocalDateTime</span> <span class="variable">validtimeEnd</span> <span class="operator">=</span> xcCourseTables.getValidtimeEnd();</span><br><span class="line">    <span class="keyword">if</span>( validtimeEnd.isBefore(LocalDateTime.now()) ){</span><br><span class="line">        <span class="comment">//{"code":"702003","desc":"选课已过期"}</span></span><br><span class="line">        xcCourseTablesDto.setLearnStatus(<span class="string">"702003"</span>);</span><br><span class="line">        BeanUtils.copyProperties(xcCourseTables, xcCourseTablesDto);</span><br><span class="line">    }<span class="keyword">else</span>{</span><br><span class="line">        xcCourseTablesDto.setLearnStatus(<span class="string">"702001"</span>);</span><br><span class="line">        BeanUtils.copyProperties(xcCourseTables, xcCourseTablesDto);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> xcCourseTablesDto;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p><strong>addChooseCourse接口完善</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> XcChooseCourseDto <span class="title function_">addChooseCourse</span><span class="params">(String userId, Long courseId)</span> {</span><br><span class="line">    <span class="comment">//远程调用服务查看课程收费规则</span></span><br><span class="line">    <span class="type">CoursePublish</span> <span class="variable">coursepublish</span> <span class="operator">=</span> contentServiceClient.getCoursepublish(courseId);</span><br><span class="line">    <span class="keyword">if</span> ( coursepublish == <span class="literal">null</span> ) {</span><br><span class="line">        <span class="comment">//课程不存在</span></span><br><span class="line">        XueChengPlusException.cast(<span class="string">"课程不存在"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//获取收费规则</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">charge</span> <span class="operator">=</span> coursepublish.getCharge();</span><br><span class="line">    <span class="type">XcChooseCourse</span> <span class="variable">xcChooseCourse</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> ( charge.equals(<span class="string">"201000"</span>) ) {</span><br><span class="line">        <span class="comment">//免费课程</span></span><br><span class="line">        <span class="comment">//向选课记录表添加数据</span></span><br><span class="line">        xcChooseCourse = addFreeCoruse(userId, coursepublish);</span><br><span class="line">        <span class="comment">//向我的课程表添加数据</span></span><br><span class="line">        <span class="type">XcCourseTables</span> <span class="variable">xcCourseTables</span> <span class="operator">=</span> addCourseTabls(xcChooseCourse);</span><br><span class="line"></span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        <span class="comment">//收费课程</span></span><br><span class="line">        <span class="comment">//向选课记录表添加数据</span></span><br><span class="line">        xcChooseCourse = addChargeCoruse(userId, coursepublish);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//判断学生学习资格</span></span><br><span class="line">    <span class="type">XcCourseTablesDto</span> <span class="variable">learningStatus</span> <span class="operator">=</span> getLearningStatus(userId, courseId);</span><br><span class="line">    <span class="comment">//构造返回结果</span></span><br><span class="line">    <span class="type">XcChooseCourseDto</span> <span class="variable">xcChooseCourseDto</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XcChooseCourseDto</span>();</span><br><span class="line">    BeanUtils.copyProperties(xcChooseCourse, xcChooseCourseDto);</span><br><span class="line">    <span class="comment">//设置学习状态</span></span><br><span class="line">    xcChooseCourseDto.setLearnStatus(learningStatus.getLearnStatus());</span><br><span class="line">    <span class="keyword">return</span> xcChooseCourseDto;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p><strong>Controller查询学习资格接口</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@ApiOperation("查询学习资格")</span></span><br><span class="line"><span class="meta">@PostMapping("/choosecourse/learnstatus/{courseId}")</span></span><br><span class="line"><span class="keyword">public</span> XcCourseTablesDto <span class="title function_">getLearnstatus</span><span class="params">(<span class="meta">@PathVariable("courseId")</span> Long courseId)</span> {</span><br><span class="line">    <span class="comment">//获取用户信息</span></span><br><span class="line">    SecurityUtil.<span class="type">XcUser</span> <span class="variable">user</span> <span class="operator">=</span> SecurityUtil.getUser();</span><br><span class="line">    <span class="keyword">if</span>(user == <span class="literal">null</span>){</span><br><span class="line">        XueChengPlusException.cast(<span class="string">"请登录后再操作"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//获取用户id</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">userId</span> <span class="operator">=</span> user.getId();</span><br><span class="line">    <span class="comment">//查询学习状态</span></span><br><span class="line">    <span class="keyword">return</span> myCourseTableService.getLearningStatus(userId, courseId);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h2 id="接口测试"><a class="markdownIt-Anchor" href="#接口测试"></a> 接口测试</h2>
<p>测试通过,这里就不截图了</p>
<h1 id="支付"><a class="markdownIt-Anchor" href="#支付"></a> 支付</h1>
<h2 id="需求分析-2"><a class="markdownIt-Anchor" href="#需求分析-2"></a> 需求分析</h2>
<h3 id="执行流程-2"><a class="markdownIt-Anchor" href="#执行流程-2"></a> 执行流程</h3>
<p>用户去学习收费课程时引导其去支付，如下图：</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240305194230135.png" alt="image-20240305194230135"></p>
<p>当用户点击“微信支付”或支付宝支付时执行流程如下：</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240305193754785.png" alt="image-20240305193754785"></p>
<ol>
<li>
<p>请求学习中心服务创建选课记录</p>
</li>
<li>
<p>请求订单服务创建商品订单、生成支付二维码。</p>
</li>
<li>
<p>用户扫码请求订单支付服务，订单支付服务请求第三方支付平台生成支付订单。</p>
</li>
<li>
<p>前端唤起支付客户端，用户输入密码完成支付。</p>
</li>
<li>
<p>第三方支付平台支付完成发起支付通知。</p>
</li>
<li>
<p>订单支付服务接收第三方支付通知结果。</p>
</li>
<li>
<p>用户在前端查询支付结果，请求订单支付服务查询支付结果。</p>
</li>
<li>
<p>订单支付服务向学习中心服务通知支付结果。</p>
</li>
<li>
<p>学习中心服务收到支付结果，如果支付成功则更新选课记录，并添加到我的课程表。</p>
</li>
</ol>
<h3 id="通用订单服务设计"><a class="markdownIt-Anchor" href="#通用订单服务设计"></a> 通用订单服务设计</h3>
<p>在本项目中不仅选课需要下单、购买学习资料、老师一对一答疑等所以收费项目都需要下单支付。</p>
<p>所以本项目设计通用的订单服务，通用的订单服务承接各业务模块的收费支付需求，当用户需要交费时统一生成商品订单并进行支付。</p>
<img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240305194312750.png" alt="image-20240305194312750" style="zoom:50%;">
<p>所有收费业务最终转换为商品订单记录在订单服务的商品订单表。</p>
<img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240305194344834.png" alt="image-20240305194344834" style="zoom:50%;">
<p>以选课为例，选课记录表的ID记录在商品订单表的out_business_id字段。</p>
<img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240305194407191.png" alt="image-20240305194407191" style="zoom:50%;">
<h2 id="支付接口调研"><a class="markdownIt-Anchor" href="#支付接口调研"></a> 支付接口调研</h2>
<h3 id="微信支付接口调研"><a class="markdownIt-Anchor" href="#微信支付接口调研"></a> 微信支付接口调研</h3>
<p>一般情况下，一个网站要支持在线支付功能通常接入第三方支付平台，比如：微信支付、支付宝、其它的聚合支付平台。</p>
<p>本项目的需求实现手机扫码支付，现在对微信、支付宝的支付接口进行调研。</p>
<p>微信目前提供的支付方式如下：</p>
<p>地址：<a href="https://pay.weixin.qq.com/static/product/product_index.shtml">https://pay.weixin.qq.com/static/product/product_index.shtml</a></p>
<p>![img](file:///C:/Users/Wwhds/AppData/Local/Temp/msohtmlclip1/01/clip_image002.gif)</p>
<p>1、付款码支付是指用户展示微信钱包内的“付款码”给商户系统扫描后直接完成支付，适用于线下场所面对面收银的场景，例如商超、便利店、餐饮、医院、学校、电影院和旅游景区等具有明确经营地址的实体场所。</p>
<p>![img](file:///C:/Users/Wwhds/AppData/Local/Temp/msohtmlclip1/01/clip_image004.gif)</p>
<p>2、JSAPI支付是指商户通过调用微信支付提供的JSAPI接口，在支付场景中调起微信支付模块完成收款</p>
<p>线下场所：调用接口生成二维码，用户扫描二维码后在微信浏览器中打开页面后完成支付</p>
<p>公众号场景：用户在微信公众账号内进入商家公众号，打开某个主页面，完成支付</p>
<p>PC网站场景：在网站中展示二维码，用户扫描二维码后在微信浏览器中打开页面后完成支付</p>
<p>![img](file:///C:/Users/Wwhds/AppData/Local/Temp/msohtmlclip1/01/clip_image006.gif)</p>
<p>3、小程序支付是指商户通过调用微信支付小程序支付接口，在微信小程序平台内实现支付功能；用户打开商家助手小程序下单，输入支付密码并完成支付后，返回商家小程序。</p>
<p>![img](file:///C:/Users/Wwhds/AppData/Local/Temp/msohtmlclip1/01/clip_image008.gif)</p>
<p>4、Native支付是指商户系统按微信支付协议生成支付二维码，用户再用微信“扫一扫”完成支付的模式。该模式适用于PC网站、实体店单品或订单、媒体广告支付等场景。</p>
<p>![img](file:///C:/Users/Wwhds/AppData/Local/Temp/msohtmlclip1/01/clip_image010.gif)</p>
<p>5、APP支付是指商户通过在移动端应用APP中集成开放SDK调起微信支付模块来完成支付。适用于在移动端APP中集成微信支付功能的场景。</p>
<p>![img](file:///C:/Users/Wwhds/AppData/Local/Temp/msohtmlclip1/01/clip_image012.gif)</p>
<p>6、刷脸支付是指用户在刷脸设备前通过摄像头刷脸、识别身份后进行的一种支付方式，安全便捷。适用于线下实体场所的收银场景，如商超、餐饮、便利店、医院、学校等。</p>
<p>![img](file:///C:/Users/Wwhds/AppData/Local/Temp/msohtmlclip1/01/clip_image014.gif)</p>
<p>以上接口native和JSAPI都可以实现pc网站实现扫码支付，两者区别是什么？怎么选择？</p>
<p>JSAPI除了在pc网站扫码支付还可以实现公众号页面内支付，可以实现在手机端H5页面唤起微信客户端完成支付。</p>
<p>本项目选择JSAPI支付接口。</p>
<p>接口文档：<a href="https://pay.weixin.qq.com/wiki/doc/apiv3/apis/chapter3_1_1.shtml">https://pay.weixin.qq.com/wiki/doc/apiv3/apis/chapter3_1_1.shtml</a></p>
<p>如何开通JSAPI支付接口?</p>
<p>以企业身份注册微信公众号https://mp.weixin.qq.com/</p>
<p>![img](file:///C:/Users/Wwhds/AppData/Local/Temp/msohtmlclip1/01/clip_image016.gif)</p>
<p>登录公众号，点击左侧菜单“微信支付”开通微信支付，如下：</p>
<p>需要提供营业执照、身份证等信息。</p>
<p>![img](file:///C:/Users/Wwhds/AppData/Local/Temp/msohtmlclip1/01/clip_image018.gif)</p>
<p>点击申请接入，需要注册微信商户号。</p>
<p>![img](file:///C:/Users/Wwhds/AppData/Local/Temp/msohtmlclip1/01/clip_image020.gif)</p>
<p>注册微信商户号的过程请参考官方文档，本文档略。参考地址如下：</p>
<p><a href="https://pay.weixin.qq.com/index.php/apply/applyment_home/guide_normal#none">https://pay.weixin.qq.com/index.php/apply/applyment_home/guide_normal#none</a></p>
<p>开通微信支付后即可在微信商户平台（<a href="http://pay.weixin.qq.com">pay.weixin.qq.com</a>）开通JSAPI支付。</p>
<p>登录商品平台，进入产品中心，开通JSAPI支付：</p>
<p>![img](file:///C:/Users/Wwhds/AppData/Local/Temp/msohtmlclip1/01/clip_image022.gif)</p>
<p>注意：JSAPI支付方式需要在公众号配置回调域名，此域名为已经备案的外网域名。</p>
<p>最后在公众号开发信息中获取：开发者id、开发者密码。</p>
<h3 id="支付宝接口调研"><a class="markdownIt-Anchor" href="#支付宝接口调研"></a> 支付宝接口调研</h3>
<p>支付宝支付产品如下：</p>
<p>文档：<a href="https://b.alipay.com/signing/productSetV2.htm">https://b.alipay.com/signing/productSetV2.htm</a></p>
<p>与本项目需求相关的接口：电脑网站支付、手机网站支付。</p>
<p>1、电脑网站支付</p>
<p>PC网站轻松收款，资金马上到账：用户在商家PC网站消费，自动跳转支付宝PC网站收银台完成付款。 交易资金直接打入商家支付宝账户，实时到账。</p>
<p>2、手机网站支付</p>
<p>用户在商家手机网站消费，通过浏览器自动跳转支付宝APP或支付宝网页完成付款。 轻松实现和APP支付相同的支付体验。</p>
<p>对比两种支付方式：手机网站支付方式可以在H5网页唤起支付宝，手机扫码支付可以使用手机网站支付方式来完成，相比电脑网站支付形式更灵活。</p>
<p>本项目选择手机网站支付方式。</p>
<p>文档：<a href="https://opendocs.alipay.com/open/02ivbt">https://opendocs.alipay.com/open/02ivbt</a></p>
<p>如何开通支付宝手机网站支付接口？</p>
<p>进入网址：<a href="https://b.alipay.com/signing/productDetailV2.htm?productId=I1011000290000001001">https://b.alipay.com/signing/productDetailV2.htm?productId=I1011000290000001001</a></p>
<p>点击：立即开通</p>
<p>上传营业执照等资料，提交审核，根据提示进行开通。</p>
<h2 id="支付接口测试"><a class="markdownIt-Anchor" href="#支付接口测试"></a> 支付接口测试</h2>
<h3 id="接口定义-2"><a class="markdownIt-Anchor" href="#接口定义-2"></a> 接口定义</h3>
<ol>
<li>支付宝支付接口交互流程如图:</li>
</ol>
<p>​	<img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240305202331887.png" alt="image-20240305202331887" style="zoom: 50%;"></p>
<ol>
<li>
<p>用户在商户的H5网站下单支付后，商户系统按照<a href="https://docs.open.alipay.com/203/107090">手机网站支付接口alipay.trade.wap.pay</a>API的参数规范生成订单数据</p>
</li>
<li>
<p>前端页面通过Form表单的形式请求到支付宝。此时支付宝会自动将页面跳转至支付宝H5收银台页面，如果用户手机上安装了支付宝APP，则自动唤起支付宝APP。</p>
</li>
<li>
<p>输入支付密码完成支付。</p>
</li>
<li>
<p>用户在支付宝APP或H5收银台完成支付后，会根据商户在手机网站支付API中传入的前台回跳地址return_url自动跳转回商户页面，同时在URL请求中以Query String的形式附带上支付结果参数，详细回跳参数见“手机网站支付接口alipay.trade.wap.pay”<a href="https://docs.open.alipay.com/203/107090#s2">前台回跳参数</a>。</p>
</li>
<li>
<p>支付宝还会根据原始支付API中传入的异步通知地址notify_url，通过POST请求的形式将支付结果作为参数通知到商户系统，详情见<a href="https://docs.open.alipay.com/203/105286">支付结果异步通知</a>。</p>
</li>
<li>
<p>接口定义</p>
</li>
</ol>
<p>文档：<a href="https://opendocs.alipay.com/open/203/107090">https://opendocs.alipay.com/open/203/107090</a></p>
<p>接口定义：外部商户请求支付宝创建订单并支付</p>
<p>公共参数</p>
<p><strong>请求地址</strong>：</p>
<p>开发中使用沙箱地址：<a href="https://openapi.alipaydev.com/gateway.do">https://openapi.alipaydev.com/gateway.do</a></p>
<p>请求参数：</p>
<p>详细查阅https://opendocs.alipay.com/open/203/107090</p>
<p>一部分由sdk设置，一部分需要编写程序时指定。</p>
<ol start="3">
<li>
<p>示例代码</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doPost</span><span class="params">(HttpServletRequest httpRequest,</span></span><br><span class="line"><span class="params">                   HttpServletResponse httpResponse)</span> <span class="keyword">throws</span> ServletException, IOException {</span><br><span class="line">    <span class="type">AlipayClient</span> <span class="variable">alipayClient</span> <span class="operator">=</span> ... <span class="comment">//获得初始化的AlipayClient</span></span><br><span class="line">        <span class="type">AlipayTradeWapPayRequest</span> <span class="variable">alipayRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AlipayTradeWapPayRequest</span>();<span class="comment">//创建API对应的request</span></span><br><span class="line">    alipayRequest.setReturnUrl(<span class="string">"http://domain.com/CallBack/return_url.jsp"</span>);</span><br><span class="line">    alipayRequest.setNotifyUrl(<span class="string">"http://domain.com/CallBack/notify_url.jsp"</span>);<span class="comment">//在公共参数中设置回跳和通知地址</span></span><br><span class="line">    alipayRequest.setBizContent(<span class="string">"{"</span> +</span><br><span class="line">                                <span class="string">"    \"out_trade_no\":\"20150320010101002\","</span> +</span><br><span class="line">                                <span class="string">"    \"total_amount\":88.88,"</span> +</span><br><span class="line">                                <span class="string">"    \"subject\":\"Iphone6 16G\","</span> +</span><br><span class="line">                                <span class="string">"    \"product_code\":\"QUICK_WAP_WAY\""</span> +</span><br><span class="line">                                <span class="string">"  }"</span>);<span class="comment">//填充业务参数</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">form</span> <span class="operator">=</span> alipayClient.pageExecute(alipayRequest).getBody(); <span class="comment">//调用SDK生成表单</span></span><br><span class="line">    httpResponse.setContentType(<span class="string">"text/html;charset="</span> + AlipayServiceEnvConstants.CHARSET);</span><br><span class="line">    httpResponse.getWriter().write(form);<span class="comment">//直接将完整的表单html输出到页面</span></span><br><span class="line">    httpResponse.getWriter().flush();</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="下单执行流程"><a class="markdownIt-Anchor" href="#下单执行流程"></a> 下单执行流程</h3>
<p>根据接口描述，支付宝下单接口的执行流程如下：</p>
   <img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240305203331675.png" alt="image-20240305203331675" style="zoom:50%;">
<h3 id="支付接口测试-2"><a class="markdownIt-Anchor" href="#支付接口测试-2"></a> 支付接口测试</h3>
<h4 id="编写下单代码"><a class="markdownIt-Anchor" href="#编写下单代码"></a> 编写下单代码</h4>
<p><strong>maven依赖:</strong></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 支付宝SDK --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alipay.sdk<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>alipay-sdk-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.34.0.ALL<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 支付宝SDK依赖的日志 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-logging<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-logging<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>下载示例代码https://opendocs.alipay.com/open/203/105910</p>
<p>拷贝示例代码，修改、测试。</p>
<p>编写测试Controller:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.orders.api;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alipay.api.AlipayApiException;</span><br><span class="line"><span class="keyword">import</span> com.alipay.api.AlipayClient;</span><br><span class="line"><span class="keyword">import</span> com.alipay.api.DefaultAlipayClient;</span><br><span class="line"><span class="keyword">import</span> com.alipay.api.request.AlipayTradeWapPayRequest;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.orders.config.AlipayConfig;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PayTestController</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value("${pay.alipay.APP_ID}")</span></span><br><span class="line">    String APP_ID;</span><br><span class="line">    <span class="meta">@Value("${pay.alipay.APP_PRIVATE_KEY}")</span></span><br><span class="line">    String APP_PRIVATE_KEY;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value("${pay.alipay.ALIPAY_PUBLIC_KEY}")</span></span><br><span class="line">    String ALIPAY_PUBLIC_KEY;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping("/alipaytest")</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doPost</span><span class="params">(HttpServletRequest httpRequest,</span></span><br><span class="line"><span class="params">                       HttpServletResponse httpResponse)</span> <span class="keyword">throws</span> ServletException, IOException, AlipayApiException {</span><br><span class="line">        <span class="type">AlipayClient</span> <span class="variable">alipayClient</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultAlipayClient</span>(AlipayConfig.URL, APP_ID, APP_PRIVATE_KEY, AlipayConfig.FORMAT, AlipayConfig.CHARSET, ALIPAY_PUBLIC_KEY,AlipayConfig.SIGNTYPE);</span><br><span class="line">        <span class="comment">//获得初始化的AlipayClient</span></span><br><span class="line">        <span class="type">AlipayTradeWapPayRequest</span> <span class="variable">alipayRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AlipayTradeWapPayRequest</span>();<span class="comment">//创建API对应的request</span></span><br><span class="line">        <span class="comment">//        alipayRequest.setReturnUrl("http://domain.com/CallBack/return_url.jsp");</span></span><br><span class="line">        <span class="comment">//        alipayRequest.setNotifyUrl("http://domain.com/CallBack/notify_url.jsp");//在公共参数中设置回跳和通知地址</span></span><br><span class="line">        alipayRequest.setBizContent(<span class="string">"{"</span> +</span><br><span class="line">                                    <span class="string">"    \"out_trade_no\":\"202210100010101002\","</span> +</span><br><span class="line">                                    <span class="string">"    \"total_amount\":0.1,"</span> +</span><br><span class="line">                                    <span class="string">"    \"subject\":\"Iphone6 16G\","</span> +</span><br><span class="line">                                    <span class="string">"    \"product_code\":\"QUICK_WAP_WAY\""</span> +</span><br><span class="line">                                    <span class="string">"  }"</span>);<span class="comment">//填充业务参数</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">form</span> <span class="operator">=</span> alipayClient.pageExecute(alipayRequest).getBody(); <span class="comment">//调用SDK生成表单</span></span><br><span class="line">        httpResponse.setContentType(<span class="string">"text/html;charset="</span> + AlipayConfig.CHARSET);</span><br><span class="line">        httpResponse.getWriter().write(form);<span class="comment">//直接将完整的表单html输出到页面</span></span><br><span class="line">        httpResponse.getWriter().flush();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h4 id="生成二维码"><a class="markdownIt-Anchor" href="#生成二维码"></a> 生成二维码</h4>
<p>用户在前端使用支付宝沙箱通过扫码请求下单接口，我们需要生成订单服务的下单接口的二维码。</p>
<p>ZXing是一个开源的类库，是用Java编写的多格式的1D / 2D条码图像处理库，使用ZXing可以生成、识别QR Code（二维码）。常用的二维码处理库还有zbar，近几年已经不再更新代码，下边介绍ZXing生成二维码的方法。</p>
<ol>
<li>引入依赖</li>
</ol>
<p>在base工程pom.xml中添加依赖：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 二维码生成&amp;识别组件 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.google.zxing<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.3.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.google.zxing<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javase<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.3.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-lang3<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ol start="2">
<li>
<p>生成二维码方法</p>
<p>拷贝课程资料中utils下的QRCodeUtil.java到base工程util包下。</p>
<p>在QRCodeUtil中添加main方法如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException {</span><br><span class="line">    <span class="type">QRCodeUtil</span> <span class="variable">qrCodeUtil</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">QRCodeUtil</span>();</span><br><span class="line">    System.out.println(qrCodeUtil.createQRCode(<span class="string">"http://www.itcast.cn/"</span>, <span class="number">200</span>, <span class="number">200</span>));</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>运行main方法输入二维码图片的base64串，如下：</p>
<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADIAQAAAACFI5MzAAABX0lEQVR42u2YS46EMAxEzYpjcFNIbppjZBWPqxJDC2k2o5HsRSNEQx4L40/ZadHfDvmSP5Iudmxdzr2JHNqPgoUjBznMxKo6jCug3WMxByl4arJrAdTa7SMykS4XoT3mI7gORjsVQbR9oez6yoNQMqvkqH6+6yeQzMM4M/Hc37oTSfpSlMuK2AQGGiOX+zqa2K+cIO2kBG799nU0cXfWJTNPJsYTN9mScdCdFvAhSQgquCANQbDMMwmpM+A0eUb7XFZHE8Z2BpmyZ/kIjUlBsGyOhC+heTvDLnkIjIWi2BVfgbeSkAKT2zWDzKbhVkeTOS7p0y6GrCkgA7lrF36lO93qaLIkmYJHv350s2jiU8BGeysbryYhPj1BmLnReabOeLJ2OQWjOn2JtqZJyJzWdfUKmXvERIT7QrspzMctF0HVDpqMapYshNFewrxRBUcWcldJ89HYp6dw8v2/6n/JD+4QqzIB2cR3AAAAAElFTkSuQmCC</span><br></pre></td></tr></table></figure>
<p>将base64串复制到浏览器地址后回车将展示一个二维码，用户用手机扫此二维码将请求至http://www.itcast.cn/。</p>
</li>
</ol>
<h4 id="接口测试-2"><a class="markdownIt-Anchor" href="#接口测试-2"></a> 接口测试</h4>
<ol>
<li>生成订单服务下单接口的二维码</li>
</ol>
<p>修改二维码生成的代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException {</span><br><span class="line">    <span class="type">QRCodeUtil</span> <span class="variable">qrCodeUtil</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">QRCodeUtil</span>();</span><br><span class="line">    System.out.println(qrCodeUtil.createQRCode(<span class="string">"http://localhost:63030/orders/alipaytest"</span>, <span class="number">200</span>, <span class="number">200</span>));</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>注意：http://localhost:63030地址用模拟器无法访问，进入cmd命令状态，输入命令ipconfig -all 查看本地网卡分配的局域网ip地址，将上边的地址修改如下：</p>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line">http://192.168.1.8:63030/orders/alipaytest</span><br></pre></td></tr></table></figure>
<p>除此之外</p>
<p>支付宝目前沙箱APP需要更新</p>
<p>在Order模块中的service中</p>
<p>请求网关地址于2023年某月更新</p>
<p>原配置失效,作如下修改</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 旧请求网关地址</span></span><br><span class="line"><span class="comment">//public static String URL = "https://openapi.alipaydev.com/gateway.do";</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 新请求网关地址</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">URL</span> <span class="operator">=</span> <span class="string">"https://openapi-sandbox.dl.alipaydev.com/gateway.do"</span>;</span><br></pre></td></tr></table></figure>
<p>以及最好在手机安装沙箱app来操作,模拟器会因不知名原因导致只能扫出来代码</p>
<h3 id="支付结果查询接口"><a class="markdownIt-Anchor" href="#支付结果查询接口"></a> 支付结果查询接口</h3>
<p>文档:<a href="https://opendocs.alipay.com/open/02ivbt">https://opendocs.alipay.com/open/02ivbt</a></p>
<p>示例代码：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">AlipayClient</span> <span class="variable">alipayClient</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultAlipayClient</span>(<span class="string">"https://openapi.alipay.com/gateway.do"</span>,<span class="string">"app_id"</span>,<span class="string">"your private_key"</span>,<span class="string">"json"</span>,<span class="string">"GBK"</span>,<span class="string">"alipay_public_key"</span>,<span class="string">"RSA2"</span>);</span><br><span class="line"><span class="type">AlipayTradeQueryRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AlipayTradeQueryRequest</span>();</span><br><span class="line"><span class="type">JSONObject</span> <span class="variable">bizContent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">bizContent.put(<span class="string">"out_trade_no"</span>, <span class="string">"20150320010101001"</span>);</span><br><span class="line"><span class="comment">//bizContent.put("trade_no", "2014112611001004680073956707");</span></span><br><span class="line">request.setBizContent(bizContent.toString());</span><br><span class="line"><span class="type">AlipayTradeQueryResponse</span> <span class="variable">response</span> <span class="operator">=</span> alipayClient.execute(request);</span><br><span class="line"><span class="keyword">if</span>(response.isSuccess()){</span><br><span class="line">    System.out.println(<span class="string">"调用成功"</span>);</span><br><span class="line">} <span class="keyword">else</span> {</span><br><span class="line">    System.out.println(<span class="string">"调用失败"</span>);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>刚才订单付款成功，可以使用out_trade_no商品订单号或支付宝的交易流水号trade_no去查询支付结果。</p>
<p>out_trade_no商品订单号: 是在下单请求时指定的商品订单号。</p>
<p>支付宝的交易流水号trade_no：是支付完成后支付宝通知支付结果时发送的trade_no</p>
<p>我们使用out_trade_no商品订单号去查询，代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AliPayTest</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value("${pay.alipay.APP_ID}")</span></span><br><span class="line">    String APP_ID;</span><br><span class="line">    <span class="meta">@Value("${pay.alipay.APP_PRIVATE_KEY}")</span></span><br><span class="line">    String APP_PRIVATE_KEY;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value("${pay.alipay.ALIPAY_PUBLIC_KEY}")</span></span><br><span class="line">    String ALIPAY_PUBLIC_KEY;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">queryPayResult</span><span class="params">()</span> <span class="keyword">throws</span> AlipayApiException {</span><br><span class="line">        <span class="type">AlipayClient</span> <span class="variable">alipayClient</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultAlipayClient</span>(<span class="string">"https://openapi-sandbox.dl.alipaydev.com/gateway.do"</span>, APP_ID, APP_PRIVATE_KEY, AlipayConfig.FORMAT, AlipayConfig.CHARSET, ALIPAY_PUBLIC_KEY, AlipayConfig.SIGNTYPE);</span><br><span class="line">        <span class="type">AlipayTradeQueryRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AlipayTradeQueryRequest</span>();</span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">bizContent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">        bizContent.put(<span class="string">"out_trade_no"</span>, <span class="string">"202410100010101023"</span>);           <span class="comment">//out_trade_no和trade_no二选一即可</span></span><br><span class="line">        <span class="comment">//bizContent.put("trade_no", "2014112611001004680073956707");</span></span><br><span class="line">        request.setBizContent(bizContent.toString());</span><br><span class="line">        <span class="type">AlipayTradeQueryResponse</span> <span class="variable">response</span> <span class="operator">=</span> alipayClient.execute(request);</span><br><span class="line">        <span class="keyword">if</span> ( response.isSuccess() ) {</span><br><span class="line">            System.out.println(<span class="string">"调用成功"</span>);</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            System.out.println(<span class="string">"调用失败"</span>);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h3 id="支付结果通知"><a class="markdownIt-Anchor" href="#支付结果通知"></a> 支付结果通知</h3>
<h4 id="准备支付环境"><a class="markdownIt-Anchor" href="#准备支付环境"></a> 准备支付环境</h4>
<p>对于手机网站支付产生的交易，支付宝会通知商户支付结果，有两种通知方式，通过return_url、notify_url进行通知</p>
<p>使用return_url不能保证通知到位，推荐使用notify_url完成支付结构通知。</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240306123054081.png" alt="image-20240306123054081"></p>
<p>具体的使用方法是在调用下单接口的 API 中传入的异步通知地址 notify_url，通过 POST 请求的形式将支付结果作为参数通知到商户系统。</p>
<p>详情可查看 <a href="https://opendocs.alipay.com/support/01raw4">支付宝异步通知说明</a>。</p>
<p>文档：<a href="https://opendocs.alipay.com/open/203/105286">https://opendocs.alipay.com/open/203/105286</a></p>
<p>根据下单执行流程，订单服务收到支付结果需要对内容进行验签，验签过程如下：</p>
<ol>
<li>在通知返回参数列表中，除去sign、sign_type两个参数外，凡是通知返回回来的参数皆是待验签的参数。将剩下参数进行 url_decode，然后进行字典排序，组成字符串，得到待签名字符串； 生活号异步通知组成的待验签串里需要保留 sign_type 参数。</li>
<li>将签名参数（sign）使用 base64 解码为字节码串；</li>
<li>使用 RSA 的验签方法，通过签名字符串、签名参数（经过 base64 解码）及支付宝公钥验证签名。</li>
<li>验证签名正确后，必须再严格按照如下描述校验通知数据的正确性。</li>
</ol>
<p>在上述验证通过后，商户必须根据支付宝不同类型的业务通知，正确的进行不同的业务处理，并且过滤重复的通知结果数据。</p>
<p>通过验证out_trade_no、total_amount、appid参数的正确性判断通知请求的合法性。</p>
<p>验证的过程可以参考sdk demo代码，下载 sdk demo代码</p>
<p>文档:<a href="https://opendocs.alipay.com/open/203/105910">https://opendocs.alipay.com/open/203/105910</a></p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240306123617296.png" alt="image-20240306123617296"></p>
<p>参考demo中的alipay.trade.wap.pay-java-utf-8\WebContent\ notify_url.jsp</p>
<p>另外，支付宝通知订单服务的地址必须为外网域名且备案通过可以正常访问。</p>
<p>此接口仍然使用内网穿透技术。</p>
<h4 id="编写测试代码"><a class="markdownIt-Anchor" href="#编写测试代码"></a> 编写测试代码</h4>
<ol>
<li>
<p>在下单请求时设置通知地址request.setNotifyUrl("商户自己的notify_url地址");</p>
</li>
<li>
<p>编写接收通知接口，接收参数并验签</p>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@PostMapping("/paynotify")</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">paynotify</span><span class="params">(HttpServletRequest request,HttpServletResponse response)</span> <span class="keyword">throws</span> IOException, AlipayApiException {</span><br><span class="line">    <span class="comment">//获取支付宝POST过来反馈信息</span></span><br><span class="line">    Map&lt;String,String&gt; params = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String,String&gt;();</span><br><span class="line">    <span class="type">Map</span> <span class="variable">requestParams</span> <span class="operator">=</span> request.getParameterMap();</span><br><span class="line">    <span class="keyword">for</span> ( <span class="type">Iterator</span> <span class="variable">iter</span> <span class="operator">=</span> requestParams.keySet().iterator(); iter.hasNext();) {</span><br><span class="line">        <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> (String) iter.next();</span><br><span class="line">        String[] values = (String[]) requestParams.get(name);</span><br><span class="line">        <span class="type">String</span> <span class="variable">valueStr</span> <span class="operator">=</span> <span class="string">""</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; values.length; i++) {</span><br><span class="line">            valueStr = (i == values.length - <span class="number">1</span>) ? valueStr + values[i]</span><br><span class="line">                : valueStr + values[i] + <span class="string">","</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">//乱码解决，这段代码在出现乱码时使用。如果mysign和sign不相等也可以使用这段代码转化</span></span><br><span class="line">        <span class="comment">//valueStr = new String(valueStr.getBytes("ISO-8859-1"), "gbk");</span></span><br><span class="line">        params.put(name, valueStr);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//获取支付宝的通知返回参数，可参考技术文档中页面跳转同步通知参数列表(以下仅供参考)//</span></span><br><span class="line">    <span class="comment">//商户订单号</span></span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">out_trade_no</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(request.getParameter(<span class="string">"out_trade_no"</span>).getBytes(<span class="string">"ISO-8859-1"</span>),<span class="string">"UTF-8"</span>);</span><br><span class="line">    <span class="comment">//支付宝交易号</span></span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">trade_no</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(request.getParameter(<span class="string">"trade_no"</span>).getBytes(<span class="string">"ISO-8859-1"</span>),<span class="string">"UTF-8"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//交易状态</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">trade_status</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(request.getParameter(<span class="string">"trade_status"</span>).getBytes(<span class="string">"ISO-8859-1"</span>),<span class="string">"UTF-8"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取支付宝的通知返回参数，可参考技术文档中页面跳转同步通知参数列表(以上仅供参考)//</span></span><br><span class="line">    <span class="comment">//计算得出通知验证结果</span></span><br><span class="line">    <span class="comment">//boolean AlipaySignature.rsaCheckV1(Map&lt;String, String&gt; params, String publicKey, String charset, String sign_type)</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">verify_result</span> <span class="operator">=</span> AlipaySignature.rsaCheckV1(params, ALIPAY_PUBLIC_KEY, AlipayConfig.CHARSET, <span class="string">"RSA2"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(verify_result){<span class="comment">//验证成功</span></span><br><span class="line">        <span class="comment">//////////////////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line">        <span class="comment">//请在这里加上商户的业务逻辑程序代码</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//——请根据您的业务逻辑来编写程序（以下代码仅作参考）——</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(trade_status.equals(<span class="string">"TRADE_FINISHED"</span>)){</span><br><span class="line">            <span class="comment">//判断该笔订单是否在商户网站中已经做过处理</span></span><br><span class="line">            <span class="comment">//如果没有做过处理，根据订单号（out_trade_no）在商户网站的订单系统中查到该笔订单的详细，并执行商户的业务程序</span></span><br><span class="line">            <span class="comment">//请务必判断请求时的total_fee、seller_id与通知时获取的total_fee、seller_id为一致的</span></span><br><span class="line">            <span class="comment">//如果有做过处理，不执行商户的业务程序</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">//注意：</span></span><br><span class="line">            <span class="comment">//如果签约的是可退款协议，退款日期超过可退款期限后（如三个月可退款），支付宝系统发送该交易状态通知</span></span><br><span class="line">            <span class="comment">//如果没有签约可退款协议，那么付款完成后，支付宝系统发送该交易状态通知。</span></span><br><span class="line">        } <span class="keyword">else</span> <span class="keyword">if</span> (trade_status.equals(<span class="string">"TRADE_SUCCESS"</span>)){</span><br><span class="line">            <span class="comment">//判断该笔订单是否在商户网站中已经做过处理</span></span><br><span class="line">            <span class="comment">//如果没有做过处理，根据订单号（out_trade_no）在商户网站的订单系统中查到该笔订单的详细，并执行商户的业务程序</span></span><br><span class="line">            <span class="comment">//请务必判断请求时的total_fee、seller_id与通知时获取的total_fee、seller_id为一致的</span></span><br><span class="line">            <span class="comment">//如果有做过处理，不执行商户的业务程序</span></span><br><span class="line">            System.out.printf(<span class="string">"trade_status = "</span> + trade_status);</span><br><span class="line">            <span class="comment">//注意：</span></span><br><span class="line">            <span class="comment">//如果签约的是可退款协议，那么付款完成后，支付宝系统发送该交易状态通知。</span></span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">//——请根据您的业务逻辑来编写程序（以上代码仅作参考）——</span></span><br><span class="line">        response.getWriter().write(<span class="string">"success"</span>);	<span class="comment">//请不要修改或删除</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//////////////////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line">    }<span class="keyword">else</span>{<span class="comment">//验证失败</span></span><br><span class="line">        response.getWriter().write(<span class="string">"fail"</span>);	<span class="comment">//请不要修改或删除</span></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>在测试中的alipayRequse也需要修改</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">AlipayTradeWapPayRequest</span> <span class="variable">alipayRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AlipayTradeWapPayRequest</span>();<span class="comment">//创建API对应的request</span></span><br><span class="line"><span class="comment">//        alipayRequest.setReturnUrl("http://domain.com/CallBack/return_url.jsp");</span></span><br><span class="line">alipayRequest.setNotifyUrl(<span class="string">"http://318f68d075.vicp.fun:45930/orders/paynotify"</span>);<span class="comment">//在公共参数中设置回跳和通知地址</span></span><br><span class="line">alipayRequest.setBizContent(<span class="string">"{"</span> +</span><br><span class="line">                            <span class="string">"    \"out_trade_no\":\"202410100010101023\","</span> +</span><br><span class="line">                            <span class="string">"    \"total_amount\":0.1,"</span> +</span><br><span class="line">                            <span class="string">"    \"subject\":\"Iphone116 16G\","</span> +</span><br><span class="line">                            <span class="string">"    \"product_code\":\"QUICK_WAP_WAY\""</span> +</span><br><span class="line">                            <span class="string">"  }"</span>);<span class="comment">//填充业务参数</span></span><br></pre></td></tr></table></figure>
<p>添加设置<code>alipayRequest.setNotifyUrl("http://318f68d075.vicp.fun:45930/orders/paynotify");</code></p>
]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>学习</tag>
        <tag>后端</tag>
        <tag>黑马程序员</tag>
        <tag>学成在线</tag>
      </tags>
  </entry>
  <entry>
    <title>学成在线Day13</title>
    <url>/2024/03/21/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFDay13/</url>
    <content><![CDATA[<h1 id="在线学习"><a class="markdownIt-Anchor" href="#在线学习"></a> 在线学习</h1>
<h2 id="需求分析"><a class="markdownIt-Anchor" href="#需求分析"></a> 需求分析</h2>
<p>用户通过课程详情界面点击马上学习 进入 视频插放界面进行视频点播。</p>
<p>获取视频资源时进行学习资格校验，如下图:</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240310153400675.png" alt="image-20240310153400675"></p>
<p>拥有学习资格则继续播放视频，不具有学习资格则引导去购买、续期等操作。</p>
<p>如何判断是否拥有学习资格？</p>
<p>首先判断是否为试学视频，如果为试学视频则可以正常学习。</p>
<p>如果为非试学课程首先判断用户是否登录，如果已登录则判断是否选课，如果已经选课且没有过期可以正常学习。</p>
<p>详细流程如下图:</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240310153516861.png" alt="image-20240310153516861"></p>
<h2 id="查询课程信息"><a class="markdownIt-Anchor" href="#查询课程信息"></a> <strong>查询课程信息</strong></h2>
<p>在视频点播页面需要查询课程信息，课程上线后也需要访问/api/content/course/whole/{courseId}</p>
<p>课程预览时请求获取课程的接口为：/open/content/course/whole/{courseId}</p>
<p>在nginx中进行配置：</p>
<p>/open、/api在nginx的配置如下：(已经配置的不要重复配置)</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">location</span> <span class="string">/api/ {</span></span><br><span class="line">        <span class="attr">proxy_pass</span> <span class="string">http://gatewayserver/;</span></span><br><span class="line"><span class="attr">}</span> <span class="string"></span></span><br><span class="line"><span class="comment">#openapi</span></span><br><span class="line"><span class="attr">location</span> <span class="string">/open/content/ {</span></span><br><span class="line">        <span class="attr">proxy_pass</span> <span class="string">http://gatewayserver/content/open/;</span></span><br><span class="line"><span class="attr">}</span> <span class="string"></span></span><br><span class="line"><span class="attr">location</span> <span class="string">/open/media/ {</span></span><br><span class="line">        <span class="attr">proxy_pass</span> <span class="string">http://gatewayserver/media/open/;</span></span><br><span class="line"><span class="attr">}</span> <span class="string"></span></span><br></pre></td></tr></table></figure>
<p>下边实现/api/content/course/whole/{courseId} 获取课程发布信息接口。</p>
<p>进入内容管理服务api工程CoursePublishController 类，定义查询课程预览信息接口如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@ApiOperation("获取课程发布信息")</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="meta">@GetMapping("/course/whole/{courseId}")</span></span><br><span class="line"><span class="keyword">public</span> CoursePreviewDTO <span class="title function_">getCoursePublish</span><span class="params">(<span class="meta">@PathVariable("courseId")</span> Long courseId)</span> {</span><br><span class="line">    <span class="comment">//封装数据</span></span><br><span class="line">    <span class="type">CoursePreviewDTO</span> <span class="variable">coursePreviewDTO</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CoursePreviewDTO</span>();</span><br><span class="line">    <span class="comment">//查询课程发布表</span></span><br><span class="line">    <span class="type">CoursePublish</span> <span class="variable">coursePublish</span> <span class="operator">=</span> coursePublishService.getCoursePublish(courseId);</span><br><span class="line">    <span class="keyword">if</span>(coursePublish == <span class="literal">null</span>){</span><br><span class="line">        <span class="keyword">return</span> coursePreviewDTO;</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//向dto中封装数据</span></span><br><span class="line">    <span class="type">CourseBaseInfoDTO</span> <span class="variable">courseBaseInfoDTO</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CourseBaseInfoDTO</span>();</span><br><span class="line">    BeanUtils.copyProperties(coursePublish, courseBaseInfoDTO);</span><br><span class="line">    coursePreviewDTO.setCourseBase(courseBaseInfoDTO);</span><br><span class="line">    <span class="comment">//查询课程计划</span></span><br><span class="line">    <span class="comment">//从CouseBaseInfoDTO中获取课程计划</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">teachPlanJson</span> <span class="operator">=</span> coursePublish.getTeachplan();</span><br><span class="line">    List&lt;TeachplanDTO&gt; teachplanDTOS = JSON.parseArray(teachPlanJson, TeachplanDTO.class);</span><br><span class="line">    coursePreviewDTO.setTeachPlans(teachplanDTOS);</span><br><span class="line">    <span class="keyword">return</span> coursePreviewDTO;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>重启内容管理服务，进入学习界面查看课程计划、课程名称等信息是否显示正常。</p>
<h2 id="获取视频"><a class="markdownIt-Anchor" href="#获取视频"></a> 获取视频</h2>
<h3 id="需求分析-2"><a class="markdownIt-Anchor" href="#需求分析-2"></a> 需求分析</h3>
<pre class="mermaid">sequenceDiagram
	前端 -&gt;&gt; 学习中心服务: 获取视频
	学习中心服务 -&gt;&gt; 内容管理服务: 获取课程信息
	学习中心服务 -&gt;&gt; 学习中心服务: 判断学习资格
	学习中心服务 -&gt;&gt; 前端: 没有学习资格
	学习中心服务 -&gt;&gt; 媒资管理服务: 获取媒体资源</pre>
<h3 id="接口定义"><a class="markdownIt-Anchor" href="#接口定义"></a> 接口定义</h3>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Api(value = "学习过程管理接口", tags = "学习过程管理接口")</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyLearningController</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    LearningService learningService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiOperation("获取视频")</span></span><br><span class="line">    <span class="meta">@GetMapping("/open/learn/getvideo/{courseId}/{teachplanId}/{mediaId}")</span></span><br><span class="line">    <span class="keyword">public</span> RestResponse&lt;String&gt; <span class="title function_">getvideo</span><span class="params">(<span class="meta">@PathVariable("courseId")</span> Long courseId, <span class="meta">@PathVariable("teachplanId")</span> Long teachplanId, <span class="meta">@PathVariable("mediaId")</span> String mediaId)</span> {</span><br><span class="line">        SecurityUtil.<span class="type">XcUser</span> <span class="variable">user</span> <span class="operator">=</span> SecurityUtil.getUser();</span><br><span class="line">        <span class="type">String</span> <span class="variable">userId</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (user != <span class="literal">null</span>) {</span><br><span class="line">            userId = user.getId();</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">//调用媒资服务查询视频播放地址</span></span><br><span class="line">        <span class="keyword">return</span> learningService.getVideo(userId, courseId, teachplanId, mediaId);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>定义service接口</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Wwh</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ProjectName</span> xuecheng-plus-project</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@dateTime</span> 2024/3/10 16:13</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 在线学习相关接口</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">LearningService</span> {</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取视频</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userId     用户id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> courseId   课程id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> teachplanId 计划id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> mediaId    媒体id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> RestResponse&lt;String&gt; 视频播放地址</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    RestResponse&lt;String&gt; <span class="title function_">getVideo</span><span class="params">(String userId, Long courseId, Long teachplanId, String mediaId)</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h3 id="获取视频远程接口"><a class="markdownIt-Anchor" href="#获取视频远程接口"></a> 获取视频远程接口</h3>
<p>在学习中心服务service工程中定义媒资管理Feignclient</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@FeignClient(value = "media-api", fallbackFactory = MediaServiceClientFallbackFactory.class)</span></span><br><span class="line"><span class="meta">@RequestMapping("/media")</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MediaServiceClient</span> {</span><br><span class="line">    <span class="meta">@GetMapping("/open/preview/{mediaId}")</span></span><br><span class="line">    RestResponse&lt;String&gt; <span class="title function_">getPlayUrlByMediaId</span><span class="params">(<span class="meta">@PathVariable("mediaId")</span> String mediaId)</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>定义降级类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MediaServiceClientFallbackFactory</span> <span class="keyword">implements</span> <span class="title class_">FallbackFactory</span>&lt;MediaServiceClient&gt; {</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> MediaServiceClient <span class="title function_">create</span><span class="params">(Throwable throwable)</span> {</span><br><span class="line">        <span class="keyword">return</span> mediaId -&gt; {</span><br><span class="line">            log.error(<span class="string">"远程调用媒资管理服务熔断异常：{}"</span>, throwable.getMessage());</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        };</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h3 id="学习资格校验"><a class="markdownIt-Anchor" href="#学习资格校验"></a> 学习资格校验</h3>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> RestResponse&lt;String&gt; <span class="title function_">getVideo</span><span class="params">(String userId, Long courseId, Long teachplanId, String mediaId)</span> {</span><br><span class="line">    <span class="comment">//查询课程信息</span></span><br><span class="line">    <span class="type">CoursePublish</span> <span class="variable">coursepublish</span> <span class="operator">=</span> contentServiceClient.getCoursepublish(courseId);</span><br><span class="line">    <span class="keyword">if</span> ( coursepublish == <span class="literal">null</span> ) {</span><br><span class="line">        <span class="keyword">return</span> RestResponse.validfail(<span class="string">"课程信息不存在"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//远程调用内容管理服务根据课程计划ID查询课程计划,如果is_preview为1则支持试学</span></span><br><span class="line">    <span class="comment">//也可以从coursepublish解析出课程计划是否支持试学</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//1.判断是否登录</span></span><br><span class="line">    <span class="keyword">if</span> ( StringUtil.isNotEmpty(userId) ) {</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取学习资格</span></span><br><span class="line">        <span class="comment">//学习资格，[{"code":"702001","desc":"正常学习"},{"code":"702002","desc":"没有选课或选课后没有支付"},{"code":"702003","desc":"已过期需要申请续期或重新支付"}]</span></span><br><span class="line">        <span class="type">XcCourseTablesDto</span> <span class="variable">learning</span> <span class="operator">=</span> myCourseTableService.getLearningStatus(userId, courseId);</span><br><span class="line">        <span class="type">String</span> <span class="variable">learnStatus</span> <span class="operator">=</span> learning.getLearnStatus();</span><br><span class="line">        <span class="keyword">if</span> ( <span class="string">"702002"</span>.equals(learnStatus) ) {</span><br><span class="line">            <span class="keyword">return</span> RestResponse.validfail(<span class="string">"无法学习,没有选课或选课后没有支付"</span>);</span><br><span class="line">        } <span class="keyword">else</span> <span class="keyword">if</span> ( <span class="string">"702003"</span>.equals(learnStatus) ) {</span><br><span class="line">            <span class="keyword">return</span> RestResponse.validfail(<span class="string">"无法学习,已过期需要申请续期或重新支付"</span>);</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="comment">//远程调用媒资获取视频播放地址</span></span><br><span class="line">            <span class="keyword">return</span> mediaServiceClient.getPlayUrlByMediaId(mediaId);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//2.如果用户没有登录</span></span><br><span class="line">    <span class="comment">//查询课程信息判断是否为免费课程</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">charge</span> <span class="operator">=</span> coursepublish.getCharge();</span><br><span class="line">    <span class="keyword">if</span> ( <span class="string">"201000"</span>.equals(charge) ) {</span><br><span class="line">        <span class="comment">//免费课程</span></span><br><span class="line">        <span class="comment">//远程调用媒资获取视频播放地址</span></span><br><span class="line">        <span class="keyword">return</span> mediaServiceClient.getPlayUrlByMediaId(mediaId);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> RestResponse.validfail(<span class="string">"课程需要购买"</span>);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h3 id="测试"><a class="markdownIt-Anchor" href="#测试"></a> 测试</h3>
<ol>
<li>完善接口</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@ApiOperation("获取视频")</span></span><br><span class="line"><span class="meta">@GetMapping("/open/learn/getvideo/{courseId}/{teachplanId}/{mediaId}")</span></span><br><span class="line"><span class="keyword">public</span> RestResponse&lt;String&gt; <span class="title function_">getvideo</span><span class="params">(<span class="meta">@PathVariable("courseId")</span> Long courseId, <span class="meta">@PathVariable("teachplanId")</span> Long teachplanId, <span class="meta">@PathVariable("mediaId")</span> String mediaId)</span> {</span><br><span class="line">    SecurityUtil.<span class="type">XcUser</span> <span class="variable">user</span> <span class="operator">=</span> SecurityUtil.getUser();</span><br><span class="line">    <span class="type">String</span> <span class="variable">userId</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (user != <span class="literal">null</span>) {</span><br><span class="line">        userId = user.getId();</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//调用媒资服务查询视频播放地址</span></span><br><span class="line">    <span class="keyword">return</span> learningService.getVideo(userId, courseId, teachplanId, mediaId);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>
<p>测试准备</p>
<p>选课成功一门课程。</p>
<p>没有选课的免费课程、收费课程各一门，其中收费课程具有试学课程。</p>
</li>
<li>
<ol>
<li>
<p>选课成功的课程是否可以正常获取视频</p>
</li>
<li>
<p>免费课程没有选课是否可以正常学习</p>
</li>
</ol>
<p>可修改选课记录表中的课程id为不存在进行测试，测试完再恢复原样。</p>
<ol start="3">
<li>收费课程没有选课是否可以正常学习</li>
</ol>
<p>可修改选课记录表中的课程id为不存在进行测试，测试完再恢复原样。</p>
</li>
</ol>
<h2 id="我的课程表"><a class="markdownIt-Anchor" href="#我的课程表"></a> 我的课程表</h2>
<h3 id="需求分析-3"><a class="markdownIt-Anchor" href="#需求分析-3"></a> 需求分析</h3>
<h4 id="业务流程"><a class="markdownIt-Anchor" href="#业务流程"></a> 业务流程</h4>
<p>登录网站，点击“我的学习”进入个人中心，</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240311093550102.png" alt="image-20240311093550102"></p>
<p>个人中心首页显示我的课程表：</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240311093617221.png" alt="image-20240311093617221"></p>
<p>我的课表中显示了选课成功的免费课程、收费课程。最近学习课程显示了当前用户最近学习的课程信息。</p>
<p>点击继续学习进入当前学习章节的视频继续学习。</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">server</span> <span class="string">{</span></span><br><span class="line">    <span class="attr">listen</span>       <span class="string">80;</span></span><br><span class="line">    <span class="attr">server_name</span>  <span class="string">ucenter.51xuecheng.cn;</span></span><br><span class="line"><span class="comment">    #charset koi8-r;</span></span><br><span class="line">    <span class="attr">ssi</span> <span class="string">on;</span></span><br><span class="line">    <span class="attr">ssi_silent_errors</span> <span class="string">on;</span></span><br><span class="line"><span class="comment">    #access_log  logs/host.access.log  main;</span></span><br><span class="line">    <span class="attr">location</span> <span class="string">/ {</span></span><br><span class="line">        <span class="attr">alias</span>  <span class="string">D:/Programming_Learning/Project/xc-ui-pc-static-portal/ucenter/;</span></span><br><span class="line">        <span class="attr">index</span>  <span class="string">index.html index.htm;</span></span><br><span class="line">    <span class="attr">}</span></span><br><span class="line">    <span class="attr">location</span> <span class="string">/include {</span></span><br><span class="line">        <span class="attr">proxy_pass</span>   <span class="string">http://127.0.0.1;</span></span><br><span class="line">    <span class="attr">}</span></span><br><span class="line">    <span class="attr">location</span> <span class="string">/img/ {</span></span><br><span class="line">        <span class="attr">proxy_pass</span>   <span class="string">http://127.0.0.1/static/img/;</span></span><br><span class="line">    <span class="attr">}</span></span><br><span class="line">    <span class="attr">location</span> <span class="string">/api/ {</span></span><br><span class="line">            <span class="attr">proxy_pass</span> <span class="string">http://gatewayserver/;</span></span><br><span class="line">    <span class="attr">}</span> <span class="string"></span></span><br><span class="line"><span class="attr">}</span></span><br></pre></td></tr></table></figure>
<h3 id="接口定义-2"><a class="markdownIt-Anchor" href="#接口定义-2"></a> 接口定义</h3>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@ApiOperation("我的课程表")</span></span><br><span class="line"><span class="meta">@GetMapping("/mycoursetable")</span></span><br><span class="line"><span class="keyword">public</span> PageResult&lt;XcCourseTables&gt; <span class="title function_">mycoursetable</span><span class="params">(MyCourseTableParams params)</span> {</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h3 id="接口开发"><a class="markdownIt-Anchor" href="#接口开发"></a> 接口开发</h3>
<p>service接口:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> params 查询参数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> com.xuecheng.base.model.PageResult&lt;com.xuecheng.learning.model.po.XcCourseTables&gt;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 我的课程表查询接口</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2024/3/11 11：47</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">PageResult&lt;XcCourseTables&gt; <span class="title function_">mycourestabls</span><span class="params">(MyCourseTableParams params)</span>;</span><br></pre></td></tr></table></figure>
<p>service接口实现:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> PageResult&lt;XcCourseTables&gt; <span class="title function_">mycourestabls</span><span class="params">(MyCourseTableParams params)</span> {</span><br><span class="line">    <span class="type">int</span> <span class="variable">pageNo</span> <span class="operator">=</span> params.getPage();</span><br><span class="line">    <span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> params.getSize();</span><br><span class="line">    Page&lt;XcCourseTables&gt; xcCourseTablesPage = <span class="keyword">new</span> <span class="title class_">Page</span>&lt;&gt;(pageNo, size);</span><br><span class="line">    LambdaQueryWrapper&lt;XcCourseTables&gt; eq = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;XcCourseTables&gt;()</span><br><span class="line">        .eq(XcCourseTables::getUserId, params.getUserId());</span><br><span class="line">    Page&lt;XcCourseTables&gt; result = xcCourseTablesMapper.selectPage(xcCourseTablesPage, eq);</span><br><span class="line">    PageResult&lt;XcCourseTables&gt; xcCourseTablesPageResult = <span class="keyword">new</span> <span class="title class_">PageResult</span>&lt;&gt;(result.getRecords(), result.getTotal(), size, pageNo);</span><br><span class="line">    <span class="keyword">return</span> xcCourseTablesPageResult;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>controller完善:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@ApiOperation("我的课程表")</span></span><br><span class="line"><span class="meta">@GetMapping("/mycoursetable")</span></span><br><span class="line"><span class="keyword">public</span> PageResult&lt;XcCourseTables&gt; <span class="title function_">mycoursetable</span><span class="params">(MyCourseTableParams params)</span> {</span><br><span class="line">    <span class="comment">//获取用户信息</span></span><br><span class="line">    SecurityUtil.<span class="type">XcUser</span> <span class="variable">user</span> <span class="operator">=</span> SecurityUtil.getUser();</span><br><span class="line">    <span class="keyword">if</span>(user == <span class="literal">null</span>){</span><br><span class="line">        XueChengPlusException.cast(<span class="string">"请登录后再操作"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//获取用户id</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">userId</span> <span class="operator">=</span> user.getId();</span><br><span class="line">    params.setUserId(userId);</span><br><span class="line">    PageResult&lt;XcCourseTables&gt; mycourestabls = myCourseTableService.mycourestabls(params);</span><br><span class="line">    <span class="keyword">return</span> mycourestabls;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h3 id="接口测试"><a class="markdownIt-Anchor" href="#接口测试"></a> 接口测试</h3>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240311120705534.png" alt="image-20240311120705534"></p>
<h1 id="项目部署"><a class="markdownIt-Anchor" href="#项目部署"></a> 项目部署</h1>
<h2 id="什么是devops"><a class="markdownIt-Anchor" href="#什么是devops"></a> 什么是DevOps</h2>
<p>一个软件的生命周期包括：需求分析阶、设计、开发、测试、上线、维护、升级、废弃。</p>
<p>通过示例说明如下：</p>
<ol>
<li>
<p>产品人员进行需求分析</p>
</li>
<li>
<p>设计人员进行软件架构设计和模块设计。</p>
</li>
<li>
<p>每个模块的开发人员并行开发，设计接口、进行编码，并进行单元测试</p>
</li>
<li>
<p>开发完毕，将代码集成部署到测试服务器，测试人员进行测试。</p>
</li>
<li>
<p>测试人员发现bug，提交bug、开发人员修改bug</p>
</li>
<li>
<p>bug修改完毕再次集成、测试。</p>
</li>
<li>
<p>测试完毕，项目上线。</p>
</li>
<li>
<p>运维人员进行安装部署、培训。</p>
</li>
<li>
<p>用户提出问题，返回给运维人员。</p>
</li>
<li>
<p>运维人员反馈给开发人员，开发人员进行问题处理。</p>
</li>
<li>
<p>再次提交测试。</p>
</li>
<li>
<p>测试完毕再次部署升级。</p>
</li>
</ol>
<p>....</p>
<p>最后软件下线。</p>
<p>所以，在整体生命周期中比较核心的两个阶段是：开发阶段、维护阶段，开发阶段的成果是软件开发完成并成功上线，运维阶段则负责对软件进行维护和升级，而运维阶段通常在一个软件 的生命周期中占比最多。</p>
<p>提高开发阶段、运维阶段的工作效率是企业在进行软件项目管理的重点。</p>
<p>因此，专家提出了DevOps，DevOps是什么呢？</p>
<p>下边是摘自百度百科的定义：</p>
<p>DevOps（Development和Operations的组合词）是一组过程、方法与系统的统称，用于促进开发（<a href="https://baike.baidu.com/item/%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F/5985445?fromModule=lemma_inlink">应用程序</a>/软件工程）、技术运营和质量保障（<a href="https://baike.baidu.com/item/QA/476016?fromModule=lemma_inlink">QA</a>）部门之间的沟通、协作与整合。</p>
<p>它是一种重视“<a href="https://baike.baidu.com/item/%E8%BD%AF%E4%BB%B6%E5%BC%80%E5%8F%91/3448966?fromModule=lemma_inlink">软件开发</a>人员（Dev）”和“<a href="https://baike.baidu.com/item/IT%E8%BF%90%E7%BB%B4/5727814?fromModule=lemma_inlink">IT运维</a>技术人员（Ops）”之间沟通合作的文化、运动或惯例。透过自动化“<a href="https://baike.baidu.com/item/%E8%BD%AF%E4%BB%B6%E4%BA%A4%E4%BB%98/638479?fromModule=lemma_inlink">软件交付</a>”和“架构变更”的流程，来使得构建、测试、发布软件能够更加地快捷、频繁和可靠。</p>
<p>它的出现是由于软件行业日益清晰地认识到：为了按时交付<a href="https://baike.baidu.com/item/%E8%BD%AF%E4%BB%B6%E4%BA%A7%E5%93%81/6800028?fromModule=lemma_inlink">软件产品</a>和服务，开发和运维工作必须紧密合作。</p>
<img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240313161655272.png" alt="image-20240313161655272" style="zoom:50%;">
<p>DevOps是一个工具吗？</p>
<p>DevOps是一个工作职位吗？</p>
<p>都不是。</p>
<p>DevOps是一种思想理念，它涵盖开发、测试、运维的整个过程。DevOps追求的目标是提高软件开发、测试、运维、运营等各部门的沟通与协作质量，DevOps强调软件开发人员与软件测试、软件运维、质量保障（QA）部门之间有效的沟通与协作，强调通过自动化的方法去管理软件变更、软件集成，使软件从构建到测试、发布更加快捷、可靠，最终按时交付软件。</p>
<img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240313161814278.png" alt="image-20240313161814278" style="zoom:50%;">
<h2 id="什么是cicd"><a class="markdownIt-Anchor" href="#什么是cicd"></a> 什么是CI/CD</h2>
<p>如何来落地实现DevOps呢？</p>
<p>DevOps兴起于2009年，近年来由于云计算、互联网的发展，促进了DevOps的基础设施及工具链的发展，涌现了一大批优秀的工具，这些工具包括开发、测试、运维的各各领域，例如：GitHub、Docker、Jenkins、Hudson、K8S、Ant/Maven/Gradle、Selenium、QUnit、JMeter等。下图是DevOps相关的工具集：</p>
<img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240313161912638.png" alt="image-20240313161912638" style="zoom:50%;">
<p>好的工具有利于DevOps的实施，但并不代表实施DevOps就一定需要去引入一堆工具。</p>
<p>问题的关键：如何解决问题，而不是具体应用工具。</p>
<p>CI/CD 是近年来企业有效实施DevOps的具体方案。</p>
<p>CI/CD 包含了一个 CI 和两个 CD，CI全称 Continuous Integration，表示持续集成，CD包含 Continuous Delivery和 Continuous Deployment，分别是持续交付和持续部署，三者具有前后依赖关系。</p>
<p>CI 持续集成：</p>
<p>持续集成倡导团队成员需要频繁的集成他们的工作，将开发分支合并到主分支，每次集成都通过自动化构建（包括编译、构建、自动化测试）来验证，从而尽快地发现集成中的错误，让产品可以快速迭代，同时还能保持高质量。</p>
<img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240313162159678.png" alt="image-20240313162159678" style="zoom:50%;">
<p>CD持续交付:</p>
<p>持续交付将集成后的代码部署到类生产环境(预发布)，除了交付到类生产环境之外，还会执行一些集成测试、API测试。持续交付强调的是“交付”，交付给测试、产品验收，不管怎么更新，软件是随时随地可以交付的。</p>
<img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240313162442297.png" alt="image-20240313162442297" style="zoom:50%;">
<p>CD持续部署：</p>
<p>在持续交付的基础上由开发人员或运维人员自助式的定期向生产环境部署稳定的构建版本，持续部署的目标是代码在任何时刻都是可部署的，并可自动进入到生产环境。</p>
<img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240313162456823.png" alt="image-20240313162456823" style="zoom:50%;">
<h2 id="devops实战"><a class="markdownIt-Anchor" href="#devops实战"></a> DevOps实战</h2>
<h3 id="技术方案"><a class="markdownIt-Anchor" href="#技术方案"></a> 技术方案</h3>
<p>下图是比较流行的一种CI/CD的技术方案：</p>
<img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240313162654340.png" alt="image-20240313162654340" style="zoom: 50%;">
<p>下边我们参考该技术方案将学成在线项目使用Docker进行部署。</p>
<p>本次项目部署实战旨在理解CI/CD的流程，考虑Kubernates的复杂性课堂上我们用Jenkins代替Kubernates完成容器部署。</p>
<h3 id="准备环境"><a class="markdownIt-Anchor" href="#准备环境"></a> 准备环境</h3>
<p>准备一台Centos7 虚拟机，安装Docker、jdk、maven，通过Docker容器安装jenkins、Docker私服软件，其它软件为学成在线项目所需要的，如下：</p>
<table>
<thead>
<tr>
<th>Mysql</th>
<th>8.x</th>
<th>docker</th>
</tr>
</thead>
<tbody>
<tr>
<td>nacos</td>
<td>1.4.1</td>
<td>docker</td>
</tr>
<tr>
<td>rabbitmq</td>
<td>3.8.34</td>
<td>docker</td>
</tr>
<tr>
<td>redis</td>
<td>6.2.7</td>
<td>docker</td>
</tr>
<tr>
<td>xxl-job-admin</td>
<td>2.3.1</td>
<td>docker</td>
</tr>
<tr>
<td>minio</td>
<td>RELEASE.2022-09-07</td>
<td>docker</td>
</tr>
<tr>
<td>elasticsearch</td>
<td>7.12.1</td>
<td>docker</td>
</tr>
<tr>
<td>kibana</td>
<td>7.12.1</td>
<td>docker</td>
</tr>
<tr>
<td>gogs</td>
<td>0.13.0</td>
<td>docker</td>
</tr>
<tr>
<td>nginx</td>
<td>1.12.2</td>
<td>docker</td>
</tr>
</tbody>
</table>
<h3 id="人工部署方式"><a class="markdownIt-Anchor" href="#人工部署方式"></a> 人工部署方式</h3>
<p>如果不使用CI/CD则需要人工手动对工程进行测试、打包、部署。使用CI/CD后通过自动化的工具去完成。</p>
<p>下边先演示手动部署方式，之后采用工具进行部署。</p>
<h4 id="项目打包"><a class="markdownIt-Anchor" href="#项目打包"></a> 项目打包</h4>
<ol>
<li>在父工程聚合各模块</li>
</ol>
<p>首先在父工程添加models，聚合各各模块</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">modules</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">module</span>&gt;</span>../xuecheng-plus-base<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">module</span>&gt;</span>../xuecheng-plus-checkcode<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">module</span>&gt;</span>../xuecheng-plus-gateway<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">module</span>&gt;</span>../xuecheng-plus-auth<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">module</span>&gt;</span>../xuecheng-plus-content<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">module</span>&gt;</span>../xuecheng-plus-learning<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">module</span>&gt;</span>../xuecheng-plus-media<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">module</span>&gt;</span>../xuecheng-plus-orders<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">module</span>&gt;</span>../xuecheng-plus-message-sdk<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">module</span>&gt;</span>../xuecheng-plus-search<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">module</span>&gt;</span>../xuecheng-plus-system<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">modules</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ol start="2">
<li>配置打包插件</li>
</ol>
<p>使用springboot打包插件进行打包，在需要打可执行包的工程中配置spring-boot-maven-plugin插件否则报 “jar中没有主清单属性” 。</p>
<p>注意:在要打可执行jar包的工程中配置该插件。</p>
<p>例如:base工程是不用添加插件的,而auth和checkcode工程需要添加打包插件</p>
<p>内容如下:</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">finalName</span>&gt;</span>${project.artifactId}-${project.version}<span class="tag">&lt;/<span class="name">finalName</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>${spring-boot.version}<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">goal</span>&gt;</span>repackage<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>这段配置文件是Maven的POM文件（Project Object Model）的一部分，用于构建Spring Boot项目。</p>
<ul>
<li><code>&lt;finalName&gt;${project.artifactId}-${project.version}&lt;/finalName&gt;</code>：这行设置了构建的最终产物的名称，它将会是<code>${project.artifactId}-${project.version}</code>，其中<code>${project.artifactId}</code>和<code>${project.version}</code>是Maven项目的artifactId和version。</li>
<li><code>&lt;plugins&gt;</code>：这个标签包含了项目中使用的所有插件。</li>
<li><code>&lt;plugin&gt;</code>：这个标签定义了一个插件。在这个例子中，定义的插件是Spring Boot Maven插件。</li>
<li><code>&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</code>、<code>&lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;</code>和<code>&lt;version&gt;${spring-boot.version}&lt;/version&gt;</code>：这些标签定义了插件的groupId，artifactId和version。在这个例子中，插件的groupId是<code>org.springframework.boot</code>，artifactId是<code>spring-boot-maven-plugin</code>，version是<code>${spring-boot.version}</code>。</li>
<li><code>&lt;executions&gt;</code>：这个标签定义了插件的执行方式。</li>
<li><code>&lt;execution&gt;</code>：这个标签定义了一个执行。在这个例子中，只定义了一个执行。</li>
<li><code>&lt;goals&gt;</code>：这个标签定义了执行的目标。</li>
<li><code>&lt;goal&gt;repackage&lt;/goal&gt;</code>：这个标签定义了目标是<code>repackage</code>。这意味着在构建过程中，Spring Boot Maven插件会自动创建一个可执行的jar或war文件。</li>
</ul>
<p>说明：<br>
配置了springboot打包插件即可在maven窗口显示如下：</p>
<img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240313164534537.png" alt="image-20240313164534537" style="zoom:50%;">
<p>功能说明：</p>
<p>build-info：生成项目的构建信息文件 build-info.properties</p>
<p>repackage：这个是默认 goal，在 mvn package 执行之后，这个命令再次打包生成可执行的 jar，同时将 mvn package 生成的 jar 重命名为 *.origin</p>
<p>run：这个可以用来运行 Spring Boot 应用</p>
<p>start：这个在 mvn integration-test 阶段，进行 Spring Boot 应用生命周期的管理</p>
<p>stop：这个在 mvn integration-test 阶段，进行 Spring Boot 应用生命周期的管理</p>
<p>在父工程执行：<code>clean install -DskipTests -f pom.xml</code> 对所有工程进行打包</p>
<p>这是一个Maven命令，用于构建Java项目。下面是每个部分的解释：</p>
<ul>
<li><code>clean</code>：这是一个Maven生命周期阶段，它会清理之前构建生成的所有文件。</li>
<li><code>install</code>：这也是一个Maven生命周期阶段，它会编译、测试和打包项目，并将包安装到本地仓库，以便其他项目可以使用。</li>
<li><code>-DskipTests</code>：这是一个命令行选项，它告诉Maven跳过测试阶段。这在你只想构建项目，但不想运行测试时很有用。</li>
<li><code>-f pom.xml</code>：这是一个命令行选项，它指定了Maven应该使用哪个文件作为项目的POM（Project Object Model）。在这个例子中，它是<code>pom.xml</code>，这是Maven项目的默认POM文件名。</li>
</ul>
<p>所以，整个命令的意思是：清理之前的构建文件，然后编译、打包项目，并将包安装到本地仓库，但是跳过测试阶段。并且，所有这些操作都是基于<code>pom.xml</code>文件的配置进行的。</p>
<p>打包时遇到如下问题:</p>
<blockquote>
<p>[ERROR] Failed to execute goal on project xuecheng-plus-checkcode: Could not resolve dependencies for project com.xuecheng:xuecheng-plus-checkcode:jar:0.0.1-SNAPSHOT: Could not find artifact com.xuecheng:xuecheng-plus-base:jar:0.0.1-SNAPSHOT -&gt; [Help 1]</p>
</blockquote>
<p>检查后发现原因是base工程下的<code>pom.xml</code>文件中的标签<code>&lt;packing&gt;pom&lt;/packing&gt;</code>导致的,去掉后正常</p>
<p>生成的文件位于checkcode工程的<code>target</code>文件夹下</p>
<p>打包完成可在本地通过java -jar 运行jar包观察是否可以正常运行。</p>
<p>下边测试验证码服务：</p>
<p>进入验证码服务的target目录，cmd运行：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">java -Dfile.encoding=utf-8 -jar xuecheng-plus-checkcode-0.0.1-SNAPSHOT.jar </span><br></pre></td></tr></table></figure>
<p>如下图:</p>
<img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240313172043536.png" alt="image-20240313172043536" style="zoom:50%;">
<p>可以通过发送请求验证是否正常运行：</p>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line">### 申请验证码</span><br><span class="line">POST {{checkcode_host}}/checkcode/pic</span><br></pre></td></tr></table></figure>
<p>发送请求后遇到问题请先尝试启动IDEA内的项目查看是否有问题</p>
<p>如果没问题请查看自己电脑环境变量中的jdk版本是否为jdk-8,其他版本会报错</p>
<h4 id="部署到linux"><a class="markdownIt-Anchor" href="#部署到linux"></a> 部署到Linux</h4>
<p>将打成的jar包拷贝到Linux，生成镜像，并创建容器。</p>
<ol>
<li>编写Dockerfile文件</li>
</ol>
<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">FROM java:8u20</span><br><span class="line">MAINTAINER docker_maven docker_maven@email.com</span><br><span class="line">WORKDIR /ROOT</span><br><span class="line">ADD xuecheng-plus-checkcode-0.0.1-SNAPSHOT.jar xuecheng-plus-checkcode.jar</span><br><span class="line">CMD ["java", "-version"]</span><br><span class="line">ENTRYPOINT ["java", "-Dfile.encoding=utf-8","-jar", "xuecheng-plus-checkcode.jar"]</span><br><span class="line">EXPOSE 63075</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>创建镜像</li>
</ol>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker build -t checkcode:1.0 .</span><br></pre></td></tr></table></figure>
<p>这是一个Docker命令，用于构建Docker镜像。下面是每个部分的解释：</p>
<ul>
<li><code>docker build</code>：这是Docker的一个命令，用于从Dockerfile构建镜像。</li>
<li><code>-t checkcode:1.0</code>：<code>-t</code>选项用于给构建的镜像指定一个名字（和可选的标签）。在这个例子中，镜像的名字是<code>checkcode</code>，标签是<code>1.0</code>。</li>
<li><code>.</code>：这是Docker build命令的最后一个参数，它指定了Dockerfile的位置。在这个例子中，<code>.</code>表示Dockerfile在当前目录。</li>
</ul>
<p>所以，整个命令的意思是：使用当前目录下的Dockerfile构建一个名为<code>checkcode</code>，标签为<code>1.0</code>的Docker镜像。</p>
<p>创建成功，查询镜像:</p>
<img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240313173544730.png" alt="image-20240313173544730" style="zoom:50%;">
<ol start="3">
<li>创建容器运行</li>
</ol>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker run --name xuecheng-plus-checkcode -p 63075:63075 -idt checkcode:1.0</span><br></pre></td></tr></table></figure>
<p>如果出现<code>Error: Invalid or corrupt jarfile xuecheng-plus-checkcode.jar</code></p>
<p>那建议检查一下jar包完整性,最好是删掉原jar包重新往虚拟机发一遍</p>
]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>学习</tag>
        <tag>后端</tag>
        <tag>黑马程序员</tag>
        <tag>学成在线</tag>
      </tags>
  </entry>
  <entry>
    <title>学成在线Day12</title>
    <url>/2024/03/21/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFDay12/</url>
    <content><![CDATA[<h2 id="生成支付二维码"><a class="markdownIt-Anchor" href="#生成支付二维码"></a> 生成支付二维码</h2>
<h3 id="需求分析"><a class="markdownIt-Anchor" href="#需求分析"></a> 需求分析</h3>
<h4 id="执行流程"><a class="markdownIt-Anchor" href="#执行流程"></a> 执行流程</h4>
<p>再次打开课程支付引导界面，点击“支付宝支付”按钮系统该如何处理？</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240306163011491.png" alt="image-20240306163011491"></p>
<p>点击<code>支付宝支付</code>此时打开支付二维码，用户扫码支付。</p>
<p>所以首先需要生成支付二维码，用户扫描二维码开始请求支付宝下单，在向支付宝下单前需要添加选课记录、创建商品订单、生成支付交易记录。</p>
<p>生成二维码执行流程如下：</p>
<pre class="mermaid">sequenceDiagram
	actor 用户
	用户 -&gt;&gt; 前端: 点击支付
	前端 -&gt;&gt; 学习服务中心: 添加选课记录
	前端 -&gt;&gt; 订单服务: 创建商品订单
	订单服务 -&gt;&gt; 订单服务: 生成支付记录
	订单服务 -&gt;&gt; 订单服务: 生成二维码
	订单服务 -&gt;&gt; 前端: 返回二维码</pre>
<p>执行流程：</p>
<ol>
<li>
<p>前端调用学习中心服务的添加选课接口。</p>
</li>
<li>
<p>添加选课成功请求订单服务生成支付二维码接口。</p>
</li>
<li>
<p>生成二维码接口：创建商品订单、生成支付交易记录、生成二维码。</p>
</li>
<li>
<p>将二维码返回到前端，用户扫码。</p>
</li>
</ol>
<p>用户扫码支付流程如下：</p>
<pre class="mermaid">sequenceDiagram
	actor 用户
	用户 -&gt;&gt; 前端: 支付宝沙箱扫码
	前端 -&gt;&gt; 订单服务: 下单
	订单服务 -&gt;&gt; 订单服务: 构造请求参数
	订单服务 -&gt;&gt; 支付宝: 下单
	订单服务 -&gt;&gt; 前端: 响应
	用户 -&gt;&gt; 前端: 输入密码支付
	前端 -&gt;&gt; 支付宝: 请求支付
	支付宝 -&gt;&gt; 订单服务: 通知支付结果
	订单服务 -&gt;&gt; 订单服务: 接收支付结果并验收
	用户 -&gt;&gt; 前端: 查询支付结果
	前端 -&gt;&gt; 订单服务: 查询支付结果
	订单服务 -&gt;&gt; 支付宝: 查询支付结果</pre>
<p>执行流程：</p>
<ol>
<li>
<p>用户输入支付密码，支付成功。</p>
</li>
<li>
<p>接收第三方平台通知的支付结果。</p>
</li>
<li>
<p>根据支付结果更新支付交易记录的支付状态为支付成功。</p>
</li>
</ol>
<h4 id="数据模型"><a class="markdownIt-Anchor" href="#数据模型"></a> 数据模型</h4>
<p>订单支付模式的核心由三张表组成：订单表、订单明细表、支付交易记录表。</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240306164135416.png" alt="image-20240306164135416"></p>
<p>订单号注意唯一性、安全性、尽量短等特点，生成方案常用的如下：</p>
<ol>
<li><code>时间戳+随机数</code></li>
</ol>
<p>年月日时分秒毫秒+随机数</p>
<ol start="2">
<li><code>高并发场景</code></li>
</ol>
<p>年月日时分秒毫秒+随机数+redis自增序列</p>
<ol start="3">
<li><code>订单号中加上业务标识</code></li>
</ol>
<p>订单号加上业务标识方便客服，比如：第10位是业务类型，第11位是用户类型等。</p>
<ol start="4">
<li><code>雪花算法</code></li>
</ol>
<p>雪花算法是<code>推特内部</code>使用的分布式环境下的唯一ID生成算法，它基于时间戳生成，保证有序递增，加以入计算机硬件等元素，可以满足高并发环境下ID不重复。</p>
<p>本项目订单号生成采用雪花算法。</p>
<h3 id="接口开发"><a class="markdownIt-Anchor" href="#接口开发"></a> 接口开发</h3>
<h4 id="保存商品订单"><a class="markdownIt-Anchor" href="#保存商品订单"></a> 保存商品订单</h4>
<ol>
<li>定义保存订单信息接口:</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">OrderService</span> {</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建订单</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userId 用户id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> addOrderDto 订单信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 订单id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    PayRecordDto <span class="title function_">createOrder</span><span class="params">(String userId, AddOrderDto addOrderDto)</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>在保存订单接口中需要完成创建商品订单、创建支付交易记录，接口实现方法如下：</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> PayRecordDto <span class="title function_">createOrder</span><span class="params">(String userId, AddOrderDto addOrderDto)</span> {</span><br><span class="line"></span><br><span class="line">    <span class="comment">//添加商品订单</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//添加支付交易记录</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//生成二维码</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>编写创建商品订单方法，商品订单的数据来源于选课记录，在订单表需要存入选课记录的ID，这里需要作好幂等处理。</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> XcOrders <span class="title function_">saveXcOrders</span><span class="params">(String userId, AddOrderDto addOrderDto)</span> {</span><br><span class="line">    <span class="comment">// 插入订单表</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 进行幂等性判断,确定每一个选课记录只能有一个订单</span></span><br><span class="line">    <span class="type">XcOrders</span> <span class="variable">xcOrdersByBusinessId</span> <span class="operator">=</span> getXcOrdersByBusinessId(addOrderDto.getOutBusinessId());</span><br><span class="line">    <span class="keyword">if</span>(xcOrdersByBusinessId != <span class="literal">null</span>){</span><br><span class="line">        <span class="keyword">return</span> xcOrdersByBusinessId;</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// 1.插入订单主表</span></span><br><span class="line">    <span class="type">XcOrders</span> <span class="variable">xcOrders</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XcOrders</span>();</span><br><span class="line">    xcOrders.setId(IdWorkerUtils.getInstance().nextId()); <span class="comment">//雪花算法生成订单号</span></span><br><span class="line">    xcOrders.setTotalPrice(addOrderDto.getTotalPrice());</span><br><span class="line">    xcOrders.setCreateDate(LocalDateTime.now());</span><br><span class="line">    xcOrders.setStatus(<span class="string">"600001"</span>);<span class="comment">//未支付</span></span><br><span class="line">    xcOrders.setUserId(userId);</span><br><span class="line">    xcOrders.setOrderType(<span class="string">"60201"</span>);<span class="comment">//订单类型:课程</span></span><br><span class="line">    xcOrders.setOrderName(addOrderDto.getOrderName());</span><br><span class="line">    xcOrders.setOrderDescrip(addOrderDto.getOrderDescrip());</span><br><span class="line">    xcOrders.setOrderDetail(addOrderDto.getOrderDetail());</span><br><span class="line">    xcOrders.setOutBusinessId(addOrderDto.getOutBusinessId());<span class="comment">//如果是购买课程此处是选课的ID</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">insert</span> <span class="operator">=</span> xcOrdersMapper.insert(xcOrders);</span><br><span class="line">    <span class="keyword">if</span>(insert &lt;= <span class="number">0</span>){</span><br><span class="line">        XueChengPlusException.cast(<span class="string">"插入订单失败"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="type">Long</span> <span class="variable">orderId</span> <span class="operator">=</span> xcOrders.getId();</span><br><span class="line">    <span class="comment">// 2.插入订单明细表</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">orderDetailJSON</span> <span class="operator">=</span> addOrderDto.getOrderDetail();</span><br><span class="line">    <span class="comment">//解析JSON</span></span><br><span class="line">    List&lt;XcOrdersGoods&gt; xcOrdersGoods = JSON.parseArray(orderDetailJSON, XcOrdersGoods.class);</span><br><span class="line">    <span class="comment">//遍历插入</span></span><br><span class="line">    <span class="keyword">for</span> (XcOrdersGoods xcOrdersGoods1 : xcOrdersGoods) {</span><br><span class="line">        xcOrdersGoods1.setOrderId(orderId);</span><br><span class="line">        <span class="type">int</span> <span class="variable">insert1</span> <span class="operator">=</span> xcOrdersGoodsMapper.insert(xcOrdersGoods1);</span><br><span class="line">        <span class="keyword">if</span>(insert1 &lt;= <span class="number">0</span>){</span><br><span class="line">            XueChengPlusException.cast(<span class="string">"插入订单明细失败"</span>);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> xcOrders;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>插入交易记录表</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 插入支付记录</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> orders 订单信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 支付记录</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="keyword">private</span> XcPayRecord <span class="title function_">createPayRecord</span><span class="params">(XcOrders orders)</span> {</span><br><span class="line">    <span class="comment">//订单ID</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">orderId</span> <span class="operator">=</span> orders.getId();</span><br><span class="line">    <span class="comment">//如果订单不存在,不添加支付记录</span></span><br><span class="line">    <span class="type">XcOrders</span> <span class="variable">xcOrders</span> <span class="operator">=</span> xcOrdersMapper.selectById(orderId);</span><br><span class="line">    <span class="keyword">if</span>(xcOrders == <span class="literal">null</span>){</span><br><span class="line">        XueChengPlusException.cast(<span class="string">"订单不存在"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//如果订单支付已成功,也不添加支付记录</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">status</span> <span class="operator">=</span> xcOrders.getStatus();</span><br><span class="line">    <span class="keyword">if</span>(<span class="string">"601002"</span>.equals(status)){</span><br><span class="line">        XueChengPlusException.cast(<span class="string">"订单已支付"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//插入支付记录</span></span><br><span class="line">    <span class="type">XcPayRecord</span> <span class="variable">xcPayRecord</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XcPayRecord</span>();</span><br><span class="line">    xcPayRecord.setPayNo(IdWorkerUtils.getInstance().nextId());<span class="comment">//雪花算法生成支付号</span></span><br><span class="line">    xcPayRecord.setOrderId(orderId);</span><br><span class="line">    xcPayRecord.setOrderName(xcOrders.getOrderName());</span><br><span class="line">    xcPayRecord.setTotalPrice(xcOrders.getTotalPrice());</span><br><span class="line">    xcPayRecord.setCurrency(<span class="string">"CNY"</span>);</span><br><span class="line">    xcPayRecord.setCreateDate(LocalDateTime.now());</span><br><span class="line">    xcPayRecord.setStatus(<span class="string">"601001"</span>);<span class="comment">//支付类型:未支付</span></span><br><span class="line">    xcPayRecord.setUserId(xcOrders.getUserId());</span><br><span class="line">    <span class="type">int</span> <span class="variable">insert</span> <span class="operator">=</span> xcPayRecordMapper.insert(xcPayRecord);</span><br><span class="line">    <span class="keyword">if</span>(insert &lt;= <span class="number">0</span>){</span><br><span class="line">        XueChengPlusException.cast(<span class="string">"插入支付记录失败"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//返回支付记录</span></span><br><span class="line">    <span class="keyword">return</span> xcPayRecord;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h4 id="创建支付交易记录"><a class="markdownIt-Anchor" href="#创建支付交易记录"></a> 创建支付交易记录</h4>
<p>为什么创建支付交易记录？</p>
<p>在请求微信或支付宝下单接口时需要传入 商品订单号，在与第三方支付平台对接时发现，当用户支付失败或因为其它原因最终该订单没有支付成功，此时再次调用第三方支付平台的下单接口发现报错“订单号已存在”，此时如果我们传入一个没有使用过的订单号就可以解决问题，但是商品订单已经创建，因为没有支付成功重新创建一个新订单是不合理的。</p>
<p>解决以上问题的方案是：</p>
<ol>
<li>
<p>用户每次发起都创建一个新的支付交易记录 ，此交易记录与商品订单关联。</p>
</li>
<li>
<p>将支付交易记录的流水号传给第三方支付系统下单接口，这样就即使没有支付成功就不会出现上边的问题。</p>
</li>
<li>
<p>需要提醒用户不要重复支付。</p>
</li>
</ol>
<img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240307161041581.png" alt="image-20240307161041581" style="zoom:50%;">
<p>编写创建支付交易记录的方法:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> XcPayRecord <span class="title function_">createPayRecord</span><span class="params">(XcOrders orders)</span>{</span><br><span class="line">    <span class="keyword">if</span>(order==<span class="literal">null</span>){</span><br><span class="line">        XueChengPlusException.cast(<span class="string">"订单不存在"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">if</span>(orders.getStatus().equals(<span class="string">"600002"</span>)){</span><br><span class="line">        XueChengPlusException.cast(<span class="string">"订单已支付"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="type">XcPayRecord</span> <span class="variable">payRecord</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XcPayRecord</span>();</span><br><span class="line">    <span class="comment">//生成支付交易流水号</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">payNo</span> <span class="operator">=</span> IdWorkerUtils.getInstance().nextId();</span><br><span class="line">    payRecord.setPayNo(payNo);</span><br><span class="line">    payRecord.setOrderId(orders.getId());<span class="comment">//商品订单号</span></span><br><span class="line">    payRecord.setOrderName(orders.getOrderName());</span><br><span class="line">    payRecord.setTotalPrice(orders.getTotalPrice());</span><br><span class="line">    payRecord.setCurrency(<span class="string">"CNY"</span>);</span><br><span class="line">    payRecord.setCreateDate(LocalDateTime.now());</span><br><span class="line">    payRecord.setStatus(<span class="string">"601001"</span>);<span class="comment">//未支付</span></span><br><span class="line">    payRecord.setUserId(orders.getUserId());</span><br><span class="line">    payRecordMapper.insert(payRecord);</span><br><span class="line">    <span class="keyword">return</span> payRecord;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h4 id="生成支付二维码-2"><a class="markdownIt-Anchor" href="#生成支付二维码-2"></a> 生成支付二维码</h4>
<ol>
<li>在nacos中order-service-dev.yaml配置二维码url</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">pay:</span></span><br><span class="line">  <span class="attr">qrcodeurl:</span> <span class="string">http://192.168.101.1/api/orders/requestpay?payNo=%s</span></span><br></pre></td></tr></table></figure>
<ol start="2">
<li>完善创建订单service方法</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Value("${pay.qrcodeurl}")</span></span><br><span class="line"><span class="keyword">private</span> String qrcodeUrl;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> PayRecordDto <span class="title function_">createOrder</span><span class="params">(String userId, AddOrderDto addOrderDto)</span> {</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//插入订单主表,订单明细表</span></span><br><span class="line">    <span class="type">XcOrders</span> <span class="variable">xcOrders</span> <span class="operator">=</span> saveXcOrders(userId, addOrderDto);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//插入支付记录</span></span><br><span class="line">    <span class="type">XcPayRecord</span> <span class="variable">xcPayRecord</span> <span class="operator">=</span> createPayRecord(xcOrders);</span><br><span class="line">    <span class="type">Long</span> <span class="variable">payNo</span> <span class="operator">=</span> xcPayRecord.getPayNo();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//生成支付二维码</span></span><br><span class="line">    <span class="type">QRCodeUtil</span> <span class="variable">qrCodeUtil</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">QRCodeUtil</span>();</span><br><span class="line">    <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> String.format(qrcodeUrl, payNo);</span><br><span class="line">    <span class="type">String</span> <span class="variable">qrCode</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        qrCode = qrCodeUtil.createQRCode(url, <span class="number">200</span>, <span class="number">200</span>);</span><br><span class="line">    } <span class="keyword">catch</span> (IOException e) {</span><br><span class="line">        XueChengPlusException.cast(<span class="string">"生成支付二维码失败"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="type">PayRecordDto</span> <span class="variable">payRecordDto</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PayRecordDto</span>();</span><br><span class="line">    BeanUtils.copyProperties(xcPayRecord, payRecordDto);</span><br><span class="line">    payRecordDto.setQrcode(qrCode);<span class="comment">//二维码</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> payRecordDto;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h4 id="生成二维码接口完善"><a class="markdownIt-Anchor" href="#生成二维码接口完善"></a> 生成二维码接口完善</h4>
<p>完善生成支付二维码controller接口</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">OrderService orderService;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ApiOperation("生成支付二维码")</span></span><br><span class="line"><span class="meta">@PostMapping("/generatepaycode")</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> PayRecordDto <span class="title function_">generatePayCode</span><span class="params">(<span class="meta">@RequestBody</span> AddOrderDto addOrderDto)</span> {</span><br><span class="line">    <span class="comment">//登录用户</span></span><br><span class="line">    SecurityUtil.<span class="type">XcUser</span> <span class="variable">user</span> <span class="operator">=</span> SecurityUtil.getUser();</span><br><span class="line">    <span class="keyword">if</span>(user == <span class="literal">null</span>){</span><br><span class="line">        XueChengPlusException.cast(<span class="string">"请登录后继续选课"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> orderService.createOrder(user.getId(), addOrderDto);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h4 id="扫码下单接口完善"><a class="markdownIt-Anchor" href="#扫码下单接口完善"></a> 扫码下单接口完善</h4>
<p>生成了支付二维码，用户扫码请求第三方支付平台下单、支付。</p>
<ol>
<li>定义查询支付交易记录的Service接口与实现方法</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据支付流水号查询支付记录</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> payNo 支付流水号</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 支付记录</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">XcPayRecord <span class="title function_">getPayRecordByPayno</span><span class="params">(String payNo)</span>;</span><br></pre></td></tr></table></figure>
<p>实现方法:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> XcPayRecord <span class="title function_">getPayRecordByPayno</span><span class="params">(String payNo)</span> {</span><br><span class="line">    <span class="comment">//根据支付流水号查询支付记录</span></span><br><span class="line">    <span class="keyword">return</span> xcPayRecordMapper.selectOne(<span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;XcPayRecord&gt;().eq(XcPayRecord::getPayNo, payNo));</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>下单接口</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@ApiOperation("扫码下单接口")</span></span><br><span class="line"><span class="meta">@GetMapping("/requestpay")</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">requestpay</span><span class="params">(String payNo, HttpServletResponse httpResponse)</span> <span class="keyword">throws</span> IOException, AlipayApiException {</span><br><span class="line">    <span class="comment">//传入支付记录号,判断支付记录是否存在</span></span><br><span class="line">    <span class="type">XcPayRecord</span> <span class="variable">xcPayRecordByPayNo</span> <span class="operator">=</span> orderService.getPayRecordByPayno(payNo);</span><br><span class="line">    <span class="keyword">if</span> ( xcPayRecordByPayNo == <span class="literal">null</span> ) {</span><br><span class="line">        XueChengPlusException.cast(<span class="string">"支付记录不存在"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//判断有没有支付成功</span></span><br><span class="line">    <span class="keyword">if</span> ( <span class="string">"601002"</span>.equals(xcPayRecordByPayNo.getStatus()) ) {</span><br><span class="line">        XueChengPlusException.cast(<span class="string">"支付已经成功,无需重复支付"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//请求支付宝下单</span></span><br><span class="line">    <span class="type">AlipayClient</span> <span class="variable">alipayClient</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultAlipayClient</span>(AlipayConfig.URL, APP_ID, APP_PRIVATE_KEY, AlipayConfig.FORMAT, AlipayConfig.CHARSET, ALIPAY_PUBLIC_KEY, AlipayConfig.SIGNTYPE);</span><br><span class="line">    <span class="comment">//获得初始化的AlipayClient</span></span><br><span class="line">    <span class="type">AlipayTradeWapPayRequest</span> <span class="variable">alipayRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AlipayTradeWapPayRequest</span>();<span class="comment">//创建API对应的request</span></span><br><span class="line">    <span class="comment">//        alipayRequest.setReturnUrl("http://domain.com/CallBack/return_url.jsp");</span></span><br><span class="line">    <span class="comment">//alipayRequest.setNotifyUrl("http://318f68d075.vicp.fun:45930/orders/paynotify");//在公共参数中设置回跳和通知地址</span></span><br><span class="line">    alipayRequest.setBizContent(<span class="string">"{"</span> +</span><br><span class="line">                                <span class="string">"    \"out_trade_no\":\""</span> + payNo + <span class="string">"\","</span> +</span><br><span class="line">                                <span class="string">"    \"total_amount\":"</span> + xcPayRecordByPayNo.getTotalPrice() + <span class="string">","</span> +</span><br><span class="line">                                <span class="string">"    \"subject\":\""</span> + xcPayRecordByPayNo.getOrderName() + <span class="string">"\","</span> +</span><br><span class="line">                                <span class="string">"    \"product_code\":\"QUICK_WAP_WAY\""</span> +</span><br><span class="line">                                <span class="string">"  }"</span>);<span class="comment">//填充业务参数</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">form</span> <span class="operator">=</span> alipayClient.pageExecute(alipayRequest).getBody(); <span class="comment">//调用SDK生成表单</span></span><br><span class="line">    httpResponse.setContentType(<span class="string">"text/html;charset="</span> + AlipayConfig.CHARSET);</span><br><span class="line">    httpResponse.getWriter().write(form);<span class="comment">//直接将完整的表单html输出到页面</span></span><br><span class="line">    httpResponse.getWriter().flush();</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h3 id="支付测试"><a class="markdownIt-Anchor" href="#支付测试"></a> 支付测试</h3>
<p>测试准备：</p>
<ol>
<li>
<p>启动网关服务、认证服务、验证码服务、学习中心服务、订单服务、内容管理服务。</p>
</li>
<li>
<p>发布一门收费课程。</p>
</li>
<li>
<p>使用资料目录中的新模板course_template.ftl</p>
</li>
</ol>
<p>测试流程：</p>
<ol>
<li>
<p>进入收费课程详细页面，点击马上学习。</p>
</li>
<li>
<p>跟踪浏览器及微服务，观察选课记录是否创建成功、商品订单是否创建成功、支付交易记录是否创建成功。</p>
</li>
<li>
<p>观察生成二维码是否成功</p>
</li>
<li>
<p>使用模拟器扫码测试，是否可以正常支付。</p>
</li>
</ol>
<p>最终结果</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/Snipaste_2024-03-06_19-18-08.png" alt="Snipaste_2024-03-06_19-18-08"></p>
<p>手机沙箱测试成功</p>
<h2 id="查询支付结果"><a class="markdownIt-Anchor" href="#查询支付结果"></a> 查询支付结果</h2>
<h3 id="接口定义"><a class="markdownIt-Anchor" href="#接口定义"></a> 接口定义</h3>
<p>根据前边我们调研的获取支付结果的接口，包括：主动查询支付结果、被动接收支付结果。</p>
<p>这里先实现主动查询支付结果，当支付完成用户点击“支付结果”将请求第三方支付平台查询支付结果。</p>
<p>在<code>OrderController</code>类中定义接口如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@ApiOperation("查询支付结果")</span></span><br><span class="line"><span class="meta">@GetMapping("/payresult")</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> PayRecordDto <span class="title function_">payresult</span><span class="params">(String payNo)</span> <span class="keyword">throws</span> IOException {</span><br><span class="line">    <span class="comment">//查询支付结果</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h3 id="接口实现"><a class="markdownIt-Anchor" href="#接口实现"></a> 接口实现</h3>
<h4 id="service总体接口"><a class="markdownIt-Anchor" href="#service总体接口"></a> <code>service</code>总体接口</h4>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 查询支付结果</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> payNo 支付流水号</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 支付结果</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">PayRecordDto <span class="title function_">queryPayResult</span><span class="params">(String payNo)</span>;</span><br></pre></td></tr></table></figure>
<p><code>service</code>实现</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> PayRecordDto <span class="title function_">queryPayResult</span><span class="params">(String payNo)</span> <span class="keyword">throws</span> AlipayApiException {</span><br><span class="line">    <span class="comment">//调用支付宝接口查询结果</span></span><br><span class="line">    <span class="type">XcPayRecord</span> <span class="variable">payRecord</span> <span class="operator">=</span> getPayRecordByPayno(payNo);</span><br><span class="line">    <span class="keyword">if</span>(payRecord == <span class="literal">null</span>){</span><br><span class="line">        XueChengPlusException.cast(<span class="string">"请重新点击获取二维码"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//根据支付流水号查询支付记录</span></span><br><span class="line">    <span class="type">PayStatusDto</span> <span class="variable">payStatusDto</span> <span class="operator">=</span> queryPayResultFromAlipay(payNo);</span><br><span class="line">    System.out.println(<span class="string">"payStatusDto = "</span> + payStatusDto);</span><br><span class="line">    <span class="keyword">if</span>(payStatusDto == <span class="literal">null</span>){</span><br><span class="line">        XueChengPlusException.cast(<span class="string">"支付记录不存在"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">//保存支付宝支付结果</span></span><br><span class="line">    currentProxy.saveAliPayStatus(payStatusDto);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//返回最新支付记录信息</span></span><br><span class="line">    <span class="type">XcPayRecord</span> <span class="variable">payRecordByPayno</span> <span class="operator">=</span> getPayRecordByPayno(payNo);</span><br><span class="line">    <span class="type">PayRecordDto</span> <span class="variable">payRecordDto</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PayRecordDto</span>();</span><br><span class="line">    BeanUtils.copyProperties(payRecordByPayno, payRecordDto);</span><br><span class="line">    <span class="keyword">return</span> payRecordDto;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h4 id="查询支付结果-2"><a class="markdownIt-Anchor" href="#查询支付结果-2"></a> 查询支付结果</h4>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 请求支付宝查询支付结果</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> payNo 支付交易号</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 支付结果</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="keyword">public</span> PayStatusDto <span class="title function_">queryPayResultFromAlipay</span><span class="params">(String payNo)</span> <span class="keyword">throws</span> AlipayApiException {</span><br><span class="line">    <span class="type">AlipayClient</span> <span class="variable">alipayClient</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultAlipayClient</span>(<span class="string">"https://openapi-sandbox.dl.alipaydev.com/gateway.do"</span>, APP_ID, APP_PRIVATE_KEY, AlipayConfig.FORMAT, AlipayConfig.CHARSET, ALIPAY_PUBLIC_KEY, AlipayConfig.SIGNTYPE);</span><br><span class="line">    <span class="type">AlipayTradeQueryRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AlipayTradeQueryRequest</span>();</span><br><span class="line">    <span class="type">JSONObject</span> <span class="variable">bizContent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">    bizContent.put(<span class="string">"out_trade_no"</span>, payNo);           <span class="comment">//out_trade_no和trade_no二选一即可</span></span><br><span class="line">    <span class="comment">//bizContent.put("trade_no", "2014112611001004680073956707");</span></span><br><span class="line">    request.setBizContent(bizContent.toString());</span><br><span class="line">    <span class="type">String</span> <span class="variable">resultJson</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span>{</span><br><span class="line">        <span class="type">AlipayTradeQueryResponse</span> <span class="variable">response</span> <span class="operator">=</span> alipayClient.execute(request);</span><br><span class="line">        <span class="comment">//交易不成功</span></span><br><span class="line">        <span class="keyword">if</span>(!response.isSuccess()){</span><br><span class="line">            XueChengPlusException.cast(<span class="string">"交易不成功"</span>);</span><br><span class="line">        }</span><br><span class="line">        resultJson = response.getBody();</span><br><span class="line">    }<span class="keyword">catch</span> (AlipayApiException e){</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        XueChengPlusException.cast(<span class="string">"调用支付宝查询接口失败"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//转map</span></span><br><span class="line">    <span class="type">Map</span> <span class="variable">resultMap</span> <span class="operator">=</span> JSON.parseObject(resultJson, Map.class);</span><br><span class="line">    <span class="type">Map</span> <span class="variable">alipay_trade_query_response</span> <span class="operator">=</span> (Map) resultMap.get(<span class="string">"alipay_trade_query_response"</span>);</span><br><span class="line">    <span class="comment">//支付结果</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">trade_status</span> <span class="operator">=</span> (String) alipay_trade_query_response.get(<span class="string">"trade_status"</span>);</span><br><span class="line">    <span class="type">String</span> <span class="variable">total_amount</span> <span class="operator">=</span> (String) alipay_trade_query_response.get(<span class="string">"total_amount"</span>);</span><br><span class="line">    <span class="type">String</span> <span class="variable">trade_no</span> <span class="operator">=</span> (String) alipay_trade_query_response.get(<span class="string">"trade_no"</span>);</span><br><span class="line">    <span class="comment">//保存支付结果</span></span><br><span class="line">    <span class="type">PayStatusDto</span> <span class="variable">payStatusDto</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PayStatusDto</span>();</span><br><span class="line">    payStatusDto.setOut_trade_no(payNo);</span><br><span class="line">    payStatusDto.setTrade_status(trade_status);</span><br><span class="line">    payStatusDto.setApp_id(APP_ID);</span><br><span class="line">    payStatusDto.setTrade_no(trade_no);</span><br><span class="line">    payStatusDto.setTotal_amount(total_amount);</span><br><span class="line">    <span class="keyword">return</span> payStatusDto;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h4 id="保存支付结果"><a class="markdownIt-Anchor" href="#保存支付结果"></a> 保存支付结果</h4>
<ol>
<li>定义接口</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 保存支付宝支付状态</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> payStatusDto 支付状态</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">saveAliPayStatus</span><span class="params">(PayStatusDto payStatusDto)</span>;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>实现</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveAliPayStatus</span><span class="params">(PayStatusDto payStatusDto)</span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">//如果支付成功</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">payNO</span> <span class="operator">=</span> payStatusDto.getOut_trade_no();</span><br><span class="line">    <span class="type">XcPayRecord</span> <span class="variable">payRecordByPayno</span> <span class="operator">=</span> getPayRecordByPayno(payNO);</span><br><span class="line">    <span class="keyword">if</span>(payRecordByPayno == <span class="literal">null</span>){</span><br><span class="line">        XueChengPlusException.cast(<span class="string">"找不到相关支付记录"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//拿到相关联订单id</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">orderId</span> <span class="operator">=</span> payRecordByPayno.getOrderId();</span><br><span class="line">    <span class="type">XcOrders</span> <span class="variable">xcOrders</span> <span class="operator">=</span> xcOrdersMapper.selectById(orderId);</span><br><span class="line">    <span class="keyword">if</span>(xcOrders == <span class="literal">null</span>){</span><br><span class="line">        XueChengPlusException.cast(<span class="string">"找不到相关订单"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//支付状态</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">statusFromDb</span> <span class="operator">=</span> payRecordByPayno.getStatus();</span><br><span class="line">    <span class="comment">//如果数据库支付状态已经成功,不再处理</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="string">"601002"</span>.equals(statusFromDb)){</span><br><span class="line">        <span class="comment">//支付已经成功</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//如果支付成功</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">tradeStatus</span> <span class="operator">=</span> payStatusDto.getTrade_status();</span><br><span class="line">    <span class="comment">//返回信息为支付成功</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="string">"TRADE_SUCCESS"</span>.equals(tradeStatus)){</span><br><span class="line">        <span class="comment">//更新支付记录表支付状态为支付成功</span></span><br><span class="line">        payRecordByPayno.setStatus(<span class="string">"601002"</span>);</span><br><span class="line">        <span class="comment">//支付宝订单号</span></span><br><span class="line">        payRecordByPayno.setOutPayNo(payStatusDto.getTrade_no());</span><br><span class="line">        <span class="comment">//第三方支付渠道编号</span></span><br><span class="line">        payRecordByPayno.setOutPayChannel(<span class="string">"Alipay"</span>);</span><br><span class="line">        <span class="comment">//支付成功时间</span></span><br><span class="line">        payRecordByPayno.setPaySuccessTime(LocalDateTime.now());</span><br><span class="line">        <span class="type">int</span> <span class="variable">update</span> <span class="operator">=</span> xcPayRecordMapper.updateById(payRecordByPayno);</span><br><span class="line">        <span class="keyword">if</span>(update &lt;= <span class="number">0</span>){</span><br><span class="line">            XueChengPlusException.cast(<span class="string">"更新支付记录失败"</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">//更新订单表支付状态为支付成功</span></span><br><span class="line">        xcOrders.setStatus(<span class="string">"600002"</span>);<span class="comment">//订单已经支付成功</span></span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">update1</span> <span class="operator">=</span> xcOrdersMapper.updateById(xcOrders);</span><br><span class="line">        <span class="keyword">if</span>(update1 &lt;= <span class="number">0</span>){</span><br><span class="line">            XueChengPlusException.cast(<span class="string">"更新订单失败"</span>);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h4 id="接口测试"><a class="markdownIt-Anchor" href="#接口测试"></a> 接口测试</h4>
<p>对界面扫码后查数据库验证即可</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240307183647563.png" alt="image-20240307183647563"></p>
<h4 id="接口问题"><a class="markdownIt-Anchor" href="#接口问题"></a> 接口问题</h4>
<p>由于雪花ID发送到前端会产生精度丢失,所以我们需要在后端的base包下处理格式</p>
<p>日后在遇到相同问题百度可以搜到相应答案</p>
<h2 id="接收支付通知"><a class="markdownIt-Anchor" href="#接收支付通知"></a> 接收支付通知</h2>
<h3 id="接口定义-2"><a class="markdownIt-Anchor" href="#接口定义-2"></a> 接口定义</h3>
<p>支付完成后第三方支付系统会主动通知支付结果，要实现主动通知需要在请求支付系统下单时传入NotifyUrl，这里有两个url：NotifyUrl和ReturnUrl，ReturnUrl是支付完成后支付系统携带支付结果重定向到ReturnUrl地址，NotifyUrl是支付完成后支付系统在后台定时去通知，使用NotifyUrl比使用ReturnUrl有保证。</p>
<p>根据接口描述：<a href="https://opendocs.alipay.com/open/203/105286%E7%9A%84%E5%86%85%E5%AE%B9%E4%B8%8B%E8%BE%B9%E5%9C%A8%E8%AE%A2%E5%8D%95%E6%9C%8D%E5%8A%A1%E5%AE%9A%E4%B9%89%E6%8E%A5%E6%94%B6%E6%94%AF%E4%BB%98%E7%BB%93%E6%9E%9C%E9%80%9A%E7%9F%A5%E7%9A%84%E6%8E%A5%E5%8F%A3%E3%80%82">https://opendocs.alipay.com/open/203/105286的内容下边在订单服务定义接收支付结果通知的接口。</a></p>
<p>首先在下单时指定NotifyUrl:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@ApiOperation("接收支付结果通知")</span></span><br><span class="line"><span class="meta">@PostMapping("/receivenotify")</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">receivenotify</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> IOException, AlipayApiException {</span><br><span class="line">    <span class="comment">//获取支付宝POST过来反馈信息</span></span><br><span class="line">    Map&lt;String, String&gt; params = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    <span class="type">Map</span> <span class="variable">requestParams</span> <span class="operator">=</span> request.getParameterMap();</span><br><span class="line">    <span class="keyword">for</span> ( <span class="type">Iterator</span> <span class="variable">iter</span> <span class="operator">=</span> requestParams.keySet().iterator(); iter.hasNext(); ) {</span><br><span class="line">        <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> (String) iter.next();</span><br><span class="line">        String[] values = (String[]) requestParams.get(name);</span><br><span class="line">        <span class="type">String</span> <span class="variable">valueStr</span> <span class="operator">=</span> <span class="string">""</span>;</span><br><span class="line">        <span class="keyword">for</span> ( <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; values.length; i++ ) {</span><br><span class="line">            valueStr = (i == values.length - <span class="number">1</span>) ? valueStr + values[i]</span><br><span class="line">                : valueStr + values[i] + <span class="string">","</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">//乱码解决，这段代码在出现乱码时使用。如果mysign和sign不相等也可以使用这段代码转化</span></span><br><span class="line">        <span class="comment">//valueStr = new String(valueStr.getBytes("ISO-8859-1"), "gbk");</span></span><br><span class="line">        params.put(name, valueStr);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">verify_result</span> <span class="operator">=</span> AlipaySignature.rsaCheckV1(params, ALIPAY_PUBLIC_KEY, AlipayConfig.CHARSET, <span class="string">"RSA2"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( verify_result ) {<span class="comment">//验证成功</span></span><br><span class="line">        <span class="comment">//获取支付宝的通知返回参数，可参考技术文档中页面跳转同步通知参数列表(以下仅供参考)//</span></span><br><span class="line">        <span class="comment">//商户订单号</span></span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">out_trade_no</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(request.getParameter(<span class="string">"out_trade_no"</span>).getBytes(<span class="string">"ISO-8859-1"</span>), <span class="string">"UTF-8"</span>);</span><br><span class="line">        <span class="comment">//支付宝交易号</span></span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">trade_no</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(request.getParameter(<span class="string">"trade_no"</span>).getBytes(<span class="string">"ISO-8859-1"</span>), <span class="string">"UTF-8"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//交易状态</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">trade_status</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(request.getParameter(<span class="string">"trade_status"</span>).getBytes(<span class="string">"ISO-8859-1"</span>), <span class="string">"UTF-8"</span>);</span><br><span class="line">        <span class="comment">//交易金额</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">total_amount</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(request.getParameter(<span class="string">"total_amount"</span>).getBytes(<span class="string">"ISO-8859-1"</span>), <span class="string">"UTF-8"</span>);</span><br><span class="line">        <span class="keyword">if</span> ( trade_status.equals(<span class="string">"TRADE_SUCCESS"</span>) ) {</span><br><span class="line">            <span class="comment">//更新支付记录表状态为成功,订单表未成功</span></span><br><span class="line">            <span class="type">PayStatusDto</span> <span class="variable">payStatusDto</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PayStatusDto</span>();</span><br><span class="line">            payStatusDto.setTrade_status(trade_status);</span><br><span class="line">            payStatusDto.setTrade_no(trade_no);</span><br><span class="line">            payStatusDto.setOut_trade_no(out_trade_no);</span><br><span class="line">            payStatusDto.setTotal_amount(total_amount);</span><br><span class="line">            payStatusDto.setApp_id(APP_ID);</span><br><span class="line">            orderService.saveAliPayStatus(payStatusDto);</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">//——请根据您的业务逻辑来编写程序（以上代码仅作参考）——</span></span><br><span class="line">        response.getWriter().write(<span class="string">"success"</span>);    <span class="comment">//请不要修改或删除</span></span><br><span class="line">    } <span class="keyword">else</span> {<span class="comment">//验证失败</span></span><br><span class="line">        response.getWriter().write(<span class="string">"fail"</span>);    <span class="comment">//请不要修改或删除</span></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>Service接口:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 保存支付宝支付状态</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> payStatusDto 支付状态</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">saveAliPayStatus</span><span class="params">(PayStatusDto payStatusDto)</span>;</span><br></pre></td></tr></table></figure>
<p>Service实现类:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveAliPayStatus</span><span class="params">(PayStatusDto payStatusDto)</span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">//如果支付成功</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">payNO</span> <span class="operator">=</span> payStatusDto.getOut_trade_no();</span><br><span class="line">    <span class="type">XcPayRecord</span> <span class="variable">payRecordByPayno</span> <span class="operator">=</span> getPayRecordByPayno(payNO);</span><br><span class="line">    <span class="keyword">if</span>(payRecordByPayno == <span class="literal">null</span>){</span><br><span class="line">        XueChengPlusException.cast(<span class="string">"找不到相关支付记录"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//拿到相关联订单id</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">orderId</span> <span class="operator">=</span> payRecordByPayno.getOrderId();</span><br><span class="line">    <span class="type">XcOrders</span> <span class="variable">xcOrders</span> <span class="operator">=</span> xcOrdersMapper.selectById(orderId);</span><br><span class="line">    <span class="keyword">if</span>(xcOrders == <span class="literal">null</span>){</span><br><span class="line">        XueChengPlusException.cast(<span class="string">"找不到相关订单"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//支付状态</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">statusFromDb</span> <span class="operator">=</span> payRecordByPayno.getStatus();</span><br><span class="line">    <span class="comment">//如果数据库支付状态已经成功,不再处理</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="string">"601002"</span>.equals(statusFromDb)){</span><br><span class="line">        <span class="comment">//支付已经成功</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//如果支付成功</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">tradeStatus</span> <span class="operator">=</span> payStatusDto.getTrade_status();</span><br><span class="line">    <span class="comment">//返回信息为支付成功</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="string">"TRADE_SUCCESS"</span>.equals(tradeStatus)){</span><br><span class="line">        <span class="comment">//更新支付记录表支付状态为支付成功</span></span><br><span class="line">        payRecordByPayno.setStatus(<span class="string">"601002"</span>);</span><br><span class="line">        <span class="comment">//支付宝订单号</span></span><br><span class="line">        payRecordByPayno.setOutPayNo(payStatusDto.getTrade_no());</span><br><span class="line">        <span class="comment">//第三方支付渠道编号</span></span><br><span class="line">        payRecordByPayno.setOutPayChannel(<span class="string">"Alipay"</span>);</span><br><span class="line">        <span class="comment">//支付成功时间</span></span><br><span class="line">        payRecordByPayno.setPaySuccessTime(LocalDateTime.now());</span><br><span class="line">        <span class="type">int</span> <span class="variable">update</span> <span class="operator">=</span> xcPayRecordMapper.updateById(payRecordByPayno);</span><br><span class="line">        <span class="keyword">if</span>(update &lt;= <span class="number">0</span>){</span><br><span class="line">            XueChengPlusException.cast(<span class="string">"更新支付记录失败"</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">//更新订单表支付状态为支付成功</span></span><br><span class="line">        xcOrders.setStatus(<span class="string">"600002"</span>);<span class="comment">//订单已经支付成功</span></span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">update1</span> <span class="operator">=</span> xcOrdersMapper.updateById(xcOrders);</span><br><span class="line">        <span class="keyword">if</span>(update1 &lt;= <span class="number">0</span>){</span><br><span class="line">            XueChengPlusException.cast(<span class="string">"更新订单失败"</span>);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h3 id="接口测试-2"><a class="markdownIt-Anchor" href="#接口测试-2"></a> 接口测试</h3>
<p>测试准备：</p>
<ol>
<li>
<p>启动网关服务、认证服务、验证码服务、学习中心服务、内容管理服务。</p>
</li>
<li>
<p>发布一门收费课程。</p>
</li>
</ol>
<p>测试流程：</p>
<ol>
<li>
<p>对选课进行支付</p>
</li>
<li>
<p>支付成功跟踪service方法的日志，支付成功需要更新支付交易表记录的状态、通知时间、支付宝交易号、支付渠道(Alipay)</p>
</li>
</ol>
<p>支付成功更新订单表的状态为空。</p>
<h1 id="支付通知"><a class="markdownIt-Anchor" href="#支付通知"></a> 支付通知</h1>
<h2 id="需求分析-2"><a class="markdownIt-Anchor" href="#需求分析-2"></a> 需求分析</h2>
<p>订单服务作为通用服务在订单支付成功后需要将支付结果异步通知给其它微服务。</p>
<p>下图使用了消息队列完成支付结果通知：</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240309162829957.png" alt="image-20240309162829957"></p>
<p>学习中心服务：对收费课程选课需要支付，与订单服务对接完成支付。</p>
<p>学习资源服务：对收费的学习资料需要购买后下载，与订单服务对接完成支付。</p>
<p>订单服务完成支付后将支付结果发给每一个与订单服务对接的微服务，订单服务将消息发给交换机，由交换机广播消息，每个订阅消息的微服务都可以接收到支付结果.</p>
<p>微服务收到支付结果根据订单的类型去更新自己的业务数据。</p>
<h2 id="技术方案"><a class="markdownIt-Anchor" href="#技术方案"></a> 技术方案</h2>
<p>使用消息队列进行异步通知需要保证消息的可靠性，即生产端将消息成功通知到消费端。</p>
<p>消息从生产端发送到消费端经历了如下过程：</p>
<ol>
<li>
<p>消息发送到交换机</p>
</li>
<li>
<p>消息由交换机发送到队列</p>
</li>
<li>
<p>消息者收到消息进行处理</p>
</li>
</ol>
<p>保证消息的可靠性需要保证以上过程的可靠性，本项目使用RabbitMQ可以通过如下方面保证消息的可靠性。</p>
<ol>
<li>生产者确认机制</li>
</ol>
<p>发送消息前使用数据库事务将消息保证到数据库表中</p>
<p>成功发送到交换机将消息从数据库中删除</p>
<ol start="2">
<li>mq持久化</li>
</ol>
<p>mq收到消息进行持久化，当mq重启即使消息没有消费完也不会丢失。</p>
<p>需要配置交换机持久化、队列持久化、发送消息时设置持久化。</p>
<p>3、消费者确认机制</p>
<p>消费者消费成功自动发送ack，否则重试消费。</p>
<h2 id="发送支付结果"><a class="markdownIt-Anchor" href="#发送支付结果"></a> 发送支付结果</h2>
<h3 id="订单集成服务mq"><a class="markdownIt-Anchor" href="#订单集成服务mq"></a> 订单集成服务MQ</h3>
<p>订单服务通过消息队列将支付结果发给学习中心服务，消息队列采用发布订阅模式。</p>
<ol>
<li>
<p>订单服务创建支付结果通知交换机。</p>
</li>
<li>
<p>学习中心服务绑定队列到交换机。</p>
</li>
</ol>
<p>项目使用RabbitMQ作为消息队列，在课前下发的虚拟上已经安装了RabbitMQ.</p>
<p>执行docker start rabbitmq 启动RabbitMQ。访问：<a href="http://192.168.101.65:15672/">http://192.168.101.65:15672/</a></p>
<p>账户密码：guest/guest</p>
<p>交换机为Fanout广播模式。</p>
<p>首先需要在学习中心服务和订单服务工程配置连接消息队列。</p>
<ol>
<li>首先在订单服务添加消息队列依赖</li>
</ol>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ol start="2">
<li>在nacos配置rabbitmq-dev.yaml为通用配置文件</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.101</span><span class="number">.65</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">guest</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">guest</span></span><br><span class="line">    <span class="attr">virtual-host:</span> <span class="string">/</span></span><br><span class="line">    <span class="attr">publisher-confirm-type:</span> <span class="string">correlated</span> <span class="comment">#correlated 异步回调，定义ConfirmCallback，MQ返回结果时会回调这个ConfirmCallback</span></span><br><span class="line">    <span class="attr">publisher-returns:</span> <span class="literal">false</span> <span class="comment">#开启publish-return功能，同样是基于callback机制，需要定义ReturnCallback</span></span><br><span class="line">    <span class="attr">template:</span></span><br><span class="line">      <span class="attr">mandatory:</span> <span class="literal">false</span> <span class="comment">#定义消息路由失败时的策略。true，则调用ReturnCallback；false：则直接丢弃消息</span></span><br><span class="line">    <span class="attr">listener:</span></span><br><span class="line">      <span class="attr">simple:</span></span><br><span class="line">        <span class="attr">acknowledge-mode:</span> <span class="string">none</span> <span class="comment">#出现异常时返回unack，消息回滚到mq；没有异常，返回ack ,manual:手动控制,none:丢弃消息，不回滚到mq</span></span><br><span class="line">        <span class="attr">retry:</span></span><br><span class="line">          <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment">#开启消费者失败重试</span></span><br><span class="line">          <span class="attr">initial-interval:</span> <span class="string">1000ms</span> <span class="comment">#初识的失败等待时长为1秒</span></span><br><span class="line">          <span class="attr">multiplier:</span> <span class="number">1</span> <span class="comment">#失败的等待时长倍数，下次等待时长 = multiplier * last-interval</span></span><br><span class="line">          <span class="attr">max-attempts:</span> <span class="number">3</span> <span class="comment">#最大重试次数</span></span><br><span class="line">          <span class="attr">stateless:</span> <span class="literal">true</span> <span class="comment">#true无状态；false有状态。如果业务中包含事务，这里改为false</span></span><br></pre></td></tr></table></figure>
<ol start="3">
<li>在订单服务接口工程引入rabbitmq-dev.yaml配置文件</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">shared-configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">data-id:</span> <span class="string">rabbitmq-${spring.profiles.active}.yaml</span></span><br><span class="line">    <span class="attr">group:</span> <span class="string">xuecheng-plus-common</span></span><br><span class="line">    <span class="attr">refresh:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<ol start="4">
<li>在订单服务service工程编写MQ配置类，配置交换机</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PayNotifyConfig</span> <span class="keyword">implements</span> <span class="title class_">ApplicationContextAware</span> {</span><br><span class="line"></span><br><span class="line">    <span class="comment">//交换机</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PAYNOTIFY_EXCHANGE_FANOUT</span> <span class="operator">=</span> <span class="string">"paynotify_exchange_fanout"</span>;</span><br><span class="line">    <span class="comment">//支付结果通知消息类型</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">MESSAGE_TYPE</span> <span class="operator">=</span> <span class="string">"payresult_notify"</span>;</span><br><span class="line">    <span class="comment">//支付通知队列</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PAYNOTIFY_QUEUE</span> <span class="operator">=</span> <span class="string">"paynotify_queue"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//声明交换机，且持久化</span></span><br><span class="line">    <span class="meta">@Bean(PAYNOTIFY_EXCHANGE_FANOUT)</span></span><br><span class="line">    <span class="keyword">public</span> FanoutExchange <span class="title function_">paynotify_exchange_fanout</span><span class="params">()</span> {</span><br><span class="line">        <span class="comment">// 三个参数：交换机名称、是否持久化、当没有queue与其绑定时是否自动删除</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">FanoutExchange</span>(PAYNOTIFY_EXCHANGE_FANOUT, <span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//支付通知队列,且持久化</span></span><br><span class="line">    <span class="meta">@Bean(PAYNOTIFY_QUEUE)</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">course_publish_queue</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> QueueBuilder.durable(PAYNOTIFY_QUEUE).build();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">//交换机和支付通知队列绑定</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">binding_course_publish_queue</span><span class="params">(<span class="meta">@Qualifier(PAYNOTIFY_QUEUE)</span> Queue queue, <span class="meta">@Qualifier(PAYNOTIFY_EXCHANGE_FANOUT)</span> FanoutExchange exchange)</span> {</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queue).to(exchange);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setApplicationContext</span><span class="params">(ApplicationContext applicationContext)</span> <span class="keyword">throws</span> BeansException {</span><br><span class="line">        <span class="comment">// 获取RabbitTemplate</span></span><br><span class="line">        <span class="type">RabbitTemplate</span> <span class="variable">rabbitTemplate</span> <span class="operator">=</span> applicationContext.getBean(RabbitTemplate.class);</span><br><span class="line">        <span class="comment">//消息处理service</span></span><br><span class="line">        <span class="type">MqMessageService</span> <span class="variable">mqMessageService</span> <span class="operator">=</span> applicationContext.getBean(MqMessageService.class);</span><br><span class="line">        <span class="comment">// 设置ReturnCallback</span></span><br><span class="line">        rabbitTemplate.setReturnCallback((message, replyCode, replyText, exchange, routingKey) -&gt; {</span><br><span class="line">            <span class="comment">// 投递失败，记录日志</span></span><br><span class="line">            log.info(<span class="string">"消息发送失败，应答码{}，原因{}，交换机{}，路由键{},消息{}"</span>,</span><br><span class="line">                     replyCode, replyText, exchange, routingKey, message.toString());</span><br><span class="line">            <span class="type">MqMessage</span> <span class="variable">mqMessage</span> <span class="operator">=</span> JSON.parseObject(message.toString(), MqMessage.class);</span><br><span class="line">            <span class="comment">//将消息再添加到消息表</span></span><br><span class="line">            mqMessageService.addMessage(mqMessage.getMessageType(),mqMessage.getBusinessKey1(),mqMessage.getBusinessKey2(),mqMessage.getBusinessKey3());</span><br><span class="line"></span><br><span class="line">        });</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h3 id="发送支付结果-2"><a class="markdownIt-Anchor" href="#发送支付结果-2"></a> 发送支付结果</h3>
<p>在OrderService中定义接口:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 发送通知结果</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> message</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">notifyPayResult</span><span class="params">(MqMessage message)</span>;</span><br></pre></td></tr></table></figure>
<p>编写接口实现方法:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">notifyPayResult</span><span class="params">(MqMessage message)</span> {</span><br><span class="line"></span><br><span class="line">    <span class="comment">//消息内容</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">jsonString</span> <span class="operator">=</span> JSON.toJSONString(message);</span><br><span class="line"></span><br><span class="line">    <span class="type">Message</span> <span class="variable">messageObj</span> <span class="operator">=</span> MessageBuilder.withBody(jsonString.getBytes(StandardCharsets.UTF_8))</span><br><span class="line">        .setDeliveryMode(MessageDeliveryMode.PERSISTENT).build();</span><br><span class="line">    <span class="comment">//全局消息ID</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">id</span> <span class="operator">=</span> message.getId();</span><br><span class="line">    <span class="type">CorrelationData</span> <span class="variable">correlationData</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CorrelationData</span>();</span><br><span class="line">    <span class="comment">//使用CorrelationData对象指定回调方法</span></span><br><span class="line">    correlationData.getFuture().addCallback(</span><br><span class="line">        result -&gt; {</span><br><span class="line">            <span class="keyword">if</span>(result.isAck()){</span><br><span class="line">                <span class="comment">//消息成功发送到交换机</span></span><br><span class="line">                log.info(<span class="string">"消息成功发送到交换机:{}"</span>,jsonString);</span><br><span class="line">                <span class="comment">//将消息从数据库表删除</span></span><br><span class="line">                mqMessageService.completed(id);</span><br><span class="line">            }<span class="keyword">else</span>{</span><br><span class="line">                <span class="comment">//消息发送到交换机失败</span></span><br><span class="line">                log.info(<span class="string">"消息发送到交换机失败:{}"</span>,jsonString);</span><br><span class="line">            }</span><br><span class="line">        },</span><br><span class="line">        ex -&gt; {</span><br><span class="line">            <span class="comment">//发生异常了</span></span><br><span class="line">            log.info(<span class="string">"消息发送到交换机异常:{}"</span>,jsonString);</span><br><span class="line">        }</span><br><span class="line">    );</span><br><span class="line">    rabbitTemplate.convertAndSend(PayNotifyConfig.PAYNOTIFY_EXCHANGE_FANOUT, <span class="string">""</span>, messageObj, correlationData);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>订单服务收到第三方平台的支付结果时，在saveAliPayStatus方法中添加代码，向数据库消息表添加消息并进行发送消息，如下所示:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//保存消息记录,参数1：支付结果通知类型，2: 业务id，3:业务类型</span></span><br><span class="line"><span class="type">MqMessage</span> <span class="variable">payresultNotify</span> <span class="operator">=</span> mqMessageService.addMessage(<span class="string">"payresult_notify"</span>,</span><br><span class="line">                                                        xcOrders.getOutBusinessId(),</span><br><span class="line">                                                        xcOrders.getOrderType(),</span><br><span class="line">                                                        <span class="literal">null</span>);</span><br><span class="line"><span class="comment">//发送消息</span></span><br><span class="line">notifyPayResult(payresultNotify);</span><br></pre></td></tr></table></figure>
<h2 id="接收支付结果"><a class="markdownIt-Anchor" href="#接收支付结果"></a> 接收支付结果</h2>
<h3 id="学习中心服务集成mq"><a class="markdownIt-Anchor" href="#学习中心服务集成mq"></a> 学习中心服务集成MQ</h3>
<ol>
<li>在学习中心服务添加消息队列依赖</li>
</ol>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ol start="2">
<li>在学习中心服务接口工程引入rabbitmq-dev.yaml配置文件</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">shared-configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">data-id:</span> <span class="string">rabbitmq-${spring.profiles.active}.yaml</span></span><br><span class="line">    <span class="attr">group:</span> <span class="string">xuecheng-plus-common</span></span><br><span class="line">    <span class="attr">refresh:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<ol start="3">
<li>添加配置类</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PayNotifyConfig</span> {</span><br><span class="line"></span><br><span class="line">    <span class="comment">//交换机</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PAYNOTIFY_EXCHANGE_FANOUT</span> <span class="operator">=</span> <span class="string">"paynotify_exchange_fanout"</span>;</span><br><span class="line">    <span class="comment">//支付结果通知消息类型</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">MESSAGE_TYPE</span> <span class="operator">=</span> <span class="string">"payresult_notify"</span>;</span><br><span class="line">    <span class="comment">//支付通知队列</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PAYNOTIFY_QUEUE</span> <span class="operator">=</span> <span class="string">"paynotify_queue"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//声明交换机，且持久化</span></span><br><span class="line">    <span class="meta">@Bean(PAYNOTIFY_EXCHANGE_FANOUT)</span></span><br><span class="line">    <span class="keyword">public</span> FanoutExchange <span class="title function_">paynotify_exchange_fanout</span><span class="params">()</span> {</span><br><span class="line">        <span class="comment">// 三个参数：交换机名称、是否持久化、当没有queue与其绑定时是否自动删除</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">FanoutExchange</span>(PAYNOTIFY_EXCHANGE_FANOUT, <span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//支付通知队列,且持久化</span></span><br><span class="line">    <span class="meta">@Bean(PAYNOTIFY_QUEUE)</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">course_publish_queue</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> QueueBuilder.durable(PAYNOTIFY_QUEUE).build();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">//交换机和支付通知队列绑定</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">binding_course_publish_queue</span><span class="params">(<span class="meta">@Qualifier(PAYNOTIFY_QUEUE)</span> Queue queue, <span class="meta">@Qualifier(PAYNOTIFY_EXCHANGE_FANOUT)</span> FanoutExchange exchange)</span> {</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queue).to(exchange);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h3 id="接收支付结果-2"><a class="markdownIt-Anchor" href="#接收支付结果-2"></a> 接收支付结果</h3>
<ol>
<li>新建Service来接收支付结果</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.learning.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.base.exception.XueChengPlusException;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.learning.config.PayNotifyConfig;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.learning.service.MyCourseTableService;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.messagesdk.model.po.MqMessage;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Message;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Wwh</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ProjectName</span> xuecheng-plus-project</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@dateTime</span> 2024/3/9 17:11</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 支付通知服务</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReceivePayNotifyService</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MyCourseTableService myCourseTableService;</span><br><span class="line">    <span class="meta">@RabbitListener(queues = PayNotifyConfig.PAYNOTIFY_QUEUE)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">receivePayNotify</span><span class="params">(Message message)</span> {</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            Thread.sleep(<span class="number">5000</span>);</span><br><span class="line">        } <span class="keyword">catch</span> (InterruptedException e) {</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        }</span><br><span class="line">        log.info(<span class="string">"接收到支付通知消息：{}"</span>, message);</span><br><span class="line">        <span class="type">byte</span>[] body = message.getBody();</span><br><span class="line">        <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(body);</span><br><span class="line">        <span class="comment">//转为对象</span></span><br><span class="line">        <span class="type">MqMessage</span> <span class="variable">mqMessage</span> <span class="operator">=</span> JSON.parseObject(msg, MqMessage.class);</span><br><span class="line">        <span class="comment">//解析消息内容</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//选课ID</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">chooseCourseId</span> <span class="operator">=</span> mqMessage.getBusinessKey1();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取订单类型</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">orderType</span> <span class="operator">=</span> mqMessage.getBusinessKey2();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//学习中心类服务只要购买课程的支付订单结果</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="string">"60201"</span>.equals(orderType)){</span><br><span class="line">            <span class="comment">//支付成功</span></span><br><span class="line">            <span class="comment">//根据消息内容,更新选课记录,像我的课程表添加课程</span></span><br><span class="line">            <span class="type">boolean</span> <span class="variable">b</span> <span class="operator">=</span> myCourseTableService.saveChooseCourseSuccess(chooseCourseId);</span><br><span class="line">            <span class="keyword">if</span>(!b){</span><br><span class="line">                XueChengPlusException.cast(<span class="string">"保存选课记录失败"</span>);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>在MyCourseTableService中添加</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> courseId 课程id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> boolean</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 保存选课成功记录，用于后续查询学习状态，是否已经选课等等</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">boolean</span> <span class="title function_">saveChooseCourseSuccess</span><span class="params">(String courseId)</span>;</span><br></pre></td></tr></table></figure>
<p>实现方法:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">saveChooseCourseSuccess</span><span class="params">(String courseId)</span> {</span><br><span class="line">    <span class="comment">//防止脏数据</span></span><br><span class="line">    <span class="comment">//根据选课ID查询选课记录</span></span><br><span class="line">    <span class="type">XcChooseCourse</span> <span class="variable">xcChooseCourse</span> <span class="operator">=</span> xcChooseCourseMapper.selectById(courseId);</span><br><span class="line">    <span class="keyword">if</span> ( xcChooseCourse == <span class="literal">null</span> ) {</span><br><span class="line">        log.debug(<span class="string">"接收到购买课程信息,但选课记录不存在,选课ID:{}"</span>, courseId);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//选课状态</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">status</span> <span class="operator">=</span> xcChooseCourse.getStatus();</span><br><span class="line">    <span class="comment">//未支付时才更新为已支付</span></span><br><span class="line">    <span class="keyword">if</span> ( status.equals(<span class="string">"701002"</span>) ) {</span><br><span class="line">        <span class="comment">//更新选课记录为成功</span></span><br><span class="line">        xcChooseCourse.setStatus(<span class="string">"701001"</span>);</span><br><span class="line">        <span class="comment">//向我的课程表插入数据</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">insert</span> <span class="operator">=</span> xcChooseCourseMapper.updateById(xcChooseCourse);</span><br><span class="line">        <span class="keyword">if</span>(insert &lt;= <span class="number">0</span>){</span><br><span class="line">            log.debug(<span class="string">"更新选课记录失败,选课ID:{}"</span>, courseId);</span><br><span class="line">            XueChengPlusException.cast(<span class="string">"更新选课记录失败"</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">//向我的课程表插入</span></span><br><span class="line">        <span class="type">XcCourseTables</span> <span class="variable">xcCourseTables</span> <span class="operator">=</span> addCourseTabls(xcChooseCourse);</span><br><span class="line">        <span class="keyword">if</span>(xcCourseTables == <span class="literal">null</span>){</span><br><span class="line">            log.debug(<span class="string">"向我的课程表插入数据失败,选课ID:{}"</span>, courseId);</span><br><span class="line">            XueChengPlusException.cast(<span class="string">"向我的课程表插入数据失败"</span>);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h2 id="通知支付结果测试"><a class="markdownIt-Anchor" href="#通知支付结果测试"></a> 通知支付结果测试</h2>
<p><strong>通知支付结果测试</strong></p>
<p>测试准备：</p>
<ol>
<li>
<p>找一门已发布的收费课程。</p>
</li>
<li>
<p>如果在我的课程表存储则删除。</p>
</li>
<li>
<p>删除此课程的选课记录及订单信息。</p>
</li>
</ol>
<p>测试流程：</p>
<ol>
<li>
<p>进入课程详细页面，点击马上学习，生成二维码进行支付。</p>
</li>
<li>
<p>支付完成点击“支付完成”，观察订单服务控制台是否发送消息。</p>
</li>
<li>
<p>观察学习中心服务控制台是否接收到消息。</p>
</li>
<li>
<p>观察数据库中的消息表的相应记录是否已删除。</p>
</li>
</ol>
<p>消费重试测试：</p>
<ol>
<li>
<p>在学习中心服务接收支付结果方法中制造异常。</p>
</li>
<li>
<p>重新执行上边的测试流程，观察是否消费重试。</p>
</li>
</ol>
]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>学习</tag>
        <tag>后端</tag>
        <tag>黑马程序员</tag>
        <tag>学成在线</tag>
      </tags>
  </entry>
  <entry>
    <title>学成在线Day14</title>
    <url>/2024/03/21/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFDay14/</url>
    <content><![CDATA[<h1 id="项目优化"><a class="markdownIt-Anchor" href="#项目优化"></a> 项目优化</h1>
<h1 id="优化需求"><a class="markdownIt-Anchor" href="#优化需求"></a> 优化需求</h1>
<p>视频播放页面用户未登录也可以访问，当用户观看试学课程时需要请求服务端查询数据，接口如下：</p>
<ol>
<li>
<p>根据课程id查询课程信息。</p>
</li>
<li>
<p>根据文件id查询视频信息。</p>
</li>
</ol>
<p>这些接口在用户未认证状态下也可以访问，如果接口的性能不高，当高并发到来很可能耗尽整个系统的资源，将整个系统压垮，所以特别需要对这些暴露在外边的接口进行优化。</p>
<p>下边对 根据课程id查询课程信息 接口进行优化，下边的内容将此接口简称为课程查询接口。</p>
<p>接口地址：<a href="http://www.51xuecheng.cn/open/content/course/whole/%7BcourseId%7D">http://www.51xuecheng.cn/open/content/course/whole/{courseId}</a></p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240314091725298.png" alt="image-20240314091725298"></p>
<h1 id="压力测试"><a class="markdownIt-Anchor" href="#压力测试"></a> 压力测试</h1>
<h2 id="性能指标"><a class="markdownIt-Anchor" href="#性能指标"></a> 性能指标</h2>
<p>对接口进行优化之前需要对接口进行压力测试，不仅接口需要压力测试，整个微服务在发布前也是需要经历压力测试的，因为压力测试可以暴露功能测试所发现不了的问题。</p>
<p>功能测试即是对系统的功能按用户需求进行测试，比如：添加一门课程，根据需求文档先准备测试数据，再通过前端界面将一门课程添加到系统，测试是否可以操作成功。整个过程就是测试软件是否可以实现用户的需求。</p>
<p>压力测试是通过测试工具制造大规模的并发请求去访问系统，测试系统是否经受住压力。</p>
<p>比如：一个在线学习网站，上线要求该网站可以支持1万用户同时在线，此时就需要模拟1万并发请求去访问网站的关键业务流程，比如：测试点播学习流程，测试系统是否可以抗住1万并发请求。</p>
<p>一些功能测试时无法发现的问题在压力测试时就会发现，比如：内存泄露、线程安全、IO异常等问题。</p>
<p>压力测试常用的性能指标如下：</p>
<ol>
<li>吞吐量</li>
</ol>
<p>吞吐量是系统每秒可以处理的事务数，也称为TPS（Transaction Per Second）。</p>
<p>比如：一次点播流程，从请求进入系统到视频画图显示出来这整个流程就是一次事务。</p>
<p>所以吞吐量并不是一次数据库事务，它是完成一次业务的整体流程。</p>
<ol start="2">
<li>响应时间</li>
</ol>
<p>响应时间是指客户端请求服务端，从请求进入系统到客户端拿到响应结果所经历的时间。响应时间包括：最大响应时间、最小响应时间、平均响应时间。</p>
<ol start="3">
<li>每秒查询数</li>
</ol>
<p>每秒查询数即QPS（Queries-per-second），它是衡量查询接口的性能指标，比如：商品信息查询， 一秒可以请求该接口查询商品信息的次数就是QPS。</p>
<p>拿查询接口举例，一次查询请求内部不会再去请求其它接口，此时 <code>QPS = TPS</code></p>
<p>如果一次查询请求内容需要远程调用另一个接口查询数据，此时 <code>QPS = 2 * TPS</code></p>
<ol start="4">
<li>错误率</li>
</ol>
<p>错误率 是一批请求发生错误的请求占全部请求的比例。</p>
<p>不同的指标其要求不同，比如现在进行接口优化，优化后的接口响应时间应该越来越小，吞吐量越来越大，以及QPS值也是越大越好，错误率要保持在一个很小的范围。</p>
<p>另外除了关注这些性能指标以外还要关注系统的负载情况：</p>
<ol>
<li>
<p>CPU使用率，不高于 <code>85%</code></p>
</li>
<li>
<p>内存利用率，不高于 <code>85%</code></p>
</li>
<li>
<p>网络利用率，不高于 <code>80%</code></p>
</li>
<li>
<p>磁盘IO</p>
</li>
</ol>
<p>磁盘IO的性能指标是IOPS (Input/Output Per Second)即每秒的输入输出量(或读写次数)。</p>
<p>如果过大说明IO操作密集，IO过大也会影响性能指标。</p>
<h2 id="安装jmeter"><a class="markdownIt-Anchor" href="#安装jmeter"></a> 安装Jmeter</h2>
<p>Apache JMeter 是 Apache 组织基于 Java 开发的压力测试工具，用于对软件做压力测试。</p>
<p>下载Jmeter</p>
<p><a href="https://jmeter.apache.org/download_jmeter.cgi">https://jmeter.apache.org/download_jmeter.cgi</a></p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240314092408135.png" alt="image-20240314092408135"></p>
<p>下载，解压，进入bin目录修改<code>jmeter.properties</code>，设置中文和字体</p>
<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">language=zh_CN</span><br><span class="line">jmeter.hidpi.mode=true</span><br><span class="line">jmeter.hidpi.scale.factor=1.8</span><br><span class="line">jsyntaxtextarea.font.family= Hack</span><br><span class="line">jsyntaxtextarea.font.size=25</span><br><span class="line">jmeter.toolbar.icons.size=32x32</span><br><span class="line">jmeter.tree.icons.size=24x24</span><br></pre></td></tr></table></figure>
<p>双击运行bin目录下的<code>jmeter.bat</code>文件。</p>
<img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240314092739311.png" alt="image-20240314092739311" style="zoom:50%;">
<h2 id="压力测试-2"><a class="markdownIt-Anchor" href="#压力测试-2"></a> 压力测试</h2>
<p>样本数：200个线程，每个线程请求100次，共20000次</p>
<p>压力机：通常压力机是单独的客户端。</p>
<p>测试gateway+content</p>
<p>吞吐量180左右</p>
<img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240314100128751.png" alt="image-20240314100128751" style="zoom:50%;">
<p>单独测试content</p>
<p>吞吐量680左右</p>
<img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240314100233851.png" alt="image-20240314100233851" style="zoom:50%;">
<h2 id="优化日志"><a class="markdownIt-Anchor" href="#优化日志"></a> 优化日志</h2>
<p>内容管理日志级别改为info级别.</p>
<img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240314101147300.png" alt="image-20240314101147300" style="zoom:50%;">
<p>吞吐量接近1000，受限于本人机能，不进行下一步测试</p>
<h1 id="缓存优化"><a class="markdownIt-Anchor" href="#缓存优化"></a> 缓存优化</h1>
<h2 id="redis缓存"><a class="markdownIt-Anchor" href="#redis缓存"></a> redis缓存</h2>
<p>测试用例是根据id查询课程信息，这里不存在复杂的SQL，也不存在数据库连接不释放的问题，暂时不考虑数据库方面的优化。</p>
<p>课程发布信息的特点的是查询较多，修改很少，这里考虑将课程发布信息进行缓存。</p>
<p>课程信息缓存的流程如下：</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240314101328633.png" alt="image-20240314101328633"></p>
<p>在nacos配置<code>redis-dev.yaml（group=xuecheng-plus-common）</code></p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span> </span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.101</span><span class="number">.65</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">6379</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">redis</span></span><br><span class="line">    <span class="attr">database:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">lettuce:</span></span><br><span class="line">      <span class="attr">pool:</span></span><br><span class="line">        <span class="attr">max-active:</span> <span class="number">20</span></span><br><span class="line">        <span class="attr">max-idle:</span> <span class="number">10</span></span><br><span class="line">        <span class="attr">min-idle:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="number">10000</span></span><br></pre></td></tr></table></figure>
<p>在content-api的bootstrap.yml文件中添加配置</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">shared-configs:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">data-id:</span> <span class="string">redis-${spring.profiles.active}.yaml</span></span><br><span class="line">      <span class="attr">group:</span> <span class="string">xuecheng-plus-common</span></span><br><span class="line">      <span class="attr">refresh:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<p>在content-service微服务中添加依赖</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-pool2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.6.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>定义查询缓存接口：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 获取课程发布信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> courseId 课程id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> com.xuecheng.content.model.po.CoursePublish 课程发布信息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">CoursePublish <span class="title function_">getCoursePublishCache</span><span class="params">(Long courseId)</span>;</span><br></pre></td></tr></table></figure>
<p>接口实现:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> CoursePublish <span class="title function_">getCoursePublishCache</span><span class="params">(Long courseId)</span> {</span><br><span class="line">    <span class="comment">//查询缓存</span></span><br><span class="line">    <span class="type">Object</span> <span class="variable">jsonObj</span> <span class="operator">=</span> redisTemplate.opsForValue().get(<span class="string">"course:"</span> + courseId);</span><br><span class="line">    <span class="keyword">if</span> ( jsonObj != <span class="literal">null</span> ) {</span><br><span class="line">        <span class="type">String</span> <span class="variable">jsonString</span> <span class="operator">=</span> jsonObj.toString();</span><br><span class="line">        log.info(<span class="string">"=================从缓存查================="</span>);</span><br><span class="line">        <span class="type">CoursePublish</span> <span class="variable">coursePublish</span> <span class="operator">=</span> JSON.parseObject(jsonString, CoursePublish.class);</span><br><span class="line">        <span class="keyword">return</span> coursePublish;</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        log.info(<span class="string">"从数据库查询..."</span>);</span><br><span class="line">        <span class="comment">//从数据库查询</span></span><br><span class="line">        <span class="type">CoursePublish</span> <span class="variable">coursePublish</span> <span class="operator">=</span> getCoursePublish(courseId);</span><br><span class="line">        <span class="keyword">if</span> ( coursePublish != <span class="literal">null</span> ) {</span><br><span class="line">            redisTemplate.opsForValue().set(<span class="string">"course:"</span> + courseId, JSON.toJSONString(coursePublish));</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> coursePublish;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>修改接口层：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@ApiOperation("获取课程发布信息")</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="meta">@GetMapping("/course/whole/{courseId}")</span></span><br><span class="line"><span class="keyword">public</span> CoursePreviewDTO <span class="title function_">getCoursePublish</span><span class="params">(<span class="meta">@PathVariable("courseId")</span> Long courseId)</span> {</span><br><span class="line">    <span class="comment">//封装数据</span></span><br><span class="line">    <span class="type">CoursePreviewDTO</span> <span class="variable">coursePreviewDTO</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CoursePreviewDTO</span>();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//查询课程发布表</span></span><br><span class="line">    <span class="comment">//CoursePublish coursePublish = coursePublishService.getCoursePublish(courseId);</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//查询课程基本信息(缓存)</span></span><br><span class="line">    <span class="type">CoursePublish</span> <span class="variable">coursePublish</span> <span class="operator">=</span> coursePublishService.getCoursePublishCache(courseId);</span><br><span class="line">    <span class="keyword">if</span>(coursePublish == <span class="literal">null</span>){</span><br><span class="line">        <span class="keyword">return</span> coursePreviewDTO;</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//向dto中封装数据</span></span><br><span class="line">    <span class="type">CourseBaseInfoDTO</span> <span class="variable">courseBaseInfoDTO</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CourseBaseInfoDTO</span>();</span><br><span class="line">    BeanUtils.copyProperties(coursePublish, courseBaseInfoDTO);</span><br><span class="line">    coursePreviewDTO.setCourseBase(courseBaseInfoDTO);</span><br><span class="line">    <span class="comment">//查询课程计划</span></span><br><span class="line">    <span class="comment">//从CouseBaseInfoDTO中获取课程计划</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">teachPlanJson</span> <span class="operator">=</span> coursePublish.getTeachplan();</span><br><span class="line">    List&lt;TeachplanDTO&gt; teachplanDTOS = JSON.parseArray(teachPlanJson, TeachplanDTO.class);</span><br><span class="line">    coursePreviewDTO.setTeachPlans(teachplanDTOS);</span><br><span class="line">    <span class="keyword">return</span> coursePreviewDTO;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>重新启动jmeter测试结果</p>
<p>吞吐量达到2700左右</p>
<img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240314104245614.png" style="zoom:50%;">
<h2 id="缓存穿透"><a class="markdownIt-Anchor" href="#缓存穿透"></a> 缓存穿透</h2>
<h3 id="什么是缓存穿透"><a class="markdownIt-Anchor" href="#什么是缓存穿透"></a> 什么是缓存穿透</h3>
<p>使用缓存后代码的性能有了很大的提高，虽然性能有很大的提升但是控制台打出了很多“从数据库查询”的日志，明明判断了如果缓存存在课程信息则从缓存查询，为什么要有这么多从数据库查询的请求的？</p>
<p>这是因为并发数高，很多线程会同时到达查询数据库代码处去执行。</p>
<p>我们分析下代码：</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240314104813880.png" alt=""></p>
<p>如果存在恶意攻击的可能，如果有大量并发去查询一个不存在的课程信息会出现什么问题呢？</p>
<p>比如去请求/content/course/whole/181，查询181号课程，该课程并不在课程发布表中。</p>
<p>进行压力测试发现会去请求数据库。</p>
<p>大量并发去访问一个数据库不存在的数据，由于缓存中没有该数据导致大量并发查询数据库，这个现象要缓存穿透。</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240314105105518.png" alt="image-20240314105105518"></p>
<p>缓存穿透可以造成数据库瞬间压力过大，连接数等资源用完，最终数据库拒绝连接不可用。</p>
<h3 id="解决缓存穿透"><a class="markdownIt-Anchor" href="#解决缓存穿透"></a> 解决缓存穿透</h3>
<p>如何解决缓存穿透?</p>
<ol>
<li>对请求增加校验机制</li>
</ol>
<p>比如：课程Id是长整型，如果发来的不是长整型则直接返回。</p>
<ol start="2">
<li>使用布隆过滤器</li>
</ol>
<p>什么是布隆过滤器，以下摘自百度百科：</p>
<p>布隆过滤器可以用于检索一个元素是否在一个集合中。如果想要判断一个元素是不是在一个集合里，一般想到的是将所有元素保存起来，然后通过比较确定。<a href="https://baike.baidu.com/item/%E9%93%BE%E8%A1%A8/9794473?fromModule=lemma_inlink">链表</a>，树等等数据结构都是这种思路. 但是随着集合中元素的增加，我们需要的存储空间越来越大，<a href="https://baike.baidu.com/item/%E6%A3%80%E7%B4%A2%E9%80%9F%E5%BA%A6/20807841?fromModule=lemma_inlink">检索速度</a>也越来越慢(O(n),O(logn))。不过世界上还有一种叫作散列表（又叫<a href="https://baike.baidu.com/item/%E5%93%88%E5%B8%8C%E8%A1%A8/5981869?fromModule=lemma_inlink">哈希表</a>，Hash table）的数据结构。它可以通过一个Hash函数将一个元素映射成一个位阵列（Bit array）中的一个点。这样一来，我们只要看看这个点是不是1就可以知道集合中有没有它了。这就是布隆过滤器的基本思想。</p>
<p>布隆过滤器的特点是，高效地插入和查询，占用空间少；查询结果有不确定性，如果查询结果是存在则元素不一定存在，如果不存在则一定不存在；另外它只能添加元素不能删除元素，因为删除元素会增加误判率。</p>
<p>比如：将商品id写入布隆过滤器，如果分3次hash此时在布隆过滤器有3个点，当从布隆过滤器查询该商品id，通过hash找到了该商品id在过滤器中的点，此时返回1，如果找不到一定会返回0。</p>
<p>所以，为了避免缓存穿透我们需要缓存预热将要查询的课程或商品信息的id提前存入布隆过滤器，添加数据时将信息的id也存入过滤器，当去查询一个数据时先在布隆过滤器中找一下如果没有到到就说明不存在，此时直接返回。</p>
<p>实现方法有：</p>
<blockquote>
<p>Google工具包Guava实现</p>
</blockquote>
<blockquote>
<p>redisson</p>
</blockquote>
<ol start="2">
<li>缓存空值或特殊值</li>
</ol>
<p>请求通过了第一步的校验，查询数据库得到的数据不存在，此时我们仍然去缓存数据，缓存一个空值或一个特殊值的数据。</p>
<p>但是要注意：如果缓存了空值或特殊值要设置一个短暂的过期时间。</p>
<p>service修改后如下:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> CoursePublish <span class="title function_">getCoursePublishCache</span><span class="params">(Long courseId)</span> {</span><br><span class="line">    <span class="comment">//查询缓存</span></span><br><span class="line">    <span class="type">Object</span> <span class="variable">jsonObj</span> <span class="operator">=</span> redisTemplate.opsForValue().get(<span class="string">"course:"</span> + courseId);</span><br><span class="line">    <span class="keyword">if</span> ( jsonObj != <span class="literal">null</span> ) {</span><br><span class="line">        <span class="type">String</span> <span class="variable">jsonString</span> <span class="operator">=</span> jsonObj.toString();</span><br><span class="line">        <span class="keyword">if</span> ( jsonString.equals(<span class="string">"null"</span>) ){</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="type">CoursePublish</span> <span class="variable">coursePublish</span> <span class="operator">=</span> JSON.parseObject(jsonString, CoursePublish.class);</span><br><span class="line">        <span class="keyword">return</span> coursePublish;</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        <span class="comment">//从数据库查询</span></span><br><span class="line">        System.out.println(<span class="string">"从数据库查询数据..."</span>);</span><br><span class="line">        <span class="type">CoursePublish</span> <span class="variable">coursePublish</span> <span class="operator">=</span> getCoursePublish(courseId);</span><br><span class="line">        <span class="comment">//设置过期时间300秒</span></span><br><span class="line">        redisTemplate.opsForValue().set(<span class="string">"course:"</span> + courseId, JSON.toJSONString(coursePublish), <span class="number">30</span>, TimeUnit.SECONDS);</span><br><span class="line">        <span class="keyword">return</span> coursePublish;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h2 id="缓存雪崩"><a class="markdownIt-Anchor" href="#缓存雪崩"></a> 缓存雪崩</h2>
<h3 id="什么是缓存雪崩"><a class="markdownIt-Anchor" href="#什么是缓存雪崩"></a> 什么是缓存雪崩</h3>
<p>缓存雪崩是缓存中大量key失效后当高并发到来时导致大量请求到数据库，瞬间耗尽数据库资源，导致数据库无法使用。</p>
<p>造成缓存雪崩问题的原因是是<code>大量key拥有了相同的过期时间</code>，比如对课程信息设置缓存过期时间为10分钟，在大量请求同时查询大量的课程信息时，此时就会有大量的课程存在相同的过期时间，一旦失效将同时失效，造成雪崩问题。</p>
<h3 id="解决缓存雪崩"><a class="markdownIt-Anchor" href="#解决缓存雪崩"></a> 解决缓存雪崩</h3>
<p>如何解决缓存雪崩？</p>
<ol>
<li>使用同步锁控制查询数据库的线程</li>
</ol>
<p>使用同步锁控制查询数据库的线程，只允许有一个线程去查询数据库，查询得到数据后存入缓存。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">synchronized</span>(obj){</span><br><span class="line">  <span class="comment">//查询数据库</span></span><br><span class="line">  <span class="comment">//存入缓存</span></span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>对同一类型信息的key设置不同的过期时间</li>
</ol>
<p>通常对一类信息的key设置的过期时间是相同的，这里可以在原有固定时间的基础上加上一个随机时间使它们的过期时间都不相同。</p>
<p>示例代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//设置过期时间300秒</span></span><br><span class="line">redisTemplate.opsForValue().set(</span><br><span class="line">    <span class="string">"course:"</span> + courseId, </span><br><span class="line">    JSON.toJSONString(coursePublish),</span><br><span class="line">    <span class="number">300</span>+<span class="keyword">new</span> <span class="title class_">Random</span>().nextInt(<span class="number">100</span>), </span><br><span class="line">    TimeUnit.SECONDS</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>缓存预热</li>
</ol>
<p>不用等到请求到来再去查询数据库存入缓存，可以提前将数据存入缓存。使用缓存预热机制通常有专门的后台程序去将数据库的数据同步到缓存。</p>
<h2 id="缓存击穿"><a class="markdownIt-Anchor" href="#缓存击穿"></a> 缓存击穿</h2>
<h3 id="什么是缓存击穿"><a class="markdownIt-Anchor" href="#什么是缓存击穿"></a> 什么是缓存击穿</h3>
<p>缓存击穿是指大量并发访问同一个热点数据，当热点数据失效后同时去请求数据库，瞬间耗尽数据库资源，导致数据库无法使用。</p>
<p>比如某手机新品发布，当缓存失效时有大量并发到来导致同时去访问数据库。</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240314111119782.png" alt="image-20240314111119782"></p>
<h3 id="解决缓存击穿"><a class="markdownIt-Anchor" href="#解决缓存击穿"></a> 解决缓存击穿</h3>
<p>如何解决缓存击穿？</p>
<ol>
<li>使用同步锁控制查询数据库的线程</li>
</ol>
<p>使用同步锁控制查询数据库的代码，只允许有一个线程去查询数据库，查询得到数据库存入缓存。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">synchronized</span>(obj){</span><br><span class="line">    <span class="comment">//查询数据库</span></span><br><span class="line">    <span class="comment">//插入缓存</span></span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>热点数据不过期</li>
</ol>
<p>可以由后台程序提前将热点数据加入缓存，缓存过期时间不过期，由后台程序做好缓存同步。</p>
<p>下边使用synchronized对代码加锁。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> CoursePublish <span class="title function_">getCoursePublishCache</span><span class="params">(Long courseId)</span> {</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="built_in">this</span>) {</span><br><span class="line">        <span class="comment">//查询缓存</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">jsonString</span> <span class="operator">=</span> (String) redisTemplate.opsForValue().get(<span class="string">"course:"</span> + courseId);</span><br><span class="line">        <span class="keyword">if</span> ( StringUtils.isNotEmpty(jsonString) ) {</span><br><span class="line">            <span class="keyword">if</span> ( jsonString.equals(<span class="string">"null"</span>) ) {</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            }</span><br><span class="line">            <span class="type">CoursePublish</span> <span class="variable">coursePublish</span> <span class="operator">=</span> JSON.parseObject(jsonString, CoursePublish.class);</span><br><span class="line">            <span class="keyword">return</span> coursePublish;</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="comment">//从数据库查询</span></span><br><span class="line">            System.out.println(<span class="string">"从数据库查询数据..."</span>);</span><br><span class="line">            <span class="type">CoursePublish</span> <span class="variable">coursePublish</span> <span class="operator">=</span> getCoursePublish(courseId);</span><br><span class="line">            <span class="comment">//设置过期时间300秒</span></span><br><span class="line">            redisTemplate.opsForValue().set(<span class="string">"course:"</span> + courseId, JSON.toJSONString(coursePublish), <span class="number">300</span>, TimeUnit.SECONDS);</span><br><span class="line">            <span class="keyword">return</span> coursePublish;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>测试，吞吐量有1700左右</p>
<img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240314123228089.png" alt="image-20240314123228089" style="zoom: 33%;">
<h2 id="小结"><a class="markdownIt-Anchor" href="#小结"></a> 小结</h2>
<ol>
<li>缓存穿透：</li>
</ol>
<p>去访问一个数据库不存在的数据无法将数据进行缓存，导致查询数据库，当并发较大就会对数据库造成压力。缓存穿透可以造成数据库瞬间压力过大，连接数等资源用完，最终数据库拒绝连接不可用。</p>
<p>解决的方法：</p>
<ul>
<li>
<p>缓存一个null值。</p>
</li>
<li>
<p>使用布隆过滤器。</p>
</li>
</ul>
<ol start="2">
<li>缓存雪崩：</li>
</ol>
<p>缓存中大量key失效后当高并发到来时导致大量请求到数据库，瞬间耗尽数据库资源，导致数据库无法使用。</p>
<p>造成缓存雪崩问题的原因是是大量key拥有了相同的过期时间。</p>
<p>解决办法：</p>
<ul>
<li>
<p>使用同步锁控制</p>
</li>
<li>
<p>对同一类型信息的key设置不同的过期时间，比如：使用固定数+随机数作为过期时间。</p>
</li>
</ul>
<ol start="3">
<li>缓存击穿</li>
</ol>
<p>大量并发访问同一个热点数据，当热点数据失效后同时去请求数据库，瞬间耗尽数据库资源，导致数据库无法使用。</p>
<p>解决办法：</p>
<ul>
<li>
<p>使用同步锁控制</p>
</li>
<li>
<p>设置key永不过期</p>
</li>
</ul>
<p>限流技术方案：</p>
<ul>
<li>
<p>alibaba/Sentinel</p>
</li>
<li>
<p>nginx+Lua</p>
</li>
</ul>
<h2 id="分布式锁"><a class="markdownIt-Anchor" href="#分布式锁"></a> 分布式锁</h2>
<h3 id="本地锁的问题"><a class="markdownIt-Anchor" href="#本地锁的问题"></a> 本地锁的问题</h3>
<p>上边的程序使用了同步锁解决了缓存击穿、缓存雪崩的问题，保证同一个key过期后只会查询一次数据库。</p>
<p>如果将同步锁的程序分布式部署在多个虚拟机上则无法保证同一个key只会查询一次数据库，如下图：</p>
<img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240314162818526.png" alt="image-20240314162818526" style="zoom:50%;">
<p>一个同步锁程序只能保证同一个虚拟机中多个线程只有一个线程去数据库，如果高并发通过网关负载均衡转发给各个虚拟机，此时就会存在多个线程去查询数据库情况，因为虚拟机中的锁只能保证该虚拟机自己的线程去同步执行，无法跨虚拟机保证同步执行。</p>
<p>我们将虚拟机内部的锁叫本地锁，本地锁只能保证所在虚拟机的线程同步执行。</p>
<p>下边进行测试：</p>
<p>启动三个内容管理服务：</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240314162902233.png" alt="image-20240314162902233"></p>
<p>通过网关访问课程查询，网关通过负载均衡将请求转发给三个服务。</p>
<p>通过测试发现，有两个服务各有一次数据库查询，这说明本地锁无法跨虚拟机保证同步执行。</p>
<h3 id="什么是分布锁"><a class="markdownIt-Anchor" href="#什么是分布锁"></a> 什么是分布锁</h3>
<p>本地锁只能控制所在虚拟机中的线程同步执行，现在要实现分布式环境下所有虚拟机中的线程去同步执行就需要让多个虚拟机去共用一个锁，虚拟机可以分布式部署，锁也可以分布式部署，如下图：</p>
<img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240314162959626.png" alt="image-20240314162959626" style="zoom:50%;">
<p>虚拟机都去抢占同一个锁，锁是一个单独的程序提供加锁、解锁服务，谁抢到锁谁去查询数据库。</p>
<p>该锁已不属于某个虚拟机，而是分布式部署，由多个虚拟机所共享，这种锁叫分布式锁。</p>
<h3 id="分布式锁的实现方案"><a class="markdownIt-Anchor" href="#分布式锁的实现方案"></a> 分布式锁的实现方案</h3>
<p>实现分布式锁的方案有很多，常用的如下：</p>
<ol>
<li>基于<code>数据库</code>实现分布锁</li>
</ol>
<p>利用数据库<code>主键唯一性</code>的特点，或利用数据库唯一索引的特点，多个线程同时去插入相同的记录，谁插入成功谁就抢到锁。</p>
<ol start="2">
<li>基于<code>redis</code>实现锁</li>
</ol>
<p><code>redis</code>提供了分布式锁的实现方案，比如：<code>SETNX</code>、<code>set nx</code>、<code>redisson</code>等。</p>
<p>拿SETNX举例说明，SETNX命令的工作过程是去set一个不存在的key，多个线程去设置同一个key只会有一个线程设置成功，设置成功的的线程拿到锁。</p>
<ol start="3">
<li>使用<code>zookeeper</code>实现</li>
</ol>
<p><code>zookeeper</code>是一个分布式协调服务，主要解决分布式程序之间的同步的问题。<code>zookeeper</code>的结构类似的文件目录，多线程向<code>zookeeper</code>创建一个子目录(节点)只会有一个创建成功，利用此特点可以实现分布式锁，谁创建该结点成功谁就获得锁。</p>
<h3 id="redis-nx实现分布式锁"><a class="markdownIt-Anchor" href="#redis-nx实现分布式锁"></a> Redis NX实现分布式锁</h3>
<p>redis实现分布式锁的方案可以在redis.cn网站查阅，地址:<a href="http://www.redis.cn/commands/set.html">http://www.redis.cn/commands/set.html</a></p>
<p>使用命令： SET resource-name anystring NX EX max-lock-time 即可实现。</p>
<p>NX：表示key不存在才设置成功。</p>
<p>EX：设置过期时间</p>
<p>这里启动三个ssh客户端，连接redis: docker exec -it redis redis-cli</p>
<p>先认证: auth redis</p>
<p>同时向三个客户端发送测试命令如下：</p>
<p>表示设置lock001锁，value为001，过期时间为30秒</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">SET lock001 001 NX EX 30</span><br></pre></td></tr></table></figure>
<p>命令发送成功，观察三个ssh客户端发现只有一个设置成功，其它两个设置失败，设置成功的请求表示抢到了lock001锁。</p>
<p>如何在代码中使用Set nx去实现分布锁呢？</p>
<p>使用spring-boot-starter-data-redis 提供的api即可实现set nx。</p>
<p>添加依赖：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-pool2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.6.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>添加依赖后，在bean中注入restTemplate。</p>
<p>我们先分析一段伪代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(缓存中有){</span><br><span class="line"></span><br><span class="line">    返回缓存中的数据</span><br><span class="line">}<span class="keyword">else</span>{</span><br><span class="line"></span><br><span class="line">    获取分布式锁</span><br><span class="line">        <span class="keyword">if</span>(获取锁成功）{</span><br><span class="line">            <span class="keyword">try</span>{</span><br><span class="line">                查询数据库</span><br><span class="line">            }<span class="keyword">finally</span>{</span><br><span class="line">                释放锁</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<ol>
<li>获取分布式锁</li>
</ol>
<p>使用redisTemplate.opsForValue().setIfAbsent(key,vaue)获取锁</p>
<p>这里考虑一个问题，当set nx一个key/value成功1后，这个key(就是锁)需要设置过期时间吗？</p>
<p>如果不设置过期时间当获取到了锁却没有执行finally这个锁将会一直存在，其它线程无法获取这个锁。</p>
<p>所以执行set nx时要指定过期时间，即使用如下的命令</p>
<p>SET resource-name anystring NX EX max-lock-time</p>
<p>具体调用的方法是：redisTemplate.opsForValue().setIfAbsent(K var1, V var2, long var3, TimeUnit var5)</p>
<ol start="2">
<li>如何释放锁</li>
</ol>
<p>释放锁分为两种情况：key到期自动释放，手动删除。</p>
<p>​	1. key到期自动释放的方法</p>
<p>​	因为锁设置了过期时间，key到期会自动释放，但是会存在一个问题就是 查询数据库等操作还没有执行完时key到期了，此时其它线程就抢到锁了，最终	    	重复查询数据库执行了重复的业务操作。</p>
<p>​	怎么解决这个问题？</p>
<p>​	可以将key的到期时间设置的长一些，足以执行完成查询数据库并设置缓存等相关操作。</p>
<p>​	如果这样效率会低一些，另外这个时间值也不好把控。</p>
<p>​	2. 手动删除锁</p>
<p>​	如果是采用手动删除锁可能和key到期自动删除有所冲突，造成删除了别人的锁。</p>
<p>​	比如：当查询数据库等业务还没有执行完时key过期了，此时其它线程占用了锁，</p>
<p>​	当上一个线程执行查询数据库等业务操作完成后手动删除锁就把其它线程的锁给删除了。</p>
<p>​	要解决这个问题可以采用删除锁之前判断是不是自己设置的锁，伪代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(缓存中有){</span><br><span class="line"></span><br><span class="line">  返回缓存中的数据</span><br><span class="line">}<span class="keyword">else</span>{</span><br><span class="line">  获取分布式锁: set lock <span class="number">01</span> NX</span><br><span class="line">  <span class="title function_">if</span><span class="params">(获取锁成功）{</span></span><br><span class="line"><span class="params">       <span class="keyword">try</span>{</span></span><br><span class="line"><span class="params">         查询数据库</span></span><br><span class="line"><span class="params">      }<span class="keyword">finally</span>{</span></span><br><span class="line"><span class="params">         <span class="keyword">if</span>(redis.call(<span class="string">"get"</span>,<span class="string">"lock"</span>)</span>==<span class="string">"01"</span>){</span><br><span class="line">            释放锁: redis.call(<span class="string">"del"</span>,<span class="string">"lock"</span>)</span><br><span class="line">         }</span><br><span class="line">      }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>以上代码第11行到13行非原子性，也会导致删除其它线程的锁。</p>
<p>查看文档上的说明：<a href="http://www.redis.cn/commands/set.html">http://www.redis.cn/commands/set.html</a></p>
<img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240314174058767.png" alt="image-20240314174058767" style="zoom:50%;">
<p>在调用setnx命令设置key/value时，每个线程设置不一样的value值，这样当线程去删除锁时可以先根据key查询出来判断是不是自己当时设置的vlaue，如果是则删除。</p>
<p>这整个操作是原子的，实现方法就是去执行上边的lua脚本。</p>
<p><em>Lua</em> 是一个小巧的脚本语言，redis在2.6版本就支持通过执行Lua脚本保证多个命令的原子性。</p>
<p>什么是原子性？</p>
<p>这些指令要么全成功要么全失败。</p>
<p>以上就是使用Redis Nx方式实现分布式锁，为了避免删除别的线程设置的锁需要使用redis去执行Lua脚本的方式去实现，这样就具有原子性，但是过期时间的值设置不存在不精确的问题。</p>
<h3 id="redisson实现分布式锁"><a class="markdownIt-Anchor" href="#redisson实现分布式锁"></a> Redisson实现分布式锁</h3>
<h4 id="什么是redisson"><a class="markdownIt-Anchor" href="#什么是redisson"></a> 什么是Redisson</h4>
<p>再查阅 文档http://www.redis.cn/commands/set.html</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240314174435592.png" alt="image-20240314174435592"></p>
<img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240314174447929.png" alt="image-20240314174447929" style="zoom:50%;">
<p>我们选用Java的实现方案 <a href="https://github.com/redisson/redisson">https://github.com/redisson/redisson</a></p>
<p>Redisson的文档地址：<a href="https://github.com/redisson/redisson/wiki/Table-of-Content">https://github.com/redisson/redisson/wiki/Table-of-Content</a></p>
<p>Redisson底层采用的是<a href="http://netty.io/">Netty</a> 框架。支持<a href="http://redis.cn/">Redis</a> 2.8以上版本，支持Java1.6+以上版本。Redisson是一个在Redis的基础上实现的Java驻内存数据网格（In-Memory Data Grid）。它不仅提供了一系列的分布式的Java常用对象，还提供了许多分布式服务。其中包括(BitSet, Set, Multimap, SortedSet, Map, List, Queue, BlockingQueue, Deque, BlockingDeque, Semaphore, Lock, AtomicLong, CountDownLatch, Publish / Subscribe, Bloom filter, Remote service, Spring cache, Executor service, Live Object service, Scheduler service) 。</p>
<img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240314174522829.png" alt="image-20240314174522829" style="zoom:50%;">
<p>使用Redisson可以非常方便将Java本地内存中的常用数据结构的对象搬到分布式缓存redis中。</p>
<p>也可以将常用的并发编程工具如：AtomicLong、CountDownLatch、Semaphore等支持分布式。</p>
<p>使用RScheduledExecutorService 实现分布式调度服务。</p>
<p>支持数据分片，将数据分片存储到不同的redis实例中。</p>
<p>支持分布式锁，基于Java的Lock接口实现分布式锁，方便开发。</p>
<p>下边使用Redisson将Queue队列的数据存入Redis，实现一个排队及出队的接口。</p>
<img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240314175036480.png" alt="image-20240314175036480" style="zoom:33%;">
<p>添加redisson的依赖</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.redisson<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>redisson-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.11.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>从课程资料目录拷贝singleServerConfig.yaml到config工程下</p>
<p>在redis配置文件中添加：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">redisson:</span></span><br><span class="line">      <span class="comment">#配置文件目录</span></span><br><span class="line">      <span class="attr">config:</span> <span class="string">classpath:singleServerConfig.yaml</span></span><br><span class="line">      <span class="comment">#config: classpath:clusterServersConfig.yaml</span></span><br></pre></td></tr></table></figure>
<p>redis集群配置clusterServersConfig.yaml.</p>
<p>Redisson相比set nx实现分布式锁要简单的多，工作原理如下：</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240314180504402.png" alt="image-20240314180504402"></p>
<p>• <code>加锁机制</code></p>
<p>线程去获取锁，获取成功: 执行lua脚本，保存数据到redis数据库。</p>
<p>线程去获取锁，获取失败: 一直通过while循环尝试获取锁，获取成功后，执行lua脚本，保存数据到redis</p>
<p>• <code>WatchDog</code>自动延期看门狗机制</p>
<p>第一种情况：在一个分布式环境下，假如一个线程获得锁后，突然服务器宕机了，那么这个时候在一定时间后这个锁会自动释放，你也可以设置锁的有效时间(当不设置默认30秒时），这样的目的主要是防止死锁的发生</p>
<p>第二种情况：线程A业务还没有执行完，时间就过了，线程A 还想持有锁的话，就会启动一个watch dog后台线程，不断的延长锁key的生存时间。</p>
<p>• <code>lua</code>脚本保证原子性操作</p>
<p>主要是如果你的业务逻辑复杂的话，通过封装在lua脚本中发送给redis，而且redis是单线程的，这样就保证这段复杂业务逻辑执行的原子性</p>
<p>具体使用RLock操作分布锁，RLock继承JDK的Lock接口，所以他有Lock接口的所有特性，比如lock、unlock、trylock等特性,同时它还有很多新特性：强制锁释放，带有效期的锁,。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">RRLock</span> {</span><br><span class="line"></span><br><span class="line">    <span class="comment">//----------------------Lock接口方法-----------------------</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 加锁 锁的有效期默认30秒</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">lock</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 加锁 可以手动设置锁的有效时间</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> leaseTime 锁有效时间</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> unit      时间单位 小时、分、秒、毫秒等</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">lock</span><span class="params">(<span class="type">long</span> leaseTime, TimeUnit unit)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * tryLock()方法是有返回值的，用来尝试获取锁，</span></span><br><span class="line"><span class="comment">     * 如果获取成功，则返回true，如果获取失败（即锁已被其他线程获取），则返回false .</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">tryLock</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * tryLock(long time, TimeUnit unit)方法和tryLock()方法是类似的，</span></span><br><span class="line"><span class="comment">     * 只不过区别在于这个方法在拿不到锁时会等待一定的时间，</span></span><br><span class="line"><span class="comment">     * 在时间期限之内如果还拿不到锁，就返回false。如果如果一开始拿到锁或者在等待期间内拿到了锁，则返回true。</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> time 等待时间</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> unit 时间单位 小时、分、秒、毫秒等</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">tryLock</span><span class="params">(<span class="type">long</span> time, TimeUnit unit)</span> <span class="keyword">throws</span> InterruptedException;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 比上面多一个参数，多添加一个锁的有效时间</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> waitTime  等待时间</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> leaseTime 锁有效时间</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> unit      时间单位 小时、分、秒、毫秒等</span></span><br><span class="line"><span class="comment">     * waitTime 大于 leaseTime</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">tryLock</span><span class="params">(<span class="type">long</span> waitTime, <span class="type">long</span> leaseTime, TimeUnit unit)</span> <span class="keyword">throws</span> InterruptedException;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 解锁</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">()</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p><strong>lock()</strong>：</p>
<ul>
<li>
<p>此方法为加锁，但是锁的有效期采用<strong>默认</strong>30秒</p>
</li>
<li>
<p>如果主线程未释放，且当前锁未调用unlock方法，则进入到<strong>watchDog</strong>机制</p>
</li>
<li>
<p>如果主线程未释放，且当前锁调用unlock方法，则直接释放锁</p>
</li>
</ul>
<h4 id="分布式锁避免缓存击穿"><a class="markdownIt-Anchor" href="#分布式锁避免缓存击穿"></a> 分布式锁避免缓存击穿</h4>
<p>下边使用分布式锁修改查询课程信息的接口。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//Redisson分布式锁</span></span><br><span class="line"><span class="keyword">public</span>  CoursePublish <span class="title function_">getCoursePublishCache</span><span class="params">(Long courseId)</span>{</span><br><span class="line">    <span class="comment">//查询缓存</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">jsonString</span> <span class="operator">=</span> (String) redisTemplate.opsForValue().get(<span class="string">"course:"</span> + courseId);</span><br><span class="line">    <span class="keyword">if</span>(StringUtils.isNotEmpty(jsonString)){</span><br><span class="line">        <span class="keyword">if</span>(jsonString.equals(<span class="string">"null"</span>)){</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="type">CoursePublish</span> <span class="variable">coursePublish</span> <span class="operator">=</span> JSON.parseObject(jsonString, CoursePublish.class);</span><br><span class="line">        <span class="keyword">return</span> coursePublish;</span><br><span class="line">    }<span class="keyword">else</span>{</span><br><span class="line">        <span class="comment">//每门课程设置一个锁</span></span><br><span class="line">        <span class="type">RLock</span> <span class="variable">lock</span> <span class="operator">=</span> redissonClient.getLock(<span class="string">"coursequerylock:"</span>+courseId);</span><br><span class="line">        <span class="comment">//获取锁</span></span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            jsonString = (String) redisTemplate.opsForValue().get(<span class="string">"course:"</span> + courseId);</span><br><span class="line">            <span class="keyword">if</span>(StringUtils.isNotEmpty(jsonString)){</span><br><span class="line">                <span class="type">CoursePublish</span> <span class="variable">coursePublish</span> <span class="operator">=</span> JSON.parseObject(jsonString, CoursePublish.class);</span><br><span class="line">                <span class="keyword">return</span> coursePublish;</span><br><span class="line">            }</span><br><span class="line">            System.out.println(<span class="string">"=========从数据库查询=========="</span>);</span><br><span class="line">            <span class="comment">//从数据库查询</span></span><br><span class="line">            <span class="type">CoursePublish</span> <span class="variable">coursePublish</span> <span class="operator">=</span> getCoursePublish(courseId);</span><br><span class="line">            redisTemplate.opsForValue().set(<span class="string">"course:"</span> + courseId, JSON.toJSONString(coursePublish),<span class="number">1</span>,TimeUnit.DAYS);</span><br><span class="line">            <span class="keyword">return</span> coursePublish;</span><br><span class="line">        }<span class="keyword">finally</span> {</span><br><span class="line">            <span class="comment">//释放锁</span></span><br><span class="line">            lock.unlock();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>启动多个内容管理服务实例，使用JMeter压力测试，只有一个实例查询一次数据库。</p>
<p>吞吐量大大提高,达到7000左右</p>
<img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240314185520789.png" alt="image-20240314185520789" style="zoom:50%;">
<p>测试Redisson自动续期功能。</p>
<p>在查询数据库处添加休眠，观察锁是否会自动续期。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">try</span> {</span><br><span class="line">    Thread.sleep(<span class="number">60000</span>);</span><br><span class="line">} <span class="keyword">catch</span> (InterruptedException e) {</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>学习</tag>
        <tag>后端</tag>
        <tag>黑马程序员</tag>
        <tag>学成在线</tag>
      </tags>
  </entry>
  <entry>
    <title>计算机组成原理第一次作业</title>
    <url>/2024/03/27/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86%E7%AC%AC%E4%B8%80%E6%AC%A1%E4%BD%9C%E4%B8%9A/</url>
    <content><![CDATA[<h2 id="11-解释如下名词"><a class="markdownIt-Anchor" href="#11-解释如下名词"></a> 1.1 解释如下名词</h2>
<ol>
<li>
<p><strong>摩尔定律</strong>:<br>
1965年，Intel创始人之一戈登·摩尔(Gordon Moore)在Cramming More Components ontoInegraled Circuits 一文中对集成电路上可容纳的品体管数目、性能和价格等发展趋势进行了预测其主要内容可概括为:“当价格不变时,集成电路上可容纳的品体管数量大约18~ 24 个月翻一番<br>
性能也将提升一倍。”这就是著名的摩尔定律。摩尔定律已被集成电路 40 多年的发展历史准确无误地验证。近年来由于工艺和技术的发展,半导体工艺已接近集成电路极限，集成电路的发展开始逐渐偏离摩尔定律的预测，从2013年开始逐步放缓至3年翻一番，摩尔定律放缓已成了行业的共识。但这些都不能否定摩尔定律的深远影响和巨大贡献。摩尔定律的意义和影响表现在:<br>
(1)单个芯片集成度提高后，其成本变化不大，因此总体成本明显下降;<br>
(2)高集成度的芯片中，电路间的距离更近，其连线更短，工作速度可以更高</p>
<p>(3)增加了芯片内部的连线，从而减少了外部连线，可靠性得以提高<br>
(4)计算机体积越来越小，减少了电能的消耗，适应性更好。</p>
</li>
<li>
<p><strong>主存控制器:</strong></p>
<p><strong>主存控制器</strong>是计算机系统中的一个关键组件，负责协调和管理主存储器（也称为内存）的访问。让我们深入了解一下主存控制器的作用、特点和应用。</p>
<ol>
<li><strong>作用</strong>：
<ul>
<li>主存控制器的主要功能是进行接口的转换，将主设备发出的读、写等命令转换成存储器能够识别的信号。</li>
<li>它还负责完成主设备与存储器之间的地址译码、数据格式转换（例如数据位宽）等操作。</li>
</ul>
</li>
<li><strong>特点</strong>：
<ul>
<li>主存控制器通常位于CPU内部，作为存储器访问的桥梁。</li>
<li>它具有快速的读写速度，以便有效地处理数据传输。</li>
</ul>
</li>
<li><strong>应用领域</strong>：
<ul>
<li>主存控制器在计算机系统中广泛应用，特别是在内存管理和数据传输方面。</li>
<li>它在操作系统、数据库管理系统、网络设备等领域中发挥着重要作用。</li>
</ul>
</li>
</ol>
<p>总之，主存控制器是计算机系统中的关键组件，确保CPU和内存之间的高效通信，从而实现数据的读取和写入。</p>
</li>
<li>
<p><strong>汇编器,编译器,解释器</strong>：</p>
<p>语言翻译程序主要包括编译程序、汇编程序、解释程序和其他软件操作程序。编译程序负责将高级语言翻译成汇编代码，也称为<code>编译器</code>;汇编程序负责将汇编语言翻译成机器语言目标程序，也称为<code>汇编器</code>;解释程序用于将源程序中的语句按执行顺序逐条翻译成机器指令并执行且不生成目标程序，也称为<code>解释器</code>。</p>
</li>
<li>
<p><strong>链接器</strong>：</p>
<p>链接器主要是将有关的目标文件彼此相连接生成可加载、可执行的目标文件。链接器的核心工作就是符号表解析和重定位。</p>
</li>
<li>
<p><strong>时钟周期</strong>:<br>
时钟周期是计算机中最基本的、最小的时间单位。在一个时钟周期内，CPU 仅完成一个最基本的动作。时钟周期是时钟频率的倒数，也称为节拍周期或T周期，随着CPU主频的提高，对应的时钟周期将变短，例如，主频1GHz(10%Hz)的CPU 时钟周期为 1ns。</p>
</li>
<li>
<p><strong>字长:</strong></p>
<p>计算机的字长一般是指 CPU 一次处理的数据位数，用二进制数的长度来衡量。字长一般与计算机内部寄存器、运算器、数据总线的位宽相等。</p>
<p>字长一般以字节( Byte )为基本单位,不同计算机的字长可以不同,有的计算机还支持变字长如支持半字长、全字长、双字长和多字长等,不过它们都是字节的整数倍。早期的计算机字长较短一般为16位，现代计算机字长一般为32位或64位。<br>
字长对计算机性能有如下几方面的影响。</p>
<p>(1)影响计算精确度。字长越长，计算精确度就越高，反之计算精确度就越低。</p>
<p>(2)影响数据的表示范围和精度。字长越长，定点数的表示范围就越大，浮点数的表示范围越大、精度也越高。</p>
</li>
<li>
<p><strong>存储容量:</strong></p>
<p>主存容量是指主存能存储的最大信息量，一般用<code>MxN</code>表示，其中M表示存储单元数，也称字容量;N表示每个存储单元存储的二进制位数，也称位容量。主存容量常用单位的定义如下表所示。</p>
<table>
<thead>
<tr>
<th style="text-align:center">单位</th>
<th style="text-align:center">存储容量</th>
<th style="text-align:center">最少地址线</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">KB(Kilobyte)</td>
<td style="text-align:center">1024B</td>
<td style="text-align:center">10根</td>
</tr>
<tr>
<td style="text-align:center">MB(Megabyte)</td>
<td style="text-align:center">1024KB</td>
<td style="text-align:center">20根</td>
</tr>
<tr>
<td style="text-align:center">GB(Gigabyte)</td>
<td style="text-align:center">1024MB</td>
<td style="text-align:center">30根</td>
</tr>
<tr>
<td style="text-align:center">TB(Treabyte)</td>
<td style="text-align:center">1024GB</td>
<td style="text-align:center">40根</td>
</tr>
<tr>
<td style="text-align:center">PB(Petabyte)</td>
<td style="text-align:center">1024TB</td>
<td style="text-align:center">50根</td>
</tr>
</tbody>
</table>
<p>增加主存容量能减少程序运行期间访问辅存的次数，有利于提高程序的执行速度，也有利于计算机性能的提高。</p>
</li>
<li>
<p><strong>CPI</strong>:</p>
<p><code>CPI(Clock Cycles Per Instruction)</code>是指执行每条指令所需要的平均时钟周期数。由于指令功能不同且相同功能的指令还可能有不同的寻址方式，因此，指令执行时所需要的时钟周期数也可能不同。CPI既可表示<code>每条指令执行所需要的时钟周期数</code>，也可指<code>一类指令(如算术运算类指令)或一段程序中所有指令执行所需时钟周期数的平均值</code>。<br>
假设程序中包含的总指令条数用IC 表示，程序执行所需时钟周期数为 m，机器周期为 T频率为f, 则根据上述 CPI的定义可得:</p>
<mjx-container class="MathJax" jax="SVG" display="true" width="full" style="min-width: 20.834ex;"><svg style="vertical-align: -1.5ex; min-width: 20.834ex;" xmlns="http://www.w3.org/2000/svg" width="100%" height="4.131ex" role="img" focusable="false"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(0.0181,-0.0181) translate(0, -1163)"><g data-mml-node="math"><g data-mml-node="mtable" transform="translate(2078,0) translate(-2078,0)"><g transform="translate(0 1163) matrix(1 0 0 -1 0 0) scale(55.25)"><svg data-table="true" preserveAspectRatio="xMidYMid" viewBox="2526.3 -1163 1 1826"><g transform="matrix(1 0 0 -1 0 0)"><g data-mml-node="mlabeledtr" transform="translate(0,45)"><g data-mml-node="mtd"><g data-mml-node="mi"><path data-c="1D436" d="M50 252Q50 367 117 473T286 641T490 704Q580 704 633 653Q642 643 648 636T656 626L657 623Q660 623 684 649Q691 655 699 663T715 679T725 690L740 705H746Q760 705 760 698Q760 694 728 561Q692 422 692 421Q690 416 687 415T669 413H653Q647 419 647 422Q647 423 648 429T650 449T651 481Q651 552 619 605T510 659Q484 659 454 652T382 628T299 572T226 479Q194 422 175 346T156 222Q156 108 232 58Q280 24 350 24Q441 24 512 92T606 240Q610 253 612 255T628 257Q648 257 648 248Q648 243 647 239Q618 132 523 55T319 -22Q206 -22 128 53T50 252Z"></path></g><g data-mml-node="mi" transform="translate(760,0)"><path data-c="1D443" d="M287 628Q287 635 230 637Q206 637 199 638T192 648Q192 649 194 659Q200 679 203 681T397 683Q587 682 600 680Q664 669 707 631T751 530Q751 453 685 389Q616 321 507 303Q500 302 402 301H307L277 182Q247 66 247 59Q247 55 248 54T255 50T272 48T305 46H336Q342 37 342 35Q342 19 335 5Q330 0 319 0Q316 0 282 1T182 2Q120 2 87 2T51 1Q33 1 33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM645 554Q645 567 643 575T634 597T609 619T560 635Q553 636 480 637Q463 637 445 637T416 636T404 636Q391 635 386 627Q384 621 367 550T332 412T314 344Q314 342 395 342H407H430Q542 342 590 392Q617 419 631 471T645 554Z"></path></g><g data-mml-node="mi" transform="translate(1511,0)"><path data-c="1D43C" d="M43 1Q26 1 26 10Q26 12 29 24Q34 43 39 45Q42 46 54 46H60Q120 46 136 53Q137 53 138 54Q143 56 149 77T198 273Q210 318 216 344Q286 624 286 626Q284 630 284 631Q274 637 213 637H193Q184 643 189 662Q193 677 195 680T209 683H213Q285 681 359 681Q481 681 487 683H497Q504 676 504 672T501 655T494 639Q491 637 471 637Q440 637 407 634Q393 631 388 623Q381 609 337 432Q326 385 315 341Q245 65 245 59Q245 52 255 50T307 46H339Q345 38 345 37T342 19Q338 6 332 0H316Q279 2 179 2Q143 2 113 2T65 2T43 1Z"></path></g><g data-mml-node="mo" transform="translate(2292.8,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path></g><g data-mml-node="mfrac" transform="translate(3348.6,0)"><g data-mml-node="mi" transform="translate(413,676)"><path data-c="1D45A" d="M21 287Q22 293 24 303T36 341T56 388T88 425T132 442T175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q303 442 384 442Q401 442 415 440T441 433T460 423T475 411T485 398T493 385T497 373T500 364T502 357L510 367Q573 442 659 442Q713 442 746 415T780 336Q780 285 742 178T704 50Q705 36 709 31T724 26Q752 26 776 56T815 138Q818 149 821 151T837 153Q857 153 857 145Q857 144 853 130Q845 101 831 73T785 17T716 -10Q669 -10 648 17T627 73Q627 92 663 193T700 345Q700 404 656 404H651Q565 404 506 303L499 291L466 157Q433 26 428 16Q415 -11 385 -11Q372 -11 364 -4T353 8T350 18Q350 29 384 161L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 181Q151 335 151 342Q154 357 154 369Q154 405 129 405Q107 405 92 377T69 316T57 280Q55 278 41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mrow" transform="translate(220,-686)"><g data-mml-node="mi"><path data-c="1D43C" d="M43 1Q26 1 26 10Q26 12 29 24Q34 43 39 45Q42 46 54 46H60Q120 46 136 53Q137 53 138 54Q143 56 149 77T198 273Q210 318 216 344Q286 624 286 626Q284 630 284 631Q274 637 213 637H193Q184 643 189 662Q193 677 195 680T209 683H213Q285 681 359 681Q481 681 487 683H497Q504 676 504 672T501 655T494 639Q491 637 471 637Q440 637 407 634Q393 631 388 623Q381 609 337 432Q326 385 315 341Q245 65 245 59Q245 52 255 50T307 46H339Q345 38 345 37T342 19Q338 6 332 0H316Q279 2 179 2Q143 2 113 2T65 2T43 1Z"></path></g><g data-mml-node="mi" transform="translate(504,0)"><path data-c="1D436" d="M50 252Q50 367 117 473T286 641T490 704Q580 704 633 653Q642 643 648 636T656 626L657 623Q660 623 684 649Q691 655 699 663T715 679T725 690L740 705H746Q760 705 760 698Q760 694 728 561Q692 422 692 421Q690 416 687 415T669 413H653Q647 419 647 422Q647 423 648 429T650 449T651 481Q651 552 619 605T510 659Q484 659 454 652T382 628T299 572T226 479Q194 422 175 346T156 222Q156 108 232 58Q280 24 350 24Q441 24 512 92T606 240Q610 253 612 255T628 257Q648 257 648 248Q648 243 647 239Q618 132 523 55T319 -22Q206 -22 128 53T50 252Z"></path></g></g><rect width="1464" height="60" x="120" y="220"></rect></g></g></g></g></svg><svg data-labels="true" preserveAspectRatio="xMaxYMid" viewBox="1278 -1163 1 1826"><g data-labels="true" transform="matrix(1 0 0 -1 0 0)"><g data-mml-node="mtd" id="mjx-eqn:1" transform="translate(0,795)"><text data-id-align="true"></text><g data-idbox="true" transform="translate(0,-750)"><g data-mml-node="mtext"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z" transform="translate(389,0)"></path><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z" transform="translate(889,0)"></path></g></g></g></g></svg></g></g></g></g></svg></mjx-container>

<p>若能知</p>
<p>道某程序中每类指令的使用频率(用P表示)、每类指令的CPI(用CPI<sub>i</sub>表示)每类指令的条数(用IC表示)，则程序的CPI可表示为:</p>
<mjx-container class="MathJax" jax="SVG" display="true" width="full" style="min-width: 52.574ex;"><svg style="vertical-align: -2.611ex; min-width: 52.574ex;" xmlns="http://www.w3.org/2000/svg" width="100%" height="6.354ex" role="img" focusable="false"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(0.0181,-0.0181) translate(0, -1654.2)"><g data-mml-node="math"><g data-mml-node="mtable" transform="translate(2078,0) translate(-2078,0)"><g transform="translate(0 1654.2) matrix(1 0 0 -1 0 0) scale(55.25)"><svg data-table="true" preserveAspectRatio="xMidYMid" viewBox="9540.9 -1654.2 1 2808.5"><g transform="matrix(1 0 0 -1 0 0)"><g data-mml-node="mlabeledtr" transform="translate(0,91.7)"><g data-mml-node="mtd"><g data-mml-node="mi"><path data-c="1D436" d="M50 252Q50 367 117 473T286 641T490 704Q580 704 633 653Q642 643 648 636T656 626L657 623Q660 623 684 649Q691 655 699 663T715 679T725 690L740 705H746Q760 705 760 698Q760 694 728 561Q692 422 692 421Q690 416 687 415T669 413H653Q647 419 647 422Q647 423 648 429T650 449T651 481Q651 552 619 605T510 659Q484 659 454 652T382 628T299 572T226 479Q194 422 175 346T156 222Q156 108 232 58Q280 24 350 24Q441 24 512 92T606 240Q610 253 612 255T628 257Q648 257 648 248Q648 243 647 239Q618 132 523 55T319 -22Q206 -22 128 53T50 252Z"></path></g><g data-mml-node="mi" transform="translate(760,0)"><path data-c="1D443" d="M287 628Q287 635 230 637Q206 637 199 638T192 648Q192 649 194 659Q200 679 203 681T397 683Q587 682 600 680Q664 669 707 631T751 530Q751 453 685 389Q616 321 507 303Q500 302 402 301H307L277 182Q247 66 247 59Q247 55 248 54T255 50T272 48T305 46H336Q342 37 342 35Q342 19 335 5Q330 0 319 0Q316 0 282 1T182 2Q120 2 87 2T51 1Q33 1 33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM645 554Q645 567 643 575T634 597T609 619T560 635Q553 636 480 637Q463 637 445 637T416 636T404 636Q391 635 386 627Q384 621 367 550T332 412T314 344Q314 342 395 342H407H430Q542 342 590 392Q617 419 631 471T645 554Z"></path></g><g data-mml-node="mi" transform="translate(1511,0)"><path data-c="1D43C" d="M43 1Q26 1 26 10Q26 12 29 24Q34 43 39 45Q42 46 54 46H60Q120 46 136 53Q137 53 138 54Q143 56 149 77T198 273Q210 318 216 344Q286 624 286 626Q284 630 284 631Q274 637 213 637H193Q184 643 189 662Q193 677 195 680T209 683H213Q285 681 359 681Q481 681 487 683H497Q504 676 504 672T501 655T494 639Q491 637 471 637Q440 637 407 634Q393 631 388 623Q381 609 337 432Q326 385 315 341Q245 65 245 59Q245 52 255 50T307 46H339Q345 38 345 37T342 19Q338 6 332 0H316Q279 2 179 2Q143 2 113 2T65 2T43 1Z"></path></g><g data-mml-node="mo" transform="translate(2292.8,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path></g><g data-mml-node="munderover" transform="translate(3348.6,0)"><g data-mml-node="mo"><path data-c="2211" d="M60 948Q63 950 665 950H1267L1325 815Q1384 677 1388 669H1348L1341 683Q1320 724 1285 761Q1235 809 1174 838T1033 881T882 898T699 902H574H543H251L259 891Q722 258 724 252Q725 250 724 246Q721 243 460 -56L196 -356Q196 -357 407 -357Q459 -357 548 -357T676 -358Q812 -358 896 -353T1063 -332T1204 -283T1307 -196Q1328 -170 1348 -124H1388Q1388 -125 1381 -145T1356 -210T1325 -294L1267 -449L666 -450Q64 -450 61 -448Q55 -446 55 -439Q55 -437 57 -433L590 177Q590 178 557 222T452 366T322 544L56 909L55 924Q55 945 60 948Z"></path></g><g data-mml-node="TeXAtom" transform="translate(148.2,-1087.9) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><path data-c="1D456" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mo" transform="translate(345,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path></g><g data-mml-node="mn" transform="translate(1123,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g></g><g data-mml-node="mi" transform="translate(509.9,1150) scale(0.707)"><path data-c="1D45B" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path></g></g><g data-mml-node="mo" transform="translate(4792.6,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="mi" transform="translate(5181.6,0)"><path data-c="1D436" d="M50 252Q50 367 117 473T286 641T490 704Q580 704 633 653Q642 643 648 636T656 626L657 623Q660 623 684 649Q691 655 699 663T715 679T725 690L740 705H746Q760 705 760 698Q760 694 728 561Q692 422 692 421Q690 416 687 415T669 413H653Q647 419 647 422Q647 423 648 429T650 449T651 481Q651 552 619 605T510 659Q484 659 454 652T382 628T299 572T226 479Q194 422 175 346T156 222Q156 108 232 58Q280 24 350 24Q441 24 512 92T606 240Q610 253 612 255T628 257Q648 257 648 248Q648 243 647 239Q618 132 523 55T319 -22Q206 -22 128 53T50 252Z"></path></g><g data-mml-node="mi" transform="translate(5941.6,0)"><path data-c="1D443" d="M287 628Q287 635 230 637Q206 637 199 638T192 648Q192 649 194 659Q200 679 203 681T397 683Q587 682 600 680Q664 669 707 631T751 530Q751 453 685 389Q616 321 507 303Q500 302 402 301H307L277 182Q247 66 247 59Q247 55 248 54T255 50T272 48T305 46H336Q342 37 342 35Q342 19 335 5Q330 0 319 0Q316 0 282 1T182 2Q120 2 87 2T51 1Q33 1 33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM645 554Q645 567 643 575T634 597T609 619T560 635Q553 636 480 637Q463 637 445 637T416 636T404 636Q391 635 386 627Q384 621 367 550T332 412T314 344Q314 342 395 342H407H430Q542 342 590 392Q617 419 631 471T645 554Z"></path></g><g data-mml-node="msub" transform="translate(6692.6,0)"><g data-mml-node="mi"><path data-c="1D43C" d="M43 1Q26 1 26 10Q26 12 29 24Q34 43 39 45Q42 46 54 46H60Q120 46 136 53Q137 53 138 54Q143 56 149 77T198 273Q210 318 216 344Q286 624 286 626Q284 630 284 631Q274 637 213 637H193Q184 643 189 662Q193 677 195 680T209 683H213Q285 681 359 681Q481 681 487 683H497Q504 676 504 672T501 655T494 639Q491 637 471 637Q440 637 407 634Q393 631 388 623Q381 609 337 432Q326 385 315 341Q245 65 245 59Q245 52 255 50T307 46H339Q345 38 345 37T342 19Q338 6 332 0H316Q279 2 179 2Q143 2 113 2T65 2T43 1Z"></path></g><g data-mml-node="mi" transform="translate(473,-150) scale(0.707)"><path data-c="1D456" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"></path></g></g><g data-mml-node="mo" transform="translate(7681.7,0)"><path data-c="D7" d="M630 29Q630 9 609 9Q604 9 587 25T493 118L389 222L284 117Q178 13 175 11Q171 9 168 9Q160 9 154 15T147 29Q147 36 161 51T255 146L359 250L255 354Q174 435 161 449T147 471Q147 480 153 485T168 490Q173 490 175 489Q178 487 284 383L389 278L493 382Q570 459 587 475T609 491Q630 491 630 471Q630 464 620 453T522 355L418 250L522 145Q606 61 618 48T630 29Z"></path></g><g data-mml-node="msub" transform="translate(8682,0)"><g data-mml-node="mi"><path data-c="1D443" d="M287 628Q287 635 230 637Q206 637 199 638T192 648Q192 649 194 659Q200 679 203 681T397 683Q587 682 600 680Q664 669 707 631T751 530Q751 453 685 389Q616 321 507 303Q500 302 402 301H307L277 182Q247 66 247 59Q247 55 248 54T255 50T272 48T305 46H336Q342 37 342 35Q342 19 335 5Q330 0 319 0Q316 0 282 1T182 2Q120 2 87 2T51 1Q33 1 33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM645 554Q645 567 643 575T634 597T609 619T560 635Q553 636 480 637Q463 637 445 637T416 636T404 636Q391 635 386 627Q384 621 367 550T332 412T314 344Q314 342 395 342H407H430Q542 342 590 392Q617 419 631 471T645 554Z"></path></g><g data-mml-node="mi" transform="translate(675,-150) scale(0.707)"><path data-c="1D456" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"></path></g></g><g data-mml-node="mo" transform="translate(9650.9,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g><g data-mml-node="mo" transform="translate(10317.7,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path></g><g data-mml-node="munderover" transform="translate(11373.5,0)"><g data-mml-node="mo"><path data-c="2211" d="M60 948Q63 950 665 950H1267L1325 815Q1384 677 1388 669H1348L1341 683Q1320 724 1285 761Q1235 809 1174 838T1033 881T882 898T699 902H574H543H251L259 891Q722 258 724 252Q725 250 724 246Q721 243 460 -56L196 -356Q196 -357 407 -357Q459 -357 548 -357T676 -358Q812 -358 896 -353T1063 -332T1204 -283T1307 -196Q1328 -170 1348 -124H1388Q1388 -125 1381 -145T1356 -210T1325 -294L1267 -449L666 -450Q64 -450 61 -448Q55 -446 55 -439Q55 -437 57 -433L590 177Q590 178 557 222T452 366T322 544L56 909L55 924Q55 945 60 948Z"></path></g><g data-mml-node="TeXAtom" transform="translate(148.2,-1087.9) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><path data-c="1D456" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mo" transform="translate(345,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path></g><g data-mml-node="mn" transform="translate(1123,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g></g><g data-mml-node="mi" transform="translate(509.9,1150) scale(0.707)"><path data-c="1D45B" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path></g></g><g data-mml-node="mo" transform="translate(12817.5,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="TeXAtom" data-mjx-texclass="ORD" transform="translate(13206.5,0)"><g data-mml-node="mi"><path data-c="1D436" d="M50 252Q50 367 117 473T286 641T490 704Q580 704 633 653Q642 643 648 636T656 626L657 623Q660 623 684 649Q691 655 699 663T715 679T725 690L740 705H746Q760 705 760 698Q760 694 728 561Q692 422 692 421Q690 416 687 415T669 413H653Q647 419 647 422Q647 423 648 429T650 449T651 481Q651 552 619 605T510 659Q484 659 454 652T382 628T299 572T226 479Q194 422 175 346T156 222Q156 108 232 58Q280 24 350 24Q441 24 512 92T606 240Q610 253 612 255T628 257Q648 257 648 248Q648 243 647 239Q618 132 523 55T319 -22Q206 -22 128 53T50 252Z"></path></g><g data-mml-node="mi" transform="translate(760,0)"><path data-c="1D443" d="M287 628Q287 635 230 637Q206 637 199 638T192 648Q192 649 194 659Q200 679 203 681T397 683Q587 682 600 680Q664 669 707 631T751 530Q751 453 685 389Q616 321 507 303Q500 302 402 301H307L277 182Q247 66 247 59Q247 55 248 54T255 50T272 48T305 46H336Q342 37 342 35Q342 19 335 5Q330 0 319 0Q316 0 282 1T182 2Q120 2 87 2T51 1Q33 1 33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM645 554Q645 567 643 575T634 597T609 619T560 635Q553 636 480 637Q463 637 445 637T416 636T404 636Q391 635 386 627Q384 621 367 550T332 412T314 344Q314 342 395 342H407H430Q542 342 590 392Q617 419 631 471T645 554Z"></path></g><g data-mml-node="msub" transform="translate(1511,0)"><g data-mml-node="mi"><path data-c="1D43C" d="M43 1Q26 1 26 10Q26 12 29 24Q34 43 39 45Q42 46 54 46H60Q120 46 136 53Q137 53 138 54Q143 56 149 77T198 273Q210 318 216 344Q286 624 286 626Q284 630 284 631Q274 637 213 637H193Q184 643 189 662Q193 677 195 680T209 683H213Q285 681 359 681Q481 681 487 683H497Q504 676 504 672T501 655T494 639Q491 637 471 637Q440 637 407 634Q393 631 388 623Q381 609 337 432Q326 385 315 341Q245 65 245 59Q245 52 255 50T307 46H339Q345 38 345 37T342 19Q338 6 332 0H316Q279 2 179 2Q143 2 113 2T65 2T43 1Z"></path></g><g data-mml-node="mi" transform="translate(473,-150) scale(0.707)"><path data-c="1D456" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"></path></g></g><g data-mml-node="mo" transform="translate(2500.2,0)"><path data-c="D7" d="M630 29Q630 9 609 9Q604 9 587 25T493 118L389 222L284 117Q178 13 175 11Q171 9 168 9Q160 9 154 15T147 29Q147 36 161 51T255 146L359 250L255 354Q174 435 161 449T147 471Q147 480 153 485T168 490Q173 490 175 489Q178 487 284 383L389 278L493 382Q570 459 587 475T609 491Q630 491 630 471Q630 464 620 453T522 355L418 250L522 145Q606 61 618 48T630 29Z"></path></g><g data-mml-node="mfrac" transform="translate(3500.4,0)"><g data-mml-node="mrow" transform="translate(220,676)"><g data-mml-node="mi"><path data-c="1D43C" d="M43 1Q26 1 26 10Q26 12 29 24Q34 43 39 45Q42 46 54 46H60Q120 46 136 53Q137 53 138 54Q143 56 149 77T198 273Q210 318 216 344Q286 624 286 626Q284 630 284 631Q274 637 213 637H193Q184 643 189 662Q193 677 195 680T209 683H213Q285 681 359 681Q481 681 487 683H497Q504 676 504 672T501 655T494 639Q491 637 471 637Q440 637 407 634Q393 631 388 623Q381 609 337 432Q326 385 315 341Q245 65 245 59Q245 52 255 50T307 46H339Q345 38 345 37T342 19Q338 6 332 0H316Q279 2 179 2Q143 2 113 2T65 2T43 1Z"></path></g><g data-mml-node="msub" transform="translate(504,0)"><g data-mml-node="mi"><path data-c="1D436" d="M50 252Q50 367 117 473T286 641T490 704Q580 704 633 653Q642 643 648 636T656 626L657 623Q660 623 684 649Q691 655 699 663T715 679T725 690L740 705H746Q760 705 760 698Q760 694 728 561Q692 422 692 421Q690 416 687 415T669 413H653Q647 419 647 422Q647 423 648 429T650 449T651 481Q651 552 619 605T510 659Q484 659 454 652T382 628T299 572T226 479Q194 422 175 346T156 222Q156 108 232 58Q280 24 350 24Q441 24 512 92T606 240Q610 253 612 255T628 257Q648 257 648 248Q648 243 647 239Q618 132 523 55T319 -22Q206 -22 128 53T50 252Z"></path></g><g data-mml-node="mi" transform="translate(748,-150) scale(0.707)"><path data-c="1D456" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"></path></g></g></g><g data-mml-node="mrow" transform="translate(361,-686)"><g data-mml-node="mi"><path data-c="1D43C" d="M43 1Q26 1 26 10Q26 12 29 24Q34 43 39 45Q42 46 54 46H60Q120 46 136 53Q137 53 138 54Q143 56 149 77T198 273Q210 318 216 344Q286 624 286 626Q284 630 284 631Q274 637 213 637H193Q184 643 189 662Q193 677 195 680T209 683H213Q285 681 359 681Q481 681 487 683H497Q504 676 504 672T501 655T494 639Q491 637 471 637Q440 637 407 634Q393 631 388 623Q381 609 337 432Q326 385 315 341Q245 65 245 59Q245 52 255 50T307 46H339Q345 38 345 37T342 19Q338 6 332 0H316Q279 2 179 2Q143 2 113 2T65 2T43 1Z"></path></g><g data-mml-node="mi" transform="translate(504,0)"><path data-c="1D436" d="M50 252Q50 367 117 473T286 641T490 704Q580 704 633 653Q642 643 648 636T656 626L657 623Q660 623 684 649Q691 655 699 663T715 679T725 690L740 705H746Q760 705 760 698Q760 694 728 561Q692 422 692 421Q690 416 687 415T669 413H653Q647 419 647 422Q647 423 648 429T650 449T651 481Q651 552 619 605T510 659Q484 659 454 652T382 628T299 572T226 479Q194 422 175 346T156 222Q156 108 232 58Q280 24 350 24Q441 24 512 92T606 240Q610 253 612 255T628 257Q648 257 648 248Q648 243 647 239Q618 132 523 55T319 -22Q206 -22 128 53T50 252Z"></path></g></g><rect width="1746" height="60" x="120" y="220"></rect></g></g><g data-mml-node="mo" transform="translate(18692.8,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g></g></g></g></svg><svg data-labels="true" preserveAspectRatio="xMaxYMid" viewBox="1278 -1654.2 1 2808.5"><g data-labels="true" transform="matrix(1 0 0 -1 0 0)"><g data-mml-node="mtd" id="mjx-eqn:2" transform="translate(0,841.7)"><text data-id-align="true"></text><g data-idbox="true" transform="translate(0,-750)"><g data-mml-node="mtext"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z" transform="translate(389,0)"></path><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z" transform="translate(889,0)"></path></g></g></g></g></svg></g></g></g></g></svg></mjx-container>

</li>
<li>
<p><strong>CPU时间:</strong></p>
<p>根据上述有关CPU时间的定义和描述，某段程序的CPU时间T<sub>cpu</sub>可表示为:</p>
<mjx-container class="MathJax" jax="SVG" display="true" width="full" style="min-width: 28.685ex;"><svg style="vertical-align: -1.707ex; min-width: 28.685ex;" xmlns="http://www.w3.org/2000/svg" width="100%" height="4.545ex" role="img" focusable="false"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(0.0181,-0.0181) translate(0, -1254.5)"><g data-mml-node="math"><g data-mml-node="mtable" transform="translate(2078,0) translate(-2078,0)"><g transform="translate(0 1254.5) matrix(1 0 0 -1 0 0) scale(55.25)"><svg data-table="true" preserveAspectRatio="xMidYMid" viewBox="4261.4 -1254.5 1 2009"><g transform="matrix(1 0 0 -1 0 0)"><g data-mml-node="mlabeledtr" transform="translate(0,136.5)"><g data-mml-node="mtd"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D447" d="M40 437Q21 437 21 445Q21 450 37 501T71 602L88 651Q93 669 101 677H569H659Q691 677 697 676T704 667Q704 661 687 553T668 444Q668 437 649 437Q640 437 637 437T631 442L629 445Q629 451 635 490T641 551Q641 586 628 604T573 629Q568 630 515 631Q469 631 457 630T439 622Q438 621 368 343T298 60Q298 48 386 46Q418 46 427 45T436 36Q436 31 433 22Q429 4 424 1L422 0Q419 0 415 0Q410 0 363 1T228 2Q99 2 64 0H49Q43 6 43 9T45 27Q49 40 55 46H83H94Q174 46 189 55Q190 56 191 56Q196 59 201 76T241 233Q258 301 269 344Q339 619 339 625Q339 630 310 630H279Q212 630 191 624Q146 614 121 583T67 467Q60 445 57 441T43 437H40Z"></path></g><g data-mml-node="TeXAtom" transform="translate(617,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><path data-c="1D450" d="M34 159Q34 268 120 355T306 442Q362 442 394 418T427 355Q427 326 408 306T360 285Q341 285 330 295T319 325T330 359T352 380T366 386H367Q367 388 361 392T340 400T306 404Q276 404 249 390Q228 381 206 359Q162 315 142 235T121 119Q121 73 147 50Q169 26 205 26H209Q321 26 394 111Q403 121 406 121Q410 121 419 112T429 98T420 83T391 55T346 25T282 0T202 -11Q127 -11 81 37T34 159Z"></path></g><g data-mml-node="mi" transform="translate(433,0)"><path data-c="1D45D" d="M23 287Q24 290 25 295T30 317T40 348T55 381T75 411T101 433T134 442Q209 442 230 378L240 387Q302 442 358 442Q423 442 460 395T497 281Q497 173 421 82T249 -10Q227 -10 210 -4Q199 1 187 11T168 28L161 36Q160 35 139 -51T118 -138Q118 -144 126 -145T163 -148H188Q194 -155 194 -157T191 -175Q188 -187 185 -190T172 -194Q170 -194 161 -194T127 -193T65 -192Q-5 -192 -24 -194H-32Q-39 -187 -39 -183Q-37 -156 -26 -148H-6Q28 -147 33 -136Q36 -130 94 103T155 350Q156 355 156 364Q156 405 131 405Q109 405 94 377T71 316T59 280Q57 278 43 278H29Q23 284 23 287ZM178 102Q200 26 252 26Q282 26 310 49T356 107Q374 141 392 215T411 325V331Q411 405 350 405Q339 405 328 402T306 393T286 380T269 365T254 350T243 336T235 326L232 322Q232 321 229 308T218 264T204 212Q178 106 178 102Z"></path></g><g data-mml-node="mi" transform="translate(936,0)"><path data-c="1D462" d="M21 287Q21 295 30 318T55 370T99 420T158 442Q204 442 227 417T250 358Q250 340 216 246T182 105Q182 62 196 45T238 27T291 44T328 78L339 95Q341 99 377 247Q407 367 413 387T427 416Q444 431 463 431Q480 431 488 421T496 402L420 84Q419 79 419 68Q419 43 426 35T447 26Q469 29 482 57T512 145Q514 153 532 153Q551 153 551 144Q550 139 549 130T540 98T523 55T498 17T462 -8Q454 -10 438 -10Q372 -10 347 46Q345 45 336 36T318 21T296 6T267 -6T233 -11Q189 -11 155 7Q103 38 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"></path></g></g></g><g data-mml-node="mo" transform="translate(2011.1,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path></g><g data-mml-node="mi" transform="translate(3066.9,0)"><path data-c="1D45A" d="M21 287Q22 293 24 303T36 341T56 388T88 425T132 442T175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q303 442 384 442Q401 442 415 440T441 433T460 423T475 411T485 398T493 385T497 373T500 364T502 357L510 367Q573 442 659 442Q713 442 746 415T780 336Q780 285 742 178T704 50Q705 36 709 31T724 26Q752 26 776 56T815 138Q818 149 821 151T837 153Q857 153 857 145Q857 144 853 130Q845 101 831 73T785 17T716 -10Q669 -10 648 17T627 73Q627 92 663 193T700 345Q700 404 656 404H651Q565 404 506 303L499 291L466 157Q433 26 428 16Q415 -11 385 -11Q372 -11 364 -4T353 8T350 18Q350 29 384 161L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 181Q151 335 151 342Q154 357 154 369Q154 405 129 405Q107 405 92 377T69 316T57 280Q55 278 41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mo" transform="translate(4167.1,0)"><path data-c="D7" d="M630 29Q630 9 609 9Q604 9 587 25T493 118L389 222L284 117Q178 13 175 11Q171 9 168 9Q160 9 154 15T147 29Q147 36 161 51T255 146L359 250L255 354Q174 435 161 449T147 471Q147 480 153 485T168 490Q173 490 175 489Q178 487 284 383L389 278L493 382Q570 459 587 475T609 491Q630 491 630 471Q630 464 620 453T522 355L418 250L522 145Q606 61 618 48T630 29Z"></path></g><g data-mml-node="mi" transform="translate(5167.3,0)"><path data-c="1D447" d="M40 437Q21 437 21 445Q21 450 37 501T71 602L88 651Q93 669 101 677H569H659Q691 677 697 676T704 667Q704 661 687 553T668 444Q668 437 649 437Q640 437 637 437T631 442L629 445Q629 451 635 490T641 551Q641 586 628 604T573 629Q568 630 515 631Q469 631 457 630T439 622Q438 621 368 343T298 60Q298 48 386 46Q418 46 427 45T436 36Q436 31 433 22Q429 4 424 1L422 0Q419 0 415 0Q410 0 363 1T228 2Q99 2 64 0H49Q43 6 43 9T45 27Q49 40 55 46H83H94Q174 46 189 55Q190 56 191 56Q196 59 201 76T241 233Q258 301 269 344Q339 619 339 625Q339 630 310 630H279Q212 630 191 624Q146 614 121 583T67 467Q60 445 57 441T43 437H40Z"></path></g><g data-mml-node="mo" transform="translate(6149.1,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path></g><g data-mml-node="mfrac" transform="translate(7204.9,0)"><g data-mml-node="mi" transform="translate(220,676)"><path data-c="1D45A" d="M21 287Q22 293 24 303T36 341T56 388T88 425T132 442T175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q303 442 384 442Q401 442 415 440T441 433T460 423T475 411T485 398T493 385T497 373T500 364T502 357L510 367Q573 442 659 442Q713 442 746 415T780 336Q780 285 742 178T704 50Q705 36 709 31T724 26Q752 26 776 56T815 138Q818 149 821 151T837 153Q857 153 857 145Q857 144 853 130Q845 101 831 73T785 17T716 -10Q669 -10 648 17T627 73Q627 92 663 193T700 345Q700 404 656 404H651Q565 404 506 303L499 291L466 157Q433 26 428 16Q415 -11 385 -11Q372 -11 364 -4T353 8T350 18Q350 29 384 161L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 181Q151 335 151 342Q154 357 154 369Q154 405 129 405Q107 405 92 377T69 316T57 280Q55 278 41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mi" transform="translate(384,-686)"><path data-c="1D453" d="M118 -162Q120 -162 124 -164T135 -167T147 -168Q160 -168 171 -155T187 -126Q197 -99 221 27T267 267T289 382V385H242Q195 385 192 387Q188 390 188 397L195 425Q197 430 203 430T250 431Q298 431 298 432Q298 434 307 482T319 540Q356 705 465 705Q502 703 526 683T550 630Q550 594 529 578T487 561Q443 561 443 603Q443 622 454 636T478 657L487 662Q471 668 457 668Q445 668 434 658T419 630Q412 601 403 552T387 469T380 433Q380 431 435 431Q480 431 487 430T498 424Q499 420 496 407T491 391Q489 386 482 386T428 385H372L349 263Q301 15 282 -47Q255 -132 212 -173Q175 -205 139 -205Q107 -205 81 -186T55 -132Q55 -95 76 -78T118 -61Q162 -61 162 -103Q162 -122 151 -136T127 -157L118 -162Z"></path></g><rect width="1078" height="60" x="120" y="220"></rect></g></g></g></g></svg><svg data-labels="true" preserveAspectRatio="xMaxYMid" viewBox="1278 -1254.5 1 2009"><g data-labels="true" transform="matrix(1 0 0 -1 0 0)"><g data-mml-node="mtd" id="mjx-eqn:3" transform="translate(0,886.5)"><text data-id-align="true"></text><g data-idbox="true" transform="translate(0,-750)"><g data-mml-node="mtext"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path><path data-c="33" d="M127 463Q100 463 85 480T69 524Q69 579 117 622T233 665Q268 665 277 664Q351 652 390 611T430 522Q430 470 396 421T302 350L299 348Q299 347 308 345T337 336T375 315Q457 262 457 175Q457 96 395 37T238 -22Q158 -22 100 21T42 130Q42 158 60 175T105 193Q133 193 151 175T169 130Q169 119 166 110T159 94T148 82T136 74T126 70T118 67L114 66Q165 21 238 21Q293 21 321 74Q338 107 338 175V195Q338 290 274 322Q259 328 213 329L171 330L168 332Q166 335 166 348Q166 366 174 366Q202 366 232 371Q266 376 294 413T322 525V533Q322 590 287 612Q265 626 240 626Q208 626 181 615T143 592T132 580H135Q138 579 143 578T153 573T165 566T175 555T183 540T186 520Q186 498 172 481T127 463Z" transform="translate(389,0)"></path><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z" transform="translate(889,0)"></path></g></g></g></g></svg></g></g></g></g></svg></mjx-container>

<p>考虑CPI后，CPU时间还可表示为:</p>
<mjx-container class="MathJax" jax="SVG" display="true" width="full" style="min-width: 43.814ex;"><svg style="vertical-align: -2.005ex; min-width: 43.814ex;" xmlns="http://www.w3.org/2000/svg" width="100%" height="5.14ex" role="img" focusable="false"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(0.0181,-0.0181) translate(0, -1386)"><g data-mml-node="math"><g data-mml-node="mtable" transform="translate(2078,0) translate(-2078,0)"><g transform="translate(0 1386) matrix(1 0 0 -1 0 0) scale(55.25)"><svg data-table="true" preserveAspectRatio="xMidYMid" viewBox="7604.9 -1386 1 2272"><g transform="matrix(1 0 0 -1 0 0)"><g data-mml-node="mlabeledtr" transform="translate(0,5)"><g data-mml-node="mtd"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D447" d="M40 437Q21 437 21 445Q21 450 37 501T71 602L88 651Q93 669 101 677H569H659Q691 677 697 676T704 667Q704 661 687 553T668 444Q668 437 649 437Q640 437 637 437T631 442L629 445Q629 451 635 490T641 551Q641 586 628 604T573 629Q568 630 515 631Q469 631 457 630T439 622Q438 621 368 343T298 60Q298 48 386 46Q418 46 427 45T436 36Q436 31 433 22Q429 4 424 1L422 0Q419 0 415 0Q410 0 363 1T228 2Q99 2 64 0H49Q43 6 43 9T45 27Q49 40 55 46H83H94Q174 46 189 55Q190 56 191 56Q196 59 201 76T241 233Q258 301 269 344Q339 619 339 625Q339 630 310 630H279Q212 630 191 624Q146 614 121 583T67 467Q60 445 57 441T43 437H40Z"></path></g><g data-mml-node="TeXAtom" transform="translate(617,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><path data-c="1D450" d="M34 159Q34 268 120 355T306 442Q362 442 394 418T427 355Q427 326 408 306T360 285Q341 285 330 295T319 325T330 359T352 380T366 386H367Q367 388 361 392T340 400T306 404Q276 404 249 390Q228 381 206 359Q162 315 142 235T121 119Q121 73 147 50Q169 26 205 26H209Q321 26 394 111Q403 121 406 121Q410 121 419 112T429 98T420 83T391 55T346 25T282 0T202 -11Q127 -11 81 37T34 159Z"></path></g><g data-mml-node="mi" transform="translate(433,0)"><path data-c="1D45D" d="M23 287Q24 290 25 295T30 317T40 348T55 381T75 411T101 433T134 442Q209 442 230 378L240 387Q302 442 358 442Q423 442 460 395T497 281Q497 173 421 82T249 -10Q227 -10 210 -4Q199 1 187 11T168 28L161 36Q160 35 139 -51T118 -138Q118 -144 126 -145T163 -148H188Q194 -155 194 -157T191 -175Q188 -187 185 -190T172 -194Q170 -194 161 -194T127 -193T65 -192Q-5 -192 -24 -194H-32Q-39 -187 -39 -183Q-37 -156 -26 -148H-6Q28 -147 33 -136Q36 -130 94 103T155 350Q156 355 156 364Q156 405 131 405Q109 405 94 377T71 316T59 280Q57 278 43 278H29Q23 284 23 287ZM178 102Q200 26 252 26Q282 26 310 49T356 107Q374 141 392 215T411 325V331Q411 405 350 405Q339 405 328 402T306 393T286 380T269 365T254 350T243 336T235 326L232 322Q232 321 229 308T218 264T204 212Q178 106 178 102Z"></path></g><g data-mml-node="mi" transform="translate(936,0)"><path data-c="1D462" d="M21 287Q21 295 30 318T55 370T99 420T158 442Q204 442 227 417T250 358Q250 340 216 246T182 105Q182 62 196 45T238 27T291 44T328 78L339 95Q341 99 377 247Q407 367 413 387T427 416Q444 431 463 431Q480 431 488 421T496 402L420 84Q419 79 419 68Q419 43 426 35T447 26Q469 29 482 57T512 145Q514 153 532 153Q551 153 551 144Q550 139 549 130T540 98T523 55T498 17T462 -8Q454 -10 438 -10Q372 -10 347 46Q345 45 336 36T318 21T296 6T267 -6T233 -11Q189 -11 155 7Q103 38 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"></path></g></g></g><g data-mml-node="mo" transform="translate(2011.1,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path></g><g data-mml-node="mi" transform="translate(3066.9,0)"><path data-c="1D436" d="M50 252Q50 367 117 473T286 641T490 704Q580 704 633 653Q642 643 648 636T656 626L657 623Q660 623 684 649Q691 655 699 663T715 679T725 690L740 705H746Q760 705 760 698Q760 694 728 561Q692 422 692 421Q690 416 687 415T669 413H653Q647 419 647 422Q647 423 648 429T650 449T651 481Q651 552 619 605T510 659Q484 659 454 652T382 628T299 572T226 479Q194 422 175 346T156 222Q156 108 232 58Q280 24 350 24Q441 24 512 92T606 240Q610 253 612 255T628 257Q648 257 648 248Q648 243 647 239Q618 132 523 55T319 -22Q206 -22 128 53T50 252Z"></path></g><g data-mml-node="mi" transform="translate(3826.9,0)"><path data-c="1D443" d="M287 628Q287 635 230 637Q206 637 199 638T192 648Q192 649 194 659Q200 679 203 681T397 683Q587 682 600 680Q664 669 707 631T751 530Q751 453 685 389Q616 321 507 303Q500 302 402 301H307L277 182Q247 66 247 59Q247 55 248 54T255 50T272 48T305 46H336Q342 37 342 35Q342 19 335 5Q330 0 319 0Q316 0 282 1T182 2Q120 2 87 2T51 1Q33 1 33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM645 554Q645 567 643 575T634 597T609 619T560 635Q553 636 480 637Q463 637 445 637T416 636T404 636Q391 635 386 627Q384 621 367 550T332 412T314 344Q314 342 395 342H407H430Q542 342 590 392Q617 419 631 471T645 554Z"></path></g><g data-mml-node="mi" transform="translate(4577.9,0)"><path data-c="1D43C" d="M43 1Q26 1 26 10Q26 12 29 24Q34 43 39 45Q42 46 54 46H60Q120 46 136 53Q137 53 138 54Q143 56 149 77T198 273Q210 318 216 344Q286 624 286 626Q284 630 284 631Q274 637 213 637H193Q184 643 189 662Q193 677 195 680T209 683H213Q285 681 359 681Q481 681 487 683H497Q504 676 504 672T501 655T494 639Q491 637 471 637Q440 637 407 634Q393 631 388 623Q381 609 337 432Q326 385 315 341Q245 65 245 59Q245 52 255 50T307 46H339Q345 38 345 37T342 19Q338 6 332 0H316Q279 2 179 2Q143 2 113 2T65 2T43 1Z"></path></g><g data-mml-node="mo" transform="translate(5304.1,0)"><path data-c="D7" d="M630 29Q630 9 609 9Q604 9 587 25T493 118L389 222L284 117Q178 13 175 11Q171 9 168 9Q160 9 154 15T147 29Q147 36 161 51T255 146L359 250L255 354Q174 435 161 449T147 471Q147 480 153 485T168 490Q173 490 175 489Q178 487 284 383L389 278L493 382Q570 459 587 475T609 491Q630 491 630 471Q630 464 620 453T522 355L418 250L522 145Q606 61 618 48T630 29Z"></path></g><g data-mml-node="mi" transform="translate(6304.3,0)"><path data-c="1D43C" d="M43 1Q26 1 26 10Q26 12 29 24Q34 43 39 45Q42 46 54 46H60Q120 46 136 53Q137 53 138 54Q143 56 149 77T198 273Q210 318 216 344Q286 624 286 626Q284 630 284 631Q274 637 213 637H193Q184 643 189 662Q193 677 195 680T209 683H213Q285 681 359 681Q481 681 487 683H497Q504 676 504 672T501 655T494 639Q491 637 471 637Q440 637 407 634Q393 631 388 623Q381 609 337 432Q326 385 315 341Q245 65 245 59Q245 52 255 50T307 46H339Q345 38 345 37T342 19Q338 6 332 0H316Q279 2 179 2Q143 2 113 2T65 2T43 1Z"></path></g><g data-mml-node="mi" transform="translate(6808.3,0)"><path data-c="1D436" d="M50 252Q50 367 117 473T286 641T490 704Q580 704 633 653Q642 643 648 636T656 626L657 623Q660 623 684 649Q691 655 699 663T715 679T725 690L740 705H746Q760 705 760 698Q760 694 728 561Q692 422 692 421Q690 416 687 415T669 413H653Q647 419 647 422Q647 423 648 429T650 449T651 481Q651 552 619 605T510 659Q484 659 454 652T382 628T299 572T226 479Q194 422 175 346T156 222Q156 108 232 58Q280 24 350 24Q441 24 512 92T606 240Q610 253 612 255T628 257Q648 257 648 248Q648 243 647 239Q618 132 523 55T319 -22Q206 -22 128 53T50 252Z"></path></g><g data-mml-node="mo" transform="translate(7790.5,0)"><path data-c="D7" d="M630 29Q630 9 609 9Q604 9 587 25T493 118L389 222L284 117Q178 13 175 11Q171 9 168 9Q160 9 154 15T147 29Q147 36 161 51T255 146L359 250L255 354Q174 435 161 449T147 471Q147 480 153 485T168 490Q173 490 175 489Q178 487 284 383L389 278L493 382Q570 459 587 475T609 491Q630 491 630 471Q630 464 620 453T522 355L418 250L522 145Q606 61 618 48T630 29Z"></path></g><g data-mml-node="mi" transform="translate(8790.8,0)"><path data-c="1D447" d="M40 437Q21 437 21 445Q21 450 37 501T71 602L88 651Q93 669 101 677H569H659Q691 677 697 676T704 667Q704 661 687 553T668 444Q668 437 649 437Q640 437 637 437T631 442L629 445Q629 451 635 490T641 551Q641 586 628 604T573 629Q568 630 515 631Q469 631 457 630T439 622Q438 621 368 343T298 60Q298 48 386 46Q418 46 427 45T436 36Q436 31 433 22Q429 4 424 1L422 0Q419 0 415 0Q410 0 363 1T228 2Q99 2 64 0H49Q43 6 43 9T45 27Q49 40 55 46H83H94Q174 46 189 55Q190 56 191 56Q196 59 201 76T241 233Q258 301 269 344Q339 619 339 625Q339 630 310 630H279Q212 630 191 624Q146 614 121 583T67 467Q60 445 57 441T43 437H40Z"></path></g><g data-mml-node="mo" transform="translate(9772.5,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path></g><g data-mml-node="mfrac" transform="translate(10828.3,0)"><g data-mml-node="mrow" transform="translate(220,676)"><g data-mml-node="mi"><path data-c="1D436" d="M50 252Q50 367 117 473T286 641T490 704Q580 704 633 653Q642 643 648 636T656 626L657 623Q660 623 684 649Q691 655 699 663T715 679T725 690L740 705H746Q760 705 760 698Q760 694 728 561Q692 422 692 421Q690 416 687 415T669 413H653Q647 419 647 422Q647 423 648 429T650 449T651 481Q651 552 619 605T510 659Q484 659 454 652T382 628T299 572T226 479Q194 422 175 346T156 222Q156 108 232 58Q280 24 350 24Q441 24 512 92T606 240Q610 253 612 255T628 257Q648 257 648 248Q648 243 647 239Q618 132 523 55T319 -22Q206 -22 128 53T50 252Z"></path></g><g data-mml-node="mi" transform="translate(760,0)"><path data-c="1D443" d="M287 628Q287 635 230 637Q206 637 199 638T192 648Q192 649 194 659Q200 679 203 681T397 683Q587 682 600 680Q664 669 707 631T751 530Q751 453 685 389Q616 321 507 303Q500 302 402 301H307L277 182Q247 66 247 59Q247 55 248 54T255 50T272 48T305 46H336Q342 37 342 35Q342 19 335 5Q330 0 319 0Q316 0 282 1T182 2Q120 2 87 2T51 1Q33 1 33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM645 554Q645 567 643 575T634 597T609 619T560 635Q553 636 480 637Q463 637 445 637T416 636T404 636Q391 635 386 627Q384 621 367 550T332 412T314 344Q314 342 395 342H407H430Q542 342 590 392Q617 419 631 471T645 554Z"></path></g><g data-mml-node="mi" transform="translate(1511,0)"><path data-c="1D43C" d="M43 1Q26 1 26 10Q26 12 29 24Q34 43 39 45Q42 46 54 46H60Q120 46 136 53Q137 53 138 54Q143 56 149 77T198 273Q210 318 216 344Q286 624 286 626Q284 630 284 631Q274 637 213 637H193Q184 643 189 662Q193 677 195 680T209 683H213Q285 681 359 681Q481 681 487 683H497Q504 676 504 672T501 655T494 639Q491 637 471 637Q440 637 407 634Q393 631 388 623Q381 609 337 432Q326 385 315 341Q245 65 245 59Q245 52 255 50T307 46H339Q345 38 345 37T342 19Q338 6 332 0H316Q279 2 179 2Q143 2 113 2T65 2T43 1Z"></path></g><g data-mml-node="mo" transform="translate(2237.2,0)"><path data-c="D7" d="M630 29Q630 9 609 9Q604 9 587 25T493 118L389 222L284 117Q178 13 175 11Q171 9 168 9Q160 9 154 15T147 29Q147 36 161 51T255 146L359 250L255 354Q174 435 161 449T147 471Q147 480 153 485T168 490Q173 490 175 489Q178 487 284 383L389 278L493 382Q570 459 587 475T609 491Q630 491 630 471Q630 464 620 453T522 355L418 250L522 145Q606 61 618 48T630 29Z"></path></g><g data-mml-node="mi" transform="translate(3237.4,0)"><path data-c="1D447" d="M40 437Q21 437 21 445Q21 450 37 501T71 602L88 651Q93 669 101 677H569H659Q691 677 697 676T704 667Q704 661 687 553T668 444Q668 437 649 437Q640 437 637 437T631 442L629 445Q629 451 635 490T641 551Q641 586 628 604T573 629Q568 630 515 631Q469 631 457 630T439 622Q438 621 368 343T298 60Q298 48 386 46Q418 46 427 45T436 36Q436 31 433 22Q429 4 424 1L422 0Q419 0 415 0Q410 0 363 1T228 2Q99 2 64 0H49Q43 6 43 9T45 27Q49 40 55 46H83H94Q174 46 189 55Q190 56 191 56Q196 59 201 76T241 233Q258 301 269 344Q339 619 339 625Q339 630 310 630H279Q212 630 191 624Q146 614 121 583T67 467Q60 445 57 441T43 437H40Z"></path></g></g><g data-mml-node="mi" transform="translate(1915.7,-686)"><path data-c="1D453" d="M118 -162Q120 -162 124 -164T135 -167T147 -168Q160 -168 171 -155T187 -126Q197 -99 221 27T267 267T289 382V385H242Q195 385 192 387Q188 390 188 397L195 425Q197 430 203 430T250 431Q298 431 298 432Q298 434 307 482T319 540Q356 705 465 705Q502 703 526 683T550 630Q550 594 529 578T487 561Q443 561 443 603Q443 622 454 636T478 657L487 662Q471 668 457 668Q445 668 434 658T419 630Q412 601 403 552T387 469T380 433Q380 431 435 431Q480 431 487 430T498 424Q499 420 496 407T491 391Q489 386 482 386T428 385H372L349 263Q301 15 282 -47Q255 -132 212 -173Q175 -205 139 -205Q107 -205 81 -186T55 -132Q55 -95 76 -78T118 -61Q162 -61 162 -103Q162 -122 151 -136T127 -157L118 -162Z"></path></g><rect width="4141.4" height="60" x="120" y="220"></rect></g></g></g></g></svg><svg data-labels="true" preserveAspectRatio="xMaxYMid" viewBox="1278 -1386 1 2272"><g data-labels="true" transform="matrix(1 0 0 -1 0 0)"><g data-mml-node="mtd" id="mjx-eqn:4" transform="translate(0,755)"><text data-id-align="true"></text><g data-idbox="true" transform="translate(0,-750)"><g data-mml-node="mtext"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path><path data-c="34" d="M462 0Q444 3 333 3Q217 3 199 0H190V46H221Q241 46 248 46T265 48T279 53T286 61Q287 63 287 115V165H28V211L179 442Q332 674 334 675Q336 677 355 677H373L379 671V211H471V165H379V114Q379 73 379 66T385 54Q393 47 442 46H471V0H462ZM293 211V545L74 212L183 211H293Z" transform="translate(389,0)"></path><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z" transform="translate(889,0)"></path></g></g></g></g></svg></g></g></g></g></svg></mjx-container>

</li>
</ol>
<p>​	从式(1-1)~式(1-4)可以看出CPU时间与下列3个因素紧密相关。</p>
<p>​	(1)时钟频率。时钟频率取决于CPU的实现技术和工艺，时钟频率越高，程序执行速度就越快。<br>
​	(2)CPI。CPI取决于计算机的实现技术和指令集结构，CPI越小，程序执行速度越快。</p>
<p>​	(3)指令条数。当CPI和时钟周期固定时，程序指令条数越少，执行速度就越快。完成相同功能的程序所包含的指令条数主要与指令系统的设计和编译技术有关。</p>
<ol start="10">
<li>
<p><strong>MIPS:</strong></p>
<p>MIPS(Million Instructions Per Second)即每秒百万条指令，更大的单位有 GIPS(GigaInstructions Per Second)。可用每秒执行完成的指令数量作为衡量计算机性能的一个指标，不过要注意这个指标衡量的指令数量是以百万为单位的。<br>
根据 MIPS 的定义，可用下面的公式计算MIPS:</p>
<mjx-container class="MathJax" jax="SVG" display="true" width="full" style="min-width: 29.4ex;"><svg style="vertical-align: -2.254ex; min-width: 29.4ex;" xmlns="http://www.w3.org/2000/svg" width="100%" height="5.638ex" role="img" focusable="false"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(0.0181,-0.0181) translate(0, -1496.1)"><g data-mml-node="math"><g data-mml-node="mtable" transform="translate(2078,0) translate(-2078,0)"><g transform="translate(0 1496.1) matrix(1 0 0 -1 0 0) scale(55.25)"><svg data-table="true" preserveAspectRatio="xMidYMid" viewBox="4419.4 -1496.1 1 2492.2"><g transform="matrix(1 0 0 -1 0 0)"><g data-mml-node="mlabeledtr" transform="translate(0,115.1)"><g data-mml-node="mtd"><g data-mml-node="mi"><path data-c="1D440" d="M289 629Q289 635 232 637Q208 637 201 638T194 648Q194 649 196 659Q197 662 198 666T199 671T201 676T203 679T207 681T212 683T220 683T232 684Q238 684 262 684T307 683Q386 683 398 683T414 678Q415 674 451 396L487 117L510 154Q534 190 574 254T662 394Q837 673 839 675Q840 676 842 678T846 681L852 683H948Q965 683 988 683T1017 684Q1051 684 1051 673Q1051 668 1048 656T1045 643Q1041 637 1008 637Q968 636 957 634T939 623Q936 618 867 340T797 59Q797 55 798 54T805 50T822 48T855 46H886Q892 37 892 35Q892 19 885 5Q880 0 869 0Q864 0 828 1T736 2Q675 2 644 2T609 1Q592 1 592 11Q592 13 594 25Q598 41 602 43T625 46Q652 46 685 49Q699 52 704 61Q706 65 742 207T813 490T848 631L654 322Q458 10 453 5Q451 4 449 3Q444 0 433 0Q418 0 415 7Q413 11 374 317L335 624L267 354Q200 88 200 79Q206 46 272 46H282Q288 41 289 37T286 19Q282 3 278 1Q274 0 267 0Q265 0 255 0T221 1T157 2Q127 2 95 1T58 0Q43 0 39 2T35 11Q35 13 38 25T43 40Q45 46 65 46Q135 46 154 86Q158 92 223 354T289 629Z"></path></g><g data-mml-node="mi" transform="translate(1051,0)"><path data-c="1D43C" d="M43 1Q26 1 26 10Q26 12 29 24Q34 43 39 45Q42 46 54 46H60Q120 46 136 53Q137 53 138 54Q143 56 149 77T198 273Q210 318 216 344Q286 624 286 626Q284 630 284 631Q274 637 213 637H193Q184 643 189 662Q193 677 195 680T209 683H213Q285 681 359 681Q481 681 487 683H497Q504 676 504 672T501 655T494 639Q491 637 471 637Q440 637 407 634Q393 631 388 623Q381 609 337 432Q326 385 315 341Q245 65 245 59Q245 52 255 50T307 46H339Q345 38 345 37T342 19Q338 6 332 0H316Q279 2 179 2Q143 2 113 2T65 2T43 1Z"></path></g><g data-mml-node="mi" transform="translate(1555,0)"><path data-c="1D443" d="M287 628Q287 635 230 637Q206 637 199 638T192 648Q192 649 194 659Q200 679 203 681T397 683Q587 682 600 680Q664 669 707 631T751 530Q751 453 685 389Q616 321 507 303Q500 302 402 301H307L277 182Q247 66 247 59Q247 55 248 54T255 50T272 48T305 46H336Q342 37 342 35Q342 19 335 5Q330 0 319 0Q316 0 282 1T182 2Q120 2 87 2T51 1Q33 1 33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM645 554Q645 567 643 575T634 597T609 619T560 635Q553 636 480 637Q463 637 445 637T416 636T404 636Q391 635 386 627Q384 621 367 550T332 412T314 344Q314 342 395 342H407H430Q542 342 590 392Q617 419 631 471T645 554Z"></path></g><g data-mml-node="mi" transform="translate(2306,0)"><path data-c="1D446" d="M308 24Q367 24 416 76T466 197Q466 260 414 284Q308 311 278 321T236 341Q176 383 176 462Q176 523 208 573T273 648Q302 673 343 688T407 704H418H425Q521 704 564 640Q565 640 577 653T603 682T623 704Q624 704 627 704T632 705Q645 705 645 698T617 577T585 459T569 456Q549 456 549 465Q549 471 550 475Q550 478 551 494T553 520Q553 554 544 579T526 616T501 641Q465 662 419 662Q362 662 313 616T263 510Q263 480 278 458T319 427Q323 425 389 408T456 390Q490 379 522 342T554 242Q554 216 546 186Q541 164 528 137T492 78T426 18T332 -20Q320 -22 298 -22Q199 -22 144 33L134 44L106 13Q83 -14 78 -18T65 -22Q52 -22 52 -14Q52 -11 110 221Q112 227 130 227H143Q149 221 149 216Q149 214 148 207T144 186T142 153Q144 114 160 87T203 47T255 29T308 24Z"></path></g><g data-mml-node="mo" transform="translate(3228.8,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path></g><g data-mml-node="mfrac" transform="translate(4284.6,0)"><g data-mml-node="mrow" transform="translate(1645.2,676)"><g data-mml-node="mi"><path data-c="1D43C" d="M43 1Q26 1 26 10Q26 12 29 24Q34 43 39 45Q42 46 54 46H60Q120 46 136 53Q137 53 138 54Q143 56 149 77T198 273Q210 318 216 344Q286 624 286 626Q284 630 284 631Q274 637 213 637H193Q184 643 189 662Q193 677 195 680T209 683H213Q285 681 359 681Q481 681 487 683H497Q504 676 504 672T501 655T494 639Q491 637 471 637Q440 637 407 634Q393 631 388 623Q381 609 337 432Q326 385 315 341Q245 65 245 59Q245 52 255 50T307 46H339Q345 38 345 37T342 19Q338 6 332 0H316Q279 2 179 2Q143 2 113 2T65 2T43 1Z"></path></g><g data-mml-node="mi" transform="translate(504,0)"><path data-c="1D436" d="M50 252Q50 367 117 473T286 641T490 704Q580 704 633 653Q642 643 648 636T656 626L657 623Q660 623 684 649Q691 655 699 663T715 679T725 690L740 705H746Q760 705 760 698Q760 694 728 561Q692 422 692 421Q690 416 687 415T669 413H653Q647 419 647 422Q647 423 648 429T650 449T651 481Q651 552 619 605T510 659Q484 659 454 652T382 628T299 572T226 479Q194 422 175 346T156 222Q156 108 232 58Q280 24 350 24Q441 24 512 92T606 240Q610 253 612 255T628 257Q648 257 648 248Q648 243 647 239Q618 132 523 55T319 -22Q206 -22 128 53T50 252Z"></path></g></g><g data-mml-node="mrow" transform="translate(220,-824)"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D447" d="M40 437Q21 437 21 445Q21 450 37 501T71 602L88 651Q93 669 101 677H569H659Q691 677 697 676T704 667Q704 661 687 553T668 444Q668 437 649 437Q640 437 637 437T631 442L629 445Q629 451 635 490T641 551Q641 586 628 604T573 629Q568 630 515 631Q469 631 457 630T439 622Q438 621 368 343T298 60Q298 48 386 46Q418 46 427 45T436 36Q436 31 433 22Q429 4 424 1L422 0Q419 0 415 0Q410 0 363 1T228 2Q99 2 64 0H49Q43 6 43 9T45 27Q49 40 55 46H83H94Q174 46 189 55Q190 56 191 56Q196 59 201 76T241 233Q258 301 269 344Q339 619 339 625Q339 630 310 630H279Q212 630 191 624Q146 614 121 583T67 467Q60 445 57 441T43 437H40Z"></path></g><g data-mml-node="TeXAtom" transform="translate(617,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><path data-c="1D450" d="M34 159Q34 268 120 355T306 442Q362 442 394 418T427 355Q427 326 408 306T360 285Q341 285 330 295T319 325T330 359T352 380T366 386H367Q367 388 361 392T340 400T306 404Q276 404 249 390Q228 381 206 359Q162 315 142 235T121 119Q121 73 147 50Q169 26 205 26H209Q321 26 394 111Q403 121 406 121Q410 121 419 112T429 98T420 83T391 55T346 25T282 0T202 -11Q127 -11 81 37T34 159Z"></path></g><g data-mml-node="mi" transform="translate(433,0)"><path data-c="1D45D" d="M23 287Q24 290 25 295T30 317T40 348T55 381T75 411T101 433T134 442Q209 442 230 378L240 387Q302 442 358 442Q423 442 460 395T497 281Q497 173 421 82T249 -10Q227 -10 210 -4Q199 1 187 11T168 28L161 36Q160 35 139 -51T118 -138Q118 -144 126 -145T163 -148H188Q194 -155 194 -157T191 -175Q188 -187 185 -190T172 -194Q170 -194 161 -194T127 -193T65 -192Q-5 -192 -24 -194H-32Q-39 -187 -39 -183Q-37 -156 -26 -148H-6Q28 -147 33 -136Q36 -130 94 103T155 350Q156 355 156 364Q156 405 131 405Q109 405 94 377T71 316T59 280Q57 278 43 278H29Q23 284 23 287ZM178 102Q200 26 252 26Q282 26 310 49T356 107Q374 141 392 215T411 325V331Q411 405 350 405Q339 405 328 402T306 393T286 380T269 365T254 350T243 336T235 326L232 322Q232 321 229 308T218 264T204 212Q178 106 178 102Z"></path></g><g data-mml-node="mi" transform="translate(936,0)"><path data-c="1D462" d="M21 287Q21 295 30 318T55 370T99 420T158 442Q204 442 227 417T250 358Q250 340 216 246T182 105Q182 62 196 45T238 27T291 44T328 78L339 95Q341 99 377 247Q407 367 413 387T427 416Q444 431 463 431Q480 431 488 421T496 402L420 84Q419 79 419 68Q419 43 426 35T447 26Q469 29 482 57T512 145Q514 153 532 153Q551 153 551 144Q550 139 549 130T540 98T523 55T498 17T462 -8Q454 -10 438 -10Q372 -10 347 46Q345 45 336 36T318 21T296 6T267 -6T233 -11Q189 -11 155 7Q103 38 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"></path></g></g></g><g data-mml-node="mo" transform="translate(1955.5,0)"><path data-c="2217" d="M229 286Q216 420 216 436Q216 454 240 464Q241 464 245 464T251 465Q263 464 273 456T283 436Q283 419 277 356T270 286L328 328Q384 369 389 372T399 375Q412 375 423 365T435 338Q435 325 425 315Q420 312 357 282T289 250L355 219L425 184Q434 175 434 161Q434 146 425 136T401 125Q393 125 383 131T328 171L270 213Q283 79 283 63Q283 53 276 44T250 35Q231 35 224 44T216 63Q216 80 222 143T229 213L171 171Q115 130 110 127Q106 124 100 124Q87 124 76 134T64 161Q64 166 64 169T67 175T72 181T81 188T94 195T113 204T138 215T170 230T210 250L74 315Q65 324 65 338Q65 353 74 363T98 374Q106 374 116 368T171 328L229 286Z"></path></g><g data-mml-node="msup" transform="translate(2677.8,0)"><g data-mml-node="mn"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z" transform="translate(500,0)"></path></g><g data-mml-node="mn" transform="translate(1033,393.1) scale(0.707)"><path data-c="36" d="M42 313Q42 476 123 571T303 666Q372 666 402 630T432 550Q432 525 418 510T379 495Q356 495 341 509T326 548Q326 592 373 601Q351 623 311 626Q240 626 194 566Q147 500 147 364L148 360Q153 366 156 373Q197 433 263 433H267Q313 433 348 414Q372 400 396 374T435 317Q456 268 456 210V192Q456 169 451 149Q440 90 387 34T253 -22Q225 -22 199 -14T143 16T92 75T56 172T42 313ZM257 397Q227 397 205 380T171 335T154 278T148 216Q148 133 160 97T198 39Q222 21 251 21Q302 21 329 59Q342 77 347 104T352 209Q352 289 347 316T329 361Q302 397 257 397Z"></path></g></g></g><rect width="4314.3" height="60" x="120" y="220"></rect></g></g></g></g></svg><svg data-labels="true" preserveAspectRatio="xMaxYMid" viewBox="1278 -1496.1 1 2492.2"><g data-labels="true" transform="matrix(1 0 0 -1 0 0)"><g data-mml-node="mtd" id="mjx-eqn:5" transform="translate(0,865.1)"><text data-id-align="true"></text><g data-idbox="true" transform="translate(0,-750)"><g data-mml-node="mtext"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path><path data-c="35" d="M164 157Q164 133 148 117T109 101H102Q148 22 224 22Q294 22 326 82Q345 115 345 210Q345 313 318 349Q292 382 260 382H254Q176 382 136 314Q132 307 129 306T114 304Q97 304 95 310Q93 314 93 485V614Q93 664 98 664Q100 666 102 666Q103 666 123 658T178 642T253 634Q324 634 389 662Q397 666 402 666Q410 666 410 648V635Q328 538 205 538Q174 538 149 544L139 546V374Q158 388 169 396T205 412T256 420Q337 420 393 355T449 201Q449 109 385 44T229 -22Q148 -22 99 32T50 154Q50 178 61 192T84 210T107 214Q132 214 148 197T164 157Z" transform="translate(389,0)"></path><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z" transform="translate(889,0)"></path></g></g></g></g></svg></g></g></g></g></svg></mjx-container>

<p>将(4)式代入(5)式得到(IPC是CPI倒数)</p>
<mjx-container class="MathJax" jax="SVG" display="true" width="full" style="min-width: 49.515ex;"><svg style="vertical-align: -1.798ex; min-width: 49.515ex;" xmlns="http://www.w3.org/2000/svg" width="100%" height="4.726ex" role="img" focusable="false"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(0.0181,-0.0181) translate(0, -1294.5)"><g data-mml-node="math"><g data-mml-node="mtable" transform="translate(2078,0) translate(-2078,0)"><g transform="translate(0 1294.5) matrix(1 0 0 -1 0 0) scale(55.25)"><svg data-table="true" preserveAspectRatio="xMidYMid" viewBox="8864.8 -1294.5 1 2089"><g transform="matrix(1 0 0 -1 0 0)"><g data-mml-node="mlabeledtr" transform="translate(0,-86.5)"><g data-mml-node="mtd"><g data-mml-node="mi"><path data-c="1D440" d="M289 629Q289 635 232 637Q208 637 201 638T194 648Q194 649 196 659Q197 662 198 666T199 671T201 676T203 679T207 681T212 683T220 683T232 684Q238 684 262 684T307 683Q386 683 398 683T414 678Q415 674 451 396L487 117L510 154Q534 190 574 254T662 394Q837 673 839 675Q840 676 842 678T846 681L852 683H948Q965 683 988 683T1017 684Q1051 684 1051 673Q1051 668 1048 656T1045 643Q1041 637 1008 637Q968 636 957 634T939 623Q936 618 867 340T797 59Q797 55 798 54T805 50T822 48T855 46H886Q892 37 892 35Q892 19 885 5Q880 0 869 0Q864 0 828 1T736 2Q675 2 644 2T609 1Q592 1 592 11Q592 13 594 25Q598 41 602 43T625 46Q652 46 685 49Q699 52 704 61Q706 65 742 207T813 490T848 631L654 322Q458 10 453 5Q451 4 449 3Q444 0 433 0Q418 0 415 7Q413 11 374 317L335 624L267 354Q200 88 200 79Q206 46 272 46H282Q288 41 289 37T286 19Q282 3 278 1Q274 0 267 0Q265 0 255 0T221 1T157 2Q127 2 95 1T58 0Q43 0 39 2T35 11Q35 13 38 25T43 40Q45 46 65 46Q135 46 154 86Q158 92 223 354T289 629Z"></path></g><g data-mml-node="mi" transform="translate(1051,0)"><path data-c="1D43C" d="M43 1Q26 1 26 10Q26 12 29 24Q34 43 39 45Q42 46 54 46H60Q120 46 136 53Q137 53 138 54Q143 56 149 77T198 273Q210 318 216 344Q286 624 286 626Q284 630 284 631Q274 637 213 637H193Q184 643 189 662Q193 677 195 680T209 683H213Q285 681 359 681Q481 681 487 683H497Q504 676 504 672T501 655T494 639Q491 637 471 637Q440 637 407 634Q393 631 388 623Q381 609 337 432Q326 385 315 341Q245 65 245 59Q245 52 255 50T307 46H339Q345 38 345 37T342 19Q338 6 332 0H316Q279 2 179 2Q143 2 113 2T65 2T43 1Z"></path></g><g data-mml-node="mi" transform="translate(1555,0)"><path data-c="1D443" d="M287 628Q287 635 230 637Q206 637 199 638T192 648Q192 649 194 659Q200 679 203 681T397 683Q587 682 600 680Q664 669 707 631T751 530Q751 453 685 389Q616 321 507 303Q500 302 402 301H307L277 182Q247 66 247 59Q247 55 248 54T255 50T272 48T305 46H336Q342 37 342 35Q342 19 335 5Q330 0 319 0Q316 0 282 1T182 2Q120 2 87 2T51 1Q33 1 33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM645 554Q645 567 643 575T634 597T609 619T560 635Q553 636 480 637Q463 637 445 637T416 636T404 636Q391 635 386 627Q384 621 367 550T332 412T314 344Q314 342 395 342H407H430Q542 342 590 392Q617 419 631 471T645 554Z"></path></g><g data-mml-node="mi" transform="translate(2306,0)"><path data-c="1D446" d="M308 24Q367 24 416 76T466 197Q466 260 414 284Q308 311 278 321T236 341Q176 383 176 462Q176 523 208 573T273 648Q302 673 343 688T407 704H418H425Q521 704 564 640Q565 640 577 653T603 682T623 704Q624 704 627 704T632 705Q645 705 645 698T617 577T585 459T569 456Q549 456 549 465Q549 471 550 475Q550 478 551 494T553 520Q553 554 544 579T526 616T501 641Q465 662 419 662Q362 662 313 616T263 510Q263 480 278 458T319 427Q323 425 389 408T456 390Q490 379 522 342T554 242Q554 216 546 186Q541 164 528 137T492 78T426 18T332 -20Q320 -22 298 -22Q199 -22 144 33L134 44L106 13Q83 -14 78 -18T65 -22Q52 -22 52 -14Q52 -11 110 221Q112 227 130 227H143Q149 221 149 216Q149 214 148 207T144 186T142 153Q144 114 160 87T203 47T255 29T308 24Z"></path></g><g data-mml-node="mo" transform="translate(3228.8,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path></g><g data-mml-node="mfrac" transform="translate(4284.6,0)"><g data-mml-node="mi" transform="translate(952.5,676)"><path data-c="1D453" d="M118 -162Q120 -162 124 -164T135 -167T147 -168Q160 -168 171 -155T187 -126Q197 -99 221 27T267 267T289 382V385H242Q195 385 192 387Q188 390 188 397L195 425Q197 430 203 430T250 431Q298 431 298 432Q298 434 307 482T319 540Q356 705 465 705Q502 703 526 683T550 630Q550 594 529 578T487 561Q443 561 443 603Q443 622 454 636T478 657L487 662Q471 668 457 668Q445 668 434 658T419 630Q412 601 403 552T387 469T380 433Q380 431 435 431Q480 431 487 430T498 424Q499 420 496 407T491 391Q489 386 482 386T428 385H372L349 263Q301 15 282 -47Q255 -132 212 -173Q175 -205 139 -205Q107 -205 81 -186T55 -132Q55 -95 76 -78T118 -61Q162 -61 162 -103Q162 -122 151 -136T127 -157L118 -162Z"></path></g><g data-mml-node="mrow" transform="translate(220,-686)"><g data-mml-node="mi"><path data-c="1D436" d="M50 252Q50 367 117 473T286 641T490 704Q580 704 633 653Q642 643 648 636T656 626L657 623Q660 623 684 649Q691 655 699 663T715 679T725 690L740 705H746Q760 705 760 698Q760 694 728 561Q692 422 692 421Q690 416 687 415T669 413H653Q647 419 647 422Q647 423 648 429T650 449T651 481Q651 552 619 605T510 659Q484 659 454 652T382 628T299 572T226 479Q194 422 175 346T156 222Q156 108 232 58Q280 24 350 24Q441 24 512 92T606 240Q610 253 612 255T628 257Q648 257 648 248Q648 243 647 239Q618 132 523 55T319 -22Q206 -22 128 53T50 252Z"></path></g><g data-mml-node="mi" transform="translate(760,0)"><path data-c="1D443" d="M287 628Q287 635 230 637Q206 637 199 638T192 648Q192 649 194 659Q200 679 203 681T397 683Q587 682 600 680Q664 669 707 631T751 530Q751 453 685 389Q616 321 507 303Q500 302 402 301H307L277 182Q247 66 247 59Q247 55 248 54T255 50T272 48T305 46H336Q342 37 342 35Q342 19 335 5Q330 0 319 0Q316 0 282 1T182 2Q120 2 87 2T51 1Q33 1 33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM645 554Q645 567 643 575T634 597T609 619T560 635Q553 636 480 637Q463 637 445 637T416 636T404 636Q391 635 386 627Q384 621 367 550T332 412T314 344Q314 342 395 342H407H430Q542 342 590 392Q617 419 631 471T645 554Z"></path></g><g data-mml-node="mi" transform="translate(1511,0)"><path data-c="1D43C" d="M43 1Q26 1 26 10Q26 12 29 24Q34 43 39 45Q42 46 54 46H60Q120 46 136 53Q137 53 138 54Q143 56 149 77T198 273Q210 318 216 344Q286 624 286 626Q284 630 284 631Q274 637 213 637H193Q184 643 189 662Q193 677 195 680T209 683H213Q285 681 359 681Q481 681 487 683H497Q504 676 504 672T501 655T494 639Q491 637 471 637Q440 637 407 634Q393 631 388 623Q381 609 337 432Q326 385 315 341Q245 65 245 59Q245 52 255 50T307 46H339Q345 38 345 37T342 19Q338 6 332 0H316Q279 2 179 2Q143 2 113 2T65 2T43 1Z"></path></g></g><rect width="2215" height="60" x="120" y="220"></rect></g><g data-mml-node="mo" transform="translate(7017.3,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path></g><g data-mml-node="mfrac" transform="translate(8073.1,0)"><g data-mml-node="mn" transform="translate(1940.7,676)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g><g data-mml-node="mrow" transform="translate(220,-686)"><g data-mml-node="mi"><path data-c="1D436" d="M50 252Q50 367 117 473T286 641T490 704Q580 704 633 653Q642 643 648 636T656 626L657 623Q660 623 684 649Q691 655 699 663T715 679T725 690L740 705H746Q760 705 760 698Q760 694 728 561Q692 422 692 421Q690 416 687 415T669 413H653Q647 419 647 422Q647 423 648 429T650 449T651 481Q651 552 619 605T510 659Q484 659 454 652T382 628T299 572T226 479Q194 422 175 346T156 222Q156 108 232 58Q280 24 350 24Q441 24 512 92T606 240Q610 253 612 255T628 257Q648 257 648 248Q648 243 647 239Q618 132 523 55T319 -22Q206 -22 128 53T50 252Z"></path></g><g data-mml-node="mi" transform="translate(760,0)"><path data-c="1D443" d="M287 628Q287 635 230 637Q206 637 199 638T192 648Q192 649 194 659Q200 679 203 681T397 683Q587 682 600 680Q664 669 707 631T751 530Q751 453 685 389Q616 321 507 303Q500 302 402 301H307L277 182Q247 66 247 59Q247 55 248 54T255 50T272 48T305 46H336Q342 37 342 35Q342 19 335 5Q330 0 319 0Q316 0 282 1T182 2Q120 2 87 2T51 1Q33 1 33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM645 554Q645 567 643 575T634 597T609 619T560 635Q553 636 480 637Q463 637 445 637T416 636T404 636Q391 635 386 627Q384 621 367 550T332 412T314 344Q314 342 395 342H407H430Q542 342 590 392Q617 419 631 471T645 554Z"></path></g><g data-mml-node="mi" transform="translate(1511,0)"><path data-c="1D43C" d="M43 1Q26 1 26 10Q26 12 29 24Q34 43 39 45Q42 46 54 46H60Q120 46 136 53Q137 53 138 54Q143 56 149 77T198 273Q210 318 216 344Q286 624 286 626Q284 630 284 631Q274 637 213 637H193Q184 643 189 662Q193 677 195 680T209 683H213Q285 681 359 681Q481 681 487 683H497Q504 676 504 672T501 655T494 639Q491 637 471 637Q440 637 407 634Q393 631 388 623Q381 609 337 432Q326 385 315 341Q245 65 245 59Q245 52 255 50T307 46H339Q345 38 345 37T342 19Q338 6 332 0H316Q279 2 179 2Q143 2 113 2T65 2T43 1Z"></path></g><g data-mml-node="mo" transform="translate(2237.2,0)"><path data-c="D7" d="M630 29Q630 9 609 9Q604 9 587 25T493 118L389 222L284 117Q178 13 175 11Q171 9 168 9Q160 9 154 15T147 29Q147 36 161 51T255 146L359 250L255 354Q174 435 161 449T147 471Q147 480 153 485T168 490Q173 490 175 489Q178 487 284 383L389 278L493 382Q570 459 587 475T609 491Q630 491 630 471Q630 464 620 453T522 355L418 250L522 145Q606 61 618 48T630 29Z"></path></g><g data-mml-node="mi" transform="translate(3237.4,0)"><path data-c="1D447" d="M40 437Q21 437 21 445Q21 450 37 501T71 602L88 651Q93 669 101 677H569H659Q691 677 697 676T704 667Q704 661 687 553T668 444Q668 437 649 437Q640 437 637 437T631 442L629 445Q629 451 635 490T641 551Q641 586 628 604T573 629Q568 630 515 631Q469 631 457 630T439 622Q438 621 368 343T298 60Q298 48 386 46Q418 46 427 45T436 36Q436 31 433 22Q429 4 424 1L422 0Q419 0 415 0Q410 0 363 1T228 2Q99 2 64 0H49Q43 6 43 9T45 27Q49 40 55 46H83H94Q174 46 189 55Q190 56 191 56Q196 59 201 76T241 233Q258 301 269 344Q339 619 339 625Q339 630 310 630H279Q212 630 191 624Q146 614 121 583T67 467Q60 445 57 441T43 437H40Z"></path></g></g><rect width="4141.4" height="60" x="120" y="220"></rect></g><g data-mml-node="mo" transform="translate(12732.3,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path></g><g data-mml-node="mi" transform="translate(13788.1,0)"><path data-c="1D43C" d="M43 1Q26 1 26 10Q26 12 29 24Q34 43 39 45Q42 46 54 46H60Q120 46 136 53Q137 53 138 54Q143 56 149 77T198 273Q210 318 216 344Q286 624 286 626Q284 630 284 631Q274 637 213 637H193Q184 643 189 662Q193 677 195 680T209 683H213Q285 681 359 681Q481 681 487 683H497Q504 676 504 672T501 655T494 639Q491 637 471 637Q440 637 407 634Q393 631 388 623Q381 609 337 432Q326 385 315 341Q245 65 245 59Q245 52 255 50T307 46H339Q345 38 345 37T342 19Q338 6 332 0H316Q279 2 179 2Q143 2 113 2T65 2T43 1Z"></path></g><g data-mml-node="mi" transform="translate(14292.1,0)"><path data-c="1D443" d="M287 628Q287 635 230 637Q206 637 199 638T192 648Q192 649 194 659Q200 679 203 681T397 683Q587 682 600 680Q664 669 707 631T751 530Q751 453 685 389Q616 321 507 303Q500 302 402 301H307L277 182Q247 66 247 59Q247 55 248 54T255 50T272 48T305 46H336Q342 37 342 35Q342 19 335 5Q330 0 319 0Q316 0 282 1T182 2Q120 2 87 2T51 1Q33 1 33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM645 554Q645 567 643 575T634 597T609 619T560 635Q553 636 480 637Q463 637 445 637T416 636T404 636Q391 635 386 627Q384 621 367 550T332 412T314 344Q314 342 395 342H407H430Q542 342 590 392Q617 419 631 471T645 554Z"></path></g><g data-mml-node="mi" transform="translate(15043.1,0)"><path data-c="1D436" d="M50 252Q50 367 117 473T286 641T490 704Q580 704 633 653Q642 643 648 636T656 626L657 623Q660 623 684 649Q691 655 699 663T715 679T725 690L740 705H746Q760 705 760 698Q760 694 728 561Q692 422 692 421Q690 416 687 415T669 413H653Q647 419 647 422Q647 423 648 429T650 449T651 481Q651 552 619 605T510 659Q484 659 454 652T382 628T299 572T226 479Q194 422 175 346T156 222Q156 108 232 58Q280 24 350 24Q441 24 512 92T606 240Q610 253 612 255T628 257Q648 257 648 248Q648 243 647 239Q618 132 523 55T319 -22Q206 -22 128 53T50 252Z"></path></g><g data-mml-node="mo" transform="translate(16025.3,0)"><path data-c="D7" d="M630 29Q630 9 609 9Q604 9 587 25T493 118L389 222L284 117Q178 13 175 11Q171 9 168 9Q160 9 154 15T147 29Q147 36 161 51T255 146L359 250L255 354Q174 435 161 449T147 471Q147 480 153 485T168 490Q173 490 175 489Q178 487 284 383L389 278L493 382Q570 459 587 475T609 491Q630 491 630 471Q630 464 620 453T522 355L418 250L522 145Q606 61 618 48T630 29Z"></path></g><g data-mml-node="mi" transform="translate(17025.6,0)"><path data-c="1D447" d="M40 437Q21 437 21 445Q21 450 37 501T71 602L88 651Q93 669 101 677H569H659Q691 677 697 676T704 667Q704 661 687 553T668 444Q668 437 649 437Q640 437 637 437T631 442L629 445Q629 451 635 490T641 551Q641 586 628 604T573 629Q568 630 515 631Q469 631 457 630T439 622Q438 621 368 343T298 60Q298 48 386 46Q418 46 427 45T436 36Q436 31 433 22Q429 4 424 1L422 0Q419 0 415 0Q410 0 363 1T228 2Q99 2 64 0H49Q43 6 43 9T45 27Q49 40 55 46H83H94Q174 46 189 55Q190 56 191 56Q196 59 201 76T241 233Q258 301 269 344Q339 619 339 625Q339 630 310 630H279Q212 630 191 624Q146 614 121 583T67 467Q60 445 57 441T43 437H40Z"></path></g></g></g></g></svg><svg data-labels="true" preserveAspectRatio="xMaxYMid" viewBox="1278 -1294.5 1 2089"><g data-labels="true" transform="matrix(1 0 0 -1 0 0)"><g data-mml-node="mtd" id="mjx-eqn:6" transform="translate(0,663.5)"><text data-id-align="true"></text><g data-idbox="true" transform="translate(0,-750)"><g data-mml-node="mtext"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path><path data-c="36" d="M42 313Q42 476 123 571T303 666Q372 666 402 630T432 550Q432 525 418 510T379 495Q356 495 341 509T326 548Q326 592 373 601Q351 623 311 626Q240 626 194 566Q147 500 147 364L148 360Q153 366 156 373Q197 433 263 433H267Q313 433 348 414Q372 400 396 374T435 317Q456 268 456 210V192Q456 169 451 149Q440 90 387 34T253 -22Q225 -22 199 -14T143 16T92 75T56 172T42 313ZM257 397Q227 397 205 380T171 335T154 278T148 216Q148 133 160 97T198 39Q222 21 251 21Q302 21 329 59Q342 77 347 104T352 209Q352 289 347 316T329 361Q302 397 257 397Z" transform="translate(389,0)"></path><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z" transform="translate(889,0)"></path></g></g></g></g></svg></g></g></g></g></svg></mjx-container>

<p>这里时钟频率/的单位为MHZ。公式(1-6)就是常说的CPU全性能公式，该公式最早由Intel 提出，从该公式可以看出，计算机性能与指令的CPI和主频有直接的关系，主频越高，MIPS 值越高;CPI越小，MIPS值越高。计算机厂家会通过运行人工合成的指令序列测试峰值 MIPS，通常这些测试指令的 CPI最小日运行时会尽量减少分支跳转和cache缺失。但峰值MIPS和实际负载中的MIPS会存在很大差别该值并不能反映计算机的真实性能。为了解决峰值 MIPS 指标的滥用问题，出现了第三方的基准测试程序，基准测试程序通过在不同的计算机上运行相同的测试程序来比较计算机性能，通常这些测试程序能较好地反映计算机实际应用的工作负载。</p>
</li>
<li>
<p><strong>MFLOPS:</strong></p>
<p>MFLOPS(Milion Floating-Point Operations Per Second)是指计算机每秒执行浮点运算的次数，而不是 MIPS所衡量的每秒执行的指令条数。如某系统的运算速度为2MFLOPS，表示该系统的浮点运算速度为每秒 200万次。更大的单位有GFLOPS、TFLOPS、PFLOPS。MFLOPS不是计算机实际执行程序的速度，而是计算机在理论上能达到的浮点运算处理速度。与 MIPS类似，MFLOPS用程序中浮点运算次数除以程序在特定输入时的执行时间得到:</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>M</mi><mi>F</mi><mi>L</mi><mi>O</mi><mi>P</mi><mi>S</mi><mo>=</mo><mfrac><mrow><mi>I</mi><msub><mi>C</mi><mrow><mi>f</mi><mi>l</mi><mi>o</mi><mi>p</mi><mi>s</mi></mrow></msub></mrow><mrow><msub><mi>T</mi><mrow><mi>c</mi><mi>p</mi><mi>u</mi></mrow></msub><mo>×</mo><mn>1</mn><msup><mn>0</mn><mn>6</mn></msup></mrow></mfrac></mrow><annotation encoding="application/x-tex">MFLOPS = \frac{IC_{flops}}{T_{cpu} \times 10^6}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault" style="margin-right:0.13889em;">F</span><span class="mord mathdefault">L</span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.332438em;vertical-align:-0.972108em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.36033em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">c</span><span class="mord mathdefault mtight">p</span><span class="mord mathdefault mtight">u</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.740108em;"><span style="top:-2.9890000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">6</span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361079999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.10764em;">f</span><span class="mord mathdefault mtight" style="margin-right:0.01968em;">l</span><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight">p</span><span class="mord mathdefault mtight">s</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.972108em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
</li>
<li>
<p><strong>计算机层次结构:</strong></p>
<p>1.多层次结构<br>
现代计算机系统是一个硬件与软件组成的综合体，我们可以把它看成是按功能划分的多级层次结构</p>
<p>2.虚拟机概念<br>
在计算机系统的多层次结构中，除第0、1、2级外，上面四级均为虚拟机。<br>
虚拟计算机是指这个计算机只对该级的观察者存在。对某一层次的观察者来说，他只能是通过该层次的语言来了解和使用计算机，至于下层是如何工作和实现的就不必关心了。简而言之，虚拟计算机即是由软件实现的机器。</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240228164057615.png" alt="image-20240228164057615"></p>
</li>
</ol>
<h2 id="12-选择题"><a class="markdownIt-Anchor" href="#12-选择题"></a> 1.2 选择题</h2>
<p>(1) D (2) C (3) C (4) A</p>
<p>(5) D (6) D</p>
<p>(7)</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi mathvariant="normal">根</mi><mi mathvariant="normal">据</mi><mi mathvariant="normal">公</mi><mi mathvariant="normal">式</mi><mo>:</mo><mi>M</mi><mi>I</mi><mi>P</mi><mi>S</mi><mo>=</mo><mfrac><mi>f</mi><mrow><mi>C</mi><mi>P</mi><mi>I</mi></mrow></mfrac><mspace linebreak="newline"></mspace><mi>M</mi><mi>I</mi><mi>P</mi><mi>S</mi><mo>=</mo><mn>1200</mn><mi>M</mi><mi>H</mi><mi>z</mi><mo>÷</mo><mo stretchy="false">(</mo><mn>50</mn><mi mathvariant="normal">%</mi><mo>×</mo><mn>2</mn><mo>+</mo><mn>20</mn><mi mathvariant="normal">%</mi><mo>×</mo><mn>3</mn><mo>+</mo><mn>10</mn><mi mathvariant="normal">%</mi><mo>×</mo><mn>4</mn><mo>+</mo><mn>20</mn><mi mathvariant="normal">%</mi><mo>×</mo><mn>5</mn><mo stretchy="false">)</mo><mspace linebreak="newline"></mspace><mi>M</mi><mi>I</mi><mi>P</mi><mi>S</mi><mo>=</mo><mn>400</mn></mrow><annotation encoding="application/x-tex">根据公式:MIPS = \frac{f}{CPI}\\
MIPS = 1200MHz \div (50\% \times 2 + 20\% \times 3 + 10\% \times 4 + 20\% \times 5)\\
MIPS = 400
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord cjk_fallback">根</span><span class="mord cjk_fallback">据</span><span class="mord cjk_fallback">公</span><span class="mord cjk_fallback">式</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.0574399999999997em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714399999999998em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.10764em;">f</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord">1</span><span class="mord">2</span><span class="mord">0</span><span class="mord">0</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault" style="margin-right:0.08125em;">H</span><span class="mord mathdefault" style="margin-right:0.04398em;">z</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">÷</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">5</span><span class="mord">0</span><span class="mord">%</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.08333em;"></span><span class="mord">2</span><span class="mord">0</span><span class="mord">%</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">3</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.08333em;"></span><span class="mord">1</span><span class="mord">0</span><span class="mord">%</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">4</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.08333em;"></span><span class="mord">2</span><span class="mord">0</span><span class="mord">%</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">5</span><span class="mclose">)</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">4</span><span class="mord">0</span><span class="mord">0</span></span></span></span></span></p>
<p>选C</p>
<p>(8) D</p>
<p>(9)</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>I</mi><msub><mi>C</mi><mn>1</mn></msub><mo>×</mo><mi>C</mi><mi>P</mi><msub><mi>I</mi><mn>1</mn></msub><mo>=</mo><mn>20</mn><mi>s</mi><mspace linebreak="newline"></mspace><mi mathvariant="normal">优</mi><mi mathvariant="normal">化</mi><mi mathvariant="normal">后</mi><mspace linebreak="newline"></mspace><mi>I</mi><msub><mi>C</mi><mn>2</mn></msub><mo>×</mo><mi>C</mi><mi>P</mi><msub><mi>I</mi><mn>2</mn></msub><mo>=</mo><mn>0.84</mn><mo>×</mo><mo stretchy="false">(</mo><mi>I</mi><msub><mi>C</mi><mn>1</mn></msub><mo>×</mo><mi>C</mi><mi>P</mi><msub><mi>I</mi><mn>1</mn></msub><mo stretchy="false">)</mo><mspace linebreak="newline"></mspace><mn>20</mn><mi>s</mi><mo>×</mo><mn>0.84</mn><mo>=</mo><mn>16.8</mn><mi>s</mi></mrow><annotation encoding="application/x-tex">IC_1 \times CPI_1 = 20s\\
优化后\\
IC_2 \times CPI_2 = 0.84 \times(IC_1 \times CPI_1)\\
20s \times 0.84 = 16.8s
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07847em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">2</span><span class="mord">0</span><span class="mord mathdefault">s</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:0em;vertical-align:0em;"></span><span class="mord cjk_fallback">优</span><span class="mord cjk_fallback">化</span><span class="mord cjk_fallback">后</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07847em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">8</span><span class="mord">4</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07847em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">2</span><span class="mord">0</span><span class="mord mathdefault">s</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">8</span><span class="mord">4</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord">6</span><span class="mord">.</span><span class="mord">8</span><span class="mord mathdefault">s</span></span></span></span></span></p>
<p>选D</p>
<p>(10)</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mfrac><mrow><mn>1.5</mn><mi>G</mi><mi>H</mi><mi>z</mi></mrow><mn>2</mn></mfrac><mo>=</mo><mi>x</mi><mo>×</mo><mfrac><mrow><mn>1.2</mn><mi>G</mi><mi>h</mi><mi>z</mi></mrow><mn>1</mn></mfrac><mspace linebreak="newline"></mspace><mi mathvariant="normal">解</mi><mi mathvariant="normal">得</mi><mi>x</mi><mi mathvariant="normal">的</mi><mi mathvariant="normal">倒</mi><mi mathvariant="normal">数</mi><mi mathvariant="normal">为</mi><mn>1.6</mn></mrow><annotation encoding="application/x-tex">\frac{1.5GHz}{2} = x \times \frac{1.2Ghz}{1}\\
解得x的倒数为1.6
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:2.04633em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.36033em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span><span class="mord">.</span><span class="mord">5</span><span class="mord mathdefault">G</span><span class="mord mathdefault" style="margin-right:0.08125em;">H</span><span class="mord mathdefault" style="margin-right:0.04398em;">z</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.66666em;vertical-align:-0.08333em;"></span><span class="mord mathdefault">x</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:2.05744em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.37144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span><span class="mord">.</span><span class="mord">2</span><span class="mord mathdefault">G</span><span class="mord mathdefault">h</span><span class="mord mathdefault" style="margin-right:0.04398em;">z</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord cjk_fallback">解</span><span class="mord cjk_fallback">得</span><span class="mord mathdefault">x</span><span class="mord cjk_fallback">的</span><span class="mord cjk_fallback">倒</span><span class="mord cjk_fallback">数</span><span class="mord cjk_fallback">为</span><span class="mord">1</span><span class="mord">.</span><span class="mord">6</span></span></span></span></span></p>
<p>选C</p>
<h2 id="13教材15"><a class="markdownIt-Anchor" href="#13教材15"></a> 1.3(教材1.5)</h2>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi mathvariant="normal">由</mi><mi>C</mi><mi>P</mi><mi>I</mi><mo>=</mo><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></munderover><mo stretchy="false">(</mo><mi>C</mi><mi>P</mi><msub><mi>I</mi><mi>i</mi></msub><mo>×</mo><msub><mi>P</mi><mi>i</mi></msub><mo stretchy="false">)</mo><mspace linebreak="newline"></mspace><mspace linebreak="newline"></mspace><mi mathvariant="normal">和</mi><mi>M</mi><mi>I</mi><mi>P</mi><mi>S</mi><mo>=</mo><mfrac><mi>f</mi><mrow><mi>C</mi><mi>P</mi><mi>I</mi></mrow></mfrac><mi mathvariant="normal">得</mi><mspace linebreak="newline"></mspace><mspace linebreak="newline"></mspace><mi>M</mi><mi>I</mi><mi>P</mi><msub><mi>S</mi><mn>1</mn></msub><mo>=</mo><mfrac><mrow><mn>600</mn><mi>M</mi><mi>H</mi><mi>z</mi></mrow><mrow><mn>2</mn><mo>×</mo><mn>0.4</mn><mo>+</mo><mn>3</mn><mo>×</mo><mn>0.2</mn><mo>+</mo><mn>4</mn><mo>×</mo><mn>0.15</mn><mo>+</mo><mn>5</mn><mo>×</mo><mn>0.25</mn></mrow></mfrac><mo>≈</mo><mn>185</mn><mspace linebreak="newline"></mspace><mspace linebreak="newline"></mspace><mi mathvariant="normal">同</mi><mi mathvariant="normal">理</mi><mi>M</mi><mi>I</mi><mi>P</mi><msub><mi>S</mi><mn>2</mn></msub><mo>≈</mo><mn>302</mn></mrow><annotation encoding="application/x-tex">由CPI = \sum_{i=1}^n(CPI_i \times P_i)\\\\
和MIPS = \frac{f}{CPI}得\\\\
MIPS_1 = \frac{600MHz}{2\times0.4 + 3 \times 0.2 + 4 \times 0.15 + 5 \times 0.25} \approx 185\\\\
同理
MIPS_2 \approx 302
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord cjk_fallback">由</span><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.929066em;vertical-align:-1.277669em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6513970000000002em;"><span style="top:-1.872331em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.050005em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3000050000000005em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.277669em;"><span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.07847em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span><span class="mspace newline"></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord cjk_fallback">和</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.0574399999999997em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714399999999998em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.10764em;">f</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord cjk_fallback">得</span></span><span class="mspace newline"></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.05764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.1296600000000003em;vertical-align:-0.7693300000000001em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.36033em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">4</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">3</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">4</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">1</span><span class="mord">5</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">5</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">2</span><span class="mord">5</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">6</span><span class="mord">0</span><span class="mord">0</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault" style="margin-right:0.08125em;">H</span><span class="mord mathdefault" style="margin-right:0.04398em;">z</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.7693300000000001em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≈</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord">8</span><span class="mord">5</span></span><span class="mspace newline"></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord cjk_fallback">同</span><span class="mord cjk_fallback">理</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.05764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≈</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">3</span><span class="mord">0</span><span class="mord">2</span></span></span></span></span></p>
<h2 id="14教材16"><a class="markdownIt-Anchor" href="#14教材16"></a> 1.4(教材1.6)</h2>
<p>(1):</p>
<p>CPI优化前为1.6</p>
<p>CPI优化后为1.75</p>
<p>(2):</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi mathvariant="normal">优</mi><mi mathvariant="normal">化</mi><mi mathvariant="normal">前</mi><mi>M</mi><mi>I</mi><mi>P</mi><mi>S</mi><mo>=</mo><mn>312.5</mn><mspace linebreak="newline"></mspace><mspace linebreak="newline"></mspace><mi mathvariant="normal">优</mi><mi mathvariant="normal">化</mi><mi mathvariant="normal">后</mi><mi>M</mi><mi>I</mi><mi>P</mi><mi>S</mi><mo>≈</mo><mn>285.7</mn></mrow><annotation encoding="application/x-tex">优化前MIPS = 312.5\\\\
优化后MIPS \approx 285.7
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord cjk_fallback">优</span><span class="mord cjk_fallback">化</span><span class="mord cjk_fallback">前</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">3</span><span class="mord">1</span><span class="mord">2</span><span class="mord">.</span><span class="mord">5</span></span><span class="mspace newline"></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord cjk_fallback">优</span><span class="mord cjk_fallback">化</span><span class="mord cjk_fallback">后</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≈</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">2</span><span class="mord">8</span><span class="mord">5</span><span class="mord">.</span><span class="mord">7</span></span></span></span></span></p>
<p>(3):优化后得CPI提升但是MIPS下降，不能通过指标简单地判断计算机性能</p>
<h2 id="15-超级计算机相关检索信息"><a class="markdownIt-Anchor" href="#15-超级计算机相关检索信息"></a> 1.5 超级计算机相关检索信息</h2>
<ol>
<li>
<p><strong>Frontier</strong>（美国）</p>
<ul>
<li><strong>计算能力</strong>：1102.00 PFlop/s</li>
<li><strong>主要构成特点</strong>：Frontier是一台百亿亿次级计算机，由美国橡树岭国家实验室（ORNL）开发。它采用了高性能计算（HPL）和Linpack测试，几乎是第二名系统的三倍。</li>
<li><strong>应用领域</strong>：科学研究、气候模拟、核物理等。</li>
<li><strong>技术实现方式</strong>：采用AMD EPYC处理器和NVIDIA A100 Tensor Core GPU。</li>
</ul>
</li>
<li>
<p><strong>富岳（Fugaku）</strong>（日本）</p>
<ul>
<li><strong>计算能力</strong>：442.01 PFlop/s</li>
<li><strong>主要构成特点</strong>：Fugaku是一台超级计算机，由日本理化学研究所（RIKEN）计算科学中心（R-CCS）开发。它曾连续两年占据榜首。</li>
<li><strong>应用领域</strong>：天气预报、材料科学、医学研究等。</li>
<li><strong>技术实现方式</strong>：采用ARM A64FX处理器和NVIDIA A100 Tensor Core GPU。</li>
</ul>
</li>
<li>
<p><strong>LUMI</strong>（芬兰）</p>
<ul>
<li><strong>计算能力</strong>：309.10 PFlop/s</li>
<li><strong>主要构成特点</strong>：LUMI是欧洲最快的超级计算机，经过一次重大升级，规模增加了一倍。</li>
<li><strong>应用领域</strong>：气候模拟、材料科学、能源研究等。</li>
<li><strong>技术实现方式</strong>：采用AMD EPYC处理器和NVIDIA A100 Tensor Core GPU。</li>
</ul>
</li>
<li>
<p><strong>Leonardo</strong>（意大利）</p>
<ul>
<li><strong>计算能力</strong>：174.70 PFlop/s</li>
<li><strong>主要构成特点</strong>：Leonardo由意大利博洛尼亚EuroHPC/CINECA开发，拥有1463616个内核。</li>
<li><strong>应用领域</strong>：材料科学、生物医学、天气预报等。</li>
<li><strong>技术实现方式</strong>：采用NVIDIA HGX节点和Intel Lake CPU。</li>
</ul>
</li>
<li>
<p><strong>Summit</strong>（美国）</p>
<ul>
<li><strong>计算能力</strong>：148.60 PFlop/s</li>
<li><strong>主要构成特点</strong>：Summit采用IBM Power9处理器和NVIDIA V100 Tensor Core GPU。</li>
<li><strong>应用领域</strong>：人工智能、生物医学、材料科学等。</li>
</ul>
</li>
<li>
<p><strong>Sierra</strong>（美国）</p>
<ul>
<li><strong>计算能力</strong>：94.64 PFlop/s</li>
<li><strong>主要构成特点</strong>：Sierra采用IBM Power9处理器和NVIDIA V100 Tensor Core GPU。</li>
<li><strong>应用领域</strong>：核物理、材料科学、天气模拟等。</li>
</ul>
</li>
<li>
<p><strong>神威太湖之光</strong>（中国）</p>
<ul>
<li><strong>计算能力</strong>：93.01 PFlop/s</li>
<li><strong>主要构成特点</strong>：神威太湖之光由中国国家超级计算无锡中心开发，采用自主研发的SW26010处理器。</li>
<li><strong>应用领域</strong>：气象模拟、地震模拟、材料科学等。</li>
</ul>
</li>
<li>
<p><strong>Perlmutter</strong>（美国）</p>
<ul>
<li><strong>计算能力</strong>：70.87 PFlop/s</li>
<li><strong>主要构成特点</strong>：Perlmutter采用AMD EPYC处理器和NVIDIA A100 Tensor Core GPU。</li>
<li><strong>应用领域</strong>：天文学、宇宙学、粒子物理学等。</li>
</ul>
</li>
<li>
<p><strong>Selene</strong> (美国)：</p>
<ul>
<li>
<p><strong>计算能力</strong>：63.46 PFlop/s</p>
</li>
<li>
<p><strong>主要构成特点</strong>：Selene 基于 NVIDIA 的 DGX SuperPOD 技术构建，由 280 台 DGX A100 服务器组成，共计 272800 个 CPU 和 GPU 计算核心，总内存为 560000GB。</p>
</li>
<li>
<p><strong>应用领域</strong>：Selene 的计算能力被用于自动驾驶汽车、图形渲染、量子化学和基因组学工具等各种领域。</p>
</li>
</ul>
</li>
<li>
<p><strong>天河-2A</strong> (中国):</p>
<ul>
<li>
<p><strong>计算能力</strong>：运算速度为 61.44 PFlop/s。</p>
</li>
<li>
<p><strong>主要构成特点</strong>：天河-2A由 <strong>Intel Xeon Phi 7290</strong> 处理器和 <strong>NVIDIA Tesla P100 GPU</strong> 组成。</p>
</li>
<li>
<p><strong>应用领域</strong>：用于气象模拟、材料科学、生物医学等。</p>
</li>
</ul>
<p>这些超级计算机在不同领域发挥着重要作用，从气象预报到材料科学，再到宇宙学和核能模拟。它们的技术实现方式和构成特点各有不同，但都在推动科学研究和技术创新方面发挥着关键作用。</p>
</li>
</ol>
]]></content>
      <categories>
        <category>校内课程</category>
      </categories>
      <tags>
        <tag>学习</tag>
        <tag>计算机组成原理</tag>
        <tag>作业</tag>
      </tags>
  </entry>
  <entry>
    <title>计算机组成原理第二次作业</title>
    <url>/2024/03/25/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86%E7%AC%AC%E4%BA%8C%E6%AC%A1%E4%BD%9C%E4%B8%9A/</url>
    <content><![CDATA[<h1 id="21-解释下列名词"><a class="markdownIt-Anchor" href="#21-解释下列名词"></a> 2.1 解释下列名词</h1>
<h2 id="真值"><a class="markdownIt-Anchor" href="#真值"></a> 真值</h2>
<p>二进制数与十进制数一样有正负之分。书写时可以用“+”和“_”来表示数据的符号，这种数据书写格式也称为真值。</p>
<h2 id="机器码"><a class="markdownIt-Anchor" href="#机器码"></a> 机器码</h2>
<p>由于数据只有正、负两种符号，因此在计算机中很自然就采用进制的0和1来表示数据的符号，由符号和数值一起编码表示的二进制数称为机器数或机器码。</p>
<h2 id="补码"><a class="markdownIt-Anchor" href="#补码"></a> 补码</h2>
<p>在计算机科学中，补码是一种用于表示整数的二进制编码方式。它的特点是可以使用相同的加法运算处理加法和减法，这使得硬件设计更简单。</p>
<p>补码的定义如下：</p>
<ul>
<li>
<p>对于正数，补码与原码相同（原码就是正常的二进制表示）。</p>
</li>
<li>
<p>对于负数，补码是其绝对值的二进制表示取反（即0变为1，1变为0，这也被称为按位取反或者求补），然后在结果上加1。</p>
</li>
</ul>
<p>例如，假设我们有一个8位的二进制数，我们来看看-1的补码是如何计算的：</p>
<ol>
<li>首先，我们取1的二进制表示（即00000001）。</li>
<li>然后，我们取反，得到11111110。</li>
<li>最后，我们在结果上加1，得到11111111。</li>
</ol>
<p>所以，-1的8位补码表示是11111111。</p>
<p>这种方法的一个优点是没有所谓的“-0”。在一些其他的编码方案中，+0和-0是不同的，但在补码中，它们都被编码为00000000。</p>
<h2 id="定点数"><a class="markdownIt-Anchor" href="#定点数"></a> 定点数</h2>
<p>定点数表示法约定计算机中所有数据的小数点位置固定，其中，将小数点的位置固定在数据的最高数位之前(或符号位之后)的数据表示称为定点小数，而将小数点固定在最低数位之后的数据表示称为定点整数。另外，由于小数点位置固定，因此小数点不必再用符号表示，其位置也无须存储。</p>
<ol>
<li>定点整数</li>
</ol>
<p>设定点小数 x=x<sub>0</sub>x<sub>1</sub>x<sub>2</sub>…x<sub>n</sub>，则其在计算机中的表示形式如下图所示。符号位x用来表示数的正负，小数点的位置是固定的，在计算机中并不用去表示它。x~x是数值的有效部分，也称为尾数;x为最高有效位。在计算机中定点小数主要用于表示浮点数的尾数，并没有高级语言数据类型与之相对应。</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240319081921342.png" alt="image-20240319081921342"></p>
<ol start="2">
<li>定点小数</li>
</ol>
<p>设定点整数x=x<sub>0</sub>x<sub>1</sub>x<sub>2</sub>…x<sub>n</sub>，则其在计算机中的表示形式如图2.4所示。在C语言中char、short、int、long型都属于定点整数。<br>
定点数能表示的数据范围与下列因素有关。<br>
(1)机器字长。字长越长，其表示的数据范围就越大。<br>
(2)所采用的机器数表示方法。通过前面对几种不同机器数的分析可知，补码和移码表示所能表示的数据范围比原码和反码所能表示的数据范围要多一个数。</p>
<ol start="3">
<li>定点数表示范围</li>
</ol>
<p>定点数表示范围中的每一个数都可以对应数轴上的一个刻度，刻度在数轴上是均匀分布的，对于定点整数，最小刻度间距是1，而定点小数则为2"。当数据超出计算机所能表示的数据范围时称为溢出。当数据大于最大正数时，发生正上溢;当数据小于最小负数时，发生负上溢，具体如下图所示。<br>
而定点小数还存在精度的问题，所有不在数轴刻度上的纯小数都超出了定点小数所能表示的精度，无法表示，此时定点小数发生精度溢出，只能采用舍入的方式近似表示。</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240319082227375.png" alt="image-20240319082227375"></p>
<h2 id="浮点数"><a class="markdownIt-Anchor" href="#浮点数"></a> 浮点数</h2>
<p>浮点数是一种用于表示实数（即包含小数部分的数）的计算机编码系统。它是一种科学计数法的形式，用于表示非常大或非常小的数，以及精确到小数点后几位的数。</p>
<p>浮点数由三部分组成：符号位、指数和尾数。在这种表示法中，一个数被表示为：</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mtable width="100%"><mtr><mtd width="50%"></mtd><mtd><mrow><mi>N</mi><mo>=</mo><msup><mn>2</mn><mi>E</mi></msup><mo>×</mo><mi>M</mi><mo>=</mo><msup><mn>2</mn><mrow><mo>±</mo><mi>e</mi></mrow></msup><mo>×</mo><mo stretchy="false">(</mo><mo>±</mo><mn>0.</mn><mi>m</mi><mo stretchy="false">)</mo></mrow></mtd><mtd width="50%"></mtd><mtd><mtext>(1)</mtext></mtd></mtr></mtable><annotation encoding="application/x-tex">N = 2^E \times M = 2^{\pm e} \times (\pm0.m) \tag{1}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">N</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.9746609999999999em;vertical-align:-0.08333em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913309999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.05764em;">E</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.904661em;vertical-align:-0.08333em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.821331em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">±</span><span class="mord mathdefault mtight">e</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">±</span><span class="mord">0</span><span class="mord">.</span><span class="mord mathdefault">m</span><span class="mclose">)</span></span><span class="tag"><span class="strut" style="height:1.1413309999999999em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">(</span><span class="mord"><span class="mord">1</span></span><span class="mord">)</span></span></span></span></span></span></p>
<p>采用这种方法，二进制浮点数可表示成阶码E(Exponent)和尾数M(Mantissa)两部分，其中阶码E是定点整数，而尾数M是定点小数。阶码的位数决定数据表示的范围，阶码的位数越多，能表示的数据范围就越大，而阶码的值决定了小数点的位置;尾数的位数决定数据表示的精度。阶码长度相同时，分配给尾数的数位越多，数据表示的精度就越高。浮点数数据的一般格式如下图所示。注意阶码和尾数均可采用不同的机器码进行表示，对应的浮点数表示范围也会略有不同。</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240319082911150.png" alt="image-20240319082911150"></p>
<h2 id="溢出"><a class="markdownIt-Anchor" href="#溢出"></a> 溢出</h2>
<p>显然当阶码为最大值，尾数为最大值时，浮点数为正数最大值;而当阶码为最小值，尾数为正数最小值时,浮点数为正数最小值,这个值也就是浮点数的最小精度。同理,当阶码为最大值尾数为最小负数时，浮点数为负数最小值;而当阶码为最小值，尾数为负数最大值时，浮点数为负数最大值。<br>
浮点数有效扩大了数据表示范围，但受计算机字长限制，浮点数仍然存在溢出现象。下图所示为浮点数的有效表示范围，图中“负数区域”“正数区域”及“0”是可表示的数据区域。当浮点数绝对值超过正数最大值时发生上溢，左、右两侧分别对应正上溢和负上溢，分别表示正无穷和负无穷;当非0浮点数绝对值小于正数最小值时，发生下溢。若运算结果发生上溢浮点运算器件会显示溢出标志;若运算结果发生下溢，虽然此时数据不能被精确表示，但由于发生下溢时数的绝对值很小，可作为机器0处理。同样，当一个浮点数在正、负数区域中但并不在某个数轴刻度上时，也会出现精度溢出的问题，此时只能用近似数表示。</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240319083047726.png" alt="image-20240319083047726"></p>
<p>浮点数采用阶码和尾数的方式表示，阶码每变化一个刻度，数据就变大一倍，所以浮点数在数轴上的刻度并不是均匀分布的，越往数轴的左右两端，刻度越稀疏，这就是浮点数密度变化。</p>
<h2 id="浮点数规格化"><a class="markdownIt-Anchor" href="#浮点数规格化"></a> 浮点数规格化</h2>
<p>同一浮点数如果采用图 2.6所示的浮点数格式，可能存在多种表示形式，如 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>0.01111</mn><mo>×</mo><msup><mn>2</mn><mn>101</mn></msup></mrow><annotation encoding="application/x-tex">0.01111 \times 2^{101}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">0</span><span class="mord">1</span><span class="mord">1</span><span class="mord">1</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.8141079999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mord mtight">0</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span></span></span></span>还可以表示成 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>0.11110</mn><mo>×</mo><msup><mn>2</mn><mn>100</mn></msup></mrow><annotation encoding="application/x-tex">0.11110 \times 2^{100}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">1</span><span class="mord">1</span><span class="mord">1</span><span class="mord">1</span><span class="mord">0</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.8141079999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mord mtight">0</span><span class="mord mtight">0</span></span></span></span></span></span></span></span></span></span></span></span>​。尾数小数点的位置不同，就会有不同的尾数和阶码组合，这将给浮点数的表示带来麻烦。为了使浮点数的表示形式唯一并进一步提高数据的表示精度，通常要求浮点数在数据表示时对尾数进行规格化处理。所谓规格化处理就是使得尾数真值<strong>最高有效位为1</strong>,也就是<strong>尾数的绝对值</strong>应大于或等于(0.1)<sub>2</sub>或(0.5)<sub>10</sub>。<br>
对于非规格化尾数，需要对其进行规格化操作，即根据具体形式通过将非规格化尾数进行算术左移或右移，并同步减少或增加阶码值的操作进行规格化，对应的规格化方法分别称为左移规格化和右移规格化。<br>
除使尾数真值大于0.5外,还有一种规格化数也经常使用,就是使得尾数绝对值大于1、小于2.这种规格化数参考了十进制科学记数法的表示方法，任意一个十进制数N都可表示为:</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mtable width="100%"><mtr><mtd width="50%"></mtd><mtd><mrow><mi>N</mi><mo>=</mo><mn>1</mn><msup><mn>0</mn><mi>E</mi></msup><mo>×</mo><mi>M</mi><mo stretchy="false">(</mo><mn>1</mn><mo>≤</mo><mo stretchy="false">∣</mo><mi>M</mi><mo stretchy="false">∣</mo><mo>≤</mo><mn>10</mn><mo stretchy="false">)</mo></mrow></mtd><mtd width="50%"></mtd><mtd><mtext>(2)</mtext></mtd></mtr></mtable><annotation encoding="application/x-tex">N = 10^E \times M                     (1 \leq \lvert M \rvert \leq 10)\tag{2}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">N</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.9746609999999999em;vertical-align:-0.08333em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913309999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.05764em;">E</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">∣</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mclose">∣</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mord">0</span><span class="mclose">)</span></span><span class="tag"><span class="strut" style="height:1.1413309999999999em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">(</span><span class="mord"><span class="mord">2</span></span><span class="mord">)</span></span></span></span></span></span></p>
<p>示成如下形式注意尾数绝对值应大<br>
注意十进制科学记数法中尾数绝对值应该大于1、小于10。而任意一个二进制数N也可表示成如下形式</p>
<p>注意尾数<strong>绝对值应该大于1,小于2</strong></p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mtable width="100%"><mtr><mtd width="50%"></mtd><mtd><mrow><mi>N</mi><mo>=</mo><msup><mn>2</mn><mi>E</mi></msup><mo>×</mo><mi>M</mi><mo>=</mo><msup><mn>2</mn><mrow><mo>±</mo><mi>e</mi></mrow></msup><mo>×</mo><mo stretchy="false">(</mo><mo>±</mo><mn>1.</mn><mi>m</mi><mo stretchy="false">)</mo></mrow></mtd><mtd width="50%"></mtd><mtd><mtext>(3)</mtext></mtd></mtr></mtable><annotation encoding="application/x-tex">N = 2^E \times M = 2^{\pm e} \times (\pm1.m) \tag{3}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">N</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.9746609999999999em;vertical-align:-0.08333em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913309999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.05764em;">E</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.904661em;vertical-align:-0.08333em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.821331em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">±</span><span class="mord mathdefault mtight">e</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">±</span><span class="mord">1</span><span class="mord">.</span><span class="mord mathdefault">m</span><span class="mclose">)</span></span><span class="tag"><span class="strut" style="height:1.1413309999999999em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">(</span><span class="mord"><span class="mord">3</span></span><span class="mord">)</span></span></span></span></span></span></p>
<p>大于0.5和大于1的规格化数在本质上没有太大的区别，二者尾数真值最高有效位都是1，在实际表示时可以采用与定点数小数点一样的表示策略，无须单独表示最高有效位上的1，需要进行数据运算时再恢复最高有效位的表示，被隐藏的这一位又称为隐藏位。</p>
<h2 id="模"><a class="markdownIt-Anchor" href="#模"></a> 模</h2>
<p>在数学中，"模"是一种测量或者比较整数的工具。给定两个整数a和b，我们说"a模b"（通常写作a mod b或者a % b）是a除以b后的余数。</p>
<p>例如，17模5等于2，因为17除以5等于3余2。</p>
<p>模运算有许多有用的性质。例如，它是周期性的（即a mod b的值在a增加b的整数倍时不变），并且满足分配律即(a + b) mod c = (a mod c + b mod c) mod c。</p>
<p>在计算机科学中，模运算常常用于将值限制在某个范围内，例如将数组索引限制在数组长度内，或者将角度限制在0到360度之间。</p>
<h2 id="bcd码binary-code-decimal"><a class="markdownIt-Anchor" href="#bcd码binary-code-decimal"></a> BCD码(Binary Code Decimal)</h2>
<p><strong>BCD</strong>码编码较为简单，用4位二进制数表示09这10个数，由于4位二进制数能表示16种不同状态，因此需要从中选取10种来表示十进制数0~9，选取的方法有多种，常见的有8421码、2421 码、余3码等。</p>
<ul>
<li>
<p>8421码是一种有权编码，即表示十进制数的4位二进制数码的每一位都有确定的权值。其从高位到低位的权值分别为8、4、2、1，故称为8421码。</p>
<p>8421码编码简单，0000~ 1001分别表示十进制的09，这10个4位二进制数按权展开后相加的值正好分别对应0~9。其余6种编码为非法编码。</p>
</li>
<li>
<p>2421码则是另外一种有权编码，其4位二进制数的权值从左到右依次是 2、4、2、1。需要关注的是 2421码不具有单值性，即从权值考虑，1011和0101都可表示十进制数5，为了避免不-致性，2421码规定不用0101~1010这6个编码。另外，2421码编码具有自补的特点，即各位取反后正好为该数对9的补码。</p>
</li>
<li>
<p>余3码是通过对 8421码的每个数码加3形成的一种无权编码。</p>
</li>
</ul>
<p>这3种编码在进行算术运算时都需要进行结果的校正，运算器相对比较复杂。</p>
<ul>
<li>对8421码实现算术运算时，如果两数之和大于10，则运算结果需要加6修正，并向高位进位;</li>
<li>-2421码运算对结果的修正问题比 8421码更为复杂;</li>
<li>余3码进行加法时如不产生进位，则运算结果需要减 3:若产生进位，则将进位送入高位，当前位加3校正。</li>
</ul>
<h2 id="机内码"><a class="markdownIt-Anchor" href="#机内码"></a> 机内码</h2>
<p>机内码，也被称为内码或者原码，是计算机系统内部使用的字符编码。它通常是为了满足特定系统或应用的需要而设计的，可能与其他系统或应用使用的编码不同。</p>
<p>在计算机中，所有的信息最终都是以二进制的形式存储的。机内码就是将字符（包括字母、数字、符号等）转换为二进制形式的规则。</p>
<p>例如，ASCII（美国标准信息交换码）就是一种广泛使用的机内码，它使用7位二进制数来表示128个不同的字符。在ASCII中，大写字母A的机内码是65（或者二进制的1000001），小写字母a的机内码是97（或者二进制的1100001）。</p>
<p>请注意，机内码通常是特定于某个系统或应用的，不同的系统或应用可能会使用不同的机内码。</p>
<h2 id="字形码"><a class="markdownIt-Anchor" href="#字形码"></a> 字形码</h2>
<p>字形码是一种用于表示字符形状（字形）的编码系统。在计算机字体中，每个字符都有一个唯一的字形码，用于指定该字符的视觉表示。</p>
<p>字形码通常与字符编码（如ASCII或Unicode）分开处理。字符编码只是字符的抽象表示，而字形码则是字符在屏幕或打印机上的具体表示。</p>
<p>例如，Unicode字符U+0061（小写字母'a'）可能有多个不同的字形，取决于字体。在一种字体中，'a'可能被表示为一个带有尾部的圆圈，而在另一种字体中，'a'可能被表示为一个没有尾部的圆圈。尽管这两个字形看起来不同，但它们都表示同一个字符，并且都有同一个Unicode字符编码（U+0061）。然而，它们的字形码将是不同的，因为字形码是用来指定字符的具体视觉表示的。</p>
<h2 id="字库"><a class="markdownIt-Anchor" href="#字库"></a> 字库</h2>
<p>字库是一种计算机文件，它包含了一套字符或符号的图形表示。这些图形表示被称为字形。每个字形对应一个字符编码，这样计算机就可以根据字符编码找到对应的字形，并在屏幕或打印机上显示出来。</p>
<p>字库通常用于存储特定字体的所有字符。例如，一个字库可能包含所有的拉丁字母、数字、标点符号，以及其他特殊字符。字库也可以包含其他语言的字符，例如汉字、日文假名和片假名、阿拉伯字母等。</p>
<p>在计算机中，字库通常以字体文件的形式存在。常见的字体文件格式包括TrueType（.ttf）、OpenType（.otf）、PostScript Type 1等。这些文件不仅包含字形，还包含字符间距、行高、字体样式等信息。</p>
<h2 id="码距"><a class="markdownIt-Anchor" href="#码距"></a> 码距</h2>
<p>在信息编码中，两个编码对应二进制位不同的个数称为<strong>码距</strong>，又称<strong>海明距离</strong>。</p>
<blockquote>
<p>如10101和00110从第一位开始依次有第1位、第4位、第5位等3位不同，则码距为3。</p>
</blockquote>
<p>一个有效编码集中，任意两个码字的最小码距称为该编码集的码距。校验码的目的就是扩大码距，从而通过编码规则来识别错误代码。码距越大，抗干扰能力、纠错能力越强，数据冗余越大，编码效率越低选择码距时应考虑信息出错概率、系统容错率以及硬件开销等因素。</p>
<h2 id="校验码"><a class="markdownIt-Anchor" href="#校验码"></a> 校验码</h2>
<p>校验码是一种用于检测数据传输或存储过程中是否发生错误的技术。它通常是通过对数据应用某种算法，然后生成一个简短的数字或字符序列（即校验码）来实现的。在数据接收或读取时，会再次计算校验码，并与原始的校验码进行比较，以检测是否有错误发生。</p>
<p>校验码的一种常见形式是奇偶校验，它通过计算数据中的位数来检测单个位错误。另一种常见的形式是循环冗余校验（CRC），以及海明码，它可以检测更复杂的错误。</p>
<p>请注意，虽然校验码可以检测错误，但它们通常不能纠正错误。对于需要错误纠正的应用，通常会使用更复杂的技术，如前向纠错或纠错码。</p>
<h2 id="海明校验码"><a class="markdownIt-Anchor" href="#海明校验码"></a> 海明校验码</h2>
<p>海明校验码是一种错误检测和纠正的方法，由理查德·海明在1950年代提出。它可以检测到多位错误，并且能够自动纠正单位错误。<br>
设海明校验码H<sub>n</sub>……H<sub>2</sub>H<sub>1</sub>共n位，包含原始信息D<sub>k</sub>…D<sub>2</sub>D<sub>1</sub>共k位，称为(n，k)码，校验位分别是P<sub>r</sub>…P<sub>2</sub>P<sub>1</sub>，包含r个偶校验组，n=k+r。每个原始数据位至少位于两个以上的校验组。每个校验组的r位检错信息构成一个检错码G<sub>r</sub>…G<sub>2</sub>G<sub>1</sub>假定0值表示无错，其他值表示海明码1位错的出错位置，则检错码可指出 2<sup>r</sup>-1种一位错。为了能指出n位海明编码中的所有一位错，"n、k、r"间应满足如下关系:</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mtable width="100%"><mtr><mtd width="50%"></mtd><mtd><mrow><mi>n</mi><mo>=</mo><mi>k</mi><mo>+</mo><mi>r</mi><mo>≤</mo><msup><mn>2</mn><mrow><mi>r</mi><mo>−</mo><mn>1</mn></mrow></msup></mrow></mtd><mtd width="50%"></mtd><mtd><mtext>(4)</mtext></mtd></mtr></mtable><annotation encoding="application/x-tex">n = k + r\leq2^{r-1} \tag{4}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">n</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.77777em;vertical-align:-0.08333em;"></span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.7719400000000001em;vertical-align:-0.13597em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.864108em;vertical-align:0em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.864108em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.02778em;">r</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span></span><span class="tag"><span class="strut" style="height:1.1141079999999999em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">(</span><span class="mord"><span class="mord">4</span></span><span class="mord">)</span></span></span></span></span></span></p>
<p>海明校验码广泛应用于计算机内存、数据传输等领域，用于提高数据的可靠性。</p>
<p>根据海明码规则本人编写如下代码生成海明码</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> math</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">generate_parity_code</span>(<span class="params">data, parity=<span class="string">'even'</span></span>):</span><br><span class="line">    <span class="comment"># 计算数据中1的个数</span></span><br><span class="line">    count = data.count(<span class="string">'1'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 如果选择的是偶校验，并且1的个数是奇数，或者选择的是奇校验，并且1的个数是偶数，那么校验位为1</span></span><br><span class="line">    <span class="keyword">if</span> (parity == <span class="string">'even'</span> <span class="keyword">and</span> count % <span class="number">2</span> != <span class="number">0</span>) <span class="keyword">or</span> (parity == <span class="string">'odd'</span> <span class="keyword">and</span> count % <span class="number">2</span> == <span class="number">0</span>):</span><br><span class="line">        data += <span class="string">'1'</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        data += <span class="string">'0'</span></span><br><span class="line">    <span class="keyword">return</span> data</span><br><span class="line"><span class="comment"># 汉明码</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">generate_hamming_code</span>(<span class="params">k:<span class="built_in">int</span></span>):</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">64</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="number">2</span> ** (i - <span class="number">1</span>) &gt;= k + i:</span><br><span class="line">            binary = i</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        i += <span class="number">1</span></span><br><span class="line">    result = [] <span class="comment"># list[str]</span></span><br><span class="line">    <span class="comment"># 校验位</span></span><br><span class="line">    P = []</span><br><span class="line">    <span class="comment"># 校验位位置</span></span><br><span class="line">    P_index = []</span><br><span class="line">    <span class="comment"># 数据位</span></span><br><span class="line">    D = []</span><br><span class="line">    <span class="comment"># 数据位位置</span></span><br><span class="line">    D_index = []</span><br><span class="line">    <span class="comment"># 校验位的码距</span></span><br><span class="line">    D_cnt = {<span class="string">"D"</span> + <span class="built_in">str</span>(i):<span class="number">0</span> <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,k+<span class="number">1</span>)}</span><br><span class="line">    <span class="comment"># 校验码生成结果字典</span></span><br><span class="line">    P_result = {<span class="string">"P"</span> + <span class="built_in">str</span>(i):[] <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,binary + <span class="number">1</span>)}</span><br><span class="line">    <span class="comment"># 定义海明码类,内容包括数据位,二进制形式,校验位计算,校验位组</span></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">hamming_code</span>:</span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, data,binary_format,bit_verification_calculation,check_bit_group</span>):</span><br><span class="line">            self.data = data</span><br><span class="line">            self.binary_format = binary_format</span><br><span class="line">            self.bit_verification_calculation = bit_verification_calculation</span><br><span class="line">            self.check_bit_group = check_bit_group</span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">__str__</span>(<span class="params">self</span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">f"数据位:<span class="subst">{self.data}</span> 二进制形式:<span class="subst">{self.binary_format}</span> 校验位计算:<span class="subst">{self.bit_verification_calculation}</span> 校验位组:<span class="subst">{self.check_bit_group}</span>"</span></span><br><span class="line">    <span class="comment"># 生成校验位</span></span><br><span class="line">    P = [(<span class="string">"P"</span> + <span class="built_in">str</span>(i + <span class="number">1</span>)) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(binary)]</span><br><span class="line">    <span class="comment"># 生成数据位</span></span><br><span class="line">    D = [(<span class="string">"D"</span> + <span class="built_in">str</span>(i + <span class="number">1</span>)) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(k)]</span><br><span class="line">    j = <span class="number">0</span></span><br><span class="line">    o = <span class="number">0</span></span><br><span class="line">    <span class="comment"># 生成海明码</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, k + binary):</span><br><span class="line">        <span class="keyword">if</span> i == <span class="number">2</span> ** j:</span><br><span class="line">            result.append(P[j])</span><br><span class="line">            P_index.append(i)</span><br><span class="line">            j += <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            result.append(D[o])</span><br><span class="line">            D_index.append(i)</span><br><span class="line">            o += <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> j &lt; <span class="built_in">len</span>(P):</span><br><span class="line">        result.append(P[j])</span><br><span class="line">        P_index.append(<span class="built_in">len</span>(result))</span><br><span class="line">    <span class="comment"># 反转结果使得其便于查看</span></span><br><span class="line">    result.reverse()</span><br><span class="line">    f = <span class="built_in">open</span>(<span class="string">"汉明码.md"</span>, <span class="string">"a"</span>,encoding=<span class="string">"UTF-8"</span>)</span><br><span class="line">    <span class="comment"># 清除原有内容</span></span><br><span class="line">    f.truncate(<span class="number">0</span>)</span><br><span class="line">    f.write(<span class="string">"**汉明码:**"</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(result)-<span class="number">2</span>):</span><br><span class="line">        <span class="keyword">if</span> result[i][<span class="number">0</span>] == <span class="string">"P"</span>:</span><br><span class="line">            f.write(<span class="string">"`"</span> + result[i] + <span class="string">"`"</span>) </span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            f.write(result[i])</span><br><span class="line">    f.write(<span class="string">"`P2P1`"</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"汉明码："</span>, result)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"数据位位置："</span>, D_index)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"校验位位置："</span>, P_index)</span><br><span class="line">    <span class="comment"># 再次反转适合处理</span></span><br><span class="line">    result.reverse()</span><br><span class="line">    hamming_code_result = []</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 生成海明码内容类的相关数据</span></span><br><span class="line">    <span class="comment"># 数值最大值,保证码距相等</span></span><br><span class="line">    D_max = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> D_index:</span><br><span class="line">        <span class="comment"># 获取反转后的二进制形式</span></span><br><span class="line">        data_binary = <span class="built_in">bin</span>(i)[:<span class="number">1</span>:-<span class="number">1</span>]</span><br><span class="line">        tmp_calculate = []</span><br><span class="line">        check_bit_group = []</span><br><span class="line">        tmp_calculate.append(<span class="built_in">str</span>(i) + <span class="string">" = "</span>)</span><br><span class="line">        <span class="keyword">for</span> t <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(data_binary)):</span><br><span class="line">            <span class="keyword">if</span> data_binary[t] == <span class="string">'1'</span>:</span><br><span class="line">                <span class="comment"># 获取二进制位的校验位计算</span></span><br><span class="line">                <span class="keyword">if</span> <span class="built_in">len</span>(tmp_calculate) == <span class="number">1</span>:</span><br><span class="line">                    tmp_calculate.append(<span class="built_in">str</span>(<span class="number">2</span> ** t))</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    tmp_calculate.append(<span class="string">" + "</span>+<span class="built_in">str</span>(<span class="number">2</span> ** t))</span><br><span class="line">                P_result[<span class="string">"P"</span> + <span class="built_in">str</span>(t + <span class="number">1</span>)].append(result[i-<span class="number">1</span>])</span><br><span class="line">                check_bit_group.append(result[<span class="number">2</span> ** t - <span class="number">1</span>])</span><br><span class="line">                <span class="comment"># 统计数据位出现次数</span></span><br><span class="line">                D_cnt[result[i-<span class="number">1</span>]] += <span class="number">1</span></span><br><span class="line">                D_max = <span class="built_in">max</span>(D_max,D_cnt[result[i-<span class="number">1</span>]])</span><br><span class="line">        tmp_hamming_code = hamming_code(result[i-<span class="number">1</span>],data_binary[::-<span class="number">1</span>],tmp_calculate,check_bit_group)</span><br><span class="line">        hamming_code_result.append(tmp_hamming_code)</span><br><span class="line">    <span class="comment"># 输出汉明码结果类的相关信息</span></span><br><span class="line">    <span class="comment"># 有数据位,二进制形式,校验位计算,校验位组</span></span><br><span class="line">    f.write(<span class="string">"\n| 数据位 | 二进制形式 | 校验位计算 | 校验位组 |\n| :----: | :--------: | :--------: | :------: |"</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> hamming_code_result:</span><br><span class="line">        <span class="built_in">print</span>(i)</span><br><span class="line">        <span class="keyword">if</span>(i.binary_format.count(<span class="string">'1'</span>) &lt; binary):</span><br><span class="line">            i.binary_format = <span class="string">"0"</span> * (binary - <span class="built_in">len</span>(i.binary_format) -<span class="number">1</span>) + i.binary_format</span><br><span class="line">        f.write(<span class="string">f"\n| <span class="subst">{i.data}</span> | <span class="subst">{i.binary_format}</span> | <span class="subst">{<span class="string">''</span>.join(i.bit_verification_calculation)}</span> | <span class="subst">{<span class="string">','</span>.join(i.check_bit_group)}</span> |"</span>)</span><br><span class="line">    <span class="comment"># 输出校验位的生成部分,确认是否正确</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> P_result:</span><br><span class="line">        <span class="built_in">print</span>(i, <span class="string">":"</span>, P_result[i])</span><br><span class="line">    <span class="keyword">if</span> P_result[result[-<span class="number">1</span>]] == []:</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> D_cnt.keys():</span><br><span class="line">            <span class="comment"># 不符合最大码距的数据位添加到校验位的生成部分</span></span><br><span class="line">            <span class="keyword">if</span> D_cnt[i] != D_max:</span><br><span class="line">                P_result[result[-<span class="number">1</span>]].append(i)</span><br><span class="line">        P_result[result[-<span class="number">1</span>]].sort()</span><br><span class="line">    <span class="comment"># 输出latex的校验码</span></span><br><span class="line">    f.write(<span class="string">"\n\n$$\n"</span>)</span><br><span class="line">    <span class="comment"># 校验位的形成部分打印</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> P_result:</span><br><span class="line">        f.write(<span class="string">"\\\\"</span>)</span><br><span class="line">        <span class="built_in">print</span>(i, <span class="string">":"</span>, P_result[i])</span><br><span class="line">        P_result[i].sort(key = <span class="keyword">lambda</span> x: <span class="built_in">int</span>(x[<span class="number">1</span>:]))</span><br><span class="line">        <span class="keyword">for</span> l <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(P_result[i])):</span><br><span class="line">            <span class="keyword">if</span> l != <span class="number">0</span>:</span><br><span class="line">                f.write(<span class="string">f"\\oplus <span class="subst">{P_result[i][l]}</span>"</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                f.write(<span class="string">f"<span class="subst">{i}</span> = <span class="subst">{P_result[i][l]}</span>"</span>)</span><br><span class="line">    f.write(<span class="string">"\n$$\n"</span>)</span><br><span class="line">    <span class="comment"># 输出latex的校验码</span></span><br><span class="line">    f.write(<span class="string">"# 校验\n"</span>)</span><br><span class="line">    f.write(<span class="string">"\n$$\n"</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> P_result:</span><br><span class="line">        f.write(<span class="string">"\\\\"</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"S"</span> + i[<span class="number">1</span>:], <span class="string">":"</span>, P_result[i])</span><br><span class="line">        <span class="keyword">for</span> l <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(P_result[i])):</span><br><span class="line">            <span class="keyword">if</span> l != <span class="number">0</span>:</span><br><span class="line">                f.write(<span class="string">f"\\oplus <span class="subst">{P_result[i][l]}</span>"</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                f.write(<span class="string">f"S<span class="subst">{i[<span class="number">1</span>:]}</span> = <span class="subst">{i}</span> \\oplus <span class="subst">{P_result[i][l]}</span>"</span>)</span><br><span class="line">    f.write(<span class="string">"\n$$\n"</span>)</span><br><span class="line">    f.close()</span><br><span class="line">generate_hamming_code(<span class="number">8</span>)</span><br></pre></td></tr></table></figure>
<p>修改<code>generate_hamming_code(x)</code>中的参数即可生成对应海明码的md文件</p>
<p>效果如下</p>
<img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240319090631229.png" alt="image-20240319090631229" style="zoom:50%;">
<h2 id="crc码"><a class="markdownIt-Anchor" href="#crc码"></a> CRC码</h2>
<p>循环几余校验(Cyclic Redundancy Check，CRC)是一种基于模2运算建立编码规则的校验码，在磁存储和计算机通信方面应用广泛。</p>
<p>设CRC码长度共n位,其中原始数据信息为C<sub>k-1</sub>C<sub>k-2</sub>…C<sub>1</sub>C<sub>0</sub>共k位,校验位P<sub>r-1</sub>P<sub>r-2</sub>…P<sub>0</sub>共r位，称为(n，k)码，则CRC码为C<sub>k-1</sub>C<sub>k-2</sub>……C<sub>0</sub>P<sub>r-1</sub>P<sub>r-2</sub>……P<sub>0</sub>。和海明码一样，CRC码也需要满足如下关系式:</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mtable width="100%"><mtr><mtd width="50%"></mtd><mtd><mrow><mi>n</mi><mo>=</mo><mi>k</mi><mo>+</mo><mi>r</mi><mo>≤</mo><msup><mn>2</mn><mrow><mi>r</mi><mo>−</mo><mn>1</mn></mrow></msup></mrow></mtd><mtd width="50%"></mtd><mtd><mtext>(5)</mtext></mtd></mtr></mtable><annotation encoding="application/x-tex">n = k + r\leq2^{r-1} \tag{5}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">n</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.77777em;vertical-align:-0.08333em;"></span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.7719400000000001em;vertical-align:-0.13597em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.864108em;vertical-align:0em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.864108em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.02778em;">r</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span></span><span class="tag"><span class="strut" style="height:1.1141079999999999em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">(</span><span class="mord"><span class="mord">5</span></span><span class="mord">)</span></span></span></span></span></span></p>
<p>根据CRC码编码规则本人写出如下代码:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># CRC码</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">calculate_crc</span>(<span class="params">data, divisor</span>):</span><br><span class="line">    <span class="comment"># 获取移位位数</span></span><br><span class="line">    shift_bits = <span class="built_in">len</span>(divisor) - divisor.find(<span class="string">'1'</span>) -<span class="number">1</span></span><br><span class="line">    <span class="comment"># 将数据和除数转换为列表，以便进行操作</span></span><br><span class="line">    data = <span class="built_in">list</span>(<span class="built_in">map</span>(<span class="built_in">int</span>, data))</span><br><span class="line">    data = data + [<span class="number">0</span>] * (<span class="built_in">len</span>(divisor) - <span class="number">1</span>)</span><br><span class="line">    <span class="comment"># 保存原始数据，以便最后生成CRC码</span></span><br><span class="line">    original_data = data.copy()</span><br><span class="line">    divisor = <span class="built_in">list</span>(<span class="built_in">map</span>(<span class="built_in">int</span>, divisor))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 执行除法操作</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(data) - <span class="built_in">len</span>(divisor) + <span class="number">1</span>):</span><br><span class="line">        <span class="keyword">if</span> data[i] == <span class="number">1</span>:</span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(divisor)):</span><br><span class="line">                data[i+j] ^= divisor[j]</span><br><span class="line">    <span class="comment"># 生成CRC码</span></span><br><span class="line">    crc_code = <span class="string">''</span>.join(<span class="built_in">map</span>(<span class="built_in">str</span>, data[-(<span class="built_in">len</span>(divisor)-<span class="number">1</span>):]))</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(crc_code)):</span><br><span class="line">        j = <span class="built_in">int</span>(crc_code[i])</span><br><span class="line">        <span class="keyword">if</span> j == <span class="number">1</span>:</span><br><span class="line">            original_data[<span class="built_in">len</span>(data) - (<span class="built_in">len</span>(crc_code) - i)] = <span class="number">1</span></span><br><span class="line">    <span class="built_in">print</span>(*original_data)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"CRC码:"</span>, crc_code)</span><br><span class="line">    <span class="keyword">return</span> original_data</span><br><span class="line"><span class="built_in">print</span>(*calculate_crc(<span class="string">'1100'</span>, <span class="string">'1011'</span>)) <span class="comment">#输出1 1 0 0 0 1 0</span></span><br></pre></td></tr></table></figure>
<h1 id="22-选择题"><a class="markdownIt-Anchor" href="#22-选择题"></a> 2.2 选择题</h1>
<ol>
<li>
<p>可以组成<code>10000011</code>，原码是<code>10000011</code>即-125，选<code>B</code></p>
</li>
<li>
<p>无符号65535二进制形式为<code>1111111111111111</code>,若转换为带符号数则为变为<code>-1</code>，选<code>A</code></p>
</li>
<li>
<p><code>short</code>表明应该是八位,<code>65530</code>对应十六进制表示<code>0000 FFFAH</code>,选<code>B</code></p>
</li>
<li>
<p><code>short</code>类型的<code>-32767</code>转换为二进制为<code>1000000000000001</code>，对应<code>unsigned short</code>为<code>32769</code>,选<code>D</code></p>
</li>
<li>
<p>在IEEE 754标准中，一个浮点数被表示为三部分：符号位、指数位和尾数位。</p>
<p>对于单精度（32位）浮点数：</p>
<ul>
<li>符号位：1位，表示正负，0为正，1为负。</li>
<li>指数位：8位，偏移量为127。</li>
<li>尾数位：23位，表示小数部分。</li>
</ul>
<p>对于<code>-8.25</code>：</p>
<ul>
<li>符号位：因为是负数，所以符号位为1。</li>
<li>指数位：8的二进制表示为<code>1000</code>，所以指数为3。加上偏移量127，得到130，即<code>10000010</code>。</li>
<li>尾数位：0.25的二进制表示为<code>01</code>，规格化后尾数为<code>00001000000000000000000000</code>。</li>
</ul>
<p>所以，<code>-8.25</code>的IEEE 754单精度浮点数表示为：<code>'1 10000010 000010000000000000000000'</code></p>
<p>转换为16进制即为: <code>C1040000</code></p>
<p>选<code>A</code></p>
</li>
<li>
<p><code>C6400000H</code>二进制表示为<code>11000110010000000000000000000000</code></p>
</li>
</ol>
<ul>
<li>
<p>符号位: 为<code>1</code>,所以是负数</p>
</li>
<li>
<p>指数位: <code>10001100</code>减去偏移量<code>127</code>得到十进制为<code>13</code></p>
</li>
<li>
<p>尾数位: <code>10000000000000000000000</code>,得到<code>0.5</code></p>
<p>规格化后得<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>−</mo><mn>1.5</mn><mo>×</mo><msup><mn>2</mn><mn>13</mn></msup></mrow><annotation encoding="application/x-tex">-1.5 \times 2^{13}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">−</span><span class="mord">1</span><span class="mord">.</span><span class="mord">5</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.8141079999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mord mtight">3</span></span></span></span></span></span></span></span></span></span></span></span></p>
<p>选<code>A</code></p>
</li>
</ul>
<ol start="7">
<li>
<p>IEEE754单精度浮点格式表示的最大整数二进制形式为<code>01111111111111111111111111111111</code></p>
<p>换算过来是<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msup><mn>2</mn><mn>127</mn></msup><mo>×</mo><mo stretchy="false">(</mo><mn>2</mn><mo>−</mo><msup><mn>2</mn><mrow><mo>−</mo><mn>23</mn></mrow></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">2^{127} \times (2  - 2^{-23})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.897438em;vertical-align:-0.08333em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mord mtight">2</span><span class="mord mtight">7</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.064108em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">2</span><span class="mord mtight">3</span></span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></p>
<p>即<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msup><mn>2</mn><mn>128</mn></msup><mo>−</mo><msup><mn>2</mn><mn>104</mn></msup></mrow><annotation encoding="application/x-tex">2^{128} - 2^{104}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.897438em;vertical-align:-0.08333em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mord mtight">2</span><span class="mord mtight">8</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.8141079999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mord mtight">0</span><span class="mord mtight">4</span></span></span></span></span></span></span></span></span></span></span></span>​</p>
<p>选<code>D</code></p>
</li>
<li>
<p>取如下值</p>
</li>
</ol>
<ul>
<li>
<p>符号位: 0</p>
</li>
<li>
<p>指数位: 1</p>
</li>
<li>
<p>尾数位: 0</p>
<p>此时可以得到规格化最小值2<sup>-126</sup></p>
<p>选<code>A</code></p>
</li>
</ul>
<ol start="9">
<li>
<p><code>x</code>转换为二进制形式为<code>11001100100100000000000000000000</code>,对应规格化浮点数为<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>−</mo><mn>1.125</mn><mo>×</mo><msup><mn>2</mn><mn>25</mn></msup></mrow><annotation encoding="application/x-tex">-1.125 \times 2^{25}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">−</span><span class="mord">1</span><span class="mord">.</span><span class="mord">1</span><span class="mord">2</span><span class="mord">5</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.8141079999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mord mtight">5</span></span></span></span></span></span></span></span></span></span></span></span><br>
<code>y</code>转换为二进制形式为<code>10110000110000000000000000000000</code>,对应规格化浮点数为<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>−</mo><mn>1.5</mn><mo>×</mo><msup><mn>2</mn><mrow><mo>−</mo><mn>30</mn></mrow></msup></mrow><annotation encoding="application/x-tex">-1.5\times 2^{-30}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">−</span><span class="mord">1</span><span class="mord">.</span><span class="mord">5</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.8141079999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">3</span><span class="mord mtight">0</span></span></span></span></span></span></span></span></span></span></span></span>​</p>
<p>可以看出<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.464ex;" xmlns="http://www.w3.org/2000/svg" width="7.18ex" height="1.686ex" role="img" focusable="false" viewBox="0 -540 3173.6 745"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D466" d="M21 287Q21 301 36 335T84 406T158 442Q199 442 224 419T250 355Q248 336 247 334Q247 331 231 288T198 191T182 105Q182 62 196 45T238 27Q261 27 281 38T312 61T339 94Q339 95 344 114T358 173T377 247Q415 397 419 404Q432 431 462 431Q475 431 483 424T494 412T496 403Q496 390 447 193T391 -23Q363 -106 294 -155T156 -205Q111 -205 77 -183T43 -117Q43 -95 50 -80T69 -58T89 -48T106 -45Q150 -45 150 -87Q150 -107 138 -122T115 -142T102 -147L99 -148Q101 -153 118 -160T152 -167H160Q177 -167 186 -165Q219 -156 247 -127T290 -65T313 -9T321 21L315 17Q309 13 296 6T270 -6Q250 -11 231 -11Q185 -11 150 11T104 82Q103 89 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mo" transform="translate(767.8,0)"><g data-mml-node="text"><path data-c="3E" d="M84 520Q84 528 88 533T96 539L99 540Q106 540 253 471T544 334L687 265Q694 260 694 250T687 235Q685 233 395 96L107 -40H101Q83 -38 83 -20Q83 -19 83 -17Q82 -10 98 -1Q117 9 248 71Q326 108 378 132L626 250L378 368Q90 504 86 509Q84 513 84 520Z"></path></g><g data-mml-node="text" transform="translate(778,0)"><path data-c="3E" d="M84 520Q84 528 88 533T96 539L99 540Q106 540 253 471T544 334L687 265Q694 260 694 250T687 235Q685 233 395 96L107 -40H101Q83 -38 83 -20Q83 -19 83 -17Q82 -10 98 -1Q117 9 248 71Q326 108 378 132L626 250L378 368Q90 504 86 509Q84 513 84 520Z"></path></g></g><g data-mml-node="mi" transform="translate(2601.6,0)"><path data-c="1D465" d="M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z"></path></g></g></g></svg></mjx-container>,且二者符号位相同</p>
<p>选<code>A</code></p>
</li>
<li>
<p>Ⅰ中的i为整数,转换为浮点数后再转整数并未有精度损失，所以Ⅰ是对的</p>
</li>
</ol>
<p>​    Ⅱ中的f为单精度浮点数,转换为整数后再转为浮点数出现了精度损失,所以是错的</p>
<p>​    Ⅲ中的f为单精度浮点数,转换为双精度浮点数并未有精度损失,所以Ⅲ是对的</p>
<p>​    Ⅳ因为在将单精度数提升为双精度数进行计算时，可能会引入一些舍入误差,所以Ⅳ错</p>
<p>​    选<code>B</code></p>
<ol start="11">
<li>根据公式<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>k</mi><mo>+</mo><mi>r</mi><mo>≤</mo><msup><mn>2</mn><mi>r</mi></msup><mo>−</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">k + r \leq 2^r - 1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.77777em;vertical-align:-0.08333em;"></span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.7719400000000001em;vertical-align:-0.13597em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.747722em;vertical-align:-0.08333em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.664392em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.02778em;">r</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span></li>
</ol>
<p>​    带入8可得到r最小值为4</p>
<p>​    选<code>C</code></p>
<h1 id="23-回答下列问题"><a class="markdownIt-Anchor" href="#23-回答下列问题"></a> 2.3 回答下列问题</h1>
<ol>
<li>为什么计算机中采用二进制进行数据表示和运算</li>
</ol>
<p>计算机使用二进制进行数据表示和运算的主要原因是硬件设计的简单性。在最基本的电子级别，一个开关只有两种状态：开（通常表示为1）和关（通常表示为0）。这非常适合于二进制系统，其中只有两个可能的值：0和1。</p>
<p>此外，二进制也使得逻辑运算（如AND、OR和NOT）变得简单直接，这些运算在计算机程序中非常常见。二进制还使得错误检测和纠正变得更容易，因为只需要检查和修正一个位，而不是一个复杂的十进制数字。</p>
<p>最后，虽然对于人类来说，十进制系统可能更直观，但是计算机处理二进制数据的速度要比处理十进制数据快得多。这是因为二进制运算可以直接通过硬件电路实现，而不需要复杂的算法。</p>
<ol start="2">
<li>为什么计算机采用补码表示带符号整数</li>
</ol>
<p>计算机采用补码来表示带符号整数的主要原因有以下几点：</p>
<p>​        1. <strong>统一运算规则</strong>：在补码表示法中，加法和减法可以使用相同的硬件电路进行运算，无需区分正数和负数，简化了硬件设计。</p>
<p>​	2. <strong>避免出现多种零</strong>：在原码和反码表示法中，+0和-0是两种不同的表示，而在补码表示法中，只有一种零，避免了这种混淆。</p>
<p>​	3. <strong>扩大了负数的表示范围</strong>：在补码表示法中，可以表示的负数比正数多一个，例如在8位二进制数中，可以表示的最大正数是127，而最小的负数是-128。</p>
<p>​	4. <strong>方便进行逻辑运算</strong>：补码的形式更适合进行逻辑运算，如位移、与、或、非等操作。</p>
<p>因此，现代计算机系统普遍采用补码来表示带符号整数。</p>
<ol start="3">
<li>浮点数表示范围和精度分别由什么决定</li>
</ol>
<p>​	浮点数的表示范围和精度主要由以下三个部分决定：</p>
<p>​	1. <strong>符号位（Sign bit）</strong>：这一位决定了浮点数的正负。</p>
<p>​        2. <strong>指数位（Exponent）</strong>：这部分决定了浮点数的大小范围。在IEEE 754标准中，单精度浮点数的指数部分有8位，双精度浮点数的指数部分有11位。</p>
<p>​        3. <strong>尾数位（Mantissa/Fraction）</strong>：这部分决定了浮点数的精度。在IEEE 754标准中，单精度浮点数的尾数部分有23位，双精度浮点数的尾数部分有52位。</p>
<p>指数位和尾数位的长度决定了浮点数的表示范围和精度。指数位的长度决定了浮点数的表示范围，尾数位的长度决定了浮点数的精度。更长的指数位可以表示更大范围的数，更长的尾数位可以表示更高精度的数。</p>
<ol start="4">
<li>汉字输入码，机内码和字形码在汉字处理过程中有何作用</li>
</ol>
<p>在计算机处理汉字的过程中，汉字输入码、机内码和字形码各有其特定的作用：</p>
<p>​	1. <strong>汉字输入码</strong>：这是用户在键盘上输入汉字时使用的编码。例如，拼音输入法中，“你好”的输入码就是"nihao"。输入码的设计目标是方便用户输入。</p>
<p>​	2. <strong>机内码</strong>：这是计算机内部存储和处理汉字时使用的编码。例如，GB2312、GBK和UTF-8都是机内码。机内码的设计目标是高效地存储和处理汉字。</p>
<p>​	3. <strong>字形码</strong>：这是计算机在显示汉字时使用的编码。字形码通常是一个点阵或矢量图形，描述了汉字的形状。字形码的设计目标是清晰、美观地显示汉字。</p>
<p>在汉字从输入到显示的过程中，会经历从输入码到机内码，再到字形码的转换。这个过程涉及到输入法、字符编码和字体渲染等多个技术。</p>
<ol start="5">
<li>在机内码如何区分ASCII字符和一个汉字字符</li>
</ol>
<p>在计算机内部，ASCII字符和汉字字符的区分主要依赖于所使用的字符编码方案。</p>
<p>例如，在UTF-8编码中，ASCII字符只占用一个字节，而汉字通常占用三个字节。UTF-8编码的一个重要特性是它是可变长度的，也就是说，不同的字符可能占用不同数量的字节。这使得UTF-8编码可以兼容ASCII编码，并且可以表示更多的字符。</p>
<p>在GB2312、GBK或GB18030等编码中，ASCII字符占用一个字节，汉字占用两个字节或更多。这些编码方案都是专门为汉字设计的，可以表示大量的汉字。</p>
<p>在处理字符串时，计算机会根据当前的字符编码方案来解析每个字符占用的字节数，从而区分ASCII字符和汉字字符。</p>
<ol start="6">
<li>
<p>如何识别浮点数的正负?浮点数能表示的数值范围和数值的精确度取决于什么</p>
<p>在IEEE 754标准中，浮点数的最高位（称为符号位）用于表示浮点数的正负。如果符号位是0，那么这个浮点数就是正数；如果符号位是1，那么这个浮点数就是负数。</p>
<p>浮点数能表示的数值范围和数值的精确度主要取决于两个部分：指数部分和尾数部分。</p>
<ol>
<li><strong>指数部分</strong>：决定了浮点数的大小范围。指数部分的位数越多，能表示的数的范围就越大。</li>
<li><strong>尾数部分</strong>：决定了浮点数的精度。尾数部分的位数越多，能表示的数的精度就越高。</li>
</ol>
<p>例如，在IEEE 754标准的单精度浮点数中，符号位占1位，指数部分占8位，尾数部分占23位。在双精度浮点数中，符号位占1位，指数部分占11位，尾数部分占52位。</p>
</li>
<li>
<p>简述CRC校验码的纠错原理</p>
</li>
</ol>
<p>CRC（Cyclic Redundancy Check，循环冗余校验）是一种常用的数据校验方法，它的主要原理是通过在数据后面添加一些冗余位（即CRC校验码），使得整个数据（包括原始数据和冗余位）能被一个预定的多项式整除。</p>
<p>CRC校验的过程如下：</p>
<ol>
<li>在发送端，发送者首先选择一个多项式，并将其转换为二进制形式。然后，发送者将原始数据扩展（通常是在数据的后面添加若干个0），使得扩展后的数据长度能被多项式的长度整除。接着，发送者将扩展后的数据与多项式进行模2除法运算（即异或运算），得到的余数就是CRC校验码。最后，发送者将CRC校验码添加到原始数据的后面，一起发送出去。</li>
<li>在接收端，接收者收到数据后，也用同样的多项式对收到的数据（包括原始数据和CRC校验码）进行模2除法运算。如果余数为0，那么接收者就认为数据没有错误；如果余数不为0，那么接收者就认为数据有错误。</li>
</ol>
<p>需要注意的是，CRC只能检测出错误，但不能纠正错误。如果需要纠错功能，就需要使用其他的纠错码，如海明码（Hamming code）等。</p>
<h1 id="24-已知数的补码表示形式求数的真值"><a class="markdownIt-Anchor" href="#24-已知数的补码表示形式求数的真值"></a> 2.4 已知数的补码表示形式,求数的真值</h1>
<table>
<thead>
<tr>
<th style="text-align:center"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo stretchy="false">[</mo><mi>x</mi><msub><mo stretchy="false">]</mo><mi mathvariant="normal">补</mi></msub></mrow><annotation encoding="application/x-tex">[x]_{补}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord mathdefault">x</span><span class="mclose"><span class="mclose">]</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:-0.15em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord cjk_fallback mtight">补</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></th>
<th style="text-align:center">真值</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">0.10010</td>
<td style="text-align:center">0.10010</td>
</tr>
<tr>
<td style="text-align:center">1.10010</td>
<td style="text-align:center">-0.01110</td>
</tr>
<tr>
<td style="text-align:center">1.11111</td>
<td style="text-align:center">-0.00001</td>
</tr>
<tr>
<td style="text-align:center">1.00000</td>
<td style="text-align:center">-1.00000</td>
</tr>
<tr>
<td style="text-align:center">0.10001</td>
<td style="text-align:center">0.10001</td>
</tr>
<tr>
<td style="text-align:center">1.00001</td>
<td style="text-align:center">-0.11111</td>
</tr>
</tbody>
</table>
<h1 id="25-分析下列几种情况下所能表示的数据范围分别是多少"><a class="markdownIt-Anchor" href="#25-分析下列几种情况下所能表示的数据范围分别是多少"></a> 2.5 分析下列几种情况下所能表示的数据范围分别是多少</h1>
<table>
<thead>
<tr>
<th style="text-align:center">类型</th>
<th style="text-align:center">数据范围</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">16位无符号数</td>
<td style="text-align:center"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>0</mn><mo>∼</mo><msup><mn>2</mn><mn>16</mn></msup><mo>−</mo><mn>1</mn><mi mathvariant="normal">即</mi><mo stretchy="false">[</mo><mn>0</mn><mo separator="true">,</mo><mn>65535</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">0\sim2^{16}-1 即[0,65535]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">∼</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.897438em;vertical-align:-0.08333em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mord mtight">6</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mord cjk_fallback">即</span><span class="mopen">[</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">6</span><span class="mord">5</span><span class="mord">5</span><span class="mord">3</span><span class="mord">5</span><span class="mclose">]</span></span></span></span></td>
</tr>
<tr>
<td style="text-align:center">16位原码定点小数</td>
<td style="text-align:center"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>1.111111111111111</mn><mo>∼</mo><mn>0.111111111111111</mn><mi mathvariant="normal">即</mi><mo>−</mo><mo stretchy="false">(</mo><mn>1</mn><mo>−</mo><msup><mn>2</mn><mrow><mo>−</mo><mn>15</mn></mrow></msup><mo stretchy="false">)</mo><mo>∼</mo><mn>1</mn><mo>−</mo><msup><mn>2</mn><mrow><mo>−</mo><mn>15</mn></mrow></msup></mrow><annotation encoding="application/x-tex">1.111111111111111 \sim 0.111111111111111即-(1-2^{-15}) \sim 1-2^{-15}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord">.</span><span class="mord">1</span><span class="mord">1</span><span class="mord">1</span><span class="mord">1</span><span class="mord">1</span><span class="mord">1</span><span class="mord">1</span><span class="mord">1</span><span class="mord">1</span><span class="mord">1</span><span class="mord">1</span><span class="mord">1</span><span class="mord">1</span><span class="mord">1</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">∼</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">1</span><span class="mord">1</span><span class="mord">1</span><span class="mord">1</span><span class="mord">1</span><span class="mord">1</span><span class="mord">1</span><span class="mord">1</span><span class="mord">1</span><span class="mord">1</span><span class="mord">1</span><span class="mord">1</span><span class="mord">1</span><span class="mord">1</span><span class="mord">1</span><span class="mord cjk_fallback">即</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.064108em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">1</span><span class="mord mtight">5</span></span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">∼</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.8141079999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">1</span><span class="mord mtight">5</span></span></span></span></span></span></span></span></span></span></span></span></td>
</tr>
<tr>
<td style="text-align:center">16位补码定点小数</td>
<td style="text-align:center"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>1.000000000000000</mn><mo>∼</mo><mn>0.111111111111111</mn><mi mathvariant="normal">即</mi><mo>−</mo><mn>1</mn><mo>∼</mo><mn>1</mn><mo>−</mo><msup><mn>2</mn><mrow><mo>−</mo><mn>15</mn></mrow></msup></mrow><annotation encoding="application/x-tex">1.000000000000000 \sim 0.111111111111111即-1\sim 1-2^{-15}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord">.</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">∼</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">1</span><span class="mord">1</span><span class="mord">1</span><span class="mord">1</span><span class="mord">1</span><span class="mord">1</span><span class="mord">1</span><span class="mord">1</span><span class="mord">1</span><span class="mord">1</span><span class="mord">1</span><span class="mord">1</span><span class="mord">1</span><span class="mord">1</span><span class="mord">1</span><span class="mord cjk_fallback">即</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">∼</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.8141079999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">1</span><span class="mord mtight">5</span></span></span></span></span></span></span></span></span></span></span></span></td>
</tr>
<tr>
<td style="text-align:center">16位补码定点整数</td>
<td style="text-align:center"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>1000000000000000</mn><mo>∼</mo><mn>0111111111111111</mn><mi mathvariant="normal">即</mi><mo>−</mo><msup><mn>2</mn><mn>15</mn></msup><mo>∼</mo><msup><mn>2</mn><mn>15</mn></msup><mo>−</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">1000000000000000 \sim 0111111111111111即-2^{15}\sim 2^{15}-1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">∼</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">0</span><span class="mord">1</span><span class="mord">1</span><span class="mord">1</span><span class="mord">1</span><span class="mord">1</span><span class="mord">1</span><span class="mord">1</span><span class="mord">1</span><span class="mord">1</span><span class="mord">1</span><span class="mord">1</span><span class="mord">1</span><span class="mord">1</span><span class="mord">1</span><span class="mord">1</span><span class="mord cjk_fallback">即</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.8141079999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mord mtight">5</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">∼</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.897438em;vertical-align:-0.08333em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mord mtight">5</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span></td>
</tr>
</tbody>
</table>
<h1 id="26-用ieee754-32位单精度浮点数标准表示下列十进制数"><a class="markdownIt-Anchor" href="#26-用ieee754-32位单精度浮点数标准表示下列十进制数"></a> 2.6 用IEEE754 32位单精度浮点数标准表示下列十进制数</h1>
<p>(1) -6.625</p>
<p>-6.625转化为二进制为<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>−</mo><mn>110.101</mn><mi mathvariant="normal">转</mi><mi mathvariant="normal">化</mi><mi mathvariant="normal">为</mi><mi mathvariant="normal">科</mi><mi mathvariant="normal">学</mi><mi mathvariant="normal">计</mi><mi mathvariant="normal">数</mi><mi mathvariant="normal">法</mi><mo>−</mo><mn>1.10101</mn><mo>×</mo><msup><mn>2</mn><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">-110.101转化为科学计数法-1.10101 \times 2^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">−</span><span class="mord">1</span><span class="mord">1</span><span class="mord">0</span><span class="mord">.</span><span class="mord">1</span><span class="mord">0</span><span class="mord">1</span><span class="mord cjk_fallback">转</span><span class="mord cjk_fallback">化</span><span class="mord cjk_fallback">为</span><span class="mord cjk_fallback">科</span><span class="mord cjk_fallback">学</span><span class="mord cjk_fallback">计</span><span class="mord cjk_fallback">数</span><span class="mord cjk_fallback">法</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">1</span><span class="mord">.</span><span class="mord">1</span><span class="mord">0</span><span class="mord">1</span><span class="mord">0</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.8141079999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></p>
<p>得到2进制指数位为2,尾数为10101000000000000000000</p>
<p>1 10000001 10101000000000000000000</p>
<ul>
<li>符号位: 1,为负数</li>
<li>指数位: 2 + 127 = 129 ,即10000001</li>
<li>尾数位: 10101000000000000000000</li>
<li>结果: 1 10000001 10101000000000000000000 = (C0D40000)<sub>16</sub></li>
</ul>
<p>(2) 3.1415927</p>
<p>3.1415927转化为二进制为<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>11.00100100001111110110101010001</mn><mi mathvariant="normal">转</mi><mi mathvariant="normal">化</mi><mi mathvariant="normal">为</mi><mi mathvariant="normal">科</mi><mi mathvariant="normal">学</mi><mi mathvariant="normal">计</mi><mi mathvariant="normal">数</mi><mi mathvariant="normal">法</mi><mn>1.100100100001111110110101010001</mn><mo>×</mo><msup><mn>2</mn><mn>1</mn></msup></mrow><annotation encoding="application/x-tex">11.00100100001111110110101010001转化为科学计数法1.100100100001111110110101010001 \times 2^1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">1</span><span class="mord">1</span><span class="mord">.</span><span class="mord">0</span><span class="mord">0</span><span class="mord">1</span><span class="mord">0</span><span class="mord">0</span><span class="mord">1</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mord">1</span><span class="mord">1</span><span class="mord">1</span><span class="mord">1</span><span class="mord">1</span><span class="mord">1</span><span class="mord">0</span><span class="mord">1</span><span class="mord">1</span><span class="mord">0</span><span class="mord">1</span><span class="mord">0</span><span class="mord">1</span><span class="mord">0</span><span class="mord">1</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mord">1</span><span class="mord cjk_fallback">转</span><span class="mord cjk_fallback">化</span><span class="mord cjk_fallback">为</span><span class="mord cjk_fallback">科</span><span class="mord cjk_fallback">学</span><span class="mord cjk_fallback">计</span><span class="mord cjk_fallback">数</span><span class="mord cjk_fallback">法</span><span class="mord">1</span><span class="mord">.</span><span class="mord">1</span><span class="mord">0</span><span class="mord">0</span><span class="mord">1</span><span class="mord">0</span><span class="mord">0</span><span class="mord">1</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mord">1</span><span class="mord">1</span><span class="mord">1</span><span class="mord">1</span><span class="mord">1</span><span class="mord">1</span><span class="mord">0</span><span class="mord">1</span><span class="mord">1</span><span class="mord">0</span><span class="mord">1</span><span class="mord">0</span><span class="mord">1</span><span class="mord">0</span><span class="mord">1</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.8141079999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span></span></span></span></span></span></span></span></p>
<p>得到2进制指数位为1,尾数为100100001111110110101010001</p>
<ul>
<li>符号位: 0,为正数</li>
<li>指数位: 1 + 127 = 128 ,即10000000</li>
<li>尾数位: 10010010000111111011010</li>
<li>结果: 0 10000000 10010010000111111011010 = (40490FDB)<sub>16</sub></li>
</ul>
<p>(3) 64000</p>
<p>64000转化为二进制为<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>1111101000000000</mn><mi mathvariant="normal">转</mi><mi mathvariant="normal">化</mi><mi mathvariant="normal">为</mi><mi mathvariant="normal">科</mi><mi mathvariant="normal">学</mi><mi mathvariant="normal">计</mi><mi mathvariant="normal">数</mi><mi mathvariant="normal">法</mi><mn>1.111101000000000</mn><mo>×</mo><msup><mn>2</mn><mn>15</mn></msup></mrow><annotation encoding="application/x-tex">1111101000000000转化为科学计数法1.111101000000000 \times 2^{15}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">1</span><span class="mord">1</span><span class="mord">1</span><span class="mord">1</span><span class="mord">1</span><span class="mord">0</span><span class="mord">1</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mord cjk_fallback">转</span><span class="mord cjk_fallback">化</span><span class="mord cjk_fallback">为</span><span class="mord cjk_fallback">科</span><span class="mord cjk_fallback">学</span><span class="mord cjk_fallback">计</span><span class="mord cjk_fallback">数</span><span class="mord cjk_fallback">法</span><span class="mord">1</span><span class="mord">.</span><span class="mord">1</span><span class="mord">1</span><span class="mord">1</span><span class="mord">1</span><span class="mord">0</span><span class="mord">1</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.8141079999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mord mtight">5</span></span></span></span></span></span></span></span></span></span></span></span></p>
<p>得到2进制指数位为1,尾数为100100001111110110101010001</p>
<ul>
<li>符号位: 0,为正数</li>
<li>指数位: 15 + 127 = 142 ,即10001110</li>
<li>尾数位: 11110100000000000000000</li>
<li>结果: 0 10001110 11110100000000000000000 = (477A0000)<sub>16</sub></li>
</ul>
<h1 id="27-求与单精度浮点数43940000h对应的十进制数"><a class="markdownIt-Anchor" href="#27-求与单精度浮点数43940000h对应的十进制数"></a> 2.7 求与单精度浮点数43940000H对应的十进制数</h1>
<p>43940000H对应的二进制编码为0 10000111 00101000000000000000000</p>
<ul>
<li>符号位: 0,为正数</li>
<li>指数位: 10000011,即135,减去偏移量即为8</li>
<li>尾数: 00101000000000000000000</li>
</ul>
<p>那么十进制数也就是<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>1.00101000000000000000000</mn><mo>×</mo><msup><mn>2</mn><mn>8</mn></msup><mo>=</mo><mn>100101000</mn><mo>=</mo><mn>296</mn></mrow><annotation encoding="application/x-tex">1.00101000000000000000000 \times 2^8 = 100101000 = 296</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">1</span><span class="mord">.</span><span class="mord">0</span><span class="mord">0</span><span class="mord">1</span><span class="mord">0</span><span class="mord">1</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.8141079999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">8</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord">0</span><span class="mord">0</span><span class="mord">1</span><span class="mord">0</span><span class="mord">1</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">2</span><span class="mord">9</span><span class="mord">6</span></span></span></span></p>
<h1 id="28-解释下列名词"><a class="markdownIt-Anchor" href="#28-解释下列名词"></a> 2.8 解释下列名词</h1>
<h2 id="变形补码"><a class="markdownIt-Anchor" href="#变形补码"></a> 变形补码</h2>
<p>补码是一种用于表示有符号整数的二进制数系统。在补码系统中，负数是通过取其绝对值的二进制表示，然后反转所有的位（即取反，0变为1，1变为0），最后加1来得到的。</p>
<p>变形补码是一种特殊的补码形式，它用于表示浮点数的指数部分。在IEEE 754浮点数标准中，指数部分使用了一种称为偏移二进制（offset binary）或者变形补码（bias representation）的表示方法。</p>
<p>在单精度浮点数中，指数部分是8位，偏移量是127。也就是说，实际的指数值等于存储的指数值减去127。例如，如果存储的指数值是10000001（二进制），那么实际的指数值就是1（因为10000001等于129，129减去127等于2）。</p>
<p>在双精度浮点数中，指数部分是11位，偏移量是1023。</p>
<p>这种表示方法的好处是，它可以很容易地表示出正数、负数和零，而不需要额外的符号位。</p>
<h2 id="溢出-2"><a class="markdownIt-Anchor" href="#溢出-2"></a> 溢出</h2>
<p>溢出（Overflow）是一种常见的错误情况，发生在当一个运算的结果超出了可表示或存储的范围时。例如，当你试图将一个大于127的整数存储在一个8位的有符号整数中时，就会发生溢出。</p>
<p>溢出可以分为两种类型：整数溢出和浮点数溢出。</p>
<ol>
<li>整数溢出：当一个整数的值超过了其数据类型所能表示的最大值或最小值时，就会发生整数溢出。例如，一个8位的有符号整数可以表示的最大值是127，最小值是-128。如果一个运算的结果超过了这个范围，就会发生整数溢出。</li>
<li>浮点数溢出：当一个浮点数的值超过了其数据类型所能表示的最大值时，就会发生浮点数溢出。例如，一个单精度浮点数可以表示的最大值大约是3.4E+38，如果一个运算的结果超过了这个值，就会发生浮点数溢出。</li>
</ol>
<p>在大多数编程语言中，溢出通常会导致程序错误，或者产生不可预期的结果。因此，编写程序时需要注意避免溢出的情况。</p>
<h2 id="阵列乘法器"><a class="markdownIt-Anchor" href="#阵列乘法器"></a> 阵列乘法器</h2>
<p>运算速度的提高对机器性能的提高至关重要。原码、补码一位乘法主要是通过加法器的循环累加计算多个位积和求解乘积的，速度较慢。为提高多个位积求和的速度，可以采用硬件的方式实现阵列乘法器。其基本思想是采用类似手动乘法运算的方法，用大量与门阵列同时产生手动乘法中的各乘积项,同时将大量一位全加器按照手动乘法运算的需要构成全加器阵列。图3.13所示为一个4位乘4位无符号阵列乘法器的工作原理图。</p>
<h2 id="恢复余数除法"><a class="markdownIt-Anchor" href="#恢复余数除法"></a> 恢复余数除法</h2>
<p>在原码恢复余数法中，比较被除数(余数)与除数的大小是用减法实现的。对原码除法而言操作数以绝对值的形式参与运算。因此，相减结果为正(符号位为0)说明够减，商上1;相减结果为负(符号位为1)说明不够减，商上0。<br>
由于除法通过减法实现，当商上1时，减法得到的差值就是余数，可以继续进行后续的除法操作。但商上0时表明不够减，减法得到的余数是负数，因此需要将余数加上除数，即将余数恢复成比较操作之前的数值，这种方法就称为恢复余数法。</p>
<h2 id="不恢复余数除法"><a class="markdownIt-Anchor" href="#不恢复余数除法"></a> 不恢复余数除法</h2>
<p>不恢复余数法是对恢复余数法的改进，主要特点是不够减时不需要恢复余数，而根据余数符号进行不同的运算处理。其运算步数固定，控制简单，有效提高了除法运算速度。</p>
<h2 id="并行进位"><a class="markdownIt-Anchor" href="#并行进位"></a> 并行进位</h2>
<p>在基本的二进制加法器中，每一位的加法运算都依赖于低一位的进位。这就意味着，加法运算必须从最低位开始，然后逐位向上进行，每一位的运算都必须等待前一位的运算完成。这种加法器被称为串行进位加法器。</p>
<p>并行进位加法器通过预先计算所有可能的进位，从而避免了等待前一位运算完成的延迟。这就使得所有位的加法运算可以同时进行，大大提高了加法运算的速度。</p>
<p>并行进位加法器的设计和实现比串行进位加法器要复杂得多，但是在需要进行大量加法运算的应用中，它的高速性能使得这种复杂性是值得的。</p>
<h2 id="先行进位"><a class="markdownIt-Anchor" href="#先行进位"></a> 先行进位</h2>
<p>与并行进位相同</p>
<h2 id="算术移位"><a class="markdownIt-Anchor" href="#算术移位"></a> 算术移位</h2>
<p>算术移位是一种位操作，用于将一个二进制数的所有位向左或向右移动一定的位数，同时保持该数的符号不变。</p>
<p>算术右移（Arithmetic Right Shift）：在算术右移中，最左边的位（通常是符号位）被复制到新的最左边的位，而其他位则向右移动一位。这种操作相当于将原数除以2。</p>
<p>算术左移（Arithmetic Left Shift）：在算术左移中，最右边的位被丢弃，最左边的位（符号位）保持不变，而其他位则向左移动一位。这种操作相当于将原数乘以2。</p>
<p>需要注意的是，算术移位和逻辑移位是不同的。在算术移位中，空出的位总是被填充为符号位。</p>
<h2 id="逻辑移位"><a class="markdownIt-Anchor" href="#逻辑移位"></a> 逻辑移位</h2>
<p>逻辑移位是一种位操作，用于将一个二进制数的所有位向左或向右移动一定的位数。</p>
<p>逻辑右移（Logical Right Shift）：在逻辑右移中，最左边的位被填充为0，而其他位则向右移动一位。这种操作相当于将原数除以2。</p>
<p>逻辑左移（Logical Left Shift）：在逻辑左移中，最右边的位被丢弃，最左边的位被填充为0，而其他位则向左移动一位。这种操作相当于将原数乘以2。</p>
<p>需要注意的是，逻辑移位和算术移位是不同的。在逻辑移位中，空出的位被填充为0。</p>
<h2 id="对阶"><a class="markdownIt-Anchor" href="#对阶"></a> 对阶</h2>
<p>阶码和尾数均采用补码有利于采用前面介绍的运算方法进行运算，设有两个浮点数:</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>X</mi><mo>=</mo><msup><mn>2</mn><mi>m</mi></msup><mo>×</mo><msub><mi>M</mi><mi>x</mi></msub><mtext>    </mtext><mi>Y</mi><mo>=</mo><msup><mn>2</mn><mi>n</mi></msup><mo>×</mo><msub><mi>M</mi><mi>y</mi></msub></mrow><annotation encoding="application/x-tex">X = 2^m \times M_x~~~~Y = 2^n\times M_y
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.07847em;">X</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.7977219999999999em;vertical-align:-0.08333em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7143919999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">m</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.10903em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace nobreak"> </span><span class="mspace nobreak"> </span><span class="mspace nobreak"> </span><span class="mspace nobreak"> </span><span class="mord mathdefault" style="margin-right:0.22222em;">Y</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.7977219999999999em;vertical-align:-0.08333em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7143919999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">n</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.969438em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:-0.10903em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">y</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span></span></p>
<p>当m=n时，尾数部分直接运算即可得到浮点形式的运算结果。但当参加运算的两个数的阶码m与n并不相等时，必须先设法让两个阶码相等后才能进行尾数部分的运算。使阶码相等的过程称为<code>对阶</code>，对阶完成后即可进行尾数的加减法运算</p>
<h2 id="规格化"><a class="markdownIt-Anchor" href="#规格化"></a> 规格化</h2>
<p>在计算机科学中，规格化（Normalization）是一种处理数据的方法，通常用于浮点数的表示和计算。</p>
<p>在IEEE 754浮点数标准中，规格化是指将浮点数表示为1.xxxx的形式，其中1是显式的，xxxx是尾数部分。例如，二进制数1011.1101规格化后就变成了1.0111101 * 2^3。</p>
<p>规格化的主要目的是使得浮点数的表示更加精确。因为在规格化的浮点数中，尾数部分总是以1开头，所以可以最大限度地利用尾数的位数，从而提高浮点数的精度。</p>
<h1 id="29-选择题"><a class="markdownIt-Anchor" href="#29-选择题"></a> 2.9 选择题</h1>
<ol>
<li>
<p>r1真值为-2,r2真值为-14,r3真值为-112,r4真值为-8,八位补码数据表示范围从-128~127,可以算出B的答案溢出,其他未溢出，选<code>B</code></p>
</li>
<li>
<p>x真值为-12,y真值为-80，z=-64那么选<code>A</code></p>
</li>
<li>
<p>x真值为-33,y真值为65,x-y为-98转为机器码为FFFF FF9EH，选<code>A</code></p>
</li>
<li>
<p>逻辑移位添加0而不动符号位,算术移位需添加符号位，移位后结果如下01101100,11101100,选<code>B</code></p>
</li>
<li>
<p>x阶码可记为00,111,尾数可记为00,11101</p>
<p>y阶码可记为00,101,尾数可记为00,10100</p>
<p>首先对阶,y阶码向x看齐,y阶码加2变为00,111</p>
<p>尾数相加得01,00010,符号位为01，进行右规，阶码+1</p>
<p>得X+Y阶码为01,000,X+Y尾数位00,10001</p>
<p>阶码为01说明发生溢出</p>
<p>选<code>D</code></p>
<h1 id="210-回答下列问题"><a class="markdownIt-Anchor" href="#210-回答下列问题"></a> 2.10 回答下列问题</h1>
<ol>
<li>
<p>为什么采用并行进位能提高加法器运算速度</p>
<p>并行进位（Carry-Lookahead）加法器能提高加法器运算速度的原因在于它减少了进位的等待时间。</p>
<p>在传统的串行进位加法器中，每一位的加法运算都依赖于前一位的进位结果。这就意味着，加法运算必须从最低位开始，然后逐位向上进行，每一位的运算都必须等待前一位的运算完成。这种依赖关系导致了加法运算的延迟，特别是在处理多位数时。</p>
<p>而并行进位加法器通过预先计算所有可能的进位，从而避免了等待前一位运算完成的延迟。这就使得所有位的加法运算可以同时进行，大大提高了加法运算的速度。</p>
</li>
<li>
<p>如何判断浮点数运算结果是否为规格化数?如果不是规格化数字,如何进行规格化</p>
<p>在IEEE 754浮点数标准中，一个浮点数被规格化是指它的表示形式为1.xxxx * 2^n，其中1是显式的，xxxx是尾数部分，n是指数部分。如果浮点数的表示形式不是这样，那么它就不是规格化的。</p>
<p>判断一个浮点数是否规格化，可以通过检查它的二进制表示。如果它的二进制表示的最高位（除了符号位）是1，那么它就是规格化的。否则，它就不是规格化的。</p>
<p>如果一个浮点数不是规格化的，可以通过以下步骤进行规格化：</p>
<ol>
<li>如果浮点数的二进制表示的最高位（除了符号位）是0，那么将它向左移动，直到最高位变为1。同时，每移动一位，就将指数部分减1。</li>
<li>如果浮点数的二进制表示的最高位（除了符号位）是1，但是它的小数部分有多余的0，那么将它向右移动，直到小数部分的最后一位变为1。同时，每移动一位，就将指数部分加1。</li>
</ol>
</li>
</ol>
<h1 id="211-已知x和y用变形补码计算xy并判断结果是否溢出"><a class="markdownIt-Anchor" href="#211-已知x和y用变形补码计算xy并判断结果是否溢出"></a> 2.11 已知x和y,用变形补码计算x+y,并判断结果是否溢出</h1>
<ol>
<li>x = 0.11010,y = 0.101110<br>
<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo stretchy="false">[</mo><mi>x</mi><mo>+</mo><mi>y</mi><msub><mo stretchy="false">]</mo><mi mathvariant="normal">补</mi></msub><mo>=</mo><mn>01.10001</mn></mrow><annotation encoding="application/x-tex">[x + y]_补 = 01.10001</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord mathdefault">x</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="mclose"><span class="mclose">]</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:-0.15em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord cjk_fallback mtight">补</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span><span class="mord">1</span><span class="mord">.</span><span class="mord">1</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mord">1</span></span></span></span><br>
正溢出</li>
<li>x = 0.10111,y = -0.10100<br>
<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo stretchy="false">[</mo><mi>x</mi><mo>+</mo><mi>y</mi><msub><mo stretchy="false">]</mo><mi mathvariant="normal">补</mi></msub><mo>=</mo><mn>00.01001</mn></mrow><annotation encoding="application/x-tex">[x + y]_补 = 00.01001</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord mathdefault">x</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="mclose"><span class="mclose">]</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:-0.15em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord cjk_fallback mtight">补</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span><span class="mord">0</span><span class="mord">.</span><span class="mord">0</span><span class="mord">1</span><span class="mord">0</span><span class="mord">0</span><span class="mord">1</span></span></span></span><br>
未溢出</li>
<li>x = -0.10111,y=-0.11000<br>
<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo stretchy="false">[</mo><mi>x</mi><mo>+</mo><mi>y</mi><msub><mo stretchy="false">]</mo><mi mathvariant="normal">补</mi></msub><mo>=</mo><mn>10.10001</mn></mrow><annotation encoding="application/x-tex">[x+y]_补 = 10.10001</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord mathdefault">x</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="mclose"><span class="mclose">]</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:-0.15em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord cjk_fallback mtight">补</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord">0</span><span class="mord">.</span><span class="mord">1</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mord">1</span></span></span></span><br>
负溢出</li>
</ol>
</li>
</ol>
<h1 id="212-已知x和y用变形补码计算x-y并判断结果是否溢出"><a class="markdownIt-Anchor" href="#212-已知x和y用变形补码计算x-y并判断结果是否溢出"></a> 2.12 已知x和y,用变形补码计算x-y,并判断结果是否溢出</h1>
<ol>
<li>
<p>x = 0.11011,y = 0.11101</p>
<p><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo stretchy="false">[</mo><mi>x</mi><mo>−</mo><mi>y</mi><msub><mo stretchy="false">]</mo><mi mathvariant="normal">补</mi></msub><mo>=</mo><mn>11.11110</mn></mrow><annotation encoding="application/x-tex">[x - y]_补 = 11.11110</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord mathdefault">x</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="mclose"><span class="mclose">]</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:-0.15em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord cjk_fallback mtight">补</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord">1</span><span class="mord">.</span><span class="mord">1</span><span class="mord">1</span><span class="mord">1</span><span class="mord">1</span><span class="mord">0</span></span></span></span></p>
<p>未溢出</p>
</li>
<li>
<p>x = 0.10111,y=0.11110</p>
<p><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo stretchy="false">[</mo><mi>x</mi><mo>−</mo><mi>y</mi><msub><mo stretchy="false">]</mo><mi mathvariant="normal">补</mi></msub><mo>=</mo><mn>11.11001</mn></mrow><annotation encoding="application/x-tex">[x - y]_补 = 11.11001</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord mathdefault">x</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="mclose"><span class="mclose">]</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:-0.15em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord cjk_fallback mtight">补</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord">1</span><span class="mord">.</span><span class="mord">1</span><span class="mord">1</span><span class="mord">0</span><span class="mord">0</span><span class="mord">1</span></span></span></span></p>
<p>未溢出</p>
</li>
<li>
<p>x = -0.11111,y=-0.11001</p>
<p><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo stretchy="false">[</mo><mi>x</mi><mo>−</mo><mi>y</mi><msub><mo stretchy="false">]</mo><mi mathvariant="normal">补</mi></msub><mo>=</mo><mn>11.11010</mn></mrow><annotation encoding="application/x-tex">[x-y]_补 = 11.11010</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord mathdefault">x</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="mclose"><span class="mclose">]</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:-0.15em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord cjk_fallback mtight">补</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord">1</span><span class="mord">.</span><span class="mord">1</span><span class="mord">1</span><span class="mord">0</span><span class="mord">1</span><span class="mord">0</span></span></span></span></p>
<p>未溢出</p>
</li>
</ol>
<h1 id="213-用原码一位乘法计算x-y"><a class="markdownIt-Anchor" href="#213-用原码一位乘法计算x-y"></a> 2.13 用原码一位乘法计算x * y = ?</h1>
<ol>
<li>
<p><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>x</mi><mo>=</mo><mn>0.11111</mn><mtext>   </mtext><mi>y</mi><mo>=</mo><mn>0.11101</mn></mrow><annotation encoding="application/x-tex">x = 0.11111~~~y = 0.11101</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">x</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8388800000000001em;vertical-align:-0.19444em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">1</span><span class="mord">1</span><span class="mord">1</span><span class="mord">1</span><span class="mord">1</span><span class="mspace nobreak"> </span><span class="mspace nobreak"> </span><span class="mspace nobreak"> </span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">1</span><span class="mord">1</span><span class="mord">1</span><span class="mord">0</span><span class="mord">1</span></span></span></span></p>
<table>
<thead>
<tr>
<th style="text-align:center">部分积</th>
<th style="text-align:center">乘数</th>
<th style="text-align:center">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">00.00000<br>+ 00.11111</td>
<td style="text-align:center">1110<u>1</u></td>
<td style="text-align:center">部分积 初态z<sub>0</sub> = 0<br>+|X|</td>
</tr>
<tr>
<td style="text-align:center">00.11111<br>-&gt; 00.01111<br> +  00.00000</td>
<td style="text-align:center"><br><strong>1</strong>111<u>0</u></td>
<td style="text-align:center">-&gt; 1 得z<sub>1</sub><br>+ 0</td>
</tr>
<tr>
<td style="text-align:center">00.01111<br>-&gt; 00.00111<br> + 00.11111</td>
<td style="text-align:center"><br><strong>11</strong>11<u>1</u></td>
<td style="text-align:center">-&gt; 1 得z<sub>2</sub><br>+ |X|</td>
</tr>
<tr>
<td style="text-align:center">01.00110<br>-&gt; 00.10011<br> + 00.11111</td>
<td style="text-align:center"><br><strong>011</strong>1<u>1</u></td>
<td style="text-align:center">-&gt; 1 得z<sub>3</sub><br>+|X|</td>
</tr>
<tr>
<td style="text-align:center">01.10010<br>-&gt; 00.11001<br> + 00.11111</td>
<td style="text-align:center"><br><strong>0011</strong><u>1</u></td>
<td style="text-align:center">-&gt; 1 得z<sub>4</sub><br>+|X|</td>
</tr>
<tr>
<td style="text-align:center">01.11000<br>-&gt; 00.11100<br></td>
<td style="text-align:center"><br><strong>00011</strong></td>
<td style="text-align:center">-&gt; 1 得z<sub>5</sub><br></td>
</tr>
</tbody>
</table>
<p>符号位 = <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>X</mi><mi>s</mi></msub><mo>⊕</mo><msub><mi>Y</mi><mi>s</mi></msub><mo>=</mo><mn>1</mn><mo>⊕</mo><mn>0</mn><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">X_s \oplus Y_s = 1 \oplus 0 = 1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.07847em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">s</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⊕</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.22222em;">Y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.22222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">s</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⊕</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span></p>
<p>结果为 -0.1110000011</p>
</li>
<li>
<p><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>x</mi><mo>=</mo><mo>−</mo><mn>0.11010</mn><mtext>   </mtext><mi>y</mi><mo>=</mo><mo>−</mo><mn>0.01011</mn></mrow><annotation encoding="application/x-tex">x = - 0.11010~~~y = - 0.01011</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">x</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8388800000000001em;vertical-align:-0.19444em;"></span><span class="mord">−</span><span class="mord">0</span><span class="mord">.</span><span class="mord">1</span><span class="mord">1</span><span class="mord">0</span><span class="mord">1</span><span class="mord">0</span><span class="mspace nobreak"> </span><span class="mspace nobreak"> </span><span class="mspace nobreak"> </span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">−</span><span class="mord">0</span><span class="mord">.</span><span class="mord">0</span><span class="mord">1</span><span class="mord">0</span><span class="mord">1</span><span class="mord">1</span></span></span></span></p>
<table>
<thead>
<tr>
<th style="text-align:center">部分积</th>
<th style="text-align:center">乘数</th>
<th style="text-align:center">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">00.00000<br>+   00.11010</td>
<td style="text-align:center">0101<u>1</u></td>
<td style="text-align:center">部分积 初态z<sub>0</sub> = 0<br>+|X|</td>
</tr>
<tr>
<td style="text-align:center">00.11010<br>-&gt;  00.01101<br> +  00.11010</td>
<td style="text-align:center"><br><strong>0</strong>010<u>1</u></td>
<td style="text-align:center">-&gt; 1 得z<sub>1</sub><br>+ |X|</td>
</tr>
<tr>
<td style="text-align:center">01.00111<br>-&gt; 00.10011<br> + 00.00000</td>
<td style="text-align:center"><br><strong>10</strong>01<u>0</u></td>
<td style="text-align:center">-&gt; 1 得z<sub>2</sub><br>+ 0</td>
</tr>
<tr>
<td style="text-align:center">00.10011<br>-&gt; 00.01001<br> + 00.11010</td>
<td style="text-align:center"><br><strong>110</strong>0<u>1</u></td>
<td style="text-align:center">-&gt; 1 得z<sub>3</sub><br>+|X|</td>
</tr>
<tr>
<td style="text-align:center">01.00011<br>-&gt; 00.10001<br> + 00.00000</td>
<td style="text-align:center"><br><strong>1110</strong><u>0</u></td>
<td style="text-align:center">-&gt; 1 得z<sub>4</sub><br>+0</td>
</tr>
<tr>
<td style="text-align:center">00.10001<br>-&gt; 00.01000<br></td>
<td style="text-align:center"><br><strong>11110</strong></td>
<td style="text-align:center">-&gt; 1 得z<sub>5</sub><br></td>
</tr>
</tbody>
</table>
<p>符号位 = <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>X</mi><mi>s</mi></msub><mo>⊕</mo><msub><mi>Y</mi><mi>s</mi></msub><mo>=</mo><mn>1</mn><mo>⊕</mo><mn>1</mn><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">X_s \oplus Y_s = 1 \oplus 1 = 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.07847em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">s</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⊕</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.22222em;">Y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.22222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">s</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⊕</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span></span></span></span></p>
<p>结果为0.0100011110</p>
</li>
</ol>
<h1 id="214-用补码一位乘法计算-x-y"><a class="markdownIt-Anchor" href="#214-用补码一位乘法计算-x-y"></a> 2.14 用补码一位乘法计算 x * y = ?</h1>
<ol>
<li></li>
</ol>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>x</mi><mo>=</mo><mn>0.10110</mn><mtext>   </mtext><mi>y</mi><mo>=</mo><mo>−</mo><mn>0.00011</mn><mspace linebreak="newline"></mspace><mo stretchy="false">[</mo><mi>X</mi><msub><mo stretchy="false">]</mo><mi mathvariant="normal">补</mi></msub><mo>=</mo><mn>0.10110</mn><mtext>   </mtext><mo stretchy="false">[</mo><mi>Y</mi><msub><mo stretchy="false">]</mo><mi mathvariant="normal">补</mi></msub><mo>=</mo><mn>1.11101</mn><mtext>   </mtext><mo stretchy="false">[</mo><mo>−</mo><mi>X</mi><msub><mo stretchy="false">]</mo><mi mathvariant="normal">补</mi></msub><mo>=</mo><mn>1.01010</mn></mrow><annotation encoding="application/x-tex">   x=0.10110~~~y=-0.00011\\
   [X]_补 = 0.10110~~~[Y]_补=1.11101~~~[-X]_补=1.01010
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">x</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8388800000000001em;vertical-align:-0.19444em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">1</span><span class="mord">0</span><span class="mord">1</span><span class="mord">1</span><span class="mord">0</span><span class="mspace nobreak"> </span><span class="mspace nobreak"> </span><span class="mspace nobreak"> </span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">−</span><span class="mord">0</span><span class="mord">.</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mord">1</span><span class="mord">1</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord mathdefault" style="margin-right:0.07847em;">X</span><span class="mclose"><span class="mclose">]</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:-0.15em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord cjk_fallback mtight">补</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">1</span><span class="mord">0</span><span class="mord">1</span><span class="mord">1</span><span class="mord">0</span><span class="mspace nobreak"> </span><span class="mspace nobreak"> </span><span class="mspace nobreak"> </span><span class="mopen">[</span><span class="mord mathdefault" style="margin-right:0.22222em;">Y</span><span class="mclose"><span class="mclose">]</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:-0.15em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord cjk_fallback mtight">补</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mord">.</span><span class="mord">1</span><span class="mord">1</span><span class="mord">1</span><span class="mord">0</span><span class="mord">1</span><span class="mspace nobreak"> </span><span class="mspace nobreak"> </span><span class="mspace nobreak"> </span><span class="mopen">[</span><span class="mord">−</span><span class="mord mathdefault" style="margin-right:0.07847em;">X</span><span class="mclose"><span class="mclose">]</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:-0.15em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord cjk_fallback mtight">补</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord">.</span><span class="mord">0</span><span class="mord">1</span><span class="mord">0</span><span class="mord">1</span><span class="mord">0</span></span></span></span></span></p>
<table>
<thead>
<tr>
<th style="text-align:center">部分积</th>
<th style="text-align:center">乘数</th>
<th style="text-align:center">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">00.00000<br>+   01.01010</td>
<td style="text-align:center"><br>1.1110<u>10</u></td>
<td style="text-align:center"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>y</mi><mrow><mi>n</mi><mo>+</mo><mn>1</mn></mrow></msub><mo>−</mo><msub><mi>y</mi><mi>n</mi></msub><mo>=</mo><mo>−</mo><mn>1</mn><mspace linebreak="newline"></mspace><mo>+</mo><mo stretchy="false">[</mo><mo>−</mo><mi>X</mi><msub><mo stretchy="false">]</mo><mi mathvariant="normal">补</mi></msub></mrow><annotation encoding="application/x-tex">y_{n+1}-y_n=-1\\+[-X]_补</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.791661em;vertical-align:-0.208331em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.301108em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">n</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.208331em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">−</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:0.66666em;vertical-align:-0.08333em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord">−</span><span class="mord mathdefault" style="margin-right:0.07847em;">X</span><span class="mclose"><span class="mclose">]</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:-0.15em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord cjk_fallback mtight">补</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><br>右移一位</td>
</tr>
<tr>
<td style="text-align:center">01.01010<br>-&gt; 00.10101<br>+  00.10110</td>
<td style="text-align:center"><br><strong>0</strong>1111<u>01</u></td>
<td style="text-align:center"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>y</mi><mrow><mi>n</mi><mo>+</mo><mn>1</mn></mrow></msub><mo>−</mo><msub><mi>y</mi><mi>n</mi></msub><mo>=</mo><mn>1</mn><mspace linebreak="newline"></mspace><mo>+</mo><mo stretchy="false">[</mo><mi>X</mi><msub><mo stretchy="false">]</mo><mi mathvariant="normal">补</mi></msub></mrow><annotation encoding="application/x-tex">y_{n+1}-y_n=1\\+[X]_补</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.791661em;vertical-align:-0.208331em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.301108em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">n</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.208331em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:0.66666em;vertical-align:-0.08333em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord mathdefault" style="margin-right:0.07847em;">X</span><span class="mclose"><span class="mclose">]</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:-0.15em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord cjk_fallback mtight">补</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><br>右移一位</td>
</tr>
<tr>
<td style="text-align:center">01.01011<br>-&gt; 00.10101<br>+  11.01010</td>
<td style="text-align:center"><br><strong>10</strong>111<u>10</u></td>
<td style="text-align:center"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>y</mi><mrow><mi>n</mi><mo>+</mo><mn>1</mn></mrow></msub><mo>−</mo><msub><mi>y</mi><mi>n</mi></msub><mo>=</mo><mo>−</mo><mn>1</mn><mspace linebreak="newline"></mspace><mo>+</mo><mo stretchy="false">[</mo><mo>−</mo><mi>X</mi><msub><mo stretchy="false">]</mo><mi mathvariant="normal">补</mi></msub></mrow><annotation encoding="application/x-tex">y_{n+1}-y_n=-1\\+[-X]_补</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.791661em;vertical-align:-0.208331em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.301108em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">n</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.208331em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">−</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:0.66666em;vertical-align:-0.08333em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord">−</span><span class="mord mathdefault" style="margin-right:0.07847em;">X</span><span class="mclose"><span class="mclose">]</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:-0.15em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord cjk_fallback mtight">补</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><br>右移一位</td>
</tr>
<tr>
<td style="text-align:center">11.01111<br>-&gt; 11.10111<br>+   00.00000</td>
<td style="text-align:center"><br><strong>110</strong>11<u>11</u></td>
<td style="text-align:center"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>y</mi><mrow><mi>n</mi><mo>+</mo><mn>1</mn></mrow></msub><mo>−</mo><msub><mi>y</mi><mi>n</mi></msub><mo>=</mo><mn>0</mn><mspace linebreak="newline"></mspace><mo>+</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">y_{n+1}-y_n=0\\+0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.791661em;vertical-align:-0.208331em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.301108em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">n</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.208331em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:0.66666em;vertical-align:-0.08333em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span></span></span></span><br>右移一位</td>
</tr>
<tr>
<td style="text-align:center">11.10111<br>-&gt; 11.11011<br>+   00.00000</td>
<td style="text-align:center"><br><strong>1110</strong>1<u>11</u></td>
<td style="text-align:center"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>y</mi><mrow><mi>n</mi><mo>+</mo><mn>1</mn></mrow></msub><mo>−</mo><msub><mi>y</mi><mi>n</mi></msub><mo>=</mo><mn>0</mn><mspace linebreak="newline"></mspace><mo>+</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">y_{n+1}-y_n=0\\+0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.791661em;vertical-align:-0.208331em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.301108em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">n</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.208331em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:0.66666em;vertical-align:-0.08333em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span></span></span></span><br>右移一位</td>
</tr>
<tr>
<td style="text-align:center">11.11011<br>-&gt; 11.11101<br>+   00.00000</td>
<td style="text-align:center"><br><strong>11110</strong><u>11</u></td>
<td style="text-align:center"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>y</mi><mrow><mi>n</mi><mo>+</mo><mn>1</mn></mrow></msub><mo>−</mo><msub><mi>y</mi><mi>n</mi></msub><mo>=</mo><mn>0</mn><mspace linebreak="newline"></mspace><mo>+</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">y_{n+1}-y_n=0\\+0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.791661em;vertical-align:-0.208331em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.301108em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">n</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.208331em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:0.66666em;vertical-align:-0.08333em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span></span></span></span><br>最后一位数据不移位</td>
</tr>
<tr>
<td style="text-align:center">11.11101</td>
<td style="text-align:center"><strong>11110</strong></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo stretchy="false">[</mo><mi>x</mi><mo>×</mo><mi>y</mi><msub><mo stretchy="false">]</mo><mi mathvariant="normal">补</mi></msub><mo>=</mo><mn>1.1110111110</mn></mrow><annotation encoding="application/x-tex">[x \times y]_补 = 1.1110111110</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord mathdefault">x</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="mclose"><span class="mclose">]</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:-0.15em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord cjk_fallback mtight">补</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord">.</span><span class="mord">1</span><span class="mord">1</span><span class="mord">1</span><span class="mord">0</span><span class="mord">1</span><span class="mord">1</span><span class="mord">1</span><span class="mord">1</span><span class="mord">1</span><span class="mord">0</span></span></span></span></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
</tbody>
</table>
<ol start="2">
<li></li>
</ol>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>x</mi><mo>=</mo><mo>−</mo><mn>0.011010</mn><mtext>   </mtext><mi>y</mi><mo>=</mo><mo>−</mo><mn>0.011101</mn><mspace linebreak="newline"></mspace><mo stretchy="false">[</mo><mi>X</mi><msub><mo stretchy="false">]</mo><mi mathvariant="normal">补</mi></msub><mo>=</mo><mn>1.100110</mn><mtext>   </mtext><mo stretchy="false">[</mo><mi>Y</mi><msub><mo stretchy="false">]</mo><mi mathvariant="normal">补</mi></msub><mo>=</mo><mn>1.100011</mn><mtext>   </mtext><mo stretchy="false">[</mo><mo>−</mo><mi>X</mi><msub><mo stretchy="false">]</mo><mi mathvariant="normal">补</mi></msub><mo>=</mo><mn>0.011010</mn></mrow><annotation encoding="application/x-tex">    x=-0.011010~~~y=-0.011101\\
    [X]_补 = 1.100110~~~[Y]_补=1.100011~~~[-X]_补=0.011010
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">x</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8388800000000001em;vertical-align:-0.19444em;"></span><span class="mord">−</span><span class="mord">0</span><span class="mord">.</span><span class="mord">0</span><span class="mord">1</span><span class="mord">1</span><span class="mord">0</span><span class="mord">1</span><span class="mord">0</span><span class="mspace nobreak"> </span><span class="mspace nobreak"> </span><span class="mspace nobreak"> </span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">−</span><span class="mord">0</span><span class="mord">.</span><span class="mord">0</span><span class="mord">1</span><span class="mord">1</span><span class="mord">1</span><span class="mord">0</span><span class="mord">1</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord mathdefault" style="margin-right:0.07847em;">X</span><span class="mclose"><span class="mclose">]</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:-0.15em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord cjk_fallback mtight">补</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mord">.</span><span class="mord">1</span><span class="mord">0</span><span class="mord">0</span><span class="mord">1</span><span class="mord">1</span><span class="mord">0</span><span class="mspace nobreak"> </span><span class="mspace nobreak"> </span><span class="mspace nobreak"> </span><span class="mopen">[</span><span class="mord mathdefault" style="margin-right:0.22222em;">Y</span><span class="mclose"><span class="mclose">]</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:-0.15em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord cjk_fallback mtight">补</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mord">.</span><span class="mord">1</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mord">1</span><span class="mord">1</span><span class="mspace nobreak"> </span><span class="mspace nobreak"> </span><span class="mspace nobreak"> </span><span class="mopen">[</span><span class="mord">−</span><span class="mord mathdefault" style="margin-right:0.07847em;">X</span><span class="mclose"><span class="mclose">]</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:-0.15em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord cjk_fallback mtight">补</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">0</span><span class="mord">1</span><span class="mord">1</span><span class="mord">0</span><span class="mord">1</span><span class="mord">0</span></span></span></span></span></p>
<table>
<thead>
<tr>
<th style="text-align:center">部分积</th>
<th style="text-align:center">乘数</th>
<th style="text-align:center">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">00.000000<br>+    00.011010</td>
<td style="text-align:center"><br>1.10001<u>10</u></td>
<td style="text-align:center"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>y</mi><mrow><mi>n</mi><mo>+</mo><mn>1</mn></mrow></msub><mo>−</mo><msub><mi>y</mi><mi>n</mi></msub><mo>=</mo><mn>0</mn><mspace linebreak="newline"></mspace><mo>+</mo><mo stretchy="false">[</mo><mo>−</mo><mi>X</mi><msub><mo stretchy="false">]</mo><mi mathvariant="normal">补</mi></msub></mrow><annotation encoding="application/x-tex">y_{n+1}-y_n=0\\+[-X]_补</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.791661em;vertical-align:-0.208331em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.301108em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">n</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.208331em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:0.66666em;vertical-align:-0.08333em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord">−</span><span class="mord mathdefault" style="margin-right:0.07847em;">X</span><span class="mclose"><span class="mclose">]</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:-0.15em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord cjk_fallback mtight">补</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><br>右移一位</td>
</tr>
<tr>
<td style="text-align:center">00.011010<br>-&gt;  00.001101<br>+    00.000000</td>
<td style="text-align:center"><br><strong>0</strong>11000<u>11</u></td>
<td style="text-align:center"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>y</mi><mrow><mi>n</mi><mo>+</mo><mn>1</mn></mrow></msub><mo>−</mo><msub><mi>y</mi><mi>n</mi></msub><mo>=</mo><mn>1</mn><mspace linebreak="newline"></mspace><mo>+</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">y_{n+1}-y_n=1\\+0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.791661em;vertical-align:-0.208331em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.301108em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">n</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.208331em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:0.66666em;vertical-align:-0.08333em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span></span></span></span><br>右移一位</td>
</tr>
<tr>
<td style="text-align:center">00.001101<br>-&gt;   00.000110<br>+    11.100110</td>
<td style="text-align:center"><br><strong>10</strong>1100<u>01</u></td>
<td style="text-align:center"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>y</mi><mrow><mi>n</mi><mo>+</mo><mn>1</mn></mrow></msub><mo>−</mo><msub><mi>y</mi><mi>n</mi></msub><mo>=</mo><mn>0</mn><mspace linebreak="newline"></mspace><mo>+</mo><mo stretchy="false">[</mo><mi>X</mi><msub><mo stretchy="false">]</mo><mi mathvariant="normal">补</mi></msub></mrow><annotation encoding="application/x-tex">y_{n+1}-y_n=0\\+[X]_补</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.791661em;vertical-align:-0.208331em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.301108em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">n</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.208331em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:0.66666em;vertical-align:-0.08333em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord mathdefault" style="margin-right:0.07847em;">X</span><span class="mclose"><span class="mclose">]</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:-0.15em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord cjk_fallback mtight">补</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><br>右移一位</td>
</tr>
<tr>
<td style="text-align:center">11.101100<br>-&gt;  11.110110<br>+    00.000000</td>
<td style="text-align:center"><br><strong>010</strong>110<u>00</u></td>
<td style="text-align:center"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>y</mi><mrow><mi>n</mi><mo>+</mo><mn>1</mn></mrow></msub><mo>−</mo><msub><mi>y</mi><mi>n</mi></msub><mo>=</mo><mn>0</mn><mspace linebreak="newline"></mspace><mo>+</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">y_{n+1}-y_n=0\\+0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.791661em;vertical-align:-0.208331em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.301108em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">n</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.208331em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:0.66666em;vertical-align:-0.08333em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span></span></span></span><br>右移一位</td>
</tr>
<tr>
<td style="text-align:center">11.110110<br>-&gt; 11.111011<br>+   00.000000</td>
<td style="text-align:center"><br><strong>0010</strong>11<u>00</u></td>
<td style="text-align:center"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>y</mi><mrow><mi>n</mi><mo>+</mo><mn>1</mn></mrow></msub><mo>−</mo><msub><mi>y</mi><mi>n</mi></msub><mo>=</mo><mo>−</mo><mn>1</mn><mspace linebreak="newline"></mspace><mo>+</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">y_{n+1}-y_n=-1\\+0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.791661em;vertical-align:-0.208331em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.301108em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">n</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.208331em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">−</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:0.66666em;vertical-align:-0.08333em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span></span></span></span><br>右移一位</td>
</tr>
<tr>
<td style="text-align:center">11.111011<br>-&gt; 11.111101<br>+   00.011010</td>
<td style="text-align:center"><br><strong>10010</strong>1<u>10</u></td>
<td style="text-align:center"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>y</mi><mrow><mi>n</mi><mo>+</mo><mn>1</mn></mrow></msub><mo>−</mo><msub><mi>y</mi><mi>n</mi></msub><mo>=</mo><mo>−</mo><mn>1</mn><mspace linebreak="newline"></mspace><mo>+</mo><mo stretchy="false">[</mo><mo>−</mo><mi>X</mi><msub><mo stretchy="false">]</mo><mi mathvariant="normal">补</mi></msub></mrow><annotation encoding="application/x-tex">y_{n+1}-y_n=-1\\+[-X]_补</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.791661em;vertical-align:-0.208331em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.301108em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">n</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.208331em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">−</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:0.66666em;vertical-align:-0.08333em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord">−</span><span class="mord mathdefault" style="margin-right:0.07847em;">X</span><span class="mclose"><span class="mclose">]</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:-0.15em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord cjk_fallback mtight">补</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><br>右移一位</td>
</tr>
<tr>
<td style="text-align:center">00.010111<br>-&gt; 00.001011<br>+   00.000000</td>
<td style="text-align:center"><br><strong>110010</strong><u>11</u></td>
<td style="text-align:center"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>y</mi><mrow><mi>n</mi><mo>+</mo><mn>1</mn></mrow></msub><mo>−</mo><msub><mi>y</mi><mi>n</mi></msub><mo>=</mo><mn>0</mn><mspace linebreak="newline"></mspace><mo>+</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">y_{n+1}-y_n=0\\+0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.791661em;vertical-align:-0.208331em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.301108em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">n</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.208331em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:0.66666em;vertical-align:-0.08333em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span></span></span></span><br>最后一位不移位</td>
</tr>
<tr>
<td style="text-align:center">-&gt;  00.001011<br></td>
<td style="text-align:center"><strong>110010</strong></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo stretchy="false">[</mo><mi>x</mi><mo>×</mo><mi>y</mi><msub><mo stretchy="false">]</mo><mi mathvariant="normal">补</mi></msub><mo>=</mo><mn>0.001011110010</mn></mrow><annotation encoding="application/x-tex">[x \times y]_补 = 0.001011110010</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord mathdefault">x</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="mclose"><span class="mclose">]</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:-0.15em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord cjk_fallback mtight">补</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">0</span><span class="mord">0</span><span class="mord">1</span><span class="mord">0</span><span class="mord">1</span><span class="mord">1</span><span class="mord">1</span><span class="mord">1</span><span class="mord">0</span><span class="mord">0</span><span class="mord">1</span><span class="mord">0</span></span></span></span></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
</tbody>
</table>
]]></content>
      <categories>
        <category>校内课程</category>
      </categories>
      <tags>
        <tag>学习</tag>
        <tag>计算机组成原理</tag>
        <tag>作业</tag>
      </tags>
  </entry>
</search>
