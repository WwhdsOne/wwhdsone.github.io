<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.1.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/MdiAlphaWCircle.svg">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/MdiAlphaWCircle.svg">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/MdiAlphaWCircle.svg">
  <link rel="mask-icon" href="/images/MdiAlphaWCircle.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.loli.net/css?family=EB Garamond, 'Noto Serif SC':300,300italic,400,400italic,700,700italic|Fira Code:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pace-js@latest/themes/black/pace-theme-center-atom.css">
  <script src="//cdn.jsdelivr.net/npm/pace-js@latest/pace.min.js"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"wwhdsone.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"gitalk","storage":true,"lazyload":false,"nav":null,"activeClass":"gitalk"},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":true,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="学成在线Day12内容">
<meta property="og:type" content="article">
<meta property="og:title" content="学成在线Day12">
<meta property="og:url" content="https://wwhdsone.github.io/2024/03/21/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFDay12/index.html">
<meta property="og:site_name" content="WBlog">
<meta property="og:description" content="学成在线Day12内容">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240306163011491.png">
<meta property="og:image" content="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240306164135416.png">
<meta property="og:image" content="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240307161041581.png">
<meta property="og:image" content="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/Snipaste_2024-03-06_19-18-08.png">
<meta property="og:image" content="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240307183647563.png">
<meta property="og:image" content="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240309162829957.png">
<meta property="article:published_time" content="2024-03-21T02:10:02.000Z">
<meta property="article:modified_time" content="2024-03-21T02:10:18.987Z">
<meta property="article:author" content="Wwhds">
<meta property="article:tag" content="Java">
<meta property="article:tag" content="学习">
<meta property="article:tag" content="后端">
<meta property="article:tag" content="黑马程序员">
<meta property="article:tag" content="学成在线">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240306163011491.png">

<link rel="canonical" href="https://wwhdsone.github.io/2024/03/21/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFDay12/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>
<link rel="stylesheet" href="//cdn.jsdelivr.net/gh/theme-next/theme-next-needmoreshare2@1/needsharebutton.min.css"><style>
#needsharebutton-postbottom {
  cursor: pointer;
  height: 26px;
  margin-top: 10px;
  position: relative;
}
#needsharebutton-postbottom .btn {
  border: 1px solid $btn-default-border-color;
  border-radius: 3px;
  display: initial;
  padding: 1px 4px;
}
</style>
  <title>学成在线Day12 | WBlog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<style>mjx-container[jax="SVG"] {
  direction: ltr;
}

mjx-container[jax="SVG"] > svg {
  overflow: visible;
}

mjx-container[jax="SVG"][display="true"] {
  display: block;
  text-align: center;
  margin: 1em 0;
}

mjx-container[jax="SVG"][justify="left"] {
  text-align: left;
}

mjx-container[jax="SVG"][justify="right"] {
  text-align: right;
}

g[data-mml-node="merror"] > g {
  fill: red;
  stroke: red;
}

g[data-mml-node="merror"] > rect[data-background] {
  fill: yellow;
  stroke: none;
}

g[data-mml-node="mtable"] > line[data-line] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > rect[data-frame] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > .mjx-dashed {
  stroke-dasharray: 140;
}

g[data-mml-node="mtable"] > .mjx-dotted {
  stroke-linecap: round;
  stroke-dasharray: 0,140;
}

g[data-mml-node="mtable"] > svg {
  overflow: visible;
}

[jax="SVG"] mjx-tool {
  display: inline-block;
  position: relative;
  width: 0;
  height: 0;
}

[jax="SVG"] mjx-tool > mjx-tip {
  position: absolute;
  top: 0;
  left: 0;
}

mjx-tool > mjx-tip {
  display: inline-block;
  padding: .2em;
  border: 1px solid #888;
  font-size: 70%;
  background-color: #F8F8F8;
  color: black;
  box-shadow: 2px 2px 5px #AAAAAA;
}

g[data-mml-node="maction"][data-toggle] {
  cursor: pointer;
}

mjx-status {
  display: block;
  position: fixed;
  left: 1em;
  bottom: 1em;
  min-width: 25%;
  padding: .2em .4em;
  border: 1px solid #888;
  font-size: 90%;
  background-color: #F8F8F8;
  color: black;
}

foreignObject[data-mjx-xml] {
  font-family: initial;
  line-height: normal;
  overflow: visible;
}

.MathJax path {
  stroke-width: 3;
}

mjx-container[display="true"] {
  overflow: auto hidden;
}

mjx-container[display="true"] + br {
  display: none;
}
</style><style>.darkmode--activated{--body-bg-color:#282828;--content-bg-color:#333;--card-bg-color:#555;--text-color:#ccc;--blockquote-color:#bbb;--link-color:#ccc;--link-hover-color:#eee;--brand-color:#ddd;--brand-hover-color:#ddd;--table-row-odd-bg-color:#282828;--table-row-hover-bg-color:#363636;--menu-item-bg-color:#555;--btn-default-bg:#222;--btn-default-color:#ccc;--btn-default-border-color:#555;--btn-default-hover-bg:#666;--btn-default-hover-color:#ccc;--btn-default-hover-border-color:#666;--highlight-background:#282b2e;--highlight-foreground:#a9b7c6;--highlight-gutter-background:#34393d;--highlight-gutter-foreground:#9ca9b6}.darkmode--activated img{opacity:.75}.darkmode--activated img:hover{opacity:.9}.darkmode--activated code{color:#69dbdc;background:0 0}button.darkmode-toggle{z-index:9999}.darkmode-ignore,img{display:flex!important}.beian img{display:inline-block!important}</style></head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">WBlog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">哀吾生之须臾，羡长江之无穷</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/WwhdsOne" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://wwhdsone.github.io/2024/03/21/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFDay12/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/Markdown%E4%BD%BF%E7%94%A8/w.jpg">
      <meta itemprop="name" content="Wwhds">
      <meta itemprop="description" content="个人博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WBlog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          学成在线Day12
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2024-03-21 10:10:02 / 修改时间：10:10:18" itemprop="dateCreated datePublished" datetime="2024-03-21T10:10:02+08:00">2024-03-21</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span><br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>26k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>47 分钟</span>
            </span>
            <div class="post-description">学成在线Day12内容</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="学成在线day12"><a class="markdownIt-Anchor" href="#学成在线day12"></a> 学成在线Day12</h1>
<h2 id="生成支付二维码"><a class="markdownIt-Anchor" href="#生成支付二维码"></a> 生成支付二维码</h2>
<h3 id="需求分析"><a class="markdownIt-Anchor" href="#需求分析"></a> 需求分析</h3>
<h4 id="执行流程"><a class="markdownIt-Anchor" href="#执行流程"></a> 执行流程</h4>
<p>再次打开课程支付引导界面，点击“支付宝支付”按钮系统该如何处理？</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240306163011491.png" alt="image-20240306163011491"></p>
<p>点击<code>支付宝支付</code>此时打开支付二维码，用户扫码支付。</p>
<p>所以首先需要生成支付二维码，用户扫描二维码开始请求支付宝下单，在向支付宝下单前需要添加选课记录、创建商品订单、生成支付交易记录。</p>
<p>生成二维码执行流程如下：</p>
<pre class="mermaid">sequenceDiagram
	actor 用户
	用户 -&gt;&gt; 前端: 点击支付
	前端 -&gt;&gt; 学习服务中心: 添加选课记录
	前端 -&gt;&gt; 订单服务: 创建商品订单
	订单服务 -&gt;&gt; 订单服务: 生成支付记录
	订单服务 -&gt;&gt; 订单服务: 生成二维码
	订单服务 -&gt;&gt; 前端: 返回二维码</pre>
<p>执行流程：</p>
<ol>
<li>
<p>前端调用学习中心服务的添加选课接口。</p>
</li>
<li>
<p>添加选课成功请求订单服务生成支付二维码接口。</p>
</li>
<li>
<p>生成二维码接口：创建商品订单、生成支付交易记录、生成二维码。</p>
</li>
<li>
<p>将二维码返回到前端，用户扫码。</p>
</li>
</ol>
<p>用户扫码支付流程如下：</p>
<pre class="mermaid">sequenceDiagram
	actor 用户
	用户 -&gt;&gt; 前端: 支付宝沙箱扫码
	前端 -&gt;&gt; 订单服务: 下单
	订单服务 -&gt;&gt; 订单服务: 构造请求参数
	订单服务 -&gt;&gt; 支付宝: 下单
	订单服务 -&gt;&gt; 前端: 响应
	用户 -&gt;&gt; 前端: 输入密码支付
	前端 -&gt;&gt; 支付宝: 请求支付
	支付宝 -&gt;&gt; 订单服务: 通知支付结果
	订单服务 -&gt;&gt; 订单服务: 接收支付结果并验收
	用户 -&gt;&gt; 前端: 查询支付结果
	前端 -&gt;&gt; 订单服务: 查询支付结果
	订单服务 -&gt;&gt; 支付宝: 查询支付结果</pre>
<p>执行流程：</p>
<ol>
<li>
<p>用户输入支付密码，支付成功。</p>
</li>
<li>
<p>接收第三方平台通知的支付结果。</p>
</li>
<li>
<p>根据支付结果更新支付交易记录的支付状态为支付成功。</p>
</li>
</ol>
<h4 id="数据模型"><a class="markdownIt-Anchor" href="#数据模型"></a> 数据模型</h4>
<p>订单支付模式的核心由三张表组成：订单表、订单明细表、支付交易记录表。</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240306164135416.png" alt="image-20240306164135416"></p>
<p>订单号注意唯一性、安全性、尽量短等特点，生成方案常用的如下：</p>
<ol>
<li><code>时间戳+随机数</code></li>
</ol>
<p>年月日时分秒毫秒+随机数</p>
<ol start="2">
<li><code>高并发场景</code></li>
</ol>
<p>年月日时分秒毫秒+随机数+redis自增序列</p>
<ol start="3">
<li><code>订单号中加上业务标识</code></li>
</ol>
<p>订单号加上业务标识方便客服，比如：第10位是业务类型，第11位是用户类型等。</p>
<ol start="4">
<li><code>雪花算法</code></li>
</ol>
<p>雪花算法是<code>推特内部</code>使用的分布式环境下的唯一ID生成算法，它基于时间戳生成，保证有序递增，加以入计算机硬件等元素，可以满足高并发环境下ID不重复。</p>
<p>本项目订单号生成采用雪花算法。</p>
<h3 id="接口开发"><a class="markdownIt-Anchor" href="#接口开发"></a> 接口开发</h3>
<h4 id="保存商品订单"><a class="markdownIt-Anchor" href="#保存商品订单"></a> 保存商品订单</h4>
<ol>
<li>定义保存订单信息接口:</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">OrderService</span> {</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建订单</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userId 用户id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> addOrderDto 订单信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 订单id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    PayRecordDto <span class="title function_">createOrder</span><span class="params">(String userId, AddOrderDto addOrderDto)</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>在保存订单接口中需要完成创建商品订单、创建支付交易记录，接口实现方法如下：</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> PayRecordDto <span class="title function_">createOrder</span><span class="params">(String userId, AddOrderDto addOrderDto)</span> {</span><br><span class="line"></span><br><span class="line">    <span class="comment">//添加商品订单</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//添加支付交易记录</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//生成二维码</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>编写创建商品订单方法，商品订单的数据来源于选课记录，在订单表需要存入选课记录的ID，这里需要作好幂等处理。</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> XcOrders <span class="title function_">saveXcOrders</span><span class="params">(String userId, AddOrderDto addOrderDto)</span> {</span><br><span class="line">    <span class="comment">// 插入订单表</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 进行幂等性判断,确定每一个选课记录只能有一个订单</span></span><br><span class="line">    <span class="type">XcOrders</span> <span class="variable">xcOrdersByBusinessId</span> <span class="operator">=</span> getXcOrdersByBusinessId(addOrderDto.getOutBusinessId());</span><br><span class="line">    <span class="keyword">if</span>(xcOrdersByBusinessId != <span class="literal">null</span>){</span><br><span class="line">        <span class="keyword">return</span> xcOrdersByBusinessId;</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// 1.插入订单主表</span></span><br><span class="line">    <span class="type">XcOrders</span> <span class="variable">xcOrders</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XcOrders</span>();</span><br><span class="line">    xcOrders.setId(IdWorkerUtils.getInstance().nextId()); <span class="comment">//雪花算法生成订单号</span></span><br><span class="line">    xcOrders.setTotalPrice(addOrderDto.getTotalPrice());</span><br><span class="line">    xcOrders.setCreateDate(LocalDateTime.now());</span><br><span class="line">    xcOrders.setStatus(<span class="string">"600001"</span>);<span class="comment">//未支付</span></span><br><span class="line">    xcOrders.setUserId(userId);</span><br><span class="line">    xcOrders.setOrderType(<span class="string">"60201"</span>);<span class="comment">//订单类型:课程</span></span><br><span class="line">    xcOrders.setOrderName(addOrderDto.getOrderName());</span><br><span class="line">    xcOrders.setOrderDescrip(addOrderDto.getOrderDescrip());</span><br><span class="line">    xcOrders.setOrderDetail(addOrderDto.getOrderDetail());</span><br><span class="line">    xcOrders.setOutBusinessId(addOrderDto.getOutBusinessId());<span class="comment">//如果是购买课程此处是选课的ID</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">insert</span> <span class="operator">=</span> xcOrdersMapper.insert(xcOrders);</span><br><span class="line">    <span class="keyword">if</span>(insert &lt;= <span class="number">0</span>){</span><br><span class="line">        XueChengPlusException.cast(<span class="string">"插入订单失败"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="type">Long</span> <span class="variable">orderId</span> <span class="operator">=</span> xcOrders.getId();</span><br><span class="line">    <span class="comment">// 2.插入订单明细表</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">orderDetailJSON</span> <span class="operator">=</span> addOrderDto.getOrderDetail();</span><br><span class="line">    <span class="comment">//解析JSON</span></span><br><span class="line">    List&lt;XcOrdersGoods&gt; xcOrdersGoods = JSON.parseArray(orderDetailJSON, XcOrdersGoods.class);</span><br><span class="line">    <span class="comment">//遍历插入</span></span><br><span class="line">    <span class="keyword">for</span> (XcOrdersGoods xcOrdersGoods1 : xcOrdersGoods) {</span><br><span class="line">        xcOrdersGoods1.setOrderId(orderId);</span><br><span class="line">        <span class="type">int</span> <span class="variable">insert1</span> <span class="operator">=</span> xcOrdersGoodsMapper.insert(xcOrdersGoods1);</span><br><span class="line">        <span class="keyword">if</span>(insert1 &lt;= <span class="number">0</span>){</span><br><span class="line">            XueChengPlusException.cast(<span class="string">"插入订单明细失败"</span>);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> xcOrders;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>插入交易记录表</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 插入支付记录</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> orders 订单信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 支付记录</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="keyword">private</span> XcPayRecord <span class="title function_">createPayRecord</span><span class="params">(XcOrders orders)</span> {</span><br><span class="line">    <span class="comment">//订单ID</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">orderId</span> <span class="operator">=</span> orders.getId();</span><br><span class="line">    <span class="comment">//如果订单不存在,不添加支付记录</span></span><br><span class="line">    <span class="type">XcOrders</span> <span class="variable">xcOrders</span> <span class="operator">=</span> xcOrdersMapper.selectById(orderId);</span><br><span class="line">    <span class="keyword">if</span>(xcOrders == <span class="literal">null</span>){</span><br><span class="line">        XueChengPlusException.cast(<span class="string">"订单不存在"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//如果订单支付已成功,也不添加支付记录</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">status</span> <span class="operator">=</span> xcOrders.getStatus();</span><br><span class="line">    <span class="keyword">if</span>(<span class="string">"601002"</span>.equals(status)){</span><br><span class="line">        XueChengPlusException.cast(<span class="string">"订单已支付"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//插入支付记录</span></span><br><span class="line">    <span class="type">XcPayRecord</span> <span class="variable">xcPayRecord</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XcPayRecord</span>();</span><br><span class="line">    xcPayRecord.setPayNo(IdWorkerUtils.getInstance().nextId());<span class="comment">//雪花算法生成支付号</span></span><br><span class="line">    xcPayRecord.setOrderId(orderId);</span><br><span class="line">    xcPayRecord.setOrderName(xcOrders.getOrderName());</span><br><span class="line">    xcPayRecord.setTotalPrice(xcOrders.getTotalPrice());</span><br><span class="line">    xcPayRecord.setCurrency(<span class="string">"CNY"</span>);</span><br><span class="line">    xcPayRecord.setCreateDate(LocalDateTime.now());</span><br><span class="line">    xcPayRecord.setStatus(<span class="string">"601001"</span>);<span class="comment">//支付类型:未支付</span></span><br><span class="line">    xcPayRecord.setUserId(xcOrders.getUserId());</span><br><span class="line">    <span class="type">int</span> <span class="variable">insert</span> <span class="operator">=</span> xcPayRecordMapper.insert(xcPayRecord);</span><br><span class="line">    <span class="keyword">if</span>(insert &lt;= <span class="number">0</span>){</span><br><span class="line">        XueChengPlusException.cast(<span class="string">"插入支付记录失败"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//返回支付记录</span></span><br><span class="line">    <span class="keyword">return</span> xcPayRecord;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h4 id="创建支付交易记录"><a class="markdownIt-Anchor" href="#创建支付交易记录"></a> 创建支付交易记录</h4>
<p>为什么创建支付交易记录？</p>
<p>在请求微信或支付宝下单接口时需要传入 商品订单号，在与第三方支付平台对接时发现，当用户支付失败或因为其它原因最终该订单没有支付成功，此时再次调用第三方支付平台的下单接口发现报错“订单号已存在”，此时如果我们传入一个没有使用过的订单号就可以解决问题，但是商品订单已经创建，因为没有支付成功重新创建一个新订单是不合理的。</p>
<p>解决以上问题的方案是：</p>
<ol>
<li>
<p>用户每次发起都创建一个新的支付交易记录 ，此交易记录与商品订单关联。</p>
</li>
<li>
<p>将支付交易记录的流水号传给第三方支付系统下单接口，这样就即使没有支付成功就不会出现上边的问题。</p>
</li>
<li>
<p>需要提醒用户不要重复支付。</p>
</li>
</ol>
<img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240307161041581.png" alt="image-20240307161041581" style="zoom:50%;">
<p>编写创建支付交易记录的方法:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> XcPayRecord <span class="title function_">createPayRecord</span><span class="params">(XcOrders orders)</span>{</span><br><span class="line">    <span class="keyword">if</span>(order==<span class="literal">null</span>){</span><br><span class="line">        XueChengPlusException.cast(<span class="string">"订单不存在"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">if</span>(orders.getStatus().equals(<span class="string">"600002"</span>)){</span><br><span class="line">        XueChengPlusException.cast(<span class="string">"订单已支付"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="type">XcPayRecord</span> <span class="variable">payRecord</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XcPayRecord</span>();</span><br><span class="line">    <span class="comment">//生成支付交易流水号</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">payNo</span> <span class="operator">=</span> IdWorkerUtils.getInstance().nextId();</span><br><span class="line">    payRecord.setPayNo(payNo);</span><br><span class="line">    payRecord.setOrderId(orders.getId());<span class="comment">//商品订单号</span></span><br><span class="line">    payRecord.setOrderName(orders.getOrderName());</span><br><span class="line">    payRecord.setTotalPrice(orders.getTotalPrice());</span><br><span class="line">    payRecord.setCurrency(<span class="string">"CNY"</span>);</span><br><span class="line">    payRecord.setCreateDate(LocalDateTime.now());</span><br><span class="line">    payRecord.setStatus(<span class="string">"601001"</span>);<span class="comment">//未支付</span></span><br><span class="line">    payRecord.setUserId(orders.getUserId());</span><br><span class="line">    payRecordMapper.insert(payRecord);</span><br><span class="line">    <span class="keyword">return</span> payRecord;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h4 id="生成支付二维码-2"><a class="markdownIt-Anchor" href="#生成支付二维码-2"></a> 生成支付二维码</h4>
<ol>
<li>在nacos中order-service-dev.yaml配置二维码url</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">pay:</span></span><br><span class="line">  <span class="attr">qrcodeurl:</span> <span class="string">http://192.168.101.1/api/orders/requestpay?payNo=%s</span></span><br></pre></td></tr></table></figure>
<ol start="2">
<li>完善创建订单service方法</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Value("${pay.qrcodeurl}")</span></span><br><span class="line"><span class="keyword">private</span> String qrcodeUrl;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> PayRecordDto <span class="title function_">createOrder</span><span class="params">(String userId, AddOrderDto addOrderDto)</span> {</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//插入订单主表,订单明细表</span></span><br><span class="line">    <span class="type">XcOrders</span> <span class="variable">xcOrders</span> <span class="operator">=</span> saveXcOrders(userId, addOrderDto);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//插入支付记录</span></span><br><span class="line">    <span class="type">XcPayRecord</span> <span class="variable">xcPayRecord</span> <span class="operator">=</span> createPayRecord(xcOrders);</span><br><span class="line">    <span class="type">Long</span> <span class="variable">payNo</span> <span class="operator">=</span> xcPayRecord.getPayNo();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//生成支付二维码</span></span><br><span class="line">    <span class="type">QRCodeUtil</span> <span class="variable">qrCodeUtil</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">QRCodeUtil</span>();</span><br><span class="line">    <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> String.format(qrcodeUrl, payNo);</span><br><span class="line">    <span class="type">String</span> <span class="variable">qrCode</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        qrCode = qrCodeUtil.createQRCode(url, <span class="number">200</span>, <span class="number">200</span>);</span><br><span class="line">    } <span class="keyword">catch</span> (IOException e) {</span><br><span class="line">        XueChengPlusException.cast(<span class="string">"生成支付二维码失败"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="type">PayRecordDto</span> <span class="variable">payRecordDto</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PayRecordDto</span>();</span><br><span class="line">    BeanUtils.copyProperties(xcPayRecord, payRecordDto);</span><br><span class="line">    payRecordDto.setQrcode(qrCode);<span class="comment">//二维码</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> payRecordDto;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h4 id="生成二维码接口完善"><a class="markdownIt-Anchor" href="#生成二维码接口完善"></a> 生成二维码接口完善</h4>
<p>完善生成支付二维码controller接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">OrderService orderService;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ApiOperation("生成支付二维码")</span></span><br><span class="line"><span class="meta">@PostMapping("/generatepaycode")</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> PayRecordDto <span class="title function_">generatePayCode</span><span class="params">(<span class="meta">@RequestBody</span> AddOrderDto addOrderDto)</span> {</span><br><span class="line">    <span class="comment">//登录用户</span></span><br><span class="line">    SecurityUtil.<span class="type">XcUser</span> <span class="variable">user</span> <span class="operator">=</span> SecurityUtil.getUser();</span><br><span class="line">    <span class="keyword">if</span>(user == <span class="literal">null</span>){</span><br><span class="line">        XueChengPlusException.cast(<span class="string">"请登录后继续选课"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> orderService.createOrder(user.getId(), addOrderDto);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h4 id="扫码下单接口完善"><a class="markdownIt-Anchor" href="#扫码下单接口完善"></a> 扫码下单接口完善</h4>
<p>生成了支付二维码，用户扫码请求第三方支付平台下单、支付。</p>
<ol>
<li>定义查询支付交易记录的Service接口与实现方法</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据支付流水号查询支付记录</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> payNo 支付流水号</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 支付记录</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">XcPayRecord <span class="title function_">getPayRecordByPayno</span><span class="params">(String payNo)</span>;</span><br></pre></td></tr></table></figure>
<p>实现方法:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> XcPayRecord <span class="title function_">getPayRecordByPayno</span><span class="params">(String payNo)</span> {</span><br><span class="line">    <span class="comment">//根据支付流水号查询支付记录</span></span><br><span class="line">    <span class="keyword">return</span> xcPayRecordMapper.selectOne(<span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;XcPayRecord&gt;().eq(XcPayRecord::getPayNo, payNo));</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>下单接口</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiOperation("扫码下单接口")</span></span><br><span class="line"><span class="meta">@GetMapping("/requestpay")</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">requestpay</span><span class="params">(String payNo, HttpServletResponse httpResponse)</span> <span class="keyword">throws</span> IOException, AlipayApiException {</span><br><span class="line">    <span class="comment">//传入支付记录号,判断支付记录是否存在</span></span><br><span class="line">    <span class="type">XcPayRecord</span> <span class="variable">xcPayRecordByPayNo</span> <span class="operator">=</span> orderService.getPayRecordByPayno(payNo);</span><br><span class="line">    <span class="keyword">if</span> ( xcPayRecordByPayNo == <span class="literal">null</span> ) {</span><br><span class="line">        XueChengPlusException.cast(<span class="string">"支付记录不存在"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//判断有没有支付成功</span></span><br><span class="line">    <span class="keyword">if</span> ( <span class="string">"601002"</span>.equals(xcPayRecordByPayNo.getStatus()) ) {</span><br><span class="line">        XueChengPlusException.cast(<span class="string">"支付已经成功,无需重复支付"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//请求支付宝下单</span></span><br><span class="line">    <span class="type">AlipayClient</span> <span class="variable">alipayClient</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultAlipayClient</span>(AlipayConfig.URL, APP_ID, APP_PRIVATE_KEY, AlipayConfig.FORMAT, AlipayConfig.CHARSET, ALIPAY_PUBLIC_KEY, AlipayConfig.SIGNTYPE);</span><br><span class="line">    <span class="comment">//获得初始化的AlipayClient</span></span><br><span class="line">    <span class="type">AlipayTradeWapPayRequest</span> <span class="variable">alipayRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AlipayTradeWapPayRequest</span>();<span class="comment">//创建API对应的request</span></span><br><span class="line">    <span class="comment">//        alipayRequest.setReturnUrl("http://domain.com/CallBack/return_url.jsp");</span></span><br><span class="line">    <span class="comment">//alipayRequest.setNotifyUrl("http://318f68d075.vicp.fun:45930/orders/paynotify");//在公共参数中设置回跳和通知地址</span></span><br><span class="line">    alipayRequest.setBizContent(<span class="string">"{"</span> +</span><br><span class="line">                                <span class="string">"    \"out_trade_no\":\""</span> + payNo + <span class="string">"\","</span> +</span><br><span class="line">                                <span class="string">"    \"total_amount\":"</span> + xcPayRecordByPayNo.getTotalPrice() + <span class="string">","</span> +</span><br><span class="line">                                <span class="string">"    \"subject\":\""</span> + xcPayRecordByPayNo.getOrderName() + <span class="string">"\","</span> +</span><br><span class="line">                                <span class="string">"    \"product_code\":\"QUICK_WAP_WAY\""</span> +</span><br><span class="line">                                <span class="string">"  }"</span>);<span class="comment">//填充业务参数</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">form</span> <span class="operator">=</span> alipayClient.pageExecute(alipayRequest).getBody(); <span class="comment">//调用SDK生成表单</span></span><br><span class="line">    httpResponse.setContentType(<span class="string">"text/html;charset="</span> + AlipayConfig.CHARSET);</span><br><span class="line">    httpResponse.getWriter().write(form);<span class="comment">//直接将完整的表单html输出到页面</span></span><br><span class="line">    httpResponse.getWriter().flush();</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h3 id="支付测试"><a class="markdownIt-Anchor" href="#支付测试"></a> 支付测试</h3>
<p>测试准备：</p>
<ol>
<li>
<p>启动网关服务、认证服务、验证码服务、学习中心服务、订单服务、内容管理服务。</p>
</li>
<li>
<p>发布一门收费课程。</p>
</li>
<li>
<p>使用资料目录中的新模板course_template.ftl</p>
</li>
</ol>
<p>测试流程：</p>
<ol>
<li>
<p>进入收费课程详细页面，点击马上学习。</p>
</li>
<li>
<p>跟踪浏览器及微服务，观察选课记录是否创建成功、商品订单是否创建成功、支付交易记录是否创建成功。</p>
</li>
<li>
<p>观察生成二维码是否成功</p>
</li>
<li>
<p>使用模拟器扫码测试，是否可以正常支付。</p>
</li>
</ol>
<p>最终结果</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/Snipaste_2024-03-06_19-18-08.png" alt="Snipaste_2024-03-06_19-18-08"></p>
<p>手机沙箱测试成功</p>
<h2 id="查询支付结果"><a class="markdownIt-Anchor" href="#查询支付结果"></a> 查询支付结果</h2>
<h3 id="接口定义"><a class="markdownIt-Anchor" href="#接口定义"></a> 接口定义</h3>
<p>根据前边我们调研的获取支付结果的接口，包括：主动查询支付结果、被动接收支付结果。</p>
<p>这里先实现主动查询支付结果，当支付完成用户点击“支付结果”将请求第三方支付平台查询支付结果。</p>
<p>在<code>OrderController</code>类中定义接口如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiOperation("查询支付结果")</span></span><br><span class="line"><span class="meta">@GetMapping("/payresult")</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> PayRecordDto <span class="title function_">payresult</span><span class="params">(String payNo)</span> <span class="keyword">throws</span> IOException {</span><br><span class="line">    <span class="comment">//查询支付结果</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h3 id="接口实现"><a class="markdownIt-Anchor" href="#接口实现"></a> 接口实现</h3>
<h4 id="service总体接口"><a class="markdownIt-Anchor" href="#service总体接口"></a> <code>service</code>总体接口</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 查询支付结果</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> payNo 支付流水号</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 支付结果</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">PayRecordDto <span class="title function_">queryPayResult</span><span class="params">(String payNo)</span>;</span><br></pre></td></tr></table></figure>
<p><code>service</code>实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> PayRecordDto <span class="title function_">queryPayResult</span><span class="params">(String payNo)</span> <span class="keyword">throws</span> AlipayApiException {</span><br><span class="line">    <span class="comment">//调用支付宝接口查询结果</span></span><br><span class="line">    <span class="type">XcPayRecord</span> <span class="variable">payRecord</span> <span class="operator">=</span> getPayRecordByPayno(payNo);</span><br><span class="line">    <span class="keyword">if</span>(payRecord == <span class="literal">null</span>){</span><br><span class="line">        XueChengPlusException.cast(<span class="string">"请重新点击获取二维码"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//根据支付流水号查询支付记录</span></span><br><span class="line">    <span class="type">PayStatusDto</span> <span class="variable">payStatusDto</span> <span class="operator">=</span> queryPayResultFromAlipay(payNo);</span><br><span class="line">    System.out.println(<span class="string">"payStatusDto = "</span> + payStatusDto);</span><br><span class="line">    <span class="keyword">if</span>(payStatusDto == <span class="literal">null</span>){</span><br><span class="line">        XueChengPlusException.cast(<span class="string">"支付记录不存在"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">//保存支付宝支付结果</span></span><br><span class="line">    currentProxy.saveAliPayStatus(payStatusDto);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//返回最新支付记录信息</span></span><br><span class="line">    <span class="type">XcPayRecord</span> <span class="variable">payRecordByPayno</span> <span class="operator">=</span> getPayRecordByPayno(payNo);</span><br><span class="line">    <span class="type">PayRecordDto</span> <span class="variable">payRecordDto</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PayRecordDto</span>();</span><br><span class="line">    BeanUtils.copyProperties(payRecordByPayno, payRecordDto);</span><br><span class="line">    <span class="keyword">return</span> payRecordDto;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h4 id="查询支付结果-2"><a class="markdownIt-Anchor" href="#查询支付结果-2"></a> 查询支付结果</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 请求支付宝查询支付结果</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> payNo 支付交易号</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 支付结果</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="keyword">public</span> PayStatusDto <span class="title function_">queryPayResultFromAlipay</span><span class="params">(String payNo)</span> <span class="keyword">throws</span> AlipayApiException {</span><br><span class="line">    <span class="type">AlipayClient</span> <span class="variable">alipayClient</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultAlipayClient</span>(<span class="string">"https://openapi-sandbox.dl.alipaydev.com/gateway.do"</span>, APP_ID, APP_PRIVATE_KEY, AlipayConfig.FORMAT, AlipayConfig.CHARSET, ALIPAY_PUBLIC_KEY, AlipayConfig.SIGNTYPE);</span><br><span class="line">    <span class="type">AlipayTradeQueryRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AlipayTradeQueryRequest</span>();</span><br><span class="line">    <span class="type">JSONObject</span> <span class="variable">bizContent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">    bizContent.put(<span class="string">"out_trade_no"</span>, payNo);           <span class="comment">//out_trade_no和trade_no二选一即可</span></span><br><span class="line">    <span class="comment">//bizContent.put("trade_no", "2014112611001004680073956707");</span></span><br><span class="line">    request.setBizContent(bizContent.toString());</span><br><span class="line">    <span class="type">String</span> <span class="variable">resultJson</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span>{</span><br><span class="line">        <span class="type">AlipayTradeQueryResponse</span> <span class="variable">response</span> <span class="operator">=</span> alipayClient.execute(request);</span><br><span class="line">        <span class="comment">//交易不成功</span></span><br><span class="line">        <span class="keyword">if</span>(!response.isSuccess()){</span><br><span class="line">            XueChengPlusException.cast(<span class="string">"交易不成功"</span>);</span><br><span class="line">        }</span><br><span class="line">        resultJson = response.getBody();</span><br><span class="line">    }<span class="keyword">catch</span> (AlipayApiException e){</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        XueChengPlusException.cast(<span class="string">"调用支付宝查询接口失败"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//转map</span></span><br><span class="line">    <span class="type">Map</span> <span class="variable">resultMap</span> <span class="operator">=</span> JSON.parseObject(resultJson, Map.class);</span><br><span class="line">    <span class="type">Map</span> <span class="variable">alipay_trade_query_response</span> <span class="operator">=</span> (Map) resultMap.get(<span class="string">"alipay_trade_query_response"</span>);</span><br><span class="line">    <span class="comment">//支付结果</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">trade_status</span> <span class="operator">=</span> (String) alipay_trade_query_response.get(<span class="string">"trade_status"</span>);</span><br><span class="line">    <span class="type">String</span> <span class="variable">total_amount</span> <span class="operator">=</span> (String) alipay_trade_query_response.get(<span class="string">"total_amount"</span>);</span><br><span class="line">    <span class="type">String</span> <span class="variable">trade_no</span> <span class="operator">=</span> (String) alipay_trade_query_response.get(<span class="string">"trade_no"</span>);</span><br><span class="line">    <span class="comment">//保存支付结果</span></span><br><span class="line">    <span class="type">PayStatusDto</span> <span class="variable">payStatusDto</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PayStatusDto</span>();</span><br><span class="line">    payStatusDto.setOut_trade_no(payNo);</span><br><span class="line">    payStatusDto.setTrade_status(trade_status);</span><br><span class="line">    payStatusDto.setApp_id(APP_ID);</span><br><span class="line">    payStatusDto.setTrade_no(trade_no);</span><br><span class="line">    payStatusDto.setTotal_amount(total_amount);</span><br><span class="line">    <span class="keyword">return</span> payStatusDto;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h4 id="保存支付结果"><a class="markdownIt-Anchor" href="#保存支付结果"></a> 保存支付结果</h4>
<ol>
<li>定义接口</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 保存支付宝支付状态</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> payStatusDto 支付状态</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">saveAliPayStatus</span><span class="params">(PayStatusDto payStatusDto)</span>;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>实现</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveAliPayStatus</span><span class="params">(PayStatusDto payStatusDto)</span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">//如果支付成功</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">payNO</span> <span class="operator">=</span> payStatusDto.getOut_trade_no();</span><br><span class="line">    <span class="type">XcPayRecord</span> <span class="variable">payRecordByPayno</span> <span class="operator">=</span> getPayRecordByPayno(payNO);</span><br><span class="line">    <span class="keyword">if</span>(payRecordByPayno == <span class="literal">null</span>){</span><br><span class="line">        XueChengPlusException.cast(<span class="string">"找不到相关支付记录"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//拿到相关联订单id</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">orderId</span> <span class="operator">=</span> payRecordByPayno.getOrderId();</span><br><span class="line">    <span class="type">XcOrders</span> <span class="variable">xcOrders</span> <span class="operator">=</span> xcOrdersMapper.selectById(orderId);</span><br><span class="line">    <span class="keyword">if</span>(xcOrders == <span class="literal">null</span>){</span><br><span class="line">        XueChengPlusException.cast(<span class="string">"找不到相关订单"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//支付状态</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">statusFromDb</span> <span class="operator">=</span> payRecordByPayno.getStatus();</span><br><span class="line">    <span class="comment">//如果数据库支付状态已经成功,不再处理</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="string">"601002"</span>.equals(statusFromDb)){</span><br><span class="line">        <span class="comment">//支付已经成功</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//如果支付成功</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">tradeStatus</span> <span class="operator">=</span> payStatusDto.getTrade_status();</span><br><span class="line">    <span class="comment">//返回信息为支付成功</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="string">"TRADE_SUCCESS"</span>.equals(tradeStatus)){</span><br><span class="line">        <span class="comment">//更新支付记录表支付状态为支付成功</span></span><br><span class="line">        payRecordByPayno.setStatus(<span class="string">"601002"</span>);</span><br><span class="line">        <span class="comment">//支付宝订单号</span></span><br><span class="line">        payRecordByPayno.setOutPayNo(payStatusDto.getTrade_no());</span><br><span class="line">        <span class="comment">//第三方支付渠道编号</span></span><br><span class="line">        payRecordByPayno.setOutPayChannel(<span class="string">"Alipay"</span>);</span><br><span class="line">        <span class="comment">//支付成功时间</span></span><br><span class="line">        payRecordByPayno.setPaySuccessTime(LocalDateTime.now());</span><br><span class="line">        <span class="type">int</span> <span class="variable">update</span> <span class="operator">=</span> xcPayRecordMapper.updateById(payRecordByPayno);</span><br><span class="line">        <span class="keyword">if</span>(update &lt;= <span class="number">0</span>){</span><br><span class="line">            XueChengPlusException.cast(<span class="string">"更新支付记录失败"</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">//更新订单表支付状态为支付成功</span></span><br><span class="line">        xcOrders.setStatus(<span class="string">"600002"</span>);<span class="comment">//订单已经支付成功</span></span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">update1</span> <span class="operator">=</span> xcOrdersMapper.updateById(xcOrders);</span><br><span class="line">        <span class="keyword">if</span>(update1 &lt;= <span class="number">0</span>){</span><br><span class="line">            XueChengPlusException.cast(<span class="string">"更新订单失败"</span>);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h4 id="接口测试"><a class="markdownIt-Anchor" href="#接口测试"></a> 接口测试</h4>
<p>对界面扫码后查数据库验证即可</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240307183647563.png" alt="image-20240307183647563"></p>
<h4 id="接口问题"><a class="markdownIt-Anchor" href="#接口问题"></a> 接口问题</h4>
<p>由于雪花ID发送到前端会产生精度丢失,所以我们需要在后端的base包下处理格式</p>
<p>日后在遇到相同问题百度可以搜到相应答案</p>
<h2 id="接收支付通知"><a class="markdownIt-Anchor" href="#接收支付通知"></a> 接收支付通知</h2>
<h3 id="接口定义-2"><a class="markdownIt-Anchor" href="#接口定义-2"></a> 接口定义</h3>
<p>支付完成后第三方支付系统会主动通知支付结果，要实现主动通知需要在请求支付系统下单时传入NotifyUrl，这里有两个url：NotifyUrl和ReturnUrl，ReturnUrl是支付完成后支付系统携带支付结果重定向到ReturnUrl地址，NotifyUrl是支付完成后支付系统在后台定时去通知，使用NotifyUrl比使用ReturnUrl有保证。</p>
<p>根据接口描述：<a target="_blank" rel="noopener" href="https://opendocs.alipay.com/open/203/105286%E7%9A%84%E5%86%85%E5%AE%B9%E4%B8%8B%E8%BE%B9%E5%9C%A8%E8%AE%A2%E5%8D%95%E6%9C%8D%E5%8A%A1%E5%AE%9A%E4%B9%89%E6%8E%A5%E6%94%B6%E6%94%AF%E4%BB%98%E7%BB%93%E6%9E%9C%E9%80%9A%E7%9F%A5%E7%9A%84%E6%8E%A5%E5%8F%A3%E3%80%82">https://opendocs.alipay.com/open/203/105286的内容下边在订单服务定义接收支付结果通知的接口。</a></p>
<p>首先在下单时指定NotifyUrl:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiOperation("接收支付结果通知")</span></span><br><span class="line"><span class="meta">@PostMapping("/receivenotify")</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">receivenotify</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> IOException, AlipayApiException {</span><br><span class="line">    <span class="comment">//获取支付宝POST过来反馈信息</span></span><br><span class="line">    Map&lt;String, String&gt; params = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    <span class="type">Map</span> <span class="variable">requestParams</span> <span class="operator">=</span> request.getParameterMap();</span><br><span class="line">    <span class="keyword">for</span> ( <span class="type">Iterator</span> <span class="variable">iter</span> <span class="operator">=</span> requestParams.keySet().iterator(); iter.hasNext(); ) {</span><br><span class="line">        <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> (String) iter.next();</span><br><span class="line">        String[] values = (String[]) requestParams.get(name);</span><br><span class="line">        <span class="type">String</span> <span class="variable">valueStr</span> <span class="operator">=</span> <span class="string">""</span>;</span><br><span class="line">        <span class="keyword">for</span> ( <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; values.length; i++ ) {</span><br><span class="line">            valueStr = (i == values.length - <span class="number">1</span>) ? valueStr + values[i]</span><br><span class="line">                : valueStr + values[i] + <span class="string">","</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">//乱码解决，这段代码在出现乱码时使用。如果mysign和sign不相等也可以使用这段代码转化</span></span><br><span class="line">        <span class="comment">//valueStr = new String(valueStr.getBytes("ISO-8859-1"), "gbk");</span></span><br><span class="line">        params.put(name, valueStr);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">verify_result</span> <span class="operator">=</span> AlipaySignature.rsaCheckV1(params, ALIPAY_PUBLIC_KEY, AlipayConfig.CHARSET, <span class="string">"RSA2"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( verify_result ) {<span class="comment">//验证成功</span></span><br><span class="line">        <span class="comment">//获取支付宝的通知返回参数，可参考技术文档中页面跳转同步通知参数列表(以下仅供参考)//</span></span><br><span class="line">        <span class="comment">//商户订单号</span></span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">out_trade_no</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(request.getParameter(<span class="string">"out_trade_no"</span>).getBytes(<span class="string">"ISO-8859-1"</span>), <span class="string">"UTF-8"</span>);</span><br><span class="line">        <span class="comment">//支付宝交易号</span></span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">trade_no</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(request.getParameter(<span class="string">"trade_no"</span>).getBytes(<span class="string">"ISO-8859-1"</span>), <span class="string">"UTF-8"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//交易状态</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">trade_status</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(request.getParameter(<span class="string">"trade_status"</span>).getBytes(<span class="string">"ISO-8859-1"</span>), <span class="string">"UTF-8"</span>);</span><br><span class="line">        <span class="comment">//交易金额</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">total_amount</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(request.getParameter(<span class="string">"total_amount"</span>).getBytes(<span class="string">"ISO-8859-1"</span>), <span class="string">"UTF-8"</span>);</span><br><span class="line">        <span class="keyword">if</span> ( trade_status.equals(<span class="string">"TRADE_SUCCESS"</span>) ) {</span><br><span class="line">            <span class="comment">//更新支付记录表状态为成功,订单表未成功</span></span><br><span class="line">            <span class="type">PayStatusDto</span> <span class="variable">payStatusDto</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PayStatusDto</span>();</span><br><span class="line">            payStatusDto.setTrade_status(trade_status);</span><br><span class="line">            payStatusDto.setTrade_no(trade_no);</span><br><span class="line">            payStatusDto.setOut_trade_no(out_trade_no);</span><br><span class="line">            payStatusDto.setTotal_amount(total_amount);</span><br><span class="line">            payStatusDto.setApp_id(APP_ID);</span><br><span class="line">            orderService.saveAliPayStatus(payStatusDto);</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">//——请根据您的业务逻辑来编写程序（以上代码仅作参考）——</span></span><br><span class="line">        response.getWriter().write(<span class="string">"success"</span>);    <span class="comment">//请不要修改或删除</span></span><br><span class="line">    } <span class="keyword">else</span> {<span class="comment">//验证失败</span></span><br><span class="line">        response.getWriter().write(<span class="string">"fail"</span>);    <span class="comment">//请不要修改或删除</span></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>Service接口:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 保存支付宝支付状态</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> payStatusDto 支付状态</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">saveAliPayStatus</span><span class="params">(PayStatusDto payStatusDto)</span>;</span><br></pre></td></tr></table></figure>
<p>Service实现类:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveAliPayStatus</span><span class="params">(PayStatusDto payStatusDto)</span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">//如果支付成功</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">payNO</span> <span class="operator">=</span> payStatusDto.getOut_trade_no();</span><br><span class="line">    <span class="type">XcPayRecord</span> <span class="variable">payRecordByPayno</span> <span class="operator">=</span> getPayRecordByPayno(payNO);</span><br><span class="line">    <span class="keyword">if</span>(payRecordByPayno == <span class="literal">null</span>){</span><br><span class="line">        XueChengPlusException.cast(<span class="string">"找不到相关支付记录"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//拿到相关联订单id</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">orderId</span> <span class="operator">=</span> payRecordByPayno.getOrderId();</span><br><span class="line">    <span class="type">XcOrders</span> <span class="variable">xcOrders</span> <span class="operator">=</span> xcOrdersMapper.selectById(orderId);</span><br><span class="line">    <span class="keyword">if</span>(xcOrders == <span class="literal">null</span>){</span><br><span class="line">        XueChengPlusException.cast(<span class="string">"找不到相关订单"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//支付状态</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">statusFromDb</span> <span class="operator">=</span> payRecordByPayno.getStatus();</span><br><span class="line">    <span class="comment">//如果数据库支付状态已经成功,不再处理</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="string">"601002"</span>.equals(statusFromDb)){</span><br><span class="line">        <span class="comment">//支付已经成功</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//如果支付成功</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">tradeStatus</span> <span class="operator">=</span> payStatusDto.getTrade_status();</span><br><span class="line">    <span class="comment">//返回信息为支付成功</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="string">"TRADE_SUCCESS"</span>.equals(tradeStatus)){</span><br><span class="line">        <span class="comment">//更新支付记录表支付状态为支付成功</span></span><br><span class="line">        payRecordByPayno.setStatus(<span class="string">"601002"</span>);</span><br><span class="line">        <span class="comment">//支付宝订单号</span></span><br><span class="line">        payRecordByPayno.setOutPayNo(payStatusDto.getTrade_no());</span><br><span class="line">        <span class="comment">//第三方支付渠道编号</span></span><br><span class="line">        payRecordByPayno.setOutPayChannel(<span class="string">"Alipay"</span>);</span><br><span class="line">        <span class="comment">//支付成功时间</span></span><br><span class="line">        payRecordByPayno.setPaySuccessTime(LocalDateTime.now());</span><br><span class="line">        <span class="type">int</span> <span class="variable">update</span> <span class="operator">=</span> xcPayRecordMapper.updateById(payRecordByPayno);</span><br><span class="line">        <span class="keyword">if</span>(update &lt;= <span class="number">0</span>){</span><br><span class="line">            XueChengPlusException.cast(<span class="string">"更新支付记录失败"</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">//更新订单表支付状态为支付成功</span></span><br><span class="line">        xcOrders.setStatus(<span class="string">"600002"</span>);<span class="comment">//订单已经支付成功</span></span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">update1</span> <span class="operator">=</span> xcOrdersMapper.updateById(xcOrders);</span><br><span class="line">        <span class="keyword">if</span>(update1 &lt;= <span class="number">0</span>){</span><br><span class="line">            XueChengPlusException.cast(<span class="string">"更新订单失败"</span>);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h3 id="接口测试-2"><a class="markdownIt-Anchor" href="#接口测试-2"></a> 接口测试</h3>
<p>测试准备：</p>
<ol>
<li>
<p>启动网关服务、认证服务、验证码服务、学习中心服务、内容管理服务。</p>
</li>
<li>
<p>发布一门收费课程。</p>
</li>
</ol>
<p>测试流程：</p>
<ol>
<li>
<p>对选课进行支付</p>
</li>
<li>
<p>支付成功跟踪service方法的日志，支付成功需要更新支付交易表记录的状态、通知时间、支付宝交易号、支付渠道(Alipay)</p>
</li>
</ol>
<p>支付成功更新订单表的状态为空。</p>
<h1 id="支付通知"><a class="markdownIt-Anchor" href="#支付通知"></a> 支付通知</h1>
<h2 id="需求分析-2"><a class="markdownIt-Anchor" href="#需求分析-2"></a> 需求分析</h2>
<p>订单服务作为通用服务在订单支付成功后需要将支付结果异步通知给其它微服务。</p>
<p>下图使用了消息队列完成支付结果通知：</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240309162829957.png" alt="image-20240309162829957"></p>
<p>学习中心服务：对收费课程选课需要支付，与订单服务对接完成支付。</p>
<p>学习资源服务：对收费的学习资料需要购买后下载，与订单服务对接完成支付。</p>
<p>订单服务完成支付后将支付结果发给每一个与订单服务对接的微服务，订单服务将消息发给交换机，由交换机广播消息，每个订阅消息的微服务都可以接收到支付结果.</p>
<p>微服务收到支付结果根据订单的类型去更新自己的业务数据。</p>
<h2 id="技术方案"><a class="markdownIt-Anchor" href="#技术方案"></a> 技术方案</h2>
<p>使用消息队列进行异步通知需要保证消息的可靠性，即生产端将消息成功通知到消费端。</p>
<p>消息从生产端发送到消费端经历了如下过程：</p>
<ol>
<li>
<p>消息发送到交换机</p>
</li>
<li>
<p>消息由交换机发送到队列</p>
</li>
<li>
<p>消息者收到消息进行处理</p>
</li>
</ol>
<p>保证消息的可靠性需要保证以上过程的可靠性，本项目使用RabbitMQ可以通过如下方面保证消息的可靠性。</p>
<ol>
<li>生产者确认机制</li>
</ol>
<p>发送消息前使用数据库事务将消息保证到数据库表中</p>
<p>成功发送到交换机将消息从数据库中删除</p>
<ol start="2">
<li>mq持久化</li>
</ol>
<p>mq收到消息进行持久化，当mq重启即使消息没有消费完也不会丢失。</p>
<p>需要配置交换机持久化、队列持久化、发送消息时设置持久化。</p>
<p>3、消费者确认机制</p>
<p>消费者消费成功自动发送ack，否则重试消费。</p>
<h2 id="发送支付结果"><a class="markdownIt-Anchor" href="#发送支付结果"></a> 发送支付结果</h2>
<h3 id="订单集成服务mq"><a class="markdownIt-Anchor" href="#订单集成服务mq"></a> 订单集成服务MQ</h3>
<p>订单服务通过消息队列将支付结果发给学习中心服务，消息队列采用发布订阅模式。</p>
<ol>
<li>
<p>订单服务创建支付结果通知交换机。</p>
</li>
<li>
<p>学习中心服务绑定队列到交换机。</p>
</li>
</ol>
<p>项目使用RabbitMQ作为消息队列，在课前下发的虚拟上已经安装了RabbitMQ.</p>
<p>执行docker start rabbitmq 启动RabbitMQ。访问：<a target="_blank" rel="noopener" href="http://192.168.101.65:15672/">http://192.168.101.65:15672/</a></p>
<p>账户密码：guest/guest</p>
<p>交换机为Fanout广播模式。</p>
<p>首先需要在学习中心服务和订单服务工程配置连接消息队列。</p>
<ol>
<li>首先在订单服务添加消息队列依赖</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ol start="2">
<li>在nacos配置rabbitmq-dev.yaml为通用配置文件</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.101</span><span class="number">.65</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">guest</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">guest</span></span><br><span class="line">    <span class="attr">virtual-host:</span> <span class="string">/</span></span><br><span class="line">    <span class="attr">publisher-confirm-type:</span> <span class="string">correlated</span> <span class="comment">#correlated 异步回调，定义ConfirmCallback，MQ返回结果时会回调这个ConfirmCallback</span></span><br><span class="line">    <span class="attr">publisher-returns:</span> <span class="literal">false</span> <span class="comment">#开启publish-return功能，同样是基于callback机制，需要定义ReturnCallback</span></span><br><span class="line">    <span class="attr">template:</span></span><br><span class="line">      <span class="attr">mandatory:</span> <span class="literal">false</span> <span class="comment">#定义消息路由失败时的策略。true，则调用ReturnCallback；false：则直接丢弃消息</span></span><br><span class="line">    <span class="attr">listener:</span></span><br><span class="line">      <span class="attr">simple:</span></span><br><span class="line">        <span class="attr">acknowledge-mode:</span> <span class="string">none</span> <span class="comment">#出现异常时返回unack，消息回滚到mq；没有异常，返回ack ,manual:手动控制,none:丢弃消息，不回滚到mq</span></span><br><span class="line">        <span class="attr">retry:</span></span><br><span class="line">          <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment">#开启消费者失败重试</span></span><br><span class="line">          <span class="attr">initial-interval:</span> <span class="string">1000ms</span> <span class="comment">#初识的失败等待时长为1秒</span></span><br><span class="line">          <span class="attr">multiplier:</span> <span class="number">1</span> <span class="comment">#失败的等待时长倍数，下次等待时长 = multiplier * last-interval</span></span><br><span class="line">          <span class="attr">max-attempts:</span> <span class="number">3</span> <span class="comment">#最大重试次数</span></span><br><span class="line">          <span class="attr">stateless:</span> <span class="literal">true</span> <span class="comment">#true无状态；false有状态。如果业务中包含事务，这里改为false</span></span><br></pre></td></tr></table></figure>
<ol start="3">
<li>在订单服务接口工程引入rabbitmq-dev.yaml配置文件</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">shared-configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">data-id:</span> <span class="string">rabbitmq-${spring.profiles.active}.yaml</span></span><br><span class="line">    <span class="attr">group:</span> <span class="string">xuecheng-plus-common</span></span><br><span class="line">    <span class="attr">refresh:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<ol start="4">
<li>在订单服务service工程编写MQ配置类，配置交换机</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PayNotifyConfig</span> <span class="keyword">implements</span> <span class="title class_">ApplicationContextAware</span> {</span><br><span class="line"></span><br><span class="line">    <span class="comment">//交换机</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PAYNOTIFY_EXCHANGE_FANOUT</span> <span class="operator">=</span> <span class="string">"paynotify_exchange_fanout"</span>;</span><br><span class="line">    <span class="comment">//支付结果通知消息类型</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">MESSAGE_TYPE</span> <span class="operator">=</span> <span class="string">"payresult_notify"</span>;</span><br><span class="line">    <span class="comment">//支付通知队列</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PAYNOTIFY_QUEUE</span> <span class="operator">=</span> <span class="string">"paynotify_queue"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//声明交换机，且持久化</span></span><br><span class="line">    <span class="meta">@Bean(PAYNOTIFY_EXCHANGE_FANOUT)</span></span><br><span class="line">    <span class="keyword">public</span> FanoutExchange <span class="title function_">paynotify_exchange_fanout</span><span class="params">()</span> {</span><br><span class="line">        <span class="comment">// 三个参数：交换机名称、是否持久化、当没有queue与其绑定时是否自动删除</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">FanoutExchange</span>(PAYNOTIFY_EXCHANGE_FANOUT, <span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//支付通知队列,且持久化</span></span><br><span class="line">    <span class="meta">@Bean(PAYNOTIFY_QUEUE)</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">course_publish_queue</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> QueueBuilder.durable(PAYNOTIFY_QUEUE).build();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">//交换机和支付通知队列绑定</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">binding_course_publish_queue</span><span class="params">(<span class="meta">@Qualifier(PAYNOTIFY_QUEUE)</span> Queue queue, <span class="meta">@Qualifier(PAYNOTIFY_EXCHANGE_FANOUT)</span> FanoutExchange exchange)</span> {</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queue).to(exchange);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setApplicationContext</span><span class="params">(ApplicationContext applicationContext)</span> <span class="keyword">throws</span> BeansException {</span><br><span class="line">        <span class="comment">// 获取RabbitTemplate</span></span><br><span class="line">        <span class="type">RabbitTemplate</span> <span class="variable">rabbitTemplate</span> <span class="operator">=</span> applicationContext.getBean(RabbitTemplate.class);</span><br><span class="line">        <span class="comment">//消息处理service</span></span><br><span class="line">        <span class="type">MqMessageService</span> <span class="variable">mqMessageService</span> <span class="operator">=</span> applicationContext.getBean(MqMessageService.class);</span><br><span class="line">        <span class="comment">// 设置ReturnCallback</span></span><br><span class="line">        rabbitTemplate.setReturnCallback((message, replyCode, replyText, exchange, routingKey) -&gt; {</span><br><span class="line">            <span class="comment">// 投递失败，记录日志</span></span><br><span class="line">            log.info(<span class="string">"消息发送失败，应答码{}，原因{}，交换机{}，路由键{},消息{}"</span>,</span><br><span class="line">                     replyCode, replyText, exchange, routingKey, message.toString());</span><br><span class="line">            <span class="type">MqMessage</span> <span class="variable">mqMessage</span> <span class="operator">=</span> JSON.parseObject(message.toString(), MqMessage.class);</span><br><span class="line">            <span class="comment">//将消息再添加到消息表</span></span><br><span class="line">            mqMessageService.addMessage(mqMessage.getMessageType(),mqMessage.getBusinessKey1(),mqMessage.getBusinessKey2(),mqMessage.getBusinessKey3());</span><br><span class="line"></span><br><span class="line">        });</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h3 id="发送支付结果-2"><a class="markdownIt-Anchor" href="#发送支付结果-2"></a> 发送支付结果</h3>
<p>在OrderService中定义接口:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 发送通知结果</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> message</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">notifyPayResult</span><span class="params">(MqMessage message)</span>;</span><br></pre></td></tr></table></figure>
<p>编写接口实现方法:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">notifyPayResult</span><span class="params">(MqMessage message)</span> {</span><br><span class="line"></span><br><span class="line">    <span class="comment">//消息内容</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">jsonString</span> <span class="operator">=</span> JSON.toJSONString(message);</span><br><span class="line"></span><br><span class="line">    <span class="type">Message</span> <span class="variable">messageObj</span> <span class="operator">=</span> MessageBuilder.withBody(jsonString.getBytes(StandardCharsets.UTF_8))</span><br><span class="line">        .setDeliveryMode(MessageDeliveryMode.PERSISTENT).build();</span><br><span class="line">    <span class="comment">//全局消息ID</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">id</span> <span class="operator">=</span> message.getId();</span><br><span class="line">    <span class="type">CorrelationData</span> <span class="variable">correlationData</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CorrelationData</span>();</span><br><span class="line">    <span class="comment">//使用CorrelationData对象指定回调方法</span></span><br><span class="line">    correlationData.getFuture().addCallback(</span><br><span class="line">        result -&gt; {</span><br><span class="line">            <span class="keyword">if</span>(result.isAck()){</span><br><span class="line">                <span class="comment">//消息成功发送到交换机</span></span><br><span class="line">                log.info(<span class="string">"消息成功发送到交换机:{}"</span>,jsonString);</span><br><span class="line">                <span class="comment">//将消息从数据库表删除</span></span><br><span class="line">                mqMessageService.completed(id);</span><br><span class="line">            }<span class="keyword">else</span>{</span><br><span class="line">                <span class="comment">//消息发送到交换机失败</span></span><br><span class="line">                log.info(<span class="string">"消息发送到交换机失败:{}"</span>,jsonString);</span><br><span class="line">            }</span><br><span class="line">        },</span><br><span class="line">        ex -&gt; {</span><br><span class="line">            <span class="comment">//发生异常了</span></span><br><span class="line">            log.info(<span class="string">"消息发送到交换机异常:{}"</span>,jsonString);</span><br><span class="line">        }</span><br><span class="line">    );</span><br><span class="line">    rabbitTemplate.convertAndSend(PayNotifyConfig.PAYNOTIFY_EXCHANGE_FANOUT, <span class="string">""</span>, messageObj, correlationData);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>订单服务收到第三方平台的支付结果时，在saveAliPayStatus方法中添加代码，向数据库消息表添加消息并进行发送消息，如下所示:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//保存消息记录,参数1：支付结果通知类型，2: 业务id，3:业务类型</span></span><br><span class="line"><span class="type">MqMessage</span> <span class="variable">payresultNotify</span> <span class="operator">=</span> mqMessageService.addMessage(<span class="string">"payresult_notify"</span>,</span><br><span class="line">                                                        xcOrders.getOutBusinessId(),</span><br><span class="line">                                                        xcOrders.getOrderType(),</span><br><span class="line">                                                        <span class="literal">null</span>);</span><br><span class="line"><span class="comment">//发送消息</span></span><br><span class="line">notifyPayResult(payresultNotify);</span><br></pre></td></tr></table></figure>
<h2 id="接收支付结果"><a class="markdownIt-Anchor" href="#接收支付结果"></a> 接收支付结果</h2>
<h3 id="学习中心服务集成mq"><a class="markdownIt-Anchor" href="#学习中心服务集成mq"></a> 学习中心服务集成MQ</h3>
<ol>
<li>在学习中心服务添加消息队列依赖</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ol start="2">
<li>在学习中心服务接口工程引入rabbitmq-dev.yaml配置文件</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">shared-configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">data-id:</span> <span class="string">rabbitmq-${spring.profiles.active}.yaml</span></span><br><span class="line">    <span class="attr">group:</span> <span class="string">xuecheng-plus-common</span></span><br><span class="line">    <span class="attr">refresh:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<ol start="3">
<li>添加配置类</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PayNotifyConfig</span> {</span><br><span class="line"></span><br><span class="line">    <span class="comment">//交换机</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PAYNOTIFY_EXCHANGE_FANOUT</span> <span class="operator">=</span> <span class="string">"paynotify_exchange_fanout"</span>;</span><br><span class="line">    <span class="comment">//支付结果通知消息类型</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">MESSAGE_TYPE</span> <span class="operator">=</span> <span class="string">"payresult_notify"</span>;</span><br><span class="line">    <span class="comment">//支付通知队列</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PAYNOTIFY_QUEUE</span> <span class="operator">=</span> <span class="string">"paynotify_queue"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//声明交换机，且持久化</span></span><br><span class="line">    <span class="meta">@Bean(PAYNOTIFY_EXCHANGE_FANOUT)</span></span><br><span class="line">    <span class="keyword">public</span> FanoutExchange <span class="title function_">paynotify_exchange_fanout</span><span class="params">()</span> {</span><br><span class="line">        <span class="comment">// 三个参数：交换机名称、是否持久化、当没有queue与其绑定时是否自动删除</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">FanoutExchange</span>(PAYNOTIFY_EXCHANGE_FANOUT, <span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//支付通知队列,且持久化</span></span><br><span class="line">    <span class="meta">@Bean(PAYNOTIFY_QUEUE)</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">course_publish_queue</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> QueueBuilder.durable(PAYNOTIFY_QUEUE).build();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">//交换机和支付通知队列绑定</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">binding_course_publish_queue</span><span class="params">(<span class="meta">@Qualifier(PAYNOTIFY_QUEUE)</span> Queue queue, <span class="meta">@Qualifier(PAYNOTIFY_EXCHANGE_FANOUT)</span> FanoutExchange exchange)</span> {</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queue).to(exchange);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h3 id="接收支付结果-2"><a class="markdownIt-Anchor" href="#接收支付结果-2"></a> 接收支付结果</h3>
<ol>
<li>新建Service来接收支付结果</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.learning.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.base.exception.XueChengPlusException;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.learning.config.PayNotifyConfig;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.learning.service.MyCourseTableService;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.messagesdk.model.po.MqMessage;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Message;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Wwh</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ProjectName</span> xuecheng-plus-project</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@dateTime</span> 2024/3/9 17:11</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 支付通知服务</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReceivePayNotifyService</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MyCourseTableService myCourseTableService;</span><br><span class="line">    <span class="meta">@RabbitListener(queues = PayNotifyConfig.PAYNOTIFY_QUEUE)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">receivePayNotify</span><span class="params">(Message message)</span> {</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            Thread.sleep(<span class="number">5000</span>);</span><br><span class="line">        } <span class="keyword">catch</span> (InterruptedException e) {</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        }</span><br><span class="line">        log.info(<span class="string">"接收到支付通知消息：{}"</span>, message);</span><br><span class="line">        <span class="type">byte</span>[] body = message.getBody();</span><br><span class="line">        <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(body);</span><br><span class="line">        <span class="comment">//转为对象</span></span><br><span class="line">        <span class="type">MqMessage</span> <span class="variable">mqMessage</span> <span class="operator">=</span> JSON.parseObject(msg, MqMessage.class);</span><br><span class="line">        <span class="comment">//解析消息内容</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//选课ID</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">chooseCourseId</span> <span class="operator">=</span> mqMessage.getBusinessKey1();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取订单类型</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">orderType</span> <span class="operator">=</span> mqMessage.getBusinessKey2();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//学习中心类服务只要购买课程的支付订单结果</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="string">"60201"</span>.equals(orderType)){</span><br><span class="line">            <span class="comment">//支付成功</span></span><br><span class="line">            <span class="comment">//根据消息内容,更新选课记录,像我的课程表添加课程</span></span><br><span class="line">            <span class="type">boolean</span> <span class="variable">b</span> <span class="operator">=</span> myCourseTableService.saveChooseCourseSuccess(chooseCourseId);</span><br><span class="line">            <span class="keyword">if</span>(!b){</span><br><span class="line">                XueChengPlusException.cast(<span class="string">"保存选课记录失败"</span>);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>在MyCourseTableService中添加</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> courseId 课程id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> boolean</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 保存选课成功记录，用于后续查询学习状态，是否已经选课等等</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">boolean</span> <span class="title function_">saveChooseCourseSuccess</span><span class="params">(String courseId)</span>;</span><br></pre></td></tr></table></figure>
<p>实现方法:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">saveChooseCourseSuccess</span><span class="params">(String courseId)</span> {</span><br><span class="line">    <span class="comment">//防止脏数据</span></span><br><span class="line">    <span class="comment">//根据选课ID查询选课记录</span></span><br><span class="line">    <span class="type">XcChooseCourse</span> <span class="variable">xcChooseCourse</span> <span class="operator">=</span> xcChooseCourseMapper.selectById(courseId);</span><br><span class="line">    <span class="keyword">if</span> ( xcChooseCourse == <span class="literal">null</span> ) {</span><br><span class="line">        log.debug(<span class="string">"接收到购买课程信息,但选课记录不存在,选课ID:{}"</span>, courseId);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//选课状态</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">status</span> <span class="operator">=</span> xcChooseCourse.getStatus();</span><br><span class="line">    <span class="comment">//未支付时才更新为已支付</span></span><br><span class="line">    <span class="keyword">if</span> ( status.equals(<span class="string">"701002"</span>) ) {</span><br><span class="line">        <span class="comment">//更新选课记录为成功</span></span><br><span class="line">        xcChooseCourse.setStatus(<span class="string">"701001"</span>);</span><br><span class="line">        <span class="comment">//向我的课程表插入数据</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">insert</span> <span class="operator">=</span> xcChooseCourseMapper.updateById(xcChooseCourse);</span><br><span class="line">        <span class="keyword">if</span>(insert &lt;= <span class="number">0</span>){</span><br><span class="line">            log.debug(<span class="string">"更新选课记录失败,选课ID:{}"</span>, courseId);</span><br><span class="line">            XueChengPlusException.cast(<span class="string">"更新选课记录失败"</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">//向我的课程表插入</span></span><br><span class="line">        <span class="type">XcCourseTables</span> <span class="variable">xcCourseTables</span> <span class="operator">=</span> addCourseTabls(xcChooseCourse);</span><br><span class="line">        <span class="keyword">if</span>(xcCourseTables == <span class="literal">null</span>){</span><br><span class="line">            log.debug(<span class="string">"向我的课程表插入数据失败,选课ID:{}"</span>, courseId);</span><br><span class="line">            XueChengPlusException.cast(<span class="string">"向我的课程表插入数据失败"</span>);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h2 id="通知支付结果测试"><a class="markdownIt-Anchor" href="#通知支付结果测试"></a> 通知支付结果测试</h2>
<p><strong>通知支付结果测试</strong></p>
<p>测试准备：</p>
<ol>
<li>
<p>找一门已发布的收费课程。</p>
</li>
<li>
<p>如果在我的课程表存储则删除。</p>
</li>
<li>
<p>删除此课程的选课记录及订单信息。</p>
</li>
</ol>
<p>测试流程：</p>
<ol>
<li>
<p>进入课程详细页面，点击马上学习，生成二维码进行支付。</p>
</li>
<li>
<p>支付完成点击“支付完成”，观察订单服务控制台是否发送消息。</p>
</li>
<li>
<p>观察学习中心服务控制台是否接收到消息。</p>
</li>
<li>
<p>观察数据库中的消息表的相应记录是否已删除。</p>
</li>
</ol>
<p>消费重试测试：</p>
<ol>
<li>
<p>在学习中心服务接收支付结果方法中制造异常。</p>
</li>
<li>
<p>重新执行上边的测试流程，观察是否消费重试。</p>
</li>
</ol>

    </div>

    
    
    <div class="post-widgets">
      <div id="needsharebutton-postbottom">
        <span class="btn">
          <i class="fa fa-share-alt" aria-hidden="true"></i>
        </span>
      </div>
    </div>
        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>Wwhds
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="https://wwhdsone.github.io/2024/03/21/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFDay12/" title="学成在线Day12">https://wwhdsone.github.io/2024/03/21/学成在线Day12/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/zh-CN" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Java/" rel="tag"><i class="fa fa-tag"></i> Java</a>
              <a href="/tags/%E5%AD%A6%E4%B9%A0/" rel="tag"><i class="fa fa-tag"></i> 学习</a>
              <a href="/tags/%E5%90%8E%E7%AB%AF/" rel="tag"><i class="fa fa-tag"></i> 后端</a>
              <a href="/tags/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98/" rel="tag"><i class="fa fa-tag"></i> 黑马程序员</a>
              <a href="/tags/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF/" rel="tag"><i class="fa fa-tag"></i> 学成在线</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2024/03/21/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFDay11/" rel="prev" title="学成在线Day11">
      <i class="fa fa-chevron-left"></i> 学成在线Day11
    </a></div>
      <div class="post-nav-item">
    <a href="/2024/03/21/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFDay13/" rel="next" title="学成在线Day13">
      学成在线Day13 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="gitalk-container"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday12"><span class="nav-text"> 学成在线Day12</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%94%9F%E6%88%90%E6%94%AF%E4%BB%98%E4%BA%8C%E7%BB%B4%E7%A0%81"><span class="nav-text"> 生成支付二维码</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90"><span class="nav-text"> 需求分析</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B"><span class="nav-text"> 执行流程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B"><span class="nav-text"> 数据模型</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91"><span class="nav-text"> 接口开发</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BF%9D%E5%AD%98%E5%95%86%E5%93%81%E8%AE%A2%E5%8D%95"><span class="nav-text"> 保存商品订单</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E6%94%AF%E4%BB%98%E4%BA%A4%E6%98%93%E8%AE%B0%E5%BD%95"><span class="nav-text"> 创建支付交易记录</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%94%9F%E6%88%90%E6%94%AF%E4%BB%98%E4%BA%8C%E7%BB%B4%E7%A0%81-2"><span class="nav-text"> 生成支付二维码</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%94%9F%E6%88%90%E4%BA%8C%E7%BB%B4%E7%A0%81%E6%8E%A5%E5%8F%A3%E5%AE%8C%E5%96%84"><span class="nav-text"> 生成二维码接口完善</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%89%AB%E7%A0%81%E4%B8%8B%E5%8D%95%E6%8E%A5%E5%8F%A3%E5%AE%8C%E5%96%84"><span class="nav-text"> 扫码下单接口完善</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%94%AF%E4%BB%98%E6%B5%8B%E8%AF%95"><span class="nav-text"> 支付测试</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9F%A5%E8%AF%A2%E6%94%AF%E4%BB%98%E7%BB%93%E6%9E%9C"><span class="nav-text"> 查询支付结果</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89"><span class="nav-text"> 接口定义</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8E%A5%E5%8F%A3%E5%AE%9E%E7%8E%B0"><span class="nav-text"> 接口实现</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#service%E6%80%BB%E4%BD%93%E6%8E%A5%E5%8F%A3"><span class="nav-text"> service总体接口</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9F%A5%E8%AF%A2%E6%94%AF%E4%BB%98%E7%BB%93%E6%9E%9C-2"><span class="nav-text"> 查询支付结果</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BF%9D%E5%AD%98%E6%94%AF%E4%BB%98%E7%BB%93%E6%9E%9C"><span class="nav-text"> 保存支付结果</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8E%A5%E5%8F%A3%E6%B5%8B%E8%AF%95"><span class="nav-text"> 接口测试</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8E%A5%E5%8F%A3%E9%97%AE%E9%A2%98"><span class="nav-text"> 接口问题</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8E%A5%E6%94%B6%E6%94%AF%E4%BB%98%E9%80%9A%E7%9F%A5"><span class="nav-text"> 接收支付通知</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89-2"><span class="nav-text"> 接口定义</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8E%A5%E5%8F%A3%E6%B5%8B%E8%AF%95-2"><span class="nav-text"> 接口测试</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%94%AF%E4%BB%98%E9%80%9A%E7%9F%A5"><span class="nav-text"> 支付通知</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90-2"><span class="nav-text"> 需求分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8A%80%E6%9C%AF%E6%96%B9%E6%A1%88"><span class="nav-text"> 技术方案</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%91%E9%80%81%E6%94%AF%E4%BB%98%E7%BB%93%E6%9E%9C"><span class="nav-text"> 发送支付结果</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AE%A2%E5%8D%95%E9%9B%86%E6%88%90%E6%9C%8D%E5%8A%A1mq"><span class="nav-text"> 订单集成服务MQ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%91%E9%80%81%E6%94%AF%E4%BB%98%E7%BB%93%E6%9E%9C-2"><span class="nav-text"> 发送支付结果</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8E%A5%E6%94%B6%E6%94%AF%E4%BB%98%E7%BB%93%E6%9E%9C"><span class="nav-text"> 接收支付结果</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AD%A6%E4%B9%A0%E4%B8%AD%E5%BF%83%E6%9C%8D%E5%8A%A1%E9%9B%86%E6%88%90mq"><span class="nav-text"> 学习中心服务集成MQ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8E%A5%E6%94%B6%E6%94%AF%E4%BB%98%E7%BB%93%E6%9E%9C-2"><span class="nav-text"> 接收支付结果</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%80%9A%E7%9F%A5%E6%94%AF%E4%BB%98%E7%BB%93%E6%9E%9C%E6%B5%8B%E8%AF%95"><span class="nav-text"> 通知支付结果测试</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Wwhds"
      src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/Markdown%E4%BD%BF%E7%94%A8/w.jpg">
  <p class="site-author-name" itemprop="name">Wwhds</p>
  <div class="site-description" itemprop="description">个人博客</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">18</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">13</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/WwhdsOne" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;WwhdsOne" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:a1605691832@163.com" title="E-Mail → mailto:a1605691832@163.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://qm.qq.com/q/A18mWRc5YQ" title="QQ → https:&#x2F;&#x2F;qm.qq.com&#x2F;q&#x2F;A18mWRc5YQ" rel="noopener" target="_blank"><i class="fab fa-qq fa-lg fa-fw"></i>QQ</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://space.bilibili.com/85778548?spm_id_from=333.1007.0.0" title="Bilibili → https:&#x2F;&#x2F;space.bilibili.com&#x2F;85778548?spm_id_from&#x3D;333.1007.0.0" rel="noopener" target="_blank"><i class="fa custom bilibili fa-fw"></i>Bilibili</a>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/zh-CN" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Wwhds</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="站点总字数">249k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">7:33</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

  <script src='https://unpkg.com/mermaid@/dist/mermaid.min.js'></script>
  <script>
    if (window.mermaid) {
      mermaid.initialize({theme: 'forest'});
    }
  </script>

<div>
  <span id="timeDate">载入天数...</span>
  <script>
      var now = new Date(); 
      function createtime() { 
          var grt = new Date("03/18/2024 00:00:00");//在此处修改你的建站时间
          now.setTime(now.getTime()+250); 
          days = (now - grt ) / 1000 / 60 / 60 / 24; dnum = Math.floor(days); 
          document.getElementById("timeDate").innerHTML = "已运行 "+dnum+" 天 "; 
      } 
  setInterval("createtime()",250);
  </script>
</div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>











<script>
if (document.querySelectorAll('pre.mermaid').length) {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js', () => {
    mermaid.initialize({
      theme    : 'forest',
      logLevel : 3,
      flowchart: { curve     : 'linear' },
      gantt    : { axisFormat: '%m/%d/%Y' },
      sequence : { actorMargin: 50 }
    });
  }, window.mermaid);
}
</script>


  

  
      
<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/katex@0/dist/katex.min.css">


  
<script src="https://cdn.jsdelivr.net/npm/darkmode-js@1.5.7/lib/darkmode-js.min.js"></script>

<script>
var options = {
  bottom: '64px',
  right: '32px',
  left: 'unset',
  time: '1s',
  mixColor: 'transparent',
  backgroundColor: 'transparent',
  buttonColorDark: '#fff',
  buttonColorLight: '#fff',
  saveInCookies: true,
  label: '模式切换',
  autoMatchOsTheme: true
}
const darkmode = new Darkmode(options);
window.darkmode = darkmode;
darkmode.showWidget();
</script>

  <script src="//cdn.jsdelivr.net/gh/theme-next/theme-next-needmoreshare2@1/needsharebutton.min.js"></script>
  <script>
      pbOptions = {};
        pbOptions.iconStyle = "box";
        pbOptions.boxForm = "horizontal";
        pbOptions.position = "bottomCenter";
        pbOptions.networks = "Wechat,QQZone,Weibo,Douban,Twitter,Facebook";
      new needShareButton('#needsharebutton-postbottom', pbOptions);
  </script>
<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.css">

<script>
NexT.utils.loadComments(document.querySelector('#gitalk-container'), () => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js', () => {
    var gitalk = new Gitalk({
      clientID    : '402f0a321164611a3faa',
      clientSecret: '0857efbac20d76b6f97010056772c1069e03fabe',
      repo        : 'Wblog_Comments',
      owner       : 'WwhdsOne',
      admin       : ['WwhdsOne'],
      id          : '854838c36b03a1a0a7c91055202442e4',
        language: 'zh-CN',
      distractionFreeMode: false
    });
    gitalk.render('gitalk-container');
  }, window.Gitalk);
});
</script>

</body>
</html>
