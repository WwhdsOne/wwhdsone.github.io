<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.1.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/MdiAlphaWCircle.svg">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/MdiAlphaWCircle.svg">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/MdiAlphaWCircle.svg">
  <link rel="mask-icon" href="/images/MdiAlphaWCircle.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.loli.net/css?family=Noto Sans SC:300,300italic,400,400italic,700,700italic|Fira Code:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pace-js@latest/themes/black/pace-theme-center-atom.css">
  <script src="//cdn.jsdelivr.net/npm/pace-js@latest/pace.min.js"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"wwhdsone.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"gitalk","storage":true,"lazyload":false,"nav":null,"activeClass":"gitalk"},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":true,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="学成在线Day11内容">
<meta property="og:type" content="article">
<meta property="og:title" content="学成在线Day11">
<meta property="og:url" content="https://wwhdsone.github.io/2024/03/21/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFDay11/index.html">
<meta property="og:site_name" content="WBlog">
<meta property="og:description" content="学成在线Day11内容">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240304162632533.png">
<meta property="og:image" content="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240304163606002.png">
<meta property="og:image" content="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240304164611743.png">
<meta property="og:image" content="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240304171025127.png">
<meta property="og:image" content="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240304171201768.png">
<meta property="og:image" content="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240304173446011.png">
<meta property="og:image" content="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240304222553158.png">
<meta property="og:image" content="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240305091312405.png">
<meta property="og:image" content="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240305165437866.png">
<meta property="og:image" content="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/clip_image002.gif">
<meta property="og:image" content="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/clip_image004.gif">
<meta property="og:image" content="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/clip_image006.gif">
<meta property="og:image" content="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/clip_image008.gif">
<meta property="og:image" content="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/clip_image010.gif">
<meta property="og:image" content="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/clip_image012.gif">
<meta property="og:image" content="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/clip_image014.gif">
<meta property="og:image" content="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/clip_image016.gif">
<meta property="og:image" content="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/clip_image002.gif">
<meta property="og:image" content="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/clip_image004.gif">
<meta property="og:image" content="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/clip_image006.gif">
<meta property="og:image" content="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240305194230135.png">
<meta property="og:image" content="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240305193754785.png">
<meta property="og:image" content="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240305194312750.png">
<meta property="og:image" content="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240305194344834.png">
<meta property="og:image" content="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240305194407191.png">
<meta property="og:image" content="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240305202331887.png">
<meta property="og:image" content="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240305203331675.png">
<meta property="og:image" content="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240306123054081.png">
<meta property="og:image" content="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240306123617296.png">
<meta property="article:published_time" content="2024-03-21T02:09:05.000Z">
<meta property="article:modified_time" content="2024-03-27T07:24:56.177Z">
<meta property="article:author" content="Wwhds">
<meta property="article:tag" content="Java">
<meta property="article:tag" content="学习">
<meta property="article:tag" content="后端">
<meta property="article:tag" content="黑马程序员">
<meta property="article:tag" content="学成在线">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240304162632533.png">

<link rel="canonical" href="https://wwhdsone.github.io/2024/03/21/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFDay11/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>
<link rel="stylesheet" href="//cdn.jsdelivr.net/gh/theme-next/theme-next-needmoreshare2@1/needsharebutton.min.css"><style>
#needsharebutton-postbottom {
  cursor: pointer;
  height: 26px;
  margin-top: 10px;
  position: relative;
}
#needsharebutton-postbottom .btn {
  border: 1px solid $btn-default-border-color;
  border-radius: 3px;
  display: initial;
  padding: 1px 4px;
}
</style>
  <title>学成在线Day11 | WBlog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<style>mjx-container[jax="SVG"] {
  direction: ltr;
}

mjx-container[jax="SVG"] > svg {
  overflow: visible;
}

mjx-container[jax="SVG"][display="true"] {
  display: block;
  text-align: center;
  margin: 1em 0;
}

mjx-container[jax="SVG"][justify="left"] {
  text-align: left;
}

mjx-container[jax="SVG"][justify="right"] {
  text-align: right;
}

g[data-mml-node="merror"] > g {
  fill: red;
  stroke: red;
}

g[data-mml-node="merror"] > rect[data-background] {
  fill: yellow;
  stroke: none;
}

g[data-mml-node="mtable"] > line[data-line] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > rect[data-frame] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > .mjx-dashed {
  stroke-dasharray: 140;
}

g[data-mml-node="mtable"] > .mjx-dotted {
  stroke-linecap: round;
  stroke-dasharray: 0,140;
}

g[data-mml-node="mtable"] > svg {
  overflow: visible;
}

[jax="SVG"] mjx-tool {
  display: inline-block;
  position: relative;
  width: 0;
  height: 0;
}

[jax="SVG"] mjx-tool > mjx-tip {
  position: absolute;
  top: 0;
  left: 0;
}

mjx-tool > mjx-tip {
  display: inline-block;
  padding: .2em;
  border: 1px solid #888;
  font-size: 70%;
  background-color: #F8F8F8;
  color: black;
  box-shadow: 2px 2px 5px #AAAAAA;
}

g[data-mml-node="maction"][data-toggle] {
  cursor: pointer;
}

mjx-status {
  display: block;
  position: fixed;
  left: 1em;
  bottom: 1em;
  min-width: 25%;
  padding: .2em .4em;
  border: 1px solid #888;
  font-size: 90%;
  background-color: #F8F8F8;
  color: black;
}

foreignObject[data-mjx-xml] {
  font-family: initial;
  line-height: normal;
  overflow: visible;
}

.MathJax path {
  stroke-width: 3;
}

mjx-container[display="true"] {
  overflow: auto hidden;
}

mjx-container[display="true"] + br {
  display: none;
}
</style><style>.darkmode--activated{--body-bg-color:#282828;--content-bg-color:#333;--card-bg-color:#555;--text-color:#ccc;--blockquote-color:#bbb;--link-color:#ccc;--link-hover-color:#eee;--brand-color:#ddd;--brand-hover-color:#ddd;--table-row-odd-bg-color:#282828;--table-row-hover-bg-color:#363636;--menu-item-bg-color:#555;--btn-default-bg:#222;--btn-default-color:#ccc;--btn-default-border-color:#555;--btn-default-hover-bg:#666;--btn-default-hover-color:#ccc;--btn-default-hover-border-color:#666;--highlight-background:#282b2e;--highlight-foreground:#a9b7c6;--highlight-gutter-background:#34393d;--highlight-gutter-foreground:#9ca9b6}.darkmode--activated img{opacity:.75}.darkmode--activated img:hover{opacity:.9}.darkmode--activated code{color:#69dbdc;background:0 0}button.darkmode-toggle{z-index:9999}.darkmode-ignore,img{display:flex!important}.beian img{display:inline-block!important}</style></head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">WBlog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">哀吾生之须臾，羡长江之无穷</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/WwhdsOne" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://wwhdsone.github.io/2024/03/21/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFDay11/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/Markdown%E4%BD%BF%E7%94%A8/w.jpg">
      <meta itemprop="name" content="Wwhds">
      <meta itemprop="description" content="个人博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WBlog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          学成在线Day11
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2024-03-21 10:09:05" itemprop="dateCreated datePublished" datetime="2024-03-21T10:09:05+08:00">2024-03-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-03-27 15:24:56" itemprop="dateModified" datetime="2024-03-27T15:24:56+08:00">2024-03-27</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span><br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>46k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1:23</span>
            </span>
            <div class="post-description">学成在线Day11内容</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="学成在线day11"><a class="markdownIt-Anchor" href="#学成在线day11"></a> 学成在线Day11</h1>
<h1 id="用户授权"><a class="markdownIt-Anchor" href="#用户授权"></a> 用户授权</h1>
<h2 id="rbac"><a class="markdownIt-Anchor" href="#rbac"></a> RBAC</h2>
<p>如何实现授权？业界通常基于RBAC实现授权。</p>
<p>RBAC分为两种方式：</p>
<p>基于角色的访问控制（Role-Based Access Control）</p>
<p>基于资源的访问控制（Resource-Based Access Control）</p>
<p>角色的访问控制（Role-Based Access Control）是按角色进行授权，比如：主体的角色为总经理可以查询企业运营报表，查询员工工资信息等，访问控制流程如下：</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240304162632533.png" alt="image-20240304162632533"></p>
<p>根据上图中的判断逻辑，授权代码可表示如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(主体.hasRole(<span class="string">"总经理角色id"</span>)){</span><br><span class="line">	查询工资</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>如果上图中查询工资所需要的角色变化为总经理和部门经理，此时就需要修改判断逻辑为“判断用户的角色是否是总经理或部门经理”，修改代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(主体.hasRole(<span class="string">"总经理角色id"</span>) ||  主体.hasRole(<span class="string">"部门经理角色id"</span>)){</span><br><span class="line">    查询工资</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>根据上边的例子发现，当需要修改角色的权限时就需要修改授权的相关代码，系统可扩展性差。</p>
<p>基于资源的访问控制（Resource-Based Access</p>
<p>Control）是按资源（或权限）进行授权，比如：用户必须具有查询工资权限才可以查询员工工资信息等，访问控制流程如下：</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240304163606002.png" alt="image-20240304163606002"></p>
<p>根据上图中的判断，授权代码可以表示为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(主体.hasPermission(<span class="string">"查询工资权限标识"</span>)){</span><br><span class="line">    查询工资</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>优点：系统设计时定义好查询工资的权限标识，即使查询工资所需要的角色变化为总经理和部门经理也不需要修改授权代码，系统可扩展性强。</p>
<h2 id="资源服务授权流程"><a class="markdownIt-Anchor" href="#资源服务授权流程"></a> 资源服务授权流程</h2>
<p>本项目在资源服务内部进行授权，基于资源的授权模式，因为接口在资源服务，通过在接口处添加授权注解实现授权。</p>
<p>在资源服务集成Spring Security</p>
<p>在需要授权的接口处使用@PreAuthorize("hasAuthority('权限标识符')")进行控制</p>
<p>下边代码指定/course/list接口需要拥有xc_teachmanager_course_list 权限。</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240304164611743.png" alt="image-20240304164611743"></p>
<p>设置了@PreAuthorize表示执行此方法需要授权，如果当前用户请求接口没有权限则抛出异常</p>
<p>org.springframework.security.access.AccessDeniedException: 不允许访问</p>
<p>在统一异常处理处处理异常</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="meta">@ExceptionHandler(Exception.class)</span></span><br><span class="line"><span class="meta">@ResponseStatus(HttpStatus.INTERNAL_SERVER_ERROR)</span></span><br><span class="line"><span class="keyword">public</span> RestErrorResponse <span class="title function_">exception</span><span class="params">(Exception e)</span> {</span><br><span class="line">    log.error(<span class="string">"【系统异常】{}"</span>,e.getMessage(),e);</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">    <span class="keyword">if</span>(e.getMessage().equals(<span class="string">"不允许访问"</span>)){</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RestErrorResponse</span>(<span class="string">"没有操作此功能的权限"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RestErrorResponse</span>(CommonError.UNKOWN_ERROR.getErrMessage());</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>重启资源服务进行测试</p>
<p>使用教学机构用户登录系统</p>
<p>这里使用t1用户登录，账号:t1、密码：111111</p>
<p>登录成功，点击“教学机构”</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240304171025127.png" alt="image-20240304171025127"></p>
<p>如何给用户分配权限呢？</p>
<p>首先要学习数据模型，本项目授权相关的数据表如下：</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240304171201768.png" alt="image-20240304171201768"></p>
<p>xc_user：用户表，存储了系统用户信息，用户类型包括：学生、老师、管理员等</p>
<p>xc_role：角色表，存储了系统的角色信息，学生、老师、教学管理员、系统管理员等。</p>
<p>xc_user_role：用户角色表，一个用户可拥有多个角色，一个角色可被多个用户所拥有</p>
<p>xc_menu:模块表，记录了菜单及菜单下的权限</p>
<p>xc_permission:角色权限表，一个角色可拥有多个权限，一个权限可被多个角色所拥有</p>
<p>本项目要求掌握基于权限数据模型（5张数据表），要求在数据库中操作完成给用户分配权限、查询用户权限等需求。</p>
<p>1、查询用户所拥有的权限</p>
<p>步骤：</p>
<p>查询用户的id</p>
<p>查询用户所拥有的角色</p>
<p>查询用户所拥有的权限</p>
<p>例子：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM xc_menu WHERE id IN(</span><br><span class="line">    SELECT menu_id FROM xc_permission WHERE role_id IN(</span><br><span class="line">        SELECT role_id FROM xc_user_role WHERE user_id = '49'</span><br><span class="line">    )</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>2、给用户分配权限</p>
<p>1）添加权限</p>
<p>查询用户的id</p>
<p>查询权限的id</p>
<p>查询用户的角色，如果没有角色需要先给用户指定角色</p>
<p>向角色权限表添加记录</p>
<p>2）删除用户权限</p>
<p>本项目是基于角色分配权限，如果要删除用户的权限可以给用户换角色，那么新角色下的权限就是用户的权限；如果不换用户的角色可以删除角色下的权限即删除角色权限关系表相应记录，这样操作是将角色下的权限删除，属于该角色的用户都将删除此权限。</p>
<h2 id="查询用户权限"><a class="markdownIt-Anchor" href="#查询用户权限"></a> 查询用户权限</h2>
<p>使用Spring Security进行授权，首先在生成jwt前会查询用户的权限，如下图</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240304173446011.png" alt="image-20240304173446011"></p>
<p>接下来需要修改UserServiceImpl和PasswordAuthServiceImpl从数据库查询用户的权限。</p>
<ol>
<li>定义mapper接口</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">XcMenuMapper</span> <span class="keyword">extends</span> <span class="title class_">BaseMapper</span>&lt;XcMenu&gt; {</span><br><span class="line">    <span class="meta">@Select("SELECT    * FROM xc_menu WHERE id IN (SELECT menu_id FROM xc_permission WHERE role_id IN ( SELECT role_id FROM xc_user_role WHERE user_id = #{userId} ))")</span></span><br><span class="line">    List&lt;XcMenu&gt; <span class="title function_">selectPermissionByUserId</span><span class="params">(<span class="meta">@Param("userId")</span> String userId)</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>修改PasswordAuthServiceImpl</li>
</ol>
<p>修改UserServiceImpl类的getUserPrincipal方法，查询权限信息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//查询用户身份</span></span><br><span class="line"><span class="keyword">public</span> UserDetails <span class="title function_">getUserPrincipal</span><span class="params">(XcUserExt user)</span>{</span><br><span class="line">    <span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> user.getPassword();</span><br><span class="line">    <span class="comment">//查询用户权限</span></span><br><span class="line">    List&lt;XcMenu&gt; xcMenus = menuMapper.selectPermissionByUserId(user.getId());</span><br><span class="line">    List&lt;String&gt; permissions = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">if</span>(xcMenus.size()&lt;=<span class="number">0</span>){</span><br><span class="line">        <span class="comment">//用户权限,如果不加则报Cannot pass a null GrantedAuthority collection</span></span><br><span class="line">        permissions.add(<span class="string">"p1"</span>);</span><br><span class="line">    }<span class="keyword">else</span>{</span><br><span class="line">        xcMenus.forEach(menu-&gt;{</span><br><span class="line">            permissions.add(menu.getCode());</span><br><span class="line">        });</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//将用户权限放在XcUserExt中</span></span><br><span class="line">    user.setPermissions(permissions);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//为了安全在令牌中不放密码</span></span><br><span class="line">    user.setPassword(<span class="literal">null</span>);</span><br><span class="line">    <span class="comment">//将user对象转json</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">userString</span> <span class="operator">=</span> JSON.toJSONString(user);</span><br><span class="line">    String[] authorities = permissions.toArray(<span class="keyword">new</span> <span class="title class_">String</span>[<span class="number">0</span>]);</span><br><span class="line">    <span class="type">UserDetails</span> <span class="variable">userDetails</span> <span class="operator">=</span> User.withUsername(userString).password(password).authorities(authorities).build();</span><br><span class="line">    <span class="keyword">return</span> userDetails;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>将xc_teachmanager_course_list权限分配给用户。</p>
<p>1）首先找到当前用户的角色</p>
<p>2）找到xc_teachmanager_course_list权限的主键</p>
<p>3）在角色权限关系表中添加记录</p>
<p>分配完权限需要重新登录</p>
<p>由于用户分配了xc_teachmanager_course_list权限，用户具有访问课程查询接口的权限。</p>
<h2 id="细粒度授权"><a class="markdownIt-Anchor" href="#细粒度授权"></a> 细粒度授权</h2>
<h3 id="什么是细粒度授权"><a class="markdownIt-Anchor" href="#什么是细粒度授权"></a> <strong>什么是细粒度授权</strong></h3>
<p>什么是细粒度授权？</p>
<p>细粒度授权也叫数据范围授权，即不同的用户所拥有的操作权限相同，但是能够操作的数据范围是不一样的。一个例子：用户A和用户B都是教学机构，他们都拥有“我的课程”权限，但是两个用户所查询到的数据是不一样的。</p>
<p>本项目有哪些细粒度授权？</p>
<p>比如：</p>
<p>我的课程，教学机构只允许查询本教学机构下的课程信息。</p>
<p>我的选课，学生只允许查询自己所选课。</p>
<p>如何实现细粒度授权？</p>
<p>细粒度授权涉及到不同的业务逻辑，通常在<code>service</code>层实现，根据不同的用户进行校验，根据不同的参数查询不同的数据或操作不同的数据。</p>
<h3 id="教学机构细粒度授权"><a class="markdownIt-Anchor" href="#教学机构细粒度授权"></a> 教学机构细粒度授权</h3>
<p>教学机构在维护课程时只允许维护本机构的课程，教学机构细粒度授权过程如下：</p>
<ol>
<li>
<p>获取当前登录的用户身份</p>
</li>
<li>
<p>得到用户所属教育机构的Id</p>
</li>
<li>
<p>查询该教学机构下的课程信息</p>
</li>
</ol>
<p>最终实现了用户只允许查询自己机构的课程信息。</p>
<p>根据公司Id查询课程，流程如下：</p>
<ol>
<li>
<p>教学机构用户登录系统，从用户身份中取出所属机构的id,在用户表中设计了company_id字段存储该用户所属的机构id.</p>
</li>
<li>
<p>接口层取出当前登录用户的身份，取出机构id</p>
</li>
</ol>
<ol start="3">
<li>将机构id传入service方法。</li>
<li>service方法将机构id传入Dao方法，最终查询出本机构的课程信息。</li>
</ol>
<p>代码实现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiOperation("课程查询接口")</span></span><br><span class="line"><span class="meta">@PreAuthorize("hasAuthority('xc_teachmanager_course_list')")</span><span class="comment">//拥有课程列表查询的权限方可访问</span></span><br><span class="line"><span class="meta">@PostMapping("/course/list")</span></span><br><span class="line"><span class="keyword">public</span> PageResult&lt;CourseBase&gt; <span class="title function_">list</span><span class="params">(PageParams pageParams, <span class="meta">@RequestBody</span> QueryCourseParamsDto queryCourseParams)</span>{</span><br><span class="line">    <span class="comment">//取出用户身份</span></span><br><span class="line">    <span class="type">XcUser</span> <span class="variable">user</span> <span class="operator">=</span> SecurityUtil.getUser();</span><br><span class="line">    <span class="comment">//机构id</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">companyId</span> <span class="operator">=</span> user.getCompanyId();</span><br><span class="line">    <span class="keyword">return</span> courseBaseInfoService.queryCourseBaseList(Long.parseLong(companyId),pageParams,queryCourseParams);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>Service层:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> PageResult&lt;CourseBase&gt; <span class="title function_">queryCourseBaseList</span><span class="params">(Long companyId, PageParams pageParams, QueryCourseParamsDTO queryCourseParamsDto)</span> {</span><br><span class="line">    <span class="comment">//构建查询条件对象</span></span><br><span class="line">    LambdaQueryWrapper&lt;CourseBase&gt; queryWrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();</span><br><span class="line">    <span class="comment">//构建查询条件，根据课程名称查询</span></span><br><span class="line">    queryWrapper.like(StringUtils.isNotEmpty(queryCourseParamsDto.getCourseName()), CourseBase::getName, queryCourseParamsDto.getCourseName());</span><br><span class="line">    <span class="comment">//构建查询条件，根据课程审核状态查询</span></span><br><span class="line">    queryWrapper.eq(StringUtils.isNotEmpty(queryCourseParamsDto.getAuditStatus()), CourseBase::getAuditStatus, queryCourseParamsDto.getAuditStatus());</span><br><span class="line">    <span class="comment">//构建查询条件，根据课程发布状态查询</span></span><br><span class="line">    queryWrapper.eq(StringUtils.isNotEmpty(queryCourseParamsDto.getPublishStatus()), CourseBase::getStatus, queryCourseParamsDto.getPublishStatus());</span><br><span class="line">    <span class="comment">//构建查询条件，根据课程所属机构查询</span></span><br><span class="line">    queryWrapper.eq(CourseBase::getCompanyId, companyId);</span><br><span class="line">    <span class="comment">//分页对象</span></span><br><span class="line">    Page&lt;CourseBase&gt; page = <span class="keyword">new</span> <span class="title class_">Page</span>&lt;&gt;(pageParams.getPageNo(), pageParams.getPageSize());</span><br><span class="line">    <span class="comment">// 查询数据内容获得结果</span></span><br><span class="line">    Page&lt;CourseBase&gt; pageResult = courseBaseMapper.selectPage(page, queryWrapper);</span><br><span class="line">    <span class="comment">// 获取数据列表</span></span><br><span class="line">    List&lt;CourseBase&gt; list = pageResult.getRecords();</span><br><span class="line">    <span class="comment">// 获取数据总数</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">total</span> <span class="operator">=</span> pageResult.getTotal();</span><br><span class="line">    <span class="comment">// 构建结果集</span></span><br><span class="line">    PageResult&lt;CourseBase&gt; courseBasePageResult = <span class="keyword">new</span> <span class="title class_">PageResult</span>&lt;&gt;(list, total, pageParams.getPageNo(), pageParams.getPageSize());</span><br><span class="line">    <span class="keyword">return</span> courseBasePageResult;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p><code>启动后出现配置类重名情况</code></p>
<p>原因:因为我前面没写工具类导致引入的工具类是其他包的工具类顺便在maven导入了其他模块进而导致了类名重复无法运行,下次可以先从maven依赖开始检查</p>
<h1 id="找回密码实战"><a class="markdownIt-Anchor" href="#找回密码实战"></a> 找回密码实战</h1>
<h2 id="找回密码接口文档"><a class="markdownIt-Anchor" href="#找回密码接口文档"></a> 找回密码接口文档</h2>
<p><strong>只做邮箱找回密码</strong></p>
<blockquote>
<ul>
<li>需求：忘记密码需要找回，可以通过邮箱找回密码</li>
<li>页面访问地址：localhost/findpassword.html</li>
</ul>
</blockquote>
<p>接口:</p>
<blockquote>
<p>邮箱验证码：/api/checkcode/phone?param1=电子邮箱地址</p>
<p>找回密码：/api/auth/findpassword</p>
</blockquote>
<p>请求:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">{</span></span><br><span class="line">    cellphone<span class="punctuation">:</span>''<span class="punctuation">,</span></span><br><span class="line">    email<span class="punctuation">:</span>''<span class="punctuation">,</span></span><br><span class="line">    checkcodekey<span class="punctuation">:</span>''<span class="punctuation">,</span></span><br><span class="line">    checkcode<span class="punctuation">:</span>''<span class="punctuation">,</span></span><br><span class="line">    confirmpwd<span class="punctuation">:</span>''<span class="punctuation">,</span></span><br><span class="line">    password<span class="punctuation">:</span>''</span><br><span class="line"><span class="punctuation">}</span></span><br></pre></td></tr></table></figure>
<p>响应：</p>
<p>200: 找回成功</p>
<p>其它：找回失败，失败原因使用统一异常处理返回的信息格式</p>
<p>执行流程</p>
<ol>
<li>
<p>校验验证码，不一致则抛出异常</p>
</li>
<li>
<p>判断两次密码是否一致，不一致则抛出异常</p>
</li>
<li>
<p>根据手机号和邮箱查询用户</p>
</li>
<li>
<p>如果找到用户更新为新密码</p>
</li>
</ol>
<h2 id="找回密码代码开发"><a class="markdownIt-Anchor" href="#找回密码代码开发"></a> 找回密码代码开发</h2>
<h3 id="1-安装相关依赖"><a class="markdownIt-Anchor" href="#1-安装相关依赖"></a> 1. 安装相关依赖</h3>
<p>邮箱相关依赖:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/javax.activation/activation --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.activation<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>activation<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/javax.mail/mail --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.mail<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mail<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4.7<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.apache.commons/commons-email --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-email<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="2-编写邮箱工具类"><a class="markdownIt-Anchor" href="#2-编写邮箱工具类"></a> 2. 编写邮箱工具类</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.checkcode.utils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.mail.*;</span><br><span class="line"><span class="keyword">import</span> javax.mail.internet.InternetAddress;</span><br><span class="line"><span class="keyword">import</span> javax.mail.internet.MimeMessage;</span><br><span class="line"><span class="keyword">import</span> javax.mail.internet.MimeMessage.RecipientType;</span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> java.util.Collections;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MailUtil</span> {</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> MimeMessage mimeMsg; <span class="comment">// 邮件对象</span></span><br><span class="line">    <span class="keyword">private</span> Multipart mp;<span class="comment">// 附件添加的组件</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> MessagingException {</span><br><span class="line">        <span class="comment">//可以在这里直接测试方法，填自己的邮箱即可</span></span><br><span class="line">        sendTestMail(<span class="string">"a1605691832@163.com"</span>, achieveCode());</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 发送邮件</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> email 收件邮箱号</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> code  验证码</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> MessagingException 邮件异常</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">sendTestMail</span><span class="params">(String email, String code)</span> <span class="keyword">throws</span> MessagingException {</span><br><span class="line">        <span class="comment">/* 创建Properties 类用于记录邮箱的一些属性</span></span><br><span class="line"><span class="comment">         * 1.邮件服务器</span></span><br><span class="line"><span class="comment">         * 2.发件人邮箱</span></span><br><span class="line"><span class="comment">         * 3.发件人的授权密码</span></span><br><span class="line"><span class="comment">         * 4.邮件主题</span></span><br><span class="line"><span class="comment">         * 5.收件人，多个收件人以半角逗号分隔</span></span><br><span class="line"><span class="comment">         * 6.抄送，多个抄送以半角逗号分隔</span></span><br><span class="line"><span class="comment">         * 7.正文，可以用html格式的哟</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="type">Properties</span> <span class="variable">props</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Properties</span>();</span><br><span class="line">        <span class="comment">// 表示SMTP发送邮件，必须进行身份验证</span></span><br><span class="line">        props.put(<span class="string">"mail.smtp.auth"</span>, <span class="string">"true"</span>);</span><br><span class="line">        <span class="comment">//此处填写SMTP服务器</span></span><br><span class="line">        props.put(<span class="string">"mail.smtp.host"</span>, <span class="string">"smtp.163.com"</span>);</span><br><span class="line">        <span class="comment">//端口号，QQ邮箱端口587</span></span><br><span class="line">        props.put(<span class="string">"mail.smtp.port"</span>, <span class="string">"25"</span>);</span><br><span class="line">        <span class="comment">// 此处填写，写信人的账号</span></span><br><span class="line">        props.put(<span class="string">"mail.user"</span>, <span class="string">"a1605691832@163.com"</span>);</span><br><span class="line">        <span class="comment">// 此处填写16位STMP口令</span></span><br><span class="line">        props.put(<span class="string">"mail.password"</span>, <span class="string">"CZLXNYOVEHHUQRXB"</span>);</span><br><span class="line">        <span class="comment">// 构建授权信息，用于进行SMTP进行身份验证</span></span><br><span class="line">        <span class="type">Authenticator</span> <span class="variable">authenticator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Authenticator</span>() {</span><br><span class="line">            <span class="keyword">protected</span> PasswordAuthentication <span class="title function_">getPasswordAuthentication</span><span class="params">()</span> {</span><br><span class="line">                <span class="comment">// 用户名、密码</span></span><br><span class="line">                <span class="type">String</span> <span class="variable">userName</span> <span class="operator">=</span> props.getProperty(<span class="string">"mail.user"</span>);</span><br><span class="line">                <span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> props.getProperty(<span class="string">"mail.password"</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">PasswordAuthentication</span>(userName, password);</span><br><span class="line">            }</span><br><span class="line">        };</span><br><span class="line">        <span class="comment">// 使用环境属性和授权信息，创建邮件会话</span></span><br><span class="line">        <span class="type">Session</span> <span class="variable">mailSession</span> <span class="operator">=</span> Session.getInstance(props, authenticator);</span><br><span class="line">        <span class="comment">// 创建邮件消息</span></span><br><span class="line">        <span class="type">MimeMessage</span> <span class="variable">message</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MimeMessage</span>(mailSession);</span><br><span class="line">        <span class="comment">// 设置发件人</span></span><br><span class="line">        <span class="type">InternetAddress</span> <span class="variable">from</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InternetAddress</span>(props.getProperty(<span class="string">"mail.user"</span>));</span><br><span class="line">        message.setFrom(from);</span><br><span class="line">        <span class="comment">// 设置收件人的邮箱</span></span><br><span class="line">        <span class="type">InternetAddress</span> <span class="variable">to</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InternetAddress</span>(email);</span><br><span class="line">        message.setRecipient(RecipientType.TO, to);</span><br><span class="line">        <span class="comment">// 设置邮件标题</span></span><br><span class="line">        message.setSubject(<span class="string">"Wwhds 学成在线实战邮件测试"</span>);</span><br><span class="line">        <span class="comment">// 设置邮件的内容体</span></span><br><span class="line">        message.setContent(<span class="string">"尊敬的用户:你好!\n注册验证码为:"</span> + code + <span class="string">"(有效期为一分钟,请勿告知他人)"</span>, <span class="string">"text/html;charset=UTF-8"</span>);</span><br><span class="line">        <span class="comment">// 最后当然就是发送邮件啦</span></span><br><span class="line">        Transport.send(message);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *  生成验证码</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 验证码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">achieveCode</span><span class="params">()</span> {  <span class="comment">//由于数字 1 、 0 和字母 O 、l 有时分不清楚，所以，没有数字 1 、 0</span></span><br><span class="line">        String[] beforeShuffle = <span class="keyword">new</span> <span class="title class_">String</span>[]{<span class="string">"2"</span>, <span class="string">"3"</span>, <span class="string">"4"</span>, <span class="string">"5"</span>, <span class="string">"6"</span>, <span class="string">"7"</span>, <span class="string">"8"</span>, <span class="string">"9"</span>, <span class="string">"A"</span>, <span class="string">"B"</span>, <span class="string">"C"</span>, <span class="string">"D"</span>, <span class="string">"E"</span>, <span class="string">"F"</span>,</span><br><span class="line">                <span class="string">"G"</span>, <span class="string">"H"</span>, <span class="string">"I"</span>, <span class="string">"J"</span>, <span class="string">"K"</span>, <span class="string">"L"</span>, <span class="string">"M"</span>, <span class="string">"N"</span>, <span class="string">"O"</span>, <span class="string">"P"</span>, <span class="string">"Q"</span>, <span class="string">"R"</span>, <span class="string">"S"</span>, <span class="string">"T"</span>, <span class="string">"U"</span>, <span class="string">"V"</span>, <span class="string">"W"</span>, <span class="string">"X"</span>, <span class="string">"Y"</span>, <span class="string">"Z"</span>, <span class="string">"a"</span>,</span><br><span class="line">                <span class="string">"b"</span>, <span class="string">"c"</span>, <span class="string">"d"</span>, <span class="string">"e"</span>, <span class="string">"f"</span>, <span class="string">"g"</span>, <span class="string">"h"</span>, <span class="string">"i"</span>, <span class="string">"j"</span>, <span class="string">"k"</span>, <span class="string">"l"</span>, <span class="string">"m"</span>, <span class="string">"n"</span>, <span class="string">"o"</span>, <span class="string">"p"</span>, <span class="string">"q"</span>, <span class="string">"r"</span>, <span class="string">"s"</span>, <span class="string">"t"</span>, <span class="string">"u"</span>, <span class="string">"v"</span>,</span><br><span class="line">                <span class="string">"w"</span>, <span class="string">"x"</span>, <span class="string">"y"</span>, <span class="string">"z"</span>};</span><br><span class="line">        List&lt;String&gt; list = Arrays.asList(beforeShuffle);<span class="comment">//将数组转换为集合</span></span><br><span class="line">        Collections.shuffle(list);  <span class="comment">//打乱集合顺序</span></span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        <span class="keyword">for</span> (String s : list) {</span><br><span class="line">            sb.append(s); <span class="comment">//将集合转化为字符串</span></span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> sb.substring(<span class="number">3</span>, <span class="number">8</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h3 id="3-发送验证码接口"><a class="markdownIt-Anchor" href="#3-发送验证码接口"></a> 3. 发送验证码接口</h3>
<p><strong>Controller层:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiOperation(value = "发送邮箱验证码", tags = "发送邮箱验证码")</span></span><br><span class="line"><span class="meta">@PostMapping("/phone")</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendEMail</span><span class="params">(<span class="meta">@RequestParam("param1")</span> String email)</span> <span class="keyword">throws</span> MessagingException {</span><br><span class="line">    <span class="type">String</span> <span class="variable">code</span> <span class="operator">=</span> MailUtil.achieveCode();</span><br><span class="line">    sendCodeService.sendCodeToEmail(email, code);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p><strong>Service接口:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">SendCodeService</span> {</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">        * 发送验证码</span></span><br><span class="line"><span class="comment">        * <span class="doctag">@param</span> email 目标邮箱</span></span><br><span class="line"><span class="comment">        * <span class="doctag">@param</span> code 验证码</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        <span class="keyword">void</span> <span class="title function_">sendCodeToEmail</span><span class="params">(String email,String code)</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p><strong>Service实现类:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SendCodeServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">SendCodeService</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    RedisTemplate&lt;String, String&gt; redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendCodeToEmail</span><span class="params">(String email, String code)</span> {</span><br><span class="line">        log.info(<span class="string">"发送验证码到邮箱：{}，验证码：{}"</span>, email, code);</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="comment">//1.发送邮件</span></span><br><span class="line">            MailUtil.sendTestMail(email, code);</span><br><span class="line">        } <span class="keyword">catch</span> (MessagingException e) {</span><br><span class="line">            log.info(<span class="string">"发送验证码到邮箱失败：{}，验证码：{}"</span>, email, code);</span><br><span class="line">            XueChengPlusException.cast(<span class="string">"发送验证码到邮箱失败"</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">//2.将验证码存入redis</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">CODE_EXPIRE_TIME</span> <span class="operator">=</span> <span class="number">2</span> * <span class="number">60L</span>;</span><br><span class="line">        redisTemplate.opsForValue().set(email, code, CODE_EXPIRE_TIME);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h3 id="4-验证验证码接口"><a class="markdownIt-Anchor" href="#4-验证验证码接口"></a> 4. 验证验证码接口</h3>
<p>密码找回DTO类:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FindPswDto</span> {</span><br><span class="line"></span><br><span class="line">    String cellphone;</span><br><span class="line"></span><br><span class="line">    String email;</span><br><span class="line"></span><br><span class="line">    String checkcodekey;</span><br><span class="line"></span><br><span class="line">    String checkcode;</span><br><span class="line"></span><br><span class="line">    String password;</span><br><span class="line"></span><br><span class="line">    String confirmpwd;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p><strong>Controller层:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiOperation(value = "验证验证码是否正确", tags = "验证验证码是否正确")</span></span><br><span class="line"><span class="meta">@PostMapping("/findpassword")</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">verifyCode</span><span class="params">(<span class="meta">@RequestBody</span> FindPswDto findPswDto)</span> {</span><br><span class="line">    log.info(<span class="string">"验证验证码:{}"</span>, findPswDto);</span><br><span class="line">    verifyService.findPassword(findPswDto);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p><strong>Service接口:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">VerifyService</span> {</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">findPassword</span><span class="params">(FindPswDto findPswDto)</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p><strong>Service实现类:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">VerifyServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">VerifyService</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate&lt;String,String&gt; redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> XcUserMapper userMapper;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">findPassword</span><span class="params">(FindPswDto findPswDto)</span> {</span><br><span class="line">        <span class="comment">//获取redis中的验证码</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">code</span> <span class="operator">=</span> redisTemplate.opsForValue().get(findPswDto.getEmail());</span><br><span class="line">        <span class="keyword">if</span> (code == <span class="literal">null</span>) {</span><br><span class="line">            log.info(<span class="string">"验证码已过期"</span>);</span><br><span class="line">            XueChengPlusException.cast(<span class="string">"验证码已过期"</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">if</span> (!code.equals(findPswDto.getCheckcode())) {</span><br><span class="line">            log.info(<span class="string">"验证码错误"</span>);</span><br><span class="line">            XueChengPlusException.cast(<span class="string">"验证码已过期"</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> findPswDto.getPassword();</span><br><span class="line">        <span class="type">String</span> <span class="variable">confirmpwd</span> <span class="operator">=</span> findPswDto.getConfirmpwd();</span><br><span class="line">        <span class="keyword">if</span> (!password.equals(confirmpwd)) {</span><br><span class="line">            log.info(<span class="string">"两次密码不一致"</span>);</span><br><span class="line">            XueChengPlusException.cast(<span class="string">"两次密码不一致"</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">//修改密码</span></span><br><span class="line">        LambdaQueryWrapper&lt;XcUser&gt; wrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();</span><br><span class="line">        wrapper.eq(XcUser::getEmail,findPswDto.getEmail());</span><br><span class="line">        wrapper.eq(XcUser::getCellphone,findPswDto.getCellphone());</span><br><span class="line">        <span class="type">XcUser</span> <span class="variable">xcUser</span> <span class="operator">=</span> userMapper.selectOne(wrapper);</span><br><span class="line">        <span class="keyword">if</span> (xcUser == <span class="literal">null</span>) {</span><br><span class="line">            log.info(<span class="string">"用户不存在"</span>);</span><br><span class="line">            XueChengPlusException.cast(<span class="string">"用户不存在"</span>);</span><br><span class="line">        }</span><br><span class="line">        xcUser.setPassword(<span class="keyword">new</span> <span class="title class_">BCryptPasswordEncoder</span>().encode(password));</span><br><span class="line">        userMapper.updateById(xcUser);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h1 id="注册实战"><a class="markdownIt-Anchor" href="#注册实战"></a> 注册实战</h1>
<h2 id="注册接口文档"><a class="markdownIt-Anchor" href="#注册接口文档"></a> 注册接口文档</h2>
<p>需求：为学生提供注册入口，通过此入口注册的用户为学生用户。</p>
<p>界面访问地址：<a target="_blank" rel="noopener" href="http://www.51xuecheng.cn/register.html">http://www.51xuecheng.cn/register.html</a></p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240304222553158.png" alt="image-20240304222553158"></p>
<p>接口：</p>
<p>手机验证码：/api/checkcode/phone?param1=手机号</p>
<p>注册：/api/auth/register</p>
<p>请求：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">{</span></span><br><span class="line">    cellphone<span class="punctuation">:</span>''<span class="punctuation">,</span></span><br><span class="line">    username<span class="punctuation">:</span>''<span class="punctuation">,</span></span><br><span class="line">    email<span class="punctuation">:</span>''<span class="punctuation">,</span></span><br><span class="line">    nickname<span class="punctuation">:</span>''<span class="punctuation">,</span></span><br><span class="line">    password<span class="punctuation">:</span>''<span class="punctuation">,</span></span><br><span class="line">    confirmpwd<span class="punctuation">:</span>''<span class="punctuation">,</span></span><br><span class="line">    checkcodekey<span class="punctuation">:</span>''<span class="punctuation">,</span></span><br><span class="line">    checkcode<span class="punctuation">:</span>''</span><br><span class="line"><span class="punctuation">}</span></span><br></pre></td></tr></table></figure>
<p>响应：</p>
<p>200: 注册成功</p>
<p>其它：注册失败，失败原因使用统一异常处理返回的信息格式</p>
<p>执行流程：</p>
<ol>
<li>
<p>校验验证码，如果不一致则抛出异常</p>
</li>
<li>
<p>校验两次密码是否一致，如果不一致则抛出异常</p>
</li>
<li>
<p>校验用户是否存在，如果存在则抛出异常</p>
</li>
<li>
<p>向用户表、用户角色关系表添加数据。角色为学生角色。</p>
</li>
</ol>
<h2 id="代码开发"><a class="markdownIt-Anchor" href="#代码开发"></a> 代码开发</h2>
<h3 id="1-准备dto类接受注册参数"><a class="markdownIt-Anchor" href="#1-准备dto类接受注册参数"></a> 1. 准备DTO类接受注册参数</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RegisterDto</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String cellphone;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String checkcode;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String checkcodekey;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String confirmpwd;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String email;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String nickname;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h3 id="2-注册接口"><a class="markdownIt-Anchor" href="#2-注册接口"></a> 2. 注册接口</h3>
<p><strong>Controller层:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiOperation(value = "注册", tags = "注册")</span></span><br><span class="line"><span class="meta">@RequestMapping("/register")</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">register</span><span class="params">(<span class="meta">@RequestBody</span> RegisterDto registerDto)</span> {</span><br><span class="line">    verifyService.register(registerDto);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p><strong>Sevice接口:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">VerifyService</span> {</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">register</span><span class="params">(RegisterDto registerDto)</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p><strong>Service接口实现类:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">register</span><span class="params">(RegisterDto registerDto)</span> {</span><br><span class="line">    <span class="type">String</span> <span class="variable">id</span> <span class="operator">=</span> UUID.randomUUID().toString();</span><br><span class="line">    <span class="type">String</span> <span class="variable">email</span> <span class="operator">=</span> registerDto.getEmail();</span><br><span class="line">    <span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> registerDto.getPassword();</span><br><span class="line">    <span class="type">String</span> <span class="variable">confirmpwd</span> <span class="operator">=</span> registerDto.getConfirmpwd();</span><br><span class="line">    <span class="type">String</span> <span class="variable">checkcode</span> <span class="operator">=</span> registerDto.getCheckcode();</span><br><span class="line">    <span class="type">Boolean</span> <span class="variable">verify</span> <span class="operator">=</span> verify(email, checkcode);</span><br><span class="line">    <span class="comment">//验证码错误</span></span><br><span class="line">    <span class="keyword">if</span> ( !verify ) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">"验证码输入错误"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//两次密码不一致</span></span><br><span class="line">    <span class="keyword">if</span> ( !password.equals(confirmpwd) ) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">"两次密码不一致"</span>);</span><br><span class="line">    }</span><br><span class="line">    LambdaQueryWrapper&lt;XcUser&gt; wrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();</span><br><span class="line">    wrapper.eq(XcUser::getEmail, email);</span><br><span class="line">    <span class="type">XcUser</span> <span class="variable">xcUser</span> <span class="operator">=</span> userMapper.selectOne(wrapper);</span><br><span class="line">    <span class="keyword">if</span> ( xcUser != <span class="literal">null</span> ) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">"邮箱已被注册,一个账号只能有一个用户"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="type">XcUser</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XcUser</span>();</span><br><span class="line">    BeanUtils.copyProperties(registerDto, user);</span><br><span class="line">    user.setPassword(<span class="keyword">new</span> <span class="title class_">BCryptPasswordEncoder</span>().encode(password));</span><br><span class="line">    user.setId(id);</span><br><span class="line">    user.setUtype(<span class="string">"101001"</span>);</span><br><span class="line">    user.setStatus(<span class="string">"1"</span>);</span><br><span class="line">    user.setName(registerDto.getNickname());</span><br><span class="line">    user.setCreateTime(LocalDateTime.now());</span><br><span class="line">    user.setUpdateTime(LocalDateTime.now());</span><br><span class="line">    <span class="type">int</span> <span class="variable">insert</span> <span class="operator">=</span> userMapper.insert(user);</span><br><span class="line">    <span class="keyword">if</span> ( insert &lt;= <span class="number">0</span> ) {</span><br><span class="line">        XueChengPlusException.cast(<span class="string">"注册失败"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="type">XcUserRole</span> <span class="variable">userRole</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XcUserRole</span>();</span><br><span class="line">    userRole.setUserId(id);</span><br><span class="line">    userRole.setRoleId(<span class="string">"17"</span>);</span><br><span class="line">    userRole.setId(id);</span><br><span class="line">    userRole.setCreateTime(LocalDateTime.now());</span><br><span class="line">    <span class="type">int</span> <span class="variable">insert1</span> <span class="operator">=</span> userRoleMapper.insert(userRole);</span><br><span class="line">    <span class="keyword">if</span> ( insert1 &lt;= <span class="number">0</span> ) {</span><br><span class="line">        XueChengPlusException.cast(<span class="string">"注册失败"</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h3 id="3-问题整理"><a class="markdownIt-Anchor" href="#3-问题整理"></a> 3. 问题整理</h3>
<h3 id="31-spring-security问题"><a class="markdownIt-Anchor" href="#31-spring-security问题"></a> 3.1. Spring Security问题:</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiOperation(value = "修改密码", tags = "修改密码")</span></span><br><span class="line"><span class="meta">@RequestMapping("/findpassword")</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">verifyCode</span><span class="params">(<span class="meta">@RequestBody</span> FindPswDto findPswDto)</span> {</span><br><span class="line">    log.info(<span class="string">"修改密码:{}"</span>, findPswDto);</span><br><span class="line">    verifyService.findPassword(findPswDto);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@ApiOperation(value = "注册", tags = "注册")</span></span><br><span class="line"><span class="meta">@RequestMapping("/register")</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">register</span><span class="params">(<span class="meta">@RequestBody</span> RegisterDto registerDto)</span> {</span><br><span class="line">    verifyService.register(registerDto);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>这部分api接口一开始发送请求无论何种内容均会被返回403(Forbidden)</p>
<p>原因和<code>Spring Security</code>有关</p>
<p>在WebSecurityConfig中</p>
<p>原安全拦截机制代码如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//配置安全拦截机制</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">    http</span><br><span class="line">        .authorizeRequests()</span><br><span class="line">        .antMatchers(<span class="string">"/r/**"</span>).authenticated()<span class="comment">//访问/r开始的请求需要认证通过</span></span><br><span class="line">        .anyRequest().permitAll()<span class="comment">//其它请求全部放行</span></span><br><span class="line">        .and()</span><br><span class="line">        .formLogin().successForwardUrl(<span class="string">"/login-success"</span>);<span class="comment">//登录成功跳转到/login-success</span></span><br><span class="line">    http.logout().logoutUrl(<span class="string">"/logout"</span>);<span class="comment">//退出地址</span></span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>修改后的安全拦截机制如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">    http</span><br><span class="line">        .csrf().disable()</span><br><span class="line">        .authorizeRequests()</span><br><span class="line">        .anyRequest().permitAll()</span><br><span class="line">        .and()</span><br><span class="line">        .formLogin().successForwardUrl(<span class="string">"/login-success"</span>);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>可以看到<code>csrf().disable()</code>，我们让csrf失效使得注册和找回密码需求可以正常运行</p>
<h3 id="32-redis缓存提前删除"><a class="markdownIt-Anchor" href="#32-redis缓存提前删除"></a> 3.2 redis缓存提前删除</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Boolean <span class="title function_">verify</span><span class="params">(String email, String checkcode)</span> {</span><br><span class="line">    <span class="comment">// 1. 从redis中获取缓存的验证码</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">codeInRedis</span> <span class="operator">=</span> redisTemplate.opsForValue().get(email);</span><br><span class="line">    <span class="comment">// 2. 判断是否与用户输入的一致</span></span><br><span class="line">    <span class="keyword">if</span> ( codeInRedis != <span class="literal">null</span> &amp;&amp; codeInRedis.equalsIgnoreCase(checkcode) ) {</span><br><span class="line">        redisTemplate.delete(email);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p><code>redisTemplate.delete(email);</code>由于在调用<code>verify</code>方法的方法中后续插入数据库可能导致失败，但是这步却成功了，导致删除了验证码却无法成功注册，只能重新生成验证码，可以考虑在结尾删除验证码</p>
<h3 id="33-smtp泄露"><a class="markdownIt-Anchor" href="#33-smtp泄露"></a> 3.3 SMTP泄露</h3>
<p>首先感谢Git邮件提醒</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240305091312405.png" alt="image-20240305091312405">、</p>
<p>解决方法就是通过nacos发布配置替代硬编码</p>
<h4 id="331-在nacos发布配置"><a class="markdownIt-Anchor" href="#331-在nacos发布配置"></a> 3.3.1 在nacos发布配置</h4>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">mail:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="string">smtp.**.com</span></span><br><span class="line">    <span class="attr">port:</span> <span class="string">**</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">*********@163.com</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">CZL**********XNY</span></span><br></pre></td></tr></table></figure>
<h4 id="332-设置配置读取配置类"><a class="markdownIt-Anchor" href="#332-设置配置读取配置类"></a> 3.3.2 设置配置读取配置类</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MailSendConfigProperties</span> {</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(value = "${spring.mail.host}")</span></span><br><span class="line">    <span class="keyword">public</span> String host;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(value = "${spring.mail.port}")</span></span><br><span class="line">    <span class="keyword">public</span> String port;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(value = "${spring.mail.username}")</span></span><br><span class="line">    <span class="keyword">public</span> String username;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(value = "${spring.mail.password}")</span></span><br><span class="line">    <span class="keyword">public</span> String password;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p><code>@Configuration</code>即可，不用其他注解。</p>
<h4 id="333-工具类修改"><a class="markdownIt-Anchor" href="#333-工具类修改"></a> 3.3.3 工具类修改</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MailUtil</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MailSendConfigProperties mailProperties;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> MailSendConfigProperties MailProperties;</span><br><span class="line">    <span class="comment">//提前读取配置文件</span></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span>{</span><br><span class="line">        <span class="comment">//        System.out.println("mailProperties.host = " + mailProperties.host);</span></span><br><span class="line">        <span class="comment">//        System.out.println("mailProperties.port = " + mailProperties.port);</span></span><br><span class="line">        <span class="comment">//        System.out.println("mailProperties.username = " + mailProperties.username);</span></span><br><span class="line">        <span class="comment">//        System.out.println("mailProperties.password = " + mailProperties.password);</span></span><br><span class="line">        MailProperties = mailProperties;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> MessagingException {</span><br><span class="line">        <span class="comment">//可以在这里直接测试方法，填自己的邮箱即可</span></span><br><span class="line">        sendTestMail(MailProperties.host, achieveCode());</span><br><span class="line">    }</span><br><span class="line">    ...</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<ul>
<li>
<p>首先将工具类加入<code>@Component</code>使得其可以进行自动注入</p>
</li>
<li>
<p>然后注入配置类并设置一个静态配置类</p>
</li>
<li>
<p>设置<code>init()</code>方法然后加上<code>@PostConStruct</code>注解使得其能在静态方法前加载完成</p>
</li>
<li>
<p>用<code>@PostConStruct</code>一定要在<code>bootstrap.yml</code>文件开启配置</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">main:</span></span><br><span class="line">	<span class="attr">allow-bean-definition-overriding:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h1 id="选课学习"><a class="markdownIt-Anchor" href="#选课学习"></a> 选课学习</h1>
<h1 id="模块需求分析"><a class="markdownIt-Anchor" href="#模块需求分析"></a> 模块需求分析</h1>
<h2 id="模块介绍"><a class="markdownIt-Anchor" href="#模块介绍"></a> 模块介绍</h2>
<p>本模块实现了学生选课、下单支付、学习的整体流程。</p>
<p>网站的课程有免费和收费两种，对于免费课程学生选课后可直接学习，对于收费课程学生需要下单且支付成功方可选课、学习。</p>
<p>选课：是将课程加入我的课程表的过程。</p>
<p>我的课程表：记录我在网站学习的课程，我的课程表中有免费课程和收费课程两种，对于免费课程可直接添加到我的课程表，对于收费课程需要下单、支付成功后自动加入我的课程表。</p>
<p>模块整体流程如下：</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240305165437866.png" alt="image-20240305165437866"></p>
<h2 id="业务流程"><a class="markdownIt-Anchor" href="#业务流程"></a> 业务流程</h2>
<h3 id="学习引导"><a class="markdownIt-Anchor" href="#学习引导"></a> 学习引导</h3>
<p>用户通过搜索课程、课程推荐等信息进入课程详情页面，点击“马上学习” 引导进入学习界面去学习。</p>
<p>流程如下：</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/clip_image002.gif" alt="img"></p>
<p>1、进入课程详情点击马上学习</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/clip_image004.gif" alt="img"></p>
<p>2、课程免费时引导加入我的课程表、或进入学习界面。</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/clip_image006.gif" alt="img"></p>
<p>3、课程收费时引导去支付、或试学。</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/clip_image008.gif" alt="img"></p>
<h3 id="选课流程"><a class="markdownIt-Anchor" href="#选课流程"></a> 选课流程</h3>
<p>选课是将课程加入我的课程表的过程。</p>
<p>对免费课程选课后可直接加入我的课程表，对收费课程选课后需要下单支付成功系统自动加入我的课程表。</p>
<p>流程如下：</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/clip_image010.gif" alt="img"></p>
<h3 id="支付流程"><a class="markdownIt-Anchor" href="#支付流程"></a> 支付流程</h3>
<p>本项目与第三方支付平台对接完成支付操作。</p>
<p>流程如下：</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/clip_image012.gif" alt="img"></p>
<h3 id="在线学习"><a class="markdownIt-Anchor" href="#在线学习"></a> 在线学习</h3>
<p>选课成功用户可以在线学习，对于免费课程无需选课即可在线学习。</p>
<p>流程如下：</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/clip_image014.gif" alt="img"></p>
<h3 id="免费课程续期"><a class="markdownIt-Anchor" href="#免费课程续期"></a> 免费课程续期</h3>
<p>免费课程加入我的课程表默认为1年有效期，到期用户可申请续期，流程如下：</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/clip_image016.gif" alt="img"></p>
<h1 id="添加选课"><a class="markdownIt-Anchor" href="#添加选课"></a> 添加选课</h1>
<h2 id="需求分析"><a class="markdownIt-Anchor" href="#需求分析"></a> 需求分析</h2>
<h3 id="数据模型"><a class="markdownIt-Anchor" href="#数据模型"></a> 数据模型</h3>
<p>选课是将课程加入我的课程表的过程，根据选课的业务流程进行详细分析，业务流程如下：</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/clip_image002.gif" alt="img"></p>
<p>选课信息存入选课记录表，免费课程被选课除了进入选课记录表同时进入我的课程表，收费课程进入选课记录表后需要经过下单、支付成功才可以进入我的课程表。</p>
<p>我的课程表记录了用户学习的课程，包括免费课程、收费课程（已经支付）。</p>
<p>1、选课记录表</p>
<p>当用户将课程添加到课程表时需要先创建选课记录。</p>
<p>结构如下：</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/clip_image004.gif" alt="img"></p>
<p>选课类型：免费课程、收费课程。</p>
<p>选课状态：选课成功、待支付、选课删除。</p>
<p>对于免费课程：课程价格为0，有效期默认365，开始服务时间为选课时间，结束服务时间为选课时间加1年后的时间，选课状态为选课成功。</p>
<p>对于收费课程：按课程的现价、有效期确定开始服务时间、结束服务时间，选课状态为待支付。</p>
<p>收费课程的选课记录需要支付成功后选课状态为成功。</p>
<p>2、我的课程表</p>
<p>我的课程表中记录了用户选课成功的课程，所以我的课程表的数据来源于选课记录表。</p>
<p>对于免费课程创建选课记录后同时向我的课程表添加记录。</p>
<p>对于收费课程创建选课记录后需要下单支付成功后自动向我的课程表添加记录。</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/clip_image006.gif" alt="img"></p>
<h3 id="执行流程"><a class="markdownIt-Anchor" href="#执行流程"></a> 执行流程</h3>
<pre class="mermaid">sequenceDiagram
    actor 用户
    用户 -&gt;&gt; 学习中心服务:添加选课
    学习中心服务 -&gt;&gt; 内容管理服务:查询课程信息
    内容管理服务 -&gt;&gt; 内容管理服务数据库:查询课程发布表
    学习中心服务 -&gt;&gt;学习中心服务:判断收费标准
    学习中心服务 -&gt;&gt; 学习中心数据库:免费课程:添加选课记录表及我的课程表
    学习中心服务 -&gt;&gt; 学习中心数据库:收费课程:添加选课记录表</pre>
<h2 id="接口开发"><a class="markdownIt-Anchor" href="#接口开发"></a> 接口开发</h2>
<h3 id="添加查询课程接口"><a class="markdownIt-Anchor" href="#添加查询课程接口"></a> 添加查询课程接口</h3>
<p><strong>Controller</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@description</span> 课程预览，发布，内部调用不用token</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> courseId 课程id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="meta">@ApiOperation("课程发布")</span></span><br><span class="line"><span class="meta">@PostMapping("/r/coursepublish/{courseId}")</span></span><br><span class="line"><span class="keyword">public</span> CoursePublish <span class="title function_">getCoursepublish</span><span class="params">(<span class="meta">@PathVariable("courseId")</span> Long courseId)</span> {</span><br><span class="line">    <span class="keyword">return</span> coursePublishService.getCoursePublish(courseId);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p><strong>Service接口</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CoursePublish <span class="title function_">getCoursePublish</span><span class="params">(Long courseId)</span>;</span><br></pre></td></tr></table></figure>
<p><strong>Service实现方法</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> CoursePublish <span class="title function_">getCoursePublish</span><span class="params">(Long courseId)</span> {</span><br><span class="line">    <span class="keyword">return</span> coursePublishMapper.selectById(courseId);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>由于是在网关处进行令牌校验，所以在微服务处不再校验令牌的合法性，修改内容管理content-api工程的ResouceServerConfig类，屏蔽authenticated()。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">    http.csrf().disable()</span><br><span class="line">        .authorizeRequests()</span><br><span class="line">        <span class="comment">//          .antMatchers("/r/**","/course/**").authenticated()//所有/r/**的请求必须认证通过</span></span><br><span class="line">        .anyRequest().permitAll();</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>测试类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FeignClientTest</span> {</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    ContentServiceClient contentServiceClient;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testContentServiceClient</span><span class="params">()</span> {</span><br><span class="line">        <span class="type">CoursePublish</span> <span class="variable">coursepublish</span> <span class="operator">=</span> contentServiceClient.getCoursepublish(<span class="number">125L</span>);</span><br><span class="line">        Assertions.assertNotNull(coursepublish);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>在进行feign远程调用时会将字符串转成LocalDateTime，在CoursePublish 类中LocalDateTime的属性上边添加如下代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@JsonFormat(shape = JsonFormat.Shape.STRING,pattern = "yyyy-MM-dd HH:mm:ss")</span></span><br></pre></td></tr></table></figure>
<p><code>@JsonFormat说明:</code><br>
该注解可用于返回日期数据时的时间格式化。<br>
如果前端传来的为字符串格式的日期：“2022年07月29日 09时41分22秒”，则需要如下配置：<br>
@JsonFormat(pattern = “yyyy年MM月dd日 HH时mm分ss秒”)<br>
private Date createTime;</p>
<p>解析后存入DB中的则为：2022-07-29 09:41:22，而在查询时返回的数据则为：“2022年07月29日 09时41分22秒”</p>
<h3 id="添加选课接口"><a class="markdownIt-Anchor" href="#添加选课接口"></a> 添加选课接口</h3>
<h4 id="接口分析"><a class="markdownIt-Anchor" href="#接口分析"></a> 接口分析</h4>
<p>本接口支持免费课程选课、收费课程选课。</p>
<p>免费课程选课：添加选课记录、添加我的课程表。</p>
<p>收费课程选课：添加选课记录。</p>
<p><strong>接口定义</strong></p>
<p>1、请求参数：课程id、当前用户id</p>
<p>2、响应结果：选课记录信息、学习资格</p>
<h4 id="接口定义"><a class="markdownIt-Anchor" href="#接口定义"></a> 接口定义</h4>
<p>学习资格：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">{</span><span class="attr">"code"</span><span class="punctuation">:</span><span class="string">"702001"</span><span class="punctuation">,</span><span class="attr">"desc"</span><span class="punctuation">:</span><span class="string">"正常学习"</span><span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">{</span><span class="attr">"code"</span><span class="punctuation">:</span><span class="string">"702002"</span><span class="punctuation">,</span><span class="attr">"desc"</span><span class="punctuation">:</span><span class="string">"没有选课或选课后没有支付"</span><span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">{</span><span class="attr">"code"</span><span class="punctuation">:</span><span class="string">"702003"</span><span class="punctuation">,</span><span class="attr">"desc"</span><span class="punctuation">:</span><span class="string">"已过期需要申请续期或重新支付"</span><span class="punctuation">}</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></table></figure>
<p>接口定义如下：</p>
<p><strong>Controller</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiOperation("添加选课")</span></span><br><span class="line"><span class="meta">@PostMapping("/choosecourse/{courseId}")</span></span><br><span class="line"><span class="keyword">public</span> XcChooseCourseDto <span class="title function_">addChooseCourse</span><span class="params">(<span class="meta">@PathVariable("courseId")</span> Long courseId)</span> {</span><br><span class="line">    <span class="comment">//获取用户信息</span></span><br><span class="line">    SecurityUtil.<span class="type">XcUser</span> <span class="variable">user</span> <span class="operator">=</span> SecurityUtil.getUser();</span><br><span class="line">    <span class="keyword">if</span>(user == <span class="literal">null</span>){</span><br><span class="line">        XueChengPlusException.cast(<span class="string">"请登录后再操作"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//获取用户id</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">userId</span> <span class="operator">=</span> user.getId();</span><br><span class="line">    <span class="comment">//选课</span></span><br><span class="line">    <span class="type">XcChooseCourseDto</span> <span class="variable">xcChooseCourseDto</span> <span class="operator">=</span> myCourseTableService.addChooseCourse(userId, courseId);</span><br><span class="line">    <span class="keyword">return</span> xcChooseCourseDto;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p><strong>Service接口</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MyCourseTableService</span> {</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userId   用户id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> courseId 课程id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> com.xuecheng.learning.model.dto.XcChooseCourseDto</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@description</span> 添加选课</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@date</span> 2022/10/24 17:33</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    XcChooseCourseDto <span class="title function_">addChooseCourse</span><span class="params">(String userId, Long courseId)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userId   用户id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> courseId 课程id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> com.xuecheng.learning.model.dto.XcCourseTablesDto</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@description</span> 查询学习资格，是否可以学习课程，是否已经选课，是否已经支付等等信息，返回给前端，前端根据这些信息决定是否可以学习课程，是否可以支付等等操作</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@date</span> 2022/10/24 17:33</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    XcCourseTablesDto <span class="title function_">getLearningStatus</span><span class="params">(String userId, Long courseId)</span>;</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p><strong>添加免费课程</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//添加免费课程,免费课程加入选课记录表、我的课程表</span></span><br><span class="line"><span class="keyword">public</span> XcChooseCourse <span class="title function_">addFreeCoruse</span><span class="params">(String userId, CoursePublish coursepublish)</span> {</span><br><span class="line">    <span class="comment">//如果存在免费选课记录且选课为成功状态,直接返回</span></span><br><span class="line">    LambdaQueryWrapper&lt;XcChooseCourse&gt; eq = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;XcChooseCourse&gt;()</span><br><span class="line">        .eq(XcChooseCourse::getUserId, userId)</span><br><span class="line">        .eq(XcChooseCourse::getCourseId, coursepublish.getId())</span><br><span class="line">        .eq(XcChooseCourse::getOrderType, <span class="string">"700001"</span>) <span class="comment">//免费课程</span></span><br><span class="line">        .eq(XcChooseCourse::getStatus, <span class="string">"701001"</span>);<span class="comment">//选课成功</span></span><br><span class="line">    List&lt;XcChooseCourse&gt; xcChooseCourses = xcChooseCourseMapper.selectList(eq);</span><br><span class="line">    <span class="comment">//同一个人同一门课程只能选一次,但数据库没有主键约束可能有多次,这里只取第一次</span></span><br><span class="line">    <span class="keyword">if</span>( !xcChooseCourses.isEmpty() ){</span><br><span class="line">        <span class="keyword">return</span> xcChooseCourses.get(<span class="number">0</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//向选课记录写数据</span></span><br><span class="line">    <span class="type">XcChooseCourse</span> <span class="variable">xcChooseCourse</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XcChooseCourse</span>();</span><br><span class="line">    xcChooseCourse.setCourseId(coursepublish.getId());</span><br><span class="line">    xcChooseCourse.setCourseName(coursepublish.getName());</span><br><span class="line">    xcChooseCourse.setUserId(userId);</span><br><span class="line">    xcChooseCourse.setCompanyId(coursepublish.getCompanyId());</span><br><span class="line">    xcChooseCourse.setOrderType(<span class="string">"700001"</span>);<span class="comment">//免费课程</span></span><br><span class="line">    xcChooseCourse.setCreateDate(LocalDateTime.now());</span><br><span class="line">    xcChooseCourse.setCoursePrice(coursepublish.getPrice());</span><br><span class="line">    xcChooseCourse.setValidDays(<span class="number">365</span>); <span class="comment">//暂时硬编码</span></span><br><span class="line">    xcChooseCourse.setStatus(<span class="string">"701001"</span>);<span class="comment">//选课成功</span></span><br><span class="line">    xcChooseCourse.setValidtimeStart(LocalDateTime.now());</span><br><span class="line">    xcChooseCourse.setValidtimeEnd(LocalDateTime.now().plusDays(<span class="number">365</span>));</span><br><span class="line">    <span class="type">int</span> <span class="variable">insert</span> <span class="operator">=</span> xcChooseCourseMapper.insert(xcChooseCourse);</span><br><span class="line">    <span class="keyword">if</span>( insert &lt;= <span class="number">0</span> ){</span><br><span class="line">        XueChengPlusException.cast(<span class="string">"添加选课失败"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> xcChooseCourse;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p><strong>添加收费课程</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//添加收费课程</span></span><br><span class="line"><span class="keyword">public</span> XcChooseCourse <span class="title function_">addChargeCoruse</span><span class="params">(String userId, CoursePublish coursepublish)</span> {</span><br><span class="line">    <span class="comment">//如果存在收费选课记录且选课状态为待支付，直接返回</span></span><br><span class="line">    LambdaQueryWrapper&lt;XcChooseCourse&gt; eq = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;XcChooseCourse&gt;()</span><br><span class="line">        .eq(XcChooseCourse::getUserId, userId)</span><br><span class="line">        .eq(XcChooseCourse::getCourseId, coursepublish.getId())</span><br><span class="line">        .eq(XcChooseCourse::getOrderType, <span class="string">"700002"</span>) <span class="comment">//收费课程</span></span><br><span class="line">        .eq(XcChooseCourse::getStatus, <span class="string">"701002"</span>);<span class="comment">//选课成功</span></span><br><span class="line">    List&lt;XcChooseCourse&gt; xcChooseCourses = xcChooseCourseMapper.selectList(eq);</span><br><span class="line">    <span class="comment">//同一个人同一门课程只能选一次,但数据库没有主键约束可能有多次,这里只取第一次</span></span><br><span class="line">    <span class="keyword">if</span>( !xcChooseCourses.isEmpty() ){</span><br><span class="line">        <span class="keyword">return</span> xcChooseCourses.get(<span class="number">0</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//向选课记录写数据</span></span><br><span class="line">    <span class="type">XcChooseCourse</span> <span class="variable">xcChooseCourse</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XcChooseCourse</span>();</span><br><span class="line">    xcChooseCourse.setCourseId(coursepublish.getId());</span><br><span class="line">    xcChooseCourse.setCourseName(coursepublish.getName());</span><br><span class="line">    xcChooseCourse.setUserId(userId);</span><br><span class="line">    xcChooseCourse.setCompanyId(coursepublish.getCompanyId());</span><br><span class="line">    xcChooseCourse.setOrderType(<span class="string">"700002"</span>);<span class="comment">//免费课程</span></span><br><span class="line">    xcChooseCourse.setCreateDate(LocalDateTime.now());</span><br><span class="line">    xcChooseCourse.setCoursePrice(coursepublish.getPrice());</span><br><span class="line">    xcChooseCourse.setValidDays(<span class="number">365</span>); <span class="comment">//暂时硬编码</span></span><br><span class="line">    xcChooseCourse.setStatus(<span class="string">"701002"</span>);<span class="comment">//选课成功</span></span><br><span class="line">    xcChooseCourse.setValidtimeStart(LocalDateTime.now());</span><br><span class="line">    xcChooseCourse.setValidtimeEnd(LocalDateTime.now().plusDays(<span class="number">365</span>));</span><br><span class="line">    <span class="type">int</span> <span class="variable">insert</span> <span class="operator">=</span> xcChooseCourseMapper.insert(xcChooseCourse);</span><br><span class="line">    <span class="keyword">if</span>( insert &lt;= <span class="number">0</span> ){</span><br><span class="line">        XueChengPlusException.cast(<span class="string">"添加选课失败"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> xcChooseCourse;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p><strong>添加到我的课程表:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//添加到我的课程表</span></span><br><span class="line"><span class="keyword">public</span> XcCourseTables <span class="title function_">addCourseTabls</span><span class="params">(XcChooseCourse xcChooseCourse)</span> {</span><br><span class="line">    <span class="comment">//选课成功才能向我的课程表添加数据</span></span><br><span class="line">    <span class="keyword">if</span>( !xcChooseCourse.getStatus().equals(<span class="string">"701001"</span>) ){</span><br><span class="line">        XueChengPlusException.cast(<span class="string">"选课失败,无法添加到我的课程表"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="type">XcCourseTables</span> <span class="variable">xcCourseTables</span> <span class="operator">=</span> getXcCourseTables(xcChooseCourse.getUserId(), xcChooseCourse.getCourseId());</span><br><span class="line">    <span class="keyword">if</span>( xcCourseTables != <span class="literal">null</span> ){</span><br><span class="line">        <span class="keyword">return</span> xcCourseTables;</span><br><span class="line">    }</span><br><span class="line">    xcCourseTables = <span class="keyword">new</span> <span class="title class_">XcCourseTables</span>();</span><br><span class="line">    BeanUtils.copyProperties(xcChooseCourse, xcCourseTables);</span><br><span class="line">    xcCourseTables.setChooseCourseId(xcChooseCourse.getId());<span class="comment">//记录选课记录id</span></span><br><span class="line">    xcCourseTables.setCourseType(xcChooseCourse.getOrderType());<span class="comment">//课程类型</span></span><br><span class="line">    xcCourseTables.setUpdateDate(LocalDateTime.now());</span><br><span class="line">    <span class="type">int</span> <span class="variable">insert</span> <span class="operator">=</span> xcCourseTablesMapper.insert(xcCourseTables);</span><br><span class="line">    <span class="keyword">if</span>( insert &lt;= <span class="number">0</span> ){</span><br><span class="line">        XueChengPlusException.cast(<span class="string">"添加我的课程表失败"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> xcCourseTables;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p><strong>获取学习资格</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> XcCourseTablesDto <span class="title function_">getLearningStatus</span><span class="params">(String userId, Long courseId)</span> {</span><br><span class="line">    <span class="comment">//查询我的课程表,查不到说明没有资格学习</span></span><br><span class="line">    <span class="type">XcCourseTables</span> <span class="variable">xcCourseTables</span> <span class="operator">=</span> getXcCourseTables(userId, courseId);</span><br><span class="line">    <span class="comment">//最终返回结果</span></span><br><span class="line">    <span class="type">XcCourseTablesDto</span> <span class="variable">xcCourseTablesDto</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XcCourseTablesDto</span>();</span><br><span class="line">    <span class="keyword">if</span>( xcCourseTables == <span class="literal">null</span> ){</span><br><span class="line">        <span class="comment">//{"code":"702002","desc":"没有选课或选课后没有支付"}</span></span><br><span class="line">        xcCourseTablesDto.setLearnStatus(<span class="string">"702002"</span>);</span><br><span class="line">        <span class="keyword">return</span> xcCourseTablesDto;</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//查询到了之后,判断是否过期</span></span><br><span class="line">    <span class="type">LocalDateTime</span> <span class="variable">validtimeEnd</span> <span class="operator">=</span> xcCourseTables.getValidtimeEnd();</span><br><span class="line">    <span class="keyword">if</span>( validtimeEnd.isBefore(LocalDateTime.now()) ){</span><br><span class="line">        <span class="comment">//{"code":"702003","desc":"选课已过期"}</span></span><br><span class="line">        xcCourseTablesDto.setLearnStatus(<span class="string">"702003"</span>);</span><br><span class="line">        BeanUtils.copyProperties(xcCourseTables, xcCourseTablesDto);</span><br><span class="line">    }<span class="keyword">else</span>{</span><br><span class="line">        xcCourseTablesDto.setLearnStatus(<span class="string">"702001"</span>);</span><br><span class="line">        BeanUtils.copyProperties(xcCourseTables, xcCourseTablesDto);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> xcCourseTablesDto;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p><strong>addChooseCourse接口完善</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> XcChooseCourseDto <span class="title function_">addChooseCourse</span><span class="params">(String userId, Long courseId)</span> {</span><br><span class="line">    <span class="comment">//远程调用服务查看课程收费规则</span></span><br><span class="line">    <span class="type">CoursePublish</span> <span class="variable">coursepublish</span> <span class="operator">=</span> contentServiceClient.getCoursepublish(courseId);</span><br><span class="line">    <span class="keyword">if</span> ( coursepublish == <span class="literal">null</span> ) {</span><br><span class="line">        <span class="comment">//课程不存在</span></span><br><span class="line">        XueChengPlusException.cast(<span class="string">"课程不存在"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//获取收费规则</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">charge</span> <span class="operator">=</span> coursepublish.getCharge();</span><br><span class="line">    <span class="type">XcChooseCourse</span> <span class="variable">xcChooseCourse</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> ( charge.equals(<span class="string">"201000"</span>) ) {</span><br><span class="line">        <span class="comment">//免费课程</span></span><br><span class="line">        <span class="comment">//向选课记录表添加数据</span></span><br><span class="line">        xcChooseCourse = addFreeCoruse(userId, coursepublish);</span><br><span class="line">        <span class="comment">//向我的课程表添加数据</span></span><br><span class="line">        <span class="type">XcCourseTables</span> <span class="variable">xcCourseTables</span> <span class="operator">=</span> addCourseTabls(xcChooseCourse);</span><br><span class="line"></span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        <span class="comment">//收费课程</span></span><br><span class="line">        <span class="comment">//向选课记录表添加数据</span></span><br><span class="line">        xcChooseCourse = addChargeCoruse(userId, coursepublish);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//判断学生学习资格</span></span><br><span class="line">    <span class="type">XcCourseTablesDto</span> <span class="variable">learningStatus</span> <span class="operator">=</span> getLearningStatus(userId, courseId);</span><br><span class="line">    <span class="comment">//构造返回结果</span></span><br><span class="line">    <span class="type">XcChooseCourseDto</span> <span class="variable">xcChooseCourseDto</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XcChooseCourseDto</span>();</span><br><span class="line">    BeanUtils.copyProperties(xcChooseCourse, xcChooseCourseDto);</span><br><span class="line">    <span class="comment">//设置学习状态</span></span><br><span class="line">    xcChooseCourseDto.setLearnStatus(learningStatus.getLearnStatus());</span><br><span class="line">    <span class="keyword">return</span> xcChooseCourseDto;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p><strong>Controller查询学习资格接口</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiOperation("查询学习资格")</span></span><br><span class="line"><span class="meta">@PostMapping("/choosecourse/learnstatus/{courseId}")</span></span><br><span class="line"><span class="keyword">public</span> XcCourseTablesDto <span class="title function_">getLearnstatus</span><span class="params">(<span class="meta">@PathVariable("courseId")</span> Long courseId)</span> {</span><br><span class="line">    <span class="comment">//获取用户信息</span></span><br><span class="line">    SecurityUtil.<span class="type">XcUser</span> <span class="variable">user</span> <span class="operator">=</span> SecurityUtil.getUser();</span><br><span class="line">    <span class="keyword">if</span>(user == <span class="literal">null</span>){</span><br><span class="line">        XueChengPlusException.cast(<span class="string">"请登录后再操作"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//获取用户id</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">userId</span> <span class="operator">=</span> user.getId();</span><br><span class="line">    <span class="comment">//查询学习状态</span></span><br><span class="line">    <span class="keyword">return</span> myCourseTableService.getLearningStatus(userId, courseId);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h2 id="接口测试"><a class="markdownIt-Anchor" href="#接口测试"></a> 接口测试</h2>
<p>测试通过,这里就不截图了</p>
<h1 id="支付"><a class="markdownIt-Anchor" href="#支付"></a> 支付</h1>
<h2 id="需求分析-2"><a class="markdownIt-Anchor" href="#需求分析-2"></a> 需求分析</h2>
<h3 id="执行流程-2"><a class="markdownIt-Anchor" href="#执行流程-2"></a> 执行流程</h3>
<p>用户去学习收费课程时引导其去支付，如下图：</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240305194230135.png" alt="image-20240305194230135"></p>
<p>当用户点击“微信支付”或支付宝支付时执行流程如下：</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240305193754785.png" alt="image-20240305193754785"></p>
<ol>
<li>
<p>请求学习中心服务创建选课记录</p>
</li>
<li>
<p>请求订单服务创建商品订单、生成支付二维码。</p>
</li>
<li>
<p>用户扫码请求订单支付服务，订单支付服务请求第三方支付平台生成支付订单。</p>
</li>
<li>
<p>前端唤起支付客户端，用户输入密码完成支付。</p>
</li>
<li>
<p>第三方支付平台支付完成发起支付通知。</p>
</li>
<li>
<p>订单支付服务接收第三方支付通知结果。</p>
</li>
<li>
<p>用户在前端查询支付结果，请求订单支付服务查询支付结果。</p>
</li>
<li>
<p>订单支付服务向学习中心服务通知支付结果。</p>
</li>
<li>
<p>学习中心服务收到支付结果，如果支付成功则更新选课记录，并添加到我的课程表。</p>
</li>
</ol>
<h3 id="通用订单服务设计"><a class="markdownIt-Anchor" href="#通用订单服务设计"></a> 通用订单服务设计</h3>
<p>在本项目中不仅选课需要下单、购买学习资料、老师一对一答疑等所以收费项目都需要下单支付。</p>
<p>所以本项目设计通用的订单服务，通用的订单服务承接各业务模块的收费支付需求，当用户需要交费时统一生成商品订单并进行支付。</p>
<img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240305194312750.png" alt="image-20240305194312750" style="zoom:50%;">
<p>所有收费业务最终转换为商品订单记录在订单服务的商品订单表。</p>
<img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240305194344834.png" alt="image-20240305194344834" style="zoom:50%;">
<p>以选课为例，选课记录表的ID记录在商品订单表的out_business_id字段。</p>
<img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240305194407191.png" alt="image-20240305194407191" style="zoom:50%;">
<h2 id="支付接口调研"><a class="markdownIt-Anchor" href="#支付接口调研"></a> 支付接口调研</h2>
<h3 id="微信支付接口调研"><a class="markdownIt-Anchor" href="#微信支付接口调研"></a> 微信支付接口调研</h3>
<p>一般情况下，一个网站要支持在线支付功能通常接入第三方支付平台，比如：微信支付、支付宝、其它的聚合支付平台。</p>
<p>本项目的需求实现手机扫码支付，现在对微信、支付宝的支付接口进行调研。</p>
<p>微信目前提供的支付方式如下：</p>
<p>地址：<a target="_blank" rel="noopener" href="https://pay.weixin.qq.com/static/product/product_index.shtml">https://pay.weixin.qq.com/static/product/product_index.shtml</a></p>
<p>![img](file:///C:/Users/Wwhds/AppData/Local/Temp/msohtmlclip1/01/clip_image002.gif)</p>
<p>1、付款码支付是指用户展示微信钱包内的“付款码”给商户系统扫描后直接完成支付，适用于线下场所面对面收银的场景，例如商超、便利店、餐饮、医院、学校、电影院和旅游景区等具有明确经营地址的实体场所。</p>
<p>![img](file:///C:/Users/Wwhds/AppData/Local/Temp/msohtmlclip1/01/clip_image004.gif)</p>
<p>2、JSAPI支付是指商户通过调用微信支付提供的JSAPI接口，在支付场景中调起微信支付模块完成收款</p>
<p>线下场所：调用接口生成二维码，用户扫描二维码后在微信浏览器中打开页面后完成支付</p>
<p>公众号场景：用户在微信公众账号内进入商家公众号，打开某个主页面，完成支付</p>
<p>PC网站场景：在网站中展示二维码，用户扫描二维码后在微信浏览器中打开页面后完成支付</p>
<p>![img](file:///C:/Users/Wwhds/AppData/Local/Temp/msohtmlclip1/01/clip_image006.gif)</p>
<p>3、小程序支付是指商户通过调用微信支付小程序支付接口，在微信小程序平台内实现支付功能；用户打开商家助手小程序下单，输入支付密码并完成支付后，返回商家小程序。</p>
<p>![img](file:///C:/Users/Wwhds/AppData/Local/Temp/msohtmlclip1/01/clip_image008.gif)</p>
<p>4、Native支付是指商户系统按微信支付协议生成支付二维码，用户再用微信“扫一扫”完成支付的模式。该模式适用于PC网站、实体店单品或订单、媒体广告支付等场景。</p>
<p>![img](file:///C:/Users/Wwhds/AppData/Local/Temp/msohtmlclip1/01/clip_image010.gif)</p>
<p>5、APP支付是指商户通过在移动端应用APP中集成开放SDK调起微信支付模块来完成支付。适用于在移动端APP中集成微信支付功能的场景。</p>
<p>![img](file:///C:/Users/Wwhds/AppData/Local/Temp/msohtmlclip1/01/clip_image012.gif)</p>
<p>6、刷脸支付是指用户在刷脸设备前通过摄像头刷脸、识别身份后进行的一种支付方式，安全便捷。适用于线下实体场所的收银场景，如商超、餐饮、便利店、医院、学校等。</p>
<p>![img](file:///C:/Users/Wwhds/AppData/Local/Temp/msohtmlclip1/01/clip_image014.gif)</p>
<p>以上接口native和JSAPI都可以实现pc网站实现扫码支付，两者区别是什么？怎么选择？</p>
<p>JSAPI除了在pc网站扫码支付还可以实现公众号页面内支付，可以实现在手机端H5页面唤起微信客户端完成支付。</p>
<p>本项目选择JSAPI支付接口。</p>
<p>接口文档：<a target="_blank" rel="noopener" href="https://pay.weixin.qq.com/wiki/doc/apiv3/apis/chapter3_1_1.shtml">https://pay.weixin.qq.com/wiki/doc/apiv3/apis/chapter3_1_1.shtml</a></p>
<p>如何开通JSAPI支付接口?</p>
<p>以企业身份注册微信公众号https://mp.weixin.qq.com/</p>
<p>![img](file:///C:/Users/Wwhds/AppData/Local/Temp/msohtmlclip1/01/clip_image016.gif)</p>
<p>登录公众号，点击左侧菜单“微信支付”开通微信支付，如下：</p>
<p>需要提供营业执照、身份证等信息。</p>
<p>![img](file:///C:/Users/Wwhds/AppData/Local/Temp/msohtmlclip1/01/clip_image018.gif)</p>
<p>点击申请接入，需要注册微信商户号。</p>
<p>![img](file:///C:/Users/Wwhds/AppData/Local/Temp/msohtmlclip1/01/clip_image020.gif)</p>
<p>注册微信商户号的过程请参考官方文档，本文档略。参考地址如下：</p>
<p><a target="_blank" rel="noopener" href="https://pay.weixin.qq.com/index.php/apply/applyment_home/guide_normal#none">https://pay.weixin.qq.com/index.php/apply/applyment_home/guide_normal#none</a></p>
<p>开通微信支付后即可在微信商户平台（<a target="_blank" rel="noopener" href="http://pay.weixin.qq.com">pay.weixin.qq.com</a>）开通JSAPI支付。</p>
<p>登录商品平台，进入产品中心，开通JSAPI支付：</p>
<p>![img](file:///C:/Users/Wwhds/AppData/Local/Temp/msohtmlclip1/01/clip_image022.gif)</p>
<p>注意：JSAPI支付方式需要在公众号配置回调域名，此域名为已经备案的外网域名。</p>
<p>最后在公众号开发信息中获取：开发者id、开发者密码。</p>
<h3 id="支付宝接口调研"><a class="markdownIt-Anchor" href="#支付宝接口调研"></a> 支付宝接口调研</h3>
<p>支付宝支付产品如下：</p>
<p>文档：<a target="_blank" rel="noopener" href="https://b.alipay.com/signing/productSetV2.htm">https://b.alipay.com/signing/productSetV2.htm</a></p>
<p>与本项目需求相关的接口：电脑网站支付、手机网站支付。</p>
<p>1、电脑网站支付</p>
<p>PC网站轻松收款，资金马上到账：用户在商家PC网站消费，自动跳转支付宝PC网站收银台完成付款。 交易资金直接打入商家支付宝账户，实时到账。</p>
<p>2、手机网站支付</p>
<p>用户在商家手机网站消费，通过浏览器自动跳转支付宝APP或支付宝网页完成付款。 轻松实现和APP支付相同的支付体验。</p>
<p>对比两种支付方式：手机网站支付方式可以在H5网页唤起支付宝，手机扫码支付可以使用手机网站支付方式来完成，相比电脑网站支付形式更灵活。</p>
<p>本项目选择手机网站支付方式。</p>
<p>文档：<a target="_blank" rel="noopener" href="https://opendocs.alipay.com/open/02ivbt">https://opendocs.alipay.com/open/02ivbt</a></p>
<p>如何开通支付宝手机网站支付接口？</p>
<p>进入网址：<a target="_blank" rel="noopener" href="https://b.alipay.com/signing/productDetailV2.htm?productId=I1011000290000001001">https://b.alipay.com/signing/productDetailV2.htm?productId=I1011000290000001001</a></p>
<p>点击：立即开通</p>
<p>上传营业执照等资料，提交审核，根据提示进行开通。</p>
<h2 id="支付接口测试"><a class="markdownIt-Anchor" href="#支付接口测试"></a> 支付接口测试</h2>
<h3 id="接口定义-2"><a class="markdownIt-Anchor" href="#接口定义-2"></a> 接口定义</h3>
<ol>
<li>支付宝支付接口交互流程如图:</li>
</ol>
<p>​	<img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240305202331887.png" alt="image-20240305202331887" style="zoom: 50%;"></p>
<ol>
<li>
<p>用户在商户的H5网站下单支付后，商户系统按照<a target="_blank" rel="noopener" href="https://docs.open.alipay.com/203/107090">手机网站支付接口alipay.trade.wap.pay</a>API的参数规范生成订单数据</p>
</li>
<li>
<p>前端页面通过Form表单的形式请求到支付宝。此时支付宝会自动将页面跳转至支付宝H5收银台页面，如果用户手机上安装了支付宝APP，则自动唤起支付宝APP。</p>
</li>
<li>
<p>输入支付密码完成支付。</p>
</li>
<li>
<p>用户在支付宝APP或H5收银台完成支付后，会根据商户在手机网站支付API中传入的前台回跳地址return_url自动跳转回商户页面，同时在URL请求中以Query String的形式附带上支付结果参数，详细回跳参数见“手机网站支付接口alipay.trade.wap.pay”<a target="_blank" rel="noopener" href="https://docs.open.alipay.com/203/107090#s2">前台回跳参数</a>。</p>
</li>
<li>
<p>支付宝还会根据原始支付API中传入的异步通知地址notify_url，通过POST请求的形式将支付结果作为参数通知到商户系统，详情见<a target="_blank" rel="noopener" href="https://docs.open.alipay.com/203/105286">支付结果异步通知</a>。</p>
</li>
<li>
<p>接口定义</p>
</li>
</ol>
<p>文档：<a target="_blank" rel="noopener" href="https://opendocs.alipay.com/open/203/107090">https://opendocs.alipay.com/open/203/107090</a></p>
<p>接口定义：外部商户请求支付宝创建订单并支付</p>
<p>公共参数</p>
<p><strong>请求地址</strong>：</p>
<p>开发中使用沙箱地址：<a target="_blank" rel="noopener" href="https://openapi.alipaydev.com/gateway.do">https://openapi.alipaydev.com/gateway.do</a></p>
<p>请求参数：</p>
<p>详细查阅https://opendocs.alipay.com/open/203/107090</p>
<p>一部分由sdk设置，一部分需要编写程序时指定。</p>
<ol start="3">
<li>
<p>示例代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doPost</span><span class="params">(HttpServletRequest httpRequest,</span></span><br><span class="line"><span class="params">                   HttpServletResponse httpResponse)</span> <span class="keyword">throws</span> ServletException, IOException {</span><br><span class="line">    <span class="type">AlipayClient</span> <span class="variable">alipayClient</span> <span class="operator">=</span> ... <span class="comment">//获得初始化的AlipayClient</span></span><br><span class="line">        <span class="type">AlipayTradeWapPayRequest</span> <span class="variable">alipayRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AlipayTradeWapPayRequest</span>();<span class="comment">//创建API对应的request</span></span><br><span class="line">    alipayRequest.setReturnUrl(<span class="string">"http://domain.com/CallBack/return_url.jsp"</span>);</span><br><span class="line">    alipayRequest.setNotifyUrl(<span class="string">"http://domain.com/CallBack/notify_url.jsp"</span>);<span class="comment">//在公共参数中设置回跳和通知地址</span></span><br><span class="line">    alipayRequest.setBizContent(<span class="string">"{"</span> +</span><br><span class="line">                                <span class="string">"    \"out_trade_no\":\"20150320010101002\","</span> +</span><br><span class="line">                                <span class="string">"    \"total_amount\":88.88,"</span> +</span><br><span class="line">                                <span class="string">"    \"subject\":\"Iphone6 16G\","</span> +</span><br><span class="line">                                <span class="string">"    \"product_code\":\"QUICK_WAP_WAY\""</span> +</span><br><span class="line">                                <span class="string">"  }"</span>);<span class="comment">//填充业务参数</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">form</span> <span class="operator">=</span> alipayClient.pageExecute(alipayRequest).getBody(); <span class="comment">//调用SDK生成表单</span></span><br><span class="line">    httpResponse.setContentType(<span class="string">"text/html;charset="</span> + AlipayServiceEnvConstants.CHARSET);</span><br><span class="line">    httpResponse.getWriter().write(form);<span class="comment">//直接将完整的表单html输出到页面</span></span><br><span class="line">    httpResponse.getWriter().flush();</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="下单执行流程"><a class="markdownIt-Anchor" href="#下单执行流程"></a> 下单执行流程</h3>
<p>根据接口描述，支付宝下单接口的执行流程如下：</p>
   <img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240305203331675.png" alt="image-20240305203331675" style="zoom:50%;">
<h3 id="支付接口测试-2"><a class="markdownIt-Anchor" href="#支付接口测试-2"></a> 支付接口测试</h3>
<h4 id="编写下单代码"><a class="markdownIt-Anchor" href="#编写下单代码"></a> 编写下单代码</h4>
<p><strong>maven依赖:</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 支付宝SDK --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alipay.sdk<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>alipay-sdk-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.34.0.ALL<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 支付宝SDK依赖的日志 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-logging<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-logging<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>下载示例代码https://opendocs.alipay.com/open/203/105910</p>
<p>拷贝示例代码，修改、测试。</p>
<p>编写测试Controller:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.orders.api;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alipay.api.AlipayApiException;</span><br><span class="line"><span class="keyword">import</span> com.alipay.api.AlipayClient;</span><br><span class="line"><span class="keyword">import</span> com.alipay.api.DefaultAlipayClient;</span><br><span class="line"><span class="keyword">import</span> com.alipay.api.request.AlipayTradeWapPayRequest;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.orders.config.AlipayConfig;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PayTestController</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value("${pay.alipay.APP_ID}")</span></span><br><span class="line">    String APP_ID;</span><br><span class="line">    <span class="meta">@Value("${pay.alipay.APP_PRIVATE_KEY}")</span></span><br><span class="line">    String APP_PRIVATE_KEY;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value("${pay.alipay.ALIPAY_PUBLIC_KEY}")</span></span><br><span class="line">    String ALIPAY_PUBLIC_KEY;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping("/alipaytest")</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doPost</span><span class="params">(HttpServletRequest httpRequest,</span></span><br><span class="line"><span class="params">                       HttpServletResponse httpResponse)</span> <span class="keyword">throws</span> ServletException, IOException, AlipayApiException {</span><br><span class="line">        <span class="type">AlipayClient</span> <span class="variable">alipayClient</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultAlipayClient</span>(AlipayConfig.URL, APP_ID, APP_PRIVATE_KEY, AlipayConfig.FORMAT, AlipayConfig.CHARSET, ALIPAY_PUBLIC_KEY,AlipayConfig.SIGNTYPE);</span><br><span class="line">        <span class="comment">//获得初始化的AlipayClient</span></span><br><span class="line">        <span class="type">AlipayTradeWapPayRequest</span> <span class="variable">alipayRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AlipayTradeWapPayRequest</span>();<span class="comment">//创建API对应的request</span></span><br><span class="line">        <span class="comment">//        alipayRequest.setReturnUrl("http://domain.com/CallBack/return_url.jsp");</span></span><br><span class="line">        <span class="comment">//        alipayRequest.setNotifyUrl("http://domain.com/CallBack/notify_url.jsp");//在公共参数中设置回跳和通知地址</span></span><br><span class="line">        alipayRequest.setBizContent(<span class="string">"{"</span> +</span><br><span class="line">                                    <span class="string">"    \"out_trade_no\":\"202210100010101002\","</span> +</span><br><span class="line">                                    <span class="string">"    \"total_amount\":0.1,"</span> +</span><br><span class="line">                                    <span class="string">"    \"subject\":\"Iphone6 16G\","</span> +</span><br><span class="line">                                    <span class="string">"    \"product_code\":\"QUICK_WAP_WAY\""</span> +</span><br><span class="line">                                    <span class="string">"  }"</span>);<span class="comment">//填充业务参数</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">form</span> <span class="operator">=</span> alipayClient.pageExecute(alipayRequest).getBody(); <span class="comment">//调用SDK生成表单</span></span><br><span class="line">        httpResponse.setContentType(<span class="string">"text/html;charset="</span> + AlipayConfig.CHARSET);</span><br><span class="line">        httpResponse.getWriter().write(form);<span class="comment">//直接将完整的表单html输出到页面</span></span><br><span class="line">        httpResponse.getWriter().flush();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h4 id="生成二维码"><a class="markdownIt-Anchor" href="#生成二维码"></a> 生成二维码</h4>
<p>用户在前端使用支付宝沙箱通过扫码请求下单接口，我们需要生成订单服务的下单接口的二维码。</p>
<p>ZXing是一个开源的类库，是用Java编写的多格式的1D / 2D条码图像处理库，使用ZXing可以生成、识别QR Code（二维码）。常用的二维码处理库还有zbar，近几年已经不再更新代码，下边介绍ZXing生成二维码的方法。</p>
<ol>
<li>引入依赖</li>
</ol>
<p>在base工程pom.xml中添加依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 二维码生成&amp;识别组件 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.google.zxing<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.3.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.google.zxing<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javase<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.3.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-lang3<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ol start="2">
<li>
<p>生成二维码方法</p>
<p>拷贝课程资料中utils下的QRCodeUtil.java到base工程util包下。</p>
<p>在QRCodeUtil中添加main方法如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException {</span><br><span class="line">    <span class="type">QRCodeUtil</span> <span class="variable">qrCodeUtil</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">QRCodeUtil</span>();</span><br><span class="line">    System.out.println(qrCodeUtil.createQRCode(<span class="string">"http://www.itcast.cn/"</span>, <span class="number">200</span>, <span class="number">200</span>));</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>运行main方法输入二维码图片的base64串，如下：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADIAQAAAACFI5MzAAABX0lEQVR42u2YS46EMAxEzYpjcFNIbppjZBWPqxJDC2k2o5HsRSNEQx4L40/ZadHfDvmSP5Iudmxdzr2JHNqPgoUjBznMxKo6jCug3WMxByl4arJrAdTa7SMykS4XoT3mI7gORjsVQbR9oez6yoNQMqvkqH6+6yeQzMM4M/Hc37oTSfpSlMuK2AQGGiOX+zqa2K+cIO2kBG799nU0cXfWJTNPJsYTN9mScdCdFvAhSQgquCANQbDMMwmpM+A0eUb7XFZHE8Z2BpmyZ/kIjUlBsGyOhC+heTvDLnkIjIWi2BVfgbeSkAKT2zWDzKbhVkeTOS7p0y6GrCkgA7lrF36lO93qaLIkmYJHv350s2jiU8BGeysbryYhPj1BmLnReabOeLJ2OQWjOn2JtqZJyJzWdfUKmXvERIT7QrspzMctF0HVDpqMapYshNFewrxRBUcWcldJ89HYp6dw8v2/6n/JD+4QqzIB2cR3AAAAAElFTkSuQmCC</span><br></pre></td></tr></table></figure>
<p>将base64串复制到浏览器地址后回车将展示一个二维码，用户用手机扫此二维码将请求至http://www.itcast.cn/。</p>
</li>
</ol>
<h4 id="接口测试-2"><a class="markdownIt-Anchor" href="#接口测试-2"></a> 接口测试</h4>
<ol>
<li>生成订单服务下单接口的二维码</li>
</ol>
<p>修改二维码生成的代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException {</span><br><span class="line">    <span class="type">QRCodeUtil</span> <span class="variable">qrCodeUtil</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">QRCodeUtil</span>();</span><br><span class="line">    System.out.println(qrCodeUtil.createQRCode(<span class="string">"http://localhost:63030/orders/alipaytest"</span>, <span class="number">200</span>, <span class="number">200</span>));</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>注意：http://localhost:63030地址用模拟器无法访问，进入cmd命令状态，输入命令ipconfig -all 查看本地网卡分配的局域网ip地址，将上边的地址修改如下：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://192.168.1.8:63030/orders/alipaytest</span><br></pre></td></tr></table></figure>
<p>除此之外</p>
<p>支付宝目前沙箱APP需要更新</p>
<p>在Order模块中的service中</p>
<p>请求网关地址于2023年某月更新</p>
<p>原配置失效,作如下修改</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 旧请求网关地址</span></span><br><span class="line"><span class="comment">//public static String URL = "https://openapi.alipaydev.com/gateway.do";</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 新请求网关地址</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">URL</span> <span class="operator">=</span> <span class="string">"https://openapi-sandbox.dl.alipaydev.com/gateway.do"</span>;</span><br></pre></td></tr></table></figure>
<p>以及最好在手机安装沙箱app来操作,模拟器会因不知名原因导致只能扫出来代码</p>
<h3 id="支付结果查询接口"><a class="markdownIt-Anchor" href="#支付结果查询接口"></a> 支付结果查询接口</h3>
<p>文档:<a target="_blank" rel="noopener" href="https://opendocs.alipay.com/open/02ivbt">https://opendocs.alipay.com/open/02ivbt</a></p>
<p>示例代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">AlipayClient</span> <span class="variable">alipayClient</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultAlipayClient</span>(<span class="string">"https://openapi.alipay.com/gateway.do"</span>,<span class="string">"app_id"</span>,<span class="string">"your private_key"</span>,<span class="string">"json"</span>,<span class="string">"GBK"</span>,<span class="string">"alipay_public_key"</span>,<span class="string">"RSA2"</span>);</span><br><span class="line"><span class="type">AlipayTradeQueryRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AlipayTradeQueryRequest</span>();</span><br><span class="line"><span class="type">JSONObject</span> <span class="variable">bizContent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">bizContent.put(<span class="string">"out_trade_no"</span>, <span class="string">"20150320010101001"</span>);</span><br><span class="line"><span class="comment">//bizContent.put("trade_no", "2014112611001004680073956707");</span></span><br><span class="line">request.setBizContent(bizContent.toString());</span><br><span class="line"><span class="type">AlipayTradeQueryResponse</span> <span class="variable">response</span> <span class="operator">=</span> alipayClient.execute(request);</span><br><span class="line"><span class="keyword">if</span>(response.isSuccess()){</span><br><span class="line">    System.out.println(<span class="string">"调用成功"</span>);</span><br><span class="line">} <span class="keyword">else</span> {</span><br><span class="line">    System.out.println(<span class="string">"调用失败"</span>);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>刚才订单付款成功，可以使用out_trade_no商品订单号或支付宝的交易流水号trade_no去查询支付结果。</p>
<p>out_trade_no商品订单号: 是在下单请求时指定的商品订单号。</p>
<p>支付宝的交易流水号trade_no：是支付完成后支付宝通知支付结果时发送的trade_no</p>
<p>我们使用out_trade_no商品订单号去查询，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AliPayTest</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value("${pay.alipay.APP_ID}")</span></span><br><span class="line">    String APP_ID;</span><br><span class="line">    <span class="meta">@Value("${pay.alipay.APP_PRIVATE_KEY}")</span></span><br><span class="line">    String APP_PRIVATE_KEY;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value("${pay.alipay.ALIPAY_PUBLIC_KEY}")</span></span><br><span class="line">    String ALIPAY_PUBLIC_KEY;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">queryPayResult</span><span class="params">()</span> <span class="keyword">throws</span> AlipayApiException {</span><br><span class="line">        <span class="type">AlipayClient</span> <span class="variable">alipayClient</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultAlipayClient</span>(<span class="string">"https://openapi-sandbox.dl.alipaydev.com/gateway.do"</span>, APP_ID, APP_PRIVATE_KEY, AlipayConfig.FORMAT, AlipayConfig.CHARSET, ALIPAY_PUBLIC_KEY, AlipayConfig.SIGNTYPE);</span><br><span class="line">        <span class="type">AlipayTradeQueryRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AlipayTradeQueryRequest</span>();</span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">bizContent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">        bizContent.put(<span class="string">"out_trade_no"</span>, <span class="string">"202410100010101023"</span>);           <span class="comment">//out_trade_no和trade_no二选一即可</span></span><br><span class="line">        <span class="comment">//bizContent.put("trade_no", "2014112611001004680073956707");</span></span><br><span class="line">        request.setBizContent(bizContent.toString());</span><br><span class="line">        <span class="type">AlipayTradeQueryResponse</span> <span class="variable">response</span> <span class="operator">=</span> alipayClient.execute(request);</span><br><span class="line">        <span class="keyword">if</span> ( response.isSuccess() ) {</span><br><span class="line">            System.out.println(<span class="string">"调用成功"</span>);</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            System.out.println(<span class="string">"调用失败"</span>);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h3 id="支付结果通知"><a class="markdownIt-Anchor" href="#支付结果通知"></a> 支付结果通知</h3>
<h4 id="准备支付环境"><a class="markdownIt-Anchor" href="#准备支付环境"></a> 准备支付环境</h4>
<p>对于手机网站支付产生的交易，支付宝会通知商户支付结果，有两种通知方式，通过return_url、notify_url进行通知</p>
<p>使用return_url不能保证通知到位，推荐使用notify_url完成支付结构通知。</p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240306123054081.png" alt="image-20240306123054081"></p>
<p>具体的使用方法是在调用下单接口的 API 中传入的异步通知地址 notify_url，通过 POST 请求的形式将支付结果作为参数通知到商户系统。</p>
<p>详情可查看 <a target="_blank" rel="noopener" href="https://opendocs.alipay.com/support/01raw4">支付宝异步通知说明</a>。</p>
<p>文档：<a target="_blank" rel="noopener" href="https://opendocs.alipay.com/open/203/105286">https://opendocs.alipay.com/open/203/105286</a></p>
<p>根据下单执行流程，订单服务收到支付结果需要对内容进行验签，验签过程如下：</p>
<ol>
<li>在通知返回参数列表中，除去sign、sign_type两个参数外，凡是通知返回回来的参数皆是待验签的参数。将剩下参数进行 url_decode，然后进行字典排序，组成字符串，得到待签名字符串； 生活号异步通知组成的待验签串里需要保留 sign_type 参数。</li>
<li>将签名参数（sign）使用 base64 解码为字节码串；</li>
<li>使用 RSA 的验签方法，通过签名字符串、签名参数（经过 base64 解码）及支付宝公钥验证签名。</li>
<li>验证签名正确后，必须再严格按照如下描述校验通知数据的正确性。</li>
</ol>
<p>在上述验证通过后，商户必须根据支付宝不同类型的业务通知，正确的进行不同的业务处理，并且过滤重复的通知结果数据。</p>
<p>通过验证out_trade_no、total_amount、appid参数的正确性判断通知请求的合法性。</p>
<p>验证的过程可以参考sdk demo代码，下载 sdk demo代码</p>
<p>文档:<a target="_blank" rel="noopener" href="https://opendocs.alipay.com/open/203/105910">https://opendocs.alipay.com/open/203/105910</a></p>
<p><img src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/image-20240306123617296.png" alt="image-20240306123617296"></p>
<p>参考demo中的alipay.trade.wap.pay-java-utf-8\WebContent\ notify_url.jsp</p>
<p>另外，支付宝通知订单服务的地址必须为外网域名且备案通过可以正常访问。</p>
<p>此接口仍然使用内网穿透技术。</p>
<h4 id="编写测试代码"><a class="markdownIt-Anchor" href="#编写测试代码"></a> 编写测试代码</h4>
<ol>
<li>
<p>在下单请求时设置通知地址request.setNotifyUrl("商户自己的notify_url地址");</p>
</li>
<li>
<p>编写接收通知接口，接收参数并验签</p>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping("/paynotify")</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">paynotify</span><span class="params">(HttpServletRequest request,HttpServletResponse response)</span> <span class="keyword">throws</span> IOException, AlipayApiException {</span><br><span class="line">    <span class="comment">//获取支付宝POST过来反馈信息</span></span><br><span class="line">    Map&lt;String,String&gt; params = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String,String&gt;();</span><br><span class="line">    <span class="type">Map</span> <span class="variable">requestParams</span> <span class="operator">=</span> request.getParameterMap();</span><br><span class="line">    <span class="keyword">for</span> ( <span class="type">Iterator</span> <span class="variable">iter</span> <span class="operator">=</span> requestParams.keySet().iterator(); iter.hasNext();) {</span><br><span class="line">        <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> (String) iter.next();</span><br><span class="line">        String[] values = (String[]) requestParams.get(name);</span><br><span class="line">        <span class="type">String</span> <span class="variable">valueStr</span> <span class="operator">=</span> <span class="string">""</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; values.length; i++) {</span><br><span class="line">            valueStr = (i == values.length - <span class="number">1</span>) ? valueStr + values[i]</span><br><span class="line">                : valueStr + values[i] + <span class="string">","</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">//乱码解决，这段代码在出现乱码时使用。如果mysign和sign不相等也可以使用这段代码转化</span></span><br><span class="line">        <span class="comment">//valueStr = new String(valueStr.getBytes("ISO-8859-1"), "gbk");</span></span><br><span class="line">        params.put(name, valueStr);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//获取支付宝的通知返回参数，可参考技术文档中页面跳转同步通知参数列表(以下仅供参考)//</span></span><br><span class="line">    <span class="comment">//商户订单号</span></span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">out_trade_no</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(request.getParameter(<span class="string">"out_trade_no"</span>).getBytes(<span class="string">"ISO-8859-1"</span>),<span class="string">"UTF-8"</span>);</span><br><span class="line">    <span class="comment">//支付宝交易号</span></span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">trade_no</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(request.getParameter(<span class="string">"trade_no"</span>).getBytes(<span class="string">"ISO-8859-1"</span>),<span class="string">"UTF-8"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//交易状态</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">trade_status</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(request.getParameter(<span class="string">"trade_status"</span>).getBytes(<span class="string">"ISO-8859-1"</span>),<span class="string">"UTF-8"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取支付宝的通知返回参数，可参考技术文档中页面跳转同步通知参数列表(以上仅供参考)//</span></span><br><span class="line">    <span class="comment">//计算得出通知验证结果</span></span><br><span class="line">    <span class="comment">//boolean AlipaySignature.rsaCheckV1(Map&lt;String, String&gt; params, String publicKey, String charset, String sign_type)</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">verify_result</span> <span class="operator">=</span> AlipaySignature.rsaCheckV1(params, ALIPAY_PUBLIC_KEY, AlipayConfig.CHARSET, <span class="string">"RSA2"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(verify_result){<span class="comment">//验证成功</span></span><br><span class="line">        <span class="comment">//////////////////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line">        <span class="comment">//请在这里加上商户的业务逻辑程序代码</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//——请根据您的业务逻辑来编写程序（以下代码仅作参考）——</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(trade_status.equals(<span class="string">"TRADE_FINISHED"</span>)){</span><br><span class="line">            <span class="comment">//判断该笔订单是否在商户网站中已经做过处理</span></span><br><span class="line">            <span class="comment">//如果没有做过处理，根据订单号（out_trade_no）在商户网站的订单系统中查到该笔订单的详细，并执行商户的业务程序</span></span><br><span class="line">            <span class="comment">//请务必判断请求时的total_fee、seller_id与通知时获取的total_fee、seller_id为一致的</span></span><br><span class="line">            <span class="comment">//如果有做过处理，不执行商户的业务程序</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">//注意：</span></span><br><span class="line">            <span class="comment">//如果签约的是可退款协议，退款日期超过可退款期限后（如三个月可退款），支付宝系统发送该交易状态通知</span></span><br><span class="line">            <span class="comment">//如果没有签约可退款协议，那么付款完成后，支付宝系统发送该交易状态通知。</span></span><br><span class="line">        } <span class="keyword">else</span> <span class="keyword">if</span> (trade_status.equals(<span class="string">"TRADE_SUCCESS"</span>)){</span><br><span class="line">            <span class="comment">//判断该笔订单是否在商户网站中已经做过处理</span></span><br><span class="line">            <span class="comment">//如果没有做过处理，根据订单号（out_trade_no）在商户网站的订单系统中查到该笔订单的详细，并执行商户的业务程序</span></span><br><span class="line">            <span class="comment">//请务必判断请求时的total_fee、seller_id与通知时获取的total_fee、seller_id为一致的</span></span><br><span class="line">            <span class="comment">//如果有做过处理，不执行商户的业务程序</span></span><br><span class="line">            System.out.printf(<span class="string">"trade_status = "</span> + trade_status);</span><br><span class="line">            <span class="comment">//注意：</span></span><br><span class="line">            <span class="comment">//如果签约的是可退款协议，那么付款完成后，支付宝系统发送该交易状态通知。</span></span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">//——请根据您的业务逻辑来编写程序（以上代码仅作参考）——</span></span><br><span class="line">        response.getWriter().write(<span class="string">"success"</span>);	<span class="comment">//请不要修改或删除</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//////////////////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line">    }<span class="keyword">else</span>{<span class="comment">//验证失败</span></span><br><span class="line">        response.getWriter().write(<span class="string">"fail"</span>);	<span class="comment">//请不要修改或删除</span></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>在测试中的alipayRequse也需要修改</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">AlipayTradeWapPayRequest</span> <span class="variable">alipayRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AlipayTradeWapPayRequest</span>();<span class="comment">//创建API对应的request</span></span><br><span class="line"><span class="comment">//        alipayRequest.setReturnUrl("http://domain.com/CallBack/return_url.jsp");</span></span><br><span class="line">alipayRequest.setNotifyUrl(<span class="string">"http://318f68d075.vicp.fun:45930/orders/paynotify"</span>);<span class="comment">//在公共参数中设置回跳和通知地址</span></span><br><span class="line">alipayRequest.setBizContent(<span class="string">"{"</span> +</span><br><span class="line">                            <span class="string">"    \"out_trade_no\":\"202410100010101023\","</span> +</span><br><span class="line">                            <span class="string">"    \"total_amount\":0.1,"</span> +</span><br><span class="line">                            <span class="string">"    \"subject\":\"Iphone116 16G\","</span> +</span><br><span class="line">                            <span class="string">"    \"product_code\":\"QUICK_WAP_WAY\""</span> +</span><br><span class="line">                            <span class="string">"  }"</span>);<span class="comment">//填充业务参数</span></span><br></pre></td></tr></table></figure>
<p>添加设置<code>alipayRequest.setNotifyUrl("http://318f68d075.vicp.fun:45930/orders/paynotify");</code></p>

    </div>

    
    
    <div class="post-widgets">
      <div id="needsharebutton-postbottom">
        <span class="btn">
          <i class="fa fa-share-alt" aria-hidden="true"></i>
        </span>
      </div>
    </div>
        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>Wwhds
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="https://wwhdsone.github.io/2024/03/21/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFDay11/" title="学成在线Day11">https://wwhdsone.github.io/2024/03/21/学成在线Day11/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/zh-CN" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Java/" rel="tag"><i class="fa fa-tag"></i> Java</a>
              <a href="/tags/%E5%AD%A6%E4%B9%A0/" rel="tag"><i class="fa fa-tag"></i> 学习</a>
              <a href="/tags/%E5%90%8E%E7%AB%AF/" rel="tag"><i class="fa fa-tag"></i> 后端</a>
              <a href="/tags/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98/" rel="tag"><i class="fa fa-tag"></i> 黑马程序员</a>
              <a href="/tags/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF/" rel="tag"><i class="fa fa-tag"></i> 学成在线</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2024/03/21/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFDay10/" rel="prev" title="学成在线Day10">
      <i class="fa fa-chevron-left"></i> 学成在线Day10
    </a></div>
      <div class="post-nav-item">
    <a href="/2024/03/21/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFDay12/" rel="next" title="学成在线Day12">
      学成在线Day12 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="gitalk-container"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday11"><span class="nav-text"> 学成在线Day11</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%94%A8%E6%88%B7%E6%8E%88%E6%9D%83"><span class="nav-text"> 用户授权</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#rbac"><span class="nav-text"> RBAC</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B5%84%E6%BA%90%E6%9C%8D%E5%8A%A1%E6%8E%88%E6%9D%83%E6%B5%81%E7%A8%8B"><span class="nav-text"> 资源服务授权流程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9F%A5%E8%AF%A2%E7%94%A8%E6%88%B7%E6%9D%83%E9%99%90"><span class="nav-text"> 查询用户权限</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BB%86%E7%B2%92%E5%BA%A6%E6%8E%88%E6%9D%83"><span class="nav-text"> 细粒度授权</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E7%BB%86%E7%B2%92%E5%BA%A6%E6%8E%88%E6%9D%83"><span class="nav-text"> 什么是细粒度授权</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%99%E5%AD%A6%E6%9C%BA%E6%9E%84%E7%BB%86%E7%B2%92%E5%BA%A6%E6%8E%88%E6%9D%83"><span class="nav-text"> 教学机构细粒度授权</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%89%BE%E5%9B%9E%E5%AF%86%E7%A0%81%E5%AE%9E%E6%88%98"><span class="nav-text"> 找回密码实战</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%89%BE%E5%9B%9E%E5%AF%86%E7%A0%81%E6%8E%A5%E5%8F%A3%E6%96%87%E6%A1%A3"><span class="nav-text"> 找回密码接口文档</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%89%BE%E5%9B%9E%E5%AF%86%E7%A0%81%E4%BB%A3%E7%A0%81%E5%BC%80%E5%8F%91"><span class="nav-text"> 找回密码代码开发</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E5%AE%89%E8%A3%85%E7%9B%B8%E5%85%B3%E4%BE%9D%E8%B5%96"><span class="nav-text"> 1. 安装相关依赖</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E7%BC%96%E5%86%99%E9%82%AE%E7%AE%B1%E5%B7%A5%E5%85%B7%E7%B1%BB"><span class="nav-text"> 2. 编写邮箱工具类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E5%8F%91%E9%80%81%E9%AA%8C%E8%AF%81%E7%A0%81%E6%8E%A5%E5%8F%A3"><span class="nav-text"> 3. 发送验证码接口</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E9%AA%8C%E8%AF%81%E9%AA%8C%E8%AF%81%E7%A0%81%E6%8E%A5%E5%8F%A3"><span class="nav-text"> 4. 验证验证码接口</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%B3%A8%E5%86%8C%E5%AE%9E%E6%88%98"><span class="nav-text"> 注册实战</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B3%A8%E5%86%8C%E6%8E%A5%E5%8F%A3%E6%96%87%E6%A1%A3"><span class="nav-text"> 注册接口文档</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BB%A3%E7%A0%81%E5%BC%80%E5%8F%91"><span class="nav-text"> 代码开发</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E5%87%86%E5%A4%87dto%E7%B1%BB%E6%8E%A5%E5%8F%97%E6%B3%A8%E5%86%8C%E5%8F%82%E6%95%B0"><span class="nav-text"> 1. 准备DTO类接受注册参数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E6%B3%A8%E5%86%8C%E6%8E%A5%E5%8F%A3"><span class="nav-text"> 2. 注册接口</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E9%97%AE%E9%A2%98%E6%95%B4%E7%90%86"><span class="nav-text"> 3. 问题整理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#31-spring-security%E9%97%AE%E9%A2%98"><span class="nav-text"> 3.1. Spring Security问题:</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#32-redis%E7%BC%93%E5%AD%98%E6%8F%90%E5%89%8D%E5%88%A0%E9%99%A4"><span class="nav-text"> 3.2 redis缓存提前删除</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#33-smtp%E6%B3%84%E9%9C%B2"><span class="nav-text"> 3.3 SMTP泄露</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#331-%E5%9C%A8nacos%E5%8F%91%E5%B8%83%E9%85%8D%E7%BD%AE"><span class="nav-text"> 3.3.1 在nacos发布配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#332-%E8%AE%BE%E7%BD%AE%E9%85%8D%E7%BD%AE%E8%AF%BB%E5%8F%96%E9%85%8D%E7%BD%AE%E7%B1%BB"><span class="nav-text"> 3.3.2 设置配置读取配置类</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#333-%E5%B7%A5%E5%85%B7%E7%B1%BB%E4%BF%AE%E6%94%B9"><span class="nav-text"> 3.3.3 工具类修改</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0"><span class="nav-text"> 选课学习</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%A8%A1%E5%9D%97%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90"><span class="nav-text"> 模块需求分析</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A8%A1%E5%9D%97%E4%BB%8B%E7%BB%8D"><span class="nav-text"> 模块介绍</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%9A%E5%8A%A1%E6%B5%81%E7%A8%8B"><span class="nav-text"> 业务流程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AD%A6%E4%B9%A0%E5%BC%95%E5%AF%BC"><span class="nav-text"> 学习引导</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%80%89%E8%AF%BE%E6%B5%81%E7%A8%8B"><span class="nav-text"> 选课流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%94%AF%E4%BB%98%E6%B5%81%E7%A8%8B"><span class="nav-text"> 支付流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0"><span class="nav-text"> 在线学习</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%8D%E8%B4%B9%E8%AF%BE%E7%A8%8B%E7%BB%AD%E6%9C%9F"><span class="nav-text"> 免费课程续期</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%B7%BB%E5%8A%A0%E9%80%89%E8%AF%BE"><span class="nav-text"> 添加选课</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90"><span class="nav-text"> 需求分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B"><span class="nav-text"> 数据模型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B"><span class="nav-text"> 执行流程</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91"><span class="nav-text"> 接口开发</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B7%BB%E5%8A%A0%E6%9F%A5%E8%AF%A2%E8%AF%BE%E7%A8%8B%E6%8E%A5%E5%8F%A3"><span class="nav-text"> 添加查询课程接口</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B7%BB%E5%8A%A0%E9%80%89%E8%AF%BE%E6%8E%A5%E5%8F%A3"><span class="nav-text"> 添加选课接口</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8E%A5%E5%8F%A3%E5%88%86%E6%9E%90"><span class="nav-text"> 接口分析</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89"><span class="nav-text"> 接口定义</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8E%A5%E5%8F%A3%E6%B5%8B%E8%AF%95"><span class="nav-text"> 接口测试</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%94%AF%E4%BB%98"><span class="nav-text"> 支付</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90-2"><span class="nav-text"> 需求分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B-2"><span class="nav-text"> 执行流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%80%9A%E7%94%A8%E8%AE%A2%E5%8D%95%E6%9C%8D%E5%8A%A1%E8%AE%BE%E8%AE%A1"><span class="nav-text"> 通用订单服务设计</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%94%AF%E4%BB%98%E6%8E%A5%E5%8F%A3%E8%B0%83%E7%A0%94"><span class="nav-text"> 支付接口调研</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BE%AE%E4%BF%A1%E6%94%AF%E4%BB%98%E6%8E%A5%E5%8F%A3%E8%B0%83%E7%A0%94"><span class="nav-text"> 微信支付接口调研</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%94%AF%E4%BB%98%E5%AE%9D%E6%8E%A5%E5%8F%A3%E8%B0%83%E7%A0%94"><span class="nav-text"> 支付宝接口调研</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%94%AF%E4%BB%98%E6%8E%A5%E5%8F%A3%E6%B5%8B%E8%AF%95"><span class="nav-text"> 支付接口测试</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89-2"><span class="nav-text"> 接口定义</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%8B%E5%8D%95%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B"><span class="nav-text"> 下单执行流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%94%AF%E4%BB%98%E6%8E%A5%E5%8F%A3%E6%B5%8B%E8%AF%95-2"><span class="nav-text"> 支付接口测试</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BC%96%E5%86%99%E4%B8%8B%E5%8D%95%E4%BB%A3%E7%A0%81"><span class="nav-text"> 编写下单代码</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%94%9F%E6%88%90%E4%BA%8C%E7%BB%B4%E7%A0%81"><span class="nav-text"> 生成二维码</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8E%A5%E5%8F%A3%E6%B5%8B%E8%AF%95-2"><span class="nav-text"> 接口测试</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%94%AF%E4%BB%98%E7%BB%93%E6%9E%9C%E6%9F%A5%E8%AF%A2%E6%8E%A5%E5%8F%A3"><span class="nav-text"> 支付结果查询接口</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%94%AF%E4%BB%98%E7%BB%93%E6%9E%9C%E9%80%9A%E7%9F%A5"><span class="nav-text"> 支付结果通知</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%87%86%E5%A4%87%E6%94%AF%E4%BB%98%E7%8E%AF%E5%A2%83"><span class="nav-text"> 准备支付环境</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BC%96%E5%86%99%E6%B5%8B%E8%AF%95%E4%BB%A3%E7%A0%81"><span class="nav-text"> 编写测试代码</span></a></li></ol></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Wwhds"
      src="https://wwhds-markdown-image.oss-cn-beijing.aliyuncs.com/Markdown%E4%BD%BF%E7%94%A8/w.jpg">
  <p class="site-author-name" itemprop="name">Wwhds</p>
  <div class="site-description" itemprop="description">个人博客</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">19</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">13</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/WwhdsOne" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;WwhdsOne" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:a1605691832@163.com" title="E-Mail → mailto:a1605691832@163.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://qm.qq.com/q/A18mWRc5YQ" title="QQ → https:&#x2F;&#x2F;qm.qq.com&#x2F;q&#x2F;A18mWRc5YQ" rel="noopener" target="_blank"><i class="fab fa-qq fa-lg fa-fw"></i>QQ</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://space.bilibili.com/85778548?spm_id_from=333.1007.0.0" title="Bilibili → https:&#x2F;&#x2F;space.bilibili.com&#x2F;85778548?spm_id_from&#x3D;333.1007.0.0" rel="noopener" target="_blank"><i class="fa custom bilibili fa-fw"></i>Bilibili</a>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/zh-CN" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Wwhds</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="站点总字数">255k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">7:44</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

  <script src='https://unpkg.com/mermaid@/dist/mermaid.min.js'></script>
  <script>
    if (window.mermaid) {
      mermaid.initialize({theme: 'forest'});
    }
  </script>

<div>
  <span id="timeDate">载入天数...</span>
  <script>
      var now = new Date(); 
      function createtime() { 
          var grt = new Date("03/18/2024 00:00:00");//在此处修改你的建站时间
          now.setTime(now.getTime()+250); 
          days = (now - grt ) / 1000 / 60 / 60 / 24; dnum = Math.floor(days); 
          document.getElementById("timeDate").innerHTML = "已运行 "+dnum+" 天 "; 
      } 
  setInterval("createtime()",250);
  </script>
</div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>











<script>
if (document.querySelectorAll('pre.mermaid').length) {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js', () => {
    mermaid.initialize({
      theme    : 'forest',
      logLevel : 3,
      flowchart: { curve     : 'linear' },
      gantt    : { axisFormat: '%m/%d/%Y' },
      sequence : { actorMargin: 50 }
    });
  }, window.mermaid);
}
</script>


  

  
      
<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/katex@0/dist/katex.min.css">


  

  <script src="//cdn.jsdelivr.net/gh/theme-next/theme-next-needmoreshare2@1/needsharebutton.min.js"></script>
  <script>
      pbOptions = {};
        pbOptions.iconStyle = "box";
        pbOptions.boxForm = "horizontal";
        pbOptions.position = "bottomCenter";
        pbOptions.networks = "Wechat,QQZone,Weibo,Douban,Twitter,Facebook";
      new needShareButton('#needsharebutton-postbottom', pbOptions);
  </script><script src="https://cdn.jsdelivr.net/npm/darkmode-js@1.5.7/lib/darkmode-js.min.js"></script>

<script>
var options = {
  bottom: '64px',
  right: '32px',
  left: 'unset',
  time: '1s',
  mixColor: 'transparent',
  backgroundColor: 'transparent',
  buttonColorDark: '#fff',
  buttonColorLight: '#fff',
  saveInCookies: true,
  label: '模式切换',
  autoMatchOsTheme: true
}
const darkmode = new Darkmode(options);
window.darkmode = darkmode;
darkmode.showWidget();
</script>

<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.css">

<script>
NexT.utils.loadComments(document.querySelector('#gitalk-container'), () => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js', () => {
    var gitalk = new Gitalk({
      clientID    : '402f0a321164611a3faa',
      clientSecret: '0857efbac20d76b6f97010056772c1069e03fabe',
      repo        : 'Wblog_Comments',
      owner       : 'WwhdsOne',
      admin       : ['WwhdsOne'],
      id          : 'bbcf6319149d1a3f957f46306be8f958',
        language: 'zh-CN',
      distractionFreeMode: false
    });
    gitalk.render('gitalk-container');
  }, window.Gitalk);
});
</script>

</body>
</html>
